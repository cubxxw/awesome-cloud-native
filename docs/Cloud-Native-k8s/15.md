+ [author](http://nsddd.top)

# ç¬¬15èŠ‚ k3s è¡¥å……

<div><a href = '14.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '16.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[toc]]

[TOC]

::: danger 
é¡µé¢å†…å®¹å¤ªå¤šå¡é¡¿ï¼Œæ–°å¼€ååŠéƒ¨åˆ†è¡¥å……~

+ [k3s vs k0s](https://docker.nsddd.top/Cloud-Native/7.html)

:::



## èµ„æºåˆ†æ

èµ„æºå ç”¨ç‡ä½æ˜¯ k3s çªå‡ºçš„ç‰¹ç‚¹ï¼Œé’ˆå¯¹ k3s ç‰¹æ€§ï¼Œåˆ†æèµ„æºçš„å ç”¨ï¼š



**å½±å“èµ„æºåˆ©ç”¨ç‡çš„å› ç´ ï¼š**

- `K3s server`ï¼šK3s server çš„åˆ©ç”¨ç‡æ•°æ®ä¸»è¦æ˜¯ç”±æ”¯æŒ Kubernetes æ•°æ®å­˜å‚¨ï¼ˆkine æˆ– etcdï¼‰ã€API Serverã€Controller-Manager å’Œ Scheduler æ§åˆ¶ã€‚ **åˆ›å»º/ä¿®æ”¹/åˆ é™¤** èµ„æºå°†å¯¼è‡´æš‚æ—¶çš„åˆ©ç”¨ç‡ä¸Šå‡ã€‚å¤§é‡ä½¿ç”¨ Kubernetes æ•°æ®å­˜å‚¨çš„ operators æˆ–åº”ç”¨ç¨‹åºä¹Ÿå°†å¢åŠ  server çš„èµ„æºéœ€æ±‚ã€‚

- `K3s agent`ï¼šç®¡ç†é•œåƒã€æä¾› **å­˜å‚¨æˆ–åˆ›å»º/é”€æ¯å®¹å™¨** çš„æ“ä½œå°†å¯¼è‡´åˆ©ç”¨ç‡çš„æš‚æ—¶ä¸Šå‡ï¼Œæ‹‰å–é•œåƒé€šå¸¸ä¼šå½±å“ CPU å’Œ IOï¼Œå› ä¸ºå®ƒä»¬æ¶‰åŠå°†é•œåƒå†…å®¹è§£å‹åˆ°ç£ç›˜ã€‚å¦‚æœå¯èƒ½çš„è¯ï¼Œå·¥ä½œè´Ÿè½½å­˜å‚¨(pod ä¸´æ—¶å­˜å‚¨å’Œå·)åº”è¯¥ä¸ agent ç»„ä»¶(/var/lib/rancher/k3s/agent)éš”ç¦»ï¼Œä»¥ç¡®ä¿ä¸ä¼šå‡ºç°èµ„æºå†²çªã€‚



**é˜²æ­¢ agent å’Œå·¥ä½œè´Ÿè½½å¹²æ‰°é›†ç¾¤æ•°æ®å­˜å‚¨ï¼š**

+ åœ¨ `server` èŠ‚ç‚¹è¿è¡Œå·¥ä½œè´Ÿè½½ pod æ—¶ï¼Œåº”ç¡®ä¿ `agent` å’Œå·¥ä½œè´Ÿè½½ `IOPS` ä¸å¹²æ‰°æ•°æ®å­˜å‚¨ã€‚

+ å°† `server` ç»„ä»¶ï¼ˆ/var/lib/rancher/k3s/serverï¼‰ä¸ `agent` ç»„ä»¶ï¼ˆ/var/lib/rancher/k3s/agentï¼‰æ”¾åœ¨ä¸åŒçš„å­˜å‚¨ä»‹è´¨ä¸Šï¼Œåè€…åŒ…æ‹¬ containerd é•œåƒå­˜å‚¨ã€‚

+ å·¥ä½œè´Ÿè½½å­˜å‚¨ï¼ˆpod ä¸´æ—¶å­˜å‚¨å’Œå·ï¼‰ä¹Ÿåº”è¯¥ä¸æ•°æ®å­˜å‚¨éš”ç¦»ã€‚



### /usr/local/bin é‡è¦äºŒè¿›åˆ¶

::: tip 
åé¢çš„æµ‹è¯•éƒ½æ˜¯å’Œ `/usr/local/bin` æ¯æ¯ç›¸å…³ï¼Œå°±æ¯”å¦‚è¯´æ¯ä¸€æ¬¡æµ‹è¯•åˆ é™¤ï¼š

```bash
/usr/local/bin/k3s-uninstall.sh 
```

**åŒæ ·çš„è¿˜æœ‰åœæ­¢ k3sï¼š**

ä¸ºäº†åœ¨å‡çº§æœŸé—´å®ç°é«˜å¯ç”¨æ€§ï¼ŒK3s å®¹å™¨åœ¨ K3s æœåŠ¡åœæ­¢æ—¶ä¼šç»§ç»­è¿è¡Œã€‚

```bash
/usr/local/bin/k3s-killall.sh
```

killall è„šæœ¬èƒ½æ¸…ç†å®¹å™¨ã€K3s ç›®å½•å’Œç½‘ç»œç»„ä»¶ï¼ŒåŒæ—¶è¿˜èƒ½åˆ é™¤ iptables é“¾ä»¥åŠæ‰€æœ‰ç›¸å…³è§„åˆ™ã€‚é›†ç¾¤æ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚

 ğŸ„â€â™‚ï¸ åŒæ ·å¯ä»¥ä½¿ç”¨ `systemctl start k3s` ï¼Œç›®å‰å‘ç°æ•ˆæœä¸€æ ·ï¼Œå¦‚æœä½ è§‰å¾—ä¸ä¸€æ ·ï¼Œè”ç³»ä¸‹æˆ‘~

**å½“ç„¶ k3s éƒ½æ˜¯å›´ç»•ç€ k3s è„šæœ¬ä¸ºä¸­å¿ƒçš„ï¼š**

:::



## è„šæœ¬å®‰è£…é€‰é¡¹

::: tip 
æˆ‘ä»¬ç°åœ¨å·²ç»çŸ¥é“äº†å…³äºè„šæœ¬çš„é€‰é¡¹ä¸¤ç§æ–¹å¼ï¼Œ**ç¯å¢ƒå˜é‡** æˆ–è€… **æ ‡å¿—** ã€‚

âš ï¸ æ³¨æ„ï¼Œå¦‚æœä½ é€‰æ‹© **ä¸‹è½½install.sh** ä½¿ç”¨ https://ghproxy.com ï¼Œåé¢çš„æ‰€æœ‰è„šæœ¬æˆ‘éƒ½æ˜¯ä½¿ç”¨ï¼š

```bash
INSTALL_K3S_MIRROR=cn   INSTALL_K3S_SYMLINK=skip  sh install.sh
```

ä»¥ "K3S_"å¼€å¤´çš„ç¯å¢ƒå˜é‡å°†è¢«ä¿ç•™ï¼Œä¾› systemd å’Œ openrc æœåŠ¡ä½¿ç”¨ã€‚

åœ¨æ²¡æœ‰æ˜ç¡®è®¾ç½® exec å‘½ä»¤çš„æƒ…å†µä¸‹è®¾ç½®`K3S_URL`ï¼Œä¼šå°†å‘½ä»¤é»˜è®¤ä¸º "agent"ã€‚

è¿è¡Œ agent æ—¶è¿˜å¿…é¡»è®¾ç½®`K3S_TOKEN`ã€‚

:::



`INSTALL_K3S_SKIP_DOWNLOAD` -- (ç”¨äºç¦»çº¿å®‰è£…) å¦‚æœè®¾ç½®ä¸º "true "å°†ä¸ä¼šä¸‹è½½ K3s çš„å“ˆå¸Œå€¼æˆ–äºŒè¿›åˆ¶ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
    INSTALL_K3S_SKIP_DOWNLOAD=true \
    sh -
```



`INSTALL_K3S_SYMLINK` -- é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè·¯å¾„ä¸­ä¸å­˜åœ¨å‘½ä»¤ï¼Œå°†ä¸º `kubectl`ã€`crictl` å’Œ `ctr` äºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»ºç¬¦å·é“¾æ¥ã€‚å¦‚æœè®¾ç½®ä¸º `'skip'` å°†ä¸ä¼šåˆ›å»ºç¬¦å·é“¾æ¥ï¼Œè€Œ `'force'` å°†è¦†ç›–ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SYMLINK=skip \
  sh -
```

> **æµ‹è¯•(é»˜è®¤æƒ…å†µï¼‰ï¼š**
>
> ```bash
> root@etcnode01:/usr/local/bin# ls -al
> total 66164
> drwxr-xr-x  2 root root     4096 Nov 26 09:40 .
> drwxr-xr-x 10 root root     4096 Aug 31 06:52 ..
> lrwxrwxrwx  1 root root        3 Nov 26 06:19 crictl -> k3s
> -rwxr-xr-x  1 root root 67735552 Nov 26 06:19 k3s
> -rwxr-xr-x  1 root root     1433 Nov 26 06:19 k3s-agent-uninstall.sh
> -rwxr-xr-x  1 root root     2026 Nov 26 06:19 k3s-killall.sh
> lrwxrwxrwx  1 root root        3 Nov 26 06:19 kubectl -> k3s
> ```
>
> 
>
> **æµ‹è¯•ï¼ˆæŒ‡å®šç¯å¢ƒå˜é‡ï¼‰ï¼š**
>
> ```bash
> root@cubmaster01:/usr/local/bin# ls -al
> total 66168
> drwxr-xr-x  2 root root     4096 Nov 26 11:16 .
> drwxr-xr-x 10 root root     4096 Aug 31 06:52 ..
> -rwxr-xr-x  1 root root 67735552 Nov 26 11:16 k3s
> -rwxr-xr-x  1 root root     2026 Nov 26 11:16 k3s-killall.sh
> -rwxr-xr-x  1 root root     1397 Nov 26 11:16 k3s-uninstall.sh
> ```

::: warning æ³¨æ„
âš ï¸ æˆ‘åœ¨ä¸Šä¸€èŠ‚ä»‹ç»äº†ä½¿ç”¨ **åˆ«å** ï¼Œå®ƒå¯ä»¥æ´¾ä¸Šç”¨åœºäº†ã€‚
:::

 

`INSTALL_K3S_SKIP_ENABLE` -- å¦‚æœè®¾ç½®ä¸º "true"ï¼Œå°†ä¸å¯ç”¨æˆ–å¯åŠ¨ K3s æœåŠ¡ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SKIP_ENABLE=true \
  sh -
```

> **å¼€å¯ï¼š**
>
> ```bash
> systemctl start k3s
> kubectl get nodes
> ```



`INSTALL_K3S_SKIP_START` -- å¦‚æœè®¾ç½®ä¸º "true "å°†ä¸ä¼šå¯åŠ¨ K3s æœåŠ¡ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SKIP_START=true \
  sh -
```



`INSTALL_K3S_VERSION` -- ä» Github ä¸‹è½½ K3s çš„ç‰ˆæœ¬ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°†å°è¯•ä»"stable"é¢‘é“ä¸‹è½½ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_VERSION="v1.19.9+k3s1" \
  sh -
```

> æ³¨æ„åé¢æ˜¯ `+`



`INSTALL_K3S_BIN_DIR` -- å®‰è£… K3s äºŒè¿›åˆ¶æ–‡ä»¶ã€é“¾æ¥å’Œå¸è½½è„šæœ¬çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨ `/usr/local/bin` ä½œä¸ºé»˜è®¤ç›®å½•ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_BIN_DIR=/opt/bin \
  sh -
```



`INSTALL_K3S_BIN_DIR_READ_ONLY` -- å¦‚æœè®¾ç½®ä¸º true å°†ä¸ä¼šæŠŠæ–‡ä»¶å†™å…¥INSTALL_K3S_BIN_DIRï¼Œå¼ºåˆ¶è®¾ç½®INSTALL_K3S_SKIP_DOWNLOAD=trueã€‚

`INSTALL_K3S_SKIP_DOWNLOAD` ä¼šåˆ›å»º `kubectl/crictl/ctr` ç­‰ï¼Œè€Œ `INSTALL_K3S_BIN_DIR_READ_ONLY` ä¸åˆ›å»ºã€‚

```
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_BIN_DIR_READ_ONLY=true \
  sh -
```



`INSTALL_K3S_SYSTEMD_DIR` -- å®‰è£… systemd æœåŠ¡å’Œç¯å¢ƒæ–‡ä»¶çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨/etc/systemd/system ä½œä¸ºé»˜è®¤ç›®å½•ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SYSTEMD_DIR=/opt/systemd \
  sh -
```

::: tip æµ‹è¯•

```bash
root@cubmaster01:/workspces/runtime# INSTALL_K3S_MIRROR=cn   INSTALL_K3S_SYSTEMD_DIR=/opt/systemd sh install.sh 
root@cubmaster01:/opt/systemd# ls -al
total 12
drwxr-xr-x 2 root root 4096 Nov 26 11:53 .
drwxr-xr-x 6 root root 4096 Nov 26 11:51 ..
-rw-r--r-- 1 root root  829 Nov 26 11:53 k3s.service
-rw------- 1 root root    0 Nov 26 11:53 k3s.service.env
```

:::





`INSTALL_K3S_EXEC` -- å¸¦æœ‰æ ‡å¿—çš„å‘½ä»¤ï¼Œç”¨äºåœ¨æœåŠ¡ä¸­å¯åŠ¨ K3sã€‚**å¦‚æœæœªæŒ‡å®šå‘½ä»¤ï¼Œå¹¶ä¸”è®¾ç½®äº† K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œagentâ€ã€‚å¦‚æœæœªè®¾ç½® K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œserverâ€ã€‚**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC="--docker" \
  sh -
```

**æœ€åçš„ systemd å‘½ä»¤è§£æä¸ºè¿™ä¸ªç¯å¢ƒå˜é‡å’Œè„šæœ¬å‚æ•°çš„ç»„åˆã€‚**ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œä»¥ä¸‹å‘½ä»¤çš„ç»“æœä¸æ³¨å†Œä¸€ä¸ªæ²¡æœ‰ flannel çš„ server çš„è¡Œä¸ºç›¸åŒï¼š

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--flannel-backend none" sh -s -
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --flannel-backend none" sh -s -
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server" sh -s - --flannel-backend none
curl -sfL https://get.k3s.io | sh -s - server --flannel-backend none
curl -sfL https://get.k3s.io | sh -s - --flannel-backend none
```



`INSTALL_K3S_NAME` -- è¦åˆ›å»ºçš„ `systemd` æœåŠ¡åç§°ï¼Œå¦‚æœä»¥æœåŠ¡å™¨æ–¹å¼è¿è¡Œ k3sï¼Œåˆ™é»˜è®¤ä¸º `'k3s'`ï¼›å¦‚æœä»¥ `agent` æ–¹å¼è¿è¡Œ `k3s`ï¼Œåˆ™é»˜è®¤ä¸º `'k3s-agent'` ã€‚å¦‚æœæŒ‡å®šäº†æœåŠ¡åï¼Œåˆ™æœåŠ¡åå°†ä»¥ `'k3s-'` ä¸ºå‰ç¼€ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_NAME="seal" \
  sh -
```



`INSTALL_K3S_TYPE` -- è¦åˆ›å»ºçš„ systemd æœåŠ¡ç±»å‹ï¼Œé»˜è®¤ä¸º notify

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_TYPE="exec" \
  sh -
```



`INSTALL_K3S_SKIP_SELINUX_RPM` -- å¦‚æœè®¾ç½®ä¸º `"true "` å°†è·³è¿‡ `k3s RPM` çš„è‡ªåŠ¨å®‰è£…ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SKIP_SELINUX_RPM=true \
  sh -
```

::: tip K3s RPM
[å®‰å…¨å¢å¼ºçš„ Linuxï¼ˆSELinuxï¼‰](https://en.wikipedia.org/wiki/Security-Enhanced_Linux)æ˜¯å¯¹ Linux çš„å®‰å…¨å¢å¼ºã€‚

å®ƒç”± Red Hat å¼€å‘ï¼Œæ˜¯ Linux ä¸Šå¼ºåˆ¶æ€§è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰çš„ä¸€ä¸ªå®ç°ã€‚å¼ºåˆ¶æ€§è®¿é—®æ§åˆ¶å…è®¸ç³»ç»Ÿç®¡ç†å‘˜å®šä¹‰åº”ç”¨ç¨‹åºå’Œç”¨æˆ·å¦‚ä½•è®¿é—®ä¸åŒçš„èµ„æºï¼Œå¦‚æ–‡ä»¶ã€è®¾å¤‡ã€ç½‘ç»œå’Œè¿›ç¨‹é—´é€šä¿¡ã€‚SELinux è¿˜é€šè¿‡ä½¿æ“ä½œç³»ç»Ÿåœ¨é»˜è®¤æƒ…å†µä¸‹å…·æœ‰é™åˆ¶æ€§è€Œå¢å¼ºäº†å®‰å…¨æ€§ã€‚

åœ¨å†å²ä¸Šè¢«æ”¿åºœæœºæ„ä½¿ç”¨åï¼ŒSELinux ç°åœ¨æ˜¯è¡Œä¸šæ ‡å‡†ï¼Œåœ¨ CentOS 7 å’Œ 8 ä¸Šé»˜è®¤å¯ç”¨ã€‚è¦æ£€æŸ¥ SELinux æ˜¯å¦åœ¨ä½ çš„ç³»ç»Ÿä¸Šå¯ç”¨å’Œæ‰§è¡Œï¼Œè¯·ä½¿ç”¨`getenforce`ã€‚

```bash
getenforce
Enforcing
```

:::



`INSTALL_K3S_CHANNEL_URL` -- ç”¨äºè·å– K3s ä¸‹è½½ç½‘å€çš„é¢‘é“ URLã€‚é»˜è®¤ä¸º https://update.k3s.io/v1-release/channels ã€‚

`INSTALL_K3S_CHANNEL` -- ç”¨äºè·å– K3s ä¸‹è½½ URL çš„é€šé“ã€‚é»˜è®¤å€¼ä¸º "stable"ã€‚é€‰é¡¹åŒ…æ‹¬ï¼š`stable`, `latest`, `testing`ã€‚

```
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_CHANNEL="latest" \
  sh -
```



`K3S_CONFIG_FILE` -- æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚é»˜è®¤ç›®å½•ä¸º`/etc/rancher/k3s/config.yaml`ã€‚

::: tip æˆ‘ä»¬å…ˆæŒ‡å®šä¸‹æ–‡ä»¶ï¼š

```bash
cat >> /opt/config.yaml <<-EOF
node-label:
- "foo=bar"
- "something=amazing"
EOF
```

:::

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_CONFIG_FILE=/opt/config.yaml \
  sh -
```

![image-20221126211751303](http://sm.nsddd.top/smimage-20221126211751303.png)





`K3S_TOKEN` -- ç”¨äºå°† server æˆ– agent åŠ å…¥é›†ç¾¤çš„å…±äº« secretã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_TOKEN=rancher-k3s \
  sh -
```

::: tip å¸Œæœ›ä½ å¯ä»¥æ‰¾åˆ°å®ƒçš„ä½ç½®

```bash
cat /var/lib/rancher/k3s/server/token
K1042465c14be8de6a57c482b4162f673addcb652acb13c8119a9900b5d27c234f7::server:rancher-k3s
```

:::



`K3S_TOKEN_FILE` -- æŒ‡å®š `cluster-secret`,`token` çš„æ–‡ä»¶ç›®å½•ã€‚

::: tip æˆ‘ä»¬éœ€è¦å…ˆæŒ‡å®šæ–‡ä»¶

```bash
cat >> /opt/token.txt <<-EOF
rancher-k3s
EOF
```

:::

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_TOKEN_FILE=/opt/token.txt \
  sh -
```

::: tip å¸Œæœ›ä½ å¯ä»¥æ‰¾åˆ°å®ƒçš„ä½ç½®

```bash
root@cubmaster01:/workspces/runtime# cat /var/lib/rancher/k3s/server/token
K10fbe884032e42976a1dd419e5d171b9bc38d50e13dc852afbc97ffb99c765f06e::server:rancher-k3s
```

:::





### æ€»ç»“

::: tip

1. ä»¥ "K3S\_"å¼€å¤´çš„ç¯å¢ƒå˜é‡å°†è¢«ä¿ç•™ï¼Œä¾› systemd å’Œ openrc æœåŠ¡ä½¿ç”¨ã€‚
2. åœ¨æ²¡æœ‰æ˜ç¡®è®¾ç½® exec å‘½ä»¤çš„æƒ…å†µä¸‹è®¾ç½® K3S_URLï¼Œä¼šå°†å‘½ä»¤é»˜è®¤ä¸º "agent"ã€‚
3. è¿è¡Œ agent æ—¶è¿˜å¿…é¡»è®¾ç½® K3S_TOKENã€‚

:::



##  å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……

å®‰è£…è„šæœ¬ä¸»è¦æ˜¯é…ç½® K3s ä½œä¸ºæœåŠ¡è¿è¡Œã€‚å¦‚æœä½ é€‰æ‹©ä¸ä½¿ç”¨è„šæœ¬ï¼Œä½ å¯ä»¥é€šè¿‡ [å‘å¸ƒé¡µé¢](https://github.com/rancher/k3s/releases/latest)ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†å…¶æ”¾åœ¨ä½ çš„ç¯å¢ƒå˜é‡è·¯å¾„ä¸Šï¼Œç„¶åæ‰§è¡Œå®ƒæ¥è¿è¡Œ K3sã€‚K3s äºŒè¿›åˆ¶æ”¯æŒä»¥ä¸‹å‘½ä»¤ï¼š

`k3s server` -- è¿è¡Œ K3s serverï¼Œå®ƒè¿˜å°†å¯åŠ¨ Kubernetes control-plane ç»„ä»¶ï¼Œå¦‚ API server, controller-manager, å’Œ schedulerã€‚

> å’Œ kubernetes çš„æ§åˆ¶å±‚é¢å¾ˆç±»ä¼¼~

```bash
root@cubmaster01:/workspces/runtime# k3s server
INFO[0000] Acquiring lock file /var/lib/rancher/k3s/data/.lock 
INFO[0000] Preparing data dir /var/lib/rancher/k3s/data/2ef87ff954adbb390309ce4dc07500f29c319f84feec1719bfb5059c8808ec6a 
INFO[0000] Starting k3s v1.25.3+k3s1 (f2585c16)         
INFO[0000] Configuring sqlite3 database connection pooling: maxIdleConns=2, maxOpenConns=0, connMaxLifetime=0s 
INFO[0000] Configuring database table schema and indexes, this may take a moment... 
INFO[0000] Database tables and indexes are up to date   
INFO[0000] Kine available at unix://kine.sock 
......
```



`k3s agent` -- è¿è¡Œ K3s agent èŠ‚ç‚¹ã€‚è¿™å°†ä½¿ K3s ä½œä¸ºå·¥ä½œèŠ‚ç‚¹è¿è¡Œï¼Œå¯åŠ¨ Kubernetes èŠ‚ç‚¹æœåŠ¡ kubelet å’Œ kube-proxyã€‚

```
root@etcnode01:~# k3s agent --server https://192.168.71.130:6443 --token K10fcaced71fc70ca6b77921a7e374dc03c34fdd1fb11973d69a2a8e937b61beb22::server:82c397ed440c496f5448ec3c4b11c112
INFO[0000] Starting k3s agent v1.25.4+k3s1 (0dc63334)   
INFO[0000] Running load balancer k3s-agent-load-balancer 127.0.0.1:6444 -> [192.168.71.130:6443] 
ERRO[0004] failed to get CA certs: Get "https://127.0.0.1:6444/cacerts": read tcp 127.0.0.1:60386->127.0.0.1:6444: read: connection reset by peer 
......
```

> ```bash
> root@cubmaster01:/opt# k3s kubectl get nodes
> NAME          STATUS   ROLES                  AGE   VERSION
> cubmaster01   Ready    control-plane,master   96m   v1.25.3+k3s1
> cubnode02     Ready    <none>                 52m   v1.25.4+k3s1
> etcnode01     Ready    <none>                 67m   v1.25.4+k3s1
> ```



`k3s kubectl` -- è¿è¡ŒåµŒå…¥å¼ kubectl CLIã€‚å¦‚æœæ²¡æœ‰è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡ï¼Œå½“å¯åŠ¨ K3s æœåŠ¡å™¨èŠ‚ç‚¹æ—¶ï¼Œå°†è‡ªåŠ¨å°è¯•ä½¿ç”¨åœ¨`/etc/rancher/k3s/k3s.yaml` åˆ›å»ºçš„é…ç½®æ–‡ä»¶ã€‚

```bash
root@k3s1:~# k3s kubectl get nodes
NAME   STATUS   ROLES                  AGE     VERSION
k3s1   Ready    control-plane,master   8m14s   v1.20.5+k3s1
k3s2   Ready    <none                11s     v1.20.5+k3s1
```



`k3s crictl` -- è¿è¡Œä¸€ä¸ªåµŒå…¥å¼ crictlã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºä¸ Kubernetes çš„å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰äº¤äº’çš„ CLIã€‚å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚

```bash
root@k3s1:~# k3s crictl ps
CONTAINER           IMAGE               CREATED             STATE               NAME                     ATTEMPT             POD ID
9ceb610df16c7       aa764f7db3051       8 minutes ago       Running             traefik                  0                   373c79416fa65
cadceb62ae08d       897ce3c5fc8ff       8 minutes ago       Running             lb-port-443              0                   f8a0ecfe56562
a26a49be485ac       897ce3c5fc8ff       8 minutes ago       Running             lb-port-80               0                   f8a0ecfe56562
01894072f2298       148c192562719       8 minutes ago       Running             local-path-provisioner   1                   b9d55e63f632f
5ccd6ed05120f       296a6d5035e2d       9 minutes ago       Running             coredns                  0                   2bae007d8e486
be0765e77a703       9dd718864ce61       9 minutes ago       Running             metrics-server           0                   53ab949c026ce
```



`k3s ctr` -- è¿è¡Œä¸€ä¸ªåµŒå…¥å¼çš„ ctrã€‚è¿™æ˜¯ä¸º containerdï¼ˆK3s ä½¿ç”¨çš„å®¹å™¨å®ˆæŠ¤è¿›ç¨‹ï¼‰æä¾›çš„ CLIã€‚å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚

```bash
root@k3s1:~# k3s ctr container ls
CONTAINER                                                           IMAGE                                                                                                               RUNTIME
01894072f2298208f3c109f9fb1d5e12e677d11cd5d0b0a3a66f550ae38644e4    docker.io/rancher/local-path-provisioner:v0.0.19                                                                    io.containerd.runc.v2
2bae007d8e486afffbbf1ffb88e97b92d367aff4b06842217de4fb5d22ecf1b9    docker.io/rancher/pause:3.1
```

`k3s server` å’Œ `k3s agent` å‘½ä»¤æœ‰é¢å¤–çš„é…ç½®é€‰é¡¹ï¼Œå¯ä»¥é€šè¿‡ `k3s server --help` æˆ– `k3s agent --help` æŸ¥çœ‹ã€‚



## é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨ K3s

é™¤äº†ä½¿ç”¨ç¯å¢ƒå˜é‡å’Œ CLI å‚æ•°æ¥é…ç½® K3sï¼ŒK3s è¿˜å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶ã€‚é»˜è®¤ç›®å½•ä½äº `/etc/rancher/k3s/config.yaml`ï¼ˆæˆ–è€…æ˜¯ `k3s.yaml` æ–‡ä»¶ï¼‰

::: warning æç¤º
å¦‚æœåŒæ—¶ä½¿ç”¨é…ç½®æ–‡ä»¶å’Œ CLI å‚æ•°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå€¼å°†ä»ä¸¤ä¸ªæ¥æºåŠ è½½ï¼Œä½† CLI å‚æ•°ä¼˜å…ˆçº§æ›´é«˜ã€‚ å¯¹äºå¯é‡å¤çš„å‚æ•°ï¼Œå¦‚--node-labelï¼ŒCLI å‚æ•°å°†è¦†ç›–åˆ—è¡¨ä¸­çš„æ‰€æœ‰å€¼ã€‚
:::



## K3s Server/Agent é…ç½®

**`write-kubeconfig` -- å°†ç®¡ç†å®¢æˆ·ç«¯çš„ kubeconfig å†™å…¥è¿™ä¸ªæ–‡ä»¶**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_KUBECONFIG_OUTPUT=/root/.kube/config \
  sh -
```



**ä½¿ç”¨ docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC="--docker" \
  sh -
```

::: tip æµ‹è¯•

```bash
root@cubmaster01:/workspces/runtime# docker ps
CONTAINER ID   IMAGE                              COMMAND                  CREATED              STATUS              PORTS     NAMES
9e9e8cd5eb22   rancher/mirrored-library-traefik   "/entrypoint.sh --glâ€¦"   14 seconds ago       Up 12 seconds                 k8s_traefik_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
8fb6d8f2c3dc   dbd43b6716a0                       "entry"                  32 seconds ago       Up 31 seconds                 k8s_lb-tcp-443_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6033d7ecc824   dbd43b6716a0                       "entry"                  32 seconds ago       Up 31 seconds                 k8s_lb-tcp-80_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6b95dbafc4ee   rancher/mirrored-pause:3.6         "/pause"                 32 seconds ago       Up 31 seconds                 k8s_POD_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
b13f33df38d9   rancher/mirrored-pause:3.6         "/pause"                 33 seconds ago       Up 31 seconds                 k8s_POD_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
5e8ce9d7d95e   rancher/mirrored-coredns-coredns   "/coredns -conf /etcâ€¦"   51 seconds ago       Up 50 seconds                 k8s_coredns_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_1
03db38691203   rancher/local-path-provisioner     "local-path-provisioâ€¦"   56 seconds ago       Up 55 seconds                 k8s_local-path-provisioner_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_1
9b087eb2f2d0   e57a417f15d3                       "/metrics-server --câ€¦"   About a minute ago   Up About a minute             k8s_metrics-server_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_1
a1ead6d83564   rancher/mirrored-pause:3.6         "/pause"                 About a minute ago   Up About a minute             k8s_POD_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_0
7a1020d7a01f   rancher/mirrored-pause:3.6         "/pause"                 About a minute ago   Up About a minute             k8s_POD_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_0
cd0e940354a9   rancher/mirrored-pause:3.6         "/pause"                 About a minute ago   Up About a minute             k8s_POD_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_0

```

:::



**é’ˆå¯¹å¤šç½‘å¡ä¸»æœºå®‰è£… K3s é›†ç¾¤**

**k3s server:**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
INSTALL_K3S_EXEC="--node-ip=192.168.99.211" \
sh -
```



**K3s agent:**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
K3S_URL=https://192.168.99.211:6443 \
K3S_TOKEN=9077b8e6f3b67b5f3e4a7723a96b199d \
INSTALL_K3S_EXEC="--node-ip=192.168.99.212" \
sh -
```



**--tls-san -- åœ¨ TLS è¯ä¹¦ä¸­æ·»åŠ å…¶ä»–ä¸»æœºåæˆ– IP ä½œä¸ºä¸»é¢˜å¤‡ç”¨åç§°**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC="--tls-san 3.97.6.45"  \
  sh -
```



ä¿®æ”¹`kube-apiserver`ã€`kube-scheduler` ã€`kube-controller-manager`ã€ `kube-cloud-controller-manager`ã€ `kubelet`ã€ `kube-proxy` å‚æ•°

**kubelet-argï¼š**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--kubelet-arg=max-pods=200' \
  sh -
```



**kube-apiserverï¼š**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--kube-apiserver-arg=service-node-port-range=40000-50000' \
  sh -
```



**kube-proxy-argï¼š**

```bash
 curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--kube-proxy-arg=proxy-mode=ipvs' \
  sh -
```



**`--data-dir -- K3s` æ•°æ®å­˜å‚¨ç›®å½•ï¼Œé»˜è®¤ä¸º `/var/lib/rancher/k3s` æˆ– `${HOME}/.rancher/k3s`(å¦‚æœä¸æ˜¯ root ç”¨æˆ·)**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--data-dir=/opt/k3s-data' \
  sh -
```

::: tip 
è¿™å°±æœ‰ç‚¹æ„æ€äº†ï¼Œæˆ‘ä»¬é»˜è®¤çš„å®‰è£…è¿ç§»äº†ï¼š

```bash
root@cubmaster01:/opt/k3s-data/server# cd /opt/k3s-data/;ls
agent  server
```

**å½“ç„¶ï¼Œæˆ‘ä»¬è‡ªå·±è®¾è®¡ç›®å½•ç»“æ„çš„æ—¶å€™æˆ–è®¸å¯ä»¥ç”¨åˆ°~**

:::



**ç¦ç”¨ç»„ä»¶ --disableï¼š**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--disable traefik' \
  sh -
```



::: tip
**ç¦ç”¨å‰ï¼š**

```bash
[root@VM-4-6-centos k3s]# ls /var/lib/rancher/k3s/server/manifests
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml  traefik.yaml
```



**ç¦ç”¨åï¼š**

```bash
root@cubmaster01:/workspces/runtime# ls /var/lib/rancher/k3s/server/manifests
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml
root@cubmaster01:/workspces/runtime# kubectl get pods -A | grep traefik
```

:::



**æ·»åŠ  label å’Œ taint:**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--node-label foo=bar,hello=world --node-taint key1=value1:NoExecute' \
  sh -
```



## ç½‘ç»œé€‰é¡¹

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`K3s` å°†ä»¥ `flannel` ä½œä¸º `CNI` è¿è¡Œï¼Œä½¿ç”¨ `VXLAN` ä½œä¸ºé»˜è®¤åç«¯ã€‚`CNI`å’Œé»˜è®¤åç«¯éƒ½å¯ä»¥é€šè¿‡å‚æ•°ä¿®æ”¹ã€‚

### Flannel é€‰é¡¹

Flannel çš„é»˜è®¤åç«¯æ˜¯ VXLANã€‚è¦å¯ç”¨åŠ å¯†ï¼Œè¯·ä½¿ç”¨ä¸‹é¢çš„ IPSecï¼ˆInternet Protocol Securityï¼‰æˆ– WireGuard é€‰é¡¹ã€‚

| CLI Flag å’Œ Value             | æè¿°                                                         |
| :---------------------------- | :----------------------------------------------------------- |
| `--flannel-backend=vxlan`     | (é»˜è®¤) ä½¿ç”¨ VXLAN åç«¯ã€‚                                     |
| `--flannel-backend=ipsec`     | ä½¿ç”¨ IPSEC åç«¯ï¼Œå¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†ã€‚                        |
| `--flannel-backend=host-gw`   | ä½¿ç”¨ host-gw åç«¯ã€‚                                          |
| `--flannel-backend=wireguard` | ä½¿ç”¨ WireGuard åç«¯ï¼Œå¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†ã€‚å¯èƒ½éœ€è¦é¢å¤–çš„å†…æ ¸æ¨¡å—å’Œé…ç½®ã€‚ |



### flannel-backend ä½¿ç”¨ `host-gw`

```bash
# K3s master
root@k3s1:~# curl -sfL https://get.k3s.io | \
        INSTALL_K3S_EXEC="--flannel-backend=host-gw" \
        INSTALL_K3S_MIRROR=cn sh -

# K3s agent 
root@k3s2:~# curl -sfL https://get.k3s.io | \
        INSTALL_K3S_MIRROR=cn K3S_URL=https://172.16.64.6:6443 \
        K3S_TOKEN=85892cbfef2177603f25be30344dbcd0 sh -
```

::: tip 

```bash
root@k3s1:~# cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json
{
	"Network": "10.42.0.0/16",
	"Backend": {
		"Type": "host-gw"
	}
}

root@k3s1:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.16.64.1     0.0.0.0         UG    100    0        0 enp0s2
10.42.0.0       0.0.0.0         255.255.255.0   U     0      0        0 cni0
10.42.1.0       172.16.64.9     255.255.255.0   UG    0      0        0 enp0s2
172.16.64.0     0.0.0.0         255.255.255.0   U     0      0        0 enp0s2
172.16.64.1     0.0.0.0         255.255.255.255 UH    100    0        0 enp0s2
```

:::



### å¯ç”¨ Directrouting

å½“ä¸»æœºåœ¨åŒä¸€å­ç½‘æ—¶ï¼Œå¯ç”¨ direct routes(å¦‚host-gw)ã€‚`vxlan` åªç”¨äºå°†æ•°æ®åŒ…å°è£…åˆ°ä¸åŒå­ç½‘çš„ä¸»æœºä¸Šï¼ŒåŒå­ç½‘çš„ä¸»æœºä¹‹é—´ä½¿ç”¨ `host-gw`ã€‚é»˜è®¤å€¼ä¸º `false`ã€‚

```bash
# K3s master å’Œ agent
cat >> /etc/net-conf.json <<EOF 
{
        "Network": "10.42.0.0/16",
        "Backend": {
            "Type": "vxlan",
            "Directrouting": true
	}
}
EOF

# K3s master
curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \
        INSTALL_K3S_EXEC="--flannel-conf=/etc/net-conf.json" \
        INSTALL_K3S_MIRROR=cn sh -
```



## è‡ªå®šä¹‰ CNI

ä½¿ç”¨ `--flannel-backend=none` è¿è¡Œ K3sï¼Œç„¶ååœ¨å®‰è£…ä½ é€‰æ‹©çš„ CNIã€‚



#### Calico

æŒ‰ç…§[Calico CNI æ’ä»¶æŒ‡å—](https://docs.projectcalico.org/master/reference/cni-plugin/configuration)ã€‚ä¿®æ”¹ Calico YAMLï¼Œåœ¨ container_settings éƒ¨åˆ†ä¸­å…è®¸ IP è½¬å‘ï¼Œä¾‹å¦‚ï¼š

```
"container_settings": {
              "allow_ip_forwarding": true
          }
```

> å¦‚ä¸é…ç½® `"allow_ip_forwarding": true`ï¼Œ `svclb-traefik` å°†ä¼šæŠ¥é”™ï¼š`/usr/bin/entry: line 6: can't create /proc/sys/net/ipv4/ip_forward: Read-only file system`

```bash
root@k3s1:~# curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \
        INSTALL_K3S_MIRROR=cn \
        INSTALL_K3S_EXEC="--flannel-backend=none \
        --cluster-cidr=192.168.200.0/24" \
        sh -
root@k3s1:~# kubectl apply -f https://raw.githubusercontent.com/kingsd041/k3s-tutorial/main/05-å®‰è£…-ç½‘ç»œé€‰é¡¹/calico.yaml
```

**å‚è€ƒï¼š**https://docs.projectcalico.org/getting-started/kubernetes/k3s/quickstart



## ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…

::: tip 
å•èŠ‚ç‚¹ k3s server é›†ç¾¤å¯ä»¥æ»¡è¶³å„ç§ç”¨ä¾‹ï¼Œä½†æ˜¯å¯¹äºéœ€è¦ Kubernetes control-plane ç¨³å®šè¿è¡Œçš„é‡è¦ç¯å¢ƒï¼Œæ‚¨å¯ä»¥åœ¨ HA é…ç½®ä¸­è¿è¡Œ K3sã€‚ä¸€ä¸ª K3s HA é›†ç¾¤ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- ä¸¤ä¸ªæˆ–å¤šä¸ª`server èŠ‚ç‚¹`ï¼Œå°†ä¸º Kubernetes API æä¾›æœåŠ¡å¹¶è¿è¡Œå…¶ä»– control-plane æœåŠ¡ã€‚
- é›¶ä¸ªæˆ–å¤šä¸ª`agent èŠ‚ç‚¹`ï¼Œç”¨äºè¿è¡Œæ‚¨çš„åº”ç”¨å’ŒæœåŠ¡ã€‚
- `å¤–éƒ¨æ•°æ®å­˜å‚¨` (ä¸å•ä¸ª k3s server è®¾ç½®ä¸­ä½¿ç”¨çš„åµŒå…¥å¼ SQLite æ•°æ®å­˜å‚¨ç›¸å)
- `å›ºå®šçš„æ³¨å†Œåœ°å€`ï¼Œä½äº server èŠ‚ç‚¹çš„å‰é¢ï¼Œä»¥å…è®¸ agent èŠ‚ç‚¹å‘é›†ç¾¤æ³¨å†Œ

> Agent é€šè¿‡å›ºå®šçš„æ³¨å†Œåœ°å€è¿›è¡Œæ³¨å†Œï¼Œä½†æ³¨å†Œåç›´æ¥ä¸å…¶ä¸­ä¸€ä¸ª server èŠ‚ç‚¹å»ºç«‹è¿æ¥ã€‚è¿™æ˜¯ä¸€ä¸ªç”± k3s agent è¿›ç¨‹å‘èµ·çš„ websocket è¿æ¥ï¼Œå¹¶ç”±ä½œä¸º agent è¿›ç¨‹ä¸€éƒ¨åˆ†è¿è¡Œçš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ç»´æŠ¤ã€‚

:::

 ### ç¯å¢ƒå‡†å¤‡

::: warning æé†’
ä¸ªäººæ¯”è¾ƒå€¾å‘äº etcdï¼ŒDqlite å·²ç»è¢«æŠ›å¼ƒäº†ï¼ŒåµŒå…¥å¼ etcd æ‰æ˜¯ yyds

:::



















+ **é€‚ç”¨åœºæ™¯**

> èµ„æºæœ‰é™çš„åœ°æ–¹ï¼Œå¦‚è¾¹ç¼˜è®¡ç®—ã€é›¾è®¡ç®—ã€ç‰©è”ç½‘çš„æ¥å…¥ç½‘å…³ç­‰

+ **è„šæœ¬-åœ¨çº¿å®‰è£…**

> \1. masterèŠ‚ç‚¹ æŒ‡å®šå®‰è£…ç‰ˆæœ¬,ä¸æŒ‡å®šå®‰è£…æœ€æ–°ç¨³å®šç‰ˆæœ¬

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# curl -sfL https://get.k3s.io | sh -
```

> \2. æ‰€æœ‰workerèŠ‚ç‚¹ tokenæ¥æºäºmasterèŠ‚ç‚¹ï¼Œç›®å½•/var/lib/rancher/k3s/server/node-token

```text
# export INSTALL_K3S_VERSION=v1.18.9
# curl -sfL https://get.k3s.io | K3S_URL=https://myserver:6443 K3S_TOKEN=XXX sh -
```


*ç­‰ä»·äº*

> \1. masterèŠ‚ç‚¹

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# sh k3s.sh
```

> \2. æ‰€æœ‰workerèŠ‚ç‚¹ æŒ‡å®šç‰ˆæœ¬ï¼Œmasterï¼Œè¿˜æœ‰ä»masterè·å–çš„token

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export K3S_URL=https://master_ip:6443 
# export K3S_TOKEN=K103b676c8815cc4fb467cb5564527c3a5b0d3415915c9a15e195ff6069589bf508::server:97d3d89ac68de226f5003869fe676718
# sh k3s.sh
```

+ **è„šæœ¬-ç¦»çº¿å®‰è£…**

> 1.å…ˆåœ¨æœ‰ç½‘ç»œçš„åœ°æ–¹ä¸‹è½½k3så®‰è£…è„šæœ¬å’ŒäºŒè¿›åˆ¶æ–‡ä»¶

```text
è„šæœ¬ï¼šhttps://get.k3s.io
é€‰æ‹©å¯¹åº”ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶: https://github.com/rancher/k3s/releases
```

> 2.å°†k3så®‰è£…è„šæœ¬æ”¾åœ¨ä»»æ„ä½ç½®ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´åˆ°ç›®æ ‡ä¸»æœºçš„/usr/local/binç›®å½•
> 3.æ·»åŠ ç¯å¢ƒå˜é‡

```text
# export INSTALL_K3S_SKIP_DOWNLOAD=true
è·³è¿‡äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½
```

> 4.åœ¨masterèŠ‚ç‚¹è¿è¡Œå®‰è£…è„šæœ¬ è¿™é‡Œçš„ç‰ˆæœ¬è¦å’Œä¸Šé¢ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶ç‰ˆæœ¬ä¸€è‡´

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# sh k3s.sh
```

> 5.åœ¨æ‰€æœ‰workerèŠ‚ç‚¹è¿è¡Œå®‰è£…è„šæœ¬ æ‰€æœ‰workerèŠ‚ç‚¹ æŒ‡å®šç‰ˆæœ¬ï¼Œmasterï¼Œè¿˜æœ‰ä»masterè·å–çš„token

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export K3S_URL=https://master_ip:6443 
# export K3S_TOKEN=K103b676c8815cc4fb467cb5564527c3a5b0d3415915c9a15e195ff6069589bf508::server:97d3d89ac68de226f5003869fe676718
# sh k3s.sh
```



+ **æ— è„šæœ¬-çº¯æ‰‹åŠ¨å®‰è£…**

> 1.ä¸‹è½½k3säºŒè¿›åˆ¶æ–‡ä»¶

[åœ°å€github.com/rancher/k3s/releases/latest](https://link.zhihu.com/?target=https%3A//github.com/rancher/k3s/releases/latest)

> 2.å¯åŠ¨masterå’Œworker

```text
> æ²¡æœ‰è„šæœ¬å¯åŠ¨æ–¹ä¾¿ï¼Œéœ€è¦è‡ªå·±æŒ‡å®šå¯åŠ¨å‚æ•°ï¼Œå¦‚serverã€agentç­‰

# sudo k3s server &
> Kubeconfig is written to /etc/rancher/k3s/k3s.yaml
# sudo k3s kubectl get nodes

> On a different node run the below. NODE_TOKEN comes from
> /var/lib/rancher/k3s/server/node-token on your server
# sudo k3s agent --server https://myserver:6443 --token ${NODE_TOKEN}
```

+ **k3sé»˜è®¤ç”¨çš„containerdï¼Œå¦‚æœè¦ç”¨dockeræ›¿æ¢containerdï¼Œåˆ™åœ¨å®‰è£…k3så‰å®‰è£…docker**

> 1.å®‰è£…docker

```text
# yum install -y yum-utils 
# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# yum makecache fast 
# yum list docker-ce --showduplicates | sort -r
# yum install -y docker-ce-19.03.8-3.el7
# systemctl start docker
# systemctl enable docker
```

> 2.å®‰è£…k3s master

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--docker --write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# sh k3s.sh
```

> 3.å®‰è£…k3s worker

```text
# æ‰€æœ‰workerèŠ‚ç‚¹ æŒ‡å®šç‰ˆæœ¬ï¼Œmasterï¼Œè¿˜æœ‰ä»masterè·å–çš„token
# export INSTALL_K3S_VERSION=v1.18.9
# export K3S_URL=https://master_ip:6443 
# export K3S_TOKEN=K103b676c8815cc4fb467cb5564527c3a5b0d3415915c9a15e195ff6069589bf508::server:97d3d89ac68de226f5003869fe676718
# sh k3s.sh
```





## END é“¾æ¥

<ul><li><div><a href = '14.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '16.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

