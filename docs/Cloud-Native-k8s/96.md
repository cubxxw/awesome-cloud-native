+ [author](http://nsddd.top)

# ç¬¬96èŠ‚ Kubernetes çš„ Kubectl è®¾è®¡å®ç°

<div><a href = '95.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '97.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## å¼€å§‹

kubectlå­å‘½ä»¤å¾ˆå¤šï¼Œä¼°è®¡å¾ˆå°‘æœ‰äººå¯ä»¥å…¨éƒ¨è®°ä½ï¼Œä½œä¸ºå¼€å‘ï¼Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰è¯•ç€æ€è€ƒä¸‹ï¼Œæ€ä¹ˆæ ·æ‰å¯ä»¥æ¯”è¾ƒçµæ´»çš„å®ç°è¿™ä¹ˆä¸°å¯Œçš„åŠŸèƒ½ï¼Œæ­¤å¤–ï¼Œå‘½ä»¤è¡Œå·¥å…·çš„ç”¨æˆ·å‹å¥½ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ã€‚



## Kubectlåˆ›å»º

ä¸€èµ·çœ‹çœ‹Kubectlçš„å¯åŠ¨ï¼š

```go
// kubernetes\cmd\kubectl\kubectl.go
func main() {
    rand.Seed(time.Now().UnixNano())

    command := cmd.NewDefaultKubectlCommand()

    if err := command.Execute(); err != nil {
        os.Exit(1)
    }
}
```



å»æ‰äº†ä¸€äº›æ— å…³ä»£ç ï¼Œä¸»è¦æ“ä½œå°±æ˜¯ä¸¤ä¸ªï¼š

```bash
1. NewDefaultKubectlCommand(): åˆ›å»ºkubectlå‘½ä»¤
2. command.Execute() ï¼š æ‰§è¡Œcommandå‘½ä»¤
```



é‡ç‚¹çœ‹ä¸‹åˆ›å»ºçš„è¿‡ç¨‹ï¼š

```go
// ä½¿ç”¨é»˜è®¤çš„åˆå§‹åŒ–å‚æ•°è°ƒç”¨NewDefaultKubectlCommandWithArgsåˆ›å»ºkubectl
func NewDefaultKubectlCommand() *cobra.Command {
    return NewDefaultKubectlCommandWithArgs(NewDefaultPluginHandler(plugin.ValidPluginFilenamePrefixes), os.Args, os.Stdin, os.Stdout, os.Stderr)
}

// å­—é¢æ„æ€
func NewDefaultKubectlCommandWithArgs(pluginHandler PluginHandler, args []string, in io.Reader, out, errout io.Writer) *cobra.Command {
    // å®é™…åˆ›å»ºkubectl
    cmd := NewKubectlCommand(in, out, errout)

    // æ£€æµ‹æ˜¯å¦å­˜åœ¨æ’ä»¶å¤„ç†å™¨
    if pluginHandler == nil {
        return cmd
    }

    if len(args) &gt; 1 {
        cmdPathPieces := args[1:]

        // æ ¹æ®ä¼ å…¥çš„å‚æ•°åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™æ ·çš„å­å‘½ä»¤ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„æ’ä»¶å¯ä»¥è°ƒç”¨ï¼Œæœ‰çš„è¯å°±è°ƒç”¨æ’ä»¶ï¼Œè°ƒç”¨å®Œéšå³æ¨å‡ºã€‚
        if _, _, err := cmd.Find(cmdPathPieces); err != nil {
            if err := HandlePluginCommand(pluginHandler, cmdPathPieces); err != nil {
                fmt.Fprintf(errout, &quot;Error: %v\n&quot;, err)
                os.Exit(1)
            }
        }
    }

    return cmd
}

```



ç›®å‰kubectlæ”¯æŒçš„å­å‘½ä»¤è‚¯å®šéƒ½ä¼šåœ¨è¿™é‡Œï¼Œè¿˜è®°å¾—ä¹‹å‰kubectlçš„æ„é€ å‡½æ•°ä¹ˆï¼ŸK8sçš„ä»£ç é‡Œï¼Œå°†è¿™äº›å­å‘½ä»¤åˆ†ä¸ºäº†å‡ ä¸ªç§ç±»ï¼š

| ç§ç±»                                   | å‘½ä»¤                                                      |
| -------------------------------------- | --------------------------------------------------------- |
| Basic Commands (Beginner)              | create\expose\run\set                                     |
| Basic Commands (Intermediate)          | explain\get\edit\delete                                   |
| Deploy Commands                        | rollout\scale\autoscale                                   |
| Cluster Management Commands            | certificate\clusterinfo\top\cordon\uncordon\drain\taint   |
| Troubleshooting and Debugging Commands | describe\logs\attach\exec\portforward\proxy\cp\auth\debug |
| Advanced Commands                      | diff\apply\patch\replace\wait\kustomize                   |
| Settings Commands                      | label\annotate\completion                                 |
| å…¶ä»–                                   | version\options\config\apiversions\apiresources           |

é‡Œé¢æœ‰ä¸€äº›å‘½ä»¤æ¯”è¾ƒå¸¸ç”¨ï¼Œæœ‰ä¸€äº›æˆ‘ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡çŸ¥é“ï¼Œæ¯”å¦‚ `debug\wait` ã€‚

è¿™äº›å­å‘½ä»¤éƒ½é€šè¿‡`AddCommand`æ–¹æ³•ï¼Œæ·»åŠ åˆ°`Command`ç»“æ„ä½“çš„æˆå‘˜å˜é‡`commands`ä¸­äº†ã€‚`commands`ä½œä¸ºä¸€ä¸ªæ•°ç»„ï¼Œä¸»è¦ç”¨äºå­˜å‚¨ç¨‹åºæ”¯æŒçš„å­å‘½ä»¤ã€‚

```go
// kubectlçš„æ‰§è¡Œé€»è¾‘
func (c *Command) ExecuteC() (cmd *Command, err error) {
    if c.ctx == nil {
        c.ctx = context.Background()
    }

    // ä»¥æ ¹å‘½ä»¤çš„å½¢å¼è¿è¡Œ
    if c.HasParent() {
        return c.Root().ExecuteC()
    }

    // çª—å£æ£€æµ‹å›è°ƒå‡½æ•°ï¼Œä¸»è¦ä½œç”¨æ˜¯æ£€æµ‹å½“å‰ç¨‹åºæ˜¯å¦æ˜¯è¢«é¼ æ ‡ç‚¹å‡»è§¦å‘çš„ï¼Œå¦‚æœä¸æ˜¯å‘½ä»¤è¡Œæ¨¡å¼ï¼ŒæŠ¥é”™ç„¶åé€€å‡º
    if preExecHookFn != nil {
        preExecHookFn(c)
    }

    // åˆå§‹åŒ–å¸®åŠ©ä¿¡æ¯ï¼Œè¦†ç›–é»˜è®¤çš„å¸®åŠ©ä¿¡æ¯
    c.InitDefaultHelpCmd()

    args := c.args

    // ä¸€äº›å¼‚å¸¸caseçš„æ£€æµ‹
    if c.args == nil &amp;&amp; filepath.Base(os.Args[0]) != &quot;cobra.test&quot; {
        args = os.Args[1:]
    }

    // å‘½ä»¤è¡¥å…¨åˆå§‹åŒ–
    c.initCompleteCmd(args)

    var flags []string
    // è¿™ä¸€æ­¥å¾ˆå…³é”®
    // è¿™ä¸€æ­¥ä¼šæ˜ç¡®å®é™…æ‰§è¡Œçš„å­å‘½ä»¤ï¼Œç„¶åèµ‹å€¼ç»™cmd
    if c.TraverseChildren {
        cmd, flags, err = c.Traverse(args)
    } else {
        cmd, flags, err = c.Find(args)
    }
    if err != nil {
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å­å‘½ä»¤ï¼Œæç¤ºå‡ºé”™
        if cmd != nil {
            c = cmd
        }
        if !c.SilenceErrors {
            c.PrintErrln(&quot;Error:&quot;, err.Error())
            c.PrintErrf(&quot;Run &#039;%v --help&#039; for usage.\n&quot;, c.CommandPath())
        }
        return c, err
    }

    // å­å‘½ä»¤æ‰§è¡Œå‰çš„å‡†å¤‡
    cmd.commandCalledAs.called = true
    if cmd.commandCalledAs.name == &quot;&quot; {
        cmd.commandCalledAs.name = cmd.Name()
    }

    // contextä¼ è¾“
    if cmd.ctx == nil {
        cmd.ctx = c.ctx
    }

    // æ‰§è¡Œ
    err = cmd.execute(flags)
    if err != nil {
        // Always show help if requested, even if SilenceErrors is in
        // effect
        if err == flag.ErrHelp {
            cmd.HelpFunc()(cmd, args)
            return cmd, nil
        }

        // If root command has SilentErrors flagged,
        // all subcommands should respect it
        if !cmd.SilenceErrors &amp;&amp; !c.SilenceErrors {
            c.PrintErrln(&quot;Error:&quot;, err.Error())
        }

        // If root command has SilentUsage flagged,
        // all subcommands should respect it
        if !cmd.SilenceUsage &amp;&amp; !c.SilenceUsage {
            c.Println(cmd.UsageString())
        }
    }
    return cmd, err
}

// commandçš„æ‰§è¡Œæ¡†æ¶
// æŒ‰ç…§
// 1. è§£æå‘½ä»¤è¡Œå‚æ•°
// 2. helpå‚æ•°æ£€æµ‹
// 3. è¿è¡Œå‰æ£€æµ‹
// 4. preRun
// 5. p.PersistentPreRun | p.PersistentPreRunE  pæ˜¯çˆ¶å‘½ä»¤
// 6. PreRunE | PreRun
// 7. RunE | Run
// 8. PostRunE | PostRun
// 9. p.PersistentPostRunE | p.PersistentPostRun
func (c *Command) execute(a []string) (err error) {
    if c == nil {
        return fmt.Errorf(&quot;Called Execute() on a nil Command&quot;)
    }

    if len(c.Deprecated) &gt; 0 {
        c.Printf(&quot;Command %q is deprecated, %s\n&quot;, c.Name(), c.Deprecated)
    }

    // initialize help and version flag at the last point possible to allow for user
    // overriding
    c.InitDefaultHelpFlag()
    c.InitDefaultVersionFlag()

    err = c.ParseFlags(a)
    if err != nil {
        return c.FlagErrorFunc()(c, err)
    }

    // If help is called, regardless of other flags, return we want help.
    // Also say we need help if the command isn&#039;t runnable.
    helpVal, err := c.Flags().GetBool(&quot;help&quot;)
    if err != nil {
        // should be impossible to get here as we always declare a help
        // flag in InitDefaultHelpFlag()
        c.Println(&quot;\&quot;help\&quot; flag declared as non-bool. Please correct your code&quot;)
        return err
    }

    if helpVal {
        return flag.ErrHelp
    }

    // for back-compat, only add version flag behavior if version is defined
    if c.Version != &quot;&quot; {
        versionVal, err := c.Flags().GetBool(&quot;version&quot;)
        if err != nil {
            c.Println(&quot;\&quot;version\&quot; flag declared as non-bool. Please correct your code&quot;)
            return err
        }
        if versionVal {
            err := tmpl(c.OutOrStdout(), c.VersionTemplate(), c)
            if err != nil {
                c.Println(err)
            }
            return err
        }
    }

    if !c.Runnable() {
        return flag.ErrHelp
    }

    c.preRun()

    argWoFlags := c.Flags().Args()
    if c.DisableFlagParsing {
        argWoFlags = a
    }

    if err := c.ValidateArgs(argWoFlags); err != nil {
        return err
    }

    for p := c; p != nil; p = p.Parent() {
        if p.PersistentPreRunE != nil {
            if err := p.PersistentPreRunE(c, argWoFlags); err != nil {
                return err
            }
            break
        } else if p.PersistentPreRun != nil {
            p.PersistentPreRun(c, argWoFlags)
            break
        }
    }
    if c.PreRunE != nil {
        if err := c.PreRunE(c, argWoFlags); err != nil {
            return err
        }
    } else if c.PreRun != nil {
        c.PreRun(c, argWoFlags)
    }

    if err := c.validateRequiredFlags(); err != nil {
        return err
    }
    if c.RunE != nil {
        if err := c.RunE(c, argWoFlags); err != nil {
            return err
        }
    } else {
        c.Run(c, argWoFlags)
    }
    if c.PostRunE != nil {
        if err := c.PostRunE(c, argWoFlags); err != nil {
            return err
        }
    } else if c.PostRun != nil {
        c.PostRun(c, argWoFlags)
    }
    for p := c; p != nil; p = p.Parent() {
        if p.PersistentPostRunE != nil {
            if err := p.PersistentPostRunE(c, argWoFlags); err != nil {
                return err
            }
            break
        } else if p.PersistentPostRun != nil {
            p.PersistentPostRun(c, argWoFlags)
            break
        }
    }

    return nil
}
```

å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œkubectlçš„åˆå§‹åŒ–å’Œå­å‘½ä»¤è°ƒç”¨çœ‹èµ·æ¥æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„å¤æ‚æ€§ã€‚



## å­å‘½ä»¤ç»“æ„è®¾è®¡

Kubectlçš„å­å‘½ä»¤ï¼Œä¸»è¦åŸºäºä¸‰ç§è®¾è®¡æ¨¡å¼ï¼šå»ºé€ è€…æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼ã€è£…é¥°å™¨æ¨¡å¼ã€‚

å»ºé€ è€…æ¨¡å¼(Builder Pattern)æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä½¿ç”¨å¤šä¸ªç®€å•çš„å¯¹è±¡ä¸€æ­¥ä¸€æ­¥æ„å»ºæˆä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ã€‚

è®¿é—®è€…æ¨¡å¼(Visitor Pattern)æ˜¯ä¸€ç§è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥å°†ç®—æ³•å’Œæ“ä½œå¯¹è±¡çš„ç»“æ„è¿›è¡Œåˆ†ç¦»ï¼Œéµå¾ªå¼€æ”¾ã€å°é—­åŸåˆ™çš„ä¸€ç§æ–¹æ³•ã€‚æˆ‘ä»¬éœ€è¦é‡ç‚¹çœ‹ä¸‹è¿™ä¸ªæ¨¡å¼æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

### è®¿é—®è€…æ¨¡å¼ç¤ºä¾‹

å†™ä¸€ä¸ªç®€å•çš„è®¿é—®è€…æ¨¡å¼çš„åº”ç”¨ï¼Œä¸»è¦å…ƒç´ æœ‰è®¿é—®å¯¹è±¡ã€è®¿é—®è€…ã€è°ƒç”¨æ–¹

```go
type Visitor func(person Person)

// åŸºç±»
// è¢«è®¿é—®çš„å¯¹è±¡ï¼Œé€šè¿‡acceptæ–¹æ³•æ¥å—è®¿é—®
type Person interface {
    accept(visitor Visitor)
}

// å­˜å‚¨å­¦ç”Ÿä¿¡æ¯çš„ç±»å‹
// å®ç°äº†Personæ¥å£
type Student struct {
    Name  string &#x60;json:&quot;name&quot;&#x60;
    Age   int    &#x60;json:&quot;age&quot;&#x60;
    Score int    &#x60;json:&quot;score&quot;&#x60;
}

func (s Student) accept(visitor Visitor) {
    visitor(s)
}

// å­˜å‚¨æ•™å¸ˆä¿¡æ¯
type Teacher struct {
    Name   string &#x60;json:&quot;name&quot;&#x60;
    Age    int    &#x60;json:&quot;age&quot;&#x60;
    Course string &#x60;json:&quot;course&quot;&#x60;
}

func (t Teacher) accept(visitor Visitor) {
    visitor(t)
}
```

å®šä¹‰ä¸¤ä¸ªç®€å•çš„è®¿é—®å™¨ï¼š

```go
// å¯¼å‡ºjsonæ ¼å¼æ•°æ®çš„è®¿é—®å™¨
func JsonVisitor(person Person) {
    bytes, err := json.Marshal(person)
    if err != nil {
        panic(err)
    }
    fmt.Println(string(bytes))
}

// å¯¼å‡ºyamlæ ¼å¼ä¿¡æ¯çš„è®¿é—®å™¨
func YamlVisitor(person Person) {
    bytes, err := yaml.Marshal(person)
    if err != nil {
        panic(err)
    }
    fmt.Println(string(bytes))
}

```

è°ƒç”¨ä¸€ä¸‹ï¼š

```go
func main() {
    s := Student{Age: 10, Name: &quot;å°æ˜&quot;, Score: 90}
    t := Teacher{Name: &quot;æ&quot;, Age: 35, Course: &quot;æ•°å­¦&quot;}
    persons := []Person{s, t}

    for _, person := range persons {
        person.accept(JsonVisitor)
        person.accept(YamlVisitor)
    }
}
```

ä¸Šé¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œçœ‹èµ·æ¥æœ‰ä¸€ç‚¹åƒç­–ç•¥æ¨¡å¼ã€‚ä¸¤è€…æ²¡æœ‰æœ¬è´¨åŒºåˆ«ï¼Œéƒ½æ˜¯é’ˆå¯¹å¤šæ€çš„ä¸€ç§å¤„ç†ã€‚ä¸è¿‡è®¿é—®è€…æ¨¡å¼æ›´ä¾§é‡å¯¹äºè¢«è®¿é—®è€…çš„çŠ¶æ€çš„ä¿®æ”¹ï¼Œè€Œç­–ç•¥æ¨¡å¼æ›´ä¾§é‡çš„æ˜¯å¤„ç†é€»è¾‘çš„æ‰©å±•ã€‚å®é™…ç”¨çš„æ—¶å€™ä¸ç”¨è€ƒè™‘é‚£ä¹ˆå¤šï¼Œæ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥å°±å¥½äº†ã€‚

ä¸Šé¢çš„ä¾‹å­æ¯”è¾ƒç®€å•ï¼Œå¤æ‚çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç»“æ„ä½“é‡Œä¼šæœ‰å¾ˆå¤šä¸åŒçš„çŠ¶æ€ï¼Œæ¯ä¸ªè®¿é—®å™¨è´Ÿè´£ä¿®æ”¹ä¸€éƒ¨åˆ†çŠ¶æ€ã€‚kubectlä¸­å°±æ˜¯è¿™æ ·çš„åœºæ™¯ã€‚



### Kubectlå¯¹äºè®¿é—®è€…æ¨¡å¼çš„åº”ç”¨

åœ¨k8sä¸­ï¼Œå­˜åœ¨å„ç§å„æ ·çš„èµ„æºç±»å‹ï¼Œæ¯ä¸ªç±»å‹éƒ½åŒ…å«å¤æ‚çš„çŠ¶æ€ä¿¡æ¯ï¼Œæœ‰äº›æ˜¯å…¬ç”¨çš„ï¼Œæœ‰çš„æ˜¯ç‹¬æœ‰çš„ã€‚

kubectlçš„å­å‘½ä»¤ï¼Œéœ€è¦å¯¹ä¸åŒçš„èµ„æºç±»å‹åšå‡ºå¤„ç†ï¼Œ

å¤„ç†æµç¨‹ä¸Šï¼š

1. è¯»å–å‘½ä»¤è¡Œå‚æ•°ã€æˆ–è€…è¯»å–æŒ‡å®šæ–‡ä»¶ã€æˆ–è€…è¯»å–url,æ„å»ºå‘½ä»¤ 
2. è°ƒç”¨k8sçš„client,å‘ API Serverå‘èµ·è¯·æ±‚
3. å®Œæˆå¤„ç†

å¤„ç†é€»è¾‘ä¸Š,å¯ä»¥æŠ½è±¡ä¸ºï¼š 

1. è·å–å‚æ•°
2. Builderæ¨¡å¼æ„å»ºä¸€ä¸ªèµ„æºçš„é›†åˆ
3. ä½¿ç”¨visitoræ¨¡å¼å¤„ç†è¿™äº›èµ„æºçŠ¶æ€çš„é›†åˆï¼ŒåŒ…æ‹¬æœ¬åœ°èµ„æºçš„ä¿®æ”¹æ“ä½œã€å‘Api Serverçš„è¯·æ±‚æ“ä½œ
4. å®Œæˆå¤„ç†

è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒæŠ½è±¡çš„è¿‡ç¨‹ã€‚ä¸‹é¢å¯ä»¥å…·ä½“çœ‹ä¸€ä¸‹å®é™…å®ç°çš„ä»£ç 

```go
// Info å°è£…äº†ä¸€äº›clientè°ƒç”¨æ—¶æ‰€éœ€è¦çš„åŸºæœ¬ä¿¡æ¯
type Info struct {
    // åªæœ‰éœ€è¦è¿œç«¯è°ƒç”¨çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–clientå’Œmapping
    Client RESTClient
    Mapping *meta.RESTMapping

    // æŒ‡å®šnamespaceçš„æ—¶å€™æ‰ä¼šè®¾ç½®è¿™ä¸ªå‚æ•°
    Namespace string
    Name      string

    // å¯é€‰å‚æ•° urlæˆ–è€…æ–‡ä»¶è·¯å¾„
    Source string

    Object runtime.Object
    ResourceVersion string
}

// è®¿é—®å™¨åŸºç±»ï¼Œç”¨äºä¿®æ”¹èµ„æºç±»å‹çš„æ“ä½œ
type Visitor interface {
    Visit(VisitorFunc) error
}

type VisitorFunc func(*Info, error) error
```

å¯ä»¥çœ‹åˆ°ï¼ŒVisitorç±»å‹é‡ŒåŒ…å«æ–¹æ³•Visitï¼ŒVisitçš„å‚æ•°æ˜¯ä¸€ä¸ªVisitorFuncã€‚

ä¸ºäº†æ–¹ä¾¿ç†è§£Visitorçš„ä½¿ç”¨ï¼Œå…ˆä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å®šä¹‰å‡ ä¸ªä¸åŒç±»å‹çš„Visitor

```go
// name visitor
// å‡è®¾è¿™ä¸ªvisitorä¸»è¦ç”¨äºè®¿é—® Info ç»“æ„ä¸­çš„ Name å’Œ NameSpace æˆå‘˜
type NameVisitor struct {
  visitor Visitor
}

func (v NameVisitor) Visit(fn VisitorFunc) error {
  return v.visitor.Visit(func(info *Info, err error) error {
    fmt.Println(&quot;NameVisitor() before call function&quot;)
    err = fn(info, err)
    if err == nil {
      fmt.Printf(&quot;==&gt; Name=%s, NameSpace=%s\n&quot;, info.Name, info.Namespace)
    }
    fmt.Println(&quot;NameVisitor() after call function&quot;)
    return err
  })
}

// Other Visitor
// è¿™ä¸ªVisitorä¸»è¦ç”¨æ¥è®¿é—® Info ç»“æ„ä¸­çš„ OtherThings æˆå‘˜
type OtherThingsVisitor struct {
  visitor Visitor
}

func (v OtherThingsVisitor) Visit(fn VisitorFunc) error {
  return v.visitor.Visit(func(info *Info, err error) error {
    fmt.Println(&quot;OtherThingsVisitor() before call function&quot;)
    err = fn(info, err)
    if err == nil {
      fmt.Printf(&quot;==&gt; OtherThings=%s\n&quot;, info.OtherThings)
    }
    fmt.Println(&quot;OtherThingsVisitor() after call function&quot;)
    return err
  })
}

// Log Visitor
type LogVisitor struct {
  visitor Visitor
}
func (v LogVisitor) Visit(fn VisitorFunc) error {
  return v.visitor.Visit(func(info *Info, err error) error {
    fmt.Println(&quot;LogVisitor() before call function&quot;)
    err = fn(info, err)
    fmt.Println(&quot;LogVisitor() after call function&quot;)
    return err
  })
}
// è°ƒç”¨é€»è¾‘
func main() {
  info := Info{}
  var v Visitor = &amp;info
  v = LogVisitor{v}
  v = NameVisitor{v}
  v = OtherThingsVisitor{v}

  loadFile := func(info *Info, err error) error {
    info.Name = &quot;Hao Chen&quot;
    info.Namespace = &quot;MegaEase&quot;
    info.OtherThings = &quot;We are running as remote team.&quot;
    return nil
  }
  v.Visit(loadFile)
}
```

ä¸Šé¢çš„ä»£ç ï¼Œæ¯ä¸ªvisitoré‡Œ

- æœ‰ä¸€ä¸ª `Visitor` æ¥å£æˆå‘˜ï¼Œè¿™é‡Œæ„å‘³ç€å¤šæ€ã€‚
- åœ¨å®ç° `Visit()` æ–¹æ³•æ—¶ï¼Œå…¶è°ƒç”¨äº†è‡ªå·±ç»“æ„ä½“å†…çš„é‚£ä¸ª `Visitor`çš„ `Visitor()` æ–¹æ³•ï¼Œè¿™å…¶å®æ˜¯ä¸€ç§ä¿®é¥°å™¨çš„æ¨¡å¼ï¼Œç”¨å¦ä¸€ä¸ªVisitorä¿®é¥°äº†è‡ªå·±

è°ƒç”¨åï¼Œè¾“å‡ºå¦‚ä¸‹ä¿¡æ¯

```bash
LogVisitor() before call function
NameVisitor() before call function
OtherThingsVisitor) before call function
==&gt; OtherThings=We are as remote team.
OtherThingsVisitor() after call function
==&gt; Name=Hao Chen, NameSpace=MegaEase
NameVisitor() after call function
LogVisitor() after call function
```

æ˜¾è€Œæ˜“è§ï¼Œä¸Šé¢çš„ä»£ç æœ‰ä»¥ä¸‹å‡ ç§åŠŸæ•ˆï¼š

- è§£è€¦äº†æ•°æ®å’Œç¨‹åºã€‚
- ä½¿ç”¨äº†ä¿®é¥°å™¨æ¨¡å¼
- è¿˜åšå‡ºæ¥pipelineçš„æ¨¡å¼

ææ¸…æ¥šä¸Šè¿°é€»è¾‘åï¼Œåœ¨å›è¿‡æ¥çœ‹k8sçš„å®ç°å°±ä¼šä¸€ç›®äº†ç„¶

```go
// Decorate å°±æ˜¯è£…é¥°çš„æ„æ€ï¼Œæ˜¾è€Œæ˜“è§ï¼Œè£…é¥°è¿‡çš„è®¿é—®å™¨
type DecoratedVisitor struct {
    visitor    Visitor
    // ä¸€ä¸ªè£…é¥°å™¨é›†åˆ
    decorators []VisitorFunc
}

// Visit implements Visitor
// 1. ä¸‹æ½œä¸€å±‚ï¼Œè°ƒç”¨è‡ªå·±çš„Visitorå†…çš„è®¿é—®å™¨æ–¹æ³•
// 2. è°ƒç”¨è‡ªå·± æ‰€æœ‰è£…é¥°è€…æ–¹æ³•ï¼Œå³è‡ªèº«çš„è®¿é—®å™¨
// 3. æœ€åå†è°ƒç”¨ä¼ å…¥çš„fn
// è¾¾åˆ°ä¸€ç§åµŒå¥—è°ƒç”¨ã€é“¾å¼è°ƒç”¨çš„æ•ˆæœ
func (v DecoratedVisitor) Visit(fn VisitorFunc) error {
    return v.visitor.Visit(func(info *Info, err error) error {
        if err != nil {
            return err
        }
        for i := range v.decorators {
            if err := v.decorators[i](info, nil); err != nil {
                return err
            }
        }
        return fn(info, nil)
    })
}
```

ä¸Šé¢çš„ä»£ç å¹¶ä¸å¤æ‚ï¼Œ

- ç”¨ä¸€ä¸ª `DecoratedVisitor` çš„ç»“æ„æ¥å­˜æ”¾æ‰€æœ‰çš„`VistorFunc`å‡½æ•°
- `NewDecoratedVisitor` å¯ä»¥æŠŠæ‰€æœ‰çš„ `VisitorFunc`è½¬ç»™å®ƒï¼Œæ„é€  `DecoratedVisitor` å¯¹è±¡ã€‚
- `DecoratedVisitor`å®ç°äº† `Visit()` æ–¹æ³•ï¼Œé‡Œé¢å°±æ˜¯æ¥åšä¸€ä¸ªfor-loopï¼Œé¡ºç€è°ƒç”¨æ‰€æœ‰çš„ `VisitorFunc`

**ç”¨ä¸€ä¸ªéå¸¸å·§å¦™çš„æ–¹æ³•ï¼ŒæŠŠè£…é¥°å™¨æ¨¡å¼å’Œè®¿é—®è€…æ¨¡å¼ç»“åˆåœ¨äº†ä¸€èµ·ï¼ŒåˆæŠŠæ“ä½œä¸æ•°æ®è§£è€¦ã€æ“ä½œä¸æ“ä½œè§£è€¦ï¼Œå¹ä¸ºè§‚æ­¢ï¼**

é‚£æ€ä¹ˆè°ƒç”¨å‘¢ï¼Ÿ

```go
Explaininfo := Info{}
var v Visitor = &amp;info
v = NewDecoratedVisitor(v, NameVisitor, OtherVisitor)

v.Visit(LoadFile)
```

ä¸¾ä¸ªä¾‹å­ï¼Œkubectlçš„applyæ–¹æ³•çš„å®ç°ï¼š

```go
// è·¯å¾„ vendor/k8s.io/kubectl/pkg/cmd/apply/apply.go
func (o *ApplyOptions) GetObjects() ([]*resource.Info, error) {
    var err error = nil
    if !o.objectsCached {
        // é€šè¿‡builderæ¨¡å¼ï¼Œé€æ­¥æ„å»ºä¸€ä¸ªå®Œæ•´çš„èµ„æºå¯¹è±¡
        r := o.Builder.
            Unstructured().
            Schema(o.Validator).
            ContinueOnError().
            NamespaceParam(o.Namespace).DefaultNamespace().
            FilenameParam(o.EnforceNamespace, &amp;o.DeleteOptions.FilenameOptions).
            LabelSelectorParam(o.Selector).
            Flatten().
            Do()
        o.objects, err = r.Infos()
        o.objectsCached = true
    }
    return o.objects, err
}

// è·¯å¾„ k8s.io/cli-runtime/pkg/resource/builder.go
func (b *Builder) Do() *Result {
    r := b.visitorResult()
    r.mapper = b.Mapper()
    if r.err != nil {
        return r
    }
    if b.flatten {
        r.visitor = NewFlattenListVisitor(r.visitor, b.objectTyper, b.mapper)
    }
    // è®¿é—®å™¨æ–¹æ³•é›†åˆ
    helpers := []VisitorFunc{}
    if b.defaultNamespace {
        // è®¾ç½®namespaceçš„è®¿é—®å™¨ SetNamespace
        helpers = append(helpers, SetNamespace(b.namespace))
    }
    if b.requireNamespace {
        // éœ€è¦namespaceçš„æç¤ºæ“ä½œ RequireNamespace
        helpers = append(helpers, RequireNamespace(b.namespace))
    }
    // è¿‡æ»¤namespaceçš„è®¿é—®å™¨ FilterNamespace
    helpers = append(helpers, FilterNamespace)
    if b.requireObject {
        // å¦ä¸€ä¸ªè®¿é—®å™¨
        helpers = append(helpers, RetrieveLazy)
    }
    if b.continueOnError {
        // æ„é€ è¢«è£…é¥°çš„è®¿é—®è€…
        r.visitor = NewDecoratedVisitor(ContinueOnErrorVisitor{r.visitor}, helpers...)
    } else {
        r.visitor = NewDecoratedVisitor(r.visitor, helpers...)
    }
    return r
}
```

kubectlçš„å­å‘½ä»¤åŸºæœ¬éƒ½æ˜¯è¿™æ ·çš„å·¥ä½œæ¨¡å¼ã€‚

å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å°±éœ€è¦çœ‹å®é™…çš„å¤„ç†éœ€æ±‚äº†ã€‚



## END é“¾æ¥
<ul><li><div><a href = '95.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '97.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

