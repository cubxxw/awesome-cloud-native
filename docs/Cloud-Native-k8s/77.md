+ [author](http://nsddd.top)

# ç¬¬77èŠ‚ ç®¡ç†é›†ç¾¤ä¸­çš„ TLS è®¤è¯

<div><a href = '76.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '78.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## ç®¡ç†é›†ç¾¤ä¸­çš„ TLS è®¤è¯

Kubernetes æä¾› `certificates.k8s.io` APIï¼Œå¯è®©ä½ é…ç½®ç”±ä½ æ§åˆ¶çš„è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰ ç­¾åçš„ TLS è¯ä¹¦ã€‚ ä½ çš„å·¥ä½œè´Ÿè½½å¯ä»¥ä½¿ç”¨è¿™äº› CA å’Œè¯ä¹¦æ¥å»ºç«‹ä¿¡ä»»ã€‚

`certificates.k8s.io` APIä½¿ç”¨çš„åè®®ç±»ä¼¼äº [ACME è‰æ¡ˆ](https://github.com/ietf-wg-acme/acme/)ã€‚



### é›†ç¾¤ä¸­çš„ TLS ä¿¡ä»»

ä¿¡ä»» Pod ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºæ‰€æä¾›çš„[è‡ªå®šä¹‰ CA](https://kubernetes.io/zh-cn/docs/tasks/tls/managing-tls-in-a-cluster/#configuring-your-cluster-to-provide-signing) é€šå¸¸éœ€è¦ä¸€äº›é¢å¤–çš„åº”ç”¨ç¨‹åºé…ç½®ã€‚ ä½ éœ€è¦å°† CA è¯ä¹¦åŒ…æ·»åŠ åˆ° TLS å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ä¿¡ä»»çš„ CA è¯ä¹¦åˆ—è¡¨ä¸­ã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ Golang TLS é…ç½®é€šè¿‡è§£æè¯ä¹¦é“¾å¹¶å°†è§£æçš„è¯ä¹¦æ·»åŠ åˆ° [`tls.Config`](https://pkg.go.dev/crypto/tls#Config) ç»“æ„ä¸­çš„ `RootCAs` å­—æ®µä¸­ã€‚

> **è¯´æ˜ï¼š**
>
> å³ä½¿è‡ªå®šä¹‰ CA è¯ä¹¦å¯èƒ½åŒ…å«åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ˆåœ¨ ConfigMap `kube-root-ca.crt` ä¸­ï¼‰ï¼Œ é™¤äº†éªŒè¯å†…éƒ¨ Kubernetes ç«¯ç‚¹ä¹‹å¤–ï¼Œä½ ä¸åº”å°†è¯¥è¯ä¹¦é¢å‘æœºæ„ç”¨äºä»»ä½•ç›®çš„ã€‚ å†…éƒ¨ Kubernetes ç«¯ç‚¹çš„ä¸€ä¸ªç¤ºä¾‹æ˜¯é»˜è®¤å‘½åç©ºé—´ä¸­åä¸º `kubernetes` çš„æœåŠ¡ã€‚
>
> å¦‚æœä½ æƒ³ä¸ºä½ çš„å·¥ä½œè´Ÿè½½ä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦é¢å‘æœºæ„ï¼Œä½ åº”è¯¥å•ç‹¬ç”Ÿæˆè¯¥ CAï¼Œ å¹¶ä½¿ç”¨ä½ çš„ Pod æœ‰è¯»æƒé™çš„ [ConfigMap](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap) åˆ†å‘è¯¥ CA è¯ä¹¦ã€‚



### è¯·æ±‚è¯ä¹¦

ä»¥ä¸‹éƒ¨åˆ†æ¼”ç¤ºå¦‚ä½•ä¸ºé€šè¿‡ DNS è®¿é—®çš„ Kubernetes æœåŠ¡åˆ›å»º TLS è¯ä¹¦ã€‚

> **è¯´æ˜ï¼š** æœ¬æ•™ç¨‹ä½¿ç”¨ CFSSLï¼šCloudflare's PKI å’Œ TLS å·¥å…·åŒ… [ç‚¹å‡»æ­¤å¤„](https://blog.cloudflare.com/introducing-cfssl/)äº†è§£æ›´å¤šä¿¡æ¯ã€‚



### åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚

é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆç§é’¥å’Œè¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆæˆ– CSRï¼‰:

```
cat <<EOF | cfssl genkey - | cfssljson -bare server
{
  "hosts": [
    "my-svc.my-namespace.svc.cluster.local",
    "my-pod.my-namespace.pod.cluster.local",
    "192.0.2.24",
    "10.0.34.2"
  ],
  "CN": "my-pod.my-namespace.pod.cluster.local",
  "key": {
    "algo": "ecdsa",
    "size": 256
  }
}
EOF
```

å…¶ä¸­ `192.0.2.24` æ˜¯æœåŠ¡çš„é›†ç¾¤ IPï¼Œ`my-svc.my-namespace.svc.cluster.local` æ˜¯æœåŠ¡çš„ DNS åç§°ï¼Œ`10.0.34.2` æ˜¯ Pod çš„ IPï¼Œè€Œ `my-pod.my-namespace.pod.cluster.local` æ˜¯ Pod çš„ DNS åç§°ã€‚ ä½ èƒ½çœ‹åˆ°çš„è¾“å‡ºç±»ä¼¼äºï¼š

```
2022/02/01 11:45:32 [INFO] generate received request
2022/02/01 11:45:32 [INFO] received CSR
2022/02/01 11:45:32 [INFO] generating key: ecdsa-256
2022/02/01 11:45:32 [INFO] encoded CSR
```

æ­¤å‘½ä»¤ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼›å®ƒç”ŸæˆåŒ…å« PEM ç¼–ç  [PKCS#10](https://tools.ietf.org/html/rfc2986) è¯ä¹¦è¯·æ±‚çš„ `server.csr`ï¼Œ ä»¥åŠ PEM ç¼–ç å¯†é’¥çš„ `server-key.pem`ï¼Œç”¨äºå¾…ç”Ÿæˆçš„è¯ä¹¦ã€‚



### åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰å¯¹è±¡å‘é€åˆ° Kubernetes API

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»º CSR æ¸…å•ï¼ˆYAML æ ¼å¼ï¼‰ï¼Œå¹¶å‘é€åˆ° API æœåŠ¡å™¨ï¼š

```shell
cat <<EOF | kubectl apply -f -
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: my-svc.my-namespace
spec:
  request: $(cat server.csr | base64 | tr -d '\n')
  signerName: example.com/serving
  usages:
  - digital signature
  - key encipherment
  - server auth
EOF
```

è¯·æ³¨æ„ï¼Œåœ¨æ­¥éª¤ 1 ä¸­åˆ›å»ºçš„ `server.csr` æ–‡ä»¶æ˜¯ base64 ç¼–ç å¹¶å­˜å‚¨åœ¨ `.spec.request` å­—æ®µä¸­çš„ã€‚ä½ è¿˜è¦æ±‚æä¾› â€œdigital signatureï¼ˆæ•°å­—ç­¾åï¼‰â€ï¼Œ â€œå¯†é’¥åŠ å¯†ï¼ˆkey enciphermentï¼‰â€ å’Œ â€œæœåŠ¡å™¨èº«ä»½éªŒè¯ï¼ˆserver authï¼‰â€ å¯†é’¥ç”¨é€”ï¼Œ ç”± `example.com/serving` ç¤ºä¾‹ç­¾åç¨‹åºç­¾åçš„è¯ä¹¦ã€‚ ä½ ä¹Ÿå¯ä»¥è¦æ±‚ä½¿ç”¨ç‰¹å®šçš„ `signerName`ã€‚æ›´å¤šä¿¡æ¯å¯å‚é˜… [æ”¯æŒçš„ç­¾ç½²è€…åç§°](https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#signers)ã€‚

åœ¨ API server ä¸­å¯ä»¥çœ‹åˆ°è¿™äº› CSR å¤„äº Pending çŠ¶æ€ã€‚æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ä½ å°†å¯ä»¥çœ‹åˆ°ï¼š

```bash
kubectl describe csr my-svc.my-namespace
```



### æ‰¹å‡†è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰

[è¯ä¹¦ç­¾åè¯·æ±‚](https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/) çš„æ‰¹å‡†æˆ–è€…æ˜¯é€šè¿‡è‡ªåŠ¨æ‰¹å‡†è¿‡ç¨‹å®Œæˆçš„ï¼Œæˆ–ç”±é›†ç¾¤ç®¡ç†å‘˜ä¸€æ¬¡æ€§å®Œæˆã€‚ å¦‚æœä½ è¢«æˆæƒæ‰¹å‡†è¯ä¹¦è¯·æ±‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ `kubectl` æ¥æ‰‹åŠ¨å®Œæˆæ­¤æ“ä½œï¼›ä¾‹å¦‚ï¼š

```shell
kubectl certificate approve my-svc.my-namespace
```

> åˆ¤æ–­çŠ¶æ€ï¼šStatus:             Approved

ä½ ç°åœ¨åº”è¯¥èƒ½çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```shell
controlplane $ kubectl get csr
NAME                  AGE     SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
csr-46sxj             37d     kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:z6kr08    <none>              Approved,Issued
csr-6z592             38d     kubernetes.io/kube-apiserver-client-kubelet   system:node:controlplane   <none>              Approved,Issued
my-svc.my-namespace   9m17s   example.com/serving                           kubernetes-admin           <none>              Approved
```

è¿™æ„å‘³ç€è¯ä¹¦è¯·æ±‚å·²è¢«æ‰¹å‡†ï¼Œå¹¶æ­£åœ¨ç­‰å¾…è¯·æ±‚çš„ç­¾åè€…å¯¹å…¶ç­¾åã€‚



### ç­¾åè¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSR)

æ¥ä¸‹æ¥ï¼Œä½ å°†æ‰®æ¼”è¯ä¹¦ç­¾ç½²è€…çš„è§’è‰²ï¼Œé¢å‘è¯ä¹¦å¹¶å°†å…¶ä¸Šä¼ åˆ° API æœåŠ¡å™¨ã€‚

ç­¾åè€…é€šå¸¸ä¼šä½¿ç”¨å…¶ `signerName` æŸ¥çœ‹å¯¹è±¡çš„ CertificateSigningRequest APIï¼Œ æ£€æŸ¥å®ƒä»¬æ˜¯å¦å·²è¢«æ‰¹å‡†ï¼Œä¸ºè¿™äº›è¯·æ±‚ç­¾ç½²è¯ä¹¦ï¼Œå¹¶ä½¿ç”¨å·²é¢å‘çš„è¯ä¹¦æ›´æ–° API å¯¹è±¡çŠ¶æ€ã€‚



### åˆ›å»ºè¯ä¹¦é¢å‘æœºæ„

ä½ éœ€è¦æˆæƒåœ¨æ–°è¯ä¹¦ä¸Šæä¾›æ•°å­—ç­¾åã€‚

é¦–å…ˆï¼Œé€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºç­¾åè¯ä¹¦ï¼š

```shell
cat <<EOF | cfssl gencert -initca - | cfssljson -bare ca
{
  "CN": "My Example Signer",
  "key": {
    "algo": "rsa",
    "size": 2048
  }
}
EOF
```

ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼äºä»¥ä¸‹çš„è¾“å‡ºï¼š

```none
2022/02/01 11:50:39 [INFO] generating a new CA key and certificate from CSR
2022/02/01 11:50:39 [INFO] generate received request
2022/02/01 11:50:39 [INFO] received CSR
2022/02/01 11:50:39 [INFO] generating key: rsa-2048
2022/02/01 11:50:39 [INFO] encoded CSR
2022/02/01 11:50:39 [INFO] signed certificate with serial number 263983151013686720899716354349605500797834580472
```

è¿™ä¼šäº§ç”Ÿä¸€ä¸ªè¯ä¹¦é¢å‘æœºæ„å¯†é’¥æ–‡ä»¶ï¼ˆ`ca-key.pem`ï¼‰å’Œè¯ä¹¦ï¼ˆ`ca.pem`ï¼‰ã€‚



### ä¸‹è½½è¯ä¹¦å¹¶ä½¿ç”¨å®ƒ

ç°åœ¨ï¼Œä½œä¸ºè¯·æ±‚ç”¨æˆ·ï¼Œä½ å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¸‹è½½é¢å‘çš„è¯ä¹¦å¹¶å°†å…¶ä¿å­˜åˆ° `server.crt` æ–‡ä»¶ä¸­ï¼š

CSR è¢«ç­¾ç½²å¹¶è·å¾—æ‰¹å‡†åï¼Œä½ åº”è¯¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š

```shell
kubectl get csr my-svc.my-namespace -o jsonpath='{.status.certificate}' \
    | base64 --decode > server.crt
```

ç°åœ¨ä½ å¯ä»¥å°† `server.crt` å’Œ `server-key.pem` å¡«å……åˆ° [Secret](https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/) ä¸­ï¼Œ ç¨åä½ å¯ä»¥å°†å…¶æŒ‚è½½åˆ° Pod ä¸­ï¼ˆä¾‹å¦‚ï¼Œç”¨äºæä¾› HTTPS çš„ç½‘ç»œæœåŠ¡å™¨ï¼‰ã€‚

```shell
kubectl create secret tls server --cert server.crt --key server-key.pem
secret/server created
```

æœ€åï¼Œä½ å¯ä»¥å°† `ca.pem` å¡«å……åˆ° [ConfigMap](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/) å¹¶å°†å…¶ç”¨ä½œä¿¡ä»»æ ¹æ¥éªŒè¯æœåŠ¡è¯ä¹¦ï¼š

```shell
kubectl create configmap example-serving-ca --from-file ca.crt=ca.pem
configmap/example-serving-ca created
```



### æ‰¹å‡†è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰

Kubernetes ç®¡ç†å‘˜ï¼ˆå…·æœ‰é€‚å½“æƒé™ï¼‰å¯ä»¥ä½¿ç”¨ `kubectl certificate approve` å’Œ `kubectl certificate deny` å‘½ä»¤æ‰‹åŠ¨æ‰¹å‡†ï¼ˆæˆ–æ‹’ç»ï¼‰è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰ã€‚ ä½†æ˜¯ï¼Œå¦‚æœä½ æ‰“ç®—å¤§é‡ä½¿ç”¨æ­¤ APIï¼Œåˆ™å¯ä»¥è€ƒè™‘ç¼–å†™è‡ªåŠ¨åŒ–çš„è¯ä¹¦æ§åˆ¶å™¨ã€‚

**æ³¨æ„ï¼š**

æ‰¹å‡†è¯ä¹¦ CSR çš„èƒ½åŠ›å†³å®šäº†åœ¨ä½ çš„ç¯å¢ƒä¸­è°ä¿¡ä»»è°ã€‚ ä¸åº”å¹¿æ³›æˆ–è½»ç‡åœ°æˆäºˆæ‰¹å‡† CSR çš„èƒ½åŠ›ã€‚

åœ¨æˆäºˆ `approve` æƒé™ä¹‹å‰ï¼Œä½ åº”è¯¥ç¡®ä¿è‡ªå·±å……åˆ†äº†è§£æ‰¹å‡†äººçš„éªŒè¯è¦æ±‚**å’Œ**é¢å‘ç‰¹å®šè¯ä¹¦çš„åæœã€‚

æ— è®ºä¸Šè¿°æœºå™¨æˆ–äººä½¿ç”¨ kubectlï¼Œâ€œæ‰¹å‡†è€…â€çš„ä½œç”¨æ˜¯éªŒè¯ CSR æ»¡è¶³å¦‚ä¸‹ä¸¤ä¸ªè¦æ±‚ï¼š

1. CSR çš„ subject æ§åˆ¶ç”¨äºç­¾ç½² CSR çš„ç§é’¥ã€‚è¿™è§£å†³äº†ä¼ªè£…æˆæˆæƒä¸»ä½“çš„ç¬¬ä¸‰æ–¹çš„å¨èƒã€‚ åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæ­¤æ­¥éª¤å°†éªŒè¯è¯¥ Pod æ§åˆ¶äº†ç”¨äºç”Ÿæˆ CSR çš„ç§é’¥ã€‚
2. CSR çš„ subject è¢«æˆæƒåœ¨è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚ è¿™ç‚¹ç”¨äºå¤„ç†ä¸æœŸæœ›çš„ä¸»ä½“è¢«åŠ å…¥é›†ç¾¤çš„å¨èƒã€‚ åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæ­¤æ­¥éª¤å°†æ˜¯éªŒè¯è¯¥ Pod æ˜¯å¦è¢«å…è®¸åŠ å…¥åˆ°æ‰€è¯·æ±‚çš„æœåŠ¡ä¸­ã€‚

å½“ä¸”ä»…å½“æ»¡è¶³è¿™ä¸¤ä¸ªè¦æ±‚æ—¶ï¼Œå®¡æ‰¹è€…åº”è¯¥æ‰¹å‡† CSRï¼Œå¦åˆ™æ‹’ç» CSRã€‚

æœ‰å…³è¯ä¹¦æ‰¹å‡†å’Œè®¿é—®æ§åˆ¶çš„æ›´å¤šä¿¡æ¯ï¼Œ è¯·é˜…è¯»[è¯ä¹¦ç­¾åè¯·æ±‚](https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/)å‚è€ƒé¡µã€‚



## æ‰‹åŠ¨è½®æ¢ CA è¯ä¹¦

**æ³¨æ„ï¼š**

ç¡®ä¿å¤‡ä»½ä½ çš„è¯ä¹¦ç›®å½•ã€é…ç½®æ–‡ä»¶ä»¥åŠå…¶ä»–å¿…è¦æ–‡ä»¶ã€‚

è¿™é‡Œçš„æ–¹æ³•å‡å®š Kubernetes çš„æ§åˆ¶é¢é€šè¿‡è¿è¡Œå¤šä¸ª API æœåŠ¡å™¨ä»¥é«˜å¯ç”¨é…ç½®æ¨¡å¼è¿è¡Œã€‚ å¦ä¸€å‡å®šæ˜¯ API æœåŠ¡å™¨å¯ä½“é¢åœ°ç»ˆæ­¢ï¼Œå› è€Œå®¢æˆ·ç«¯å¯ä»¥å½»åº•åœ°ä¸ä¸€ä¸ª API æœåŠ¡å™¨æ–­å¼€ è¿æ¥å¹¶è¿æ¥åˆ°å¦ä¸€ä¸ª API æœåŠ¡å™¨ã€‚

å¦‚æœé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ª API æœåŠ¡å™¨ï¼Œåˆ™åœ¨ API æœåŠ¡å™¨é‡å¯æœŸé—´ä¼šç»å†æœåŠ¡ä¸­æ–­æœŸã€‚

1. å°†æ–°çš„ CA è¯ä¹¦å’Œç§é’¥ï¼ˆä¾‹å¦‚ï¼š`ca.crt`ã€`ca.key`ã€`front-proxy-ca.crt` å’Œ `front-proxy-client.key`ï¼‰åˆ†å‘åˆ°æ‰€æœ‰æ§åˆ¶é¢èŠ‚ç‚¹ï¼Œæ”¾åœ¨å…¶ Kubernetes è¯ä¹¦ç›®å½•ä¸‹ã€‚

1. æ›´æ–° [kube-controller-manager](https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-controller-manager/) çš„ `--root-ca-file` æ ‡å¿—ï¼Œä½¿ä¹‹åŒæ—¶åŒ…å«è€çš„å’Œæ–°çš„ CAï¼Œä¹‹åé‡å¯ kube-controller-managerã€‚

   è‡ªæ­¤åˆ»èµ·ï¼Œæ‰€åˆ›å»ºçš„æ‰€æœ‰[ServiceAccount](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-service-account/) éƒ½ä¼šè·å¾—åŒæ—¶åŒ…å«è€çš„ CA å’Œæ–°çš„ CA çš„ Secretã€‚



## åˆ›å»ºå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨

åˆ›å»º[æœåŠ¡](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/)æ—¶ï¼Œä½ å¯ä»¥é€‰æ‹©è‡ªåŠ¨åˆ›å»ºäº‘ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨ã€‚ è´Ÿè½½å‡è¡¡å™¨æä¾›å¤–éƒ¨å¯è®¿é—®çš„ IP åœ°å€ï¼Œå¯å°†æµé‡å‘é€åˆ°é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„æ­£ç¡®ç«¯å£ä¸Š ï¼ˆ**å‡è®¾é›†ç¾¤åœ¨æ”¯æŒçš„ç¯å¢ƒä¸­è¿è¡Œï¼Œå¹¶é…ç½®äº†æ­£ç¡®çš„äº‘è´Ÿè½½å‡è¡¡å™¨é©±åŠ¨åŒ…**ï¼‰ã€‚

### åŸºäºæ¸…å•æ–‡ä»¶åˆ›å»ºæœåŠ¡

è¦åˆ›å»ºå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œè¯·å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ä½ çš„ Service æ¸…å•æ–‡ä»¶ï¼š

```yaml
    type: LoadBalancer
```

ä½ çš„æ¸…å•æ–‡ä»¶å¯èƒ½ä¼šå¦‚ä¸‹æ‰€ç¤ºï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: example-service
spec:
  selector:
    app: example
  ports:
    - port: 8765
      targetPort: 9376
  type: LoadBalancer
```

### ä½¿ç”¨ kubectl åˆ›å»º Service

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `kubectl expose` å‘½ä»¤åŠå…¶ `--type=LoadBalancer` å‚æ•°åˆ›å»ºæœåŠ¡ï¼š

```bash
kubectl expose deployment example --port=8765 --target-port=9376 \
        --name=example-service --type=LoadBalancer
```

æ­¤å‘½ä»¤é€šè¿‡ä½¿ç”¨ä¸å¼•ç”¨èµ„æºï¼ˆåœ¨ä¸Šé¢çš„ç¤ºä¾‹çš„æƒ…å†µä¸‹ï¼Œåä¸º `example` çš„ [Deployment](https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/)ï¼‰ ç›¸åŒçš„é€‰æ‹©å™¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡ã€‚



### æ‰¾åˆ°ä½ çš„ IP åœ°å€

ä½ å¯ä»¥é€šè¿‡ `kubectl` è·å–æœåŠ¡ä¿¡æ¯ï¼Œæ‰¾åˆ°ä¸ºä½ çš„æœåŠ¡åˆ›å»ºçš„ IP åœ°å€ï¼š

```bash
kubectl describe services example-service
```

è¿™å°†è·å¾—ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼š

```bash
Name:                     example-service
Namespace:                default
Labels:                   app=example
Annotations:              <none>
Selector:                 app=example
Type:                     LoadBalancer
IP Families:              <none>
IP:                       10.3.22.96
IPs:                      10.3.22.96
LoadBalancer Ingress:     192.0.2.89
Port:                     <unset>  8765/TCP
TargetPort:               9376/TCP
NodePort:                 <unset>  30593/TCP
Endpoints:                172.17.0.3:9376
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```

è´Ÿè½½å‡è¡¡å™¨çš„ IP åœ°å€åˆ—åœ¨ `LoadBalancer Ingress` æ—è¾¹ã€‚

**è¯´æ˜ï¼š**

å¦‚æœä½ åœ¨ Minikube ä¸Šè¿è¡ŒæœåŠ¡ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ‰¾åˆ°åˆ†é…çš„ IP åœ°å€å’Œç«¯å£ï¼š

```bash
minikube service example-service --url
```



### ä¿ç•™å®¢æˆ·ç«¯æº IP

é»˜è®¤æƒ…å†µä¸‹ï¼Œç›®æ ‡å®¹å™¨ä¸­çœ‹åˆ°çš„æº IP å°†**ä¸æ˜¯å®¢æˆ·ç«¯çš„åŸå§‹æº IP**ã€‚ è¦å¯ç”¨ä¿ç•™å®¢æˆ·ç«¯ IPï¼Œå¯ä»¥åœ¨æœåŠ¡çš„ `.spec` ä¸­é…ç½®ä»¥ä¸‹å­—æ®µï¼š

+ `.spec.externalTrafficPolicy` - è¡¨ç¤ºæ­¤ Service æ˜¯å¦å¸Œæœ›å°†å¤–éƒ¨æµé‡è·¯ç”±åˆ°èŠ‚ç‚¹æœ¬åœ°æˆ–é›†ç¾¤èŒƒå›´çš„ç«¯ç‚¹ã€‚ æœ‰ä¸¤ä¸ªå¯ç”¨é€‰é¡¹ï¼š`Cluster`ï¼ˆé»˜è®¤ï¼‰å’Œ `Local`ã€‚ `Cluster` éšè—äº†å®¢æˆ·ç«¯æº IPï¼Œå¯èƒ½å¯¼è‡´ç¬¬äºŒè·³åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†å…·æœ‰è‰¯å¥½çš„æ•´ä½“è´Ÿè½½åˆ†å¸ƒã€‚ `Local` ä¿ç•™å®¢æˆ·ç«¯æº IP å¹¶é¿å… LoadBalancer å’Œ NodePort ç±»å‹æœåŠ¡çš„ç¬¬äºŒè·³ï¼Œ ä½†å­˜åœ¨æ½œåœ¨çš„ä¸å‡è¡¡æµé‡ä¼ æ’­é£é™©ã€‚

+ `.spec.healthCheckNodePort` - æŒ‡å®šæœåŠ¡çš„ healthcheck nodePortï¼ˆæ•°å­—ç«¯å£å·ï¼‰ã€‚ å¦‚æœä½ æœªæŒ‡å®š `healthCheckNodePort`ï¼ŒæœåŠ¡æ§åˆ¶å™¨ä»é›†ç¾¤çš„ NodePort èŒƒå›´å†…åˆ†é…ä¸€ä¸ªç«¯å£ã€‚ ä½ å¯ä»¥é€šè¿‡è®¾ç½® API æœåŠ¡å™¨çš„å‘½ä»¤è¡Œé€‰é¡¹ `--service-node-port-range` æ¥é…ç½®ä¸Šè¿°èŒƒå›´ã€‚ åœ¨æœåŠ¡ `type` è®¾ç½®ä¸º LoadBalancer å¹¶ä¸” `externalTrafficPolicy` è®¾ç½®ä¸º `Local` æ—¶ï¼Œ Service å°†ä¼šä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„ `healthCheckNodePort` å€¼ï¼ˆå¦‚æœä½ æŒ‡å®šäº†å®ƒï¼‰ã€‚

å¯ä»¥é€šè¿‡åœ¨æœåŠ¡çš„æ¸…å•æ–‡ä»¶ä¸­å°† `externalTrafficPolicy` è®¾ç½®ä¸º Local æ¥æ¿€æ´»æ­¤åŠŸèƒ½ã€‚æ¯”å¦‚ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: example-service
spec:
  selector:
    app: example
  ports:
    - port: 8765
      targetPort: 9376
  externalTrafficPolicy: Local
  type: LoadBalancer
```

ä¸€äº›äº‘æœåŠ¡ä¾›åº”å•†çš„è´Ÿè½½å‡è¡¡æœåŠ¡ä¸å…è®¸ä½ ä¸ºæ¯ä¸ªç›®æ ‡é…ç½®ä¸åŒçš„æƒé‡ã€‚

ç”±äºæ¯ä¸ªç›®æ ‡åœ¨å‘èŠ‚ç‚¹å‘é€æµé‡æ–¹é¢çš„æƒé‡ç›¸åŒï¼Œå› æ­¤å¤–éƒ¨æµé‡ä¸ä¼šåœ¨ä¸åŒ Pod ä¹‹é—´å¹³å‡è´Ÿè½½ã€‚ å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ä¸çŸ¥é“æ¯ä¸ªèŠ‚ç‚¹ä¸Šç”¨ä½œç›®æ ‡çš„ Pod æ•°é‡ã€‚

åœ¨ `NumServicePods << _NumNodes` æˆ– `NumServicePods >> NumNodes` æ—¶ï¼Œ å³ä½¿æ²¡æœ‰æƒé‡ï¼Œä¹Ÿä¼šçœ‹åˆ°æ¥è¿‘ç›¸ç­‰çš„åˆ†å¸ƒã€‚

å†…éƒ¨ Pod åˆ° Pod çš„æµé‡åº”è¯¥ä¸ ClusterIP æœåŠ¡ç±»ä¼¼ï¼Œæ‰€æœ‰ Pod çš„æ¦‚ç‡ç›¸åŒã€‚



### å›æ”¶è´Ÿè½½å‡è¡¡å™¨

**ç‰¹æ€§çŠ¶æ€ï¼š** `Kubernetes v1.17 [stable]`

åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œåº”åœ¨åˆ é™¤ LoadBalancer ç±»å‹ Service åç«‹å³æ¸…é™¤äº‘æœåŠ¡ä¾›åº”å•†ä¸­çš„ç›¸å…³è´Ÿè½½å‡è¡¡å™¨èµ„æºã€‚ ä½†æ˜¯ï¼Œä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨åˆ é™¤å…³è”çš„æœåŠ¡åï¼Œäº‘èµ„æºè¢«å­¤ç«‹çš„æƒ…å†µå¾ˆå¤šã€‚ å¼•å…¥äº†é’ˆå¯¹æœåŠ¡è´Ÿè½½å‡è¡¡å™¨çš„ç»ˆç»“å™¨ä¿æŠ¤ï¼Œä»¥é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿã€‚ é€šè¿‡ä½¿ç”¨ç»ˆç»“å™¨ï¼Œåœ¨åˆ é™¤ç›¸å…³çš„è´Ÿè½½å‡è¡¡å™¨èµ„æºä¹‹å‰ï¼Œä¹Ÿä¸ä¼šåˆ é™¤æœåŠ¡èµ„æºã€‚

å…·ä½“æ¥è¯´ï¼Œå¦‚æœæœåŠ¡å…·æœ‰ `type` LoadBalancerï¼Œåˆ™æœåŠ¡æ§åˆ¶å™¨å°†é™„åŠ ä¸€ä¸ªåä¸º `service.kubernetes.io/load-balancer-cleanup` çš„ç»ˆç»“å™¨ã€‚ ä»…åœ¨æ¸…é™¤è´Ÿè½½å‡è¡¡å™¨èµ„æºåæ‰èƒ½åˆ é™¤ç»ˆç»“å™¨ã€‚ å³ä½¿åœ¨è¯¸å¦‚æœåŠ¡æ§åˆ¶å™¨å´©æºƒä¹‹ç±»çš„æç«¯æƒ…å†µä¸‹ï¼Œè¿™ä¹Ÿå¯ä»¥é˜²æ­¢è´Ÿè½½å‡è¡¡å™¨èµ„æºæ‚¬ç©ºã€‚



### å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ä¾›åº”å•†

è¯·åŠ¡å¿…æ³¨æ„ï¼Œæ­¤åŠŸèƒ½çš„æ•°æ®è·¯å¾„ç”± Kubernetes é›†ç¾¤å¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨æä¾›ã€‚

å½“æœåŠ¡ `type` è®¾ç½®ä¸º LoadBalancer æ—¶ï¼ŒKubernetes å‘é›†ç¾¤ä¸­çš„ Pod æä¾›çš„åŠŸèƒ½ç­‰åŒäº `type` è®¾ç½®ä¸º ClusterIPï¼Œå¹¶é€šè¿‡ä½¿ç”¨æ‰˜ç®¡äº†ç›¸å…³ Kubernetes Pod çš„èŠ‚ç‚¹ä½œä¸ºæ¡ç›®å¯¹è´Ÿè½½å‡è¡¡å™¨ ï¼ˆä»å¤–éƒ¨åˆ° Kubernetesï¼‰è¿›è¡Œç¼–ç¨‹æ¥æ‰©å±•å®ƒã€‚ Kubernetes æ§åˆ¶å¹³é¢è‡ªåŠ¨åˆ›å»ºå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ã€å¥åº·æ£€æŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰å’ŒåŒ…è¿‡æ»¤è§„åˆ™ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚ ä¸€æ—¦äº‘æœåŠ¡ä¾›åº”å•†ä¸ºè´Ÿè½½å‡è¡¡å™¨åˆ†é…äº† IP åœ°å€ï¼Œæ§åˆ¶å¹³é¢å°±ä¼šæŸ¥æ‰¾è¯¥å¤–éƒ¨ IP åœ°å€å¹¶å°†å…¶å¡«å……åˆ° Service å¯¹è±¡ä¸­ã€‚



## Kubernetes Ingress é…ç½®æ³›åŸŸå TLS è¯ä¹¦

è®© Ingress é«˜å¯ç”¨å¯ä»¥ç”¨ LBï¼Œ å½“ç„¶ä¹Ÿæœ‰ Local çš„æ–¹æ³•ï¼Œ

è¿™é‡Œå½•äº†åˆ©ç”¨ `let's encrytp` æ³›åŸŸåè¯ä¹¦å®ç° Kubernetes é›†ç¾¤å¤–éƒ¨æœåŠ¡è‡ªåŠ¨è¯ä¹¦é…ç½®å’Œè¯ä¹¦åˆ°æœŸè‡ªåŠ¨æ›´æ–°ï¼Œæ”¯æŒ HTTPS è®¿é—®ã€‚æˆ‘ä»¬è¿˜éƒ¨ç½²äº†è¯ä¹¦è‡ªåŠ¨åˆ†å‘ç»„ä»¶ï¼Œå®ç°è¯ä¹¦æ–‡ä»¶è‡ªåŠ¨åˆ†å‘åˆ°å…¶ä»– namespace ã€‚

+ åˆ›å»º Ingress é€‰ç”¨ HTTPS ç›‘å¬åè®®æ—¶ï¼Œé€‰ç”¨åˆé€‚çš„æœåŠ¡å™¨è¯ä¹¦èƒ½å¤Ÿç¡®ä¿è®¿é—®å®‰å…¨ã€‚
+ ä¸ºæ‰€æœ‰çš„ HTTPS åŸŸåç»‘å®šåŒä¸€ä¸ªè¯ä¹¦ï¼Œç®€åŒ–é…ç½® Ingress ä¸‹æ‰€æœ‰ HTTPS è§„åˆ™çš„è¯ä¹¦ï¼Œä½¿æ›´æ–°æ“ä½œæ›´åŠ ä¾¿æ·ã€‚
+ ä¸ºä¸åŒçš„åŸŸåç»‘å®šä¸åŒçš„è¯ä¹¦ï¼Œæ”¹å–„æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ SSL/TLSã€‚

åˆ©ç”¨ dnspod ã€ cert-manager ã€letâ€™s encrytp ç­‰å¼€æºç»„ä»¶ï¼Œå®ç°æ³›åŸŸåè¯ä¹¦çš„è‡ªåŠ¨ç”Ÿæˆã€ç»­æœŸç®¡ç†ï¼Œä¸ºç°æœ‰kubernetes é›†ç¾¤åº”ç”¨å¯åŠ¨ HTTPSï¼Œæé«˜ç³»ç»Ÿå®‰å…¨æ€§ã€‚



**æ¶æ„:**

åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ HTTPS åè®®ï¼Œéœ€è¦ä¸€ä¸ªè¯ä¹¦ç®¡ç†å™¨ã€ä¸€ä¸ªè¯ä¹¦è‡ªåŠ¨ç­¾å‘æœåŠ¡

cert-manager æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿè¯ä¹¦ç®¡ç†å¼€æºé¡¹ç›®ï¼Œç”¨äºåœ¨ Kubernetes é›†ç¾¤ä¸­æä¾› HTTPS è¯ä¹¦å¹¶è‡ªåŠ¨ç»­æœŸï¼Œæ”¯æŒ Letâ€™s Encrypt, HashiCorp Vault è¿™äº›å…è´¹è¯ä¹¦çš„ç­¾å‘ã€‚åœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Kubernetes Ingress å’Œ Letâ€™s Encrypt å®ç°å¤–éƒ¨æœåŠ¡çš„è‡ªåŠ¨åŒ– HTTPSã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](http://sm.nsddd.top/sm202310122016285.png)

Issuers/ClusterIssuersï¼šå®šä¹‰ä½¿ç”¨ä»€ä¹ˆè¯ä¹¦é¢å‘æœºæ„ (CA) æ¥å»é¢å‘è¯ä¹¦ï¼ŒIssuers å’Œ ClusterIssuers åŒºåˆ«æ˜¯ï¼š issuers

 æ˜¯ä¸€ä¸ªåç§°ç©ºé—´çº§åˆ«çš„èµ„æºï¼Œåªèƒ½ç”¨æ¥ç­¾å‘è‡ªå·±æ‰€åœ¨ namespace ä¸‹çš„è¯ä¹¦ï¼ŒClusterIssuer æ˜¯ä¸ªé›†ç¾¤çº§åˆ«çš„èµ„æº å¯ä»¥ç­¾å‘ä»»æ„ namespace ä¸‹çš„è¯ä¹¦

Certificateï¼šå®šä¹‰æ‰€éœ€çš„ X.509 è¯ä¹¦ï¼Œè¯¥è¯ä¹¦å°†æ›´æ–°å¹¶ä¿æŒæœ€æ–°ã€‚Certificate æ˜¯ä¸€ä¸ªå‘½åç©ºé—´èµ„æºï¼Œå½“ Certificate è¢«åˆ›å»ºæ—¶ï¼Œå®ƒä¼šå»åˆ›å»ºç›¸åº”çš„ CertificateRequest èµ„æºæ¥å»ç”³è¯·è¯ä¹¦ã€‚



### å®‰è£…è¯ä¹¦ç®¡ç†å™¨

å®‰è£…è¯ä¹¦ç®¡ç†å™¨æ¯”è¾ƒç®€å•ï¼Œç›´æ¥æ‰§è¡Œä»¥ä¸‹è„šæœ¬å°±å¯ä»¥äº†ã€‚

```bash
kubectl create ns cert-manager
helm uninstall cert-manager -n cert-manager

helm install cert-manager jetstack/cert-manager \
	-n cert-manager \
	--version v1.8.0 \
	--set installCRDs=true \
	--set prometheus.enabled=false \
	--set 'extraArgs={--dns01-recursive-nameservers-only,--dns01-recursive-nameservers=119.29.29.29:53\,8.8.8.8:53}'
```

### é€‰æ‹©è¯ä¹¦é¢å‘è€…

cert-manageræ”¯æŒä»¥ä¸‹å‡ ç§è¯ä¹¦é¢å‘è€…

+ SelfSigned
+ CA
+ Vault
+ Venafi
+ External
+ ACME
  æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ACMEæ¥é¢å‘è¯ä¹¦ã€‚



### é€‰æ‹©è¯ä¹¦æ ¡éªŒæ–¹å¼

å¸¸ç”¨çš„æ ¡éªŒæ–¹å¼æœ‰ HTTP-01 ã€DNS-01 ã€‚

#### DNS-01 æ ¡éªŒåŸç†

DNS-01 çš„æ ¡éªŒåŸç†æ˜¯åˆ©ç”¨ DNS æä¾›å•†çš„ API Key æ‹¿åˆ° DNS æ§åˆ¶æƒé™ï¼Œ åœ¨ Letâ€™s Encrypt ä¸º ACME å®¢æˆ·ç«¯æä¾›ä»¤ç‰Œåï¼ŒACME å®¢æˆ·ç«¯ (cert-manager) å°†åˆ›å»ºä»è¯¥ä»¤ç‰Œå’Œæˆ‘çš„å¸æˆ·å¯†é’¥æ´¾ç”Ÿçš„ TXT è®°å½•ï¼Œå¹¶å°†è¯¥è®°å½•æ”¾åœ¨ _acme-challengeã€‚ ç„¶å Letâ€™s Encrypt å°†å‘ DNS ç³»ç»ŸæŸ¥è¯¢è¯¥è®°å½•ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œå°±å¯ä»¥é¢å‘è¯ä¹¦ã€‚æ­¤æ–¹æ³•æ”¯æŒæ³›åŸŸåè¯ä¹¦ã€‚

#### HTTP-01 æ ¡éªŒåŸç†

HTTP-01 çš„æ ¡éªŒåŸç†æ˜¯ç»™åŸŸåæŒ‡å‘çš„ HTTP æœåŠ¡å¢åŠ ä¸€ä¸ªä¸´æ—¶ location ï¼ŒLetâ€™s Encrypt ä¼šå‘é€ http è¯·æ±‚ï¼Œå‚æ•°ä¸­ YOUR_DOMAIN å°±æ˜¯è¢«æ ¡éªŒçš„åŸŸåï¼ŒTOKEN æ˜¯ ACME åè®®çš„å®¢æˆ·ç«¯è´Ÿè´£æ”¾ç½®çš„æ–‡ä»¶ï¼ŒACME å®¢æˆ·ç«¯å°±æ˜¯ cert-managerï¼Œå®ƒé€šè¿‡ä¿®æ”¹æˆ–åˆ›å»º [Ingress](https://so.csdn.net/so/search?q=Ingress&spm=1001.2101.3001.7020) è§„åˆ™æ¥å¢åŠ è¿™ä¸ªä¸´æ—¶æ ¡éªŒè·¯å¾„å¹¶æŒ‡å‘æä¾› TOKEN çš„æœåŠ¡ã€‚Letâ€™s Encrypt ä¼šå¯¹æ¯” TOKEN æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œæ ¡éªŒæˆåŠŸåå°±ä¼šé¢å‘è¯ä¹¦ã€‚æ­¤æ–¹æ³•ä»…é€‚ç”¨äºç»™ä½¿ç”¨ Ingress æš´éœ²æµé‡çš„æœåŠ¡é¢å‘è¯ä¹¦ï¼Œä¸æ”¯æŒæ³›åŸŸåè¯ä¹¦ã€‚



### é…ç½®

#### HTTP-01 é…ç½®ç¤ºä¾‹

è¿™ä¸ªé…ç½®ç¤ºä¾‹ä»…ä¾›å‚è€ƒï¼Œä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œæœ‰å¤šå°‘çš„ ingress æœåŠ¡ï¼Œå°±éœ€è¦ç”³è¯·å¤šå°‘å¼ è¯ä¹¦ ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œä½†æ˜¯é…ç½®è¾ƒä¸ºç®€å•ï¼Œä¸ä¾èµ– DNS æœåŠ¡å•†ã€‚

##### 1. åˆ›å»º CA ç¾¤é›†è¯ä¹¦é¢å‘è€…

è¯ä¹¦ç®¡ç†å™¨éœ€è¦ Issuer æˆ– ClusterIssuer èµ„æºï¼Œæ‰èƒ½é¢å‘è¯ä¹¦ã€‚ è¿™ä¸¤ç§ Kubernetes èµ„æºçš„åŠŸèƒ½å®Œå…¨ç›¸åŒï¼ŒåŒºåˆ«åœ¨äº Issuer é€‚ç”¨äºå•ä¸€å‘½åç©ºé—´ï¼Œè€Œ ClusterIssuer é€‚ç”¨äºæ‰€æœ‰å‘½åç©ºé—´ã€‚
`ClusterIssuer.yaml`

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt
spec:
  acme:
    email: xxxx@xyz.cn
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      name: issuer-account-key
    solvers:
    - http01:
        ingress:
          class: nginx
```

è¯´æ˜ï¼š

+ `metadata.name`: æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ç­¾å‘æœºæ„çš„åç§°ï¼Œåé¢æˆ‘ä»¬åˆ›å»ºè¯ä¹¦çš„æ—¶å€™ä¼šå¼•ç”¨å®ƒ
+ `spec.acme.email`: æ˜¯ä½ è‡ªå·±çš„é‚®ç®±ï¼Œè¯ä¹¦å¿«è¿‡æœŸçš„æ—¶å€™ä¼šæœ‰é‚®ä»¶æé†’ï¼Œä¸è¿‡ cert-manager ä¼šåˆ©ç”¨ acme åè®®è‡ªåŠ¨ç»™æˆ‘ä»¬é‡æ–°é¢å‘è¯ä¹¦æ¥ç»­æœŸ
+ `spec.acme.server`: æ˜¯ acme åè®®çš„æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ Letâ€™s Encrypt
+ `spec.acme.privateKeySecretRef`: æŒ‡ç¤ºæ­¤ç­¾å‘æœºæ„çš„ç§é’¥å°†è¦å­˜å‚¨åˆ°å“ªä¸ª Secret å¯¹è±¡ä¸­
+ `spec.acme.solvers`: è¿™é‡ŒæŒ‡ç¤ºç­¾å‘æœºæ„æ ¡éªŒæ–¹å¼ï¼Œæœ‰ http01 å’Œ dns01 ä¸¤ç§ï¼Œè¯¥å­—æ®µä¸‹é…ç½®çš„ class å’Œ name åªèƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ªï¼Œ class æŒ‡å®šä½¿ç”¨çš„ ingress class åç§°ï¼Œ name æ¯”è¾ƒå°‘ç”¨ï¼Œé€šå¸¸ç”¨äº kubernetes çš„ ingressã€‚

```bash
kubectl apply -f ClusterIssuer.yaml -n cert-manager
```

##### 2. åˆ›å»º ingress æœåŠ¡

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
  name: ingress-wikijs
spec:
  ingressClassName: nginx
  rules:
  - host: wiki.xyz.cn
    http:
      paths:
      - backend:
          service:
            name: wikijs
            port:
              number: 3000
        path: /
        pathType: Prefix
  tls: 
  - hosts:
    - wikijs.xyz.cn
    secretName: ingress-wikijs-tls
```

æ³¨æ„ï¼š

åœ¨ annotations é‡Œ è®¾ç½®`cert-manager.io/cluster-issuer` ä¸ºç­¾ååˆ›å»ºçš„é›†ç¾¤è¯ä¹¦é¢å‘è€… `letsencrypt`

ä½¿ç”¨ yaml æ–‡ä»¶åˆ›å»º ingress åï¼Œå°±å¯ä»¥ä½¿ç”¨è¯¥ ingress å¯¹å¤–æä¾› https æœåŠ¡äº†ã€‚

```yaml
# åˆ›å»º ingress
kubectl apply -f ingress-wikijs.yaml -n infra
# æŸ¥çœ‹è¯ä¹¦æ˜¯å¦è‡ªåŠ¨åˆ›å»ºæˆåŠŸ
kubectl -n infra  get certificate
```

#### DNS01é…ç½®ç¤ºä¾‹

ä½¿ç”¨è¿™ç§æ–¹å¼éœ€è¦ DNS æœåŠ¡å•†æ”¯æŒé€šè¿‡ API åˆ›å»º DNS è®°å½•ï¼Œæ­£å¥½æˆ‘çš„ DNS æœåŠ¡å•†æ˜¯ dnspod æ”¯æŒï¼Œå› æ­¤åœ¨æˆ‘ä»¬çš„åŠç¾¤é‡Œï¼Œæœ€ç»ˆé‡‡ç”¨äº†è¿™ç§æ–¹å¼ã€‚

è¿™ä¸ªæ–¹å¼çš„é…ç½®ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œè¸©äº†å¾ˆä¹…çš„å‘ï¼Œä¸»è¦æ˜¯å› ä¸ºæˆ‘çš„é›†ç¾¤å¯ç”¨äº†æœ¬åœ° DNS æœåŠ¡å™¨ï¼Œé»˜è®¤ cert-manager ä¼šé€šè¿‡æœ¬åœ° DNS æœåŠ¡å™¨å»éªŒè¯é€šè¿‡ API åˆ›å»ºçš„ DNS txtè®°å½•ï¼Œä¼šä¸€ç›´æ£€æŸ¥ä¸åˆ°æ–°å¢çš„ txt è®°å½•ï¼Œé€ æˆåœ¨ challenge é˜¶æ®µå°±ä¸€ç›´ penddingã€‚è§£å†³æ–¹æ¡ˆé™„åã€‚

##### 1. åœ¨ dnspod åˆ›å»º API ID å’Œ API Token

å‚è€ƒdnspod äº‘å®˜æ–¹æ–‡æ¡£
è®°å½•ä¸‹åˆ›å»ºçš„ API ID å’Œ API Token ã€‚

```yaml
<API ID >
<API Token>
```

##### 2. å®‰è£… cert-manager-webhook-dnspod

ä½¿ç”¨ helm å®‰è£… roc/cert-manager-webhook-dnspodã€‚

```yaml
helm repo add roc https://charts.imroc.cc

helm uninstall cert-manager-webhook-dnspod -n cert-manager
helm install cert-manager-webhook-dnspod roc/cert-manager-webhook-dnspod \
    -n cert-manager \
    --set clusterIssuer.secretId=<API ID > \
    --set clusterIssuer.secretKey=<API Token> \
    --set clusterIssuer.email=xxxx@xyz.cn
```

##### 3. åˆ›å»ºæ³›åŸŸåè¯ä¹¦

```
xyz-crt.yaml
```

```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: xyz-crt
spec:
  secretName: xyz-crt
  issuerRef:
    name: dnspod
    kind: ClusterIssuer
    group: cert-manager.io
  dnsNames:
  - "*.xyz.cn"
```

##### 4. éªŒè¯è¯ä¹¦

æŸ¥çœ‹è¯ä¹¦æ˜¯å¦åˆ›å»ºæˆåŠŸ

```yaml
[root@ks-master infra]# kubectl get Certificate -n cert-manager
NAME                                      READY   SECRET                                    AGE
cert-manager-webhook-dnspod-ca            True    cert-manager-webhook-dnspod-ca            18m
cert-manager-webhook-dnspod-webhook-tls   True    cert-manager-webhook-dnspod-webhook-tls   18m
xyz-crt                             True    xyz-crt                             3m12s
```

ä»¥ä¸Šå¯ä»¥çœ‹å‡º xyz-crt å·²ç»åˆ›å»ºæˆåŠŸï¼Œ READY çŠ¶æ€ä¹Ÿæ˜¯ Trueã€‚

æŸ¥çœ‹è¯ä¹¦å¯¹åº”çš„åŸŸå

```yaml
[root@ks-master infra]# kubectl describe Certificate xyz-crt -n cert-manager
Name:         xyz-crt
Namespace:    cert-manager
Labels:       <none>
Annotations:  <none>
API Version:  cert-manager.io/v1
Kind:         Certificate
Metadata:
  Creation Timestamp:  2022-05-07T14:19:07Z
  Generation:          1
  Managed Fields:
    API Version:  cert-manager.io/v1
    Fields Type:  FieldsV1
    fieldsV1:
      f:status:
        .:
        f:conditions:
    Manager:      cert-manager-certificates-trigger
    Operation:    Update
    Subresource:  status
    Time:         2022-05-07T14:19:07Z
    API Version:  cert-manager.io/v1
    Fields Type:  FieldsV1
    fieldsV1:
      f:metadata:
        f:annotations:
          .:
          f:kubectl.kubernetes.io/last-applied-configuration:
      f:spec:
        .:
        f:dnsNames:
        f:issuerRef:
          .:
          f:group:
          f:kind:
          f:name:
        f:secretName:
    Manager:      kubectl-client-side-apply
    Operation:    Update
    Time:         2022-05-07T14:19:07Z
    API Version:  cert-manager.io/v1
    Fields Type:  FieldsV1
    fieldsV1:
      f:status:
        f:revision:
    Manager:      cert-manager-certificates-issuing
    Operation:    Update
    Subresource:  status
    Time:         2022-05-07T14:19:14Z
    API Version:  cert-manager.io/v1
    Fields Type:  FieldsV1
    fieldsV1:
      f:status:
        f:conditions:
          k:{"type":"Ready"}:
            .:
            f:lastTransitionTime:
            f:message:
            f:observedGeneration:
            f:reason:
            f:status:
            f:type:
        f:notAfter:
        f:notBefore:
        f:renewalTime:
    Manager:         cert-manager-certificates-readiness
    Operation:       Update
    Subresource:     status
    Time:            2022-05-07T14:19:14Z
  Resource Version:  4784901
  UID:               f2c9be82-f4cb-4243-b2c3-19f64242cc91
Spec:
  Dns Names:
    *.xyz.cn
  Issuer Ref:
    Group:      cert-manager.io
    Kind:       ClusterIssuer
    Name:       dnspod
  Secret Name:  xyz-crt
Status:
  Conditions:
    Last Transition Time:  2022-05-07T14:19:14Z
    Message:               Certificate is up to date and has not expired
    Observed Generation:   1
    Reason:                Ready
    Status:                True
    Type:                  Ready
  Not After:               2022-08-05T13:19:11Z
  Not Before:              2022-05-07T13:19:12Z
  Renewal Time:            2022-07-06T13:19:11Z
  Revision:                1
Events:
  Type    Reason     Age    From                                       Message
  ----    ------     ----   ----                                       -------
  Normal  Issuing    4m35s  cert-manager-certificates-trigger          Issuing certificate as Secret does not exist
  Normal  Generated  4m35s  cert-manager-certificates-key-manager      Stored new private key in temporary Secret resource "xyz-crt-4ml59"
  Normal  Requested  4m35s  cert-manager-certificates-request-manager  Created new CertificateRequest resource "xyz-crt-r76wp"
  Normal  Issuing    4m28s  cert-manager-certificates-issuing          The certificate has been successfully issued
[root@ks-master infra]# 
```

ä» Certificate çš„æè¿°ä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªè¯ä¹¦æ˜¯å¯¹åº”æ‰€æœ‰ *.xyz.cn çš„æ³›åŸŸåã€‚æ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨åœ¨é›†ç¾¤çš„ä»»ä½•åœ°æ–¹ã€‚

æŸ¥çœ‹è¯ä¹¦å†…å®¹

```
[root@ks-master infra]# kubectl describe secret xyz-crt -n cert-manager
Name:         xyz-crt
Namespace:    cert-manager
Labels:       <none>
Annotations:  cert-manager.io/alt-names: *.xyz.cn
              cert-manager.io/certificate-name: xyz-crt
              cert-manager.io/common-name: *.xyz.cn
              cert-manager.io/ip-sans: 
              cert-manager.io/issuer-group: cert-manager.io
              cert-manager.io/issuer-kind: ClusterIssuer
              cert-manager.io/issuer-name: dnspod
              cert-manager.io/uri-sans: 

Type:  kubernetes.io/tls

Data
====
tls.crt:  5587 bytes
tls.key:  1675 bytes

```

TLS è¯ä¹¦ä¿å­˜åœ¨ cert-manager å‘½åç©ºé—´é‡Œçš„ xyz-crt secretã€‚å¯ä»¥ä¾›æ‰€æœ‰ *.xyz.cn çš„æœåŠ¡ä½¿ç”¨ã€‚

##### å…¶ä»–

è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ€å¤§çš„å‘æ˜¯ï¼Œæˆ‘çš„é›†ç¾¤ä½¿ç”¨äº†è‡ªå»ºçš„ DNS æœåŠ¡å™¨ï¼Œé»˜è®¤ cert-manager ä¼šä½¿ç”¨è¿™ä¸ªé›†ç¾¤çš„è‡ªå»º DNS SERVER è¿›è¡Œè¯ä¹¦å‘è¡Œçš„éªŒè¯ï¼Œè™½ç„¶é€šè¿‡è°ƒç”¨ dnspod çš„ webook åœ¨ è…¾è®¯äº‘ DNS æœåŠ¡å™¨ä¸Šåˆ›å»ºçš„ _acme-challenge æ¡æ‰‹æ•°æ®ï¼Œä½†æ˜¯åœ¨æˆ‘çš„ è‡ªå»º DNS é‡Œæ˜¯æŸ¥ä¸åˆ°çš„ï¼Œæ‰€ä»¥ä¼šä¸€ç›´å¡ pending çŠ¶æ€ï¼Œ

```bash
[root@ks-master infra]# kubectl get challenge -A
NAMESPACE      NAME                                       STATE     DOMAIN         AGE
cert-manager   xyz-crt-f9kp6-381578565-136350475    pending   xyz.cn   24s

```

æŸ¥çœ‹åŸå› æ˜¯ï¼š
`Waiting for DNS-01 challenge propagation: DNS record for "xyz.cn" not yet`

```
[root@ks-master infra]# kcm describe challenge xyz-crt-f9kp6-381578565-136350475
Name:         xyz-crt-f9kp6-381578565-136350475
Namespace:    cert-manager
Labels:       <none>
Annotations:  <none>
API Version:  acme.cert-manager.io/v1
Kind:         Challenge
---
ä¸­é—´ç•¥
---
Status:
  Presented:   true
  Processing:  true
  Reason:      Waiting for DNS-01 challenge propagation: DNS record for "xyz.cn" not yet propagated
  State:       pending
Events:
  Type    Reason     Age   From                     Message
  ----    ------     ----  ----                     -------
  Normal  Started    41s   cert-manager-challenges  Challenge scheduled for processing
  Normal  Presented  39s   cert-manager-challenges  Presented challenge using DNS-01 challenge mechanism

```

æŸ¥äº†å¾ˆå¤šèµ„æ–™ï¼Œåœ¨å®˜ç½‘ä¸Šæ‰¾åˆ°è§£å†³æ–¹æ¡ˆã€‚åŠæ³•æ˜¯è®© cert-manager å¼ºåˆ¶ä½¿ç”¨æŒ‡å®šçš„ DNS æœåŠ¡å™¨è¿›è¡Œæ¡æ‰‹éªŒè¯ã€‚

æˆ‘æ˜¯ç”¨çš„æ˜¯ helm å®‰è£… cert-managerï¼Œæ‰€ä»¥æ·»åŠ ä¸€ä¸‹ set å‚æ•°

```yaml
	--set 'extraArgs={--dns01-recursive-nameservers-only,--dns01-recursive-nameservers=119.29.29.29:53\,8.8.8.8:53}'    
```



### ä½¿ç”¨ TLS è¯ä¹¦é…ç½® ingress

```yaml
kind: Ingress
apiVersion: networking.k8s.io/v1
metadata:
  name: wikijs
  namespace: infra
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: '0'
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - wiki.xyz.cn
      secretName: xyz-crt
  rules:
    - host: wiki.xyz.cn
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: wikijs
                port:
                  number: 3000
```

ä»¥ä¸Šé…ç½®å®Œæˆåï¼Œå°±å¯ä»¥ä½¿ç”¨ https æ¥è®¿é—®æ–°çš„ wiki.js æœåŠ¡äº†ã€‚



##  Letâ€™s Encrypt

ä¸ºäº†åœ¨æ‚¨çš„ç½‘ç«™ä¸Šå¯ç”¨ HTTPSï¼Œæ‚¨éœ€è¦ä»è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰è·å–è¯ä¹¦ï¼ˆä¸€ç§æ–‡ä»¶ï¼‰ã€‚ Letâ€™s Encrypt æ­£æ˜¯å…¶ä¸­ä¸€å®¶è¯ä¹¦é¢å‘æœºæ„ã€‚ è¦ä» Letâ€™s Encrypt è·å–æ‚¨ç½‘ç«™åŸŸåçš„è¯ä¹¦ï¼Œæ‚¨å¿…é¡»è¯æ˜æ‚¨å¯¹åŸŸåçš„å®é™…æ§åˆ¶æƒã€‚ è¿™ä¸€è¿‡ç¨‹é€šå¸¸ç”± Web ä¸»æœºä¸Šè¿è¡Œçš„ [ACME åè®®](https://tools.ietf.org/html/rfc8555)å®¢æˆ·ç«¯å®Œæˆã€‚

ç”³è¯·è¯ä¹¦çš„æœ€ä½³æ–¹å¼å–å†³äºæ‚¨æ˜¯å¦å…·å¤‡æœåŠ¡å™¨çš„[å‘½ä»¤è¡Œè®¿é—®æƒé™](https://en.wikipedia.org/wiki/Shell_account)ï¼ˆä¹Ÿç§°ä¸º SSH æƒé™ï¼‰ã€‚ å¦‚æœæ‚¨ä»…ä½¿ç”¨æ§åˆ¶é¢æ¿ï¼ˆä¾‹å¦‚ [cPanel](https://cpanel.net/)ã€[Plesk](https://www.plesk.com/) æˆ– [WordPress](https://wordpress.org/)ï¼‰ç®¡ç†æ‚¨çš„ç½‘ç«™ï¼Œæ‚¨å¾ˆæœ‰å¯èƒ½æ²¡æœ‰å‘½ä»¤è¡Œè®¿é—®æƒé™ã€‚ æ‚¨å¯ä»¥è”ç³»æ‚¨çš„æ‰˜ç®¡æœåŠ¡æä¾›å•†ç¡®è®¤ã€‚



### æ‹¥æœ‰å‘½ä»¤è¡Œè®¿é—®æƒé™

æˆ‘ä»¬å»ºè®®å¤§å¤šæ•°å…·æœ‰å‘½ä»¤è¡Œè®¿é—®æƒé™çš„äººä½¿ç”¨ [Certbot](https://certbot.eff.org/) ACME å®¢æˆ·ç«¯ã€‚ å®ƒå¯ä»¥åœ¨ä¸ä¸‹çº¿æ‚¨çš„æœåŠ¡å™¨çš„å‰æä¸‹è‡ªåŠ¨æ‰§è¡Œè¯ä¹¦é¢å‘å’Œå®‰è£…ã€‚ å¯¹äºä¸éœ€è¦è‡ªåŠ¨é…ç½®çš„ç”¨æˆ·ï¼ŒCertbot è¿˜æä¾›ä¸“å®¶æ¨¡å¼ã€‚ å®ƒæ˜“äºä½¿ç”¨ï¼Œé€‚ç”¨äºè®¸å¤šæ“ä½œç³»ç»Ÿï¼Œå¹¶ä¸”å…·æœ‰å‡ºè‰²çš„ï¼ˆæ³¨ï¼šè‹±æ–‡ï¼‰æ–‡æ¡£ã€‚ å‰å¾€ [Certbot å®˜ç½‘](https://certbot.eff.org/)å³å¯è·å–é’ˆå¯¹å„ç±»æ“ä½œç³»ç»Ÿä¸æœåŠ¡å™¨è½¯ä»¶çš„ä½¿ç”¨è¯´æ˜ã€‚

å¦‚æœ [Certbot](https://certbot.eff.org/) ä¸èƒ½æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œæˆ–è€…æ‚¨æƒ³å°è¯•åˆ«çš„å®¢æˆ·ç«¯ï¼Œè¿˜æœ‰[æ›´å¤š ACME å®¢æˆ·ç«¯](https://letsencrypt.org/zh-cn/docs/client-options/)å¯ä¾›é€‰æ‹©ã€‚ é€‰å®š ACME å®¢æˆ·ç«¯è½¯ä»¶åï¼Œè¯·å‚é˜…è¯¥å®¢æˆ·ç«¯çš„æ–‡æ¡£ã€‚





## END é“¾æ¥

<ul><li><div><a href = '76.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '78.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

