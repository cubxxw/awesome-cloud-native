+ [author](http://nsddd.top)

# ç¬¬14èŠ‚ k3s

<div><a href = '13.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '15.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[toc]]

[toc]

## k3sä»‹ç»

::: tip k3s â€” å¾®å‹kubernetså‘è¡Œç‰ˆ
k3sæ˜¯ç»CNCFä¸€è‡´æ€§è®¤è¯çš„Kuberneteså‘è¡Œç‰ˆï¼Œä¸“ä¸ºç‰©è”ç½‘åŠè¾¹ç¼˜è®¡ç®—è®¾è®¡ã€‚

+ [x] [å®˜æ–¹](https://www.rancher.cn/k3s/)
+ [x] [æ–‡æ¡£](https://docs.rancher.cn/)
+ [x] [å¼€æºåœ°å€](https://github.com/k3s-io/k3s/)

**æŠ€æœ¯äº®ç‚¹ï¼š**

+ å•è¿›ç¨‹æ¶æ„ç®€åŒ–éƒ¨ç½²
+ ç§»é™¤å„ç§éå¿…è¦çš„ä»£ç ï¼Œå‡å°‘èµ„æºå ç”¨
+ TLSè¯ä¹¦ç®¡ç†
+ å†…ç½®Containerd
+ å†…ç½®è‡ªè¿è¡Œ `rootfs`
+ å†…ç½®Helm Chartç®¡ç†æœºåˆ¶
+ å†…ç½®L4/L7 LB æ”¯æŒ



**é€‚åˆåœºæ™¯ï¼š**

+ è¾¹ç¼˜è®¡ç®—-Edge
+ ç‰©è”ç½‘-IoT
+ CI
+ Development
+ ARM
+ åµŒå…¥ K8s

:::



## æ¶æ„

k3sæ¶æ„å°±æ˜¯æŠŠk8sæ ¸å¿ƒç»„ä»¶å°è£…æˆäºŒè¿›åˆ¶~

k3såˆ†ä¸º`k3s server` å’Œ ` k3s agent`ï¼š

+  k3s server åªæœ‰ä¸€ä¸ªè¿›ç¨‹ä½“
+  k3s agent åˆ†ä¸ºä¸¤ä¸ªè¿›ç¨‹ä½“ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ Contrainerdï¼Œè´Ÿè´£ç®¡ç†è¿è¡Œå®¹å™¨

> åœ¨ä¸‹é¢ä¹Ÿå¯ä»¥æ·±åˆ»ç†è§£åˆ°



**æ¶æ„è¯¦è§£ï¼š**

::: details æ¶æ„è®²è§£ï¼š
k3sç®—æ˜¯å¯¹k8sçš„æ¶æ„å’Œç”Ÿæ€è¿›è¡Œä¸€éƒ¨åˆ†ç²¾åå’Œç¼©è¿›

**å•èŠ‚ç‚¹æ¶æ„ï¼š**

K3s å•èŠ‚ç‚¹é›†ç¾¤çš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¯¥é›†ç¾¤æœ‰ä¸€ä¸ªå†…åµŒ SQLite æ•°æ®åº“çš„å•èŠ‚ç‚¹  `K3s server` ã€‚

åœ¨è¿™ç§é…ç½®ä¸­ï¼Œæ¯ä¸ª  `agent` èŠ‚ç‚¹éƒ½æ³¨å†Œåˆ°åŒä¸€ä¸ª  `server` èŠ‚ç‚¹ã€‚K3s ç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒç”¨  `server` èŠ‚ç‚¹ä¸Šçš„ K3s API æ¥æ“ä½œ Kubernetes èµ„æºã€‚

å•èŠ‚ç‚¹ `K3s server` çš„æ¶æ„

![img](http://sm.nsddd.top/sm1660616402558126.png)

**é«˜å¯ç”¨æ¶æ„ï¼š**

è™½ç„¶å•èŠ‚ç‚¹ k3s é›†ç¾¤å¯ä»¥æ»¡è¶³å„ç§ç”¨ä¾‹ï¼Œä½†å¯¹äº Kubernetes control-plane çš„æ­£å¸¸è¿è¡Œè‡³å…³é‡è¦çš„ç¯å¢ƒï¼Œæ‚¨å¯ä»¥åœ¨é«˜å¯ç”¨é…ç½®ä¸­è¿è¡Œ K3sã€‚ä¸€ä¸ªé«˜å¯ç”¨ K3s é›†ç¾¤ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

+ **`K3s server` èŠ‚ç‚¹** ï¼šä¸¤ä¸ªæˆ–æ›´å¤šçš„`server`èŠ‚ç‚¹å°†ä¸º Kubernetes API æä¾›æœåŠ¡å¹¶è¿è¡Œå…¶ä»– control-plane æœåŠ¡
+ **å¤–éƒ¨æ•°æ®åº“** ï¼šä¸å•èŠ‚ç‚¹ k3s è®¾ç½®ä¸­ä½¿ç”¨çš„åµŒå…¥å¼ SQLite æ•°æ®å­˜å‚¨ç›¸åï¼Œé«˜å¯ç”¨ K3s éœ€è¦æŒ‚è½½ä¸€ä¸ª`external database`å¤–éƒ¨æ•°æ®åº“ä½œä¸ºæ•°æ®å­˜å‚¨çš„åª’ä»‹ã€‚

K3sé«˜å¯ç”¨æ¶æ„

![img](http://sm.nsddd.top/sm1660616476551520.png)

**å›ºå®š  `agent` èŠ‚ç‚¹çš„æ³¨å†Œåœ°å€ï¼š**

åœ¨é«˜å¯ç”¨   `K3s server`  é…ç½®ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹è¿˜å¿…é¡»ä½¿ç”¨å›ºå®šçš„æ³¨å†Œåœ°å€å‘ Kubernetes API æ³¨å†Œï¼Œæ³¨å†Œåï¼Œ `agent` èŠ‚ç‚¹ç›´æ¥ä¸å…¶ä¸­ä¸€ä¸ª  `server` èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![k3s-production-setup](http://sm.nsddd.top/sm1660616545857393.svg)

**æ³¨å†Œ  `agent` èŠ‚ç‚¹ï¼š**

 `agent` èŠ‚ç‚¹ç”¨`k3s agent`è¿›ç¨‹å‘èµ·çš„ websocket è¿æ¥æ³¨å†Œï¼Œè¿æ¥ç”±ä½œä¸ºä»£ç†è¿›ç¨‹ä¸€éƒ¨åˆ†è¿è¡Œçš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ç»´æŠ¤ã€‚

 `agent` å°†ä½¿ç”¨èŠ‚ç‚¹é›†ç¾¤ secret ä»¥åŠéšæœºç”Ÿæˆçš„èŠ‚ç‚¹å¯†ç å‘   `K3s server`  æ³¨å†Œï¼Œå¯†ç å­˜å‚¨åœ¨ `/etc/rancher/node/password`è·¯å¾„ä¸‹ã€‚ `K3s server` å°†æŠŠå„ä¸ªèŠ‚ç‚¹çš„å¯†ç å­˜å‚¨ä¸º Kubernetes secretsï¼Œéšåçš„ä»»ä½•å°è¯•éƒ½å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å¯†ç ã€‚èŠ‚ç‚¹å¯†ç ç§˜å¯†å­˜å‚¨åœ¨`kube-system`å‘½åç©ºé—´ä¸­ï¼Œåç§°ä½¿ç”¨æ¨¡æ¿`<host>.node-password.k3s`ã€‚

> æ³¨æ„
>
> + åœ¨ K3s v1.20.2 ä¹‹å‰ï¼Œ` K3s  server` å°†å¯†ç å­˜å‚¨åœ¨`/var/lib/rancher/k3s/server/cred/node-passwd`çš„ç£ç›˜ä¸Šã€‚
> + å¦‚æœæ‚¨åˆ é™¤äº†  `agent` çš„`/etc/rancher/node`ç›®å½•ï¼Œåˆ™éœ€è¦ä¸ºè¯¥  `agent` é‡æ–°åˆ›å»ºå¯†ç æ–‡ä»¶ï¼Œæˆ–è€…ä»  `server` ä¸­åˆ é™¤è¯¥æ¡ç›®ã€‚
> + é€šè¿‡ä½¿ç”¨`--with-node-id`æ ‡å¿—å¯åŠ¨ `  K3s server` æˆ– agentï¼Œå¯ä»¥å°†å”¯ä¸€çš„èŠ‚ç‚¹ ID é™„åŠ åˆ°ä¸»æœºåä¸­ã€‚

**è‡ªåŠ¨éƒ¨ç½²çš„æ¸…å•ï¼š**

ä½äºç›®å½•è·¯å¾„`/var/lib/rancher/k3s/server/manifests` çš„æ¸…å•åœ¨æ„å»ºæ—¶è¢«æ†ç»‘åˆ° K3s äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå°†ç”±[rancher/helm-controller](https://github.com/k3s-io/helm-controller#helm-controller)åœ¨è¿è¡Œæ—¶å®‰è£…ã€‚

:::



**æ¶æ„å›¾ï¼š**

![k3sä¸‹è½½](http://sm.nsddd.top/smhow-it-works-k3s.svg)



::: details è¡¥å……containerd
containerdä»dockerå°±å¼€å§‹ç†Ÿæ‚‰çš„ï¼Œé‚£ä¹ˆè‡ªç„¶ä»dockerå¼€å§‹ä»‹ç»ï¼š

![img](https://sm.nsddd.top/sm952033-20180520115357747-1796034956.png)



ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œdocker å¯¹å®¹å™¨çš„ç®¡ç†å’Œæ“ä½œåŸºæœ¬éƒ½æ˜¯é€šè¿‡ containerd å®Œæˆçš„ã€‚ é‚£ä¹ˆï¼Œcontainerd æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
**Containerd æ˜¯ä¸€ä¸ªå·¥ä¸šçº§æ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå®ƒå¼ºè°ƒç®€å•æ€§ã€å¥å£®æ€§å’Œå¯ç§»æ¤æ€§ã€‚Containerd å¯ä»¥åœ¨å®¿ä¸»æœºä¸­ç®¡ç†å®Œæ•´çš„å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼šå®¹å™¨é•œåƒçš„ä¼ è¾“å’Œå­˜å‚¨ã€å®¹å™¨çš„æ‰§è¡Œå’Œç®¡ç†ã€å­˜å‚¨å’Œç½‘ç»œç­‰ã€‚** è¯¦ç»†ç‚¹è¯´ï¼ŒContainerd è´Ÿè´£å¹²ä¸‹é¢è¿™äº›äº‹æƒ…ï¼š

+ ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ(ä»åˆ›å»ºå®¹å™¨åˆ°é”€æ¯å®¹å™¨)
+ æ‹‰å–/æ¨é€å®¹å™¨é•œåƒ
+ å­˜å‚¨ç®¡ç†(ç®¡ç†é•œåƒåŠå®¹å™¨æ•°æ®çš„å­˜å‚¨)
+ è°ƒç”¨ runC è¿è¡Œå®¹å™¨(ä¸ runC ç­‰å®¹å™¨è¿è¡Œæ—¶äº¤äº’)
+ ç®¡ç†å®¹å™¨ç½‘ç»œæ¥å£åŠç½‘ç»œ

âš ï¸ æ³¨æ„ï¼š**Containerd è¢«è®¾è®¡æˆåµŒå…¥åˆ°ä¸€ä¸ªæ›´å¤§çš„ç³»ç»Ÿä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”±å¼€å‘äººå‘˜æˆ–ç»ˆç«¯ç”¨æˆ·ä½¿ç”¨ã€‚**

![image-20221031142456840](http://sm.nsddd.top/smimage-20221031142456840.png)

:::





## å®‰è£…ï¼ˆå¸è½½ï¼‰k3s

::: warning å¯åŠ¨k3sæœ‰å¤šå¿«ï¼Ÿ
ä¸€è¡Œä»£ç æå®š â€” ä»…éœ€30ç§’ï¼Œå³å¯å¯åŠ¨k3sï¼š

```bash
curl -sfL https://get.k3s.io | sh -
# Check for Ready node, takes maybe 30 seconds
k3s kubectl get node

# if u in china, u can speed up the installation in the following ways
curl -sfL https://rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -
```

> **åŒæ ·ä½ å¯ä»¥é€‰æ‹©æŠŠk3séƒ¨ç½²åœ¨dockerä¸­ï¼Œè¿™æ ·ä½ å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç®¡ç†k3s**



ç¦»çº¿å®‰è£…ï¼š

+ [https://docs.rancher.cn/docs/k3s/installation/airgap/_index/](https://docs.rancher.cn/docs/k3s/installation/airgap/_index/)



æ—¥å¿—æŸ¥çœ‹k3så¯åŠ¨ä¿¡æ¯ï¼š

```bash
tail -f /var/log/syslog
# æˆ–è€…
kubectl get all -n kube-system
```

:::



**å¸è½½k3sï¼š**

::: details å¸è½½k3s
å¦‚æœæ‚¨ä½¿ç”¨å®‰è£…è„šæœ¬å®‰è£…äº† K3sï¼Œé‚£ä¹ˆåœ¨å®‰è£…è¿‡ç¨‹ä¸­ä¼šç”Ÿæˆä¸€ä¸ªå¸è½½ K3s çš„è„šæœ¬ã€‚

> å¸è½½ K3s ä¼šåˆ é™¤é›†ç¾¤æ•°æ®å’Œæ‰€æœ‰è„šæœ¬ã€‚è¦ä½¿ç”¨ä¸åŒçš„å®‰è£…é€‰é¡¹é‡æ–°å¯åŠ¨é›†ç¾¤ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„æ ‡å¿—é‡æ–°è¿è¡Œå®‰è£…è„šæœ¬ã€‚

:::

æä¾›è¦ä» server èŠ‚ç‚¹å¸è½½ K3sï¼Œå’Œéœ€è¦ä»agentç»“ç‚¹å¸è½½K3sï¼š

:::: code-group
::: code-group-item serverç»“ç‚¹

```bash
/usr/local/bin/k3s-uninstall.sh
```

:::
::: code-group-item agentç»“ç‚¹

```bash
/usr/local/bin/k3s-agent-uninstall.sh
```

:::
::::





## é•œåƒåŠ é€Ÿ

é•œåƒåŠ é€Ÿé…ç½®åï¼Œé‡å¯æœåŠ¡

```bash
cat > /etc/rancher/k3s/registries.yaml <<EOF
mirrors:
  docker.io:
    endpoint:
      - "https://fogjl973.mirror.aliyuncs.com"
      - "http://hub-mirror.c.163.com"
      - "https://docker.mirrors.ustc.edu.cn"
      - "https://registry.docker-cn.com"
EOF
```

é‡å¯k3sä½¿é…ç½®ç”Ÿæ•ˆ

```bash
crictl info|grep  -A 5 registry
```

![image-20221031112848849](http://sm.nsddd.top/smimage-20221031112848849.png)



## è¾¹ç¼˜è®¡ç®—

k3s éå¸¸æ”¯æŒè¾¹ç¼˜è®¡ç®—ï¼ŒCICD çš„éƒ¨ç½²ï¼Œå¯ä»¥ç»™æˆ‘ä»¬å¸¦æ¥æ›´å¥½çš„ä½“éªŒã€‚

::: tip è¾¹ç¼˜è®¡ç®—æ˜¯ä»€ä¹ˆï¼Ÿ
*è¾¹ç¼˜è®¡ç®—æ˜¯ä¸ºåº”ç”¨å¼€å‘è€…å’ŒæœåŠ¡æä¾›å•†åœ¨ç½‘ç»œçš„è¾¹ç¼˜ä¾§æä¾›äº‘æœåŠ¡å’ŒITç¯å¢ƒæœåŠ¡ï¼›ç›®æ ‡æ˜¯åœ¨é è¿‘æ•°æ®è¾“å…¥æˆ–ç”¨æˆ·çš„åœ°æ–¹æä¾›è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œå¸¦å®½*ã€‚

é€šä¿—åœ°è¯´ï¼šè¾¹ç¼˜è®¡ç®—æœ¬è´¨ä¸Šæ˜¯ä¸€ç§æœåŠ¡ï¼Œå°±ç±»ä¼¼äºäº‘è®¡ç®—ã€å¤§æ•°æ®æœåŠ¡ï¼Œä½†è¿™ç§æœåŠ¡éå¸¸é è¿‘ç”¨æˆ·ï¼›ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè¿‘ï¼Ÿç›®çš„æ˜¯ä¸ºäº†è®©ç”¨æˆ·æ„Ÿè§‰åˆ°åˆ·ä»€ä¹ˆå†…å®¹éƒ½ç‰¹åˆ«å¿«ã€‚

:::



**æå‡äº†Quick startæˆåŠŸç‡ï¼š**

æˆ‘ä»¬åœ¨äº¤ä»˜è½¯ä»¶çš„æ—¶å€™ï¼Œä»ä»¥å‰çš„ç»™ä¸€ä¸ªJavaç¯å¢ƒåˆ°ç°åœ¨éœ€è¦ä¸€ä¸ªk8s ç¯å¢ƒï¼Œk3såˆ™é›†æˆäº†ï¼Œæä¾›å¼€ç®±å³ç”¨çš„äº¤äº’ä½“éªŒï¼Œé™ä½è½¯ä»¶çš„èµ„æºå ç”¨ï¼Œå¹¶ä¸”ä½¿è¿ç»´éƒ¨ç½²æ›´æ–¹ä¾¿ã€‚



## END é“¾æ¥

<ul><li><div><a href = '13.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '15.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

