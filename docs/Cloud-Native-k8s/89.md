+ [author](http://nsddd.top)

# ç¬¬89èŠ‚ GitOps å®è·µç†è®ºï¼ˆä¸Šéƒ¨åˆ†ï¼‰

<div><a href = '88.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '90.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

ä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹ kubernetes å’Œ gitops çš„ç†è®ºå®è·µ

## å‘½ä»¤ä»‹ç»

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ kubectl æ”¯æŒçš„å­å‘½åï¼Œæ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ï¼š

1. **`kubectl apply`** - åº”ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºçš„å®šä¹‰ã€‚é€šå¸¸ç”¨äºéƒ¨ç½²åº”ç”¨ç¨‹åºæˆ–æ›´æ–°èµ„æºã€‚
2. **`kubectl get`** - æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºçš„ä¿¡æ¯ã€‚è¿™æ˜¯æŸ¥çœ‹ Kubernetes é›†ç¾¤ä¸­èµ„æºçŠ¶æ€çš„å¸¸ç”¨å‘½ä»¤ã€‚
3. **`kubectl describe`** - æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºçš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚äº‹ä»¶ã€çŠ¶æ€å’Œé…ç½®ã€‚
4. **`kubectl delete`** - åˆ é™¤ Kubernetes é›†ç¾¤ä¸­çš„èµ„æºã€‚
5. **`kubectl exec`** - åœ¨é›†ç¾¤ä¸­çš„å®¹å™¨é‡Œæ‰§è¡Œå‘½ä»¤ã€‚
6. **`kubectl logs`** - æ‰“å°å®¹å™¨çš„æ—¥å¿—ã€‚
7. **`kubectl create`** - ä»æ–‡ä»¶æˆ–æ ‡å‡†è¾“å…¥ä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºã€‚
8. **`kubectl edit`** - ç¼–è¾‘é›†ç¾¤ä¸­çš„èµ„æºã€‚è¿™å°†æ‰“å¼€ä¸€ä¸ªç¼–è¾‘å™¨æ¥ä¿®æ”¹èµ„æºçš„é…ç½®ã€‚
9. **`kubectl port-forward`** - å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°é›†ç¾¤ä¸­çš„ Podã€‚
10. **`kubectl run`** - åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªæŒ‡å®šçš„é•œåƒã€‚
11. **`kubectl scale`** - è°ƒæ•´èµ„æºï¼ˆå¦‚ Deploymentã€ReplicaSetï¼‰çš„å‰¯æœ¬æ•°é‡ã€‚
12. **`kubectl rollout`** - ç®¡ç†èµ„æºçš„éƒ¨ç½²ï¼Œå¦‚æŸ¥çœ‹çŠ¶æ€ã€æš‚åœã€æ¢å¤æˆ–å›æ»šæ›´æ–°ã€‚

**é™¤äº†ä¸Šé¢çš„å‘½ä»¤ï¼ŒKubernetes ä¸­çš„ kubectl è¿˜æ”¯æŒæ³¨è§£ï¼š**

`kubectl annotate` å‘½ä»¤ç”¨äºç»™ Kubernetes é›†ç¾¤ä¸­çš„èµ„æºæ·»åŠ æˆ–æ›´æ–°æ³¨è§£ï¼ˆannotationsï¼‰ã€‚æ³¨è§£æ˜¯ä¸€ç§é™„åŠ ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºå­˜å‚¨éè¯†åˆ«æ€§çš„å…ƒæ•°æ®ã€‚å®ƒä»¬é€šå¸¸ç”¨äºç®¡ç†å·¥å…·ã€åº“å’Œå®¢æˆ·ç«¯ä»¥å­˜å‚¨è¾…åŠ©ä¿¡æ¯ï¼Œä¾‹å¦‚æè¿°ã€ç‰ˆæœ¬ä¿¡æ¯ç­‰ã€‚

```bash
kubectl annotate [type] [name] [key]=[value]
```



## Operator

optrator å’Œ controller æ˜¯ç»å¸¸æ··æ·†çš„ä¸¤ä¸ªæœ¯è¯­ï¼Œkubernetes operator æ˜¯ä¸€ä¸ªåº”ç”¨ç‰¹å®šçš„æ§åˆ¶å™¨ï¼Œå®ƒæ‰©å±• Kubernetes API æ¥ä»£è¡¨ Kubernetes çš„å®é™…ç”¨æˆ·å»åˆ›å»ºã€é…ç½®å’Œç®¡ç†å¤æ‚çš„æœ‰çŠ¶æ€åº”ç”¨å®ä¾‹ï¼Œå®ƒåœ¨åŸºç¡€çš„ Kubernetes èµ„æºå’Œæ§åˆ¶å™¨æ¦‚å¿µä¸Šå»å»ºç«‹çš„ã€‚

**æ‰€æœ‰çš„ Operator éƒ½ä½¿ç”¨ Controller çš„æ¨¡å¼ï¼Œä½†å¹¶éæ‰€æœ‰çš„ Controller éƒ½æ˜¯ Operatorã€‚**

é¦–å…ˆï¼Œ**Controller** æ˜¯ Kubernetes ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚å®ƒæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­ç›‘è§†é›†ç¾¤çš„çŠ¶æ€ï¼Œå¹¶åœ¨å¿…è¦æ—¶é‡‡å–è¡ŒåŠ¨ä»¥å°†å½“å‰çŠ¶æ€è½¬å˜ä¸ºæ‰€éœ€çŠ¶æ€ã€‚Controller é€šè¿‡ä¸ Kubernetes API äº¤äº’æ¥å®ç°è¿™ä¸€ç‚¹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª Deployment Controller è´Ÿè´£ç¡®ä¿æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬æ­£åœ¨è¿è¡Œã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼Œ**Operator** æ˜¯ä¸€ç§æ›´ç‰¹å®šçš„æ§åˆ¶å™¨ç±»å‹ã€‚Kubernetes Operator æ˜¯ä¸ºäº†ç®¡ç†å¤æ‚ã€æœ‰çŠ¶æ€çš„åº”ç”¨ç¨‹åºè€Œè®¾è®¡çš„ã€‚å®ƒä¸ä»…åŒ…å«æ ‡å‡†çš„æ§åˆ¶å™¨åŠŸèƒ½ï¼Œè¿˜æ‰©å±•äº† Kubernetes APIï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†ç‰¹å®šåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ•°æ®åº“ Operator å¯ä»¥è´Ÿè´£éƒ¨ç½²æ•°æ®åº“ã€å¤‡ä»½æ•°æ®ã€æ¢å¤æ•°æ®ç­‰ã€‚

å…³é”®åŒºåˆ«åœ¨äºï¼š

+ **Controller** é€šå¸¸æ˜¯æ›´é€šç”¨çš„ï¼Œè´Ÿè´£ç®¡ç† Kubernetes ä¸­çš„æ ‡å‡†èµ„æºï¼Œå¦‚ Podsã€Deployments ç­‰ã€‚
+ **Operator** æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ Controllerï¼Œä¸“é—¨ç”¨äºç®¡ç†ç‰¹å®šçš„ã€é€šå¸¸æ˜¯å¤æ‚çš„åº”ç”¨ç¨‹åºã€‚å®ƒä»¬ä½¿ç”¨è‡ªå®šä¹‰èµ„æºï¼ˆCustom Resourcesï¼‰æ¥è¡¨ç¤ºåº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œå¹¶å®ç°ç‰¹å®šäºè¯¥åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘ã€‚

å› æ­¤ï¼Œ**æ‰€æœ‰çš„ Operator éƒ½ä½¿ç”¨ Controller çš„æ¨¡å¼ï¼Œä½†å¹¶éæ‰€æœ‰çš„ Controller éƒ½æ˜¯ Operator**ã€‚è¿™æ˜¯å› ä¸ºæ‰€æœ‰ Operator éƒ½æ˜¯æ„å»ºåœ¨æ§åˆ¶å™¨æ¨¡å¼ä¹‹ä¸Šçš„ï¼Œä½†æ§åˆ¶å™¨ä¸ä¸€å®šéœ€è¦å…·æœ‰ç®¡ç†ç‰¹å®šåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„å¤æ‚é€»è¾‘å’Œæ‰©å±• API çš„èƒ½åŠ›ï¼Œè¿™æ˜¯ Operator ç‰¹æœ‰çš„ã€‚



### å®ç°ä¸€ä¸ª Operator

æˆ‘ä»¬äº†è§£äº† Controller çš„åŸºç¡€çŸ¥è¯†ä»¥åŠ Controller å’Œ Operator ä¹‹é—´çš„åŒºåˆ«ä¹‹åï¼Œæˆ‘ä»¬å‡†å¤‡å®ç°ä¸€ä¸ª Operator ã€‚ç¤ºä¾‹ Operator å°†è§£å†³å®é™…ç¯å¢ƒä¸­çš„ä»»åŠ¡ï¼šç®¡ç†ä¸€ç»„å¸¦æœ‰é¢„é…ç½®é™æ€èµ„æºå†…å®¹çš„ Nginx æœåŠ¡å™¨ã€‚æ”¹ Operator æ”¯æŒ ç”¨æˆ· æŒ‡å®š Nginx æœåŠ¡å™¨åˆ—è¡¨ï¼Œå¹¶ä¸”é…ç½®å®‰è£…åœ¨æ¯ä¸€ä¸ªæœåŠ¡ä¸Šçš„é™æ€æ–‡ä»¶ã€‚

å¾ˆå®¹æ˜“æƒ³åˆ°çš„æ˜¯ï¼ŒConfigMap æ˜¯æˆ‘ä»¬ç”¨æ¥åšç¯å¢ƒå˜é‡ï¼Œå‘½ä»¤è¡Œå‚æ•°æˆ–è€…å·è½´çš„é…ç½®ä½¿ç”¨çš„ã€‚

Kubernetes çš„æ§åˆ¶å™¨æ˜¯å¯ä»¥ä½¿ç”¨ä»»ä½•ä¸€ç§è¯­è¨€æ¥å®ç°çš„ï¼Œæˆ‘ä»¬ç”¨ bash æ¥ç®€å•ä»‹ç»ä¸€ä¸‹


åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ Kubernetes Operator æ¡ˆä¾‹ï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ° Nginx æœåŠ¡å™¨ç®¡ç†çš„ Operatorï¼Œå¯ä»¥åˆ†ä¸ºå‡ ä¸ªä¸»è¦éƒ¨åˆ†ï¼šå®šä¹‰ CRDï¼ˆCustom Resource Definitionï¼‰ï¼Œç¼–å†™ Operator æ§åˆ¶å™¨ä»£ç ï¼Œä»¥åŠéƒ¨ç½²å’Œæµ‹è¯• Operatorã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ä¸€ç§æ›´å¸¸ç”¨çš„è¯­è¨€å¦‚ Goï¼Œå› ä¸ºå®ƒæä¾›äº†æ›´å¼ºå¤§çš„å·¥å…·å’Œåº“æ¥ä¸ Kubernetes API äº¤äº’ã€‚æˆ‘ä»¬å°†é€šè¿‡ä»¥ä¸‹æ­¥éª¤åˆ›å»ºä¸€ä¸ªç®€å•çš„ Operatorï¼š

### å®šä¹‰ CRD

é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ª CRD æ¥è¡¨ç¤º Nginx çš„é…ç½®ã€‚è¿™ä¸ª CRD å°†æè¿° Nginx å®ä¾‹çš„å±æ€§ï¼Œå¦‚ç‰ˆæœ¬ã€é…ç½®æ–‡ä»¶å†…å®¹å’Œç›¸å…³çš„é™æ€èµ„æºã€‚

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nginxconfigs.example.com
spec:
  group: example.com
  versions:
    - name: v1
      served: true
      storage: true
  scope: Namespaced
  names:
    plural: nginxconfigs
    singular: nginxconfig
    kind: NginxConfig
    shortNames:
    - ngxconf
```

### 2. ç¼–å†™ Operator æ§åˆ¶å™¨

ä½¿ç”¨ Go è¯­è¨€ç¼–å†™ Operator æ§åˆ¶å™¨ã€‚Operator æ§åˆ¶å™¨å°†ç›‘å¬ NginxConfig èµ„æºçš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤äº‹ä»¶ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚

```go
package main

import (
    // å¼•å…¥å¿…è¦çš„åº“
)

func main() {
    // åˆå§‹åŒ–å®¢æˆ·ç«¯ã€ç›‘å¬ NginxConfig èµ„æºçš„å˜åŒ–
    // å®ç°ä¸šåŠ¡é€»è¾‘ï¼šåˆ›å»º/æ›´æ–°/åˆ é™¤ Nginx å®ä¾‹
}
```

### 3. å¤„ç† Nginx å®ä¾‹

åœ¨æ§åˆ¶å™¨ä¸­ï¼Œå¤„ç† Nginx å®ä¾‹çš„åˆ›å»ºå’Œæ›´æ–°ã€‚å½“ä¸€ä¸ª NginxConfig èµ„æºè¢«åˆ›å»ºæˆ–æ›´æ–°æ—¶ï¼Œæ§åˆ¶å™¨ä¼šæ ¹æ®å®šä¹‰çš„è§„æ ¼æ¥è®¾ç½® Nginx Podï¼ŒåŒ…æ‹¬æ‰€éœ€çš„é…ç½®å’Œé™æ€æ–‡ä»¶ã€‚

### 4. åˆ›å»º Docker é•œåƒå’Œéƒ¨ç½² Operator

å°† Operator æ‰“åŒ…æˆ Docker é•œåƒï¼Œç„¶ååœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²è¿™ä¸ªé•œåƒã€‚

```bash
# ä½¿ç”¨åˆé€‚çš„åŸºç¡€é•œåƒ
FROM golang:1.15

# æ·»åŠ  Operator ä»£ç 
ADD . /operator
WORKDIR /operator

# ç¼–è¯‘ Operator
RUN go build -o operator .

# è®¾ç½®å¯åŠ¨å‘½ä»¤
CMD ["./operator"]
```

éƒ¨ç½²åˆ° Kubernetesï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      name: nginx-operator
  template:
    metadata:
      labels:
        name: nginx-operator
    spec:
      containers:
      - name: operator
        image: nginx-operator:latest
```

### 5. æµ‹è¯• Operator

åˆ›å»ºä¸€ä¸ª NginxConfig å®ä¾‹æ¥æµ‹è¯• Operatorï¼š

```yaml
apiVersion: "example.com/v1"
kind: NginxConfig
metadata:
  name: my-nginx
spec:
  version: "latest"
  staticContent: "Welcome to Nginx!"
```

ç›‘è§† Kubernetes é›†ç¾¤ï¼Œç¡®ä¿ Operator æ­£ç¡®å“åº”äº†è¿™ä¸ª NginxConfig å®ä¾‹çš„åˆ›å»ºã€‚

### æ³¨æ„äº‹é¡¹

+ **é”™è¯¯å¤„ç†å’Œèµ„æºæ¸…ç†**ï¼šç¡®ä¿ Operator èƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†é”™è¯¯å’Œèµ„æºçš„ç”Ÿå‘½å‘¨æœŸã€‚
+ **æƒé™å’Œå®‰å…¨**ï¼šç¡®ä¿ Operator æœ‰é€‚å½“çš„æƒé™æ¥ç®¡ç† Kubernetes èµ„æºï¼Œå¹¶è€ƒè™‘å®‰å…¨æ€§ã€‚
+ **æµ‹è¯•å’ŒéªŒè¯**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼Œå……åˆ†æµ‹è¯• Operator çš„è¡Œä¸ºã€‚



## ç®€å•çš„ CICD å…¥é—¨

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ª GitOps Operator æ¥é©±åŠ¨æŒç»­äº¤ä»˜ã€‚

GitOps æ˜¯ä¸€ç§ç”¨äºæŒç»­éƒ¨ç½²çš„å®è·µï¼Œå®ƒå°† Git ä½œä¸ºçœŸå®çŠ¶æ€çš„æºã€‚åœ¨ GitOps æ¨¡å‹ä¸­ï¼Œæ‰€æœ‰çš„éƒ¨ç½²å’Œç¯å¢ƒé…ç½®éƒ½å­˜å‚¨åœ¨ Git ä»“åº“ä¸­ï¼Œè¿™æ ·åšå¯ä»¥æä¾›ç‰ˆæœ¬æ§åˆ¶ã€å®¡è®¡è·Ÿè¸ªå’Œå›æ»šèƒ½åŠ›ã€‚ä¸ºäº†å®ç° GitOpsï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª GitOps Operatorï¼Œå®ƒå°†è‡ªåŠ¨åŒ–ä» Git ä»“åº“åˆ° Kubernetes é›†ç¾¤çš„éƒ¨ç½²è¿‡ç¨‹ã€‚



### åˆ›å»º GitOps Operator çš„æ­¥éª¤

1. **å®šä¹‰ GitOps Operator çš„èŒè´£**ï¼š
   + ç›‘å¬ Git ä»“åº“çš„å˜åŒ–ã€‚
   + å½“ä»“åº“ä¸­çš„å®šä¹‰ï¼ˆå¦‚ Kubernetes éƒ¨ç½²æ–‡ä»¶ï¼‰å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè‡ªåŠ¨åº”ç”¨è¿™äº›å˜åŒ–åˆ° Kubernetes é›†ç¾¤ã€‚
   + ç¡®ä¿é›†ç¾¤çŠ¶æ€ä¸ Git ä»“åº“ä¸­å®šä¹‰çš„çŠ¶æ€ä¿æŒä¸€è‡´ã€‚
2. **é€‰æ‹©å·¥å…·å’Œæ¡†æ¶**ï¼š
   + ä½¿ç”¨å¦‚ Operator SDK æˆ– Kubebuilder ç­‰å·¥å…·å¯ä»¥ç®€åŒ– Operator çš„åˆ›å»ºå’Œç®¡ç†è¿‡ç¨‹ã€‚
   + å¯¹äº Git äº¤äº’ï¼Œå¯ä»¥ä½¿ç”¨ Git å®¢æˆ·ç«¯åº“ï¼Œä¾‹å¦‚ Go-gitï¼ˆå¯¹äº Go è¯­è¨€ï¼‰ã€‚
3. **å®ç° GitOps Operator**ï¼š
   + ä½¿ç”¨ CRD å®šä¹‰ GitOps é…ç½®ï¼ŒåŒ…æ‹¬ Git ä»“åº“çš„ URLã€åˆ†æ”¯ã€è·¯å¾„ç­‰ã€‚
   + ç¼–å†™ Operator æ§åˆ¶å™¨é€»è¾‘æ¥å¤„ç†è¿™äº›è‡ªå®šä¹‰èµ„æºï¼ŒåŒ…æ‹¬ä» Git ä»“åº“å…‹éš†ä»£ç ã€è§£æ Kubernetes é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†å…¶åº”ç”¨åˆ°é›†ç¾¤ä¸­ã€‚
4. **éƒ¨ç½²å’Œæµ‹è¯• Operator**ï¼š
   + å°† Operator å®¹å™¨åŒ–ï¼Œéƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ã€‚
   + åˆ›å»º GitOps é…ç½®èµ„æºæ¥æµ‹è¯• Operatorï¼Œç¡®ä¿å®ƒèƒ½æ­£ç¡®åœ°ä» Git ä»“åº“æ‹‰å–å’Œéƒ¨ç½²é…ç½®ã€‚
5. **æ•´åˆæŒç»­é›†æˆæµç¨‹**ï¼š
   + å°† GitOps Operator é›†æˆåˆ° CI æµç¨‹ä¸­ï¼Œä»¥è‡ªåŠ¨è§¦å‘é›†ç¾¤çš„æ›´æ–°ã€‚
   + åœ¨ä»£ç æäº¤åˆ° Git ä»“åº“åï¼ŒCI å·¥å…·ï¼ˆå¦‚ Jenkinsã€GitLab CI æˆ– GitHub Actionsï¼‰å¯ä»¥è¿è¡Œæµ‹è¯•ï¼Œåˆå¹¶ä»£ç ï¼Œè§¦å‘ Operator åº”ç”¨æ›´æ–°ã€‚



### å®ç° GitOps Operator

1. **å®šä¹‰ GitOps CRD**ï¼š

   + åˆ›å»ºä¸€ä¸ª Custom Resource Definitionï¼ˆCRDï¼‰ï¼Œç”¨äºè¡¨ç¤º GitOps é…ç½®ã€‚è¿™ä¸ª CRD åº”è¯¥åŒ…æ‹¬ Git ä»“åº“çš„åœ°å€ã€åˆ†æ”¯ã€ä»¥åŠè·¯å¾„ã€‚

   ```yanl
   apiVersion: apiextensions.k8s.io/v1
   kind: CustomResourceDefinition
   metadata:
     name: gitopsconfigs.gitops.example.com
   spec:
     group: gitops.example.com
     versions:
       - name: v1
         served: true
         storage: true
     scope: Namespaced
     names:
       plural: gitopsconfigs
       singular: gitopsconfig
       kind: GitOpsConfig
       shortNames:
       - goc
   ```

2. **ç¼–å†™ Operator æ§åˆ¶å™¨**ï¼š

   + ä½¿ç”¨ Goã€Python æˆ–å…¶ä»–ç¼–ç¨‹è¯­è¨€ç¼–å†™ Operator æ§åˆ¶å™¨ã€‚
   + æ§åˆ¶å™¨åº”å½“ç›‘å¬ GitOpsConfig èµ„æºçš„å˜åŒ–ï¼Œå¹¶æ ¹æ®å…¶å®šä¹‰çš„ Git ä»“åº“ä¿¡æ¯åŒæ­¥é…ç½®ã€‚
   + æ§åˆ¶å™¨åº”å½“èƒ½å¤Ÿä» Git ä»“åº“å…‹éš†é…ç½®æ–‡ä»¶ï¼Œè§£æ Kubernetes éƒ¨ç½²æ–‡ä»¶ï¼Œå¹¶å°†å…¶åº”ç”¨åˆ°é›†ç¾¤ä¸­ã€‚

3. **æ„å»ºå’Œéƒ¨ç½² Operator**ï¼š

   + åˆ›å»º Docker é•œåƒå¹¶å°† Operator éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ã€‚

4. **æµ‹è¯• Operator**ï¼š

   + åœ¨ Git ä»“åº“ä¸­æ›´æ–° Nginx çš„é…ç½®æˆ–ç‰ˆæœ¬ã€‚
   + è§‚å¯Ÿ Operator æ˜¯å¦è‡ªåŠ¨å°†æ›´æ–°åº”ç”¨åˆ° Kubernetes é›†ç¾¤ã€‚

### æŒç»­é›†æˆ (CI) é›†æˆ

1. **è®¾ç½® CI å·¥å…·**ï¼š
   + é€‰æ‹©ä¸€ä¸ª CI å·¥å…·ï¼ˆå¦‚ Jenkinsã€Travis CIã€GitHub Actionsï¼‰ã€‚
   + åœ¨ Git ä»“åº“ä¸­è®¾ç½® CI æµç¨‹ï¼Œä»¥åœ¨ä»£ç æäº¤æ—¶è¿è¡Œæµ‹è¯•ã€‚
2. **è‡ªåŠ¨åŒ–è§¦å‘**ï¼š
   + é…ç½® CI å·¥å…·åœ¨ä»£ç å˜æ›´è¢«åˆå¹¶åˆ°ä¸»åˆ†æ”¯åè‡ªåŠ¨é€šçŸ¥ Kubernetes é›†ç¾¤ï¼Œè§¦å‘ GitOps Operator åº”ç”¨æ›´æ–°ã€‚

### å®Œæ•´çš„ GitOps æµç¨‹

+ å¼€å‘äººå‘˜æäº¤ä»£ç åˆ° Git ä»“åº“ã€‚
+ CI å·¥å…·åœ¨ä»£ç åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶è¿è¡Œæµ‹è¯•ã€‚
+ GitOps Operator ç›‘å¬åˆ° Git ä»“åº“çš„å˜åŒ–ï¼Œè‡ªåŠ¨åŒæ­¥æ›´æ–°åˆ° Kubernetes é›†ç¾¤ã€‚



## ç¯å¢ƒç®¡ç†

ä¸åŒçš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œä»¥åŠ Kubernetes å‘½åç©ºé—´æ˜¯å¦‚ä½•å®šä¹‰ç¯å¢ƒè¾¹ç•Œçš„ã€‚

ä¸€ä¸ªç¯å¢ƒæ˜¯ç”±ä¸‰ä¸ªåŒæ ·é‡è¦çš„éƒ¨åˆ†ç»„æˆçš„ï¼š

+ ä»£ç 
+ æ»¡è¶³å…ˆå†³æ¡ä»¶çš„è¿è¡Œæ—¶
+ é…ç½®

**ä»£ç ï¼š**

ä»£ç æ˜¯åº”ç”¨ç¨‹åºæ‰§è¡Œç‰¹å®šä»»åŠ¡çš„æœºå™¨æŒ‡ä»¤ã€‚è¦æ‰§è¡Œä»£ç ï¼Œå¯èƒ½è¿˜éœ€è¦è¿è¡Œæ—¶ä¾èµ–é¡¹ã€‚ä¾‹å¦‚ï¼ŒNode.jsä»£ç éœ€è¦Node.jsäºŒè¿›åˆ¶åŒ…å’Œå…¶ä»–NPMåŒ…æ‰èƒ½æˆåŠŸåœ°æ‰§è¡Œã€‚å¯¹äºKubernetesï¼Œæ‰€æœ‰è¿è¡Œæ—¶ä¾èµ–é¡¹å’Œä»£ç éƒ½æ‰“åŒ…ä¸ºä¸€ä¸ªå¯éƒ¨ç½²å•å…ƒï¼ˆåˆåDockeræ˜ åƒï¼‰ï¼Œå¹¶é€šè¿‡Dockerå®ˆæŠ¤è¿›ç¨‹è¿›è¡Œç¼–æ’ã€‚åº”ç”¨ç¨‹åºçš„Dockeræ˜ åƒå¯ä»¥æ”¾å¿ƒåœ°åœ¨ä»»ä½•ç¯å¢ƒä¸­è¿è¡Œï¼Œä»å¼€å‘äººå‘˜çš„ç¬”è®°æœ¬ç”µè„‘åˆ°åœ¨äº‘ä¸­è¿è¡Œçš„ç”Ÿäº§é›†ç¾¤ï¼Œå› ä¸ºæ˜ åƒå°è£…äº†ä»£ç å’Œæ‰€æœ‰ä¾èµ–å…³ç³»ï¼Œæ¶ˆé™¤äº†ç¯å¢ƒä¹‹é—´æ½œåœ¨çš„ä¸å…¼å®¹æ€§ã€‚

åœ¨è½¯ä»¶éƒ¨ç½²ä¸­ï¼Œç¯å¢ƒæ˜¯éƒ¨ç½²å’Œæ‰§è¡Œä»£ç çš„åœ°æ–¹ã€‚åœ¨è½¯ä»¶å¼€å‘çš„ç”Ÿå­˜å‘¨æœŸä¸­ï¼Œä¸åŒçš„ç¯å¢ƒæœåŠ¡äºä¸åŒçš„ç›®çš„ã€‚ä¾‹å¦‚ï¼Œæœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆåˆåç¬”è®°æœ¬ç”µè„‘ï¼‰æ˜¯å·¥ç¨‹å¸ˆå¯ä»¥åˆ›å»ºã€æµ‹è¯•å’Œè°ƒè¯•æ–°ä»£ç ç‰ˆæœ¬çš„åœ°æ–¹ã€‚åœ¨å·¥ç¨‹å¸ˆå®Œæˆä»£ç å¼€å‘åï¼Œä¸‹ä¸€æ­¥æ˜¯å°†æ›´æ”¹æäº¤åˆ°Gitï¼Œå¹¶å¼€å§‹éƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒä¸­è¿›è¡Œé›†æˆæµ‹è¯•å’Œæœ€ç»ˆçš„äº§å“å‘å¸ƒã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºæŒç»­é›†æˆ/æŒç»­éƒ¨ç½²ï¼ˆCI/CDï¼‰ï¼Œé€šå¸¸ç”±ä»¥ä¸‹ç¯å¢ƒç»„æˆï¼š

+ QA
+ E2E
+ é˜¶æ®µå’Œäº§å“

åœ¨QAç¯å¢ƒä¸­ï¼Œæ–°ä»£ç å°†æ ¹æ®ç¡¬ä»¶ã€æ•°æ®å’Œå…¶ä»–ç±»ä¼¼äºç”Ÿäº§çš„ä¾èµ–é¡¹è¿›è¡Œæµ‹è¯•ï¼Œä»¥ç¡®ä¿æœåŠ¡çš„æ­£ç¡®æ€§ã€‚å¦‚æœæ‰€æœ‰çš„æµ‹è¯•éƒ½é€šè¿‡äº†QAï¼Œæ–°çš„ä»£ç å°†è¢«æå‡åˆ°E2Eç¯å¢ƒï¼Œä½œä¸ºå…¶ä»–é¢„å‘å¸ƒæœåŠ¡æµ‹è¯•/é›†æˆçš„ç¨³å®šç¯å¢ƒã€‚QAå’ŒE2Eç¯å¢ƒä¹Ÿç§°ä¸ºé¢„ç”Ÿäº§ï¼ˆpreprodï¼‰ç¯å¢ƒï¼Œå› ä¸ºå®ƒä»¬ä¸æ‰¿è½½ç”Ÿäº§æµé‡æˆ–ä½¿ç”¨ç”Ÿäº§æ•°æ®ã€‚å½“ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ä»£ç å‡†å¤‡å¥½ç”¨äºç”Ÿäº§å‘å¸ƒæ—¶ï¼Œä»£ç é€šå¸¸ä¼šé¦–å…ˆéƒ¨ç½²åœ¨Stageç¯å¢ƒä¸­ï¼ˆå®ƒå¯ä»¥è®¿é—®å®é™…çš„ç”Ÿäº§ä¾èµ–ï¼‰ï¼Œä»¥ç¡®ä¿åœ¨ä»£ç è¿›å…¥Prodç¯å¢ƒä¹‹å‰ï¼Œæ‰€æœ‰çš„ç”Ÿäº§ä¾èµ–éƒ½å·²åˆ°ä½ã€‚ä¾‹å¦‚ï¼Œæ–°ä»£ç å¯èƒ½éœ€è¦ä¸€ä¸ªæ–°çš„æ•°æ®åº“æ¨¡å¼æ›´æ–°ï¼Œè€ŒStageç¯å¢ƒå¯ä»¥ç”¨æ¥éªŒè¯æ–°æ¨¡å¼æ˜¯å¦æ­£ç¡®ã€‚é…ç½®åªå°†æµ‹è¯•æµé‡å®šå‘åˆ°Stageç¯å¢ƒï¼Œè¿™æ ·æ–°ä»£ç å¼•å…¥çš„ä»»ä½•é—®é¢˜éƒ½ä¸ä¼šå½±å“å®é™…å®¢æˆ·ã€‚ä½†æ˜¯ï¼ŒStageç¯å¢ƒé€šå¸¸é…ç½®ä¸ºä½¿ç”¨â€œçœŸå®çš„â€ç”Ÿäº§æ•°æ®åº“æ“ä½œã€‚åœ¨Stageç¯å¢ƒä¸­è¿›è¡Œçš„æµ‹è¯•å¿…é¡»ç»è¿‡ä»”ç»†çš„å®¡æŸ¥ï¼Œä»¥ç¡®ä¿å®ƒä»¬åœ¨ç”Ÿäº§ä¸­æ˜¯å®‰å…¨çš„ã€‚æ‰€æœ‰æµ‹è¯•åœ¨Stageä¸­é€šè¿‡åï¼Œæ–°ä»£ç å°†æœ€ç»ˆéƒ¨ç½²åˆ°Prodä¸­ï¼Œç”¨äºå®æ—¶ç”Ÿäº§æµé‡ã€‚å› ä¸ºStageå’ŒProdéƒ½å¯ä»¥è®¿é—®ç”Ÿäº§æ•°æ®ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½è¢«è®¤ä¸ºæ˜¯ç”Ÿäº§ç¯å¢ƒã€‚



**å‘½åç©ºé—´ç®¡ç†**

å‘½åç©ºé—´æ˜¯Kubernetesä¸­æ”¯æŒç¯å¢ƒçš„è‡ªç„¶æ„é€ ã€‚å®ƒä»¬å…è®¸åœ¨å¤šä¸ªå›¢é˜Ÿæˆ–é¡¹ç›®ä¹‹é—´åˆ’åˆ†ç¾¤é›†èµ„æºã€‚å‘½åç©ºé—´ä¸ºå”¯ä¸€èµ„æºå‘½åã€èµ„æºé…é¢ã€RBACã€ç¡¬ä»¶éš”ç¦»å’Œç½‘ç»œé…ç½®æä¾›äº†èŒƒå›´ï¼š

`Kubernetes å‘½åç©ºé—´~=ç¯å¢ƒ`

åœ¨æ¯ä¸ªå‘½åç©ºé—´ä¸­ï¼Œåº”ç”¨ç¨‹åºå®ä¾‹ï¼ˆåˆåPodï¼‰æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªDockerå®¹å™¨ï¼Œåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­æ³¨å…¥äº†ç¯å¢ƒç‰¹å®šçš„åº”ç”¨ç¨‹åºå±æ€§ã€‚è¿™äº›åº”ç”¨ç¨‹åºå±æ€§å®šä¹‰äº†ç¯å¢ƒåº”è¯¥å¦‚ä½•è¿è¡Œï¼ˆæ¯”å¦‚feature flagï¼‰ä»¥åŠåº”è¯¥ä½¿ç”¨å“ªäº›å¤–éƒ¨ä¾èµ–ï¼ˆæ¯”å¦‚æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼‰ã€‚é™¤äº†åº”ç”¨ç¨‹åºPodä¹‹å¤–ï¼ŒNamespaceè¿˜å¯ä»¥åŒ…å«æä¾›ç¯å¢ƒæ‰€éœ€çš„é™„åŠ åŠŸèƒ½çš„å…¶ä»–Podã€‚

Namespaceç›¸å½“äºKubernetesä¸­çš„ç¯å¢ƒã€‚å‘½åç©ºé—´å¯ä»¥ç”±Podsï¼ˆåº”ç”¨ç¨‹åºå®ä¾‹ï¼‰ã€ç½‘ç»œç­–ç•¥ï¼ˆå…¥å£/å‡ºå£ï¼‰å’ŒRBACï¼ˆè®¿é—®æ§åˆ¶ï¼‰ï¼Œä»¥åŠåœ¨å•ç‹¬çš„Podä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºä¾èµ–ã€‚

RBACæ˜¯ä¸€ç§æ ¹æ®ä¼ä¸šå†…å„ä¸ªç”¨æˆ·çš„è§’è‰²æ¥ç®¡ç†å¯¹è®¡ç®—æœºæˆ–ç½‘ç»œèµ„æºçš„è®¿é—®çš„æ–¹æ³•ã€‚åœ¨Kubernetesä¸­ï¼Œè§’è‰²åŒ…å«è¡¨ç¤ºä¸€ç»„æƒé™çš„è§„åˆ™ã€‚æƒé™çº¯ç²¹æ˜¯åŠ æ€§çš„ï¼ˆæ²¡æœ‰å¦å®šè§„åˆ™ï¼‰ã€‚è§’è‰²å¯ä»¥ä½¿ç”¨è§’è‰²åœ¨å‘½åç©ºé—´ä¸­å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Cluster Roleåœ¨é›†ç¾¤èŒƒå›´å†…å®šä¹‰ã€‚å‘½åç©ºé—´è¿˜å¯ä»¥å…·æœ‰ä¸“ç”¨çš„ç¡¬ä»¶å’Œç½‘ç»œç­–ç•¥ï¼Œä»¥ä¾¿æ ¹æ®åº”ç”¨ç¨‹åºéœ€æ±‚å¯¹å…¶é…ç½®è¿›è¡Œä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼ŒCPUå¯†é›†å‹åº”ç”¨ç¨‹åºå¯ä»¥éƒ¨ç½²åœ¨å…·æœ‰ä¸“ç”¨å¤šæ ¸ç¡¬ä»¶çš„å‘½åç©ºé—´ä¸­ã€‚å¦ä¸€ä¸ªéœ€è¦é‡ç£ç›˜çš„æœåŠ¡æˆ‘/Oå¯ä»¥éƒ¨ç½²åœ¨å…·æœ‰é«˜é€ŸSSDçš„å•ç‹¬å‘½åç©ºé—´ä¸­ã€‚æ¯ä¸ªåç§°ç©ºé—´è¿˜å¯ä»¥å®šä¹‰è‡ªå·±çš„ç½‘ç»œç­–ç•¥ï¼ˆå…¥å£/å‡ºå£ï¼‰ï¼Œä»¥é™åˆ¶è·¨åç§°ç©ºé—´æµé‡æˆ–ä½¿ç”¨éé™å®šDNSåç§°è®¿é—®é›†ç¾¤ä¸­çš„å…¶ä»–åç§°ç©ºé—´ã€‚



### ç¯å¢ƒæ¨¡æ‹Ÿ

æ¨¡æ‹Ÿä¸¤ä¸ªç¯å¢ƒï¼Œåˆ†åˆ«æ˜¯ æµ‹è¯•ç¯å¢ƒï¼ˆqa) ä»¥åŠéç”Ÿäº§ e2e ç¯å¢ƒï¼ˆe2e)

é¦–å…ˆï¼Œä¸ºæ‚¨çš„æ¯ä¸ªæ¥å®¾ç°¿ç¯å¢ƒåˆ›å»ºguestbook-qaå’Œguestbook-e2eå‘½åç©ºé—´:

```bash
$ kubectl create namespace guestbook-qa
$ kubectl create namespace guestbook-e2
$ kubectl get namespaces
```

 ç°åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†ç•™è¨€ç°¿åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ç•™è¨€ç°¿-qaç¯å¢ƒ:

```bash
$ export K8S_GUESTBOOK_URL=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/guestbook/redis-leader-deployment.yaml
$ kubectl apply -n guestbook-qa -f ${K8S_GUESTBOOK_URL}/redis-master-deployment.yaml
```

æŸ¥è¯¢ Pod åˆ—è¡¨ä»¥éªŒè¯ Redis Pod æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š

```shell
$ kubectl get pods -n guestbook-qa
NAME                            READY   STATUS    RESTARTS   AGE
redis-leader-5596fc7b68-wxjvp   1/1     Running   0          77s
```

è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ Redis Deployment ä¸­çš„æ—¥å¿—ï¼š

```bash
$ kubectl logs -f deployment/redis-leader -n guestbook-qa 
1:C 26 Nov 2023 05:57:07.309 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
1:C 26 Nov 2023 05:57:07.309 # Redis version=6.0.5, bits=64, commit=00000000, modified=0, pid=1, just started
1:C 26 Nov 2023 05:57:07.309 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
1:M 26 Nov 2023 05:57:07.311 * Running mode=standalone, port=6379.
1:M 26 Nov 2023 05:57:07.311 # Server initialized
1:M 26 Nov 2023 05:57:07.311 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
1:M 26 Nov 2023 05:57:07.311 * Ready to accept connections
```



### åˆ›å»º Redis é¢†å¯¼è€…æœåŠ¡

ç•™è¨€æ¿åº”ç”¨éœ€è¦å¾€ Redis ä¸­å†™æ•°æ®ã€‚å› æ­¤ï¼Œéœ€è¦åˆ›å»º [Service](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/) æ¥è½¬å‘ Redis Pod çš„æµé‡ã€‚Service å®šä¹‰äº†è®¿é—® Pod çš„ç­–ç•¥ã€‚

ç•™è¨€æ¿åº”ç”¨éœ€è¦å¾€ Redis ä¸­å†™æ•°æ®ã€‚å› æ­¤ï¼Œéœ€è¦åˆ›å»º [Service](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/) æ¥è½¬å‘ Redis Pod çš„æµé‡ã€‚Service å®šä¹‰äº†è®¿é—® Pod çš„ç­–ç•¥ã€‚

[`application/guestbook/redis-leader-service.yaml`](https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/guestbook/redis-leader-service.yaml) 

```yaml
# æ¥æºï¼šhttps://cloud.google.com/kubernetes-engine/docs/tutorials/guestbook
apiVersion: v1
kind: Service
metadata:
  name: redis-leader
  labels:
    app: redis
    role: leader
    tier: backend
spec:
  ports:
  - port: 6379
    targetPort: 6379
  selector:
    app: redis
    role: leader
    tier: backend
```

1. ä½¿ç”¨ä¸‹é¢çš„ `redis-leader-service.yaml` æ–‡ä»¶åˆ›å»º Redis çš„æœåŠ¡ï¼š

   ```shell
   $ kubectl apply -f ./guestbook/redis-leader-service.yaml  -n guestbook-qa
   ```

1. æŸ¥è¯¢æœåŠ¡åˆ—è¡¨éªŒè¯ Redis æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š

   ```shell
   $ kubectl get -n guestbook-qa service
   ```

   å“åº”åº”è¯¥ä¸æ­¤ç±»ä¼¼ï¼š

   ```
   NAME           TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
   redis-leader   ClusterIP   10.68.10.77   <none>        6379/TCP   3s
   ```

**è¯´æ˜ï¼š**

è¿™ä¸ªæ¸…å•æ–‡ä»¶åˆ›å»ºäº†ä¸€ä¸ªåä¸º `redis-leader` çš„ Serviceï¼Œ å…¶ä¸­åŒ…å«ä¸€ç»„ä¸å‰é¢å®šä¹‰çš„æ ‡ç­¾åŒ¹é…çš„æ ‡ç­¾ï¼Œå› æ­¤æœåŠ¡å°†ç½‘ç»œæµé‡è·¯ç”±åˆ° Redis Pod ä¸Šã€‚



### è®¾ç½® Redis è·Ÿéšè€…

å°½ç®¡ Redis é¢†å¯¼è€…åªæœ‰ä¸€ä¸ª Podï¼Œä½ å¯ä»¥é€šè¿‡æ·»åŠ è‹¥å¹² Redis è·Ÿéšè€…æ¥å°†å…¶é…ç½®ä¸ºé«˜å¯ç”¨çŠ¶æ€ï¼Œ ä»¥æ»¡è¶³æµé‡éœ€æ±‚ã€‚

```yaml
# æ¥æºï¼šhttps://cloud.google.com/kubernetes-engine/docs/tutorials/guestbook
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-follower
  labels:
    app: redis
    role: follower
    tier: backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
        role: follower
        tier: backend
    spec:
      containers:
      - name: follower
        image: gcr.io/google_samples/gb-redis-follower:v2
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 6379
```

1. åº”ç”¨ä¸‹é¢çš„ `redis-follower-deployment.yaml` æ–‡ä»¶åˆ›å»º Redis Deploymentï¼š

   ```shell
   $ kubectl apply -f ./guestbook/redis-follower-deployment.yaml -n guestbook-qa
   ```

2. é€šè¿‡æŸ¥è¯¢ Pods åˆ—è¡¨ï¼ŒéªŒè¯ä¸¤ä¸ª Redis è·Ÿéšè€…å‰¯æœ¬åœ¨è¿è¡Œï¼š

```shell
$ kubectl get  -n guestbook-qa pods
```

æ¥ä¸‹æ¥åŒæ ·ä¹Ÿæ˜¯æµ‹è¯• guestbook-qa çš„ç¯å¢ƒæ˜¯å¦æ˜¯ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚

ç„¶ååŒæ ·æ˜¯å§ guestbook-qa æ™‹çº§åˆ° guestbook-e2e ç¯å¢ƒï¼Œ

ç„¶ååŒæ ·çš„æµ‹è¯• guestbook-e2e ç¯å¢ƒæ˜¯å¦æ­£å¸¸å·¥ä½œã€‚



### ç½‘ç»œéš”ç¦»

å®šä¹‰éƒ¨ç½²åº”ç”¨ç¨‹åºçš„ç¯å¢ƒçš„ä¸€ä¸ªå…³é”®æ–¹é¢æ˜¯ç¡®ä¿åªæœ‰ç›®æ ‡å®¢æˆ·ç«¯å¯ä»¥è®¿é—®ç‰¹å®šçš„ç¯å¢ƒã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å‘½åç©ºé—´éƒ½å¯ä»¥è¿æ¥åˆ°åœ¨æ‰€æœ‰å…¶ä»–å‘½åç©ºé—´ä¸­è¿è¡Œçš„æœåŠ¡ã€‚ä½†æ˜¯å¯¹äºä¸¤ä¸ªä¸åŒçš„ç¯å¢ƒï¼Œæ¯”å¦‚QAå’ŒProdï¼Œæ‚¨ä¸å¸Œæœ›è¿™äº›ç¯å¢ƒä¹‹é—´å‘ç”Ÿä¸²æ‰°ã€‚å¹¸è¿çš„æ˜¯ï¼Œå¯ä»¥åº”ç”¨å‘½åç©ºé—´ç½‘ç»œç­–ç•¥æ¥é™åˆ¶å‘½åç©ºé—´ä¹‹é—´çš„ç½‘ç»œé€šä¿¡ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ä¸¤ä¸ªä¸åŒçš„åç§°ç©ºé—´ï¼Œå¹¶ä½¿ç”¨ç½‘ç»œç­–ç•¥æ§åˆ¶è®¿é—®ã€‚æˆ‘ä»¬å°†ä»‹ç»åœ¨ä¸¤ä¸ªä¸åŒçš„å‘½åç©ºé—´ä¸­éƒ¨ç½²æœåŠ¡çš„æ­¥éª¤ã€‚æ‚¨è¿˜å°†ä¿®æ”¹ç½‘ç»œç­–ç•¥å¹¶è§‚å¯Ÿå…¶æ•ˆæœã€‚

> Egress traffic is network traffic that begins inside a network and pro-EGRESSceeds through its routers to a destination somewhere outside the network.

å‡ºå£æµé‡æ˜¯ä»ç½‘ç»œå†…éƒ¨å¼€å§‹ï¼Œç»è¿‡è·¯ç”±å™¨åˆ°è¾¾ç½‘ç»œå¤–éƒ¨æŸä¸ªç›®çš„åœ°çš„ç½‘ç»œæµé‡ã€‚

>  Ingress traffic is composed of all the data communications and net-INGRESSwork traffic originating from external networks.

å…¥å£æµé‡ç”±æ¥è‡ªå¤–éƒ¨ç½‘ç»œçš„æ‰€æœ‰æ•°æ®é€šä¿¡å’Œç½‘ç»œ-INGRESSå·¥ä½œæµé‡ç»„æˆã€‚

> Before you begin, verify thatVERIFY KUBERNETES CLUSTER CONNECTIONyou have correctly configured your KUBECONFIG environment variable topoint to the desired Kubernetes cluster. Please refer to appendix A for more information.

å¼€å§‹ä¹‹å‰ï¼Œè¯·éªŒè¯æ‚¨æ˜¯å¦å·²æ­£ç¡®é…ç½®KUBERNETES CLUSTER CONNECTIONç¯å¢ƒå˜é‡ä»¥æŒ‡å‘æ‰€éœ€çš„Kubernetesç¾¤é›†ã€‚è¯¦æƒ…è¯·å‚é˜…é™„å½•Aã€‚

å¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­è¿è¡Œçš„ Pod å¯ä»¥å¾€ä¸åŒçš„å‘½åç©ºé—´ä¸­è¿è¡Œçš„å…¶ä»– Pod å‘é€ç½‘ç»œæµé‡ï¼Œæˆ‘ä»¬ä¸‹é¢é€šè¿‡ä» qa å‘½åç©ºé—´çš„ Pod åˆ° prod å‘½åç©ºé—´çš„ Nginx pod æ‰§è¡Œä¸€æ¡ url å‘½ä»¤æ¥è¯æ˜è¿™ä¸€ç‚¹ï¼š

```bash
$ kubectl describe pod web -n prod | grep IPz
$ kubectl -n qa exec curl-pod -- curl -I http://<web pod ip>
$ kubectl -n prod exec curl-pod -- curl -I http://<web pod ip>
```

é€šå¸¸ï¼Œæ‚¨æ°¸è¿œä¸å¸Œæœ›qaå’Œprodç¯å¢ƒä¹‹é—´å­˜åœ¨ç›¸äº’ä¾èµ–æ€§ã€‚å¦‚æœåº”ç”¨ç¨‹åºçš„ä¸¤ä¸ªå®ä¾‹éƒ½è¢«æ­£ç¡®é…ç½®ï¼Œé‚£ä¹ˆqaå’Œprodä¹‹é—´å°±ä¸ä¼šæœ‰ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯å¦‚æœqaçš„é…ç½®ä¸­æœ‰ä¸€ä¸ªbugï¼Œå®ƒæ„å¤–åœ°å‘prodå‘é€äº†æµé‡ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæ‚¨å¯èƒ½ä¼šæŸåç”Ÿäº§æ•°æ®ã€‚ç”šè‡³åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœä¸€ä¸ªç¯å¢ƒæ‰¿è½½æ‚¨çš„è¥é”€ç«™ç‚¹ï¼Œè€Œå¦ä¸€ä¸ªç¯å¢ƒæ‰¿è½½åŒ…å«æ•æ„Ÿæ•°æ®çš„HRåº”ç”¨ç¨‹åºï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œé˜»æ­¢åç§°ç©ºé—´ä¹‹é—´çš„ç½‘ç»œæµé‡æˆ–è€…åªå…è®¸ç‰¹å®šåç§°ç©ºé—´ä¹‹é—´çš„æµé‡å¯èƒ½æ˜¯åˆé€‚çš„ã€‚è¿™å¯ä»¥é€šè¿‡å‘åç§°ç©ºé—´æ·»åŠ ç½‘ç»œç­–ç•¥æ¥å®Œæˆã€‚è®©æˆ‘ä»¬åœ¨æ¯ä¸ªåç§°ç©ºé—´ä¸­ä¸ºæˆ‘ä»¬çš„Podsæ·»åŠ ä¸€ä¸ªç½‘ç»œç­–ç•¥:

```bash
$ kubectl apply -f block-other-namespace.yaml
```



### Git ç­–ç•¥

GitOps ä¸­é’ˆå¯¹ Git çš„ä¸‰ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯å•åˆ†æ”¯ï¼ˆå¤šç›®å½•ï¼‰ï¼Œå¤šåˆ†æ”¯ï¼Œå¤šä»£ç åº“ä¸å•ä¸€ä»£ç åº“

1. **å•åˆ†æ”¯ï¼ˆå¤šç›®å½•ï¼‰ç­–ç•¥**ï¼šè¿™ç§ç­–ç•¥ä½¿ç”¨å•ä¸€çš„Gitåˆ†æ”¯æ¥ç®¡ç†æ‰€æœ‰çš„é…ç½®æ–‡ä»¶ï¼Œä½†å°†ä¸åŒçš„ç¯å¢ƒï¼ˆå¦‚å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ï¼‰çš„é…ç½®æ”¾ç½®åœ¨ä¸åŒçš„ç›®å½•ä¸­ã€‚è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ç®€å•æ˜“ç®¡ç†ï¼Œå› ä¸ºæ‰€æœ‰ç¯å¢ƒçš„é…ç½®éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ã€‚ä½†ç¼ºç‚¹æ˜¯å¯èƒ½ä¼šå› ä¸ºé…ç½®çš„ç´§å¯†è€¦åˆè€Œå¯¼è‡´é—®é¢˜çš„ä¼ æ’­ï¼Œä¾‹å¦‚ï¼Œé”™è¯¯çš„é…ç½®å¯èƒ½ä¼šå½±å“åˆ°å¤šä¸ªç¯å¢ƒã€‚
2. **å¤šåˆ†æ”¯ç­–ç•¥**ï¼šåœ¨è¿™ç§ç­–ç•¥ä¸­ï¼Œä¸ºä¸åŒçš„ç¯å¢ƒï¼ˆå¦‚å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ï¼‰åˆ›å»ºä¸åŒçš„Gitåˆ†æ”¯ã€‚è¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯å¯ä»¥æ›´å¥½åœ°éš”ç¦»ä¸åŒç¯å¢ƒçš„é…ç½®ï¼Œå‡å°‘é”™è¯¯é…ç½®å¯¹å…¶ä»–ç¯å¢ƒçš„å½±å“ã€‚ç¼ºç‚¹æ˜¯éœ€è¦æ›´å¤šçš„åˆ†æ”¯ç®¡ç†å·¥ä½œï¼Œå¹¶ä¸”åœ¨åˆ†æ”¯ä¹‹é—´åŒæ­¥æ›´æ”¹å¯èƒ½ä¼šå˜å¾—å¤æ‚ã€‚
3. **å¤šä»£ç åº“ä¸å•ä¸€ä»£ç åº“**ï¼šè¿™é‡Œçš„åŒºåˆ«åœ¨äºæ˜¯å°†æ‰€æœ‰çš„é…ç½®é›†ä¸­å­˜å‚¨åœ¨ä¸€ä¸ªä»£ç åº“ä¸­ï¼Œè¿˜æ˜¯å°†å®ƒä»¬åˆ†æ•£åœ¨å¤šä¸ªä»£ç åº“ä¸­ã€‚å•ä¸€ä»£ç åº“çš„ä¼˜ç‚¹æ˜¯é›†ä¸­ç®¡ç†å’Œä¸€è‡´æ€§ï¼Œè€Œå¤šä»£ç åº“çš„ä¼˜ç‚¹åˆ™æ˜¯æä¾›äº†æ›´é«˜çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå°¤å…¶æ˜¯åœ¨å¤§å‹æˆ–å¤æ‚çš„é¡¹ç›®ä¸­ã€‚

æ¯ç§ç­–ç•¥éƒ½æœ‰å…¶ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œé€‰æ‹©å“ªä¸€ç§å–å†³äºç»„ç»‡çš„éœ€æ±‚ã€å›¢é˜Ÿçš„å¤§å°ã€é¡¹ç›®çš„å¤æ‚æ€§ä»¥åŠå¯¹é£é™©ç®¡ç†çš„æ€åº¦ã€‚é€šå¸¸ï¼Œè¿™äº›ç­–ç•¥å¯èƒ½ä¼šç»“åˆä½¿ç”¨ï¼Œä»¥é€‚åº”ä¸åŒçš„é¡¹ç›®å’Œç»„ç»‡ç»“æ„ã€‚



### é…ç½®ç®¡ç†

ç¯å¢ƒçš„é…ç½®ç®¡ç†å¯ä»¥åˆ°æ¯ä¸€ä¸ªç¯å¢ƒä¸­åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰çš„åº”è¯¥éƒ¨ç½²çš„èµ„æºçš„ YAML æ¸…å•ï¼Œè¿™äº› YAML æ¸…å•ä¸­æ‰€æœ‰å€¼éƒ½å¯ä»¥ç¡¬ç¼–ç ä¸ºè¯¥ç¯å¢ƒæ‰€éœ€çš„ç‰¹å®šå€¼ã€‚

éœ€è¦è¿›è¡Œéƒ¨ç½²ï¼Œé‚£ä¹ˆè¿è¡Œï¼š

```bash
$ kubectl apply <directory>
```

ä¸€ä¸ª SaaS çš„åº”ç”¨ç¨‹åºå¼€å‘è€…å°†å…¶å®šåˆ¶çš„åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªç¯å¢ƒï¼ˆdev, test)

è¿™äº›ç¯å¢ƒå¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„è´¦æˆ·ï¼Œé›†ç¾¤æˆ–è€…å‘½åç©ºé—´ã€‚å®ƒä»¬ä¹‹é—´æœ‰ç»†å¾®çš„åŒºåˆ«ï¼Œå› æ­¤é…ç½®é‡ç”¨æ˜¯æœ€é‡è¦çš„ã€‚



### helm

helm ä½œä¸ºå‡ºåœºçš„ç¬¬ä¸€ä¸ªé…ç½®å·¥å…·ï¼Œæ˜¯ Kubernetes ç”Ÿæ€ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚

ä»¥ä¸‹æ˜¯Helmçš„ä¸»è¦ç‰¹ç‚¹å’Œå®ƒåœ¨Kubernetesç”Ÿæ€ä¸­çš„ä½œç”¨ï¼š

1. **åº”ç”¨ç¨‹åºåŒ…ç®¡ç†**ï¼šHelmå¯ä»¥è¢«çœ‹ä½œæ˜¯Kubernetesçš„åŒ…ç®¡ç†å™¨ã€‚å®ƒå…è®¸å¼€å‘è€…å’Œè¿ç»´äººå‘˜å°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–é¡¹æ‰“åŒ…æˆä¸€ä¸ªç§°ä¸º"chart"çš„å•å…ƒã€‚è¿™äº›chartæ˜¯é¢„é…ç½®çš„Kubernetesèµ„æºé›†åˆï¼Œå¯ä»¥åœ¨Kubernetesé›†ç¾¤ä¸Šè½»æ¾éƒ¨ç½²å’Œç®¡ç†ã€‚
2. **ç®€åŒ–å¤æ‚éƒ¨ç½²**ï¼šHelmä½¿å¾—éƒ¨ç½²å¤æ‚çš„åº”ç”¨ç¨‹åºå˜å¾—ç®€å•ã€‚å®ƒå¯ä»¥ç®¡ç†å¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰Kubernetesç»„ä»¶ä»¥æ­£ç¡®çš„é¡ºåºå’Œé…ç½®éƒ¨ç½²ã€‚è¿™å¯¹äºé‚£äº›éœ€è¦å¤šä¸ªæœåŠ¡å’Œé…ç½®çš„å¤§å‹åº”ç”¨ç¨‹åºæ¥è¯´å°¤å…¶é‡è¦ã€‚
3. **æ˜“äºç‰ˆæœ¬æ§åˆ¶å’Œå›æ»š**ï¼šHelm chartsæ˜“äºç‰ˆæœ¬æ§åˆ¶ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥è¿½è¸ªåˆ°æ¯æ¬¡éƒ¨ç½²çš„å˜åŒ–ï¼Œå¹¶åœ¨éœ€è¦æ—¶è½»æ¾åœ°å›æ»šåˆ°æ—§ç‰ˆæœ¬ã€‚
4. **å…±äº«å’Œé‡ç”¨**ï¼šé€šè¿‡Helmä»“åº“ï¼Œç”¨æˆ·å¯ä»¥å…±äº«ä»–ä»¬çš„chartsï¼Œä½¿å¾—é‡ç”¨é…ç½®å˜å¾—ç®€å•ã€‚è¿™ä¿ƒè¿›äº†æœ€ä½³å®è·µçš„å…±äº«å’Œç¤¾åŒºåä½œã€‚
5. **é…ç½®çµæ´»æ€§**ï¼šHelmå…è®¸ç”¨æˆ·è‡ªå®šä¹‰chartçš„é…ç½®ï¼Œä»¥é€‚åº”ä¸åŒçš„ç¯å¢ƒå’Œéœ€æ±‚ã€‚è¿™ç§çµæ´»æ€§æ˜¯é€šè¿‡ä½¿ç”¨æ¨¡æ¿å’Œé…ç½®æ–‡ä»¶å®ç°çš„ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥åœ¨éƒ¨ç½²æ—¶ä¿®æ”¹ã€‚
6. **é›†æˆå’Œæ‰©å±•æ€§**ï¼šHelmå¯ä»¥ä¸å…¶ä»–Kuberneteså·¥å…·å’Œæ’ä»¶æ— ç¼é›†æˆï¼Œå¢åŠ äº†å®ƒçš„æ‰©å±•æ€§ã€‚è¿™ä½¿å¾—å®ƒå¯ä»¥é€‚åº”å„ç§ä¸åŒçš„éƒ¨ç½²éœ€æ±‚å’Œç¯å¢ƒã€‚



### Jsonnet

Jsonnetï¼Œä½œä¸ºä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œä¸»è¦è¢«è®¾è®¡æ¥å¢å¼ºå’Œç®€åŒ–JSONæ•°æ®çš„å£°æ˜å’Œå¤„ç†ã€‚è™½ç„¶å®ƒå¹¶éä¸“é—¨ä¸ºKubernetesè®¾è®¡ï¼Œä½†åœ¨Kubernetesç¤¾åŒºä¸­ç¡®å®è·å¾—äº†å¹¿æ³›çš„åº”ç”¨å’Œæ™®åŠã€‚ä»¥ä¸‹æ˜¯Jsonnetçš„å…³é”®ç‰¹æ€§å’Œå®ƒåœ¨æ•°æ®å¤„ç†ä¸­çš„ä½œç”¨ï¼š

1. **å¢å¼ºçš„JSON**ï¼šJsonnetå¯ä»¥è¢«çœ‹ä½œæ˜¯JSONçš„ä¸€ä¸ªè¶…é›†ï¼Œå®ƒåœ¨JSONçš„åŸºç¡€ä¸Šæ·»åŠ äº†å˜é‡ã€æ¡ä»¶è¡¨è¾¾å¼ã€å‡½æ•°ã€ç®—æœ¯è¿ç®—å’Œå…¶ä»–ç¼–ç¨‹è¯­è¨€çš„ç‰¹æ€§ã€‚è¿™äº›æ‰©å±•ä½¿å¾—Jsonnetéå¸¸é€‚åˆå¤„ç†å¤æ‚çš„æ•°æ®æè¿°å’Œé…ç½®æ–‡ä»¶ã€‚
2. **æ¨¡æ¿å’ŒæŠ½è±¡**ï¼šJsonnetæ”¯æŒé«˜çº§åˆ«çš„æŠ½è±¡å’Œæ¨¡æ¿åŒ–ï¼Œè¿™å¯¹äºç®¡ç†å¤§é‡çš„ã€ç»“æ„ç›¸ä¼¼çš„æ•°æ®ç‰¹åˆ«æœ‰ç”¨ã€‚ç”¨æˆ·å¯ä»¥å®šä¹‰é€šç”¨çš„æ¨¡å¼å’Œç»“æ„ï¼Œç„¶ååœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­é‡å¤ä½¿ç”¨å®ƒä»¬ï¼Œå‡å°‘é‡å¤å’Œé”™è¯¯ã€‚
3. **çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§**ï¼šé€šè¿‡æä¾›å˜é‡å’Œå‡½æ•°ï¼ŒJsonnetä½¿å¾—æ•°æ®æ–‡ä»¶çš„ç»´æŠ¤å˜å¾—æ›´åŠ çµæ´»å’Œæ˜“äºç®¡ç†ã€‚è¿™å¯¹äºéœ€è¦é¢‘ç¹æ›´æ–°æˆ–ä¿®æ”¹çš„é…ç½®å°¤å…¶é‡è¦ã€‚
4. **æ¸…æ™°çš„é€»è¾‘ç»“æ„**ï¼šJsonnetçš„ç¼–ç¨‹è¯­è¨€ç‰¹æ€§å…è®¸ç”¨æˆ·ä»¥æ›´æ¸…æ™°ã€é€»è¾‘åŒ–çš„æ–¹å¼ç¼–å†™å’Œç†è§£å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œè¿™å¯¹äºå¤æ‚çš„é…ç½®ç®¡ç†æ¥è¯´æ˜¯ä¸€ä¸ªå·¨å¤§çš„ä¼˜åŠ¿ã€‚
5. **åœ¨Kubernetesä¸­çš„åº”ç”¨**ï¼šè™½ç„¶Jsonnetå¹¶éä¸“é—¨ä¸ºKubernetesè®¾è®¡ï¼Œä½†å®ƒåœ¨ç®¡ç†Kubernetesçš„é…ç½®æ–‡ä»¶æ–¹é¢æ˜¾ç¤ºå‡ºäº†å·¨å¤§çš„æ½œåŠ›ã€‚å®ƒå¯ä»¥ç”Ÿæˆå¤æ‚çš„Kubernetesèµ„æºå®šä¹‰ï¼Œå¦‚éƒ¨ç½²ã€æœåŠ¡å’Œpodé…ç½®ï¼Œå¹¶æ”¯æŒé«˜çº§çš„é…ç½®æ¨¡å¼ã€‚
6. **ç¤¾åŒºæ”¯æŒå’Œå·¥å…·é›†æˆ**ï¼šç”±äºJsonnetåœ¨Kubernetesç¤¾åŒºä¸­çš„æµè¡Œï¼Œè®¸å¤šå·¥å…·å’Œåº“å·²ç»å¼€å‘å‡ºæ¥æ”¯æŒJsonnetæ–‡ä»¶çš„ç”Ÿæˆå’Œç®¡ç†ã€‚è¿™è¿›ä¸€æ­¥å¢å¼ºäº†å®ƒåœ¨ç°ä»£äº‘åŸç”Ÿæ¶æ„ä¸­çš„åº”ç”¨ã€‚



## æµæ°´çº¿

CICD æµæ°´çº¿ä¸­çš„é˜¶æ®µ

æŒç»­é›†æˆ ï¼ˆCIï¼‰æ˜¯ä¸€ç§è½¯ä»¶å¼€å‘çš„å®è·µï¼Œåœ¨è¿™ç§å®è·µä¸­ï¼Œæ‰€æœ‰çš„å¼€å‘äººå‘˜éƒ½ä¼šåœ¨ä¸€ä¸ªä¸­å¤®ä»“åº“ï¼ˆGITï¼‰ä¸­åˆå¹¶å˜æ›´ï¼Œé€šè¿‡ CI ï¼Œæ¯ä¸€æ¬¡ä»£ç å˜æ›´ï¼ˆæäº¤ï¼‰éƒ½ä¼šè§¦å‘ç»™å®šä»“åº“çš„è‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•é˜¶æ®µï¼Œå¹¶å‘åšå‡ºå˜æ›´çš„å¼€å‘è€…æä¾›åé¦ˆã€‚ä¸ä¼ ç»Ÿçš„ CI ç›¸æ¯”ï¼ŒGitOps çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œåœ¨æ„å»ºå’Œæµ‹è¯•é˜¶æ®µæˆåŠŸå®Œæˆåï¼ŒCI æµæ°´çº¿è¿˜ä¼šåœ¨åº”ç”¨ç¨‹åºæ¸…å•ä¸­æ›´æ–°æ–°çš„é•œåƒç‰ˆæœ¬ã€‚

æŒç»­äº¤ä»˜ï¼ˆCDï¼‰ æ˜¯å°†æ•´ä¸ªè½¯ä»¶å‘å¸ƒè¿‡ç¨‹è‡ªåŠ¨åŒ–ã€‚

ä¸ä¼ ç»Ÿçš„ CICD ä¸åŒï¼Œä½¿ç”¨ GitOps Operator æ¥ç›‘æ§æ¸…å•çš„å˜åŒ–å¹¶åè°ƒéƒ¨ç½²ï¼Œåªè¦ CI æ„å»ºå®Œæˆï¼Œå¹¶ä¸”æ¸…å•æ›´æ–°ï¼ŒGitOps Operator å°±ä¼š

### æŒç»­é›†æˆ

**æ­¥éª¤å¦‚ä¸‹ï¼š**

æµç¨‹å°†ä»â€œæ‹‰å–è¯·æ±‚â€å¼€å§‹ï¼Œç»è¿‡å¤šä¸ªé˜¶æ®µï¼Œå¦‚â€œä»£ç å®¡æ ¸â€ã€â€œæ¼æ´æ‰«æâ€ã€â€œä»£ç åˆ†æâ€ã€â€œæ„å»ºâ€ã€â€œå•å…ƒæµ‹è¯•â€ã€â€œä»£ç è¦†ç›–â€ã€â€œDockeræ„å»ºâ€ã€â€œDockeræ¨é€â€ã€â€œGitå…‹éš†é…ç½®ä»“åº“â€ã€â€œæ›´æ–°é…ç½®æ¸…å•â€ã€â€œGitæäº¤å’Œæ¨é€â€ã€â€œå‘å¸ƒCIæŒ‡æ ‡â€ï¼Œæœ€ååˆ°è¾¾â€œæ„å»ºé€šçŸ¥â€ã€‚

![544991a1-6499-4de0-acef-bb43af85fdb3](http://sm.nsddd.top/sm202311261925321.webp)



é›†æˆ Go è¯­è¨€å’Œå…¶ä»–çš„ä¸€äº›å·¥å…·ï¼š

1. **GitHub Actions é›†æˆ**ï¼šåœ¨æµç¨‹å›¾ä¸­çš„å„ä¸ªé˜¶æ®µï¼Œå¦‚â€œä»£ç å®¡æ ¸â€ã€â€œæ¼æ´æ‰«æâ€ã€â€œä»£ç åˆ†æâ€ç­‰ï¼Œå¯ä»¥é€šè¿‡ GitHub Actions è‡ªåŠ¨åŒ–æ‰§è¡Œã€‚è¿™æ„å‘³ç€æ¯ä¸ªæ­¥éª¤å¯ä»¥è¢«é…ç½®ä¸º GitHub Actions çš„ä¸€ä¸ªå·¥ä½œæµï¼Œä»è€Œå®ç°è‡ªåŠ¨åŒ–å’Œæµç¨‹æ§åˆ¶ã€‚
2. **Go è¯­è¨€ç›¸å…³å·¥å…·**ï¼š
   + **ä»£ç å®¡æ ¸**ï¼šé›†æˆå¦‚ `golint` æˆ– `gometalinter` çš„ Go è¯­è¨€ä»£ç å®¡æŸ¥å·¥å…·ã€‚
   + **æ¼æ´æ‰«æ**ï¼šä½¿ç”¨é’ˆå¯¹ Go è¯­è¨€çš„æ¼æ´æ‰«æå·¥å…·ï¼Œå¦‚ `gosec`ã€‚
   + **ä»£ç åˆ†æ**ï¼šåº”ç”¨å¦‚ `staticcheck` çš„é™æ€åˆ†æå·¥å…·ã€‚
   + **å•å…ƒæµ‹è¯•**ï¼šåˆ©ç”¨ Go è‡ªå¸¦çš„æµ‹è¯•æ¡†æ¶å’Œ `go test` å‘½ä»¤ã€‚
   + **ä»£ç è¦†ç›–**ï¼šä½¿ç”¨ Go çš„ `cover` å·¥å…·æ¥æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡ã€‚
3. **Docker ä¸ Go**ï¼šåœ¨ Docker æ„å»ºé˜¶æ®µï¼Œå¯ä»¥ä½¿ç”¨é’ˆå¯¹ Go åº”ç”¨çš„ Dockerfileï¼Œç¡®ä¿åº”ç”¨è¢«æ­£ç¡®æ‰“åŒ…ã€‚
4. **é…ç½®ç®¡ç†**ï¼šå¯¹äºâ€œGit å…‹éš†é…ç½®ä»“åº“â€å’Œâ€œæ›´æ–°é…ç½®æ¸…å•â€é˜¶æ®µï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å¦‚ `Viper` æˆ– `Consul` ç­‰ Go è¯­è¨€é…ç½®ç®¡ç†å·¥å…·ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†å’Œç»´æŠ¤é…ç½®ã€‚

![chatp](http://sm.nsddd.top/sm202311261938086.png)



### æŒç»­äº¤ä»˜

æŒç»­é›†æˆåï¼Œå°±è¿›å…¥åˆ°æŒç»­äº¤ä»˜çš„ç¯èŠ‚äº†ï¼Œ

å»ºç«‹åœ¨ GitOps CICD åŸºç¡€ä¸Šçš„å®Œæ•´çš„ CD æµæ°´çº¿

1. **Git å…‹éš†é…ç½®ä»“åº“**ï¼šè¿™ä¸€æ­¥éª¤ä¿æŒä¸å˜ï¼Œä½œä¸ºé…ç½®ç®¡ç†çš„ä¸€éƒ¨åˆ†ã€‚
2. **å‘ç°æ¸…å•**ï¼šè¿™å¯èƒ½æ¶‰åŠè‡ªåŠ¨åŒ–è„šæœ¬æˆ–å·¥å…·ï¼Œç”¨äºæ£€æµ‹å’Œæ•´ç†åº”ç”¨çš„é…ç½®é¡¹å’Œä¾èµ–ã€‚
3. **kubectl apply**ï¼šåœ¨ Kubernetes ç¯å¢ƒä¸­åº”ç”¨é…ç½®æ›´æ”¹æˆ–éƒ¨ç½²æ–°çš„æœåŠ¡ã€‚
4. **åŠŸèƒ½æµ‹è¯•**ï¼šæ‰§è¡Œè‡ªåŠ¨åŒ–çš„åŠŸèƒ½æµ‹è¯•ï¼Œä»¥éªŒè¯åº”ç”¨çš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚
5. **è¿è¡Œæ—¶æ¼æ´æ‰«æ**ï¼šä½¿ç”¨é€‚åˆ Kubernetes ç¯å¢ƒçš„å·¥å…·æ¥æ£€æµ‹è¿è¡Œæ—¶çš„å®‰å…¨æ¼æ´ã€‚
6. **å‘å¸ƒ CD æŒ‡æ ‡**ï¼šæ”¶é›†å’Œå‘å¸ƒéƒ¨ç½²ç›¸å…³çš„æŒ‡æ ‡ï¼Œå¯èƒ½é€šè¿‡é›†æˆçš„ç›‘æ§å·¥å…·æˆ–å®šåˆ¶è„šæœ¬å®ç°ã€‚

![50629a41-bded-4f36-abfe-b3dfadd7c9d3](http://sm.nsddd.top/sm202311261945127.webp)



### æ¨åŠ¨æ™‹çº§å·¥ä½œ

æˆ‘ä»¬çŸ¥é“ï¼ŒKubernetes æ¸…å•å’Œä»£ç ä¸€èˆ¬ä¸æ”¾åœ¨åŒä¸€ä¸ªä»“åº“ï¼Œè¿™æ ·å¯ä»¥è·å–åˆ°æ›´çµæ´»çš„éƒ¨ç½²é€‰æ‹©ï¼Œæ›´å¥½çš„è®¿é—®æ§åˆ¶å’Œå®¡è®¡èƒ½åŠ›ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥åœ¨å“ªé‡Œç»´æŠ¤ç‰¹å®šçš„ç¯å¢ƒä¾èµ–çš„åº”ç”¨é…ç½®ï¼Œå¦‚æ•°æ®åº“é“¾æ¥å’Œåˆ†å¸ƒå¼ç¼“å­˜ã€‚

1. **å•ç‹¬çš„é…ç½®ä»“åº“**ï¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ä»“åº“æ¥å­˜å‚¨ç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶ã€‚è¿™ç§æ–¹æ³•å¯ä»¥æä¾›æ¸…æ™°çš„åˆ†ç¦»ï¼Œç¡®ä¿ä»£ç å’Œé…ç½®çš„ç‹¬ç«‹ç®¡ç†ï¼ŒåŒæ—¶ä¾¿äºè¿½è¸ªå’Œå®¡è®¡ã€‚
2. **é…ç½®ç®¡ç†å·¥å…·**ï¼šä½¿ç”¨é…ç½®ç®¡ç†å·¥å…·ï¼Œå¦‚ Helmã€Kustomize æˆ– Terraformï¼Œæ¥ç®¡ç†å’Œåº”ç”¨ä¸åŒç¯å¢ƒçš„é…ç½®ã€‚è¿™äº›å·¥å…·å¯ä»¥å¸®åŠ©ä½ æ ¹æ®ç¯å¢ƒå·®å¼‚ï¼ˆå¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰è°ƒæ•´é…ç½®ã€‚
3. **ç§˜å¯†ç®¡ç†**ï¼šå¯¹äºæ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ•°æ®åº“å¯†ç å’Œè®¿é—®å¯†é’¥ï¼‰ï¼Œä½¿ç”¨ Kubernetes çš„ç§˜å¯†ï¼ˆSecretsï¼‰ç®¡ç†åŠŸèƒ½æ¥å­˜å‚¨ã€‚è¿™äº›ç§˜å¯†å¯ä»¥åœ¨éƒ¨ç½²æ—¶åŠ¨æ€æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚
4. **é…ç½®æ˜ å°„ï¼ˆConfigMapsï¼‰**ï¼šå¯¹äºéæ•æ„Ÿçš„é…ç½®ä¿¡æ¯ï¼Œå¦‚æ•°æ®åº“é“¾æ¥å’Œåº”ç”¨å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ Kubernetes çš„ ConfigMap æ¥å­˜å‚¨ã€‚ConfigMap å¯ä»¥åœ¨å®¹å™¨å¯åŠ¨æ—¶ä½œä¸ºç¯å¢ƒå˜é‡æˆ–æŒ‚è½½çš„å·æä¾›ç»™åº”ç”¨ç¨‹åºã€‚
5. **ç¯å¢ƒå˜é‡**ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç›´æ¥åœ¨ Kubernetes çš„éƒ¨ç½²é…ç½®ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥ä¼ é€’é…ç½®ä¿¡æ¯æ˜¯æœ‰ç”¨çš„ã€‚è¿™ç§æ–¹æ³•é€‚ç”¨äºä¸éœ€è¦é¢‘ç¹æ›´æ”¹çš„ç®€å•é…ç½®ã€‚
6. **GitOps å®è·µ**ï¼šé‡‡ç”¨ GitOps çš„æ–¹å¼æ¥ç®¡ç† Kubernetes é…ç½®ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰é…ç½®æ›´æ”¹éƒ½é€šè¿‡ Git ä»“åº“æ¥è¿›è¡Œï¼Œé€šè¿‡è‡ªåŠ¨åŒ–æµç¨‹åº”ç”¨åˆ° Kubernetes ç¯å¢ƒä¸­ã€‚è¿™æœ‰åŠ©äºç¡®ä¿é…ç½®çš„ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§ã€‚

åœ¨ GitOps å®è·µä¸­ï¼Œ`git reset` å’Œ `git revert` æ˜¯ä¸¤ä¸ªé‡è¦çš„ Git å‘½ä»¤ï¼Œå®ƒä»¬ç”¨äºå¤„ç†é…ç½®å˜æ›´å’Œç»´æŠ¤å†å²è®°å½•ã€‚ç†è§£è¿™ä¸¤ä¸ªå‘½ä»¤çš„å·®å¼‚å’Œé€‚ç”¨åœºæ™¯å¯¹äºæœ‰æ•ˆåœ°ç®¡ç† Kubernetes é…ç½®è‡³å…³é‡è¦ã€‚

1. **git reset**ï¼š
   + `git reset` å‘½ä»¤ç”¨äºæ’¤é”€æŸäº›æäº¤ï¼Œå®ƒå¯ä»¥å°† HEAD æŒ‡é’ˆç§»åŠ¨åˆ°æŒ‡å®šçš„æäº¤ã€‚
   + åœ¨ GitOps ä¸­ï¼Œå¦‚æœä½ éœ€è¦æ’¤é”€ä¸€ç³»åˆ—æœ€è¿‘çš„æäº¤ï¼Œå¹¶å°†ä»“åº“çŠ¶æ€å›æ»šåˆ°ä»¥å‰çš„æŸä¸ªç‰¹å®šæäº¤ï¼Œå¯ä»¥ä½¿ç”¨ `git reset`ã€‚
   + éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`git reset` ä¼šæ›´æ”¹å†å²è®°å½•ï¼Œè¿™åœ¨å…±äº«ä»“åº“ä¸­å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚å…¶ä»–å¼€å‘è€…éœ€è¦ç”¨ `git pull --force` æ¥åŒæ­¥æ›´æ”¹ï¼Œè¿™å¯èƒ½å¯¼è‡´æ··ä¹±ã€‚
2. **git revert**ï¼š
   + `git revert` å‘½ä»¤ç”¨äºæ’¤é”€æŸä¸ªç‰¹å®šçš„æäº¤ï¼Œä½†å®ƒä¸ä¼šæ”¹å˜å†å²è®°å½•ã€‚ç›¸åï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤ï¼Œè¿™ä¸ªæ–°æäº¤çš„çŠ¶æ€ä¸è¦æ’¤é”€çš„æäº¤ç›¸åã€‚
   + åœ¨ GitOps ä¸­ï¼Œå¦‚æœéœ€è¦æ’¤é”€ä¸€ä¸ªç‰¹å®šçš„æ›´æ”¹ï¼ŒåŒæ—¶ä¿ç•™åç»­çš„æ›´æ”¹ï¼Œå¹¶ä¸”ä¸æƒ³ä¿®æ”¹å†å²è®°å½•ï¼Œ`git revert` æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚
   + `git revert` æ›´é€‚åˆå…¬å…±ä»“åº“æˆ–å›¢é˜Ÿç¯å¢ƒï¼Œå› ä¸ºå®ƒä¸ä¼šå½±å“å…¶ä»–å¼€å‘è€…çš„å†å²è®°å½•ã€‚

> æˆ‘çš„ä¸ªäººå¼€å‘ç»éªŒæ€»ç»“å‡ºæ¥çš„æ˜¯ï¼Œä¸ªäººä¸ä½¿ç”¨ `revert`ï¼Œè€Œæ˜¯ä½¿ç”¨ `reset` åœ¨æœ¬åœ°ï¼Œå‰ææ˜¯è‡ªå·±å¯¹è‡ªå·±æäº¤çš„æ ‘çŠ¶å›¾å¾ˆæ¸…æ™°ï¼Œä¸è¿‡ç”Ÿäº§ä¸­è¿˜æ˜¯ä½¿ç”¨ `revert`ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ä¿é™©å’Œå®‰è£…çš„åšæ³•ã€‚

è¿™å’Œ git rebase å’Œ git merge çš„ç†è§£ä¸€æ ·çš„ã€‚

**merge å’Œ rebase**
merge æ˜¯åˆå¹¶çš„æ„æ€ï¼Œrebaseæ˜¯å¤ä½åŸºåº•çš„æ„æ€ã€‚
ç°åœ¨æˆ‘ä»¬æœ‰è¿™æ ·çš„ä¸¤ä¸ªåˆ†æ”¯,testå’Œmasterï¼Œæäº¤å¦‚ä¸‹ï¼š

```
     D---E test
    /
A---B---C---F master
```

åœ¨masteræ‰§è¡Œ`git merge test`ç„¶åä¼šå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

```
     D--------E
    /          \
A---B---C---F---G    test , master
```

åœ¨masteræ‰§è¡Œ`git rebase test`,ç„¶åå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

```
 A---C---D---E---C `---F` test , master
```

å¯ä»¥çœ‹åˆ°mergeæ“ä½œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼Œä¹‹å‰æäº¤åˆ†å¼€æ˜¾ç¤ºã€‚è€Œrebaseæ“ä½œä¸ä¼šç”Ÿæˆæ–°çš„èŠ‚ç‚¹ï¼Œæ˜¯å°†ä¸¤ä¸ªåˆ†æ”¯èåˆæˆä¸€ä¸ªçº¿æ€§çš„æ“ä½œã€‚



## éƒ¨ç½²ç­–ç•¥

åœ¨ Kubernetes ä¸­ï¼Œä½ å¯ä»¥åªç”¨å¸¦æœ‰ PodSpec çš„æ¸…å•æ¥éƒ¨ç½²ä¸€ä¸ª Podï¼Œå¹¶ä¸”ä¿è¯å…¶å¯ç”¨æ€§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰ ReplocaSet æ¸…å•ï¼Œä»¥ä¿æŒåœ¨ä»»ä½•ç‰¹å®šæ—¶é—´è¿è¡Œä¸€ç»„ç¨³å®šçš„ Pod å‰¯æœ¬é›†åˆã€‚ReplicaSet æ˜¯é€šè¿‡æŒ‡å®šç”¨äºè¯†åˆ« Pod çš„é€‰æ‹©å™¨ã€‚

ReplicaSet ä¸æ˜¯å£°æ˜å¼çš„ï¼Œå› æ­¤ä¸é€‚åˆ GitOps 

æˆ‘æ²¡çŸ¥é“ Deployment æ˜¯ä¸€ä¸ªæ›´é«˜å±‚çš„æŠ½è±¡ï¼Œè™½ç„¶å¯ä»¥ä½¿ç”¨å¸¦æœ‰ `PodSpec` çš„æ¸…å•ç›´æ¥éƒ¨ç½²å•ä¸ª Podï¼Œä½†è¿™ç§æ–¹å¼é€šå¸¸ä¸é€‚ç”¨äºä¿è¯ Pod çš„å¯ç”¨æ€§å’Œå¯ç®¡ç†æ€§ã€‚



### ReplicaSet

+ **ä½œç”¨**ï¼š`ReplicaSet` çš„ä¸»è¦ç›®çš„æ˜¯ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬æ­£åœ¨è¿è¡Œã€‚
+ **é€‰æ‹©å™¨**ï¼šå®ƒé€šè¿‡ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨æ¥è¯†åˆ«è¦ç®¡ç†çš„ Podã€‚è¿™äº›æ ‡ç­¾åœ¨ Pod çš„å®šä¹‰ä¸­æŒ‡å®šã€‚
+ **ç¼ºç‚¹**ï¼šå°½ç®¡ `ReplicaSet` å¯ä»¥ç¡®ä¿æŒ‡å®šæ•°é‡çš„ Pod å®ä¾‹å§‹ç»ˆè¿è¡Œï¼Œä½†å®ƒæœ¬èº«å¹¶ä¸æ”¯æŒæ»šåŠ¨æ›´æ–°ã€‚å¦‚æœä½ éœ€è¦æ›´æ–° Pod çš„å®šä¹‰ï¼ˆä¾‹å¦‚ï¼Œæ›´æ–°ä½¿ç”¨çš„å®¹å™¨é•œåƒï¼‰ï¼Œå°±éœ€è¦æ‰‹åŠ¨æ›´æ–° `ReplicaSet`ï¼Œæˆ–è€…åˆ é™¤å¹¶é‡æ–°åˆ›å»ºå®ƒã€‚

### Deployment

+ **æ›´é«˜çº§çš„æŠ½è±¡**ï¼š`Deployment` æ˜¯ä¸€ä¸ªæ›´é«˜çº§åˆ«çš„æŠ½è±¡ï¼Œå®ƒåœ¨ `ReplicaSet` çš„åŸºç¡€ä¸Šæä¾›äº†æ›´å¤šåŠŸèƒ½ã€‚å®ƒä¸ä»…ç¡®ä¿ Pod æ•°é‡ï¼Œè¿˜æ”¯æŒå£°æ˜å¼åœ°æ›´æ–° Pod å’Œ `ReplicaSet`ã€‚
+ **æ»šåŠ¨æ›´æ–°**ï¼š`Deployment` æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œå…è®¸ä½ é€æ¸æ›¿æ¢æ—§ç‰ˆæœ¬çš„ Pod ä¸ºæ–°ç‰ˆæœ¬ï¼Œè€Œä¸ä¼šå¯¼è‡´åœæœºã€‚
+ **é€‚ç”¨äº GitOps**ï¼šç”±äºå…¶å£°æ˜å¼çš„ç‰¹æ€§ï¼Œ`Deployment` éå¸¸é€‚åˆ GitOps çš„å·¥ä½œæµã€‚ä½ å¯ä»¥åœ¨ Git ä»“åº“ä¸­å£°æ˜åº”ç”¨çš„æœŸæœ›çŠ¶æ€ï¼Œç„¶åä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ï¼ˆå¦‚ Argocd æˆ– Fluxï¼‰æ¥ç›‘è§†ä»“åº“å¹¶å°†æ›´æ”¹åº”ç”¨åˆ° Kubernetes é›†ç¾¤ã€‚

![gitops-deployment-replicaset](http://sm.nsddd.top/sm202311262010756.png)



###  æµé‡è·¯ç”± Traffic Routing

åœ¨Kubernetesä¸­ï¼ŒService æ˜¯ä¸€ç§æŠ½è±¡ï¼Œå®ƒå®šä¹‰äº†ä¸€ç»„é€»è¾‘çš„Podså’Œè®¿é—®å®ƒä»¬çš„ç­–ç•¥ã€‚æœåŠ¡æ‰€é’ˆå¯¹çš„è±† Pod targetedç”±ä»¥ä¸‹é€‰æ‹©å™¨ç¡®å®š

Service minifest ä¸­çš„å­—æ®µã€‚ç„¶åï¼ŒæœåŠ¡å°†æµé‡è½¬å‘åˆ°å¸¦æœ‰é€‰æ‹©å™¨æŒ‡å®šçš„åŒ¹é…æ ‡ç­¾çš„Podsã€‚å¦‚æœåº•å±‚çš„Podsæ˜¯æ— çŠ¶æ€å’Œå‘åå…¼å®¹çš„ï¼Œé‚£ä¹ˆServiceå¯ä»¥è¿›è¡Œå¾ªç¯è´Ÿè½½å¹³è¡¡ï¼Œå¹¶ä¸”éå¸¸é€‚åˆæ»šåŠ¨æ›´æ–°ã€‚å¦‚æœéœ€è¦ä¸ºéƒ¨ç½²å®šåˆ¶è´Ÿè½½å¹³è¡¡ï¼Œåˆ™éœ€è¦æ¢ç´¢å…¶ä»–è·¯ç”±æ›¿ä»£æ–¹æ¡ˆã€‚

å½“Serviceæ”¶åˆ°æµé‡æ—¶ï¼Œå®ƒä¼šæ ¹æ®å®šä¹‰çš„é€‰æ‹©å™¨å°†æµé‡è½¬å‘åˆ°æ‹¥æœ‰ç›¸åº”åŒ¹é…æ ‡ç­¾çš„Podsã€‚ä¾‹å¦‚ï¼Œå¦‚æœServiceçš„é€‰æ‹©å™¨è¢«è®¾ç½®ä¸ºåŒ¹é…æ ‡ç­¾â€œcolor: blueâ€ï¼Œé‚£ä¹ˆæ‰€æœ‰å¸¦æœ‰æ­¤æ ‡ç­¾çš„Podså°†æ¥æ”¶åˆ°ç”±è¯¥Serviceè½¬å‘çš„æµé‡ã€‚è¿™ç§æ–¹æ³•ä½¿å¾—æµé‡ç®¡ç†æ—¢çµæ´»åˆé«˜æ•ˆã€‚

#### æ— çŠ¶æ€Podså’Œè´Ÿè½½å¹³è¡¡

å¦‚æœåº•å±‚çš„Podsæ˜¯æ— çŠ¶æ€çš„ï¼ˆStatelessï¼‰å¹¶ä¸”ä¿æŒå‘åå…¼å®¹æ€§ï¼Œé‚£ä¹ˆServiceå¯ä»¥å®ç°æœ‰æ•ˆçš„å¾ªç¯è´Ÿè½½å¹³è¡¡ã€‚è¿™å¯¹äºå®æ–½æ»šåŠ¨æ›´æ–°å°¤ä¸ºé‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸åœ¨ä¸ä¸­æ–­æœåŠ¡çš„æƒ…å†µä¸‹é€æ­¥æ›¿æ¢æ—§çš„Podsã€‚

#### å®šåˆ¶è´Ÿè½½å¹³è¡¡ä¸è·¯ç”±ç­–ç•¥

å¯¹äºéœ€è¦æ›´å¤æ‚è·¯ç”±é€»è¾‘æˆ–å®šåˆ¶è´Ÿè½½å¹³è¡¡çš„éƒ¨ç½²ï¼Œå¯èƒ½éœ€è¦æ¢ç´¢Kubernetesæä¾›çš„å…¶ä»–è·¯ç”±æ›¿ä»£æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨Ingress Controllerså’ŒIngress Resourceså¯ä»¥æä¾›æ›´é«˜çº§çš„è·¯ç”±èƒ½åŠ›ï¼Œæ¯”å¦‚åŸºäºURLçš„è·¯ç”±ã€SSL/TLSç»ˆç«¯åŠ å¯†å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚

#### æ ‡ç­¾é©±åŠ¨çš„è·¯ç”±

Kubernetesä¸­çš„æœåŠ¡è·¯ç”±æ˜¯å®Œå…¨åŸºäºæ ‡ç­¾çš„ã€‚è¿™æ„å‘³ç€ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªæ ‡è®°ä¸ºâ€œblueâ€çš„Serviceåªä¼šå°†æµé‡è·¯ç”±åˆ°å¸¦æœ‰â€œblueâ€æ ‡ç­¾çš„Podsï¼Œè€Œä¸€ä¸ªæ ‡è®°ä¸ºâ€œgreenâ€çš„Serviceåˆ™åªè·¯ç”±åˆ°å¸¦æœ‰â€œgreenâ€æ ‡ç­¾çš„Podsã€‚è¿™ç§è®¾è®¡å…è®¸ç®€å•è€Œç›´è§‚çš„æµé‡åˆ†é…å’Œç®¡ç†ã€‚

![ingree-istio](http://sm.nsddd.top/sm202311262110507.png)

#### NGINX Ingress Controller

NGINX Ingress Controlleræ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œç”¨äºåœ¨Kubernetesç¯å¢ƒä¸­ç®¡ç†è¿›å…¥é›†ç¾¤çš„æµé‡ã€‚å®ƒæ”¯æŒå¤šç§è´Ÿè½½å¹³è¡¡å’Œè·¯ç”±è§„åˆ™ï¼Œé€‚ç”¨äºå¹¿æ³›çš„ç”¨ä¾‹ã€‚å…³é”®ç‰¹ç‚¹åŒ…æ‹¬ï¼š

+ **å‰ç«¯è´Ÿè½½å‡è¡¡å™¨**ï¼šå®ƒå¯ä»¥é…ç½®ä¸ºå‰ç«¯è´Ÿè½½å‡è¡¡å™¨ï¼Œè´Ÿè´£å¤„ç†è¿›å…¥é›†ç¾¤çš„æ‰€æœ‰æµé‡ã€‚
+ **è‡ªå®šä¹‰è·¯ç”±**ï¼šæ”¯æŒå„ç§è‡ªå®šä¹‰è·¯ç”±åŠŸèƒ½ï¼Œå¦‚TLSç»ˆç«¯åŠ å¯†ã€URLé‡å†™ï¼Œä»¥åŠåŸºäºè‡ªå®šä¹‰è§„åˆ™çš„æµé‡è·¯ç”±ã€‚
+ **æµé‡åˆ†é…**ï¼šå¯ä»¥é…ç½®è§„åˆ™æ¥åˆ†é…æµé‡ï¼Œä¾‹å¦‚å°†40%çš„æµé‡è·¯ç”±åˆ°å¸¦æœ‰ç‰¹å®šæ ‡ç­¾ï¼ˆå¦‚â€œblueâ€ï¼‰çš„æœåŠ¡ï¼Œè€Œ60%è·¯ç”±åˆ°å¦ä¸€ä¸ªæ ‡ç­¾ï¼ˆå¦‚â€œgreenâ€ï¼‰çš„æœåŠ¡ã€‚

é€šè¿‡è¿™äº›åŠŸèƒ½ï¼ŒNGINX Ingress Controllerèƒ½å¤Ÿæœ‰æ•ˆåœ°ç®¡ç†å’Œä¼˜åŒ–è¿›å…¥Kubernetesé›†ç¾¤çš„æµé‡ã€‚

#### Istio Gateway

Istio Gatewayæ˜¯å¦ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œç”¨äºåœ¨Kubernetesé›†ç¾¤çš„è¾¹ç¼˜ç®¡ç†æµé‡ã€‚å®ƒä¸»è¦è´Ÿè´£å¤„ç†è¿›å…¥å’Œç¦»å¼€é›†ç¾¤çš„HTTPå’ŒTCPè¿æ¥ã€‚Istio Gatewayçš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

+ **è¾¹ç¼˜è´Ÿè½½å¹³è¡¡å™¨**ï¼šä½œä¸ºé›†ç¾¤è¾¹ç¼˜çš„è´Ÿè½½å¹³è¡¡å™¨ï¼Œå®ƒå¤„ç†æ‰€æœ‰è¿›å…¥å’Œç¦»å¼€é›†ç¾¤çš„æµé‡ã€‚
+ **ç«¯å£å’Œåè®®è§„èŒƒ**ï¼šIstio Gatewayå…è®¸å®šä¹‰ä¸€ç»„è¦å…¬å¼€çš„ç«¯å£ï¼Œä»¥åŠç›¸å…³çš„åè®®ç±»å‹ï¼Œç¡®ä¿æµé‡æŒ‰ç…§æ—¢å®šçš„è§„åˆ™å’Œåè®®æµåŠ¨ã€‚
+ **é›†æˆä¸IstioæœåŠ¡ç½‘æ ¼**ï¼šä½œä¸ºIstioç”Ÿæ€ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä¸Istioçš„æœåŠ¡ç½‘æ ¼åŠŸèƒ½ç´§å¯†é›†æˆï¼Œæä¾›é«˜çº§çš„æµé‡ç®¡ç†å’Œå®‰å…¨æ€§åŠŸèƒ½ã€‚

![istio-ingress](http://sm.nsddd.top/sm202311262115919.png)

> è¯´æ˜é€šè¿‡Kubernetesä¸­çš„Ingressæ§åˆ¶å™¨çš„æµé‡æµå’ŒIstioæœåŠ¡ç½‘æ ¼ä¸­çš„æµé‡æµçš„å›¾è¡¨å·²ç»å‡†å¤‡å¥½äº†ã€‚è¿™äº›å›¾è¡¨æ¸…æ™°åœ°æ¯”è¾ƒäº†æ¯ä¸ªç³»ç»Ÿåœ¨Kubernetesç¯å¢ƒä¸­å¦‚ä½•å¤„ç†æµé‡è·¯ç”±å’Œç®¡ç†ï¼ŒåŒ…æ‹¬å…¥å£æ§åˆ¶å™¨å’ŒIstioç½‘å…³çš„è§’è‰²ã€‚



### Argo Rollouts

#### ä»€ä¹ˆæ˜¯Argo Rolloutsï¼Ÿ

Argo Rollouts æ˜¯ä¸€ä¸ªKubernetesæ§åˆ¶å™¨ï¼Œç”¨äºæ›´å¤æ‚ã€æ›´å¼ºå¤§çš„éƒ¨ç½²ç­–ç•¥ï¼Œå¦‚è“ç»¿éƒ¨ç½²ï¼ˆBlue-Green Deploymentsï¼‰å’Œé‡‘ä¸é›€éƒ¨ç½²ï¼ˆCanary Deploymentsï¼‰ã€‚å®ƒé€šè¿‡æ‰©å±•Kubernetesè‡ªèº«çš„éƒ¨ç½²èƒ½åŠ›ï¼Œä½¿å¾—åœ¨ä¸ä¸­æ–­æœåŠ¡çš„æƒ…å†µä¸‹æ›´æ–°å’Œç®¡ç†åº”ç”¨ç¨‹åºå˜å¾—æ›´åŠ å®¹æ˜“ã€‚

#### å®‰è£… & ä½¿ç”¨ Argo Rollouts

1. **å…ˆå†³æ¡ä»¶**ï¼š

   + ç¡®ä¿æ‚¨æœ‰ä¸€ä¸ªè¿è¡Œä¸­çš„ Kubernetes é›†ç¾¤ã€‚
   + æ‚¨éœ€è¦æœ‰è¶³å¤Ÿçš„æƒé™æ¥éƒ¨ç½²æ–°çš„ Kubernetes èµ„æºã€‚

2. **å®‰è£…å‘½ä»¤**ï¼š

   + Argo Rollouts å¯ä»¥é€šè¿‡å…¶ Helm å›¾è¡¨æˆ–ä½¿ç”¨ kubectl ç›´æ¥ä»å…¶ GitHub ä»“åº“å®‰è£…ã€‚

   + ä½¿ç”¨ Helm å®‰è£…ï¼ˆå¦‚æœæ‚¨ä½¿ç”¨ Helmï¼‰:

     ```bash
     helm repo add argo https://argoproj.github.io/argo-helm
     helm install argo-rollouts argo/argo-rollouts
     ```

   + æˆ–è€…ï¼Œä½¿ç”¨ kubectl ä»å…¶ GitHub ä»“åº“å®‰è£…ï¼š

     ```bash
     kubectl create namespace argo-rollouts
     kubectl apply -n argo-rollouts -f https://raw.githubusercontent.com/argoproj/argo-rollouts/stable/manifests/install.yaml
     ```

### å®šä¹‰ Rollout èµ„æº

1. **åˆ›å»º Rollout èµ„æºå®šä¹‰**ï¼š

   + Rollout èµ„æºç±»ä¼¼äº Kubernetes çš„ Deployment èµ„æºï¼Œä½†å®ƒåŒ…å«é¢å¤–çš„å­—æ®µæ¥æŒ‡å®šéƒ¨ç½²ç­–ç•¥ï¼ˆä¾‹å¦‚é‡‘ä¸é›€æˆ–è“ç»¿éƒ¨ç½²ï¼‰ã€‚
   + åˆ›å»ºä¸€ä¸ª YAML æ–‡ä»¶ï¼Œå®šä¹‰æ‚¨çš„ Rolloutï¼ŒåŒ…æ‹¬é•œåƒã€å‰¯æœ¬æ•°ã€æ›´æ–°ç­–ç•¥ç­‰ã€‚

2. **ç¤ºä¾‹ Rollout å®šä¹‰**ï¼š

   ```yaml
   apiVersion: argoproj.io/v1alpha1
   kind: Rollout
   metadata:
     name: example-rollout
   spec:
     replicas: 3
     selector:
       matchLabels:
         app: example
     template:
       metadata:
         labels:
           app: example
       spec:
         containers:
         - name: app
           image: your-image:latest
           ports:
           - containerPort: 8080
     strategy:
       canary: 
         steps:
         - setWeight: 20
         - pause: {duration: 1h}
   ```

### è§¦å‘å’Œç®¡ç†éƒ¨ç½²

1. **åº”ç”¨ Rollout èµ„æº**ï¼š

   + ä½¿ç”¨ kubectl åº”ç”¨æ‚¨çš„ Rollout å®šä¹‰ï¼š

     ```bash
     kubectl apply -f your-rollout-definition.yaml
     ```

2. **ç›‘æ§ Rollout çŠ¶æ€**ï¼š

   + ä½¿ç”¨ kubectl æ£€æŸ¥ Rollout çŠ¶æ€ï¼š

     ```bash
     kubectl argo rollouts get rollout example-rollout --watch
     ```

3. **ç®¡ç† Rollout**ï¼š

   + å¯ä»¥é€šè¿‡æ›´æ–° Rollout èµ„æºçš„å®šä¹‰ï¼ˆä¾‹å¦‚ï¼Œæ›´æ”¹é•œåƒæ ‡ç­¾ï¼‰æ¥è§¦å‘æ–°çš„éƒ¨ç½²ã€‚
   + ä½¿ç”¨ Argo Rollouts çš„ CLI å·¥å…·ï¼Œæ‚¨å¯ä»¥ç®¡ç† Rollout çš„æš‚åœã€æ¢å¤å’Œä¸­æ­¢ç­‰æ“ä½œã€‚

#### Argo Rolloutsçš„æ ¸å¿ƒåŠŸèƒ½

+ **é«˜çº§éƒ¨ç½²ç­–ç•¥**ï¼šæ”¯æŒè“ç»¿éƒ¨ç½²å’Œé‡‘ä¸é›€éƒ¨ç½²ç­‰ã€‚
+ **è‡ªåŠ¨åŒ–å›æ»š**ï¼šå¦‚æœæ–°ç‰ˆæœ¬å‡ºç°é—®é¢˜ï¼Œå®ƒèƒ½è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ã€‚
+ **æƒé‡å¼æµé‡åˆ†é…**ï¼šå¯ä»¥æ§åˆ¶æ–°ç‰ˆæœ¬å’Œæ—§ç‰ˆæœ¬ä¹‹é—´çš„æµé‡åˆ†é…æ¯”ä¾‹ã€‚
+ **é›†æˆåº¦é«˜**ï¼šä¸Istioã€NGINX Ingressç­‰æœåŠ¡ç½‘æ ¼å’ŒIngressæ§åˆ¶å™¨ç´§å¯†é›†æˆã€‚

1. **è“ç»¿éƒ¨ç½²**ï¼š
   + é¦–å…ˆï¼Œæ‚¨éƒ¨ç½²äº†æ–°ç‰ˆæœ¬ï¼ˆç»¿è‰²ç‰ˆæœ¬ï¼‰è€Œä¸ä¼šå½±å“åˆ°å½“å‰è¿è¡Œçš„æ—§ç‰ˆæœ¬ï¼ˆè“è‰²ç‰ˆæœ¬ï¼‰ã€‚
   + ä¸€æ—¦ç»¿è‰²ç‰ˆæœ¬å°±ç»ªå¹¶ä¸”ç»è¿‡äº†æµ‹è¯•éªŒè¯å…¶ç¨³å®šæ€§ï¼Œæµé‡å°†ä»è“è‰²ç‰ˆæœ¬å¹³æ»‘è½¬ç§»åˆ°ç»¿è‰²ç‰ˆæœ¬ã€‚
   + å¦‚æœç»¿è‰²ç‰ˆæœ¬è¿è¡Œè‰¯å¥½ï¼Œåˆ™å®Œæˆéƒ¨ç½²ï¼›å¦‚æœæœ‰é—®é¢˜ï¼Œåˆ™å¯ä»¥ç«‹å³åˆ‡æ¢å›è“è‰²ç‰ˆæœ¬ã€‚
2. **é‡‘ä¸é›€éƒ¨ç½²**ï¼š
   + åœ¨è¿™ç§ç­–ç•¥ä¸­ï¼Œæ‚¨ä¼šé€æ¸å‘æ–°ç‰ˆæœ¬ï¼ˆé‡‘ä¸é›€ç‰ˆæœ¬ï¼‰å¼•å…¥ä¸€å°éƒ¨åˆ†ç”¨æˆ·æµé‡ã€‚
   + åˆå§‹é˜¶æ®µï¼Œåªæœ‰å°‘é‡çš„æµé‡è¢«è·¯ç”±åˆ°æ–°ç‰ˆæœ¬ï¼ŒåŒæ—¶ç›‘æ§å…¶æ€§èƒ½å’Œç¨³å®šæ€§ã€‚
   + å¦‚æœæ–°ç‰ˆæœ¬è¡¨ç°è‰¯å¥½ï¼Œæ‚¨å¯ä»¥é€æ¸å¢åŠ æµé‡æ¯”ä¾‹ï¼Œç›´åˆ°å…¨éƒ¨æµé‡éƒ½è½¬ç§»åˆ°æ–°ç‰ˆæœ¬ã€‚
   + å¦‚æœæ–°ç‰ˆæœ¬å‡ºç°é—®é¢˜ï¼Œå¯ä»¥ç«‹å³åœæ­¢æµé‡çš„è½¬ç§»ï¼Œå¹¶å°†å…¶è·¯ç”±å›æ—§ç‰ˆæœ¬ã€‚



### è“ç»¿å‘å¸ƒ

æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œæ”¯æŒå£°æ˜å¼çš„ Deployment çš„æ»šåŠ¨æ›´æ–°æ˜¯æ›´æ–°åº”ç”¨çš„ç»ä½³æ–¹å¼ï¼Œå› ä¸ºä½ çš„åº”ç”¨åœ¨éƒ¨ç½²æœŸé—´å°†ä½¿ç”¨å¤§è‡´ç›¸åŒæ•°é‡çš„èµ„æºï¼Œä¸”åœæœºæ—¶é—´ä¸ºé›¶ï¼Œå¯¹æ€§èƒ½çš„å½±å“æœ€å°ã€‚ç„¶è€Œï¼Œç”±äºå‘åä¸å…¼å®¹æ€§æˆ–æœ‰çŠ¶æ€æ€§ï¼Œæœ‰è®¸å¤šé—ç•™åº”ç”¨ç¨‹åºä¸èƒ½å¾ˆå¥½åœ°ä¸æ»šåŠ¨æ›´æ–°ä¸€èµ·å·¥ä½œã€‚æœ‰äº›åº”ç”¨ç¨‹åºå¯èƒ½è¿˜éœ€è¦éƒ¨ç½²æ–°ç‰ˆæœ¬å¹¶ç«‹å³åˆ‡æ¢åˆ°è¯¥ç‰ˆæœ¬ï¼Œæˆ–è€…åœ¨å‡ºç°é—®é¢˜æ—¶å¿«é€Ÿå›æ»šã€‚å¯¹äºè¿™äº›ç”¨ä¾‹ï¼Œè“ç»¿è‰²éƒ¨ç½²å°†æ˜¯é€‚å½“çš„éƒ¨ç½²ç­–ç•¥ã€‚è“ç»¿éƒ¨ç½²é€šè¿‡è®©ä¸¤ä¸ªéƒ¨ç½²åŒæ—¶å®Œå…¨æ‰©å±•ï¼Œä½†åªå°†ä¼ å…¥æµé‡å®šå‘åˆ°ä¸¤ä¸ªéƒ¨ç½²ä¸­çš„ä¸€ä¸ªæ¥å®ç°è¿™äº›ã€‚

> è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Nginx Ingress æ§åˆ¶å™¨å°† 100% çš„æµé‡è·¯ç”±åˆ° blue æˆ–è€… green deploymentï¼Œå› ä¸ºå†…ç½®çš„ kubernetes service åªæ”¯æŒ iptablesï¼Œå¹¶ä¸é‡ç½®ä¸ pod çš„ç°æœ‰é“¾æ¥ï¼Œå› æ­¤ä¸é€‚åˆè“ç»¿å‘å¸ƒã€‚

åœ¨ Kubernetes ç¯å¢ƒä¸­ï¼Œè™½ç„¶å£°æ˜å¼çš„ Deployment é€šè¿‡æ»šåŠ¨æ›´æ–°ï¼ˆRolling Updateï¼‰æä¾›äº†é›¶åœæœºæ—¶é—´å’Œæœ€å°åŒ–å¯¹æ€§èƒ½çš„å½±å“ï¼Œä½†ç¡®å®å­˜åœ¨æŸäº›æƒ…å†µå’Œåº”ç”¨ç¨‹åºç±»å‹ï¼Œå…¶ä¸­è¿™ç§æ–¹æ³•å¯èƒ½ä¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚ç‰¹åˆ«æ˜¯å¯¹äºé‚£äº›æœ‰çŠ¶æ€æ€§ï¼ˆStatefulï¼‰åº”ç”¨æˆ–å› å‘åä¸å…¼å®¹æ€§è€Œéš¾ä»¥è¿›è¡Œæ»šåŠ¨æ›´æ–°çš„é—ç•™åº”ç”¨ç¨‹åºï¼Œè“ç»¿éƒ¨ç½²ï¼ˆBlue-Green Deploymentï¼‰å¯èƒ½æ›´é€‚åˆã€‚



### Iptable

Iptables æ˜¯ Linux ä¸Šä¸€ç§å¼ºå¤§çš„é˜²ç«å¢™å·¥å…·ï¼Œç”¨äºæ§åˆ¶è¿›å‡º Linux ç³»ç»Ÿçš„ç½‘ç»œæµé‡ã€‚å®ƒæ˜¯åŸºäº Netfilter æä¾›çš„ç½‘ç»œåŒ…è¿‡æ»¤æ¡†æ¶ï¼Œå…è®¸ç³»ç»Ÿç®¡ç†å‘˜é…ç½®è§„åˆ™é›†ï¼Œä»¥è¿‡æ»¤æµé‡å¹¶æä¾› NAT åŠŸèƒ½ã€‚

#### ä¸»è¦ç‰¹ç‚¹å’ŒåŠŸèƒ½

1. **åŒ…è¿‡æ»¤**ï¼š
   + Iptables å¯ä»¥è¿‡æ»¤è¿›å‡ºç³»ç»Ÿçš„æ•°æ®åŒ…ï¼ŒåŒ…æ‹¬æºåœ°å€ã€ç›®çš„åœ°å€ã€ä¼ è¾“åè®®ç­‰ã€‚
   + å®ƒå¯ä»¥æ¥å—ã€æ‹’ç»æˆ–ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œæ ¹æ®å®šä¹‰çš„è§„åˆ™å¯¹ç½‘ç»œæµé‡è¿›è¡Œç²¾ç¡®æ§åˆ¶ã€‚
2. **é“¾å’Œè¡¨**ï¼š
   + Iptables ä½¿ç”¨é“¾ï¼ˆChainsï¼‰å’Œè¡¨ï¼ˆTablesï¼‰æ¥ç»„ç»‡è§„åˆ™ã€‚
   + å¸¸è§çš„é“¾æœ‰ INPUTã€OUTPUT å’Œ FORWARDï¼Œåˆ†åˆ«æ§åˆ¶è¿›å…¥ç³»ç»Ÿã€ç¦»å¼€ç³»ç»Ÿå’Œç©¿è¿‡ç³»ç»Ÿçš„æµé‡ã€‚
   + è¡¨å¦‚ `filter`ã€`nat` å’Œ `mangle` è¡¨ç”¨äºä¸åŒç±»å‹çš„æµé‡å¤„ç†ã€‚
3. **NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰**ï¼š
   + `Iptables` æ”¯æŒ NAT åŠŸèƒ½ï¼ŒåŒ…æ‹¬æºåœ°å€è½¬æ¢ï¼ˆSNATï¼‰å’Œç›®çš„åœ°å€è½¬æ¢ï¼ˆDNATï¼‰ã€‚
   + è¿™å¯¹äºè·¯ç”±å’Œè½¬å‘æµé‡è‡³å†…éƒ¨ç½‘ç»œä¸­çš„ç§æœ‰åœ°å€éå¸¸é‡è¦ã€‚
4. **çŠ¶æ€è·Ÿè¸ª**ï¼š
   + Iptables èƒ½å¤Ÿè·Ÿè¸ªç½‘ç»œè¿æ¥çš„çŠ¶æ€ï¼Œå¦‚æ–°å»ºã€å·²å»ºç«‹ã€ç›¸å…³è”å’Œæ— æ•ˆè¿æ¥ã€‚
   + è¿™å…è®¸åŸºäºè¿æ¥çŠ¶æ€åº”ç”¨è§„åˆ™ï¼Œæé«˜è¿‡æ»¤çš„çµæ´»æ€§å’Œæ•ˆæœã€‚

#### åº”ç”¨åœºæ™¯

1. **å®‰å…¨é˜²æŠ¤**ï¼š
   + åœ¨æœåŠ¡å™¨å’Œç½‘ç»œè®¾å¤‡ä¸Šå®æ–½é˜²ç«å¢™è§„åˆ™ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®å’Œæ”»å‡»ã€‚
2. **æµé‡ç®¡ç†**ï¼š
   + ç®¡ç†å’Œé™åˆ¶ç‰¹å®šç±»å‹çš„æµé‡ï¼Œä¼˜åŒ–ç½‘ç»œä½¿ç”¨ã€‚
3. **ç½‘ç»œè°ƒè¯•**ï¼š
   + è·Ÿè¸ªå’Œç›‘æ§ç½‘ç»œæµé‡ï¼Œå¸®åŠ©è¯Šæ–­ç½‘ç»œé—®é¢˜ã€‚

#### ä½¿ç”¨ç¤ºä¾‹

+ é˜»æ­¢æ¥è‡ªç‰¹å®š IP åœ°å€çš„æµé‡ï¼š

  ```bash
  iptables -A INPUT -s 123.456.789.0 -j DROP
  ```

+ å…è®¸ç‰¹å®šç«¯å£çš„æµé‡ï¼š

  ```bash
  iptables -A INPUT -p tcp --dport 22 -j ACCEPT
  ```

Iptables çš„çµæ´»æ€§å’Œå¼ºå¤§åŠŸèƒ½ä½¿å…¶æˆä¸º Linux ç³»ç»Ÿä¸­ç®¡ç†ç½‘ç»œæµé‡å’Œå®æ–½å®‰å…¨ç­–ç•¥çš„å…³é”®å·¥å…·ã€‚ç„¶è€Œï¼Œç”±äºå…¶å¤æ‚æ€§ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è°¨æ…ä½¿ç”¨ï¼Œå¹¶ä¸”åœ¨åº”ç”¨ä»»ä½•è§„åˆ™ä¹‹å‰è¿›è¡Œå……åˆ†çš„æµ‹è¯•ã€‚



### è“ç»¿éƒ¨ç½²çš„å·¥ä½œåŸç†

è“ç»¿éƒ¨ç½²çš„æ ¸å¿ƒæ€æƒ³æ˜¯åŒæ—¶ç»´æŠ¤ä¸¤ä¸ªç”Ÿäº§ç¯å¢ƒï¼ˆæˆ–éƒ¨ç½²ï¼‰çš„å®Œå…¨ä¸åŒç‰ˆæœ¬ï¼šä¸€ä¸ªè“è‰²ï¼ˆBlueï¼‰ç‰ˆæœ¬å’Œä¸€ä¸ªç»¿è‰²ï¼ˆGreenï¼‰ç‰ˆæœ¬ã€‚

+ **è“è‰²éƒ¨ç½²**ï¼šå½“å‰è¿è¡Œçš„æ—§ç‰ˆæœ¬ã€‚
+ **ç»¿è‰²éƒ¨ç½²**ï¼šæ–°ç‰ˆæœ¬ï¼Œä¸è“è‰²éƒ¨ç½²ç›¸åŒä½†åŒ…å«æ›´æ–°ã€‚

è¿™ä¸¤ä¸ªéƒ¨ç½²éƒ½ä¼šå®Œå…¨æ‰©å±•ï¼Œä½†åœ¨ä»»ä½•æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªéƒ¨ç½²ï¼ˆè“è‰²æˆ–ç»¿è‰²ï¼‰ä¼šæ¥æ”¶åˆ°æ‰€æœ‰ä¼ å…¥æµé‡ã€‚



### ä½¿ç”¨ Nginx Ingress æ§åˆ¶å™¨å®ç°è“ç»¿éƒ¨ç½²

1. **æµé‡è·¯ç”±**ï¼š

   + åœ¨è“ç»¿éƒ¨ç½²ä¸­ï¼ŒNginx Ingress æ§åˆ¶å™¨å¯ä»¥ç”¨äºå°†100%çš„æµé‡è·¯ç”±åˆ°è“è‰²æˆ–ç»¿è‰²éƒ¨ç½²ã€‚æˆ–è€…æ˜¯å°†éƒ¨åˆ†çš„æµé‡è·¯ç”±åˆ°è“è‰²éƒ¨ç½²ï¼Œéƒ¨åˆ†çš„æµé‡è·¯ç”±åˆ°ç»¿è‰²éƒ¨ç½²ã€‚

     > å“ˆå“ˆå“ˆä½†æ˜¯è¿™æ ·è²Œä¼¼å°±ä¸æ˜¯è“ç»¿éƒ¨ç½²äº†ï¼Œæœ‰ç‚¹åƒæ˜¯é‡‘ä¸é›€éƒ¨ç½²ï¼š
     >
     > å¦‚æœæ‚¨çš„éœ€æ±‚æ˜¯åŒæ—¶å‘è“è‰²å’Œç»¿è‰²éƒ¨ç½²åˆ†é…æµé‡ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½éœ€è¦è€ƒè™‘ä½¿ç”¨é‡‘ä¸é›€éƒ¨ç½²ï¼ˆCanary Deploymentï¼‰ã€‚åœ¨é‡‘ä¸é›€éƒ¨ç½²ä¸­ï¼Œæ–°ç‰ˆæœ¬ï¼ˆé‡‘ä¸é›€ï¼‰æœ€åˆåªæ¥æ”¶ä¸€å°éƒ¨åˆ†æµé‡ï¼Œè€Œä¸»è¦æµé‡ä»ç„¶è·¯ç”±åˆ°æ—§ç‰ˆæœ¬ã€‚æ ¹æ®æ–°ç‰ˆæœ¬çš„æ€§èƒ½å’Œç¨³å®šæ€§ï¼Œé€æ¸å¢åŠ æµå‘æ–°ç‰ˆæœ¬çš„æµé‡æ¯”ä¾‹ã€‚

   + è¿™æ˜¯é€šè¿‡æ›´æ–° Ingress èµ„æºæ¥å®ç°çš„ï¼Œè¯¥èµ„æºå†³å®šäº†å“ªä¸ªæœåŠ¡ï¼ˆè“è‰²è¿˜æ˜¯ç»¿è‰²ï¼‰å°†æ¥æ”¶æµé‡ã€‚

2. **Kubernetes Service çš„å±€é™æ€§**ï¼š

   + Kubernetes Service åŸºäº iptables å®ç°ï¼Œä¸ä¼šé‡ç½®ä¸Podçš„ç°æœ‰è¿æ¥ã€‚
   + è¿™æ„å‘³ç€åœ¨è¿›è¡Œç‰ˆæœ¬åˆ‡æ¢æ—¶ï¼Œä¸€äº›ç°æœ‰çš„è¿æ¥å¯èƒ½ä»ç„¶æŒ‡å‘æ—§ç‰ˆæœ¬çš„Podï¼Œè¿™å¯¹äºéœ€è¦ç«‹å³åˆ‡æ¢å’Œå¿«é€Ÿå›æ»šçš„åº”ç”¨ä¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚
   + å› æ­¤ï¼Œå¯¹äºè“ç»¿éƒ¨ç½²ï¼Œä½¿ç”¨åƒ Nginx è¿™æ ·çš„ Ingress æ§åˆ¶å™¨å¯ä»¥æ›´å¥½åœ°ç®¡ç†æµé‡åˆ‡æ¢ï¼Œå› ä¸ºå®ƒèƒ½æ›´ç²¾ç¡®åœ°æ§åˆ¶æµé‡çš„è·¯ç”±ã€‚



### ä½¿ç”¨ Deployment å®ç°è“ç»¿éƒ¨ç½²

![deployment-blue-green](http://sm.nsddd.top/sm202311270932090.png)

> The diagram illustrating the concept of Blue-Green Deployment in a Kubernetes environment using NGINX Ingress and Deployments is ready. It visually explains how traffic is directed to either the Blue or Green Deployments, showcasing the clear separation and traffic management between these two deployments.

è¦ä½¿ç”¨ Ingress å®ç° Kubernetes ä¸­çš„è“ç»¿éƒ¨ç½²ï¼Œæ‚¨éœ€è¦å‡†å¤‡ä¸¤å¥—å®Œå…¨ä¸€æ ·ä½†ä¸åŒç‰ˆæœ¬çš„åº”ç”¨éƒ¨ç½²ï¼ˆDeploymentï¼‰ï¼Œä¸€ä¸ª Ingress æ§åˆ¶å™¨ï¼ˆä¾‹å¦‚ NGINXï¼‰ï¼Œä»¥åŠä¸€ä¸ª Ingress èµ„æºæ¥æ§åˆ¶æµé‡çš„è·¯ç”±ã€‚ä»¥ä¸‹æ˜¯å®ç°è¿™ä¸€ç­–ç•¥çš„æ­¥éª¤å’Œç¤ºä¾‹ä»£ç ã€‚

### è®¾è®¡æ–¹æ¡ˆ

1. **å‡†å¤‡ä¸¤ä¸ª Deployment**ï¼š
   + ä¸€ä¸ªâ€œè“è‰²â€Deploymentï¼Œè¿è¡Œå½“å‰ç‰ˆæœ¬çš„åº”ç”¨ã€‚
   + ä¸€ä¸ªâ€œç»¿è‰²â€Deploymentï¼Œè¿è¡Œæ–°ç‰ˆæœ¬çš„åº”ç”¨ã€‚
2. **é…ç½® Service**ï¼š
   + ä¸ºæ¯ä¸ª Deployment åˆ›å»ºä¸€ä¸ª Serviceã€‚è¿™äº› Service å°†ä½œä¸ºæµé‡çš„å…¥å£ç‚¹ã€‚
3. **è®¾ç½® Ingress æ§åˆ¶å™¨**ï¼š
   + ç¡®ä¿æ‚¨çš„ Kubernetes é›†ç¾¤ä¸­å·²å®‰è£…å¹¶è¿è¡Œäº† Ingress æ§åˆ¶å™¨ï¼Œä¾‹å¦‚ NGINXã€‚
4. **ç¼–å†™ Ingress èµ„æº**ï¼š
   + åˆ›å»ºä¸€ä¸ª Ingress èµ„æºæ¥å®šä¹‰æµé‡è·¯ç”±è§„åˆ™ã€‚å¼€å§‹æ—¶ï¼Œå°†æ‰€æœ‰æµé‡è·¯ç”±åˆ°è“è‰² Deploymentã€‚
   + å½“å‡†å¤‡å°†æµé‡åˆ‡æ¢åˆ°ç»¿è‰² Deployment æ—¶ï¼Œæ›´æ–° Ingress èµ„æºã€‚
5. **ç›‘æ§å’Œåˆ‡æ¢**ï¼š
   + åœ¨åˆ‡æ¢æµé‡ä¹‹å‰ï¼Œç¡®ä¿ç»¿è‰² Deployment å®Œå…¨å°±ç»ªä¸”æµ‹è¯•æ— è¯¯ã€‚
   + é€šè¿‡æ›´æ–° Ingress è§„åˆ™ï¼Œå°†æµé‡ä»è“è‰²åˆ‡æ¢åˆ°ç»¿è‰² Deploymentã€‚
   + å¦‚æœæ–°ç‰ˆæœ¬è¿è¡Œæ­£å¸¸ï¼Œç»§ç»­å°†æµé‡è·¯ç”±åˆ°ç»¿è‰² Deploymentï¼›å¦‚æœæœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿåˆ‡å›è“è‰² Deploymentã€‚



**ç¤ºä¾‹ä»£ç ï¼š**

**è“è‰² Deployment** (`blue-deployment.yaml`):

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blue-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
      version: blue
  template:
    metadata:
      labels:
        app: myapp
        version: blue
    spec:
      containers:
      - name: myapp
        image: myapp:blue
```



**ç»¿è‰² Deployment** (`green-deployment.yaml`):

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: green-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
      version: green
  template:
    metadata:
      labels:
        app: myapp
        version: green
    spec:
      containers:
      - name: myapp
        image: myapp:green

```



**ç»“åˆargo Rollouts**

è¦å°† Argo Rollouts ä¸è“ç»¿éƒ¨ç½²ç»“åˆèµ·æ¥ï¼Œæ‚¨å¯ä»¥é€šè¿‡ Argo Rollouts å®šä¹‰å’Œç®¡ç†è“ç»¿éƒ¨ç½²è¿‡ç¨‹ï¼ŒåŒæ—¶åˆ©ç”¨å…¶å¼ºå¤§çš„æµé‡æ§åˆ¶å’Œè‡ªåŠ¨åŒ–å›æ»šåŠŸèƒ½ã€‚è¿™éœ€è¦æ‚¨åœ¨ Kubernetes é›†ç¾¤ä¸­å®‰è£… Argo Rollouts æ§åˆ¶å™¨ï¼Œå¹¶å®šä¹‰ç›¸åº”çš„ Rollout èµ„æºæ¥ä»£æ›¿æ ‡å‡†çš„ Deployment èµ„æºã€‚

### ç»“åˆargo Rolloutsè®¾è®¡æ–¹æ¡ˆ

1. **å®‰è£… Argo Rollouts æ§åˆ¶å™¨**ï¼š
   + ç¡®ä¿æ‚¨çš„ Kubernetes é›†ç¾¤ä¸­å·²ç»å®‰è£…äº† Argo Rolloutsã€‚
2. **å®šä¹‰ Rollout èµ„æº**ï¼š
   + æ›¿ä»£ä¼ ç»Ÿçš„ Deployment èµ„æºï¼Œä½¿ç”¨ Rollout èµ„æºæ¥å®šä¹‰æ‚¨çš„åº”ç”¨éƒ¨ç½²ã€‚
   + åœ¨ Rollout é…ç½®ä¸­æŒ‡å®šè“ç»¿éƒ¨ç½²ç­–ç•¥ã€‚
3. **é…ç½® Service**ï¼š
   + å®šä¹‰ Service æ¥æŒ‡å‘ Rollout ç®¡ç†çš„ Podsã€‚
4. **é…ç½® Ingress**ï¼š
   + ä½¿ç”¨ Ingress èµ„æºæ¥æ§åˆ¶å¤–éƒ¨æµé‡è¿›å…¥æ‚¨çš„æœåŠ¡ã€‚
5. **æµé‡è½¬ç§»**ï¼š
   + åˆ©ç”¨ Argo Rollouts çš„èƒ½åŠ›æ¥ç®¡ç†ä»è“è‰²åˆ°ç»¿è‰²çš„æµé‡è½¬ç§»ã€‚

### ç¤ºä¾‹ä»£ç 

1. **Rollout èµ„æº** (`blue-green-rollout.yaml`):

   ```yaml
   apiVersion: argoproj.io/v1alpha1
   kind: Rollout
   metadata:
     name: bluegreen-rollout
   spec:
     replicas: 2
     selector:
       matchLabels:
         app: myapp
     template:
       metadata:
         labels:
           app: myapp
       spec:
         containers:
         - name: myapp
           image: myapp:latest
     strategy:
       blueGreen: 
         activeService: myapp-active
         previewService: myapp-preview
         autoPromotionEnabled: false
   ```

2. **Active Service** (`active-service.yaml`):

   ```yaml
   apiVersion: v1
   kind: Service
   metadata:
     name: myapp-active
   spec:
     selector:
       app: myapp
     ports:
     - protocol: TCP
       port: 80
       targetPort: 8080
   ```

3. **Preview Service** (`preview-service.yaml`):

   ```yaml
   apiVersion: v1
   kind: Service
   metadata:
     name: myapp-preview
   spec:
     selector:
       app: myapp
       rollouts-pod-template-hash: <HASH>
     ports:
     - protocol: TCP
       port: 80
       targetPort: 8080
   ```

4. **Ingress èµ„æº** (`ingress.yaml`):

   ```yaml
   apiVersion: networking.k8s.io/v1
   kind: Ingress
   metadata:
     name: myapp-ingress
   spec:
     rules:
     - http:
         paths:
         - path: /
           pathType: Prefix
           backend:
             service:
               name: myapp-active
               port:
                 number: 80
   ```

åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œ`activeService` å’Œ `previewService` åˆ†åˆ«ä»£è¡¨å½“å‰æ´»è·ƒç‰ˆæœ¬å’Œé¢„è§ˆï¼ˆæ–°ç‰ˆæœ¬ï¼‰çš„æœåŠ¡ã€‚Argo Rollouts ä¼šæ ¹æ®é…ç½®è‡ªåŠ¨ç®¡ç†è“ç»¿éƒ¨ç½²è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æµé‡çš„è½¬ç§»ã€‚æ‚¨å¯ä»¥é€šè¿‡æ›´æ–° Rollout èµ„æºä¸­çš„é•œåƒç‰ˆæœ¬æ¥è§¦å‘æ–°çš„éƒ¨ç½²ï¼Œå¹¶ä½¿ç”¨ Argo Rollouts çš„å‘½ä»¤è¡Œå·¥å…·æ¥æ§åˆ¶æµé‡è½¬ç§»å’Œä¿ƒè¿›æ–°ç‰ˆæœ¬çš„å‘å¸ƒã€‚



## é‡‘ä¸é›€éƒ¨ç½²

é‡‘ä¸é›€éƒ¨ç½²æ˜¯ä¸€ç§æŠ€æœ¯ï¼š

> é‡‘ä¸é›€éƒ¨ç½²ï¼ˆCanary Deploymentï¼‰æ˜¯ä¸€ç§è½¯ä»¶å‘å¸ƒæŠ€æœ¯ï¼Œå®ƒåœ¨æ›´æ–°åº”ç”¨ç¨‹åºæ—¶é‡‡å–é€æ­¥çš„æ–¹æ³•ï¼Œä»¥æœ€å°åŒ–é£é™©ã€‚è¿™ç§ç­–ç•¥çš„å‘½åæºäºçŸ¿å·¥ä½¿ç”¨é‡‘ä¸é›€ä½œä¸ºä¸€ç§å®‰å…¨é¢„è­¦ç³»ç»Ÿçš„å†å²ã€‚åœ¨è½¯ä»¶éƒ¨ç½²çš„è¯­å¢ƒä¸­ï¼Œå®ƒä»£è¡¨äº†é€æ¸å¼•å…¥æ–°ç‰ˆæœ¬åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ï¼Œä»¥ä¾¿åœ¨å…¨é¢éƒ¨ç½²å‰å¯¹å…¶è¿›è¡Œæµ‹è¯•å’ŒéªŒè¯ã€‚

### ç‰¹ç‚¹

1. **é€æ­¥æ¨å‡º**ï¼š
   + æ–°ç‰ˆæœ¬åˆå§‹åªå‘ä¸€å°éƒ¨åˆ†ç”¨æˆ·æˆ–ç¯å¢ƒå‘å¸ƒï¼Œè€Œå¤§éƒ¨åˆ†ç”¨æˆ·ä»ç„¶ä½¿ç”¨æ—§ç‰ˆæœ¬ã€‚
2. **é£é™©æ§åˆ¶**ï¼š
   + å¦‚æœæ–°ç‰ˆæœ¬è¡¨ç°ä¸ä½³ï¼ˆå¦‚å‡ºç°é”™è¯¯æˆ–æ€§èƒ½é—®é¢˜ï¼‰ï¼Œåˆ™å½±å“çš„ç”¨æˆ·èŒƒå›´æœ‰é™ï¼Œä¸”å¯ä»¥è¿…é€Ÿå›æ»šã€‚
3. **å®æ—¶åé¦ˆ**ï¼š
   + æä¾›æœºä¼šè§‚å¯Ÿæ–°ç‰ˆæœ¬åœ¨å®é™…ç¯å¢ƒä¸­çš„è¡¨ç°ï¼Œæ”¶é›†å®æ—¶åé¦ˆå’Œæ€§èƒ½æ•°æ®ã€‚

### å®æ–½æ­¥éª¤

1. **åˆå§‹å‘å¸ƒ**ï¼š
   + æ–°ç‰ˆæœ¬æœ€åˆåªå¯¹ä¸€å°ç»„ç”¨æˆ·æˆ–ä¸€éƒ¨åˆ†æµé‡å¯è§ã€‚
2. **ç›‘æ§å’Œè¯„ä¼°**ï¼š
   + å¯¹æ–°ç‰ˆæœ¬çš„æ€§èƒ½ã€ç¨³å®šæ€§å’Œç”¨æˆ·åé¦ˆè¿›è¡ŒæŒç»­ç›‘æ§ã€‚
3. **é€æ­¥å¢åŠ è¦†ç›–ç‡**ï¼š
   + å¦‚æœæ–°ç‰ˆæœ¬è¡¨ç°è‰¯å¥½ï¼Œé€æ­¥å¢åŠ å…¶å¯¹ç”¨æˆ·æˆ–æµé‡çš„è¦†ç›–èŒƒå›´ã€‚
4. **å…¨é¢éƒ¨ç½²æˆ–å›æ»š**ï¼š
   + æ ¹æ®åé¦ˆå’Œç›‘æ§ç»“æœï¼Œå†³å®šæ˜¯å…¨é¢éƒ¨ç½²æ–°ç‰ˆæœ¬è¿˜æ˜¯å›æ»šåˆ°æ—§ç‰ˆæœ¬ã€‚

### åº”ç”¨åœºæ™¯

+ **é«˜é£é™©æ›´æ–°**ï¼šå¯¹äºå¯èƒ½å¯¹ç³»ç»Ÿç¨³å®šæ€§æˆ–ç”¨æˆ·ä½“éªŒæœ‰é‡å¤§å½±å“çš„æ›´æ–°ã€‚
+ **å¤§å‹åº”ç”¨**ï¼šåœ¨å¤§å‹æˆ–å¤æ‚çš„åº”ç”¨ä¸­ï¼Œä¸åŒç”¨æˆ·ç¾¤å¯èƒ½å¯¹æ›´æ–°æœ‰ä¸åŒçš„ååº”ã€‚
+ **è¿ç»­éƒ¨ç½²ç¯å¢ƒ**ï¼šåœ¨æ•æ·å¼€å‘å’ŒæŒç»­é›†æˆ/æŒç»­éƒ¨ç½² (CI/CD) ç¯å¢ƒä¸­ï¼Œé‡‘ä¸é›€éƒ¨ç½²å¯ä»¥ä½œä¸ºä¸€ç§æœ‰æ•ˆçš„é£é™©ç®¡ç†å·¥å…·ã€‚



### ä½¿ç”¨ Ingress å’Œ Deployment å®ç°é‡‘ä¸é›€éƒ¨ç½²

#### è®¾è®¡æ–¹æ¡ˆ

1. **å‡†å¤‡ä¸¤ä¸ª Deployment**ï¼š
   + ä¸€ä¸ªä¸ºå½“å‰ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼Œæ ‡è®°ä¸º `version: stable`ï¼‰ã€‚
   + å¦ä¸€ä¸ªä¸ºæ–°ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼Œæ ‡è®°ä¸º `version: canary`ï¼‰ã€‚
2. **é…ç½® Service**ï¼š
   + ä¸ºæ¯ä¸ª Deployment åˆ›å»ºä¸€ä¸ª Serviceã€‚
3. **é…ç½® Ingress**ï¼š
   + ä½¿ç”¨ Ingress èµ„æºå®šä¹‰æµé‡çš„åˆ†é…ç­–ç•¥ï¼ŒæŒ‡å®šä¸€éƒ¨åˆ†æµé‡åˆ°æ–°ç‰ˆæœ¬ã€‚

#### ç¤ºä¾‹ä»£ç 

1. **Stable Deployment** (`stable-deployment.yaml`):

   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: myapp-stable
   spec:
     replicas: 3
     selector:
       matchLabels:
         app: myapp
         version: stable
     template:
       metadata:
         labels:
           app: myapp
           version: stable
       spec:
         containers:
         - name: myapp
           image: myapp:stable
   ```

2. **Canary Deployment** (`canary-deployment.yaml`):

   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: myapp-canary
   spec:
     replicas: 1  # Lesser replicas as it's a canary release
     selector:
       matchLabels:
         app: myapp
         version: canary
     template:
       metadata:
         labels:
           app: myapp
           version: canary
       spec:
         containers:
         - name: myapp
           image: myapp:canary
   ```

3. **Service** (`service.yaml`):

   ```
   yamlCopy codeapiVersion: v1
   kind: Service
   metadata:
     name: myapp-service
   spec:
     selector:
       app: myapp
     ports:
     - protocol: TCP
       port: 80
       targetPort: 8080
   ```

4. **Ingress èµ„æº** (`ingress.yaml`):

   + åœ¨è¿™é‡Œï¼Œæ‚¨éœ€è¦ä½¿ç”¨ Ingress æ§åˆ¶å™¨çš„ç‰¹å®šåŠŸèƒ½æ¥åˆ†é…æµé‡ï¼ˆä¾‹å¦‚ï¼ŒNGINX Ingress çš„æƒé‡åˆ†é…ï¼‰ã€‚

### ä½¿ç”¨ Argo Rollouts å®ç°é‡‘ä¸é›€éƒ¨ç½²

#### è®¾è®¡æ–¹æ¡ˆ

1. **å®‰è£… Argo Rollouts**ï¼š
   + ç¡®ä¿æ‚¨çš„ Kubernetes é›†ç¾¤ä¸­å·²ç»å®‰è£…äº† Argo Rolloutsã€‚
2. **å®šä¹‰ Rollout èµ„æº**ï¼š
   + ä½¿ç”¨ Rollout èµ„æºæ¥å®šä¹‰åº”ç”¨éƒ¨ç½²ï¼Œå¹¶æŒ‡å®šé‡‘ä¸é›€ç­–ç•¥ã€‚
3. **é…ç½® Service**ï¼š
   + å®šä¹‰ Service æ¥æŒ‡å‘ Rollout ç®¡ç†çš„ Podsã€‚
4. **ç›‘æ§å’Œç®¡ç†éƒ¨ç½²**ï¼š
   + åˆ©ç”¨ Argo Rollouts æä¾›çš„å·¥å…·æ¥ç›‘æ§å’Œç®¡ç†éƒ¨ç½²è¿‡ç¨‹ã€‚

#### ç¤ºä¾‹ä»£ç 

1. **Rollout èµ„æº** (`canary-rollout.yaml`):

   ```yaml
   apiVersion: argoproj.io/v1alpha1
   kind: Rollout
   metadata:
     name: myapp-rollout
   spec:
     replicas: 4
     selector:
       matchLabels:
         app: myapp
     template:
       metadata:
         labels:
           app: myapp
       spec:
         containers:
         - name: myapp
           image: myapp:new-version
     strategy:
       canary:
         steps:
         - setWeight: 20
         - pause: {duration: 48h}
         - setWeight: 50
         - pause: {duration: 48h}
   ```

2. **Service** (`service.yaml`):

   + åŒä¸Šé¢çš„ Ingress å’Œ Deployment æ–¹æ³•ä¸­çš„ Serviceã€‚

åœ¨ä½¿ç”¨ Argo Rollouts çš„æƒ…å†µä¸‹ï¼Œéƒ¨ç½²çš„ç®¡ç†å’Œæµé‡åˆ†é…å˜å¾—æ›´åŠ ç®€å•å’Œç›´è§‚ã€‚æ‚¨å¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶æ–°ç‰ˆæœ¬çš„æµé‡æ¯”ä¾‹ï¼Œå¹¶åˆ©ç”¨ Rollouts çš„è‡ªåŠ¨åŒ–ç‰¹æ€§æ¥ç›‘æ§éƒ¨ç½²çš„å¥åº·çŠ¶å†µå’Œè‡ªåŠ¨å›æ»š



### æ¸è¿›å¼éƒ¨ç½²

æ¸è¿›å¼éƒ¨ç½²æ˜¯é‡‘ä¸é›€éƒ¨ç½²çš„ä¸€ä¸ªå®Œå…¨çš„è‡ªåŠ¨åŒ–ç‰ˆæœ¬ã€‚æ¸è¿›å¼äº¤äº’ä¸æ˜¯åœ¨æ‰©å¤§é‡‘ä¸é›€éƒ¨ç½²ä¹‹å‰æ£€æµ‹ä¸€ä¸ªå›ºå®šçš„æ—¶é—´æ®µï¼Œè€Œæ˜¯æŒç»­ç›‘æµ‹ Pod çš„å¥åº·çŠ¶æ€ï¼Œå¹¶ä¸”ä¸æ–­æ‰©å¤§è§„æ¨¡ï¼Œç›´åˆ°å®Œå…¨æ‰©å±•ã€‚



## END é“¾æ¥

<ul><li><div><a href = '88.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '90.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

