<template><div><ul>
<li><a href="http://nsddd.top" target="_blank" rel="noopener noreferrer">author<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬66èŠ‚-crd" tabindex="-1"><a class="header-anchor" href="#ç¬¬66èŠ‚-crd" aria-hidden="true">#</a> ç¬¬66èŠ‚ CRD</h1>
<div><a href = '65.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '67.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<p>[TOC]</p>
<h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€" aria-hidden="true">#</a> å‰è¨€</h2>
<p>sealos ä½¿ç”¨äº†å¤§é‡çš„ CRD å¯¹å…¶æ‰©å±•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CRD æ¥ Kubernetes</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/kubebuilder" target="_blank" rel="noopener noreferrer">kubebuilder<ExternalLinkIcon/></a></li>
<li><a href="https://book.kubebuilder.io/" target="_blank" rel="noopener noreferrer">å®˜æ–¹å­¦ä¹ æ–‡æ¡£<ExternalLinkIcon/></a></li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿™é‡Œæœ‰ä¸€ä»½å®˜æ–¹ CRD  <a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener noreferrer">æ¡ˆä¾‹ ~<ExternalLinkIcon/></a></p>
<p>CRDæ˜¯Kubernetesä¸ºæé«˜å¯æ‰©å±•æ€§ï¼Œè®©å¼€å‘è€…å»è‡ªå®šä¹‰èµ„æºï¼ˆå¦‚Deploymentï¼ŒStatefulSetç­‰ï¼‰çš„ä¸€ç§æ–¹æ³•ã€‚</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>Operator=CRD+Controller
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>CRDä»…ä»…æ˜¯èµ„æºçš„å®šä¹‰ï¼Œè€ŒControllerå¯ä»¥å»ç›‘å¬CRDçš„CRUDäº‹ä»¶æ¥æ·»åŠ è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>å¦‚æœè¯´åªæ˜¯å¯¹CRDå®ä¾‹è¿›è¡Œ <code v-pre>CRUD</code> çš„è¯ï¼Œä¸éœ€è¦ <code v-pre>Controller</code> ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ï¼Œåªæ˜¯åªæœ‰æ•°æ®ï¼Œæ²¡æœ‰é’ˆå¯¹æ•°æ®çš„æ“ä½œã€‚</p>
<h3 id="é¡¹ç›®-demo" tabindex="-1"><a class="header-anchor" href="#é¡¹ç›®-demo" aria-hidden="true">#</a> é¡¹ç›® demo</h3>
<p>reviewï¼š<a href="https://github.com/muzi502" target="_blank" rel="noopener noreferrer">@muzi502<ExternalLinkIcon/></a></p>
<p>author:  <a href="https://github.com/cubxxw" target="_blank" rel="noopener noreferrer">@cubxxw<ExternalLinkIcon/></a></p>
<blockquote>
<p>è¿™ç¯‡æ–‡ç« å°†å‚è€ƒå„ä¸ªåšå®¢å’Œ kubebuilder å®˜æ–¹æ–‡æ¡£ ä»¥åŠ <a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener noreferrer">kubernetes/sample-controller<ExternalLinkIcon/></a>  è¿›è¡Œå­¦ä¹ ï¼Œæœ€åå®è·µä¸€ä¸ªé¡¹ç›®çš„æ­¥éª¤ï¼Œå¯¹é™æ€åšå®¢ï¼ˆ<a href="https://docker.nsddd.top/" target="_blank" rel="noopener noreferrer">docker.nsddd.top<ExternalLinkIcon/></a> æˆ–è€… <a href="https://go.nsddd.top/" target="_blank" rel="noopener noreferrer">go.nsddd.top<ExternalLinkIcon/></a>) è¿›è¡Œ CRDï¼Œå½¢æˆå­¦ä¹ é—­ç¯~</p>
<ol>
<li>åˆ›å»ºè‡ªå®šä¹‰APIå¯¹è±¡ï¼ˆCustom Resource Definitionï¼‰ï¼Œåä¸ºBlogï¼›</li>
<li>ç”¨ä»£ç ç”Ÿæˆå·¥å…·ç”Ÿæˆinformerå’Œclientç›¸å…³ä»£ç ï¼›</li>
<li>åˆ›å»ºå¹¶è¿è¡Œè‡ªå®šä¹‰æ§åˆ¶å™¨ï¼Œk8sç¯å¢ƒä¸­æ‰€æœ‰ Blog ç›¸å…³çš„&quot;å¢ã€åˆ ã€æ”¹&quot;æ“ä½œéƒ½ä¼šè¢«æ­¤æ§åˆ¶å™¨ç›‘å¬åˆ°ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚åœ¨æ§åˆ¶å™¨ä¸­ç¼–å†™ä¸šåŠ¡ä»£ç ï¼›</li>
</ol>
</blockquote>
<h3 id="operator-åŠŸèƒ½è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#operator-åŠŸèƒ½è®¾è®¡" aria-hidden="true">#</a> Operator åŠŸèƒ½è®¾è®¡</h3>
<p>å€ŸåŠ© Operator å®Œæˆå’Œä¼ä¸šå†…éƒ¨æ³¨å†Œä¸­å¿ƒçš„æ‰“é€š</p>
<p><strong>Operator å¼€å‘ SDK æœ‰ 2 ä¸ªé€‰æ‹©ï¼š</strong></p>
<ul>
<li>kubebuilder</li>
<li>operator sdk</li>
</ul>
<p>æ³¨æ„ï¼šåœ¨æœ¬è´¨ä¸Šå…¶å®éƒ½æ˜¯åœ¨ K8s æ§åˆ¶å™¨è¿è¡Œæ—¶ä¸Šçš„å°è£…ï¼Œä¸»è¦éƒ½æ˜¯è„šæ‰‹æ¶çš„ç”Ÿæˆï¼Œä½¿ç”¨ä½“éªŒç›¸å·®ä¸å¤§ã€‚</p>
<p>ä½†æ˜¯æœ‰æ„æ€çš„æ˜¯ï¼ŒKubebuilder çš„ç»´æŠ¤æ–¹æ˜¯ï¼škubernetes-sigsï¼Œæ‰€ä»¥æ›´å—äººå…³æ³¨ã€‚</p>
<p>åº•å±‚éƒ½æ˜¯åŸºäº k8s æ§åˆ¶å™¨è¿è¡Œæ—¶å°è£…ï¼Œä¸åŒçš„æ˜¯ kubebuilder æ—©æœŸåŒ…å« CRDå’Œ è‡ªå®šä¹‰ Controller å¼€å‘ã€‚ä½†æ˜¯ operator-sdk æ—©æœŸä¸åŒ…å« CRD å¼€å‘ï¼Œä½†æ˜¯ç°åœ¨ä¹Ÿæ˜¯èåˆäº†ã€‚</p>
<p><strong>CRD å…è®¸ä½ å®šä¹‰è‡ªå·±çš„ Kubernetes API å¯¹è±¡ï¼Œè€Œè‡ªå®šä¹‰æ§åˆ¶å™¨å¯ä»¥ç›‘å¬è¿™äº›å¯¹è±¡çš„äº‹ä»¶å¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</strong></p>
<h3 id="kubebuilder-æ¶æ„å›¾" tabindex="-1"><a class="header-anchor" href="#kubebuilder-æ¶æ„å›¾" aria-hidden="true">#</a> kubebuilder æ¶æ„å›¾</h3>
<p><strong>å›¾ç‰‡æ¥è‡ªå®˜ç½‘ç«™ï¼š</strong></p>
<p><img src="http://sm.nsddd.top/sm202304081027380.png" alt="image-20230408102740099"></p>
<h2 id="installation-kubebuilder" tabindex="-1"><a class="header-anchor" href="#installation-kubebuilder" aria-hidden="true">#</a> installation kubebuilder</h2>
<p>å®‰è£…kubebuilderï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token parameter variable">-o</span> kubebuilder https://go.kubebuilder.io/dl/latest/<span class="token variable"><span class="token variable">$(</span>go <span class="token function">env</span> GOOS<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>go <span class="token function">env</span> GOARCH<span class="token variable">)</span></span>

â¯ <span class="token function">chmod</span> +x kubebuilder <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> kubebuilder /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ–è€…ï¼Œä½¿ç”¨ <code v-pre>make build</code> ï¼Œ è¿™æ˜¯æˆ‘å¾ˆå–œæ¬¢çš„ä¸€ç§æ–¹å¼ï¼Œæ–¹ä¾¿è´¡çŒ®å’Œé˜…è¯»æºç ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBEBUILDER</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/kubebuilder
â¯ <span class="token function">git</span> clone https://github.com/kubernetes-sigs/kubebuilder.git <span class="token variable">$KUBEBUILDER</span>  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token variable">$KUBEBUILDER</span><span class="token punctuation">;</span> <span class="token function">make</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> bin<span class="token punctuation">;</span> ./kubebuilder<span class="token punctuation">;</span> 
â¯ <span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$KUBEBUILDER</span>/bin<span class="token punctuation">;</span> kubebuilder
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="create-a-project" tabindex="-1"><a class="header-anchor" href="#create-a-project" aria-hidden="true">#</a> create a project</h2>
<p>å¾ˆç®€å•çš„è¡Œä¸ºï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå¹¶ä¸”ä½¿ç”¨ å‘½ä»¤ åˆå§‹åŒ–å°±å¤Ÿäº†ï¼Œåœ¨åº•å±‚ä¸Š kubebuilder å¹¶ä¸å¸Œæœ›æˆ‘ä»¬çŸ¥é“å®ç°çš„ç»†èŠ‚~</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">mkdir</span> /tmp/guestbook -p<span class="token punctuation">;</span> <span class="token builtin class-name">cd</span> /tmp/guestbook
â¯ kubebuilder init <span class="token parameter variable">--domain</span> my.domain <span class="token parameter variable">--repo</span> my.domain/guestbook
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªç›®å½•å°±æ˜¯å¾ˆç¥å¥‡äº†ï¼Œå°±åƒä»£ç ç”Ÿæˆå™¨ä¸€æ ·ç”Ÿæˆäº†ä¸€ä¸ªæ¨¡æ¿ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ tree <span class="token parameter variable">-L</span> <span class="token number">3</span>
<span class="token builtin class-name">.</span>
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Makefile
â”œâ”€â”€ PROJECT
â”œâ”€â”€ README.md
â”œâ”€â”€ cmd
â”‚   â””â”€â”€ main.go
â”œâ”€â”€ config
â”‚   â”œâ”€â”€ default
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ manager_auth_proxy_patch.yaml
â”‚   â”‚   â””â”€â”€ manager_config_patch.yaml
â”‚   â”œâ”€â”€ manager
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â””â”€â”€ manager.yaml
â”‚   â”œâ”€â”€ prometheus
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â””â”€â”€ monitor.yaml
â”‚   â””â”€â”€ rbac
â”‚       â”œâ”€â”€ auth_proxy_client_clusterrole.yaml
â”‚       â”œâ”€â”€ auth_proxy_role.yaml
â”‚       â”œâ”€â”€ auth_proxy_role_binding.yaml
â”‚       â”œâ”€â”€ auth_proxy_service.yaml
â”‚       â”œâ”€â”€ kustomization.yaml
â”‚       â”œâ”€â”€ leader_election_role.yaml
â”‚       â”œâ”€â”€ leader_election_role_binding.yaml
â”‚       â”œâ”€â”€ role_binding.yaml
â”‚       â””â”€â”€ service_account.yaml
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â””â”€â”€ hack
    â””â”€â”€ boilerplate.go.txt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™é‡Œæˆ‘å€ŸåŠ©ã€ŠKubernetes operator å¼€å‘è¿›é˜¶ã€‹è¿™æœ¬ä¹¦ï¼ˆä½†ä¸æ¨èï¼‰éƒ¨åˆ†è§£é‡Šï¼š</p>
<ul>
<li><code v-pre>Dockerfile</code>: ç”¨äºæ„å»º Docker é•œåƒçš„æ–‡ä»¶ã€‚</li>
<li><code v-pre>Makefile</code>: ä¸€ä¸ª Makefileï¼Œå…¶ä¸­åŒ…å«äº†ç”¨äºæ„å»ºå’Œå‘å¸ƒ Operator çš„å¸¸ç”¨å‘½ä»¤ã€‚</li>
<li><code v-pre>PROJECT</code>: é¡¹ç›®åç§°ï¼Œä»¥åŠé¡¹ç›®ä¿¡æ¯ï¼Œè¿™é‡Œæ˜¯ä¸€äº› metadata ã€‚</li>
<li><code v-pre>README.md</code>: é¡¹ç›®çš„è¯´æ˜æ–‡æ¡£ã€‚</li>
<li><code v-pre>cmd/</code>: åŒ…å«äº† Operator çš„å…¥å£ç¨‹åº <code v-pre>main.go</code>ã€‚</li>
<li><code v-pre>config/</code>: åŒ…å«äº† Operator çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬ RBAC æƒé™ç›¸å…³çš„ YAML æ–‡ä»¶ã€Prometheus ç›‘æ§æœåŠ¡å‘ç°ï¼ˆServiceMonitorï¼‰ç›¸å…³çš„ Yaml æ–‡ä»¶ã€æ§åˆ¶å™¨ï¼ˆManagerï¼‰éƒ¨åˆ†éƒ¨ç½²çš„ Yaml æ–‡ä»¶ã€‚
<ul>
<li><code v-pre>default/</code>: åŒ…å«äº†é»˜è®¤çš„é…ç½®æ–‡ä»¶ã€‚
<ul>
<li><code v-pre>kustomization.yaml</code>: Kustomize é…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šäº†éœ€è¦åº”ç”¨çš„ k8s èµ„æºç±»å‹å’Œåç§°ã€‚</li>
<li><code v-pre>manager_auth_proxy_patch.yaml</code>: åœ¨ manager å®¹å™¨ä¸­æ·»åŠ äº† auth-proxy å®¹å™¨çš„ç›¸å…³ä¿¡æ¯ã€‚</li>
<li><code v-pre>manager_config_patch.yaml</code>: åœ¨ manager å®¹å™¨ä¸­æ·»åŠ äº†ä¸ Operator ç›¸å…³çš„é…ç½®ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li><code v-pre>manager/</code>: åŒ…å«äº†éƒ¨ç½² Operator æ‰€éœ€çš„ k8s èµ„æºæ–‡ä»¶ã€‚
<ul>
<li><code v-pre>kustomization.yaml</code>: Kustomize é…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šäº†éœ€è¦åº”ç”¨çš„ k8s èµ„æºç±»å‹å’Œåç§°ã€‚</li>
<li><code v-pre>manager.yaml</code>: éƒ¨ç½² Operator æ‰€éœ€çš„ k8s èµ„æºæ–‡ä»¶ã€‚</li>
</ul>
</li>
<li><code v-pre>prometheus/</code>: åŒ…å«äº† Prometheus ç›‘æ§ Operator æ‰€éœ€çš„ k8s èµ„æºæ–‡ä»¶ã€‚
<ul>
<li><code v-pre>kustomization.yaml</code>: Kustomize é…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šäº†éœ€è¦åº”ç”¨çš„ k8s èµ„æºç±»å‹å’Œåç§°ã€‚</li>
<li><code v-pre>monitor.yaml</code>: éƒ¨ç½² Prometheus ç›‘æ§ Operator æ‰€éœ€çš„ k8s èµ„æºæ–‡ä»¶ã€‚</li>
</ul>
</li>
<li><code v-pre>rbac/</code>: åŒ…å«äº† Operator æ‰€éœ€çš„ RBAC èµ„æºæ–‡ä»¶ã€‚
<ul>
<li><code v-pre>auth_proxy_client_clusterrole.yaml</code>: é…ç½®äº†ä¸å®¢æˆ·ç«¯æˆæƒç›¸å…³çš„ ClusterRoleã€‚</li>
<li><code v-pre>auth_proxy_role.yaml</code>: é…ç½®äº†ä¸ auth-proxy ç›¸å…³çš„ Roleã€‚</li>
<li><code v-pre>auth_proxy_role_binding.yaml</code>: é…ç½®äº†ä¸ auth-proxy ç›¸å…³çš„ RoleBindingã€‚</li>
<li><code v-pre>auth_proxy_service.yaml</code>: é…ç½®äº†ä¸ auth-proxy ç›¸å…³çš„ Serviceã€‚</li>
<li><code v-pre>kustomization.yaml</code>: Kustomize é…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šäº†éœ€è¦åº”ç”¨çš„ k8s èµ„æºç±»å‹å’Œåç§°ã€‚</li>
<li><code v-pre>leader_election_role.yaml</code>: é…ç½®äº†ä¸ leader election ç›¸å…³çš„ Roleã€‚</li>
<li><code v-pre>leader_election_role_binding.yaml</code>: é…ç½®äº†ä¸ leader election ç›¸å…³çš„ RoleBindingã€‚</li>
<li><code v-pre>role_binding.yaml</code>: é…ç½®äº†ä¸ Operator ç›¸å…³çš„ RoleBindingã€‚</li>
<li><code v-pre>service_account.yaml</code>: é…ç½®äº†ä¸ Operator ç›¸å…³çš„ ServiceAccountã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code v-pre>go.mod</code>: Go é¡¹ç›®çš„æ¨¡å—æ–‡ä»¶ã€‚</li>
<li><code v-pre>go.sum</code>: Go é¡¹ç›®çš„æ¨¡å—ä¾èµ–æ–‡ä»¶ã€‚</li>
<li><code v-pre>hack/</code>: åŒ…å«äº†ç”Ÿæˆä»£ç å’Œæ–‡æ¡£ç­‰ç›¸å…³çš„è„šæœ¬å’Œæ–‡ä»¶ã€‚
<ul>
<li><code v-pre>boilerplate.go.txt</code>: ç”¨äºç”Ÿæˆ Go é¡¹ç›®æ–‡ä»¶çš„ä»£ç æ¨¡æ¿ã€‚</li>
</ul>
</li>
</ul>
<p>ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åé¢çš„å­¦ä¹ ï¼Œæˆ‘è¿™é‡Œç”¨ git è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œæ–¹ä¾¿è§‚å¯Ÿåé¢ç”Ÿæˆäº†å“ªäº›æ–‡ä»¶</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>â¯ git add .
â¯ git commit -a -s -m "kubebuilder init"
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="create-an-api" tabindex="-1"><a class="header-anchor" href="#create-an-api" aria-hidden="true">#</a> create an API</h2>
<p>è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„APIï¼ˆç»„/ç‰ˆæœ¬ï¼‰ä¸º <code v-pre>webapp/v1</code> ï¼Œå¹¶åœ¨å…¶ä¸Šåˆ›å»ºæ–°çš„Kindï¼ˆCRDï¼‰ <code v-pre>Guestbook</code> ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ kubebuilder create api <span class="token parameter variable">--group</span> webapp <span class="token parameter variable">--version</span> v1 <span class="token parameter variable">--kind</span> Guestbook
Create Resource <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span>
y
Create Controller <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span>
y
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š</p>
<blockquote>
<p>å¦‚æœä½ æŒ‰ä¸‹ <code v-pre>y</code> åˆ›å»ºèµ„æº[y/n]å’Œåˆ›å»ºæ§åˆ¶å™¨[y/n]ï¼Œåˆ™è¿™å°†åˆ›å»ºæ–‡ä»¶ <code v-pre>api/v1/guestbook_types.go</code> ï¼ˆå…¶ä¸­å®šä¹‰äº†APIï¼‰å’Œ <code v-pre>controllers/guestbook_controller.go</code> ï¼ˆå…¶ä¸­å®ç°äº†æ­¤ç±»ï¼ˆCRDï¼‰çš„åè°ƒä¸šåŠ¡é€»è¾‘ï¼‰ã€‚</p>
</blockquote>
<p>è¿™ä¸ªæ—¶å€™ kubebuilder åˆå·å·çš„åšäº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬çœ‹ä¸€ä¸‹ git çš„å˜åŠ¨ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">git</span> status
On branch master
Changes not staged <span class="token keyword">for</span> commit:
  <span class="token punctuation">(</span>use <span class="token string">"git add &lt;file>..."</span> to update what will be committed<span class="token punctuation">)</span>
  <span class="token punctuation">(</span>use <span class="token string">"git restore &lt;file>..."</span> to discard changes <span class="token keyword">in</span> working directory<span class="token punctuation">)</span>
        modified:   PROJECT
        modified:   cmd/main.go
        modified:   go.mod
        modified:   go.sum

Untracked files:
  <span class="token punctuation">(</span>use <span class="token string">"git add &lt;file>..."</span> to include <span class="token keyword">in</span> what will be committed<span class="token punctuation">)</span>
        api/
        config/crd/
        config/rbac/guestbook_editor_role.yaml
        config/rbac/guestbook_viewer_role.yaml
        config/samples/
        internal/

no changes added to commit <span class="token punctuation">(</span>use <span class="token string">"git add"</span> and/or <span class="token string">"git commit -a"</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ–°å¢ç›®å½•ï¼š</p>
<ul>
<li><code v-pre>api</code>ï¼šåŒ…å«åˆšåˆšæ·»åŠ çš„ APIï¼Œåé¢ä¼šç»å¸¸ç¼–è¾‘è¿™é‡Œçš„ <code v-pre>guestbook_types.go</code> æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯ CRD ä»£ç çš„ä¸»è¦å®šä¹‰æ–‡ä»¶ã€‚</li>
<li><code v-pre>config/crd</code>ï¼šå­˜æ”¾çš„æ˜¯ crd éƒ¨ç½²ç›¸å…³çš„ kustomize æ–‡ä»¶ã€‚</li>
<li><code v-pre>config/rbac/</code>ï¼šåˆ†åˆ«æ˜¯ç¼–è¾‘æƒé™å’ŒæŸ¥è¯¢æƒé™çš„ <code v-pre>ClusterRole</code></li>
<li><code v-pre>samples</code>ï¼šå¾ˆå¥½ç†è§£ï¼ŒCR ç¤ºä¾‹æ–‡ä»¶</li>
<li><code v-pre>internal</code> ï¼šå¾ˆå¥½ç†è§£ï¼Œå†…éƒ¨æ ¸å¿ƒä»£ç ï¼Œæˆ‘ä»¬æ‰“å¼€çœ‹çœ‹ <code v-pre>controllers</code></li>
</ul>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>â¯ cat internal<span class="token operator">/</span>controller<span class="token operator">/</span>guestbook_controller<span class="token punctuation">.</span><span class="token keyword">go</span>

<span class="token keyword">package</span> controller
<span class="token comment">//...</span>
<span class="token comment">// GuestbookReconciler reconciles a Guestbook object</span>
<span class="token keyword">type</span> GuestbookReconciler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span>Client
        Scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme
<span class="token punctuation">}</span>
<span class="token comment">//...</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>GuestbookReconciler<span class="token punctuation">)</span> <span class="token function">Reconcile</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req ctrl<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

        <span class="token comment">// TODO(user): your logic here</span>

        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// SetupWithManager sets up the controller with the Manager.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>GuestbookReconciler<span class="token punctuation">)</span> <span class="token function">SetupWithManager</span><span class="token punctuation">(</span>mgr ctrl<span class="token punctuation">.</span>Manager<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span><span class="token function">NewControllerManagedBy</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">For</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>webappv1<span class="token punctuation">.</span>Guestbook<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Complete</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¾ˆæ˜æ˜¾ï¼Œä¸Šé¢çš„ Reconcile å‡½æ•°æ˜¯ä¸€ä¸ªè°ƒè°å‡½æ•°ï¼Œè¿™æ˜¯è´¯ç©¿å§‹ç»ˆçš„ä¸€ä¸ªè¯è¯­ï¼Œåœ¨ æ˜¾çœ¼çš„æç¤º TODO ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¡¥å……è‡ªå·±çš„é€»è¾‘ã€‚</p>
<p>æˆ‘ä»¬å…·ä½“è§‚å¯Ÿä¸€ä¸‹ PROJECT æ–‡ä»¶ï¼Œå…·ä½“çš„å…ƒæ•°æ®å˜åŒ–ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">git</span> <span class="token function">diff</span> PROJECT
<span class="token function">diff</span> <span class="token parameter variable">--git</span> a/PROJECT b/PROJECT
index a18434c<span class="token punctuation">..</span>3ea38eb <span class="token number">100644</span>
--- a/PROJECT
+++ b/PROJECT
@@ -7,4 +7,14 @@ layout:
 - go.kubebuilder.io/v4
 projectName: guestbook
 repo: my.domain/guestbook
+resources:
+- api:
+    crdVersion: v1
+    namespaced: <span class="token boolean">true</span>
+  controller: <span class="token boolean">true</span>
+  domain: my.domain
+  group: webapp
+  kind: Guestbook
+  path: my.domain/guestbook/api/v1
+  version: v1
 version: <span class="token string">"3"</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœè¦ç¼–è¾‘APIå®šä¹‰ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆæ¸…å•ï¼Œå¦‚è‡ªå®šä¹‰èµ„æºï¼ˆCRï¼‰æˆ–è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDï¼‰</p>
<details class="custom-container details"><summary>CRD å’Œ CR åŒºåˆ«</summary>
<p>è‡ªå®šä¹‰èµ„æºï¼ˆCRï¼‰æ˜¯ Kubernetes ä¸­æ‰©å±• API èµ„æºçš„ä¸€ç§æ–¹å¼ï¼Œå®ƒå…è®¸ç”¨æˆ·è‡ªå®šä¹‰ Kubernetes ä¸­çš„èµ„æºç±»å‹ï¼Œå¹¶ä¸ºå…¶åˆ›å»ºè‡ªå·±çš„ API ç«¯ç‚¹ã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·æˆ– Kubernetes API ä»¥ç¼–ç¨‹æ–¹å¼æ“ä½œ CRã€‚CR å¯ä»¥ç”¨äºä»»ä½•ä¸€ç§ Kubernetes èµ„æºçš„æ‰©å±•ï¼Œä¾‹å¦‚ Podã€Service æˆ– Deploymentã€‚</p>
<p>è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDï¼‰ç”¨äºå®šä¹‰è‡ªå®šä¹‰èµ„æºï¼ˆCRï¼‰ã€‚å®ƒå®šä¹‰äº† CR çš„ç»“æ„ï¼Œå³å®ƒçš„ API è§„èŒƒã€‚CRD ç”¨äºå®šä¹‰ Kubernetes ä¸­çš„æ–° API èµ„æºç±»å‹ã€‚è¿™äº›èµ„æºç±»å‹å¯ä»¥ç”¨äºæ‰©å±• Kubernetesï¼Œä½¿å…¶æ”¯æŒæ›´å¤šçš„èµ„æºç±»å‹å’Œæ“ä½œã€‚CRD æœ¬èº«æ˜¯ä¸€ä¸ª Kubernetes èµ„æºï¼Œå®ƒå¯ä»¥è¢« kubectl æˆ– Kubernetes API ç”¨äºåˆ›å»ºæ–°çš„ CR ç±»å‹ã€‚</p>
<p>å› æ­¤ï¼ŒCR æ˜¯ç”¨æˆ·åˆ›å»ºçš„ Kubernetes èµ„æºç±»å‹ï¼Œè€Œ CRD æ˜¯å®šä¹‰å’Œç®¡ç†è¿™äº›èµ„æºç±»å‹çš„æ–¹å¼ã€‚</p>
</details>
<h3 id="api-å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#api-å®šä¹‰" aria-hidden="true">#</a> API å®šä¹‰</h3>
<p>Kubernetes çš„èµ„æºæœ¬è´¨å°±æ˜¯ä¸€ä¸ª API å¯¹è±¡ï¼Œä¸è¿‡è¿™ä¸ªå¯¹è±¡çš„ æœŸæœ›çŠ¶æ€ è¢« API Service ä¿å­˜åœ¨äº† ETCD ä¸­ï¼ˆæˆ–è€…æ˜¯å¯¹äº k3s æ¥è¯´å¯ä»¥ä¿å­˜åœ¨å…¶ä»–çš„æœ‰çŠ¶æ€æ•°æ®åº“ï¼ŒåŒ…æ‹¬ sqliteã€dqliteã€mysqlâ€¦)ï¼Œç„¶åæä¾› RESTful æ¥å£ç”¨äº æ›´æ–°è¿™äº›å¯¹è±¡ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä¸Šé¢è®²è¿‡ï¼ŒCRD çš„ä»£ç å®šä¹‰ä¸»è¦åœ¨ <code v-pre>api/</code> ç›®å½•ä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£ç ç»“æ„ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ tree api
api
â””â”€â”€ v1
    â”œâ”€â”€ groupversion_info.go
    â”œâ”€â”€ guestbook_types.go
    â””â”€â”€ zz_generated.deepcopy.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>guestbook_types.go</code> æ–‡ä»¶ä¸»è¦çš„å®šä¹‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹ spec ç»“æ„ã€‚</p>
<details class="custom-container details"><summary>Spec ç»“å°¾çš„ç»“æ„ä½“å«ä¹‰</summary>
<p>åœ¨Goè¯­è¨€ä¸­ï¼Œç»“æ„ä½“ä»¥ spec ç»“å°¾è¡¨ç¤ºè¯¥ç»“æ„ä½“æ˜¯ç”¨äºç‰¹å®šç›®çš„çš„è§„èŒƒç»“æ„ä½“ã€‚è¿™ç§å‘½åçº¦å®šé€šå¸¸ç”¨äºæè¿°ä¸€ä¸ªç»“æ„ä½“çš„ç”¨é€”å’ŒåŠŸèƒ½ï¼Œä»¥ä¾¿å¼€å‘äººå‘˜æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨å®ƒã€‚ä¾‹å¦‚ï¼Œ<code v-pre>GuestbookSpec</code>å®šä¹‰äº†æ‰€éœ€çš„ <code v-pre>Guestbook</code> çŠ¶æ€</p>
</details>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// GuestbookSpec defines the desired state of Guestbook</span>
<span class="token keyword">type</span> GuestbookSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span>
        <span class="token comment">// Important: Run "make" to regenerate code after modifying this file</span>

        <span class="token comment">// Foo is an example field of Guestbook. Edit guestbook_types.go to remove/update</span>
        Foo <span class="token builtin">string</span> <span class="token string">`json:"foo,omitempty"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„æ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šï¼ŒFoo æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤æ‰ï¼Œç„¶åæ·»åŠ è‡ªå·±éœ€è¦çš„é…ç½®ã€‚</p>
<p>ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ååˆ©ç”¨ Makefile é‡æ–°ç”Ÿæˆä»£ç ï¼ŒğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	corev1 <span class="token string">"k8s.io/api/core/v1"</span>
    metav1 <span class="token string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> GuestbookSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Replicas <span class="token builtin">int32</span>					<span class="token string">`json:"replicas,omitempty"`</span>
    Template corev1<span class="token punctuation">.</span>PodTemplateSpec	<span class="token string">`json:"template,omitempty"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬åˆ†åˆ«å®šä¹‰äº† ç”¨äºå£°æ˜ Pod å‰¯æœ¬çš„æ•°é‡ã€å’Œç”¨äºç”Ÿæˆ Pod æ¨¡æ¿çš„é…ç½®ã€‚</p>
<p>æœ€åæˆ‘ä»¬ä¹Ÿè¦è®°å½•åˆ° git commit ä¸­ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>â¯ git add .
â¯ git commit -a -s -m "create api"
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="crd-éƒ¨ç½²" tabindex="-1"><a class="header-anchor" href="#crd-éƒ¨ç½²" aria-hidden="true">#</a> CRD éƒ¨ç½²</h3>
<p><strong>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code v-pre>make manifests</code> å‘½ä»¤ç”Ÿæˆ ClusterRole å’Œ CustomResourceDefinition é…ç½®ã€‚</strong></p>
<p><strong>æ£€æŸ¥ git çš„æ›´æ”¹ä¿¡æ¯ï¼š</strong></p>
<blockquote>
<p>å¦‚æœè¦ç¼–è¾‘APIå®šä¹‰ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆæ¸…å•ï¼Œå¦‚è‡ªå®šä¹‰èµ„æºï¼ˆCRï¼‰æˆ–è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDï¼‰</p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">git</span> status
On branch master
Untracked files:
  <span class="token punctuation">(</span>use <span class="token string">"git add &lt;file>..."</span> to include <span class="token keyword">in</span> what will be committed<span class="token punctuation">)</span>
        config/crd/bases/
        config/rbac/role.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªç›®å½•æ–‡ä»¶çš„å˜åŒ–ï¼š</p>
<ul>
<li><code v-pre>config/crd/bases/</code> ç›®å½•ï¼šæ–°å¢ <code v-pre>webapp.my.domain_guestbooks.yaml</code> æ–‡ä»¶ï¼Œè¿™ä¹Ÿæ˜¯ <code v-pre>guestbook</code> ç±»å‹çš„ CRD é…ç½®æ–‡ä»¶ã€‚</li>
<li><code v-pre>config/rbac/role.yaml</code> å®šä¹‰çš„æ˜¯ä¸€ä¸ª ClusterRoleï¼Œä»åå­— manager-role ä¸Šå¤§è‡´ä¹Ÿå¯ä»¥çŒœå‡ºè¿™æ˜¯åé¢ Controller éƒ¨ç½²åå°†å……å½“çš„ â€œ<strong>è§’è‰²</strong>â€ï¼Œå®šä¹‰äº†å¯¹ <code v-pre>guestbook</code> èµ„æºçš„ CURD æ“ä½œã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª Kubernetes çš„ç¯å¢ƒï¼Œä¸ç®¡æ˜¯ Kind &amp; minikube &amp; k3s ä½œä¸ºæµ‹è¯•ç¯å¢ƒä¹Ÿå¥½ï¼Œæˆ‘é€‰æ‹©äº† Kindï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>â¯ kind version
kind v0.18.0-alpha+bc0526729cf900 go1.20.1 linux/amd64
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>âš ï¸ æ§åˆ¶å™¨å°†è‡ªåŠ¨ä½¿ç”¨ kubeconfigæ–‡ä»¶ï¼ˆå³é›†ç¾¤<code v-pre>kubectl cluster-info</code>æ˜¾ç¤ºçš„ä»»ä½•å†…å®¹ï¼‰ã€‚å¦‚æœå‡ºç°é—®é¢˜æŒ‰ç…§å®˜æ–¹çš„æ–¹æ³•å¯ä»¥è‡ªå·±æ‹·è´ kubeconfig æˆ–è€…æ˜¯ è®¾ç½® ç¯å¢ƒå˜é‡ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ <code v-pre>make install</code> å®Œæˆ CRD çš„éƒ¨ç½²è¿‡ç¨‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">make</span> <span class="token function">install</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ğŸ¯ æˆ‘ä»¬åº”è¯¥æ£€æŸ¥ä¸€ä¸ª Makefile ä¸­çš„ <code v-pre>install target</code>ï¼Œæˆ–è®¸å¯ä»¥çœ‹å‡ºæ¥ <code v-pre>install target</code> æ˜¯åŒ…å«  <code v-pre>make manifests</code> å‘½ä»¤çš„ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯åˆ†å¼€æ“ä½œæœ‰åŠ©äºäº†è§£æ•´ä¸ªè¿‡ç¨‹ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># install   Install CRDs into the K8s cluster specified in ~/.kube/config.</span>
.PHONY: <span class="token function">install</span>
install: manifests kustomize <span class="token comment">## Install CRDs into the K8s cluster specified in ~/.kube/config.</span>
        <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE<span class="token variable">)</span></span> build config/crd <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -
      
<span class="token comment"># kustomize Download kustomize locally if necessary. If wrong version is installed, it will be removed before downloading.</span>
.PHONY: kustomize
kustomize: <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE<span class="token variable">)</span></span> <span class="token comment">## Download kustomize locally if necessary. If wrong version is installed, it will be removed before downloading.</span>
<span class="token variable"><span class="token variable">$(</span>KUSTOMIZE<span class="token variable">)</span></span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>
        @if <span class="token builtin class-name">test</span> <span class="token parameter variable">-x</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize version <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE_VERSION<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token punctuation">\</span>
                <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize version is not expected <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE_VERSION<span class="token variable">)</span></span>. Removing it before installing."</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
                <span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize<span class="token punctuation">;</span> <span class="token punctuation">\</span>
        <span class="token keyword">fi</span>
        <span class="token builtin class-name">test</span> <span class="token parameter variable">-s</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token function">curl</span> <span class="token parameter variable">-Ss</span> <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE_INSTALL_SCRIPT<span class="token variable">)</span></span> <span class="token parameter variable">--output</span> install_kustomize.sh <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> install_kustomize.sh <span class="token variable"><span class="token variable">$(</span>subst v,,<span class="token punctuation">$(</span>KUSTOMIZE_VERSION<span class="token punctuation">)</span><span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token function">rm</span> install_kustomize.sh<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ ¡éªŒ</strong>ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ k get crd <span class="token parameter variable">-A</span>
NAME                          CREATED AT
crontabs.stable.example.com   <span class="token number">2023</span>-04-07T09:17:55Z
guestbooks.webapp.my.domain   <span class="token number">2023</span>-04-07T15:42:22Z
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>guestbooks.webapp.my.domain</code> å·²ç»å­˜åœ¨äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰èµ„æºï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code v-pre>k get pod</code> çš„æ–¹å¼æ¥ <code v-pre>k get guestbooks</code></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ k get guestbooks.webapp.my.domain <span class="token parameter variable">-A</span>
No resources found
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œå¹¶æ²¡å‡ºå‡ºç° error ï¼Œè¯´æ˜æç¤ºçš„æ˜¯ kube-apiserver å·²ç»å¯ä»¥è¯†åˆ«è¿™ä¸ªèµ„æºï¼Œåªä¸è¿‡æ²¡æœ‰è¿™ä¸ªèµ„æºçš„å…·ä½“å®ä¾‹ã€‚</p>
<p>è¿è¡Œä½ çš„æ§åˆ¶å™¨ï¼ˆè¿™å°†åœ¨å‰å°è¿è¡Œï¼Œæ‰€ä»¥åˆ‡æ¢åˆ°ä¸€ä¸ªæ–°çš„ ç»ˆç«¯ï¼ˆå¦‚æœä½ æƒ³è®©å®ƒä¿æŒè¿è¡Œï¼‰ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">make</span> run
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="å®‰è£…è‡ªå®šä¹‰èµ„æºçš„å®ä¾‹" tabindex="-1"><a class="header-anchor" href="#å®‰è£…è‡ªå®šä¹‰èµ„æºçš„å®ä¾‹" aria-hidden="true">#</a> å®‰è£…è‡ªå®šä¹‰èµ„æºçš„å®ä¾‹</h3>
<p>å¦‚æœä½ æŒ‰äº†<code v-pre>y</code>åˆ›å»ºèµ„æº <strong>[y/n]</strong>ï¼Œåˆ™ä½ åœ¨ç¤ºä¾‹ä¸­ä¸ºCRDåˆ›å»ºäº†CRï¼ˆå¦‚æœä½ æ›´æ”¹äº† APIå®šä¹‰ï¼‰ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> config/samples/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="åœ¨é›†ç¾¤ä¸Šè¿è¡Œ" tabindex="-1"><a class="header-anchor" href="#åœ¨é›†ç¾¤ä¸Šè¿è¡Œ" aria-hidden="true">#</a> åœ¨é›†ç¾¤ä¸Šè¿è¡Œ</h3>
<p>æ„å»ºé•œåƒå¹¶å°†å…¶æ¨é€åˆ°<code v-pre>IMG</code>æŒ‡å®šçš„ä½ç½®ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">make</span> docker-build docker-push <span class="token assign-left variable">IMG</span><span class="token operator">=</span><span class="token operator">&lt;</span>some-registry<span class="token operator">></span>/<span class="token operator">&lt;</span>project-name<span class="token operator">></span>:tag
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä½¿ç”¨<code v-pre>IMG</code>æŒ‡å®šçš„é•œåƒå°†æ§åˆ¶å™¨éƒ¨ç½²åˆ°é›†ç¾¤ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">make</span> deploy <span class="token assign-left variable">IMG</span><span class="token operator">=</span><span class="token operator">&lt;</span>some-registry<span class="token operator">></span>/<span class="token operator">&lt;</span>project-name<span class="token operator">></span>:tag
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="å¸è½½crd" tabindex="-1"><a class="header-anchor" href="#å¸è½½crd" aria-hidden="true">#</a> å¸è½½CRD</h3>
<p>è¦ä»ç¾¤é›†ä¸­åˆ é™¤CRDï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">make</span> uninstall
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="å–æ¶ˆéƒ¨ç½²-controller" tabindex="-1"><a class="header-anchor" href="#å–æ¶ˆéƒ¨ç½²-controller" aria-hidden="true">#</a> å–æ¶ˆéƒ¨ç½² controller</h3>
<p>å°†æ§åˆ¶å™¨å–æ¶ˆéƒ¨ç½²åˆ°ç¾¤é›†ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">make</span> undeploy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="cr-éƒ¨ç½²" tabindex="-1"><a class="header-anchor" href="#cr-éƒ¨ç½²" aria-hidden="true">#</a> CR éƒ¨ç½²</h2>
<p>æˆ‘ä»¬ä½¿ç”¨ CRD å®šä¹‰äº†ä¸€ä¸ªèµ„æºï¼ŒCR å°±åƒå†™ä¸€ä¸ª Deployment ä¸€æ ·ï¼Œåˆ›å»º <code v-pre>guestbooks</code> åŒæ ·éœ€è¦ä¸€ä¸ª <code v-pre>yaml</code> æ–‡ä»¶ï¼Œå¹¶ä¸”ç¬¦åˆå£°æ˜å¼ã€‚</p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code>â¯ cat config/samples/webapp_v1_guestbook.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> webapp.my.domain/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Guestbook
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> guestbook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> guestbook<span class="token punctuation">-</span>sample
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> guestbook
    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> kustomize
    <span class="token key atrule">app.kubernetes.io/created-by</span><span class="token punctuation">:</span> guestbook
  <span class="token key atrule">name</span><span class="token punctuation">:</span> guestbook<span class="token punctuation">-</span>sample
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># TODO(user): Add fields here</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

â¯ k apply <span class="token punctuation">-</span>f webapp_v1_guestbook.yaml
guestbook.webapp.my.domain/guestbook<span class="token punctuation">-</span>sample created

â¯ k get guestbooks.webapp.my.domain
NAME               AGE
guestbook<span class="token punctuation">-</span>sample   93s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢è¡¨ç¤ºåˆ›å»ºå‡ºæ¥äº† <code v-pre>guestbook-sample </code> å¯¹è±¡ï¼Œä¸è¿‡è¿™ä¸ªæ—¶å€™è¿˜ä¸å¤Ÿï¼Œå› ä¸º Pod è¿˜æ²¡æœ‰è¢«åˆ›å»ºå‡ºæ¥ï¼Œæˆ‘ä»¬ç»§ç»­å®ç°ç›¸åº”çš„æ§åˆ¶å™¨é€»è¾‘ã€‚</p>
<h2 id="guestbook-ç”Ÿæˆçš„ä»£ç å’Œç»“æ„" tabindex="-1"><a class="header-anchor" href="#guestbook-ç”Ÿæˆçš„ä»£ç å’Œç»“æ„" aria-hidden="true">#</a> guestbook ç”Ÿæˆçš„ä»£ç å’Œç»“æ„</h2>
<p>æˆ‘ä»¬è¯¦ç»†è§£é‡Šä¸€ä¸‹ kubebuilder åˆå§‹åŒ–CRDä»¥åŠç›¸å…³çš„æ§åˆ¶å™¨æ¡†æ¶åï¼Œéƒ¨åˆ†çš„ä»£ç ç»“æ„å’Œæºç è§£æã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åº”è¯¥ä»ä¸»å‡½æ•°å¼€å§‹ï¼š main.go</p>
<h3 id="cmd" tabindex="-1"><a class="header-anchor" href="#cmd" aria-hidden="true">#</a> cmd</h3>
<p>main.go ä½œä¸ºå…¥å£å‡½æ•°ï¼Œæ˜¯æˆ‘ä»¬ä¸»è¦çœ‹çš„ã€‚å½“ç„¶ï¼Œè®¸å¯è¯ä¿¡æ¯çœç•¥æ‰äº†~ æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å¤´æ–‡ä»¶ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"flag"</span>
	<span class="token string">"os"</span>

	<span class="token comment">// Import all Kubernetes client auth plugins (e.g. Azure, GCP, OIDC, etc.)</span>
	<span class="token comment">// to ensure that exec-entrypoint and run can make use of them.</span>
	<span class="token boolean">_</span> <span class="token string">"k8s.io/client-go/plugin/pkg/client/auth"</span>

	<span class="token string">"k8s.io/apimachinery/pkg/runtime"</span>
	utilruntime <span class="token string">"k8s.io/apimachinery/pkg/util/runtime"</span>
	clientgoscheme <span class="token string">"k8s.io/client-go/kubernetes/scheme"</span>
	ctrl <span class="token string">"sigs.k8s.io/controller-runtime"</span>
	<span class="token string">"sigs.k8s.io/controller-runtime/pkg/healthz"</span>
	<span class="token string">"sigs.k8s.io/controller-runtime/pkg/log/zap"</span>

	webappv1 <span class="token string">"my.domain/guestbook/api/v1"</span>
	<span class="token string">"my.domain/guestbook/internal/controller"</span>
	<span class="token comment">//+kubebuilder:scaffold:imports</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯ä¸€ç»„æ§åˆ¶å™¨éƒ½éœ€è¦ä¸€ä¸ªSchemeï¼Œå®ƒæä¾›äº†Kindså’Œå®ƒä»¬å¯¹åº”çš„Goç±»å‹ä¹‹é—´çš„æ˜ å°„ã€‚åœ¨ç¼–å†™APIå®šä¹‰æ—¶ï¼Œæˆ‘ä»¬å°†æ›´å¤šåœ°è®¨è®ºKindsï¼Œæ‰€ä»¥ç¨åè¯·è®°ä½è¿™ä¸€ç‚¹ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	scheme   <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	setupLog <span class="token operator">=</span> ctrl<span class="token punctuation">.</span>Log<span class="token punctuation">.</span><span class="token function">WithName</span><span class="token punctuation">(</span><span class="token string">"setup"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	utilruntime<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>clientgoscheme<span class="token punctuation">.</span><span class="token function">AddToScheme</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>

	utilruntime<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>webappv1<span class="token punctuation">.</span><span class="token function">AddToScheme</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">//+kubebuilder:scaffold:scheme</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>runtime.Scheme</code> æ˜¯ Kubernetes ä¸­å¯¹è±¡çš„ç¼–è§£ç å™¨æ³¨å†Œè¡¨ï¼Œç”¨äºå°†å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œå¹¶å°†å­—èŠ‚æ•°ç»„ååºåˆ—åŒ–ä¸ºå¯¹è±¡ã€‚æ‰€æœ‰ Kubernetes API å¯¹è±¡éƒ½å¿…é¡»æ³¨å†Œåˆ° <code v-pre>runtime.Scheme</code> ä¸­ï¼Œä»¥ä¾¿åœ¨å­˜å‚¨åˆ° etcd æˆ–å‘é€åˆ° API Server æ—¶è¿›è¡Œæ­£ç¡®çš„ç¼–è§£ç ã€‚</p>
<p>å¯ä»¥é€šè¿‡è°ƒç”¨ <code v-pre>scheme.AddKnownTypes()</code> æ–¹æ³•å‘ <code v-pre>runtime.Scheme</code> ä¸­æ³¨å†Œæ–°çš„ API å¯¹è±¡ç±»å‹ã€‚</p>
<p>æˆ‘ä»¬å®ä¾‹åŒ–äº†ä¸¤ä¸ªç®¡ç†å™¨ï¼Œå®ƒè·Ÿè¸ªæ‰€æœ‰æ§åˆ¶å™¨çš„è¿è¡Œæƒ…å†µï¼Œå¹¶ä¸ºAPIæœåŠ¡å™¨è®¾ç½®å…±äº«ç¼“å­˜å’Œå®¢æˆ·æœºã€‚</p>
<p>âš ï¸ æ³¨æ„ï¼šè¿™é‡Œæœ‰ <code v-pre>//+kubebuilder:scaffold:scheme</code> ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„äº‹æƒ…ã€‚</p>
<p>å‰©ä¸‹å°±æ˜¯æœ€æ ¸å¿ƒçš„ <code v-pre>main()</code> å‡½æ•°ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> metricsAddr <span class="token builtin">string</span>
    <span class="token keyword">var</span> enableLeaderElection <span class="token builtin">bool</span>
    <span class="token keyword">var</span> probeAddr <span class="token builtin">string</span>
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>metricsAddr<span class="token punctuation">,</span> <span class="token string">"metrics-bind-address"</span><span class="token punctuation">,</span> <span class="token string">":8080"</span><span class="token punctuation">,</span> <span class="token string">"The address the metric endpoint binds to."</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>probeAddr<span class="token punctuation">,</span> <span class="token string">"health-probe-bind-address"</span><span class="token punctuation">,</span> <span class="token string">":8081"</span><span class="token punctuation">,</span> <span class="token string">"The address the probe endpoint binds to."</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>enableLeaderElection<span class="token punctuation">,</span> <span class="token string">"leader-elect"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">"Enable leader election for controller manager. "</span><span class="token operator">+</span>
            <span class="token string">"Enabling this will ensure there is only one active controller manager."</span><span class="token punctuation">)</span>
    opts <span class="token operator">:=</span> zap<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
        Development<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    opts<span class="token punctuation">.</span><span class="token function">BindFlags</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    ctrl<span class="token punctuation">.</span><span class="token function">SetLogger</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">UseFlagOptions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    mgr<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span><span class="token function">GetConfigOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctrl<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
        Scheme<span class="token punctuation">:</span>                 scheme<span class="token punctuation">,</span>
        MetricsBindAddress<span class="token punctuation">:</span>     metricsAddr<span class="token punctuation">,</span>
        Port<span class="token punctuation">:</span>                   <span class="token number">9443</span><span class="token punctuation">,</span>
        HealthProbeBindAddress<span class="token punctuation">:</span> probeAddr<span class="token punctuation">,</span>
        LeaderElection<span class="token punctuation">:</span>         enableLeaderElection<span class="token punctuation">,</span>
        LeaderElectionID<span class="token punctuation">:</span>       <span class="token string">"80807133.tutorial.kubebuilder.io"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        setupLog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to start manager"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‰é¢æ— éå°±æ˜¯å®šä¹‰äº†ä¸€ä¸ª flag å¹¶ä¸”åˆå§‹åŒ–ã€‚å¹¶ä¸”äº¤ç»™<code v-pre>Parse</code>è§£æ<code v-pre>os.Args[1:]</code>ä¸­çš„å‘½ä»¤è¡Œæ ‡å¿—ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œ <code v-pre>Manager</code> å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é™åˆ¶æ‰€æœ‰æ§åˆ¶å™¨å°†ç›‘è§†èµ„æºçš„å‘½åç©ºé—´ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code> mgr<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span><span class="token function">GetConfigOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctrl<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
     Scheme<span class="token punctuation">:</span>                 scheme<span class="token punctuation">,</span>
     Namespace<span class="token punctuation">:</span>              namespace<span class="token punctuation">,</span>
     MetricsBindAddress<span class="token punctuation">:</span>     metricsAddr<span class="token punctuation">,</span>
     Port<span class="token punctuation">:</span>                   <span class="token number">9443</span><span class="token punctuation">,</span>
     HealthProbeBindAddress<span class="token punctuation">:</span> probeAddr<span class="token punctuation">,</span>
     LeaderElection<span class="token punctuation">:</span>         enableLeaderElection<span class="token punctuation">,</span>
     LeaderElectionID<span class="token punctuation">:</span>       <span class="token string">"80807133.tutorial.kubebuilder.io"</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ç¤ºä¾‹å°†é¡¹ç›®çš„èŒƒå›´æ›´æ”¹ä¸ºå•ä¸ª <code v-pre>Namespace</code> ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜å»ºè®®å°†é»˜è®¤çš„ <code v-pre>ClusterRole</code> å’Œ <code v-pre>ClusterRoleBinding</code> åˆ†åˆ«æ›¿æ¢ä¸º <code v-pre>Role</code> å’Œ <code v-pre>RoleBinding</code> ï¼Œä»è€Œå°†æä¾›çš„æˆæƒé™åˆ¶åœ¨æ­¤å‘½åç©ºé—´ã€‚è¿™æ ·æ¥è¯´æƒé™å°ä¸€äº›ï¼Œåœ¨ RBAC ä¸­ä»‹ç»è¿‡è¿™éƒ¨åˆ†ã€‚</p>
<p>ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <code v-pre>MultiNamespacedCacheBuilder</code> æ¥ç›‘è§†ç‰¹æ€§çš„å‘½åç©ºé—´å­é›†ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">var</span> namespaces <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// List of Namespaces</span>

mgr<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span><span class="token function">GetConfigOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctrl<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
    Scheme<span class="token punctuation">:</span>                 scheme<span class="token punctuation">,</span>
    NewCache<span class="token punctuation">:</span>               cache<span class="token punctuation">.</span><span class="token function">MultiNamespacedCacheBuilder</span><span class="token punctuation">(</span>namespaces<span class="token punctuation">)</span><span class="token punctuation">,</span>
    MetricsBindAddress<span class="token punctuation">:</span>     fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%d"</span><span class="token punctuation">,</span> metricsHost<span class="token punctuation">,</span> metricsPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Port<span class="token punctuation">:</span>                   <span class="token number">9443</span><span class="token punctuation">,</span>
    HealthProbeBindAddress<span class="token punctuation">:</span> probeAddr<span class="token punctuation">,</span>
    LeaderElection<span class="token punctuation">:</span>         enableLeaderElection<span class="token punctuation">,</span>
    LeaderElectionID<span class="token punctuation">:</span>       <span class="token string">"80807133.tutorial.kubebuilder.io"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œå°±æ˜¯ä¸€äº›é”™è¯¯å¤„ç†ï¼Œå’Œå¼€å§‹æ­å»ºæˆ‘ä»¬çš„APIäº†ï¼</strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// +kubebuilder:scaffold:builder</span>

<span class="token keyword">if</span> err <span class="token operator">:=</span> mgr<span class="token punctuation">.</span><span class="token function">AddHealthzCheck</span><span class="token punctuation">(</span><span class="token string">"healthz"</span><span class="token punctuation">,</span> healthz<span class="token punctuation">.</span>Ping<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    setupLog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to set up health check"</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> mgr<span class="token punctuation">.</span><span class="token function">AddReadyzCheck</span><span class="token punctuation">(</span><span class="token string">"readyz"</span><span class="token punctuation">,</span> healthz<span class="token punctuation">.</span>Ping<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    setupLog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to set up ready check"</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

setupLog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"starting manager"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> mgr<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    setupLog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"problem running manager"</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="groups-versions-kinds-and-resources" tabindex="-1"><a class="header-anchor" href="#groups-versions-kinds-and-resources" aria-hidden="true">#</a> groups, versions, kinds, and resources</h2>
<p>å½“æˆ‘ä»¬è°ˆè®ºKubernetesä¸­çš„APIæ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨4ä¸ªæœ¯è¯­ï¼šç»„ã€ç‰ˆæœ¬ã€ç§ç±»å’Œèµ„æºã€‚</p>
<p>æ²¡é”™ï¼Œæˆ‘ä»¬åœ¨ <a href="https://docker.nsddd.top/Cloud-Native-k8s/" target="_blank" rel="noopener noreferrer">https://docker.nsddd.top/Cloud-Native-k8s/<ExternalLinkIcon/></a> ä¸­ä»‹ç»è¿‡å¾ˆå¤šå…³äº GVK å’Œ GVR çš„ä»‹ç»ï¼Œä¸ºä»€ä¹ˆåœ¨ Kubebuilder ä¸­å°¤å…¶éœ€è¦å†æä¸€æ¬¡ã€‚</p>
<p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªç‰¹å®šçš„ç»„ç‰ˆæœ¬ä¸­å¼•ç”¨ä¸€ä¸ªç§ç±»æ—¶ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸ºGroupVersionKindï¼Œæˆ–ç®€ç§°ä¸ºGVKã€‚èµ„æºå’ŒGVRä¹Ÿæ˜¯å¦‚æ­¤ã€‚æˆ‘ä»¬å¾ˆå¿«å°±ä¼šçœ‹åˆ°ï¼Œæ¯ä¸ªGVKå¯¹åº”äºåŒ…ä¸­ç»™å®šçš„ root Go typeã€‚èµ°è¿›æºç ï¼Œä½“ä¼šè¿™ç§æ„Ÿè§‰~</p>
<h3 id="create-an-api-1" tabindex="-1"><a class="header-anchor" href="#create-an-api-1" aria-hidden="true">#</a> create an API</h3>
<p>æˆ‘ä»¬åœ¨å‰é¢åˆ›å»ºè¿‡ API ï¼Œ<code v-pre>kubebuilder create api --group webapp --version v1 --kind Guestbook</code> å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ª ç»„ä¸º <code v-pre>webapp</code>ï¼Œç‰ˆæœ¬ä¸º <code v-pre>v1</code>ï¼Œç±»å‹ä¸º <code v-pre>Guestbook</code> çš„API èµ„æºå¯¹è±¡ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨çš„å‘½ä»¤æ˜¯ <code v-pre>create api</code>ï¼Œæ­¤å‘½ä»¤çš„ç›®æ ‡æ˜¯ä¸ºæˆ‘ä»¬çš„åŒç±»åˆ›å»ºè‡ªå®šä¹‰èµ„æºï¼ˆCRï¼‰å’Œè‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼ˆCRDï¼‰ã€‚æˆ‘ç¿»å¼€äº† Kubebuilder çš„æºç éƒ¨åˆ†ï¼š</p>
<p>åœ¨ <code v-pre>pkg/cli</code> ç›®å½•ä¸‹é¢ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†å…¥å£ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// addSubcommands returns a root command with a subcommand tree reflecting the</span>
<span class="token comment">// current project's state.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>CLI<span class="token punctuation">)</span> <span class="token function">addSubcommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// add the alpha command if it has any subcommands enabled</span>
	c<span class="token punctuation">.</span><span class="token function">addAlphaCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// kubebuilder completion</span>
	<span class="token comment">// Only add completion if requested</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>completionCommand <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newCompletionCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// kubebuilder create</span>
	createCmd <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">newCreateCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// kubebuilder create api</span>
	createCmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newCreateAPICmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	createCmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newCreateWebhookCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> createCmd<span class="token punctuation">.</span><span class="token function">HasSubCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>createCmd<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// kubebuilder edit</span>
	c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newEditCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// kubebuilder init</span>
	c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newInitCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// kubebuilder version</span>
	<span class="token comment">// Only add version if a version string was provided</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>version <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newVersionCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š</p>
<blockquote>
<p>é€šè¿‡ <code v-pre>newCreateCmd</code> åˆ›å»ºäº†ä¸€ä¸ª <code v-pre>create</code> å‘½ä»¤ï¼Œå¹¶ä¸”é€šè¿‡ <code v-pre>newCreateAPICmd</code> å’Œ <code v-pre>newCreateWebhookCmd</code> ç»‘å®šäº† <code v-pre>api</code> å’Œ <code v-pre>webhook</code>.</p>
</blockquote>
<p><code v-pre>webhook</code> æ˜¯ä¸€ä¸ªé’©å­ï¼Œhook åœ¨ Kubernetes ä¸­éšå¤„å¯è§ï¼Œå¯ä»¥ä½¿ç”¨ Webhook æ¥éªŒè¯ CRD å¯¹è±¡çš„è§„èŒƒæ˜¯å¦æ­£ç¡®ï¼Œå¹¶è®¾ç½®é»˜è®¤å€¼ï¼Œä»¥ç¡®ä¿ CRD å¯¹è±¡çš„æ­£ç¡®æ€§ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆè¦åˆ›å»º-api" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆè¦åˆ›å»º-api" aria-hidden="true">#</a> ä¸ºä»€ä¹ˆè¦åˆ›å»º APIï¼Ÿ</h3>
<p>æ–°çš„APIæ˜¯æˆ‘ä»¬å‘Kubernetesæ•™æˆè‡ªå®šä¹‰å¯¹è±¡çš„æ–¹å¼ã€‚Goç»“æ„ä½“ç”¨äºç”Ÿæˆä¸€ä¸ªCRDï¼Œå…¶ä¸­åŒ…æ‹¬æ•°æ®çš„æ¨¡å¼ä»¥åŠè·Ÿè¸ªæ•°æ®ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„æ–°ç±»å‹è¢«ç§°ä¸ºä»€ä¹ˆã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºæˆ‘ä»¬çš„è‡ªå®šä¹‰å¯¹è±¡çš„å®ä¾‹ï¼Œè¿™äº›å¯¹è±¡å°†ç”±æˆ‘ä»¬çš„æ§åˆ¶å™¨ç®¡ç†ã€‚</p>
<p>æˆ‘ä»¬çš„APIå’Œèµ„æºä»£è¡¨æˆ‘ä»¬åœ¨é›†ç¾¤ä¸Šçš„è§£å†³æ–¹æ¡ˆã€‚åŸºæœ¬ä¸Šï¼ŒCRDæ˜¯æˆ‘ä»¬å®šåˆ¶å¯¹è±¡çš„å®šä¹‰ï¼Œè€ŒCRæ˜¯å®ƒçš„å®ä¾‹ã€‚å°±æ¯”å¦‚è¯´ä¸Šé¢ æˆ‘ä»¬ é€šè¿‡ kubebuilder å®šä¹‰äº†ä¸€ä¸ª <code v-pre>guestbooks.webapp.my.domain</code>  çš„ CRDï¼Œç„¶åå†é€šè¿‡ å£°æ˜å¼ yaml æ–‡ä»¶ç¼–å†™ CRï¼Œå¹¶ä¸”åˆ›å»º CRã€‚</p>
<blockquote>
<p>å½“ç„¶å®˜æ–¹æœ‰ä¸€ä¸ªæ›´å¥½ç†è§£çš„ä¾‹å­ï¼šç›®æ ‡æ˜¯è®©åº”ç”¨ç¨‹åºåŠå…¶æ•°æ®åº“åœ¨Kuberneteså¹³å°ä¸Šè¿è¡Œã€‚ç„¶åï¼Œä¸€ä¸ªCRDå¯ä»¥è¡¨ç¤ºAppï¼Œè€Œå¦ä¸€ä¸ªCRDå¯ä»¥è¡¨ç¤ºDBã€‚</p>
<p>é€šè¿‡ä½¿ç”¨ä¸€ä¸ªCRDæè¿°åº”ç”¨ç¨‹åºï¼Œå¦ä¸€ä¸ªCRDæè¿°æ•°æ®åº“ï¼Œæˆ‘ä»¬ä¸ä¼šæŸå®³å°è£…ã€å•ä¸€è´£ä»»åŸåˆ™å’Œå†…èšç­‰æ¦‚å¿µã€‚</p>
<p>ç ´åè¿™äº›æ¦‚å¿µå¯èƒ½ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„å‰¯ä½œç”¨ï¼Œä¾‹å¦‚éš¾ä»¥æ‰©å±•ã€é‡ç”¨æˆ–ç»´æŠ¤ç­‰ã€‚</p>
</blockquote>
<h3 id="single-group-to-multi-group" tabindex="-1"><a class="header-anchor" href="#single-group-to-multi-group" aria-hidden="true">#</a> Single Group to Multi-Group</h3>
<p>åœ¨<code v-pre>Kubebuilder v2 scaffolding</code>çš„åˆå§‹ç‰ˆæœ¬ä¸­ï¼ˆä»Kubebuilder v2.0.0å¼€å§‹ï¼‰ä¸å­˜åœ¨å¤šç»„<code v-pre>scaffolding</code>æ”¯æŒã€‚</p>
<p>è¦æ›´æ”¹é¡¹ç›®çš„å¸ƒå±€ä»¥æ”¯æŒå¤šç»„ï¼Œè¯·è¿è¡Œå‘½ä»¤ <code v-pre>kubebuilder edit --multigroup=true</code> ã€‚ä¸€æ—¦åˆ‡æ¢åˆ°å¤šç»„å¸ƒå±€ï¼Œæ–°çš„Kindså°†åœ¨æ–°å¸ƒå±€ä¸­ç”Ÿæˆï¼Œä½†éœ€è¦é¢å¤–çš„æ‰‹åŠ¨å·¥ä½œå°†æ—§çš„APIç»„ç§»åŠ¨åˆ°æ–°å¸ƒå±€ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥æ·»åŠ ä¸€ä¸ª <strong>æ–°çš„ API</strong></p>
<h3 id="add-new-api" tabindex="-1"><a class="header-anchor" href="#add-new-api" aria-hidden="true">#</a> add new api</h3>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ kubebuilder create api <span class="token parameter variable">--group</span> batch <span class="token parameter variable">--version</span> v1 <span class="token parameter variable">--kind</span> CronJob
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æŒ‰ä¸‹ <code v-pre>y</code> é”®ï¼Œé€‰æ‹©â€œåˆ›å»ºèµ„æºâ€å’Œâ€œåˆ›å»ºæ§åˆ¶å™¨â€ã€‚</p>
<p>ç¬¬ä¸€æ¬¡ä¸ºæ¯ä¸ªç»„ç‰ˆæœ¬è°ƒç”¨æ­¤å‘½ä»¤æ—¶ï¼Œå®ƒå°†ä¸ºæ–°çš„ç»„ç‰ˆæœ¬åˆ›å»ºä¸€ä¸ªç›®å½•ã€‚</p>
<p>åœ¨æœ¬ä¾‹ä¸­ï¼Œåˆ›å»ºäº†ä¸ <code v-pre>batch.tutorial.kubebuilder.io/v1</code> å¯¹åº”çš„ <code v-pre>api/v1/</code> ç›®å½•ï¼ˆè¿˜è®°å¾—æˆ‘ä»¬ä¸€å¼€å§‹çš„ <code v-pre>--domain</code> --domainè®¾ç½®å—ï¼Ÿï¼‰ã€‚</p>
<p>å®ƒè¿˜ä¸ºæˆ‘ä»¬çš„ <code v-pre>CronJob</code> Kindæ·»åŠ äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œ <code v-pre>api/v1/cronjob_types.go</code> ã€‚æ¯æ¬¡æˆ‘ä»¬è°ƒç”¨ä¸åŒç±»å‹çš„å‘½ä»¤æ—¶ï¼Œå®ƒéƒ½ä¼šæ·»åŠ ä¸€ä¸ªç›¸åº”çš„æ–°æ–‡ä»¶ã€‚</p>
<p>æˆ‘ä»¬çš„å‡ºå‘ç‚¹å¾ˆç®€å•ï¼šæˆ‘ä»¬å¯¼å…¥ <code v-pre>meta/v1</code> APIç»„ï¼Œå®ƒé€šå¸¸ä¸ä¼šè‡ªå·±æš´éœ²ï¼Œè€Œæ˜¯åŒ…å«æ‰€æœ‰Kubernetes Kindé€šç”¨çš„å…ƒæ•°æ®ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> v1

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    metav1 <span class="token string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ºSpecå’ŒStatus of our Kindå®šä¹‰ç±»å‹ã€‚<strong>Kubernetesçš„åŠŸèƒ½æ˜¯å°†æœŸæœ›çš„çŠ¶æ€ï¼ˆ <code v-pre>Spec</code> ï¼‰ä¸å®é™…çš„é›†ç¾¤çŠ¶æ€ï¼ˆå…¶ä»–å¯¹è±¡çš„ <code v-pre>Status</code> ï¼‰å’Œå¤–éƒ¨çŠ¶æ€è¿›è¡Œåè°ƒï¼Œç„¶åè®°å½•å®ƒæ‰€è§‚å¯Ÿåˆ°çš„ï¼ˆ <code v-pre>Status</code> ï¼‰</strong>ã€‚å› æ­¤ï¼Œæ¯ä¸ªå‡½æ•°å¯¹è±¡éƒ½åŒ…æ‹¬specå’Œstatusã€‚ä¸€äº›ç±»å‹ï¼Œæ¯”å¦‚ <code v-pre>ConfigMap</code> ï¼Œä¸éµå¾ªè¿™ç§æ¨¡å¼ï¼Œå› ä¸ºå®ƒä»¬ä¸ç¼–ç æ‰€éœ€çš„çŠ¶æ€ï¼Œä½†å¤§å¤šæ•°ç±»å‹éƒ½æ˜¯è¿™æ ·ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// CronJobSpec defines the desired state of CronJob</span>
<span class="token keyword">type</span> CronJobSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span>
    <span class="token comment">// Important: Run "make" to regenerate code after modifying this file</span>
<span class="token punctuation">}</span>

<span class="token comment">// CronJobStatus defines the observed state of CronJob</span>
<span class="token keyword">type</span> CronJobStatus <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</span>
    <span class="token comment">// Important: Run "make" to regenerate code after modifying this file</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰å¯¹åº”äºå®é™…Kindçš„ç±»å‹ï¼Œ <code v-pre>CronJob</code> å’Œ <code v-pre>CronJobList</code> ã€‚ <code v-pre>CronJob</code> æ˜¯æˆ‘ä»¬çš„æ ¹ç±»å‹ï¼Œå®ƒæè¿°äº† <code v-pre>CronJob</code> ç±»å‹ã€‚åƒæ‰€æœ‰Kuberneteså¯¹è±¡ä¸€æ ·ï¼Œå®ƒåŒ…å« <code v-pre>TypeMeta</code> ï¼ˆæè¿°APIç‰ˆæœ¬å’ŒKindï¼‰ï¼Œè¿˜åŒ…å« <code v-pre>ObjectMeta</code> ï¼Œå®ƒåŒ…å«åç§°ï¼Œå‘½åç©ºé—´å’Œæ ‡ç­¾ç­‰å†…å®¹ã€‚</p>
<p><code v-pre>CronJobList</code> åªæ˜¯å¤šä¸ª <code v-pre>CronJob</code> çš„å®¹å™¨ã€‚å®ƒæ˜¯åœ¨æ‰¹é‡æ“ä½œä¸­ä½¿ç”¨çš„ç±»å‹ï¼Œå¦‚LISTã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä»ä¸ä¿®æ”¹è¿™ä¸¤ä¸ªå±æ€§ä¸­çš„ä»»ä½•ä¸€ä¸ª--æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨Specæˆ–Statusä¸­ã€‚</p>
<p>è¿™ä¸ªå°å°çš„ <code v-pre>+kubebuilder:object:root</code> æ³¨é‡Šè¢«ç§°ä¸ºæ ‡è®°ã€‚æˆ‘ä»¬å°†åœ¨ç¨åçœ‹åˆ°æ›´å¤šï¼Œä½†è¦çŸ¥é“å®ƒä»¬ä½œä¸ºé¢å¤–çš„å…ƒæ•°æ®ï¼Œå‘Šè¯‰æ§åˆ¶å™¨å·¥å…·ï¼ˆæˆ‘ä»¬çš„ä»£ç å’ŒYAMLç”Ÿæˆå™¨ï¼‰é¢å¤–çš„ä¿¡æ¯ã€‚è¿™ä¸ªç‰¹å®šçš„ç±»å‹å‘Šè¯‰ <code v-pre>object</code> ç”Ÿæˆå™¨è¿™ä¸ªç±»å‹ä»£è¡¨ä¸€ä¸ªKindã€‚ç„¶åï¼Œ <code v-pre>object</code> ç”Ÿæˆå™¨ä¸ºæˆ‘ä»¬ç”Ÿæˆ <code v-pre>runtime.Object</code> æ¥å£çš„å®ç°ï¼Œè¿™æ˜¯æ‰€æœ‰è¡¨ç¤ºKindsçš„ç±»å‹éƒ½å¿…é¡»å®ç°çš„æ ‡å‡†æ¥å£ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//+kubebuilder:object:root=true</span>
<span class="token comment">//+kubebuilder:subresource:status</span>

<span class="token comment">// CronJob is the Schema for the cronjobs API</span>
<span class="token keyword">type</span> CronJob <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    metav1<span class="token punctuation">.</span>TypeMeta   <span class="token string">`json:",inline"`</span>
    metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">`json:"metadata,omitempty"`</span>

    Spec   CronJobSpec   <span class="token string">`json:"spec,omitempty"`</span>
    Status CronJobStatus <span class="token string">`json:"status,omitempty"`</span>
<span class="token punctuation">}</span>

<span class="token comment">//+kubebuilder:object:root=true</span>

<span class="token comment">// CronJobList contains a list of CronJob</span>
<span class="token keyword">type</span> CronJobList <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    metav1<span class="token punctuation">.</span>TypeMeta <span class="token string">`json:",inline"`</span>
    metav1<span class="token punctuation">.</span>ListMeta <span class="token string">`json:"metadata,omitempty"`</span>
    Items           <span class="token punctuation">[</span><span class="token punctuation">]</span>CronJob <span class="token string">`json:"items"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åï¼Œæˆ‘ä»¬å°†Goç±»å‹æ·»åŠ åˆ°APIç»„ã€‚è¿™å…è®¸æˆ‘ä»¬å°†æ­¤APIç»„ä¸­çš„ç±»å‹æ·»åŠ åˆ°ä»»ä½• Scheme ä¸­ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SchemeBuilder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CronJob<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>CronJobList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="controller" tabindex="-1"><a class="header-anchor" href="#controller" aria-hidden="true">#</a> controller</h2>
<p>ä¸€å¥è¯æè¿°ï¼šControllers are the core of Kubernetes, and of any operator</p>
<p>æ§åˆ¶å™¨çš„å·¥ä½œæ˜¯ç¡®ä¿ï¼Œå¯¹äºä»»ä½•ç»™å®šçš„å¯¹è±¡ï¼Œä¸–ç•Œçš„å®é™…çŠ¶æ€ï¼ˆåŒ…æ‹¬é›†ç¾¤çŠ¶æ€ï¼Œä»¥åŠæ½œåœ¨çš„å¤–éƒ¨çŠ¶æ€ï¼Œå¦‚Kubeletçš„è¿è¡Œå®¹å™¨æˆ–äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨ï¼‰ä¸å¯¹è±¡ä¸­æ‰€éœ€çš„çŠ¶æ€ç›¸åŒ¹é…ã€‚</p>
<p>æ¯ä¸ªæ§åˆ¶å™¨ä¸“æ³¨äºä¸€ä¸ª root Kindï¼Œä½†å¯ä»¥ä¸å…¶ä»–Kindäº¤äº’ã€‚</p>
<p>æˆ‘ä»¬ç§°è¿™ä¸ªè¿‡ç¨‹ä¸ºå’Œè§£ï¼ˆ <em>reconciling</em>ï¼‰ã€‚</p>
<p>åœ¨controller-runtimeä¸­ï¼Œå®ç°ç‰¹å®šç±»å‹åè°ƒçš„é€»è¾‘ç§°ä¸ºReconcilerã€‚reconcilerè·å–å¯¹è±¡çš„åç§°ï¼Œå¹¶è¿”å›æ˜¯å¦éœ€è¦é‡è¯•ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœå‡ºç°é”™è¯¯æˆ–å‘¨æœŸæ€§æ§åˆ¶å™¨ï¼Œå¦‚HorizontalPodAutoscalerï¼‰ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä»ä¸€äº›æ ‡å‡†çš„å¯¼å…¥å¼€å§‹ã€‚å’Œå‰é¢ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦æ ¸å¿ƒæ§åˆ¶å™¨è¿è¡Œæ—¶åº“ï¼Œä»¥åŠå®¢æˆ·ç«¯åŒ…å’ŒAPIç±»å‹çš„åŒ…ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> controllers

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>

    <span class="token string">"k8s.io/apimachinery/pkg/runtime"</span>
    ctrl <span class="token string">"sigs.k8s.io/controller-runtime"</span>
    <span class="token string">"sigs.k8s.io/controller-runtime/pkg/client"</span>
    <span class="token string">"sigs.k8s.io/controller-runtime/pkg/log"</span>

    batchv1 <span class="token string">"tutorial.kubebuilder.io/project/api/v1"</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œkubebuilderä¸ºæˆ‘ä»¬æ­å»ºäº†ä¸€ä¸ªåŸºæœ¬çš„reconcilerç»“æ„ã€‚å‡ ä¹æ¯ä¸ªåè°ƒå™¨éƒ½éœ€è¦æ—¥å¿—ï¼Œå¹¶ä¸”éœ€è¦èƒ½å¤Ÿè·å–å¯¹è±¡ï¼Œå› æ­¤è¿™äº›éƒ½æ˜¯å¼€ç®±å³ç”¨çš„ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// CronJobReconciler reconciles a CronJob object</span>
<span class="token keyword">type</span> CronJobReconciler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span>Client
    Scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¤§å¤šæ•°æ§åˆ¶å™¨æœ€ç»ˆéƒ½åœ¨é›†ç¾¤ä¸Šè¿è¡Œï¼Œå› æ­¤å®ƒä»¬éœ€è¦RBACæƒé™ï¼Œæˆ‘ä»¬ä½¿ç”¨controller-tools RBACæ ‡è®°æ¥æŒ‡å®šè¿™äº›æƒé™ã€‚è¿™äº›æ˜¯è¿è¡Œæ‰€éœ€çš„æœ€ä½æƒé™ã€‚å½“æˆ‘ä»¬æ·»åŠ æ›´å¤šåŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬å°†éœ€è¦é‡æ–°è®¿é—®è¿™äº›ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=get;list;watch;create;update;patch;delete</span>
<span class="token comment">// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/status,verbs=get;update;patch</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é€šè¿‡controller-genä»ä¸Šè¿°æ ‡è®°ç”Ÿæˆ <code v-pre>config/rbac/role.yaml</code> å¤„çš„ <code v-pre>ClusterRole</code> æ¸…å•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">make</span> manifests
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="å®ç°-controller" tabindex="-1"><a class="header-anchor" href="#å®ç°-controller" aria-hidden="true">#</a> å®ç° Controller</h3>
<p>æˆ‘ä»¬é€šè¿‡å®ç° Controller é€»è¾‘å»åˆ›å»º Podï¼Œåœ¨ <code v-pre>internal/controller/guestbook_controller.go</code></p>
<p>æˆ‘ä»¬çš„CronJobæ§åˆ¶å™¨çš„åŸºæœ¬é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li>åŠ è½½å‘½åçš„ CronJob</li>
<li>åˆ—å‡ºæ‰€æœ‰æ´»åŠ¨ jobs å¹¶æ›´æ–°çŠ¶æ€</li>
<li>æ ¹æ®å†å²é™åˆ¶æ¸…ç† history limits</li>
<li>æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦è¢«æš‚åœï¼ˆå¦‚æœæ˜¯ï¼Œä¸è¦åšä»»ä½•å…¶ä»–äº‹æƒ…ï¼‰</li>
<li>è·å–ä¸‹ä¸€æ¬¡è®¡åˆ’è¿è¡Œ</li>
<li>è¿è¡Œä¸€ä¸ªæ–°çš„ jobï¼Œå¦‚æœå®ƒæ˜¯æŒ‰è®¡åˆ’è¿›è¡Œçš„ï¼Œæ²¡æœ‰è¶…è¿‡æˆªæ­¢æ—¥æœŸï¼Œä¹Ÿæ²¡æœ‰è¢«æˆ‘ä»¬çš„å¹¶å‘ç­–ç•¥é˜»å¡</li>
<li>å½“æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ jobï¼ˆè‡ªåŠ¨å®Œæˆï¼‰æˆ–è€…åˆ°äº†ä¸‹ä¸€ä¸ªè®¡åˆ’è¿è¡Œçš„æ—¶é—´æ—¶ï¼Œé‡æ–°æ’é˜Ÿã€‚</li>
</ol>
<p>æˆ‘ä»¬å…ˆä»è¿›å£å¼€å§‹ã€‚ä¸‹é¢ä½ ä¼šçœ‹åˆ°ï¼Œæˆ‘ä»¬éœ€è¦æ¯”é‚£äº›è„šæ‰‹æ¶æ›´å¤šçš„è¿›å£ã€‚æˆ‘ä»¬å°†åœ¨ä½¿ç”¨æ—¶è®¨è®ºæ¯ä¸€ä¸ªã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> controllers

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"sort"</span>
    <span class="token string">"time"</span>

    <span class="token string">"github.com/robfig/cron"</span>
    kbatch <span class="token string">"k8s.io/api/batch/v1"</span>
    corev1 <span class="token string">"k8s.io/api/core/v1"</span>
    metav1 <span class="token string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span>
    <span class="token string">"k8s.io/apimachinery/pkg/runtime"</span>
    ref <span class="token string">"k8s.io/client-go/tools/reference"</span>
    ctrl <span class="token string">"sigs.k8s.io/controller-runtime"</span>
    <span class="token string">"sigs.k8s.io/controller-runtime/pkg/client"</span>
    <span class="token string">"sigs.k8s.io/controller-runtime/pkg/log"</span>

    batchv1 <span class="token string">"tutorial.kubebuilder.io/project/api/v1"</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ—¶é’Ÿï¼Œè¿™å°†å…è®¸æˆ‘ä»¬åœ¨æµ‹è¯•ä¸­ä¼ªé€ æ—¶é—´ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// CronJobReconciler reconciles a CronJob object</span>
<span class="token keyword">type</span> CronJobReconciler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span>Client
    Scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme
    Clock
<span class="token punctuation">}</span>
<span class="token comment">// Clock</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å°†æ¨¡æ‹Ÿæ—¶é’Ÿï¼Œä»¥ä¾¿åœ¨æµ‹è¯•æ—¶æ›´å®¹æ˜“åœ¨æ—¶é—´ä¸Šè·³è·ƒï¼Œâ€œçœŸå®çš„â€ æ—¶é’Ÿåªæ˜¯è°ƒç”¨ <code v-pre>time.Now</code> ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> realClock <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token boolean">_</span> realClock<span class="token punctuation">)</span> <span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time <span class="token punctuation">{</span> <span class="token keyword">return</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token comment">// clock knows how to get the current time.</span>
<span class="token comment">// It can be used to fake out timing for testing.</span>
<span class="token keyword">type</span> Clock <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›RBACæƒé™--å› ä¸ºæˆ‘ä»¬ç°åœ¨æ­£åœ¨åˆ›å»ºå’Œç®¡ç†ä½œä¸šï¼Œæ‰€ä»¥éœ€è¦è¿™äº›æƒé™ï¼Œè¿™æ„å‘³ç€è¦æ·»åŠ ä¸€äº›æ ‡è®°ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">//+kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=get;list;watch;create;update;patch;delete</span>
<span class="token comment">//+kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/status,verbs=get;update;patch</span>
<span class="token comment">//+kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/finalizers,verbs=update</span>
<span class="token comment">//+kubebuilder:rbac:groups=batch,resources=jobs,verbs=get;list;watch;create;update;patch;delete</span>
<span class="token comment">//+kubebuilder:rbac:groups=batch,resources=jobs/status,verbs=get</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬è¿›å…¥æ§åˆ¶å™¨çš„æ ¸å¿ƒ--åè°ƒå™¨é€»è¾‘ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
    scheduledTimeAnnotation <span class="token operator">=</span> <span class="token string">"batch.tutorial.kubebuilder.io/scheduled-at"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Reconcile is part of the main kubernetes reconciliation loop which aims to</span>
<span class="token comment">// move the current state of the cluster closer to the desired state.</span>
<span class="token comment">// TODO(user): Modify the Reconcile function to compare the state specified by</span>
<span class="token comment">// the CronJob object against the actual cluster state, and then</span>
<span class="token comment">// perform operations to make the cluster state reflect the state specified by</span>
<span class="token comment">// the user.</span>
<span class="token comment">//</span>
<span class="token comment">// For more details, check Reconcile and its Result here:</span>
<span class="token comment">// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.13.0/pkg/reconcile</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>CronJobReconciler<span class="token punctuation">)</span> <span class="token function">Reconcile</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req ctrl<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æŒ‰åç§°åŠ è½½cronjob" tabindex="-1"><a class="header-anchor" href="#æŒ‰åç§°åŠ è½½cronjob" aria-hidden="true">#</a> æŒ‰åç§°åŠ è½½CronJob</h3>
<p>æˆ‘ä»¬å°†ä½¿ç”¨å®¢æˆ·ç«¯è·å–CronJobã€‚æ‰€æœ‰å®¢æˆ·ç«¯æ–¹æ³•éƒ½å°†ä¸Šä¸‹æ–‡ï¼ˆä»¥å…è®¸å–æ¶ˆï¼‰ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¹¶å°†æœ‰é—®é¢˜çš„å¯¹è±¡ä½œä¸ºå…¶æœ€åä¸€ä¸ªå‚æ•°ã€‚Getæœ‰ç‚¹ç‰¹æ®Šï¼Œå®ƒå°† <code v-pre>NamespacedName</code> ä½œä¸ºä¸­é—´å‚æ•°ï¼ˆå¤§å¤šæ•°æ²¡æœ‰ä¸­é—´å‚æ•°ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢çœ‹åˆ°ï¼‰ã€‚</p>
<p>è®¸å¤šå®¢æˆ·ç«¯æ–¹æ³•ä¹Ÿåœ¨æœ€åé‡‡ç”¨å¯å˜å‚æ•°é€‰é¡¹ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">var</span> cronJob batchv1<span class="token punctuation">.</span>CronJob
<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cronJob<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to fetch CronJob"</span><span class="token punctuation">)</span>
    <span class="token comment">// we'll ignore not-found errors, since they can't be fixed by an immediate</span>
    <span class="token comment">// requeue (we'll need to wait for a new notification), and we can get them</span>
    <span class="token comment">// on deleted requests.</span>
    <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">IgnoreNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åˆ—å‡ºæ‰€æœ‰æ´»åŠ¨ä½œä¸š-å¹¶æ›´æ–°çŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#åˆ—å‡ºæ‰€æœ‰æ´»åŠ¨ä½œä¸š-å¹¶æ›´æ–°çŠ¶æ€" aria-hidden="true">#</a> åˆ—å‡ºæ‰€æœ‰æ´»åŠ¨ä½œä¸šï¼Œå¹¶æ›´æ–°çŠ¶æ€</h3>
<p>è¦å®Œå…¨æ›´æ–°çŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦åˆ—å‡ºæ­¤å‘½åç©ºé—´ä¸­å±äºæ­¤CronJobçš„æ‰€æœ‰å­ä½œä¸šã€‚ä¸Getç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Listæ–¹æ³•åˆ—å‡ºå­ä½œä¸šã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>    <span class="token keyword">var</span> childJobs kbatch<span class="token punctuation">.</span>JobList
    <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>childJobs<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">InNamespace</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span>MatchingFields<span class="token punctuation">{</span>jobOwnerKey<span class="token punctuation">:</span> req<span class="token punctuation">.</span>Name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to list child Jobs"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€æ—¦æˆ‘ä»¬æ‹¥æœ‰äº†æ‰€æœ‰çš„ä½œä¸šï¼Œæˆ‘ä»¬å°†æŠŠå®ƒä»¬åˆ†æˆæ´»åŠ¨çš„ã€æˆåŠŸçš„å’Œå¤±è´¥çš„ä½œä¸šï¼Œè·Ÿè¸ªæœ€è¿‘çš„è¿è¡Œï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨çŠ¶æ€ä¸­è®°å½•å®ƒã€‚</p>
<p>è¯·è®°ä½ï¼ŒçŠ¶æ€åº”è¯¥èƒ½å¤Ÿä»ä¸–ç•Œçš„çŠ¶æ€ä¸­é‡æ–°æ„å»ºï¼Œå› æ­¤é€šå¸¸ä»æ ¹å¯¹è±¡çš„çŠ¶æ€ä¸­è¯»å–ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ç›¸åï¼Œæ‚¨åº”è¯¥åœ¨æ¯æ¬¡è¿è¡Œæ—¶é‡æ–°æ„å»ºå®ƒã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¦åšçš„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨çŠ¶æ€æ¡ä»¶æ£€æŸ¥ä½œä¸šæ˜¯å¦â€œå®Œæˆâ€ä»¥åŠå®ƒæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚æˆ‘ä»¬å°†æŠŠè¿™ä¸ªé€»è¾‘æ”¾åœ¨ä¸€ä¸ªå¸®åŠ©å™¨ä¸­ï¼Œä»¥ä½¿æˆ‘ä»¬çš„ä»£ç æ›´æ¸…æ™°ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>    <span class="token comment">// find the active list of jobs</span>
    <span class="token keyword">var</span> activeJobs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>kbatch<span class="token punctuation">.</span>Job
    <span class="token keyword">var</span> successfulJobs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>kbatch<span class="token punctuation">.</span>Job
    <span class="token keyword">var</span> failedJobs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>kbatch<span class="token punctuation">.</span>Job
    <span class="token keyword">var</span> mostRecentTime <span class="token operator">*</span>time<span class="token punctuation">.</span>Time <span class="token comment">// find the last run so we can update the status</span>
<span class="token comment">// isJobFinished</span>
<span class="token comment">// getScheduledTimeForJob</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> job <span class="token operator">:=</span> <span class="token keyword">range</span> childJobs<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> finishedType <span class="token operator">:=</span> <span class="token function">isJobFinished</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>job<span class="token punctuation">)</span>
        <span class="token keyword">switch</span> finishedType <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">""</span><span class="token punctuation">:</span> <span class="token comment">// ongoing</span>
            activeJobs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>activeJobs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>childJobs<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> kbatch<span class="token punctuation">.</span>JobFailed<span class="token punctuation">:</span>
            failedJobs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>childJobs<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> kbatch<span class="token punctuation">.</span>JobComplete<span class="token punctuation">:</span>
            successfulJobs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>childJobs<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// We'll store the launch time in an annotation, so we'll reconstitute that from</span>
        <span class="token comment">// the active jobs themselves.</span>
        scheduledTimeForJob<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getScheduledTimeForJob</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>job<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to parse schedule time for child job"</span><span class="token punctuation">,</span> <span class="token string">"job"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>job<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> scheduledTimeForJob <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> mostRecentTime <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                mostRecentTime <span class="token operator">=</span> scheduledTimeForJob
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> mostRecentTime<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span><span class="token operator">*</span>scheduledTimeForJob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mostRecentTime <span class="token operator">=</span> scheduledTimeForJob
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> mostRecentTime <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>LastScheduleTime <span class="token operator">=</span> <span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>Time<span class="token punctuation">{</span>Time<span class="token punctuation">:</span> <span class="token operator">*</span>mostRecentTime<span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>LastScheduleTime <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Active <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> activeJob <span class="token operator">:=</span> <span class="token keyword">range</span> activeJobs <span class="token punctuation">{</span>
        jobRef<span class="token punctuation">,</span> err <span class="token operator">:=</span> ref<span class="token punctuation">.</span><span class="token function">GetReference</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> activeJob<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to make reference to active job"</span><span class="token punctuation">,</span> <span class="token string">"job"</span><span class="token punctuation">,</span> activeJob<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Active <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Active<span class="token punctuation">,</span> <span class="token operator">*</span>jobRef<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†è®°å½•æˆ‘ä»¬åœ¨ç¨é«˜çš„æ—¥å¿—çº§åˆ«ä¸Šè§‚å¯Ÿåˆ°çš„ä½œä¸šæ•°é‡ï¼Œä»¥ä¾¿è¿›è¡Œè°ƒè¯•ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸æ˜¯ä½¿ç”¨æ ¼å¼å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä½¿ç”¨å›ºå®šæ¶ˆæ¯ï¼Œå¹¶é™„åŠ å¸¦æœ‰é¢å¤–ä¿¡æ¯çš„é”®å€¼å¯¹ã€‚è¿™ä½¿å¾—è¿‡æ»¤å’ŒæŸ¥è¯¢æ—¥å¿—è¡Œæ›´åŠ å®¹æ˜“ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>    log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"job count"</span><span class="token punctuation">,</span> <span class="token string">"active jobs"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>activeJobs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"successful jobs"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"failed jobs"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä½¿ç”¨æˆ‘ä»¬æ”¶é›†çš„æ•°æ®ï¼Œæˆ‘ä»¬å°†æ›´æ–°CRDçš„çŠ¶æ€ã€‚å°±åƒä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬åˆ©ç”¨æˆ‘ä»¬çš„å®¢æˆ·ã€‚ä¸ºäº†ä¸“é—¨æ›´æ–°çŠ¶æ€å­èµ„æºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®¢æˆ·ç«¯çš„ <code v-pre>Status</code> éƒ¨åˆ†å’Œ <code v-pre>Update</code> æ–¹æ³•ã€‚</p>
<p>statuså­èµ„æºå¿½ç•¥å¯¹specçš„æ›´æ”¹ï¼Œå› æ­¤å®ƒä¸å¤ªå¯èƒ½ä¸ä»»ä½•å…¶ä»–æ›´æ–°å†²çªï¼Œå¹¶ä¸”å¯ä»¥å…·æœ‰å•ç‹¬çš„æƒé™ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>    <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cronJob<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to update CronJob status"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€æ—¦æˆ‘ä»¬æ›´æ–°äº†æˆ‘ä»¬çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­ç¡®ä¿ä¸–ç•Œçš„çŠ¶æ€ä¸æˆ‘ä»¬åœ¨è§„èŒƒä¸­æƒ³è¦çš„ç›¸åŒ¹é…ã€‚</p>
<h3 id="æ ¹æ®å†å²é™åˆ¶æ¸…ç†æ—§ä½œä¸š" tabindex="-1"><a class="header-anchor" href="#æ ¹æ®å†å²é™åˆ¶æ¸…ç†æ—§ä½œä¸š" aria-hidden="true">#</a> æ ¹æ®å†å²é™åˆ¶æ¸…ç†æ—§ä½œä¸š</h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†åŠªåŠ›æ¸…ç†æ—§çš„å·¥ä½œï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šç•™ä¸‹å¤ªå¤šçš„é—²ç½®å·¥ä½œã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// NB: deleting these are "best effort" -- if we fail on a particular one,</span>
    <span class="token comment">// we won't requeue just to finish the deleting.</span>
    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>FailedJobsHistoryLimit <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        sort<span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> failedJobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> failedJobs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime <span class="token operator">!=</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> failedJobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> job <span class="token operator">:=</span> <span class="token keyword">range</span> failedJobs <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token function">int32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">*</span>cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>FailedJobsHistoryLimit <span class="token punctuation">{</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> job<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">PropagationPolicy</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>DeletePropagationBackground<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> client<span class="token punctuation">.</span><span class="token function">IgnoreNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to delete old failed job"</span><span class="token punctuation">,</span> <span class="token string">"job"</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"deleted old failed job"</span><span class="token punctuation">,</span> <span class="token string">"job"</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>SuccessfulJobsHistoryLimit <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        sort<span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> successfulJobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> successfulJobs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime <span class="token operator">!=</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> successfulJobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> job <span class="token operator">:=</span> <span class="token keyword">range</span> successfulJobs <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token function">int32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">*</span>cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>SuccessfulJobsHistoryLimit <span class="token punctuation">{</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> job<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">PropagationPolicy</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>DeletePropagationBackground<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to delete old successful job"</span><span class="token punctuation">,</span> <span class="token string">"job"</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"deleted old successful job"</span><span class="token punctuation">,</span> <span class="token string">"job"</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ£€æŸ¥æ˜¯å¦åœæ­¢" tabindex="-1"><a class="header-anchor" href="#æ£€æŸ¥æ˜¯å¦åœæ­¢" aria-hidden="true">#</a> æ£€æŸ¥æ˜¯å¦åœæ­¢</h3>
<p>å¦‚æœè¿™ä¸ªå¯¹è±¡è¢«æŒ‚èµ·ï¼Œæˆ‘ä»¬ä¸æƒ³è¿è¡Œä»»ä½•ä½œä¸šï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨åœæ­¢ã€‚å¦‚æœæˆ‘ä»¬æ­£åœ¨è¿è¡Œçš„ä½œä¸šå‡ºç°æ•…éšœï¼Œå¹¶ä¸”æˆ‘ä»¬å¸Œæœ›æš‚åœè¿è¡Œä»¥è¿›è¡Œè°ƒæŸ¥æˆ–å¤„ç†é›†ç¾¤ï¼Œè€Œä¸åˆ é™¤å¯¹è±¡ï¼Œåˆ™æ­¤åŠŸèƒ½éå¸¸æœ‰ç”¨ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Suspend <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Suspend <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"cronjob suspended, skipping"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è·å–ä¸‹ä¸€æ¬¡è®¡åˆ’è¿è¡Œ" tabindex="-1"><a class="header-anchor" href="#è·å–ä¸‹ä¸€æ¬¡è®¡åˆ’è¿è¡Œ" aria-hidden="true">#</a> è·å–ä¸‹ä¸€æ¬¡è®¡åˆ’è¿è¡Œ</h3>
<p>å¦‚æœæˆ‘ä»¬æ²¡æœ‰æš‚åœï¼Œæˆ‘ä»¬å°†éœ€è¦è®¡ç®—ä¸‹ä¸€ä¸ªè®¡åˆ’çš„è¿è¡Œï¼Œä»¥åŠæˆ‘ä»¬æ˜¯å¦æœ‰ä¸€ä¸ªå°šæœªå¤„ç†çš„è¿è¡Œã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// getNextSchedule</span>
    <span class="token comment">// figure out the next times that we need to create</span>
    <span class="token comment">// jobs at (or anything we missed).</span>
    missedRun<span class="token punctuation">,</span> nextRun<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getNextSchedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cronJob<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to figure out CronJob schedule"</span><span class="token punctuation">)</span>
        <span class="token comment">// we don't really care about requeuing until we get an update that</span>
        <span class="token comment">// fixes the schedule, so don't return an error</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å°†å‡†å¤‡æœ€ç»ˆçš„è¯·æ±‚ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€ä¸ªä½œä¸šä¹‹å‰é‡æ–°æ’é˜Ÿï¼Œç„¶åç¡®å®šæˆ‘ä»¬æ˜¯å¦å®é™…éœ€è¦è¿è¡Œã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>    scheduledResult <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span>RequeueAfter<span class="token punctuation">:</span> nextRun<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token comment">// save this so we can re-use it elsewhere</span>
    log <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">WithValues</span><span class="token punctuation">(</span><span class="token string">"now"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"next run"</span><span class="token punctuation">,</span> nextRun<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è¿è¡Œä¸€ä¸ªæ–°çš„ä½œä¸š-å¦‚æœå®ƒæ˜¯æŒ‰è®¡åˆ’è¿›è¡Œçš„-æ²¡æœ‰è¶…è¿‡æˆªæ­¢æ—¥æœŸ-ä¹Ÿæ²¡æœ‰è¢«æˆ‘ä»¬çš„å¹¶å‘ç­–ç•¥é˜»å¡" tabindex="-1"><a class="header-anchor" href="#è¿è¡Œä¸€ä¸ªæ–°çš„ä½œä¸š-å¦‚æœå®ƒæ˜¯æŒ‰è®¡åˆ’è¿›è¡Œçš„-æ²¡æœ‰è¶…è¿‡æˆªæ­¢æ—¥æœŸ-ä¹Ÿæ²¡æœ‰è¢«æˆ‘ä»¬çš„å¹¶å‘ç­–ç•¥é˜»å¡" aria-hidden="true">#</a> è¿è¡Œä¸€ä¸ªæ–°çš„ä½œä¸šï¼Œå¦‚æœå®ƒæ˜¯æŒ‰è®¡åˆ’è¿›è¡Œçš„ï¼Œæ²¡æœ‰è¶…è¿‡æˆªæ­¢æ—¥æœŸï¼Œä¹Ÿæ²¡æœ‰è¢«æˆ‘ä»¬çš„å¹¶å‘ç­–ç•¥é˜»å¡</h3>
<p>å¦‚æœæˆ‘ä»¬é”™è¿‡äº†ä¸€ä¸ªè¿è¡Œï¼Œå¹¶ä¸”æˆ‘ä»¬ä»ç„¶åœ¨å¼€å§‹å®ƒçš„æˆªæ­¢æ—¥æœŸå†…ï¼Œæˆ‘ä»¬å°†éœ€è¦è¿è¡Œä¸€ä¸ªä½œä¸šã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>    <span class="token keyword">if</span> missedRun<span class="token punctuation">.</span><span class="token function">IsZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"no upcoming scheduled times, sleeping until next"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// make sure we're not too late to start the run</span>
    log <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">WithValues</span><span class="token punctuation">(</span><span class="token string">"current run"</span><span class="token punctuation">,</span> missedRun<span class="token punctuation">)</span>
    tooLate <span class="token operator">:=</span> <span class="token boolean">false</span>
    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>StartingDeadlineSeconds <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        tooLate <span class="token operator">=</span> missedRun<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token operator">*</span>cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>StartingDeadlineSeconds<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> tooLate <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"missed starting deadline for last run, sleeping till next"</span><span class="token punctuation">)</span>
        <span class="token comment">// TODO(directxman12): events</span>
        <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä»¬å®é™…ä¸Šå¿…é¡»è¿è¡Œä¸€ä¸ªä½œä¸šï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…ç°æœ‰çš„ä½œä¸šå®Œæˆï¼Œæ›¿æ¢ç°æœ‰çš„ä½œä¸šï¼Œæˆ–è€…åªæ˜¯æ·»åŠ æ–°çš„ä½œä¸šã€‚å¦‚æœæˆ‘ä»¬çš„ä¿¡æ¯ç”±äºç¼“å­˜å»¶è¿Ÿè€Œè¿‡æœŸï¼Œæˆ‘ä»¬å°†åœ¨è·å¾—æœ€æ–°ä¿¡æ¯æ—¶é‡æ–°æ’é˜Ÿã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>    <span class="token comment">// figure out how to run this job -- concurrency policy might forbid us from running</span>
    <span class="token comment">// multiple at the same time...</span>
    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>ConcurrencyPolicy <span class="token operator">==</span> batchv1<span class="token punctuation">.</span>ForbidConcurrent <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>activeJobs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"concurrency policy blocks concurrent runs, skipping"</span><span class="token punctuation">,</span> <span class="token string">"num active"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>activeJobs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...or instruct us to replace existing ones...</span>
    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>ConcurrencyPolicy <span class="token operator">==</span> batchv1<span class="token punctuation">.</span>ReplaceConcurrent <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> activeJob <span class="token operator">:=</span> <span class="token keyword">range</span> activeJobs <span class="token punctuation">{</span>
            <span class="token comment">// we don't care if the job was already deleted</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> activeJob<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">PropagationPolicy</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>DeletePropagationBackground<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> client<span class="token punctuation">.</span><span class="token function">IgnoreNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to delete active job"</span><span class="token punctuation">,</span> <span class="token string">"job"</span><span class="token punctuation">,</span> activeJob<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€æ—¦æˆ‘ä»¬å¼„æ¸…æ¥šäº†å¦‚ä½•å¤„ç†ç°æœ‰çš„å·¥ä½œï¼Œæˆ‘ä»¬å®é™…ä¸Šå°±ä¼šåˆ›é€ å‡ºæˆ‘ä»¬æƒ³è¦çš„å·¥ä½œ</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// constructJobForCronJob</span>
    <span class="token comment">// actually make the job...</span>
    job<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">constructJobForCronJob</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cronJob<span class="token punctuation">,</span> missedRun<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to construct job from template"</span><span class="token punctuation">)</span>
        <span class="token comment">// don't bother requeuing until we get a change to the spec</span>
        <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...and create it on the cluster</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"unable to create Job for CronJob"</span><span class="token punctuation">,</span> <span class="token string">"job"</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"created Job for CronJob run"</span><span class="token punctuation">,</span> <span class="token string">"job"</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å½“æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ä½œä¸šæˆ–è€…åˆ°äº†ä¸‹ä¸€ä¸ªè®¡åˆ’è¿è¡Œçš„æ—¶é—´æ—¶é‡æ–°æ’é˜Ÿ" tabindex="-1"><a class="header-anchor" href="#å½“æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ä½œä¸šæˆ–è€…åˆ°äº†ä¸‹ä¸€ä¸ªè®¡åˆ’è¿è¡Œçš„æ—¶é—´æ—¶é‡æ–°æ’é˜Ÿ" aria-hidden="true">#</a> å½“æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ä½œä¸šæˆ–è€…åˆ°äº†ä¸‹ä¸€ä¸ªè®¡åˆ’è¿è¡Œçš„æ—¶é—´æ—¶é‡æ–°æ’é˜Ÿ</h3>
<p>æœ€åï¼Œæˆ‘ä»¬å°†è¿”å›ä¸Šé¢å‡†å¤‡çš„ç»“æœï¼Œå®ƒè¡¨ç¤ºæˆ‘ä»¬å¸Œæœ›åœ¨ä¸‹ä¸€æ¬¡è¿è¡Œæ—¶é‡æ–°æ’é˜Ÿã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªæœ€å¤§çš„æœŸé™--å¦‚æœåœ¨è¿™æœŸé—´å‘ç”Ÿäº†å…¶ä»–å˜åŒ–ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„å·¥ä½œå¼€å§‹æˆ–ç»“æŸï¼Œæˆ‘ä»¬è¢«ä¿®æ”¹ï¼Œç­‰ç­‰ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæ›´å¿«åœ°å†æ¬¡åè°ƒã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>    <span class="token comment">// we'll requeue once we see the running job, and update our status</span>
    <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¯åŠ¨-controller" tabindex="-1"><a class="header-anchor" href="#å¯åŠ¨-controller" aria-hidden="true">#</a> å¯åŠ¨ Controller</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥å¯åŠ¨è¿™ä¸ª Controller æ¥çœ‹ä¸€ä¸‹æ•ˆæœ</p>
<p>ç›´æ¥è¿è¡Œ <code v-pre>make run</code> å³å¯è¿è¡Œä»£ç ï¼Œå†ç»ˆç«¯ä¸­å¯ä»¥çœ‹åˆ°æ—¥å¿—è¾“å‡ºã€‚</p>
<p>æŸ¥çœ‹ Pod æ˜¯å¦æˆåŠŸåˆ›å»ºå‡ºæ¥äº†ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubectl get pod 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="éƒ¨ç½²-controller" tabindex="-1"><a class="header-anchor" href="#éƒ¨ç½²-controller" aria-hidden="true">#</a> éƒ¨ç½² Controller</h3>
<p>æˆ‘ä»¬å°†å…¶éƒ¨ç½²äº†äº†ä¸€ä¸ª ç¤ºä¾‹ï¼Œä¹Ÿè¿è¡Œ Controller çœ‹åˆ°äº†ç›¸åº”çš„ å‰¯æœ¬ Pod è¢«åˆ›å»ºå‡ºæ¥äº†ï¼Œç°åœ¨æˆ‘ä»¬è¿›ä¸€æ­¥æ¨¡æ‹Ÿ Operator å®é™…ä½¿ç”¨æ—¶çš„éƒ¨ç½²æ–¹å¼ï¼ŒæŠŠ Controller æ‰“åŒ…åä»¥ container çš„æ–¹å¼éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ç¯å¢ƒä¸­ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># æ„å»ºé•œåƒ</span>
<span class="token function">make</span> docker-build <span class="token assign-left variable">IMG</span><span class="token operator">=</span>application-operator:v0.0.1

<span class="token comment"># æ¨é€åˆ° Kind ç¯å¢ƒ</span>
kind load docker-image

<span class="token comment"># éƒ¨ç½² controller </span>
<span class="token function">make</span> deploy <span class="token assign-left variable">IMG</span><span class="token operator">=</span>application-operator:v0.0.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è¡¥å……ï¼šæˆ‘ä»¬å¯ä»¥åœ¨ dockerfile ä¸­è§£å†³Goè¯­è¨€çš„ä»£ç†é—®é¢˜ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>ENV <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.op
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="èµ„æºæ¸…ç†" tabindex="-1"><a class="header-anchor" href="#èµ„æºæ¸…ç†" aria-hidden="true">#</a> èµ„æºæ¸…ç†</h3>
<p>ä¸Šé¢æœ‰è®²è¿‡ï¼Œç”¨ Makefile å‘½ä»¤æ¸…ç†è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œæˆ‘ä»¬ç›´æ¥æ¸…ç†å°±å¥½äº†ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># å¸è½½ controller</span>
<span class="token function">make</span> undeploy

<span class="token comment"># å¸è½½ CRD</span>
<span class="token function">make</span> uninstall
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="client-go" tabindex="-1"><a class="header-anchor" href="#client-go" aria-hidden="true">#</a> Client-go</h2>
<p>Kubeilder å·²ç»å±è”½äº† client-go çš„ç»†èŠ‚ï¼Œä½†æ˜¯å¦‚æœå¸Œæœ›æ·±å…¥æŒæ¡ Operator å¼€å‘æœºåˆ¶ï¼Œè¿˜æ˜¯éœ€è¦å¯¹ Client-go ç†Ÿæ‚‰çš„ã€‚</p>
<p>è¿™æ˜¯ä¸€ç¯‡è¿˜æ²¡å…¥é—¨çš„æ¦‚å¿µäº†è§£ç¬”è®°ï¼š</p>
<ul>
<li><a href="https://docker.nsddd.top/Cloud-Native-k8s/35.html" target="_blank" rel="noopener noreferrer">ç¬”è®°éƒ¨åˆ† ~<ExternalLinkIcon/></a></li>
</ul>
<p>Kubernetes APIæ˜¯ä¸€ç»„REST APIï¼Œç”¨äºä¸Kubernetesé›†ç¾¤äº¤äº’ã€‚è¿™äº›APIå…è®¸å¼€å‘äººå‘˜æ‰§è¡Œå„ç§æ“ä½œï¼ŒåŒ…æ‹¬ç®¡ç†Podã€Deploymentã€Serviceã€Namespaceç­‰ã€‚Kubernetes APIç”±ä¸€ç»„èµ„æºå¯¹è±¡è¡¨ç¤ºï¼Œä¾‹å¦‚Podã€Serviceã€ReplicaSetç­‰ã€‚è¿™äº›èµ„æºå¯¹è±¡ç”±Kubernetes API Serverç®¡ç†ï¼Œå¹¶å¯ä»¥é€šè¿‡kubectlç­‰å·¥å…·è¿›è¡ŒæŸ¥è¯¢å’Œä¿®æ”¹ã€‚</p>
<table>
<thead>
<tr>
<th>æ–¹å¼</th>
<th>ç‰¹ç‚¹</th>
<th>æ”¯æŒè€…</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes dashboard</td>
<td>ç›´æ¥é€šè¿‡Web UIè¿›è¡Œæ“ä½œï¼Œç®€å•ç›´æ¥ï¼Œå¯å®šåˆ¶åŒ–ç¨‹åº¦ä½</td>
<td>å®˜æ–¹æ”¯æŒ</td>
</tr>
<tr>
<td>kubectl</td>
<td>å‘½ä»¤è¡Œæ“ä½œï¼ŒåŠŸèƒ½æœ€å…¨ï¼Œä½†æ˜¯æ¯”è¾ƒå¤æ‚ï¼Œé€‚åˆå¯¹å…¶è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ†è£…ï¼Œå®šåˆ¶åŠŸèƒ½ï¼Œç‰ˆæœ¬é€‚é…æœ€å¥½</td>
<td>å®˜æ–¹æ”¯æŒ</td>
</tr>
<tr>
<td><a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener noreferrer">client-go<ExternalLinkIcon/></a></td>
<td>ä»kubernetesçš„ä»£ç ä¸­æŠ½ç¦»å‡ºæ¥çš„å®¢æˆ·ç«¯åŒ…ï¼Œç®€å•æ˜“ç”¨ï¼Œä½†éœ€è¦å°å¿ƒåŒºåˆ†kubernetesçš„APIç‰ˆæœ¬</td>
<td>å®˜æ–¹æ”¯æŒ</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Kubernetes API Server æä¾›çš„æ˜¯é»˜è®¤çš„ HTTPS æœåŠ¡ï¼Œè€Œä¸”æ˜¯åŒå‘çš„ TLS è®¤è¯ï¼Œè€Œæˆ‘ä»¬ç›®å‰çš„å…³æ³¨ç‚¹æ˜¯ API æœ¬èº«ï¼Œå› æ­¤å…ˆé€šè¿‡ Kubectl æ¥ä»£ç† API Server æœåŠ¡ã€‚</p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ kubectl proxy <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">8080</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡ç®€å•çš„ HTTP è¯·æ±‚æ¥å’Œ API Server äº¤äº’äº†ï¼š</p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">curl</span> localhost:8080/version
<span class="token punctuation">{</span>
  <span class="token string">"major"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
  <span class="token string">"minor"</span><span class="token builtin class-name">:</span> <span class="token string">"19"</span>,
  <span class="token string">"gitVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1.19.16"</span>,
  <span class="token string">"gitCommit"</span><span class="token builtin class-name">:</span> <span class="token string">"e37e4ab4cc8dcda84f1344dda47a97bb1927d074"</span>,
  <span class="token string">"gitTreeState"</span><span class="token builtin class-name">:</span> <span class="token string">"clean"</span>,
  <span class="token string">"buildDate"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-10-26T15:40:32Z"</span>,
  <span class="token string">"goVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"go1.15.15"</span>,
  <span class="token string">"compiler"</span><span class="token builtin class-name">:</span> <span class="token string">"gc"</span>,
  <span class="token string">"platform"</span><span class="token builtin class-name">:</span> <span class="token string">"linux/amd64"</span>
<span class="token punctuation">}</span><span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥æè¿° Deployment èµ„æºï¼Œåœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ª <code v-pre>nginx-deploy.yaml</code> æ–‡ä»¶:</p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬åˆ›å»ºå®ƒï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ kubectl create <span class="token parameter variable">-f</span> nginx-deploy.yaml
deployment.apps/nginx-deployment created
â¯ k get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
my-nginx-app       <span class="token number">0</span>/3     <span class="token number">3</span>            <span class="token number">0</span>           23h
nginx-deployment   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           19s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Deployment åˆ›å»ºçš„ API å’Œ åœ¨ Kubernetes ä¸­ API çš„è·¯å¾„ä¸€æ ·ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>POST /apis/apps/v1/namespace/{namespace}/deployment
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote>
<p>Kubernetesä¸­ä½¿ç”¨çš„ RESTful æ¥å£æ›´æ–°è¿™äº›å¯¹è±¡ï¼ŒåŒ…æ‹¬æ“ä½œï¼š</p>
<div class="language-markdown ext-md line-numbers-mode"><pre v-pre class="language-markdown"><code><span class="token list punctuation">-</span> GETï¼šä»æœåŠ¡å™¨è¯»å–ä¸€ä¸ªèµ„æºã€‚
<span class="token list punctuation">-</span> POSTï¼šåœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºã€‚
<span class="token list punctuation">-</span> PUTï¼šåœ¨æœåŠ¡å™¨ä¸Šæ›´æ–°ä¸€ä¸ªèµ„æºã€‚
<span class="token list punctuation">-</span> DELETEï¼šä»æœåŠ¡å™¨åˆ é™¤ä¸€ä¸ªèµ„æºã€‚
<span class="token list punctuation">-</span> HEADï¼šä»æœåŠ¡å™¨è¯»å–ä¸€ä¸ªèµ„æºçš„å¤´ä¿¡æ¯ã€‚
<span class="token list punctuation">-</span> PATCHï¼šåœ¨æœåŠ¡å™¨ä¸Šéƒ¨åˆ†æ›´æ–°ä¸€ä¸ªèµ„æºã€‚
<span class="token list punctuation">-</span> OPTIONSï¼šåˆ—å‡ºæœåŠ¡å™¨æ”¯æŒçš„æ–¹æ³•å’ŒåŠŸèƒ½ã€‚
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>
<p>æ—¢ç„¶æƒ³å°è¯• kubectlï¼Œé‚£ä¹ˆæ¥ç‚¹æ–°èŠ±æ ·ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">curl</span> localhost:8080/apis/apps/v1/namespaces/default/deployments/nginx-deploymen
<span class="token punctuation">{</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"Status"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>,
  <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"Failure"</span>,
  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"deployments.apps <span class="token entity" title="\&quot;">\"</span>nginx-deploymen<span class="token entity" title="\&quot;">\"</span> not found"</span>,
  <span class="token string">"reason"</span><span class="token builtin class-name">:</span> <span class="token string">"NotFound"</span>,
  <span class="token string">"details"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"nginx-deploymen"</span>,
    <span class="token string">"group"</span><span class="token builtin class-name">:</span> <span class="token string">"apps"</span>,
    <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"deployments"</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">404</span>
<span class="token punctuation">}</span><span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>èµ„æºåˆ›å»ºï¼š</strong></p>
<p>Depolyment çš„åˆ›å»º API æ˜¯ï¼š<code v-pre>apps/v1</code> ä¸­çš„ Deploymentã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>POST /apis/apps/v1/namespaces/<span class="token punctuation">{</span>namespace<span class="token punctuation">}</span>/deployments
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åœ¨ default å‘½åç©ºé—´ä¸‹åˆ›å»ºä¸€ä¸ª deploymentï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">--header</span> <span class="token string">'Content-Type: application/yaml'</span> --data-binary @nginx-deploy.yaml http://localhost:8080/apis/apps/v1/namespaces/default/deployments
<span class="token punctuation">{</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"Status"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>,
  <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"Failure"</span>,
  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"deployments.apps <span class="token entity" title="\&quot;">\"</span>nginx-deployment<span class="token entity" title="\&quot;">\"</span> already exists"</span>,
  <span class="token string">"reason"</span><span class="token builtin class-name">:</span> <span class="token string">"AlreadyExists"</span>,
  <span class="token string">"details"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"nginx-deployment"</span>,
    <span class="token string">"group"</span><span class="token builtin class-name">:</span> <span class="token string">"apps"</span>,
    <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"deployments"</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">409</span>
<span class="token punctuation">}</span><span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="client-go-1" tabindex="-1"><a class="header-anchor" href="#client-go-1" aria-hidden="true">#</a> Client-go</h3>
<p>kubectl å¹¶ä¸é€‚åˆ Kubernetes çš„äºŒæ¬¡å¼€å‘è€…æ¥å’Œ k8s æ‰“äº¤é“ï¼ŒGoè¯­è¨€æä¾›äº†ä¸€ä¸ªä¸“é—¨å’Œ Kubernetes API äº¤äº’çš„ åº“ Client-go</p>
<p>Client-goæ˜¯ä¸€ä¸ªç”¨äºä¸Kubernetes APIäº¤äº’çš„Goåº“ã€‚å®ƒæä¾›äº†å¹¿æ³›çš„åŠŸèƒ½ï¼Œç”¨äºä¸Kubernetes APIäº¤äº’ï¼ŒåŒ…æ‹¬å¼ºç±»å‹APIã€èµ„æºå®¢æˆ·ç«¯ã€Watch APIå’ŒåŠ¨æ€å®¢æˆ·ç«¯ã€‚ä½¿ç”¨client-goï¼Œå¼€å‘äººå‘˜å¯ä»¥è½»æ¾åœ°åœ¨Kubernetesä¸­åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤èµ„æºå¯¹è±¡ã€‚</p>
<blockquote>
<p>ä»è¿™ä¸ª<code v-pre>package</code>çš„åç§°æ¥çœ‹ï¼Œè¿™åº”è¯¥æ˜¯è·Ÿ<code v-pre>k8s</code>æ‰“äº¤é“çš„å®¢æˆ·ç«¯<code v-pre>client</code>çš„<code v-pre>go</code>å®ç°ï¼Œè¿™ä¸€ç‚¹æ²¡é”™ï¼Œå®ƒå®šä¹‰äº†è¯¸å¤šèµ„æºçš„å®¢æˆ·ç«¯<code v-pre>client</code>ã€‚</p>
</blockquote>
<ul>
<li><a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener noreferrer">Client-go GitHub Address<ExternalLinkIcon/></a></li>
<li>https://github.com/cubxxw/client-go</li>
</ul>
<p>ä¸Šé¢æ˜¯ client-go çš„ GitHub ä»“åº“ï¼Œä¸è¿‡è¿™ä¸ªåº“æ˜¯ actions ä»¥æ¯å¤©ä¸€æ¬¡çš„é¢‘ç‡ä» Kubernetes/Kubernetes ä¸»ä»“åº“ä¸­è‡ªåŠ¨åŒæ­¥è¿‡æ¥çš„ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è´¡çŒ®çš„è¯æ‰¾å¥½ä½ç½®å» Kubernetes è´¡çŒ®ï¼ˆkubernetes/stagin/src/k8s.ioï¼‰ã€‚</p>
<h3 id="client-goç›®å½•ç»“æ„" tabindex="-1"><a class="header-anchor" href="#client-goç›®å½•ç»“æ„" aria-hidden="true">#</a> Client-goç›®å½•ç»“æ„</h3>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â”œâ”€â”€ discovery   <span class="token comment"># DsicoveryClientå®¢æˆ·ç«¯,ç”¨äºå‘ç°k8sæ‰€æ”¯æŒGVRã€‚</span>
â”œâ”€â”€ dynamic     <span class="token comment"># DynamicClientå®¢æˆ·ç«¯, ç”¨äºè®¿é—®k8s Resourcesï¼Œä¹Ÿå¯ä»¥è®¿é—®CRDã€‚</span>
â”œâ”€â”€ informers   <span class="token comment"># k8sä¸­å„ç§Resourcesçš„Informeræœºåˆ¶çš„å®ç°ã€‚</span>
â”œâ”€â”€ kubernetes  <span class="token comment"># å¯¹RestClientè¿›è¡Œäº†å°è£…ï¼Œå®šä¹‰å¤šç§Clientçš„å®¢æˆ·ç«¯é›†åˆï¼Œä¿—ç§°clientsetã€‚</span>
â”œâ”€â”€ listers     <span class="token comment"># æä¾›å¯¹Resourcesçš„è·å–åŠŸèƒ½ã€‚å¯¹äºGet()å’ŒList()è€Œè¨€ï¼Œlistersæä¾›ç»™äºŒè€…çš„æ•°æ®éƒ½æ˜¯ä»ç¼“å­˜ä¸­è¯»å–çš„ã€‚</span>
â”œâ”€â”€ pkg
â”œâ”€â”€ plugin      <span class="token comment"># æä¾›ç¬¬ä¸‰æ–¹æ’ä»¶ã€‚</span>
â”œâ”€â”€ scale       <span class="token comment"># å®šä¹‰ç”¨äºDeploy, RS, RCç­‰èµ„æºè¿›è¡Œçš„æ‰©ã€ç¼©å®¹çš„å®¢æˆ·ç«¯ScaleClientã€‚</span>
â”œâ”€â”€ tools       <span class="token comment"># å®ç°clientæŸ¥è¯¢å’Œç¼“å­˜æœºåˆ¶ï¼Œä»¥åŠå®šä¹‰è¯¸å¦‚SharedInformerã€Reflectorã€DealtFIFOå’ŒIndexerç­‰å¸¸ç”¨å·¥å…·ã€‚</span>
â”œâ”€â”€ transport
â””â”€â”€ util        <span class="token comment"># æä¾›è¯¸å¦‚WorkQueueã€Certificateç­‰å¸¸ç”¨æ–¹æ³•ã€‚</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š</p>
<ul>
<li><code v-pre>/discovery</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºå‘ç°å’Œè·å–Kubernetes APIèµ„æºçš„ä»£ç ã€‚è¿™äº›èµ„æºåŒ…æ‹¬Podã€Serviceã€ReplicationControllerç­‰ã€‚<code v-pre>discovery</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å‘ç°å’Œä½¿ç”¨è¿™äº›èµ„æºã€‚</li>
<li><code v-pre>/dynamic</code>ï¼šè¯¥ç›®å½•åŒ…å«åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼Œç”¨äºä¸Kubernetes APIäº¤äº’ï¼Œè€Œæ— éœ€ç”Ÿæˆä»£ç ã€‚è¿™å¯¹äºæ„å»ºéœ€è¦ä¸ä»»æ„Kubernetesèµ„æºäº¤äº’çš„é€šç”¨å·¥å…·å’Œå®ç”¨ç¨‹åºéå¸¸æœ‰ç”¨ã€‚</li>
<li><code v-pre>/kubernetes</code>ï¼šè¿™ä¸ªåŒ…ä¸­æ–¹çš„æ˜¯ç”¨ client-gen è‡ªåŠ¨ç”Ÿæˆçš„ç”¨æ¥è®¿é—® Kubernetes API çš„ ClientSetï¼Œåé¢ä¼šç»å¸¸çœ‹åˆ° ClientSet è¿™ä¸ªå·¥å…·ã€‚</li>
<li><code v-pre>/informers</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºç›‘è§†Kubernetesèµ„æºå˜åŒ–çš„ä»£ç ã€‚è¿™äº›å˜åŒ–å¯ä»¥åŒ…æ‹¬èµ„æºçš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ã€‚<code v-pre>informers</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ„å»ºæ§åˆ¶å™¨å’Œå…¶ä»–éœ€è¦å¯¹Kubernetesç¯å¢ƒä¸­çš„å˜åŒ–åšå‡ºååº”çš„åº”ç”¨ç¨‹åºã€‚</li>
<li><code v-pre>/listers</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºä»KubernetesæœåŠ¡å™¨è·å–èµ„æºåˆ—è¡¨çš„ä»£ç ã€‚è¿™äº›èµ„æºåˆ—è¡¨åŒ…æ‹¬Podã€Serviceã€Namespaceç­‰ã€‚<code v-pre>listers</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´è½»æ¾åœ°è·å–æœ‰å…³Kubernetesèµ„æºçš„ä¿¡æ¯ã€‚</li>
<li><code v-pre>/rest</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºä¸Kubernetes APIäº¤äº’çš„ä»£ç ã€‚è¿™äº›APIåŒ…æ‹¬Podã€Serviceã€Namespaceç­‰ã€‚<code v-pre>rest</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ‰§è¡Œå„ç§æ“ä½œï¼ŒåŒ…æ‹¬ç®¡ç†Podã€Deploymentã€Serviceã€Namespaceç­‰ã€‚</li>
<li><code v-pre>/scale</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºä¸Kubernetesèµ„æºçš„è‡ªåŠ¨ç¼©æ”¾ç›¸å…³çš„ä»£ç ã€‚è¿™äº›èµ„æºåŒ…æ‹¬Deploymentã€ReplicaSetã€StatefulSetç­‰ã€‚<code v-pre>scale</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜è‡ªåŠ¨ç¼©æ”¾ä¸Kubernetesèµ„æºç›¸å…³çš„ç»„ä»¶ã€‚</li>
<li><code v-pre>transport</code>ï¼šè¿™ä¸ªåŒ…ç”¨äºè®¾ç½®è®¤è¯å’Œå»ºç«‹è¿æ¥</li>
<li><code v-pre>/tools</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºæµ‹è¯•å’Œå…¶ä»–å®ç”¨ç¨‹åºçš„ä»£ç ã€‚è¿™äº›å®ç”¨ç¨‹åºåŒ…æ‹¬ä»£ç ç”Ÿæˆå™¨ã€æµ‹è¯•å·¥å…·ç­‰ã€‚<code v-pre>tools</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´è½»æ¾åœ°æµ‹è¯•å’Œä½¿ç”¨client-goåº“ã€‚</li>
<li><code v-pre>/util</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºå®¢æˆ·ç«¯åº“çš„è¾…åŠ©åŠŸèƒ½çš„ä»£ç ã€‚è¿™äº›åŠŸèƒ½åŒ…æ‹¬å¯¹Kubernetes APIå¯¹è±¡çš„ç±»å‹è½¬æ¢ã€å¯¹è±¡æ¯”è¾ƒç­‰ã€‚<code v-pre>util</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´è½»æ¾åœ°ä½¿ç”¨client-goåº“ã€‚</li>
</ul>
<h3 id="è·å–-client-go" tabindex="-1"><a class="header-anchor" href="#è·å–-client-go" aria-hidden="true">#</a> è·å– Client-go</h3>
<p>å¯ä»¥é€šè¿‡ go get å‘½ä»¤è·å– client-goï¼Œä¸è¿‡æˆ‘ç›´æ¥å…‹éš†æœ€æ–°æºä»£ç ï¼Œç„¶åæ„å»ºä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/kubernetes/client-go.git
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»–ä»¬ç»™äº†ä¸€äº›æ ·ä¾‹çš„æ–‡ä»¶ï¼Œæˆ‘æ‰¾å‡ºæ¥ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">find</span> <span class="token parameter variable">-name</span> main.go
./examples/workqueue/main.go
./examples/in-cluster-client-configuration/main.go
./examples/out-of-cluster-client-configuration/main.go
./examples/dynamic-create-update-delete-deployment/main.go
./examples/create-update-delete-deployment/main.go
./examples/leader-election/main.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™äº›æ–‡ä»¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿä¸Šæ‰‹ client-goï¼š</p>
<ul>
<li><code v-pre>./examples/workqueue/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆWorkqueueï¼‰å®ç°èµ„æºæ§åˆ¶å™¨ï¼ˆControllerï¼‰ã€‚</li>
<li><code v-pre>./examples/in-cluster-client-configuration/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•åœ¨ Kubernetes é›†ç¾¤å†…éƒ¨ä½¿ç”¨ <code v-pre>client-go</code> è®¿é—® Kubernetes API Serverã€‚</li>
<li><code v-pre>./examples/out-of-cluster-client-configuration/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•åœ¨ Kubernetes é›†ç¾¤å¤–éƒ¨ä½¿ç”¨ <code v-pre>client-go</code> è®¿é—® Kubernetes API Serverã€‚</li>
<li><code v-pre>./examples/dynamic-create-update-delete-deployment/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼ˆDynamic Clientï¼‰å®ç°å¯¹ Deployment èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚</li>
<li><code v-pre>./examples/create-update-delete-deployment/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ <code v-pre>client-go</code> å®ç°å¯¹ Deployment èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚</li>
<li><code v-pre>./examples/leader-election/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„ Leader Election æœºåˆ¶ï¼Œå®ç°èµ„æºæ§åˆ¶å™¨çš„é«˜å¯ç”¨æ€§å’Œæ•…éšœè½¬ç§»ã€‚</li>
</ul>
<p>åœ¨ <code v-pre>/root/workspaces/client-go/examples/workqueue</code> ç›®å½•ä¸­ï¼š</p>
<p>æˆ‘ä»¬æ˜¯ä¸èƒ½ç›´æ¥ç¼–è¯‘çš„ï¼Œçœ‹ä¸€ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ ./main <span class="token parameter variable">--help</span>
Usage of ./main:
  <span class="token parameter variable">-kubeconfig</span> string
        absolute path to the kubeconfig <span class="token function">file</span>
  <span class="token parameter variable">-master</span> string
        master url
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŒ‡å®š kubeconfig ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡  <code v-pre>export KUBECONFIG</code> ï¼‰</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ ./main <span class="token parameter variable">-kubeconfig</span> ~/.kube/config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote>
<p>ä¸¾ä¾‹ï¼šä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸€ä¸ªåä¸º myresource çš„è‡ªå®šä¹‰èµ„æºï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° YAML æ–‡ä»¶ä¸­ã€‚ç„¶åï¼Œè¿è¡Œ <code v-pre>go run ./examples/workqueue/main.go</code> å‘½ä»¤å¯åŠ¨æ§åˆ¶å™¨ã€‚æ­¤æ—¶ï¼Œæ§åˆ¶å™¨ä¼šå¼€å§‹ç›‘å¬ myresource èµ„æºï¼Œå¹¶åœ¨è¯¥èµ„æºè¢«åˆ›å»ºæˆ–æ›´æ–°æ—¶ï¼Œå¼‚æ­¥åœ°å¤„ç†ä¸€äº›ä»»åŠ¡ã€‚</p>
</blockquote>
<p><strong>ç»§ç»­æ¼”ç¤º å¯¹ Deployment CURD æ“ä½œï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token builtin class-name">cd</span> dynamic-create-update-delete-deployment/
â¯ <span class="token function">ls</span>
README.md  main.go
â¯ go build main.go
â¯ ./main
Creating deployment<span class="token punctuation">..</span>.
Created deployment <span class="token string">"demo-deployment"</span><span class="token builtin class-name">.</span>
-<span class="token operator">></span> Press Return key to continue.

Updating deployment<span class="token punctuation">..</span>.
Updated deployment<span class="token punctuation">..</span>.
-<span class="token operator">></span> Press Return key to continue.

Listing deployments <span class="token keyword">in</span> namespace <span class="token string">"default"</span><span class="token builtin class-name">:</span>
 * demo-deployment <span class="token punctuation">(</span><span class="token number">1</span> replicas<span class="token punctuation">)</span>
 * my-nginx-app <span class="token punctuation">(</span><span class="token number">3</span> replicas<span class="token punctuation">)</span>
 * nginx-deployment <span class="token punctuation">(</span><span class="token number">3</span> replicas<span class="token punctuation">)</span>
-<span class="token operator">></span> Press Return key to continue.

Deleting deployment<span class="token punctuation">..</span>.
Deleted deployment.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>./examples/dynamic-create-update-delete-deployment/main.go</code>ï¼šè¿™ä¸ªç¤ºä¾‹æ–‡ä»¶æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼ˆDynamic Clientï¼‰å®ç°å¯¹ Deployment èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚ä½¿ç”¨åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ›´åŠ çµæ´»åœ°æ“ä½œ Kubernetes èµ„æºå¯¹è±¡ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™å¤æ‚çš„ä»£ç ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ DynamicClient å¯¹è±¡ï¼ŒåŠ¨æ€åœ°åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ Deployment èµ„æºå¯¹è±¡ã€‚</p>
<blockquote>
<p>ä¸¾ä¾‹ï¼šä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸€ä¸ªåä¸º my-deployment çš„ Deployment å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° YAML æ–‡ä»¶ä¸­ã€‚ç„¶åï¼Œè¿è¡Œ <code v-pre>go run ./examples/dynamic-create-update-delete-deployment/main.go</code> å‘½ä»¤ï¼Œä½¿ç”¨ DynamicClient å¯¹è±¡ï¼ŒåŠ¨æ€åœ°åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ my-deployment Deployment å¯¹è±¡ã€‚</p>
</blockquote>
<p>æµ‹è¯•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ k get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
demo-deployment    <span class="token number">0</span>/1     <span class="token number">0</span>            <span class="token number">0</span>           4s
my-nginx-app       <span class="token number">0</span>/3     <span class="token number">3</span>            <span class="token number">0</span>           26h
nginx-deployment   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           165m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr>
<p><strong>æ¥ä¸‹æ¥çš„ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç» sample-controllerã€kubebuilderã€operator-sdk ä»¥åŠå®ƒä»¬ä¹‹é—´é‚£å¾®å¦™çš„å…³ç³»ã€‚</strong></p>
<h2 id="sample-controller" tabindex="-1"><a class="header-anchor" href="#sample-controller" aria-hidden="true">#</a> sample-controller</h2>
<p>æˆ‘ä»¬å°†ç”¨äºå®éªŒåˆ›å»ºæ“ä½œç¬¦çš„ç¬¬ä¸€ä¸ªå·¥å…·æ˜¯sample-controllerï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼šhttps://github.com/kubernetes/sample-controllerã€‚</p>
<p>è¿™ä¸ªé¡¹ç›®ä¸º <code v-pre>Foo</code> ç±»å‹å®ç°äº†ä¸€ä¸ªç®€å•çš„æ“ä½œç¬¦ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡ <code v-pre>foo</code> æ—¶ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ä¸€äº›å…¬å…±Dockeré•œåƒå’Œç‰¹å®šæ•°é‡å‰¯æœ¬çš„éƒ¨ç½²ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä¸Šé¢å·²ç»ä¸‹è½½è¿‡ï¼Œç°åœ¨æˆ‘å°è¯•ç¼–è¯‘å®ƒï¼š</p>
<blockquote>
<p>go version: <code v-pre> gvm use go1.20</code></p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SAMPLE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/sample-controller
â¯ <span class="token function">git</span> clone https://github.com/cubxxw/sample-controller.git <span class="token variable">$SAMPLE</span>  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token variable">$SAMPLE</span><span class="token punctuation">;</span>
â¯ go build <span class="token parameter variable">-o</span> ctrl <span class="token builtin class-name">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª CRDï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ kubectl apply <span class="token parameter variable">-f</span> artifacts/examples/crd-status-subresource.yaml
customresourcedefinition.apiextensions.k8s.io/foos.samplecontroller.k8s.io created
â¯ k get CustomResourceDefinition
NAME                           CREATED AT
crontabs.stable.example.com    <span class="token number">2023</span>-04-07T09:17:55Z
foos.samplecontroller.k8s.io   <span class="token number">2023</span>-04-08T12:09:46Z
guestbooks.webapp.my.domain    <span class="token number">2023</span>-04-07T15:42:22Z
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæˆ‘ä»¬è¿è¡Œæ§åˆ¶å™¨ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>./ctrl <span class="token parameter variable">-kubeconfig</span> ~/.kube/config  <span class="token parameter variable">-logtostderr</span><span class="token operator">=</span>true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote>
<p><code v-pre>-logtostderr=true</code>ï¼šå°†æ—¥å¿—è®°å½•åˆ°æ ‡å‡†é”™è¯¯è€Œä¸æ˜¯æ–‡ä»¶(é»˜è®¤ä¸ºtrue)</p>
</blockquote>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸Šæ“ä½œ <code v-pre>Foo</code> å¯¹è±¡ï¼Œçœ‹çœ‹æ§åˆ¶å™¨ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ kubectl apply <span class="token parameter variable">-f</span> artifacts/examples/example-foo.yaml
foo.samplecontroller.k8s.io/example-foo created
â¯ k get Foo
NAME          AGE
example-foo   9s

<span class="token comment"># ----- åˆ é™¤ Foo -------</span>
â¯ kubectl delete <span class="token parameter variable">-f</span> artifacts/examples/example-foo.yaml
foo.samplecontroller.k8s.io <span class="token string">"example-foo"</span> deleted
â¯ k get pod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token string">"Foo"</span>
â¯ k get Foo
No resources found <span class="token keyword">in</span> default namespace.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>åœ¨ç¼–å†™å’Œä½¿ç”¨Kubernetes 1.11.0æ—¶ï¼Œæ§åˆ¶å™¨å°†åœ¨åˆ›å»ºéƒ¨ç½²åæ›´æ–° <code v-pre>foo</code> å¯¹è±¡çš„çŠ¶æ€æ—¶è¿›å…¥æ— é™å¾ªç¯ï¼šåœ¨ <code v-pre>updateFooStatus</code> å‡½æ•°ä¸­ï¼Œæ‚¨å¿…é¡»é€šè¿‡è°ƒç”¨ <code v-pre>UpdateStatus(fooCopy)</code> æ¥æ›´æ”¹å¯¹ <code v-pre>Update(fooCopy)</code> çš„è°ƒç”¨ã€‚</p>
</blockquote>
<p><strong>å¾ˆå¥½ç†è§£ä¸æ˜¯å—ï¼Œapply å£°æ˜å¼åœ¨ controller ä¸­ä¹Ÿæ˜¯é€šè¿‡ for å¾ªç¯ä¸æ–­çš„è¿›è¡Œæ ¡éªŒã€‚æ£€æŸ¥ status å’Œ spec çš„åŒºåˆ«ï¼Œæ˜¯å¦è¾¾æˆä¸€è‡´ã€‚</strong></p>
<p>åˆ°ç›®å‰ä¸ºæ­¢ä¸€åˆ‡é¡ºåˆ©ï¼Œæ§åˆ¶å™¨ä½¿å·¥ä½œï¼šå½“æˆ‘ä»¬åˆ›å»º <code v-pre>foo</code> å¯¹è±¡æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªéƒ¨ç½²ï¼Œå½“æˆ‘ä»¬åˆ é™¤è¯¥å¯¹è±¡æ—¶ï¼Œå®ƒä¼šåœæ­¢éƒ¨ç½²ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è°ƒæ•´CRDå’Œæ§åˆ¶å™¨ï¼Œä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„è‡ªå®šä¹‰èµ„æºå®šä¹‰ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ç¼–å†™ä¸€ä¸ª operator ï¼Œå®ƒå°†åœ¨é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šéƒ¨ç½²ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ã€‚å®ƒå°†ä½¿ç”¨ <code v-pre>DaemonSet</code> å¯¹è±¡æ¥éƒ¨ç½²æ­¤å®ˆæŠ¤è¿›ç¨‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤ŸæŒ‡å®šä¸€ä¸ªæ ‡ç­¾ï¼Œä»¥ä¾¿ä»…åœ¨æ ‡è®°æœ‰æ­¤æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šéƒ¨ç½²å®ˆæŠ¤è¿›ç¨‹ã€‚æˆ‘ä»¬è¿˜å¸Œæœ›èƒ½å¤ŸæŒ‡å®šè¦éƒ¨ç½²çš„ Docker é•œåƒï¼Œè€Œä¸æ˜¯åƒ<code v-pre>sample-controller</code>é‚£æ ·ä½¿ç”¨é™æ€é•œåƒã€‚</p>
<p>è®©æˆ‘ä»¬é¦–å…ˆä¸º <code v-pre>GenericDaemon</code> ç±»å‹åˆ›å»ºè‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼š</p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code>// artifacts/generic<span class="token punctuation">-</span>daemon/crd.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> genericdaemons.mydomain.com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> mydomain.com
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1beta1
  <span class="token key atrule">names</span><span class="token punctuation">:</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Genericdaemon
    <span class="token key atrule">plural</span><span class="token punctuation">:</span> genericdaemons
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
  <span class="token key atrule">validation</span><span class="token punctuation">:</span>
    <span class="token key atrule">openAPIV3Schema</span><span class="token punctuation">:</span>
      <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">properties</span><span class="token punctuation">:</span>
            <span class="token key atrule">label</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
            <span class="token key atrule">image</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
          <span class="token key atrule">required</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> image
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯è¦éƒ¨ç½²çš„å®ˆæŠ¤è¿›ç¨‹çš„ç¬¬ä¸€ä¸ªç¤ºä¾‹ï¼š</p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code>// artifacts/generic<span class="token punctuation">-</span>daemon/syslog.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> mydomain.com/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Genericdaemon
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> syslog
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">label</span><span class="token punctuation">:</span> logs
  <span class="token key atrule">image</span><span class="token punctuation">:</span> mbessler/syslogdocker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨æˆ‘ä»¬å¿…é¡»ä¸ºAPIæ„å»ºgoæ–‡ä»¶ï¼Œä»¥ä¾¿ä»æ“ä½œç¬¦è®¿é—®è¿™ä¸ªæ–°çš„è‡ªå®šä¹‰èµ„æºå®šä¹‰ã€‚ä¸ºæ­¤ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°ç›®å½• <code v-pre>pkg/apis/genericdaemon</code> ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­å¤åˆ¶åœ¨ <code v-pre>pkg/apis/samplecontroller</code> ä¸­æ‰¾åˆ°çš„æ–‡ä»¶ï¼ˆä½†ä¸åŒ…æ‹¬ <code v-pre>zz_generated.deepcopy.go</code> ï¼‰</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>â¯  tree pkg<span class="token operator">/</span>apis<span class="token operator">/</span>genericdaemon<span class="token operator">/</span>
pkg<span class="token operator">/</span>apis<span class="token operator">/</span>genericdaemon<span class="token operator">/</span>
â”œâ”€â”€ register<span class="token punctuation">.</span><span class="token keyword">go</span>
â””â”€â”€ v1alpha1
    â”œâ”€â”€ doc<span class="token punctuation">.</span><span class="token keyword">go</span>
    â”œâ”€â”€ register<span class="token punctuation">.</span><span class="token keyword">go</span>
    â””â”€â”€ types<span class="token punctuation">.</span><span class="token keyword">go</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¹¶è°ƒæ•´å…¶å†…å®¹ï¼ˆæ›´æ”¹çš„éƒ¨åˆ†ä»¥ç²—ä½“æ˜¾ç¤ºï¼‰ï¼š</p>
<p>å¹¶è°ƒæ•´å…¶å†…å®¹ï¼ˆæ›´æ”¹çš„éƒ¨åˆ†ä»¥ç²—ä½“æ˜¾ç¤ºï¼‰ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">////////////////</span>
<span class="token comment">// register.go</span>
<span class="token comment">////////////////</span>
<span class="token keyword">package</span> genericdaemon
<span class="token keyword">const</span> <span class="token punctuation">(</span>
 GroupName <span class="token operator">=</span> <span class="token string">"mydomain.com"</span>
<span class="token punctuation">)</span>
<span class="token comment">/////////////////////</span>
<span class="token comment">// v1beta1/doc.go</span>
<span class="token comment">/////////////////////</span>
<span class="token comment">// +k8s:deepcopy-gen=package</span>
<span class="token comment">// Package v1beta1 is the v1beta1 version of the API.</span>
<span class="token comment">// +groupName=mydomain.com</span>
<span class="token keyword">package</span> v1beta1
<span class="token comment">/////////////////////////</span>
<span class="token comment">// v1beta1/register.go</span>
<span class="token comment">/////////////////////////</span>
<span class="token keyword">package</span> v1beta1
<span class="token keyword">import</span> <span class="token punctuation">(</span>
 metav1 <span class="token string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span>
 <span class="token string">"k8s.io/apimachinery/pkg/runtime"</span>
 <span class="token string">"k8s.io/apimachinery/pkg/runtime/schema"</span>
genericdaemon <span class="token string">"k8s.io/sample-controller/pkg/apis/genericdaemon"</span>
<span class="token punctuation">)</span>
<span class="token comment">// SchemeGroupVersion is group version used to register these objects</span>
<span class="token keyword">var</span> SchemeGroupVersion <span class="token operator">=</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> genericdaemon<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Version<span class="token punctuation">:</span> <span class="token string">"v1beta1"</span><span class="token punctuation">}</span>
<span class="token comment">// Kind takes an unqualified kind and returns back a Group qualified GroupKind</span>
<span class="token keyword">func</span> <span class="token function">Kind</span><span class="token punctuation">(</span>kind <span class="token builtin">string</span><span class="token punctuation">)</span> schema<span class="token punctuation">.</span>GroupKind <span class="token punctuation">{</span>
 <span class="token keyword">return</span> SchemeGroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Resource takes an unqualified resource and returns a Group qualified GroupResource</span>
<span class="token keyword">func</span> <span class="token function">Resource</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">)</span> schema<span class="token punctuation">.</span>GroupResource <span class="token punctuation">{</span>
 <span class="token keyword">return</span> SchemeGroupVersion<span class="token punctuation">.</span><span class="token function">WithResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
 SchemeBuilder <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewSchemeBuilder</span><span class="token punctuation">(</span>addKnownTypes<span class="token punctuation">)</span>
 AddToScheme   <span class="token operator">=</span> SchemeBuilder<span class="token punctuation">.</span>AddToScheme
<span class="token punctuation">)</span>
<span class="token comment">// Adds the list of known types to Scheme.</span>
<span class="token keyword">func</span> <span class="token function">addKnownTypes</span><span class="token punctuation">(</span>scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
 scheme<span class="token punctuation">.</span><span class="token function">AddKnownTypes</span><span class="token punctuation">(</span>SchemeGroupVersion<span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>Genericdaemon<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>GenericdaemonList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span>
 metav1<span class="token punctuation">.</span><span class="token function">AddToGroupVersion</span><span class="token punctuation">(</span>scheme<span class="token punctuation">,</span> SchemeGroupVersion<span class="token punctuation">)</span>
 <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">//////////////////////</span>
<span class="token comment">// v1beta1/types.go</span>
<span class="token comment">//////////////////////</span>
<span class="token keyword">package</span> v1beta1
<span class="token keyword">import</span> <span class="token punctuation">(</span>
 metav1 <span class="token string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span>
<span class="token punctuation">)</span>
<span class="token comment">// +genclient</span>
<span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>
<span class="token comment">// Genericdaemon is a specification for a Generic Daemon resource</span>
<span class="token keyword">type</span> Genericdaemon <span class="token keyword">struct</span> <span class="token punctuation">{</span>
 metav1<span class="token punctuation">.</span>TypeMeta   <span class="token string">`json:",inline"`</span>
 metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">`json:"metadata,omitempty"`</span>
 Spec   GenericdaemonSpec   <span class="token string">`json:"spec"`</span>
 Status GenericdaemonStatus <span class="token string">`json:"status"`</span>
<span class="token punctuation">}</span>
<span class="token comment">// GenericDaemonSpec is the spec for a GenericDaemon resource</span>
<span class="token keyword">type</span> GenericdaemonSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
 Label <span class="token builtin">string</span> <span class="token string">`json:"label"`</span>
 Image <span class="token builtin">string</span> <span class="token string">`json:"image"`</span>
<span class="token punctuation">}</span>
<span class="token comment">// GenericDaemonStatus is the status for a GenericDaemon resource</span>
<span class="token keyword">type</span> GenericdaemonStatus <span class="token keyword">struct</span> <span class="token punctuation">{</span>
 Installed <span class="token builtin">int32</span> <span class="token string">`json:"installed"`</span>
<span class="token punctuation">}</span>
<span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>
<span class="token comment">// GenericDaemonList is a list of GenericDaemon resources</span>
<span class="token keyword">type</span> GenericdaemonList <span class="token keyword">struct</span> <span class="token punctuation">{</span>
 metav1<span class="token punctuation">.</span>TypeMeta <span class="token string">`json:",inline"`</span>
 metav1<span class="token punctuation">.</span>ListMeta <span class="token string">`json:"metadata"`</span>
Items <span class="token punctuation">[</span><span class="token punctuation">]</span>Genericdaemon <span class="token string">`json:"items"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹å®ƒä¸ºæˆ‘ä»¬æä¾›äº†å“ªäº›å¯ç”¨çš„è„šæœ¬:</p>
<p>å®ƒä½¿ç”¨www.example.comä¸­çš„ç”Ÿæˆå™¨<a href="https://github.com/kubernetes/code-generator" target="_blank" rel="noopener noreferrer">k8s.io/code-generator<ExternalLinkIcon/></a> ç”Ÿæˆä¸€ä¸ªç±»å‹åŒ–çš„å®¢æˆ·ç«¯ã€informersã€listerså’Œdeep-copyå‡½æ•°ã€‚ä½ å¯ä»¥ è¯·ä½¿ç”¨<code v-pre>./hack/update-codegen.sh</code>è„šæœ¬è‡ªå·±æ‰§è¡Œæ­¤æ“ä½œã€‚</p>
<h3 id="ä»£ç ç”Ÿæˆå™¨" tabindex="-1"><a class="header-anchor" href="#ä»£ç ç”Ÿæˆå™¨" aria-hidden="true">#</a> ä»£ç ç”Ÿæˆå™¨</h3>
<p><code v-pre>k8s.io/client-go</code> æä¾›äº†å¯¹k8såŸç”Ÿèµ„æºçš„informerå’Œclientsetç­‰ç­‰ï¼Œä½†å¯¹äºè‡ªå®šä¹‰èµ„æºçš„æ“ä½œåˆ™ç›¸å¯¹ä½æ•ˆï¼Œéœ€è¦ä½¿ç”¨ rest api å’Œ dynamic client æ¥æ“ä½œï¼Œå¹¶è‡ªå·±å®ç°ååºåˆ—åŒ–ç­‰åŠŸèƒ½ã€‚</p>
<p>code-generator æä¾›äº†ä»¥ä¸‹å·¥å…·ç”¨äºä¸ºk8sä¸­çš„èµ„æºç”Ÿæˆç›¸å…³ä»£ç ï¼Œå¯ä»¥æ›´åŠ æ–¹ä¾¿çš„æ“ä½œè‡ªå®šä¹‰èµ„æºï¼š</p>
<p><code v-pre>deepcopy-gen</code>: ç”Ÿæˆæ·±åº¦æ‹·è´å¯¹è±¡æ–¹æ³•</p>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li>åœ¨æ–‡ä»¶ä¸­æ·»åŠ æ³¨é‡Š<code v-pre>// +k8s:deepcopy-gen=package</code></li>
<li>ä¸ºå•ä¸ªç±»å‹æ·»åŠ è‡ªåŠ¨ç”Ÿæˆ<code v-pre>// +k8s:deepcopy-gen=true</code></li>
<li>ä¸ºå•ä¸ªç±»å‹å…³é—­è‡ªåŠ¨ç”Ÿæˆ<code v-pre>// +k8s:deepcopy-gen=false</code></li>
</ul>
<p><code v-pre>client-gen</code>: ä¸ºèµ„æºç”Ÿæˆæ ‡å‡†çš„æ“ä½œæ–¹æ³•(get;list;watch;create;update;patch;delete)</p>
<blockquote>
<p>åœ¨ <code v-pre>pkg/apis/${GROUP}/${VERSION}/types.go</code>ä¸­ä½¿ç”¨ï¼Œä½¿ç”¨<code v-pre>// +genclient</code>æ ‡è®°å¯¹åº”ç±»å‹ç”Ÿæˆçš„å®¢æˆ·ç«¯ï¼Œ å¦‚æœä¸è¯¥ç±»å‹ç›¸å…³è”çš„èµ„æºä¸æ˜¯å‘½åç©ºé—´èŒƒå›´çš„(ä¾‹å¦‚PersistentVolume), åˆ™è¿˜éœ€è¦é™„åŠ <code v-pre>// + genclientï¼šnonNamespaced</code>æ ‡è®°ï¼Œ</p>
</blockquote>
<ul>
<li>
<p><code v-pre>// +genclient</code> - ç”Ÿæˆé»˜è®¤çš„å®¢æˆ·ç«¯åŠ¨ä½œå‡½æ•°ï¼ˆcreate, update, delete, get, list, update, patch, watchä»¥åŠ æ˜¯å¦ç”ŸæˆupdateStatuså–å†³äº.Statuså­—æ®µæ˜¯å¦å­˜åœ¨ï¼‰ã€‚</p>
</li>
<li>
<p><code v-pre>// +genclient:nonNamespaced</code> - æ‰€æœ‰åŠ¨ä½œå‡½æ•°éƒ½æ˜¯åœ¨æ²¡æœ‰åç§°ç©ºé—´çš„æƒ…å†µä¸‹ç”Ÿæˆ</p>
</li>
<li>
<p><code v-pre>// +genclient:onlyVerbs=create,get</code> - æŒ‡å®šçš„åŠ¨ä½œå‡½æ•°è¢«ç”Ÿæˆ.</p>
</li>
<li>
<p><code v-pre>// +genclient:skipVerbs=watch</code> - ç”Ÿæˆwatchä»¥å¤–æ‰€æœ‰çš„åŠ¨ä½œå‡½æ•°.</p>
</li>
<li>
<p><code v-pre>// +genclient:noStatus</code> - å³ä½¿.Statuså­—æ®µå­˜åœ¨ä¹Ÿä¸ç”ŸæˆupdateStatusåŠ¨ä½œå‡½æ•°</p>
</li>
</ul>
<p><code v-pre>informer-gen</code>: ç”Ÿæˆinformerï¼Œæä¾›äº‹ä»¶æœºåˆ¶(AddFunc,UpdateFunc,DeleteFunc)æ¥å“åº”kubernetesçš„event</p>
<p><code v-pre>lister-gen</code>: ä¸ºgetå’Œlistæ–¹æ³•æä¾›åªè¯»ç¼“å­˜å±‚</p>
<p><code v-pre>conversion-gen</code>æ˜¯ç”¨äºè‡ªåŠ¨ç”Ÿæˆåœ¨å†…éƒ¨å’Œå¤–éƒ¨ç±»å‹ä¹‹é—´è½¬æ¢çš„å‡½æ•°çš„å·¥å…·</p>
<p>ä¸€èˆ¬çš„è½¬æ¢ä»£ç ç”Ÿæˆä»»åŠ¡æ¶‰åŠä¸‰å¥—ç¨‹åºåŒ…ï¼š</p>
<ul>
<li>ä¸€å¥—åŒ…å«å†…éƒ¨ç±»å‹çš„ç¨‹åºåŒ…ï¼Œ</li>
<li>ä¸€å¥—åŒ…å«å¤–éƒ¨ç±»å‹çš„ç¨‹åºåŒ…</li>
<li>å•ä¸ªç›®æ ‡ç¨‹åºåŒ…ï¼ˆå³ï¼Œç”Ÿæˆçš„è½¬æ¢å‡½æ•°æ‰€åœ¨çš„ä½ç½®ï¼Œä»¥åŠå¼€å‘äººå‘˜æˆæƒçš„è½¬æ¢åŠŸèƒ½æ‰€åœ¨çš„ä½ç½®ï¼‰ã€‚åŒ…å«å†…éƒ¨ç±»å‹çš„åŒ…åœ¨Kubernetesçš„å¸¸è§„ä»£ç ç”Ÿæˆæ¡†æ¶ä¸­æ‰®æ¼”ç€ç§°ä¸º<code v-pre>peer package</code>çš„è§’è‰²ã€‚</li>
</ul>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li>æ ‡è®°è½¬æ¢å†…éƒ¨è½¯ä»¶åŒ… <code v-pre>// +k8s:conversion-gen=&lt;import-path-of-internal-package&gt;</code></li>
<li>æ ‡è®°è½¬æ¢å¤–éƒ¨è½¯ä»¶åŒ…<code v-pre>// +k8s:conversion-gen-external-types=&lt;import-path-of-external-package&gt;</code></li>
<li>æ ‡è®°ä¸è½¬æ¢å¯¹åº”æ³¨é‡Šæˆ–ç»“æ„ <code v-pre>// +k8s:conversion-gen=false</code></li>
</ul>
<p><code v-pre>defaulter-gen</code> ç”¨äºç”Ÿäº§Defaulterå‡½æ•°</p>
<ul>
<li>ä¸ºåŒ…å«å­—æ®µçš„æ‰€æœ‰ç±»å‹åˆ›å»ºdefaultersï¼Œ<code v-pre>// +k8s:defaulter-gen=&lt;field-name-to-flag&gt;</code></li>
<li>æ‰€æœ‰éƒ½ç”Ÿæˆ<code v-pre>// +k8s:defaulter-gen=true|false</code></li>
</ul>
<p><code v-pre>go-to-protobuf</code> é€šè¿‡go structç”Ÿæˆpb idl</p>
<p><code v-pre>import-boss</code> åœ¨ç»™å®šå­˜å‚¨åº“ä¸­å¼ºåˆ¶æ‰§è¡Œå¯¼å…¥é™åˆ¶</p>
<p><code v-pre>openapi-gen</code> ç”ŸæˆopenAPIå®šä¹‰</p>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><code v-pre>+k8s:openapi-gen=true</code> ä¸ºæŒ‡å®šåŒ…æˆ–æ–¹æ³•å¼€å¯</li>
<li><code v-pre>+k8s:openapi-gen=false</code> æŒ‡å®šåŒ…å…³é—­</li>
</ul>
<p><code v-pre>register-gen</code> ç”Ÿæˆregister</p>
<p><code v-pre>set-gen</code></p>
<p>code-generatoræ•´åˆäº†è¿™äº›genï¼Œä½¿ç”¨è„šæœ¬<a href="https://github.com/kubernetes/code-generator/blob/master/generate-groups.sh" target="_blank" rel="noopener noreferrer">generate-groups.sh<ExternalLinkIcon/></a>å’Œ<a href="https://github.com/kubernetes/code-generator/blob/master/generate-internal-groups.sh" target="_blank" rel="noopener noreferrer">generate-internal-groups.sh<ExternalLinkIcon/></a>å¯ä»¥ä¸ºè‡ªå®šä¹‰èµ„æºç”Ÿäº§ç›¸å…³ä»£ç ã€‚</p>
<h3 id="è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ" aria-hidden="true">#</a> è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ</h3>
<p>è„šæœ¬ <code v-pre>hack/update-codegen.sh</code> å¯ç”¨äºå›´ç»•æˆ‘ä»¬ä½¿ç”¨è¿™äº›å…ˆå‰æ–‡ä»¶å®šä¹‰çš„æ–°è‡ªå®šä¹‰èµ„æºå®šä¹‰ç”Ÿæˆä»£ç ã€‚æˆ‘ä»¬å°†ä¸å¾—ä¸è°ƒæ•´è¿™ä¸ªè„šæœ¬æ¥ä¸ºæˆ‘ä»¬çš„æ–°CRDç”Ÿæˆæ–‡ä»¶ï¼š</p>
<p><code v-pre>update-codegen</code>è„šæœ¬å°†è‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶&amp; ç›®å½•ï¼š</p>
<ul>
<li><code v-pre>pkg/apis/samplecontroller/v1alpha1/zz_generated.deepcopy.go</code></li>
<li><code v-pre>pkg/generated/</code></li>
</ul>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code>// hack/update<span class="token punctuation">-</span>codegen.sh
<span class="token comment">#!/usr/bin/env bash</span>
set <span class="token punctuation">-</span>o errexit
set <span class="token punctuation">-</span>o nounset
set <span class="token punctuation">-</span>o pipefail

SCRIPT_ROOT=$(dirname "$<span class="token punctuation">{</span>BASH_SOURCE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span>")/..
CODEGEN_PKG=$<span class="token punctuation">{</span>CODEGEN_PKG<span class="token punctuation">:</span><span class="token punctuation">-</span>$(cd "$<span class="token punctuation">{</span>SCRIPT_ROOT<span class="token punctuation">}</span>"; ls <span class="token punctuation">-</span>d <span class="token punctuation">-</span>1 ./vendor/k8s.io/code<span class="token punctuation">-</span>generator 2<span class="token punctuation">></span>/dev/null <span class="token punctuation">|</span><span class="token punctuation">|</span> echo ../code<span class="token punctuation">-</span>generator)<span class="token punctuation">}</span>

<span class="token comment"># generate the code with:</span>
<span class="token comment"># --output-base    because this script should also be able to run inside the vendor dir of</span>
<span class="token comment">#                  k8s.io/kubernetes. The output-base is needed for the generators to output into the vendor dir</span>
<span class="token comment">#                  instead of the $GOPATH directly. For normal projects this can be dropped.</span>
echo "===<span class="token punctuation">></span> Generating code<span class="token punctuation">...</span>"
"$<span class="token punctuation">{</span>CODEGEN_PKG<span class="token punctuation">}</span>/generate<span class="token punctuation">-</span>groups.sh" "deepcopy<span class="token punctuation">,</span>client<span class="token punctuation">,</span>informer<span class="token punctuation">,</span>lister" \
  k8s.io/sample<span class="token punctuation">-</span>controller/pkg/generated \
  k8s.io/sample<span class="token punctuation">-</span>controller/pkg/apis \
  samplecontroller<span class="token punctuation">:</span>v1alpha1 \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>output<span class="token punctuation">-</span>base "$(dirname "$<span class="token punctuation">{</span>BASH_SOURCE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span>")/../../.." \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>go<span class="token punctuation">-</span>header<span class="token punctuation">-</span>file "$<span class="token punctuation">{</span>SCRIPT_ROOT<span class="token punctuation">}</span>"/hack/boilerplate.go.txt
<span class="token comment"># To use your own boilerplate text append:</span>
<span class="token comment">#   --go-header-file "${SCRIPT_ROOT}"/hack/custom-boilerplate.go.txt</span>

echo "===<span class="token punctuation">></span> Generating genericdaemon code"
"$<span class="token punctuation">{</span>CODEGEN_PKG<span class="token punctuation">}</span>/generate<span class="token punctuation">-</span>groups.sh" "deepcopy<span class="token punctuation">,</span>client<span class="token punctuation">,</span>informer<span class="token punctuation">,</span>lister" \
  k8s.io/sample<span class="token punctuation">-</span>controller/pkg/generated \
  k8s.io/sample<span class="token punctuation">-</span>controller/pkg/apis \
  genericdaemon<span class="token punctuation">:</span>v1beta1 \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>output<span class="token punctuation">-</span>base "$(dirname "$<span class="token punctuation">{</span>BASH_SOURCE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span>")/../../.." \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>go<span class="token punctuation">-</span>header<span class="token punctuation">-</span>file "$<span class="token punctuation">{</span>SCRIPT_ROOT<span class="token punctuation">}</span>"/hack/boilerplate.go.txt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæ‰§è¡Œå®ƒï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ ./hack/update-codegen.sh 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æˆ‘ä»¬ç°åœ¨å¯ä»¥è°ƒæ•´æˆ‘ä»¬çš„æ“ä½œå‘˜ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»å°†æ‰€æœ‰å¯¹å‰ä¸€ä¸ª <code v-pre>Foo</code> ç±»å‹çš„å¼•ç”¨æ›´æ”¹ä¸º <code v-pre>Genericdaemon</code> ç±»å‹ã€‚ç¬¬äºŒï¼Œå½“åˆ›å»ºæ–°çš„é€šç”¨å®ˆæŠ¤è¿›ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºDaemonsetè€Œä¸æ˜¯éƒ¨ç½²ã€‚</p>
<h3 id="å°†-operator-éƒ¨ç½²åˆ°kubernetesé›†ç¾¤" tabindex="-1"><a class="header-anchor" href="#å°†-operator-éƒ¨ç½²åˆ°kubernetesé›†ç¾¤" aria-hidden="true">#</a> å°† operator éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤</h3>
<p>å½“æˆ‘ä»¬æ ¹æ®éœ€è¦ä¿®æ”¹å®Œsample-controlleråï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶éƒ¨ç½²åˆ°kubernetesé›†ç¾¤ã€‚äº‹å®ä¸Šï¼Œåœ¨è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡ä½¿ç”¨æˆ‘ä»¬çš„å‡­è¯ä»æˆ‘ä»¬çš„å¼€å‘ç³»ç»Ÿè¿è¡Œå®ƒæ¥æµ‹è¯•å®ƒã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„Dockerfileï¼Œç”¨äºä½¿ç”¨<code v-pre>operator</code>æ„å»ºDockeré•œåƒï¼ˆæ‚¨å¿…é¡»ä»åŸå§‹çš„<code v-pre>sample-controller</code>ä¸­åˆ é™¤æ‰€æœ‰ä»£ç æ‰èƒ½æ„å»ºé•œåƒï¼‰ï¼š</p>
<div class="language-docker ext-docker line-numbers-mode"><pre v-pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> golang</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir -p /go/src/k8s.io/sample-controller</span>
<span class="token instruction"><span class="token keyword">ADD</span> . /go/src/k8s.io/sample-controller</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /go</span>
<span class="token instruction"><span class="token keyword">RUN</span> go get ./...</span>
<span class="token instruction"><span class="token keyword">RUN</span> go install -v ./...</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"/go/bin/sample-controller"</span>]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬ç°åœ¨å¯ä»¥æ„å»ºé•œåƒå¹¶å°†å…¶æ¨é€åˆ°Docker Hubï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">docker</span> build <span class="token builtin class-name">.</span> <span class="token parameter variable">-t</span> cubxxw/genericdaemon
â¯ <span class="token function">docker</span> push cubxxw/genericdaemon
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>âš ï¸ æœ€å¼€å§‹ä½¿ç”¨ <code v-pre>buildpacks</code> æ¥æ„å»ºçš„ï¼Œå¤ªç¦»è°±äº†ï¼Œæ”¾å¼ƒäº†~</p>
</blockquote>
<p>æœ€åï¼Œä½¿ç”¨æ­¤æ–°æ˜ åƒå¯åŠ¨éƒ¨ç½²ï¼š</p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code>// deploy.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sample<span class="token punctuation">-</span>controller
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> sample
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> sample
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sample
        <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"cubxxw/genericdaemon:latest"</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>and <code v-pre>kubectl apply -f deploy.yaml</code></p>
<p>operatorç°åœ¨æ­£åœ¨è¿è¡Œï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æ£€æŸ¥podçš„æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆæƒå­˜åœ¨é—®é¢˜;PODä¸è·å¾—å¯¹ä¸åŒèµ„æºçš„è®¿é—®æƒé™ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ kubectl logs sample-controller-66b79c7d5f-2qnft
E0721 <span class="token number">14</span>:34:50.499584       <span class="token number">1</span> reflector.go:134<span class="token punctuation">]</span> k8s.io/sample-controller/pkg/client/informers/externalversions/factory.go:117: Failed to list *v1beta1.Genericdaemon: genericdaemons.mydomain.com is forbidden: User <span class="token string">"system:serviceaccount:default:default"</span> cannot list genericdaemons.mydomain.com at the cluster scope
E0721 <span class="token number">14</span>:34:50.500385       <span class="token number">1</span> reflector.go:134<span class="token punctuation">]</span> k8s.io/client-go/informers/factory.go:131: Failed to list *v1.DaemonSet: daemonsets.apps is forbidden: User <span class="token string">"system:serviceaccount:default:default"</span> cannot list daemonsets.apps at the cluster scope
<span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª <code v-pre>ClusterRole</code> å’Œä¸€ä¸ª <code v-pre>ClusterRoleBinding</code> æ¥ç»™äºˆæ“ä½œå‘˜å¿…è¦çš„æƒé™ï¼š</p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code>// rbac_role.yaml
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> operator<span class="token punctuation">-</span>role
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apps
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> daemonsets
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> update
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> delete
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mydomain.com
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> genericdaemons
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> update
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> delete
// rbac_role_binding.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> operator<span class="token punctuation">-</span>rolebinding
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> operator<span class="token punctuation">-</span>role
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éƒ¨ç½²ï¼š</p>
<div class="language-bash' ext-bash' line-numbers-mode"><pre v-pre class="language-bash'"><code>kubectl apply -f rbac_role.yaml
kubectl delete -f deploy.yaml
kubectl apply -f deploy.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œæ‚¨çš„ operator åº”è¯¥éƒ¨ç½²åˆ°æ‚¨çš„Kubernetesé›†ç¾¤å¹¶å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚</p>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '65.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '67.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
<p><strong>å…³äºCRDæœ‰ä¸€äº›é“¾æ¥:</strong></p>
<ul>
<li>å®˜æ–¹æ–‡æ¡£ï¼šhttps://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/</li>
<li>å®˜æ–¹è§£é‡Šï¼šhttps://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#create-a-customresourcedefinition</li>
<li>CRD Yamlçš„Schemaï¼šhttps://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#customresourcedefinition-v1beta1-apiextensions-k8s-io</li>
<li>https://kubernetes.feisky.xyz/cha-jian-kuo-zhan/api/customresourcedefinition</li>
<li>https://book.kubebuilder.io/</li>
<li>ä¹¦ç±ï¼šã€ŠKubernetes Operator å¼€å‘è¿›é˜¶ - èƒ¡æ¶›ã€‹ ä½†ä¸æ¨èè´­ä¹°~</li>
</ul>
<p><strong>è¿™ç¯‡æ–‡ç« å‚è€ƒçš„åšå®¢è¿æ¥ï¼š</strong></p>
<ul>
<li><a href="https://xieys.club/code-generator-crd/" target="_blank" rel="noopener noreferrer">ä½¿ç”¨code-generatorç”Ÿæˆcrdçš„clientsetã€informerã€listers<ExternalLinkIcon/></a></li>
<li><a href="https://sq.163yun.com/blog/article/174980128954048512" target="_blank" rel="noopener noreferrer">kubernetes1.9ç®¡ä¸­çª¥è±¹-CRDæ¦‚å¿µã€ä½¿ç”¨åœºæ™¯åŠå®ä¾‹<ExternalLinkIcon/></a></li>
<li><a href="https://segmentfault.com/a/1190000039706356" target="_blank" rel="noopener noreferrer">ç»“åˆKubebuilderä¸code-generatorå¼€å‘Operator<ExternalLinkIcon/></a></li>
<li><a href="https://lailin.xyz/post/operator-kubebuilder-clientset.html" target="_blank" rel="noopener noreferrer">kubebuilder èƒ½å¦ç”Ÿæˆç±»ä¼¼ client-go çš„ sdk?<ExternalLinkIcon/></a></li>
<li><a href="https://blog.csdn.net/boling_cavalry/article/details/88917818" target="_blank" rel="noopener noreferrer">k8sè‡ªå®šä¹‰controllerä¸‰éƒ¨æ›²ä¹‹ä¸€:åˆ›å»ºCRDï¼ˆCustom Resource Definitionï¼‰<ExternalLinkIcon/></a></li>
</ul>
<p><strong>å¼ºæ¨å…¥é—¨ç³»åˆ—æ–‡ç« ï¼š</strong></p>
<ul>
<li><a href="https://itnext.io/building-an-operator-for-kubernetes-with-the-sample-controller-b4204be9ad56" target="_blank" rel="noopener noreferrer">sample-controller<ExternalLinkIcon/></a></li>
</ul>
<blockquote>
<ul>
<li>è¿™æ˜¯ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå°†æ¢è®¨sample-controllerã€‚</li>
<li><a href="https://medium.com/p/17cbd3f07761" target="_blank" rel="noopener noreferrer">æœ¬ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« <ExternalLinkIcon/></a>å°†æ¢ç´¢kubebuilderã€‚</li>
<li><a href="https://medium.com/p/40a029ea056" target="_blank" rel="noopener noreferrer">æœ¬ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡æ–‡ç« <ExternalLinkIcon/></a>å°†æ¢è®¨operator-sdkã€‚</li>
</ul>
</blockquote>
</div></template>


