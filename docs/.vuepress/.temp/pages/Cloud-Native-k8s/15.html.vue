<template><div><ul>
<li><a href="http://nsddd.top" target="_blank" rel="noopener noreferrer">author<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬15èŠ‚-k3s-è¡¥å……" tabindex="-1"><a class="header-anchor" href="#ç¬¬15èŠ‚-k3s-è¡¥å……" aria-hidden="true">#</a> ç¬¬15èŠ‚ k3s è¡¥å……</h1>
<div><a href = '14.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '16.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<nav class="table-of-contents"><ul><li><router-link to="#èµ„æºåˆ†æ">èµ„æºåˆ†æ</router-link><ul><li><router-link to="#usr-local-bin-é‡è¦äºŒè¿›åˆ¶">/usr/local/bin é‡è¦äºŒè¿›åˆ¶</router-link></li></ul></li><li><router-link to="#è„šæœ¬å®‰è£…é€‰é¡¹">è„šæœ¬å®‰è£…é€‰é¡¹</router-link><ul><li><router-link to="#æ€»ç»“">æ€»ç»“</router-link></li></ul></li><li><router-link to="#å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……">å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……</router-link></li><li><router-link to="#é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨-k3s">é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨ K3s</router-link></li><li><router-link to="#k3s-server-agent-é…ç½®">K3s Server/Agent é…ç½®</router-link></li><li><router-link to="#ç½‘ç»œé€‰é¡¹">ç½‘ç»œé€‰é¡¹</router-link><ul><li><router-link to="#flannel-é€‰é¡¹">Flannel é€‰é¡¹</router-link></li><li><router-link to="#flannel-backend-ä½¿ç”¨-host-gw">flannel-backend ä½¿ç”¨ host-gw</router-link></li><li><router-link to="#å¯ç”¨-directrouting">å¯ç”¨ Directrouting</router-link></li></ul></li><li><router-link to="#è‡ªå®šä¹‰-cni">è‡ªå®šä¹‰ CNI</router-link></li><li><router-link to="#ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…">ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…</router-link><ul><li><router-link to="#ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</router-link></li></ul></li><li><router-link to="#end-é“¾æ¥">END é“¾æ¥</router-link></li></ul></nav>
<p>[TOC]</p>
<div class="custom-container danger"><p class="custom-container-title">è­¦å‘Š</p>
<p>é¡µé¢å†…å®¹å¤ªå¤šå¡é¡¿ï¼Œæ–°å¼€ååŠéƒ¨åˆ†è¡¥å……~</p>
<ul>
<li><a href="https://docker.nsddd.top/Cloud-Native/7.html" target="_blank" rel="noopener noreferrer">k3s vs k0s<ExternalLinkIcon/></a></li>
</ul>
</div>
<h2 id="èµ„æºåˆ†æ" tabindex="-1"><a class="header-anchor" href="#èµ„æºåˆ†æ" aria-hidden="true">#</a> èµ„æºåˆ†æ</h2>
<p>èµ„æºå ç”¨ç‡ä½æ˜¯ k3s çªå‡ºçš„ç‰¹ç‚¹ï¼Œé’ˆå¯¹ k3s ç‰¹æ€§ï¼Œåˆ†æèµ„æºçš„å ç”¨ï¼š</p>
<p><strong>å½±å“èµ„æºåˆ©ç”¨ç‡çš„å› ç´ ï¼š</strong></p>
<ul>
<li>
<p><code v-pre>K3s server</code>ï¼šK3s server çš„åˆ©ç”¨ç‡æ•°æ®ä¸»è¦æ˜¯ç”±æ”¯æŒ Kubernetes æ•°æ®å­˜å‚¨ï¼ˆkine æˆ– etcdï¼‰ã€API Serverã€Controller-Manager å’Œ Scheduler æ§åˆ¶ã€‚ <strong>åˆ›å»º/ä¿®æ”¹/åˆ é™¤</strong> èµ„æºå°†å¯¼è‡´æš‚æ—¶çš„åˆ©ç”¨ç‡ä¸Šå‡ã€‚å¤§é‡ä½¿ç”¨ Kubernetes æ•°æ®å­˜å‚¨çš„ operators æˆ–åº”ç”¨ç¨‹åºä¹Ÿå°†å¢åŠ  server çš„èµ„æºéœ€æ±‚ã€‚</p>
</li>
<li>
<p><code v-pre>K3s agent</code>ï¼šç®¡ç†é•œåƒã€æä¾› <strong>å­˜å‚¨æˆ–åˆ›å»º/é”€æ¯å®¹å™¨</strong> çš„æ“ä½œå°†å¯¼è‡´åˆ©ç”¨ç‡çš„æš‚æ—¶ä¸Šå‡ï¼Œæ‹‰å–é•œåƒé€šå¸¸ä¼šå½±å“ CPU å’Œ IOï¼Œå› ä¸ºå®ƒä»¬æ¶‰åŠå°†é•œåƒå†…å®¹è§£å‹åˆ°ç£ç›˜ã€‚å¦‚æœå¯èƒ½çš„è¯ï¼Œå·¥ä½œè´Ÿè½½å­˜å‚¨(pod ä¸´æ—¶å­˜å‚¨å’Œå·)åº”è¯¥ä¸ agent ç»„ä»¶(/var/lib/rancher/k3s/agent)éš”ç¦»ï¼Œä»¥ç¡®ä¿ä¸ä¼šå‡ºç°èµ„æºå†²çªã€‚</p>
</li>
</ul>
<p><strong>é˜²æ­¢ agent å’Œå·¥ä½œè´Ÿè½½å¹²æ‰°é›†ç¾¤æ•°æ®å­˜å‚¨ï¼š</strong></p>
<ul>
<li>
<p>åœ¨ <code v-pre>server</code> èŠ‚ç‚¹è¿è¡Œå·¥ä½œè´Ÿè½½ pod æ—¶ï¼Œåº”ç¡®ä¿ <code v-pre>agent</code> å’Œå·¥ä½œè´Ÿè½½ <code v-pre>IOPS</code> ä¸å¹²æ‰°æ•°æ®å­˜å‚¨ã€‚</p>
</li>
<li>
<p>å°† <code v-pre>server</code> ç»„ä»¶ï¼ˆ/var/lib/rancher/k3s/serverï¼‰ä¸ <code v-pre>agent</code> ç»„ä»¶ï¼ˆ/var/lib/rancher/k3s/agentï¼‰æ”¾åœ¨ä¸åŒçš„å­˜å‚¨ä»‹è´¨ä¸Šï¼Œåè€…åŒ…æ‹¬ containerd é•œåƒå­˜å‚¨ã€‚</p>
</li>
<li>
<p>å·¥ä½œè´Ÿè½½å­˜å‚¨ï¼ˆpod ä¸´æ—¶å­˜å‚¨å’Œå·ï¼‰ä¹Ÿåº”è¯¥ä¸æ•°æ®å­˜å‚¨éš”ç¦»ã€‚</p>
</li>
</ul>
<h3 id="usr-local-bin-é‡è¦äºŒè¿›åˆ¶" tabindex="-1"><a class="header-anchor" href="#usr-local-bin-é‡è¦äºŒè¿›åˆ¶" aria-hidden="true">#</a> /usr/local/bin é‡è¦äºŒè¿›åˆ¶</h3>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>åé¢çš„æµ‹è¯•éƒ½æ˜¯å’Œ <code v-pre>/usr/local/bin</code> æ¯æ¯ç›¸å…³ï¼Œå°±æ¯”å¦‚è¯´æ¯ä¸€æ¬¡æµ‹è¯•åˆ é™¤ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>/usr/local/bin/k3s-uninstall.sh 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>åŒæ ·çš„è¿˜æœ‰åœæ­¢ k3sï¼š</strong></p>
<p>ä¸ºäº†åœ¨å‡çº§æœŸé—´å®ç°é«˜å¯ç”¨æ€§ï¼ŒK3s å®¹å™¨åœ¨ K3s æœåŠ¡åœæ­¢æ—¶ä¼šç»§ç»­è¿è¡Œã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>/usr/local/bin/k3s-killall.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>killall è„šæœ¬èƒ½æ¸…ç†å®¹å™¨ã€K3s ç›®å½•å’Œç½‘ç»œç»„ä»¶ï¼ŒåŒæ—¶è¿˜èƒ½åˆ é™¤ iptables é“¾ä»¥åŠæ‰€æœ‰ç›¸å…³è§„åˆ™ã€‚é›†ç¾¤æ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚</p>
<p>ğŸ„â€â™‚ï¸ åŒæ ·å¯ä»¥ä½¿ç”¨ <code v-pre>systemctl start k3s</code> ï¼Œç›®å‰å‘ç°æ•ˆæœä¸€æ ·ï¼Œå¦‚æœä½ è§‰å¾—ä¸ä¸€æ ·ï¼Œè”ç³»ä¸‹æˆ‘~</p>
<p><strong>å½“ç„¶ k3s éƒ½æ˜¯å›´ç»•ç€ k3s è„šæœ¬ä¸ºä¸­å¿ƒçš„ï¼š</strong></p>
</div>
<h2 id="è„šæœ¬å®‰è£…é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#è„šæœ¬å®‰è£…é€‰é¡¹" aria-hidden="true">#</a> è„šæœ¬å®‰è£…é€‰é¡¹</h2>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>æˆ‘ä»¬ç°åœ¨å·²ç»çŸ¥é“äº†å…³äºè„šæœ¬çš„é€‰é¡¹ä¸¤ç§æ–¹å¼ï¼Œ<strong>ç¯å¢ƒå˜é‡</strong> æˆ–è€… <strong>æ ‡å¿—</strong> ã€‚</p>
<p>âš ï¸ æ³¨æ„ï¼Œå¦‚æœä½ é€‰æ‹© <strong>ä¸‹è½½install.sh</strong> ä½¿ç”¨ https://ghproxy.com ï¼Œåé¢çš„æ‰€æœ‰è„šæœ¬æˆ‘éƒ½æ˜¯ä½¿ç”¨ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn   <span class="token assign-left variable">INSTALL_K3S_SYMLINK</span><span class="token operator">=</span>skip  <span class="token function">sh</span> install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»¥ &quot;K3S_&quot;å¼€å¤´çš„ç¯å¢ƒå˜é‡å°†è¢«ä¿ç•™ï¼Œä¾› systemd å’Œ openrc æœåŠ¡ä½¿ç”¨ã€‚</p>
<p>åœ¨æ²¡æœ‰æ˜ç¡®è®¾ç½® exec å‘½ä»¤çš„æƒ…å†µä¸‹è®¾ç½®<code v-pre>K3S_URL</code>ï¼Œä¼šå°†å‘½ä»¤é»˜è®¤ä¸º &quot;agent&quot;ã€‚</p>
<p>è¿è¡Œ agent æ—¶è¿˜å¿…é¡»è®¾ç½®<code v-pre>K3S_TOKEN</code>ã€‚</p>
</div>
<p><code v-pre>INSTALL_K3S_SKIP_DOWNLOAD</code> -- (ç”¨äºç¦»çº¿å®‰è£…) å¦‚æœè®¾ç½®ä¸º &quot;true &quot;å°†ä¸ä¼šä¸‹è½½ K3s çš„å“ˆå¸Œå€¼æˆ–äºŒè¿›åˆ¶ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
    <span class="token assign-left variable">INSTALL_K3S_SKIP_DOWNLOAD</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
    <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_SYMLINK</code> -- é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè·¯å¾„ä¸­ä¸å­˜åœ¨å‘½ä»¤ï¼Œå°†ä¸º <code v-pre>kubectl</code>ã€<code v-pre>crictl</code> å’Œ <code v-pre>ctr</code> äºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»ºç¬¦å·é“¾æ¥ã€‚å¦‚æœè®¾ç½®ä¸º <code v-pre>'skip'</code> å°†ä¸ä¼šåˆ›å»ºç¬¦å·é“¾æ¥ï¼Œè€Œ <code v-pre>'force'</code> å°†è¦†ç›–ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SYMLINK</span><span class="token operator">=</span>skip <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p><strong>æµ‹è¯•(é»˜è®¤æƒ…å†µï¼‰ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@etcnode01:/usr/local/bin<span class="token comment"># ls -al</span>
total <span class="token number">66164</span>
drwxr-xr-x  <span class="token number">2</span> root root     <span class="token number">4096</span> Nov <span class="token number">26</span> 09:40 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">10</span> root root     <span class="token number">4096</span> Aug <span class="token number">31</span> 06:52 <span class="token punctuation">..</span>
lrwxrwxrwx  <span class="token number">1</span> root root        <span class="token number">3</span> Nov <span class="token number">26</span> 06:19 crictl -<span class="token operator">></span> k3s
-rwxr-xr-x  <span class="token number">1</span> root root <span class="token number">67735552</span> Nov <span class="token number">26</span> 06:19 k3s
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">1433</span> Nov <span class="token number">26</span> 06:19 k3s-agent-uninstall.sh
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">2026</span> Nov <span class="token number">26</span> 06:19 k3s-killall.sh
lrwxrwxrwx  <span class="token number">1</span> root root        <span class="token number">3</span> Nov <span class="token number">26</span> 06:19 kubectl -<span class="token operator">></span> k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æµ‹è¯•ï¼ˆæŒ‡å®šç¯å¢ƒå˜é‡ï¼‰ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/usr/local/bin<span class="token comment"># ls -al</span>
total <span class="token number">66168</span>
drwxr-xr-x  <span class="token number">2</span> root root     <span class="token number">4096</span> Nov <span class="token number">26</span> <span class="token number">11</span>:16 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">10</span> root root     <span class="token number">4096</span> Aug <span class="token number">31</span> 06:52 <span class="token punctuation">..</span>
-rwxr-xr-x  <span class="token number">1</span> root root <span class="token number">67735552</span> Nov <span class="token number">26</span> <span class="token number">11</span>:16 k3s
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">2026</span> Nov <span class="token number">26</span> <span class="token number">11</span>:16 k3s-killall.sh
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">1397</span> Nov <span class="token number">26</span> <span class="token number">11</span>:16 k3s-uninstall.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>
<div class="custom-container warning"><p class="custom-container-title">æ³¨æ„</p>
<p>âš ï¸ æˆ‘åœ¨ä¸Šä¸€èŠ‚ä»‹ç»äº†ä½¿ç”¨ <strong>åˆ«å</strong> ï¼Œå®ƒå¯ä»¥æ´¾ä¸Šç”¨åœºäº†ã€‚</p>
</div>
<p><code v-pre>INSTALL_K3S_SKIP_ENABLE</code> -- å¦‚æœè®¾ç½®ä¸º &quot;true&quot;ï¼Œå°†ä¸å¯ç”¨æˆ–å¯åŠ¨ K3s æœåŠ¡ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SKIP_ENABLE</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p><strong>å¼€å¯ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>systemctl start k3s
kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>
<p><code v-pre>INSTALL_K3S_SKIP_START</code> -- å¦‚æœè®¾ç½®ä¸º &quot;true &quot;å°†ä¸ä¼šå¯åŠ¨ K3s æœåŠ¡ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SKIP_START</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_VERSION</code> -- ä» Github ä¸‹è½½ K3s çš„ç‰ˆæœ¬ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°†å°è¯•ä»&quot;stable&quot;é¢‘é“ä¸‹è½½ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_VERSION</span><span class="token operator">=</span><span class="token string">"v1.19.9+k3s1"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>æ³¨æ„åé¢æ˜¯ <code v-pre>+</code></p>
</blockquote>
<p><code v-pre>INSTALL_K3S_BIN_DIR</code> -- å®‰è£… K3s äºŒè¿›åˆ¶æ–‡ä»¶ã€é“¾æ¥å’Œå¸è½½è„šæœ¬çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨ <code v-pre>/usr/local/bin</code> ä½œä¸ºé»˜è®¤ç›®å½•ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_BIN_DIR</span><span class="token operator">=</span>/opt/bin <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_BIN_DIR_READ_ONLY</code> -- å¦‚æœè®¾ç½®ä¸º true å°†ä¸ä¼šæŠŠæ–‡ä»¶å†™å…¥INSTALL_K3S_BIN_DIRï¼Œå¼ºåˆ¶è®¾ç½®INSTALL_K3S_SKIP_DOWNLOAD=trueã€‚</p>
<p><code v-pre>INSTALL_K3S_SKIP_DOWNLOAD</code> ä¼šåˆ›å»º <code v-pre>kubectl/crictl/ctr</code> ç­‰ï¼Œè€Œ <code v-pre>INSTALL_K3S_BIN_DIR_READ_ONLY</code> ä¸åˆ›å»ºã€‚</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_BIN_DIR_READ_ONLY=true \
  sh -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_SYSTEMD_DIR</code> -- å®‰è£… systemd æœåŠ¡å’Œç¯å¢ƒæ–‡ä»¶çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨/etc/systemd/system ä½œä¸ºé»˜è®¤ç›®å½•ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SYSTEMD_DIR</span><span class="token operator">=</span>/opt/systemd <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æµ‹è¯•</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># INSTALL_K3S_MIRROR=cn   INSTALL_K3S_SYSTEMD_DIR=/opt/systemd sh install.sh </span>
root@cubmaster01:/opt/systemd<span class="token comment"># ls -al</span>
total <span class="token number">12</span>
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">4096</span> Nov <span class="token number">26</span> <span class="token number">11</span>:53 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">6</span> root root <span class="token number">4096</span> Nov <span class="token number">26</span> <span class="token number">11</span>:51 <span class="token punctuation">..</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">829</span> Nov <span class="token number">26</span> <span class="token number">11</span>:53 k3s.service
-rw------- <span class="token number">1</span> root root    <span class="token number">0</span> Nov <span class="token number">26</span> <span class="token number">11</span>:53 k3s.service.env
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><code v-pre>INSTALL_K3S_EXEC</code> -- å¸¦æœ‰æ ‡å¿—çš„å‘½ä»¤ï¼Œç”¨äºåœ¨æœåŠ¡ä¸­å¯åŠ¨ K3sã€‚<strong>å¦‚æœæœªæŒ‡å®šå‘½ä»¤ï¼Œå¹¶ä¸”è®¾ç½®äº† K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œagentâ€ã€‚å¦‚æœæœªè®¾ç½® K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œserverâ€ã€‚</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--docker"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**æœ€åçš„ systemd å‘½ä»¤è§£æä¸ºè¿™ä¸ªç¯å¢ƒå˜é‡å’Œè„šæœ¬å‚æ•°çš„ç»„åˆã€‚**ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œä»¥ä¸‹å‘½ä»¤çš„ç»“æœä¸æ³¨å†Œä¸€ä¸ªæ²¡æœ‰ flannel çš„ server çš„è¡Œä¸ºç›¸åŒï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--flannel-backend none"</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> -
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"server --flannel-backend none"</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> -
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"server"</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - --flannel-backend none
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - server --flannel-backend none
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - --flannel-backend none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_NAME</code> -- è¦åˆ›å»ºçš„ <code v-pre>systemd</code> æœåŠ¡åç§°ï¼Œå¦‚æœä»¥æœåŠ¡å™¨æ–¹å¼è¿è¡Œ k3sï¼Œåˆ™é»˜è®¤ä¸º <code v-pre>'k3s'</code>ï¼›å¦‚æœä»¥ <code v-pre>agent</code> æ–¹å¼è¿è¡Œ <code v-pre>k3s</code>ï¼Œåˆ™é»˜è®¤ä¸º <code v-pre>'k3s-agent'</code> ã€‚å¦‚æœæŒ‡å®šäº†æœåŠ¡åï¼Œåˆ™æœåŠ¡åå°†ä»¥ <code v-pre>'k3s-'</code> ä¸ºå‰ç¼€ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_NAME</span><span class="token operator">=</span><span class="token string">"seal"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_TYPE</code> -- è¦åˆ›å»ºçš„ systemd æœåŠ¡ç±»å‹ï¼Œé»˜è®¤ä¸º notify</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_TYPE</span><span class="token operator">=</span><span class="token string">"exec"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_SKIP_SELINUX_RPM</code> -- å¦‚æœè®¾ç½®ä¸º <code v-pre>&quot;true &quot;</code> å°†è·³è¿‡ <code v-pre>k3s RPM</code> çš„è‡ªåŠ¨å®‰è£…ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SKIP_SELINUX_RPM</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">K3s RPM</p>
<p><a href="https://en.wikipedia.org/wiki/Security-Enhanced_Linux" target="_blank" rel="noopener noreferrer">å®‰å…¨å¢å¼ºçš„ Linuxï¼ˆSELinuxï¼‰<ExternalLinkIcon/></a>æ˜¯å¯¹ Linux çš„å®‰å…¨å¢å¼ºã€‚</p>
<p>å®ƒç”± Red Hat å¼€å‘ï¼Œæ˜¯ Linux ä¸Šå¼ºåˆ¶æ€§è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰çš„ä¸€ä¸ªå®ç°ã€‚å¼ºåˆ¶æ€§è®¿é—®æ§åˆ¶å…è®¸ç³»ç»Ÿç®¡ç†å‘˜å®šä¹‰åº”ç”¨ç¨‹åºå’Œç”¨æˆ·å¦‚ä½•è®¿é—®ä¸åŒçš„èµ„æºï¼Œå¦‚æ–‡ä»¶ã€è®¾å¤‡ã€ç½‘ç»œå’Œè¿›ç¨‹é—´é€šä¿¡ã€‚SELinux è¿˜é€šè¿‡ä½¿æ“ä½œç³»ç»Ÿåœ¨é»˜è®¤æƒ…å†µä¸‹å…·æœ‰é™åˆ¶æ€§è€Œå¢å¼ºäº†å®‰å…¨æ€§ã€‚</p>
<p>åœ¨å†å²ä¸Šè¢«æ”¿åºœæœºæ„ä½¿ç”¨åï¼ŒSELinux ç°åœ¨æ˜¯è¡Œä¸šæ ‡å‡†ï¼Œåœ¨ CentOS 7 å’Œ 8 ä¸Šé»˜è®¤å¯ç”¨ã€‚è¦æ£€æŸ¥ SELinux æ˜¯å¦åœ¨ä½ çš„ç³»ç»Ÿä¸Šå¯ç”¨å’Œæ‰§è¡Œï¼Œè¯·ä½¿ç”¨<code v-pre>getenforce</code>ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>getenforce
Enforcing
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><code v-pre>INSTALL_K3S_CHANNEL_URL</code> -- ç”¨äºè·å– K3s ä¸‹è½½ç½‘å€çš„é¢‘é“ URLã€‚é»˜è®¤ä¸º https://update.k3s.io/v1-release/channels ã€‚</p>
<p><code v-pre>INSTALL_K3S_CHANNEL</code> -- ç”¨äºè·å– K3s ä¸‹è½½ URL çš„é€šé“ã€‚é»˜è®¤å€¼ä¸º &quot;stable&quot;ã€‚é€‰é¡¹åŒ…æ‹¬ï¼š<code v-pre>stable</code>, <code v-pre>latest</code>, <code v-pre>testing</code>ã€‚</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_CHANNEL="latest" \
  sh -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>K3S_CONFIG_FILE</code> -- æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚é»˜è®¤ç›®å½•ä¸º<code v-pre>/etc/rancher/k3s/config.yaml</code>ã€‚</p>
<div class="custom-container tip"><p class="custom-container-title">æˆ‘ä»¬å…ˆæŒ‡å®šä¸‹æ–‡ä»¶ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">>></span> /opt/config.yaml <span class="token operator">&lt;&lt;-</span><span class="token string">EOF
node-label:
- "foo=bar"
- "something=amazing"
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">K3S_CONFIG_FILE</span><span class="token operator">=</span>/opt/config.yaml <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://sm.nsddd.top/smimage-20221126211751303.png" alt="image-20221126211751303"></p>
<p><code v-pre>K3S_TOKEN</code> -- ç”¨äºå°† server æˆ– agent åŠ å…¥é›†ç¾¤çš„å…±äº« secretã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>rancher-k3s <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">å¸Œæœ›ä½ å¯ä»¥æ‰¾åˆ°å®ƒçš„ä½ç½®</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> /var/lib/rancher/k3s/server/token
K1042465c14be8de6a57c482b4162f673addcb652acb13c8119a9900b5d27c234f7::server:rancher-k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><code v-pre>K3S_TOKEN_FILE</code> -- æŒ‡å®š <code v-pre>cluster-secret</code>,<code v-pre>token</code> çš„æ–‡ä»¶ç›®å½•ã€‚</p>
<div class="custom-container tip"><p class="custom-container-title">æˆ‘ä»¬éœ€è¦å…ˆæŒ‡å®šæ–‡ä»¶</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">>></span> /opt/token.txt <span class="token operator">&lt;&lt;-</span><span class="token string">EOF
rancher-k3s
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">K3S_TOKEN_FILE</span><span class="token operator">=</span>/opt/token.txt <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">å¸Œæœ›ä½ å¯ä»¥æ‰¾åˆ°å®ƒçš„ä½ç½®</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># cat /var/lib/rancher/k3s/server/token</span>
K10fbe884032e42976a1dd419e5d171b9bc38d50e13dc852afbc97ffb99c765f06e::server:rancher-k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div>
<h3 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h3>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<ol>
<li>ä»¥ &quot;K3S_&quot;å¼€å¤´çš„ç¯å¢ƒå˜é‡å°†è¢«ä¿ç•™ï¼Œä¾› systemd å’Œ openrc æœåŠ¡ä½¿ç”¨ã€‚</li>
<li>åœ¨æ²¡æœ‰æ˜ç¡®è®¾ç½® exec å‘½ä»¤çš„æƒ…å†µä¸‹è®¾ç½® K3S_URLï¼Œä¼šå°†å‘½ä»¤é»˜è®¤ä¸º &quot;agent&quot;ã€‚</li>
<li>è¿è¡Œ agent æ—¶è¿˜å¿…é¡»è®¾ç½® K3S_TOKENã€‚</li>
</ol>
</div>
<h2 id="å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……" tabindex="-1"><a class="header-anchor" href="#å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……" aria-hidden="true">#</a> å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……</h2>
<p>å®‰è£…è„šæœ¬ä¸»è¦æ˜¯é…ç½® K3s ä½œä¸ºæœåŠ¡è¿è¡Œã€‚å¦‚æœä½ é€‰æ‹©ä¸ä½¿ç”¨è„šæœ¬ï¼Œä½ å¯ä»¥é€šè¿‡ <a href="https://github.com/rancher/k3s/releases/latest" target="_blank" rel="noopener noreferrer">å‘å¸ƒé¡µé¢<ExternalLinkIcon/></a>ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†å…¶æ”¾åœ¨ä½ çš„ç¯å¢ƒå˜é‡è·¯å¾„ä¸Šï¼Œç„¶åæ‰§è¡Œå®ƒæ¥è¿è¡Œ K3sã€‚K3s äºŒè¿›åˆ¶æ”¯æŒä»¥ä¸‹å‘½ä»¤ï¼š</p>
<p><code v-pre>k3s server</code> -- è¿è¡Œ K3s serverï¼Œå®ƒè¿˜å°†å¯åŠ¨ Kubernetes control-plane ç»„ä»¶ï¼Œå¦‚ API server, controller-manager, å’Œ schedulerã€‚</p>
<blockquote>
<p>å’Œ kubernetes çš„æ§åˆ¶å±‚é¢å¾ˆç±»ä¼¼~</p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># k3s server</span>
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Acquiring lock <span class="token function">file</span> /var/lib/rancher/k3s/data/.lock 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Preparing data <span class="token function">dir</span> /var/lib/rancher/k3s/data/2ef87ff954adbb390309ce4dc07500f29c319f84feec1719bfb5059c8808ec6a 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Starting k3s v1.25.3+k3s1 <span class="token punctuation">(</span>f2585c16<span class="token punctuation">)</span>         
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Configuring sqlite3 database connection pooling: <span class="token assign-left variable">maxIdleConns</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">maxOpenConns</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">connMaxLifetime</span><span class="token operator">=</span>0s 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Configuring database table schema and indexes, this may take a moment<span class="token punctuation">..</span>. 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Database tables and indexes are up to <span class="token function">date</span>   
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Kine available at unix://kine.sock 
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>k3s agent</code> -- è¿è¡Œ K3s agent èŠ‚ç‚¹ã€‚è¿™å°†ä½¿ K3s ä½œä¸ºå·¥ä½œèŠ‚ç‚¹è¿è¡Œï¼Œå¯åŠ¨ Kubernetes èŠ‚ç‚¹æœåŠ¡ kubelet å’Œ kube-proxyã€‚</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>root@etcnode01:~# k3s agent --server https://192.168.71.130:6443 --token K10fcaced71fc70ca6b77921a7e374dc03c34fdd1fb11973d69a2a8e937b61beb22::server:82c397ed440c496f5448ec3c4b11c112
INFO[0000] Starting k3s agent v1.25.4+k3s1 (0dc63334)   
INFO[0000] Running load balancer k3s-agent-load-balancer 127.0.0.1:6444 -> [192.168.71.130:6443] 
ERRO[0004] failed to get CA certs: Get "https://127.0.0.1:6444/cacerts": read tcp 127.0.0.1:60386->127.0.0.1:6444: read: connection reset by peer 
......
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/opt<span class="token comment"># k3s kubectl get nodes</span>
NAME          STATUS   ROLES                  AGE   VERSION
cubmaster01   Ready    control-plane,master   96m   v1.25.3+k3s1
cubnode02     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 52m   v1.25.4+k3s1
etcnode01     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 67m   v1.25.4+k3s1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>
<p><code v-pre>k3s kubectl</code> -- è¿è¡ŒåµŒå…¥å¼ kubectl CLIã€‚å¦‚æœæ²¡æœ‰è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡ï¼Œå½“å¯åŠ¨ K3s æœåŠ¡å™¨èŠ‚ç‚¹æ—¶ï¼Œå°†è‡ªåŠ¨å°è¯•ä½¿ç”¨åœ¨<code v-pre>/etc/rancher/k3s/k3s.yaml</code> åˆ›å»ºçš„é…ç½®æ–‡ä»¶ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># k3s kubectl get nodes</span>
NAME   STATUS   ROLES                  AGE     VERSION
k3s1   Ready    control-plane,master   8m14s   v1.20.5+k3s1
k3s2   Ready    <span class="token operator">&lt;</span>none                11s     v1.20.5+k3s1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>k3s crictl</code> -- è¿è¡Œä¸€ä¸ªåµŒå…¥å¼ crictlã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºä¸ Kubernetes çš„å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰äº¤äº’çš„ CLIã€‚å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># k3s crictl ps</span>
CONTAINER           IMAGE               CREATED             STATE               NAME                     ATTEMPT             POD ID
9ceb610df16c7       aa764f7db3051       <span class="token number">8</span> minutes ago       Running             traefik                  <span class="token number">0</span>                   373c79416fa65
cadceb62ae08d       897ce3c5fc8ff       <span class="token number">8</span> minutes ago       Running             lb-port-443              <span class="token number">0</span>                   f8a0ecfe56562
a26a49be485ac       897ce3c5fc8ff       <span class="token number">8</span> minutes ago       Running             lb-port-80               <span class="token number">0</span>                   f8a0ecfe56562
01894072f2298       148c192562719       <span class="token number">8</span> minutes ago       Running             local-path-provisioner   <span class="token number">1</span>                   b9d55e63f632f
5ccd6ed05120f       296a6d5035e2d       <span class="token number">9</span> minutes ago       Running             coredns                  <span class="token number">0</span>                   2bae007d8e486
be0765e77a703       9dd718864ce61       <span class="token number">9</span> minutes ago       Running             metrics-server           <span class="token number">0</span>                   53ab949c026ce
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>k3s ctr</code> -- è¿è¡Œä¸€ä¸ªåµŒå…¥å¼çš„ ctrã€‚è¿™æ˜¯ä¸º containerdï¼ˆK3s ä½¿ç”¨çš„å®¹å™¨å®ˆæŠ¤è¿›ç¨‹ï¼‰æä¾›çš„ CLIã€‚å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># k3s ctr container ls</span>
CONTAINER                                                           IMAGE                                                                                                               RUNTIME
01894072f2298208f3c109f9fb1d5e12e677d11cd5d0b0a3a66f550ae38644e4    docker.io/rancher/local-path-provisioner:v0.0.19                                                                    io.containerd.runc.v2
2bae007d8e486afffbbf1ffb88e97b92d367aff4b06842217de4fb5d22ecf1b9    docker.io/rancher/pause:3.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>k3s server</code> å’Œ <code v-pre>k3s agent</code> å‘½ä»¤æœ‰é¢å¤–çš„é…ç½®é€‰é¡¹ï¼Œå¯ä»¥é€šè¿‡ <code v-pre>k3s server --help</code> æˆ– <code v-pre>k3s agent --help</code> æŸ¥çœ‹ã€‚</p>
<h2 id="é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨-k3s" tabindex="-1"><a class="header-anchor" href="#é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨-k3s" aria-hidden="true">#</a> é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨ K3s</h2>
<p>é™¤äº†ä½¿ç”¨ç¯å¢ƒå˜é‡å’Œ CLI å‚æ•°æ¥é…ç½® K3sï¼ŒK3s è¿˜å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶ã€‚é»˜è®¤ç›®å½•ä½äº <code v-pre>/etc/rancher/k3s/config.yaml</code>ï¼ˆæˆ–è€…æ˜¯ <code v-pre>k3s.yaml</code> æ–‡ä»¶ï¼‰</p>
<div class="custom-container warning"><p class="custom-container-title">æç¤º</p>
<p>å¦‚æœåŒæ—¶ä½¿ç”¨é…ç½®æ–‡ä»¶å’Œ CLI å‚æ•°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå€¼å°†ä»ä¸¤ä¸ªæ¥æºåŠ è½½ï¼Œä½† CLI å‚æ•°ä¼˜å…ˆçº§æ›´é«˜ã€‚ å¯¹äºå¯é‡å¤çš„å‚æ•°ï¼Œå¦‚--node-labelï¼ŒCLI å‚æ•°å°†è¦†ç›–åˆ—è¡¨ä¸­çš„æ‰€æœ‰å€¼ã€‚</p>
</div>
<h2 id="k3s-server-agent-é…ç½®" tabindex="-1"><a class="header-anchor" href="#k3s-server-agent-é…ç½®" aria-hidden="true">#</a> K3s Server/Agent é…ç½®</h2>
<p><strong><code v-pre>write-kubeconfig</code> -- å°†ç®¡ç†å®¢æˆ·ç«¯çš„ kubeconfig å†™å…¥è¿™ä¸ªæ–‡ä»¶</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">K3S_KUBECONFIG_OUTPUT</span><span class="token operator">=</span>/root/.kube/config <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä½¿ç”¨ docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--docker"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æµ‹è¯•</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                              COMMAND                  CREATED              STATUS              PORTS     NAMES
9e9e8cd5eb22   rancher/mirrored-library-traefik   <span class="token string">"/entrypoint.sh --glâ€¦"</span>   <span class="token number">14</span> seconds ago       Up <span class="token number">12</span> seconds                 k8s_traefik_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
8fb6d8f2c3dc   dbd43b6716a0                       <span class="token string">"entry"</span>                  <span class="token number">32</span> seconds ago       Up <span class="token number">31</span> seconds                 k8s_lb-tcp-443_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6033d7ecc824   dbd43b6716a0                       <span class="token string">"entry"</span>                  <span class="token number">32</span> seconds ago       Up <span class="token number">31</span> seconds                 k8s_lb-tcp-80_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6b95dbafc4ee   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 <span class="token number">32</span> seconds ago       Up <span class="token number">31</span> seconds                 k8s_POD_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
b13f33df38d9   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 <span class="token number">33</span> seconds ago       Up <span class="token number">31</span> seconds                 k8s_POD_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
5e8ce9d7d95e   rancher/mirrored-coredns-coredns   <span class="token string">"/coredns -conf /etcâ€¦"</span>   <span class="token number">51</span> seconds ago       Up <span class="token number">50</span> seconds                 k8s_coredns_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_1
03db38691203   rancher/local-path-provisioner     <span class="token string">"local-path-provisioâ€¦"</span>   <span class="token number">56</span> seconds ago       Up <span class="token number">55</span> seconds                 k8s_local-path-provisioner_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_1
9b087eb2f2d0   e57a417f15d3                       <span class="token string">"/metrics-server --câ€¦"</span>   About a minute ago   Up About a minute             k8s_metrics-server_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_1
a1ead6d83564   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 About a minute ago   Up About a minute             k8s_POD_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_0
7a1020d7a01f   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 About a minute ago   Up About a minute             k8s_POD_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_0
cd0e940354a9   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 About a minute ago   Up About a minute             k8s_POD_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_0

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><strong>é’ˆå¯¹å¤šç½‘å¡ä¸»æœºå®‰è£… K3s é›†ç¾¤</strong></p>
<p><strong>k3s server:</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
<span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--node-ip=192.168.99.211"</span> <span class="token punctuation">\</span>
<span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>K3s agent:</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
<span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://192.168.99.211:6443 <span class="token punctuation">\</span>
<span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>9077b8e6f3b67b5f3e4a7723a96b199d <span class="token punctuation">\</span>
<span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--node-ip=192.168.99.212"</span> <span class="token punctuation">\</span>
<span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>--tls-san -- åœ¨ TLS è¯ä¹¦ä¸­æ·»åŠ å…¶ä»–ä¸»æœºåæˆ– IP ä½œä¸ºä¸»é¢˜å¤‡ç”¨åç§°</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--tls-san 3.97.6.45"</span>  <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¿®æ”¹<code v-pre>kube-apiserver</code>ã€<code v-pre>kube-scheduler</code> ã€<code v-pre>kube-controller-manager</code>ã€ <code v-pre>kube-cloud-controller-manager</code>ã€ <code v-pre>kubelet</code>ã€ <code v-pre>kube-proxy</code> å‚æ•°</p>
<p><strong>kubelet-argï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--kubelet-arg=max-pods=200'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>kube-apiserverï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--kube-apiserver-arg=service-node-port-range=40000-50000'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>kube-proxy-argï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code> <span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--kube-proxy-arg=proxy-mode=ipvs'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong><code v-pre>--data-dir -- K3s</code> æ•°æ®å­˜å‚¨ç›®å½•ï¼Œé»˜è®¤ä¸º <code v-pre>/var/lib/rancher/k3s</code> æˆ– <code v-pre>${HOME}/.rancher/k3s</code>(å¦‚æœä¸æ˜¯ root ç”¨æˆ·)</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--data-dir=/opt/k3s-data'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>è¿™å°±æœ‰ç‚¹æ„æ€äº†ï¼Œæˆ‘ä»¬é»˜è®¤çš„å®‰è£…è¿ç§»äº†ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/opt/k3s-data/server<span class="token comment"># cd /opt/k3s-data/;ls</span>
agent  server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å½“ç„¶ï¼Œæˆ‘ä»¬è‡ªå·±è®¾è®¡ç›®å½•ç»“æ„çš„æ—¶å€™æˆ–è®¸å¯ä»¥ç”¨åˆ°~</strong></p>
</div>
<p><strong>ç¦ç”¨ç»„ä»¶ --disableï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--disable traefik'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p><strong>ç¦ç”¨å‰ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">[</span>root@VM-4-6-centos k3s<span class="token punctuation">]</span><span class="token comment"># ls /var/lib/rancher/k3s/server/manifests</span>
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml  traefik.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¦ç”¨åï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># ls /var/lib/rancher/k3s/server/manifests</span>
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml
root@cubmaster01:/workspces/runtime<span class="token comment"># kubectl get pods -A | grep traefik</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><strong>æ·»åŠ  label å’Œ taint:</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--node-label foo=bar,hello=world --node-taint key1=value1:NoExecute'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç½‘ç»œé€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œé€‰é¡¹" aria-hidden="true">#</a> ç½‘ç»œé€‰é¡¹</h2>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code v-pre>K3s</code> å°†ä»¥ <code v-pre>flannel</code> ä½œä¸º <code v-pre>CNI</code> è¿è¡Œï¼Œä½¿ç”¨ <code v-pre>VXLAN</code> ä½œä¸ºé»˜è®¤åç«¯ã€‚<code v-pre>CNI</code>å’Œé»˜è®¤åç«¯éƒ½å¯ä»¥é€šè¿‡å‚æ•°ä¿®æ”¹ã€‚</p>
<h3 id="flannel-é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#flannel-é€‰é¡¹" aria-hidden="true">#</a> Flannel é€‰é¡¹</h3>
<p>Flannel çš„é»˜è®¤åç«¯æ˜¯ VXLANã€‚è¦å¯ç”¨åŠ å¯†ï¼Œè¯·ä½¿ç”¨ä¸‹é¢çš„ IPSecï¼ˆInternet Protocol Securityï¼‰æˆ– WireGuard é€‰é¡¹ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">CLI Flag å’Œ Value</th>
<th style="text-align:left">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code v-pre>--flannel-backend=vxlan</code></td>
<td style="text-align:left">(é»˜è®¤) ä½¿ç”¨ VXLAN åç«¯ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code v-pre>--flannel-backend=ipsec</code></td>
<td style="text-align:left">ä½¿ç”¨ IPSEC åç«¯ï¼Œå¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code v-pre>--flannel-backend=host-gw</code></td>
<td style="text-align:left">ä½¿ç”¨ host-gw åç«¯ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code v-pre>--flannel-backend=wireguard</code></td>
<td style="text-align:left">ä½¿ç”¨ WireGuard åç«¯ï¼Œå¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†ã€‚å¯èƒ½éœ€è¦é¢å¤–çš„å†…æ ¸æ¨¡å—å’Œé…ç½®ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="flannel-backend-ä½¿ç”¨-host-gw" tabindex="-1"><a class="header-anchor" href="#flannel-backend-ä½¿ç”¨-host-gw" aria-hidden="true">#</a> flannel-backend ä½¿ç”¨ <code v-pre>host-gw</code></h3>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># K3s master</span>
root@k3s1:~<span class="token comment"># curl -sfL https://get.k3s.io | \</span>
        <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--flannel-backend=host-gw"</span> <span class="token punctuation">\</span>
        <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token function">sh</span> -

<span class="token comment"># K3s agent </span>
root@k3s2:~<span class="token comment"># curl -sfL https://get.k3s.io | \</span>
        <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://172.16.64.6:6443 <span class="token punctuation">\</span>
        <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>85892cbfef2177603f25be30344dbcd0 <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json</span>
<span class="token punctuation">{</span>
	<span class="token string">"Network"</span><span class="token builtin class-name">:</span> <span class="token string">"10.42.0.0/16"</span>,
	<span class="token string">"Backend"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">"Type"</span><span class="token builtin class-name">:</span> <span class="token string">"host-gw"</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

root@k3s1:~<span class="token comment"># route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">172.16</span>.64.1     <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> enp0s2
<span class="token number">10.42</span>.0.0       <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> cni0
<span class="token number">10.42</span>.1.0       <span class="token number">172.16</span>.64.9     <span class="token number">255.255</span>.255.0   UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> enp0s2
<span class="token number">172.16</span>.64.0     <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> enp0s2
<span class="token number">172.16</span>.64.1     <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> enp0s2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<h3 id="å¯ç”¨-directrouting" tabindex="-1"><a class="header-anchor" href="#å¯ç”¨-directrouting" aria-hidden="true">#</a> å¯ç”¨ Directrouting</h3>
<p>å½“ä¸»æœºåœ¨åŒä¸€å­ç½‘æ—¶ï¼Œå¯ç”¨ direct routes(å¦‚host-gw)ã€‚<code v-pre>vxlan</code> åªç”¨äºå°†æ•°æ®åŒ…å°è£…åˆ°ä¸åŒå­ç½‘çš„ä¸»æœºä¸Šï¼ŒåŒå­ç½‘çš„ä¸»æœºä¹‹é—´ä½¿ç”¨ <code v-pre>host-gw</code>ã€‚é»˜è®¤å€¼ä¸º <code v-pre>false</code>ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># K3s master å’Œ agent</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/net-conf.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF 
{
        "Network": "10.42.0.0/16",
        "Backend": {
            "Type": "vxlan",
            "Directrouting": true
	}
}
EOF</span>

<span class="token comment"># K3s master</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="token operator">|</span> <span class="token punctuation">\</span>
        <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--flannel-conf=/etc/net-conf.json"</span> <span class="token punctuation">\</span>
        <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="è‡ªå®šä¹‰-cni" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰-cni" aria-hidden="true">#</a> è‡ªå®šä¹‰ CNI</h2>
<p>ä½¿ç”¨ <code v-pre>--flannel-backend=none</code> è¿è¡Œ K3sï¼Œç„¶ååœ¨å®‰è£…ä½ é€‰æ‹©çš„ CNIã€‚</p>
<h4 id="calico" tabindex="-1"><a class="header-anchor" href="#calico" aria-hidden="true">#</a> Calico</h4>
<p>æŒ‰ç…§<a href="https://docs.projectcalico.org/master/reference/cni-plugin/configuration" target="_blank" rel="noopener noreferrer">Calico CNI æ’ä»¶æŒ‡å—<ExternalLinkIcon/></a>ã€‚ä¿®æ”¹ Calico YAMLï¼Œåœ¨ container_settings éƒ¨åˆ†ä¸­å…è®¸ IP è½¬å‘ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>"container_settings": {
              "allow_ip_forwarding": true
          }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>å¦‚ä¸é…ç½® <code v-pre>&quot;allow_ip_forwarding&quot;: true</code>ï¼Œ <code v-pre>svclb-traefik</code> å°†ä¼šæŠ¥é”™ï¼š<code v-pre>/usr/bin/entry: line 6: can't create /proc/sys/net/ipv4/ip_forward: Read-only file system</code></p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span>
        <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
        <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--flannel-backend=none \
        --cluster-cidr=192.168.200.0/24"</span> <span class="token punctuation">\</span>
        <span class="token function">sh</span> -
root@k3s1:~<span class="token comment"># kubectl apply -f https://raw.githubusercontent.com/kingsd041/k3s-tutorial/main/05-å®‰è£…-ç½‘ç»œé€‰é¡¹/calico.yaml</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**å‚è€ƒï¼š**https://docs.projectcalico.org/getting-started/kubernetes/k3s/quickstart</p>
<h2 id="ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…" aria-hidden="true">#</a> ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…</h2>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>å•èŠ‚ç‚¹ k3s server é›†ç¾¤å¯ä»¥æ»¡è¶³å„ç§ç”¨ä¾‹ï¼Œä½†æ˜¯å¯¹äºéœ€è¦ Kubernetes control-plane ç¨³å®šè¿è¡Œçš„é‡è¦ç¯å¢ƒï¼Œæ‚¨å¯ä»¥åœ¨ HA é…ç½®ä¸­è¿è¡Œ K3sã€‚ä¸€ä¸ª K3s HA é›†ç¾¤ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>ä¸¤ä¸ªæˆ–å¤šä¸ª<code v-pre>server èŠ‚ç‚¹</code>ï¼Œå°†ä¸º Kubernetes API æä¾›æœåŠ¡å¹¶è¿è¡Œå…¶ä»– control-plane æœåŠ¡ã€‚</li>
<li>é›¶ä¸ªæˆ–å¤šä¸ª<code v-pre>agent èŠ‚ç‚¹</code>ï¼Œç”¨äºè¿è¡Œæ‚¨çš„åº”ç”¨å’ŒæœåŠ¡ã€‚</li>
<li><code v-pre>å¤–éƒ¨æ•°æ®å­˜å‚¨</code> (ä¸å•ä¸ª k3s server è®¾ç½®ä¸­ä½¿ç”¨çš„åµŒå…¥å¼ SQLite æ•°æ®å­˜å‚¨ç›¸å)</li>
<li><code v-pre>å›ºå®šçš„æ³¨å†Œåœ°å€</code>ï¼Œä½äº server èŠ‚ç‚¹çš„å‰é¢ï¼Œä»¥å…è®¸ agent èŠ‚ç‚¹å‘é›†ç¾¤æ³¨å†Œ</li>
</ul>
<blockquote>
<p>Agent é€šè¿‡å›ºå®šçš„æ³¨å†Œåœ°å€è¿›è¡Œæ³¨å†Œï¼Œä½†æ³¨å†Œåç›´æ¥ä¸å…¶ä¸­ä¸€ä¸ª server èŠ‚ç‚¹å»ºç«‹è¿æ¥ã€‚è¿™æ˜¯ä¸€ä¸ªç”± k3s agent è¿›ç¨‹å‘èµ·çš„ websocket è¿æ¥ï¼Œå¹¶ç”±ä½œä¸º agent è¿›ç¨‹ä¸€éƒ¨åˆ†è¿è¡Œçš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ç»´æŠ¤ã€‚</p>
</blockquote>
</div>
<h3 id="ç¯å¢ƒå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h3>
<div class="custom-container warning"><p class="custom-container-title">æé†’</p>
<p>ä¸ªäººæ¯”è¾ƒå€¾å‘äº etcdï¼ŒDqlite å·²ç»è¢«æŠ›å¼ƒäº†ï¼ŒåµŒå…¥å¼ etcd æ‰æ˜¯ yyds</p>
</div>
<ul>
<li><strong>é€‚ç”¨åœºæ™¯</strong></li>
</ul>
<blockquote>
<p>èµ„æºæœ‰é™çš„åœ°æ–¹ï¼Œå¦‚è¾¹ç¼˜è®¡ç®—ã€é›¾è®¡ç®—ã€ç‰©è”ç½‘çš„æ¥å…¥ç½‘å…³ç­‰</p>
</blockquote>
<ul>
<li><strong>è„šæœ¬-åœ¨çº¿å®‰è£…</strong></li>
</ul>
<blockquote>
<p>\1. masterèŠ‚ç‚¹ æŒ‡å®šå®‰è£…ç‰ˆæœ¬,ä¸æŒ‡å®šå®‰è£…æœ€æ–°ç¨³å®šç‰ˆæœ¬</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# curl -sfL https://get.k3s.io | sh -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>\2. æ‰€æœ‰workerèŠ‚ç‚¹ tokenæ¥æºäºmasterèŠ‚ç‚¹ï¼Œç›®å½•/var/lib/rancher/k3s/server/node-token</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># export INSTALL_K3S_VERSION=v1.18.9
# curl -sfL https://get.k3s.io | K3S_URL=https://myserver:6443 K3S_TOKEN=XXX sh -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><em>ç­‰ä»·äº</em></p>
<blockquote>
<p>\1. masterèŠ‚ç‚¹</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# sh k3s.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>\2. æ‰€æœ‰workerèŠ‚ç‚¹ æŒ‡å®šç‰ˆæœ¬ï¼Œmasterï¼Œè¿˜æœ‰ä»masterè·å–çš„token</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># export INSTALL_K3S_VERSION=v1.18.9
# export K3S_URL=https://master_ip:6443 
# export K3S_TOKEN=K103b676c8815cc4fb467cb5564527c3a5b0d3415915c9a15e195ff6069589bf508::server:97d3d89ac68de226f5003869fe676718
# sh k3s.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li><strong>è„šæœ¬-ç¦»çº¿å®‰è£…</strong></li>
</ul>
<blockquote>
<p>1.å…ˆåœ¨æœ‰ç½‘ç»œçš„åœ°æ–¹ä¸‹è½½k3så®‰è£…è„šæœ¬å’ŒäºŒè¿›åˆ¶æ–‡ä»¶</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>è„šæœ¬ï¼šhttps://get.k3s.io
é€‰æ‹©å¯¹åº”ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶: https://github.com/rancher/k3s/releases
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>2.å°†k3så®‰è£…è„šæœ¬æ”¾åœ¨ä»»æ„ä½ç½®ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´åˆ°ç›®æ ‡ä¸»æœºçš„/usr/local/binç›®å½•
3.æ·»åŠ ç¯å¢ƒå˜é‡</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># export INSTALL_K3S_SKIP_DOWNLOAD=true
è·³è¿‡äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>4.åœ¨masterèŠ‚ç‚¹è¿è¡Œå®‰è£…è„šæœ¬ è¿™é‡Œçš„ç‰ˆæœ¬è¦å’Œä¸Šé¢ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶ç‰ˆæœ¬ä¸€è‡´</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# sh k3s.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>5.åœ¨æ‰€æœ‰workerèŠ‚ç‚¹è¿è¡Œå®‰è£…è„šæœ¬ æ‰€æœ‰workerèŠ‚ç‚¹ æŒ‡å®šç‰ˆæœ¬ï¼Œmasterï¼Œè¿˜æœ‰ä»masterè·å–çš„token</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># export INSTALL_K3S_VERSION=v1.18.9
# export K3S_URL=https://master_ip:6443 
# export K3S_TOKEN=K103b676c8815cc4fb467cb5564527c3a5b0d3415915c9a15e195ff6069589bf508::server:97d3d89ac68de226f5003869fe676718
# sh k3s.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li><strong>æ— è„šæœ¬-çº¯æ‰‹åŠ¨å®‰è£…</strong></li>
</ul>
<blockquote>
<p>1.ä¸‹è½½k3säºŒè¿›åˆ¶æ–‡ä»¶</p>
</blockquote>
<p><a href="https://link.zhihu.com/?target=https%3A//github.com/rancher/k3s/releases/latest" target="_blank" rel="noopener noreferrer">åœ°å€github.com/rancher/k3s/releases/latest<ExternalLinkIcon/></a></p>
<blockquote>
<p>2.å¯åŠ¨masterå’Œworker</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>> æ²¡æœ‰è„šæœ¬å¯åŠ¨æ–¹ä¾¿ï¼Œéœ€è¦è‡ªå·±æŒ‡å®šå¯åŠ¨å‚æ•°ï¼Œå¦‚serverã€agentç­‰

# sudo k3s server &amp;
> Kubeconfig is written to /etc/rancher/k3s/k3s.yaml
# sudo k3s kubectl get nodes

> On a different node run the below. NODE_TOKEN comes from
> /var/lib/rancher/k3s/server/node-token on your server
# sudo k3s agent --server https://myserver:6443 --token ${NODE_TOKEN}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li><strong>k3sé»˜è®¤ç”¨çš„containerdï¼Œå¦‚æœè¦ç”¨dockeræ›¿æ¢containerdï¼Œåˆ™åœ¨å®‰è£…k3så‰å®‰è£…docker</strong></li>
</ul>
<blockquote>
<p>1.å®‰è£…docker</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># yum install -y yum-utils 
# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# yum makecache fast 
# yum list docker-ce --showduplicates | sort -r
# yum install -y docker-ce-19.03.8-3.el7
# systemctl start docker
# systemctl enable docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>2.å®‰è£…k3s master</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--docker --write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# sh k3s.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>3.å®‰è£…k3s worker</p>
</blockquote>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># æ‰€æœ‰workerèŠ‚ç‚¹ æŒ‡å®šç‰ˆæœ¬ï¼Œmasterï¼Œè¿˜æœ‰ä»masterè·å–çš„token
# export INSTALL_K3S_VERSION=v1.18.9
# export K3S_URL=https://master_ip:6443 
# export K3S_TOKEN=K103b676c8815cc4fb467cb5564527c3a5b0d3415915c9a15e195ff6069589bf508::server:97d3d89ac68de226f5003869fe676718
# sh k3s.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '14.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '16.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


