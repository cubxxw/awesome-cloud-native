<template><div><ul>
<li><a href="http://nsddd.top" target="_blank" rel="noopener noreferrer">author<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬15èŠ‚-k3s-è¡¥å……" tabindex="-1"><a class="header-anchor" href="#ç¬¬15èŠ‚-k3s-è¡¥å……" aria-hidden="true">#</a> ç¬¬15èŠ‚ k3s è¡¥å……</h1>
<div><a href = '14.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '16.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<nav class="table-of-contents"><ul><li><router-link to="#èµ„æºåˆ†æ">èµ„æºåˆ†æ</router-link><ul><li><router-link to="#usr-local-bin-é‡è¦äºŒè¿›åˆ¶">/usr/local/bin é‡è¦äºŒè¿›åˆ¶</router-link></li></ul></li><li><router-link to="#è„šæœ¬å®‰è£…é€‰é¡¹">è„šæœ¬å®‰è£…é€‰é¡¹</router-link><ul><li><router-link to="#æ€»ç»“">æ€»ç»“</router-link></li></ul></li><li><router-link to="#å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……">å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……</router-link></li><li><router-link to="#é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨-k3s">é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨ K3s</router-link></li><li><router-link to="#k3s-server-agent-é…ç½®">K3s Server/Agent é…ç½®</router-link></li><li><router-link to="#ç½‘ç»œé€‰é¡¹">ç½‘ç»œé€‰é¡¹</router-link><ul><li><router-link to="#flannel-é€‰é¡¹">Flannel é€‰é¡¹</router-link></li><li><router-link to="#flannel-backend-ä½¿ç”¨-host-gw">flannel-backend ä½¿ç”¨ host-gw</router-link></li><li><router-link to="#å¯ç”¨-directrouting">å¯ç”¨ Directrouting</router-link></li></ul></li><li><router-link to="#è‡ªå®šä¹‰-cni">è‡ªå®šä¹‰ CNI</router-link></li><li><router-link to="#ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…">ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…</router-link><ul><li><router-link to="#ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</router-link></li><li><router-link to="#å¤–éƒ¨æ•°æ®åº“é«˜å¯ç”¨">å¤–éƒ¨æ•°æ®åº“é«˜å¯ç”¨</router-link></li><li><router-link to="#agent-åŠ å…¥">agent åŠ å…¥</router-link></li><li><router-link to="#æ²¡æœ‰-cli-æ ‡å¿—å¯åŠ¨-agent-åŠ å…¥">æ²¡æœ‰ CLI æ ‡å¿—å¯åŠ¨ agent åŠ å…¥</router-link></li></ul></li><li><router-link to="#åµŒå…¥å¼db-ha">åµŒå…¥å¼DB HA</router-link></li><li><router-link to="#é›†ç¾¤æ•°æ®å­˜å‚¨é€‰é¡¹">é›†ç¾¤æ•°æ®å­˜å‚¨é€‰é¡¹</router-link><ul><li><router-link to="#é…ç½®å‚æ•°">é…ç½®å‚æ•°</router-link></li></ul></li><li><router-link to="#ç§æœ‰ä»“åº“">ç§æœ‰ä»“åº“</router-link><ul><li><router-link to="#registries-yaml-æ–‡ä»¶">registries.yaml æ–‡ä»¶</router-link></li><li><router-link to="#é…ç½®-containerd">é…ç½® Containerd</router-link></li><li><router-link to="#å°†æ˜ åƒæ·»åŠ åˆ°ä¸“ç”¨æ³¨å†Œè¡¨">å°†æ˜ åƒæ·»åŠ åˆ°ä¸“ç”¨æ³¨å†Œè¡¨</router-link></li></ul></li><li><router-link to="#ç¦»çº¿å®‰è£…">ç¦»çº¿å®‰è£…</router-link><ul><li><router-link to="#é€šè¿‡ç§æœ‰é•œåƒä»“åº“å®‰è£…-k3s">é€šè¿‡ç§æœ‰é•œåƒä»“åº“å®‰è£… K3s</router-link></li></ul></li><li><router-link to="#å‡çº§-k3s">å‡çº§ K3s</router-link><ul><li><router-link to="#é€šè¿‡è„šæœ¬å‡çº§">é€šè¿‡è„šæœ¬å‡çº§</router-link></li><li><router-link to="#åœ¨çº¿è„šæœ¬å‡çº§">åœ¨çº¿è„šæœ¬å‡çº§</router-link></li><li><router-link to="#channels-è¯´æ˜">Channels è¯´æ˜</router-link></li><li><router-link to="#ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§-k3s">ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§ K3s</router-link></li><li><router-link to="#è‡ªåŠ¨å‡çº§">è‡ªåŠ¨å‡çº§</router-link></li></ul></li><li><router-link to="#è¿æ¥åˆ°-k3s-kubernets-é›†ç¾¤çš„ä¸‰ç§æ–¹å¼">è¿æ¥åˆ° k3s kubernets é›†ç¾¤çš„ä¸‰ç§æ–¹å¼</router-link><ul><li><router-link to="#kubeconfig">kubeconfig</router-link></li><li><router-link to="#kubectl">kubectl</router-link></li><li><router-link to="#lens-kubernetes-ide">Lens Kubernetes IDE</router-link></li></ul></li><li><router-link to="#end-é“¾æ¥">END é“¾æ¥</router-link></li></ul></nav>
<p>[TOC]</p>
<div class="custom-container danger"><p class="custom-container-title">è­¦å‘Š</p>
<p>é¡µé¢å†…å®¹å¤ªå¤šå¡é¡¿ï¼Œæ–°å¼€ååŠéƒ¨åˆ†è¡¥å……~</p>
<ul>
<li><a href="https://docker.nsddd.top/Cloud-Native/7.html" target="_blank" rel="noopener noreferrer">k3s vs k0s<ExternalLinkIcon/></a></li>
</ul>
</div>
<h2 id="èµ„æºåˆ†æ" tabindex="-1"><a class="header-anchor" href="#èµ„æºåˆ†æ" aria-hidden="true">#</a> èµ„æºåˆ†æ</h2>
<p>èµ„æºå ç”¨ç‡ä½æ˜¯ k3s çªå‡ºçš„ç‰¹ç‚¹ï¼Œé’ˆå¯¹ k3s ç‰¹æ€§ï¼Œåˆ†æèµ„æºçš„å ç”¨ï¼š</p>
<p><strong>å½±å“èµ„æºåˆ©ç”¨ç‡çš„å› ç´ ï¼š</strong></p>
<ul>
<li>
<p><code v-pre>K3s server</code>ï¼šK3s server çš„åˆ©ç”¨ç‡æ•°æ®ä¸»è¦æ˜¯ç”±æ”¯æŒ Kubernetes æ•°æ®å­˜å‚¨ï¼ˆkine æˆ– etcdï¼‰ã€API Serverã€Controller-Manager å’Œ Scheduler æ§åˆ¶ã€‚ <strong>åˆ›å»º/ä¿®æ”¹/åˆ é™¤</strong> èµ„æºå°†å¯¼è‡´æš‚æ—¶çš„åˆ©ç”¨ç‡ä¸Šå‡ã€‚å¤§é‡ä½¿ç”¨ Kubernetes æ•°æ®å­˜å‚¨çš„ operators æˆ–åº”ç”¨ç¨‹åºä¹Ÿå°†å¢åŠ  server çš„èµ„æºéœ€æ±‚ã€‚</p>
</li>
<li>
<p><code v-pre>K3s agent</code>ï¼šç®¡ç†é•œåƒã€æä¾› <strong>å­˜å‚¨æˆ–åˆ›å»º/é”€æ¯å®¹å™¨</strong> çš„æ“ä½œå°†å¯¼è‡´åˆ©ç”¨ç‡çš„æš‚æ—¶ä¸Šå‡ï¼Œæ‹‰å–é•œåƒé€šå¸¸ä¼šå½±å“ CPU å’Œ IOï¼Œå› ä¸ºå®ƒä»¬æ¶‰åŠå°†é•œåƒå†…å®¹è§£å‹åˆ°ç£ç›˜ã€‚å¦‚æœå¯èƒ½çš„è¯ï¼Œå·¥ä½œè´Ÿè½½å­˜å‚¨(pod ä¸´æ—¶å­˜å‚¨å’Œå·)åº”è¯¥ä¸ agent ç»„ä»¶( <code v-pre>/var/lib/rancher/k3s/agent</code> )éš”ç¦»ï¼Œä»¥ç¡®ä¿ä¸ä¼šå‡ºç°èµ„æºå†²çªã€‚</p>
</li>
</ul>
<p><strong>é˜²æ­¢ agent å’Œå·¥ä½œè´Ÿè½½å¹²æ‰°é›†ç¾¤æ•°æ®å­˜å‚¨ï¼š</strong></p>
<ul>
<li>
<p>åœ¨ <code v-pre>server</code> èŠ‚ç‚¹è¿è¡Œå·¥ä½œè´Ÿè½½ pod æ—¶ï¼Œåº”ç¡®ä¿ <code v-pre>agent</code> å’Œå·¥ä½œè´Ÿè½½ <code v-pre>IOPS</code> ä¸å¹²æ‰°æ•°æ®å­˜å‚¨ã€‚</p>
</li>
<li>
<p>å°† <code v-pre>server</code> ç»„ä»¶ï¼ˆ<code v-pre>/var/lib/rancher/k3s/server</code>ï¼‰ä¸ <code v-pre>agent</code> ç»„ä»¶ï¼ˆ<code v-pre>/var/lib/rancher/k3s/agent</code>ï¼‰æ”¾åœ¨ä¸åŒçš„å­˜å‚¨ä»‹è´¨ä¸Šï¼Œåè€…åŒ…æ‹¬ <code v-pre>containerd</code> é•œåƒå­˜å‚¨ã€‚</p>
</li>
<li>
<p>å·¥ä½œè´Ÿè½½å­˜å‚¨ï¼ˆ<code v-pre>pod</code> ä¸´æ—¶å­˜å‚¨å’Œå·ï¼‰ä¹Ÿåº”è¯¥ä¸æ•°æ®å­˜å‚¨éš”ç¦»ã€‚</p>
</li>
</ul>
<h3 id="usr-local-bin-é‡è¦äºŒè¿›åˆ¶" tabindex="-1"><a class="header-anchor" href="#usr-local-bin-é‡è¦äºŒè¿›åˆ¶" aria-hidden="true">#</a> /usr/local/bin é‡è¦äºŒè¿›åˆ¶</h3>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>åé¢çš„æµ‹è¯•éƒ½æ˜¯å’Œ <code v-pre>/usr/local/bin</code> æ¯æ¯ç›¸å…³ï¼Œå°±æ¯”å¦‚è¯´æ¯ä¸€æ¬¡æµ‹è¯•åˆ é™¤ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>/usr/local/bin/k3s-uninstall.sh 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>åŒæ ·çš„è¿˜æœ‰åœæ­¢ k3sï¼š</strong></p>
<p>ä¸ºäº†åœ¨å‡çº§æœŸé—´å®ç°é«˜å¯ç”¨æ€§ï¼ŒK3s å®¹å™¨åœ¨ K3s æœåŠ¡åœæ­¢æ—¶ä¼šç»§ç»­è¿è¡Œã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>/usr/local/bin/k3s-killall.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>killall è„šæœ¬èƒ½æ¸…ç†å®¹å™¨ã€K3s ç›®å½•å’Œç½‘ç»œç»„ä»¶ï¼ŒåŒæ—¶è¿˜èƒ½åˆ é™¤ iptables é“¾ä»¥åŠæ‰€æœ‰ç›¸å…³è§„åˆ™ã€‚é›†ç¾¤æ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚</p>
<p>ğŸ„â€â™‚ï¸ åŒæ ·å¯ä»¥ä½¿ç”¨ <code v-pre>systemctl start k3s</code> ï¼Œç›®å‰å‘ç°æ•ˆæœä¸€æ ·ï¼Œå¦‚æœä½ è§‰å¾—ä¸ä¸€æ ·ï¼Œè”ç³»ä¸‹æˆ‘~</p>
<p><strong>å½“ç„¶ k3s éƒ½æ˜¯å›´ç»•ç€ k3s è„šæœ¬ä¸ºä¸­å¿ƒçš„ï¼š</strong></p>
</div>
<h2 id="è„šæœ¬å®‰è£…é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#è„šæœ¬å®‰è£…é€‰é¡¹" aria-hidden="true">#</a> è„šæœ¬å®‰è£…é€‰é¡¹</h2>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>æˆ‘ä»¬ç°åœ¨å·²ç»çŸ¥é“äº†å…³äºè„šæœ¬çš„é€‰é¡¹ä¸¤ç§æ–¹å¼ï¼Œ<strong>ç¯å¢ƒå˜é‡</strong> æˆ–è€… <strong>æ ‡å¿—</strong> ã€‚</p>
<p>âš ï¸ æ³¨æ„ï¼Œå¦‚æœä½ é€‰æ‹© <strong>ä¸‹è½½install.sh</strong> ä½¿ç”¨ https://ghproxy.com ï¼Œåé¢çš„æ‰€æœ‰è„šæœ¬æˆ‘éƒ½æ˜¯ä½¿ç”¨ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn   <span class="token assign-left variable">INSTALL_K3S_SYMLINK</span><span class="token operator">=</span>skip  <span class="token function">sh</span> install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»¥ &quot;K3S_&quot;å¼€å¤´çš„ç¯å¢ƒå˜é‡å°†è¢«ä¿ç•™ï¼Œä¾› systemd å’Œ openrc æœåŠ¡ä½¿ç”¨ã€‚</p>
<p>åœ¨æ²¡æœ‰æ˜ç¡®è®¾ç½® exec å‘½ä»¤çš„æƒ…å†µä¸‹è®¾ç½®<code v-pre>K3S_URL</code>ï¼Œä¼šå°†å‘½ä»¤é»˜è®¤ä¸º &quot;agent&quot;ã€‚</p>
<p>è¿è¡Œ agent æ—¶è¿˜å¿…é¡»è®¾ç½®<code v-pre>K3S_TOKEN</code>ã€‚</p>
</div>
<p><code v-pre>INSTALL_K3S_SKIP_DOWNLOAD</code> -- (ç”¨äºç¦»çº¿å®‰è£…) å¦‚æœè®¾ç½®ä¸º &quot;true &quot;å°†ä¸ä¼šä¸‹è½½ K3s çš„å“ˆå¸Œå€¼æˆ–äºŒè¿›åˆ¶ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
    <span class="token assign-left variable">INSTALL_K3S_SKIP_DOWNLOAD</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
    <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_SYMLINK</code> -- é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè·¯å¾„ä¸­ä¸å­˜åœ¨å‘½ä»¤ï¼Œå°†ä¸º <code v-pre>kubectl</code>ã€<code v-pre>crictl</code> å’Œ <code v-pre>ctr</code> äºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»ºç¬¦å·é“¾æ¥ã€‚å¦‚æœè®¾ç½®ä¸º <code v-pre>'skip'</code> å°†ä¸ä¼šåˆ›å»ºç¬¦å·é“¾æ¥ï¼Œè€Œ <code v-pre>'force'</code> å°†è¦†ç›–ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SYMLINK</span><span class="token operator">=</span>skip <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p><strong>æµ‹è¯•(é»˜è®¤æƒ…å†µï¼‰ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@etcnode01:/usr/local/bin<span class="token comment"># ls -al</span>
total <span class="token number">66164</span>
drwxr-xr-x  <span class="token number">2</span> root root     <span class="token number">4096</span> Nov <span class="token number">26</span> 09:40 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">10</span> root root     <span class="token number">4096</span> Aug <span class="token number">31</span> 06:52 <span class="token punctuation">..</span>
lrwxrwxrwx  <span class="token number">1</span> root root        <span class="token number">3</span> Nov <span class="token number">26</span> 06:19 crictl -<span class="token operator">></span> k3s
-rwxr-xr-x  <span class="token number">1</span> root root <span class="token number">67735552</span> Nov <span class="token number">26</span> 06:19 k3s
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">1433</span> Nov <span class="token number">26</span> 06:19 k3s-agent-uninstall.sh
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">2026</span> Nov <span class="token number">26</span> 06:19 k3s-killall.sh
lrwxrwxrwx  <span class="token number">1</span> root root        <span class="token number">3</span> Nov <span class="token number">26</span> 06:19 kubectl -<span class="token operator">></span> k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æµ‹è¯•ï¼ˆæŒ‡å®šç¯å¢ƒå˜é‡ï¼‰ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/usr/local/bin<span class="token comment"># ls -al</span>
total <span class="token number">66168</span>
drwxr-xr-x  <span class="token number">2</span> root root     <span class="token number">4096</span> Nov <span class="token number">26</span> <span class="token number">11</span>:16 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">10</span> root root     <span class="token number">4096</span> Aug <span class="token number">31</span> 06:52 <span class="token punctuation">..</span>
-rwxr-xr-x  <span class="token number">1</span> root root <span class="token number">67735552</span> Nov <span class="token number">26</span> <span class="token number">11</span>:16 k3s
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">2026</span> Nov <span class="token number">26</span> <span class="token number">11</span>:16 k3s-killall.sh
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">1397</span> Nov <span class="token number">26</span> <span class="token number">11</span>:16 k3s-uninstall.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>
<div class="custom-container warning"><p class="custom-container-title">æ³¨æ„</p>
<p>âš ï¸ æˆ‘åœ¨ä¸Šä¸€èŠ‚ä»‹ç»äº†ä½¿ç”¨ <strong>åˆ«å</strong> ï¼Œå®ƒå¯ä»¥æ´¾ä¸Šç”¨åœºäº†ã€‚</p>
</div>
<p><code v-pre>INSTALL_K3S_SKIP_ENABLE</code> -- å¦‚æœè®¾ç½®ä¸º &quot;true&quot;ï¼Œå°†ä¸å¯ç”¨æˆ–å¯åŠ¨ K3s æœåŠ¡ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SKIP_ENABLE</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p><strong>å¼€å¯ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>systemctl start k3s
kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>
<p><code v-pre>INSTALL_K3S_SKIP_START</code> -- å¦‚æœè®¾ç½®ä¸º &quot;true &quot;å°†ä¸ä¼šå¯åŠ¨ K3s æœåŠ¡ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SKIP_START</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_VERSION</code> -- ä» Github ä¸‹è½½ K3s çš„ç‰ˆæœ¬ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°†å°è¯•ä»&quot;stable&quot;é¢‘é“ä¸‹è½½ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_VERSION</span><span class="token operator">=</span><span class="token string">"v1.19.9+k3s1"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>æ³¨æ„åé¢æ˜¯ <code v-pre>+</code></p>
</blockquote>
<p><code v-pre>INSTALL_K3S_BIN_DIR</code> -- å®‰è£… K3s äºŒè¿›åˆ¶æ–‡ä»¶ã€é“¾æ¥å’Œå¸è½½è„šæœ¬çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨ <code v-pre>/usr/local/bin</code> ä½œä¸ºé»˜è®¤ç›®å½•ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_BIN_DIR</span><span class="token operator">=</span>/opt/bin <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container danger"><p class="custom-container-title">è­¦å‘Š</p>
<p>è¿™é‡Œæœ‰ä¸ªå‘ï¼Œå®ƒçµ¦è®¾ç½® äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼Œä½†æ˜¯ä¸ç»™æ”¹å˜ç¯å¢ƒå˜é‡è·¯å¾„~</p>
<p>ä¸€ä¸ª idea ï¼šå¦‚æœæˆ‘ä»¬åˆ›å»ºçš„ hash ç›®å½•ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥å°† roofs è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œå°±æ¯”å¦‚è¯´ <code v-pre>cd ~k3s</code>   OR   <code v-pre>cd $K3S</code></p>
<p>æˆ‘ä»¬åªéœ€è¦æ‹¿åˆ° hash è·¯å¾„  <code v-pre>export K3S=&quot;/var/lib/rancher/k3s/data/${HASH}/bin&quot;</code></p>
</div>
<p><code v-pre>INSTALL_K3S_BIN_DIR_READ_ONLY</code> -- å¦‚æœè®¾ç½®ä¸º true å°†ä¸ä¼šæŠŠæ–‡ä»¶å†™å…¥INSTALL_K3S_BIN_DIRï¼Œå¼ºåˆ¶è®¾ç½®INSTALL_K3S_SKIP_DOWNLOAD=trueã€‚</p>
<p><code v-pre>INSTALL_K3S_SKIP_DOWNLOAD</code> ä¼šåˆ›å»º <code v-pre>kubectl/crictl/ctr</code> ç­‰ï¼Œè€Œ <code v-pre>INSTALL_K3S_BIN_DIR_READ_ONLY</code> ä¸åˆ›å»ºã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_BIN_DIR_READ_ONLY</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_SYSTEMD_DIR</code> -- å®‰è£… systemd æœåŠ¡å’Œç¯å¢ƒæ–‡ä»¶çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨/etc/systemd/system ä½œä¸ºé»˜è®¤ç›®å½•ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SYSTEMD_DIR</span><span class="token operator">=</span>/opt/systemd <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æµ‹è¯•</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># INSTALL_K3S_MIRROR=cn   INSTALL_K3S_SYSTEMD_DIR=/opt/systemd sh install.sh </span>
root@cubmaster01:/opt/systemd<span class="token comment"># ls -al</span>
total <span class="token number">12</span>
drwxr-xr-x <span class="token number">2</span> root root <span class="token number">4096</span> Nov <span class="token number">26</span> <span class="token number">11</span>:53 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">6</span> root root <span class="token number">4096</span> Nov <span class="token number">26</span> <span class="token number">11</span>:51 <span class="token punctuation">..</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">829</span> Nov <span class="token number">26</span> <span class="token number">11</span>:53 k3s.service
-rw------- <span class="token number">1</span> root root    <span class="token number">0</span> Nov <span class="token number">26</span> <span class="token number">11</span>:53 k3s.service.env
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><code v-pre>INSTALL_K3S_EXEC</code> -- å¸¦æœ‰æ ‡å¿—çš„å‘½ä»¤ï¼Œç”¨äºåœ¨æœåŠ¡ä¸­å¯åŠ¨ K3sã€‚<strong>å¦‚æœæœªæŒ‡å®šå‘½ä»¤ï¼Œå¹¶ä¸”è®¾ç½®äº† K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œagentâ€ã€‚å¦‚æœæœªè®¾ç½® K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œserverâ€ã€‚</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--docker"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**æœ€åçš„ systemd å‘½ä»¤è§£æä¸ºè¿™ä¸ªç¯å¢ƒå˜é‡å’Œè„šæœ¬å‚æ•°çš„ç»„åˆã€‚**ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œä»¥ä¸‹å‘½ä»¤çš„ç»“æœä¸æ³¨å†Œä¸€ä¸ªæ²¡æœ‰ flannel çš„ server çš„è¡Œä¸ºç›¸åŒï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--flannel-backend none"</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> -
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"server --flannel-backend none"</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> -
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"server"</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - --flannel-backend none
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - server --flannel-backend none
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - --flannel-backend none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_NAME</code> -- è¦åˆ›å»ºçš„ <code v-pre>systemd</code> æœåŠ¡åç§°ï¼Œå¦‚æœä»¥æœåŠ¡å™¨æ–¹å¼è¿è¡Œ k3sï¼Œåˆ™é»˜è®¤ä¸º <code v-pre>'k3s'</code>ï¼›å¦‚æœä»¥ <code v-pre>agent</code> æ–¹å¼è¿è¡Œ <code v-pre>k3s</code>ï¼Œåˆ™é»˜è®¤ä¸º <code v-pre>'k3s-agent'</code> ã€‚å¦‚æœæŒ‡å®šäº†æœåŠ¡åï¼Œåˆ™æœåŠ¡åå°†ä»¥ <code v-pre>'k3s-'</code> ä¸ºå‰ç¼€ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_NAME</span><span class="token operator">=</span><span class="token string">"seal"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_TYPE</code> -- è¦åˆ›å»ºçš„ systemd æœåŠ¡ç±»å‹ï¼Œé»˜è®¤ä¸º notify</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_TYPE</span><span class="token operator">=</span><span class="token string">"exec"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>INSTALL_K3S_SKIP_SELINUX_RPM</code> -- å¦‚æœè®¾ç½®ä¸º <code v-pre>&quot;true &quot;</code> å°†è·³è¿‡ <code v-pre>k3s RPM</code> çš„è‡ªåŠ¨å®‰è£…ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_SKIP_SELINUX_RPM</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">K3s RPM</p>
<p><a href="https://en.wikipedia.org/wiki/Security-Enhanced_Linux" target="_blank" rel="noopener noreferrer">å®‰å…¨å¢å¼ºçš„ Linuxï¼ˆSELinuxï¼‰<ExternalLinkIcon/></a>æ˜¯å¯¹ Linux çš„å®‰å…¨å¢å¼ºã€‚</p>
<p>å®ƒç”± Red Hat å¼€å‘ï¼Œæ˜¯ Linux ä¸Šå¼ºåˆ¶æ€§è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰çš„ä¸€ä¸ªå®ç°ã€‚å¼ºåˆ¶æ€§è®¿é—®æ§åˆ¶å…è®¸ç³»ç»Ÿç®¡ç†å‘˜å®šä¹‰åº”ç”¨ç¨‹åºå’Œç”¨æˆ·å¦‚ä½•è®¿é—®ä¸åŒçš„èµ„æºï¼Œå¦‚æ–‡ä»¶ã€è®¾å¤‡ã€ç½‘ç»œå’Œè¿›ç¨‹é—´é€šä¿¡ã€‚SELinux è¿˜é€šè¿‡ä½¿æ“ä½œç³»ç»Ÿåœ¨é»˜è®¤æƒ…å†µä¸‹å…·æœ‰é™åˆ¶æ€§è€Œå¢å¼ºäº†å®‰å…¨æ€§ã€‚</p>
<p>åœ¨å†å²ä¸Šè¢«æ”¿åºœæœºæ„ä½¿ç”¨åï¼ŒSELinux ç°åœ¨æ˜¯è¡Œä¸šæ ‡å‡†ï¼Œåœ¨ CentOS 7 å’Œ 8 ä¸Šé»˜è®¤å¯ç”¨ã€‚è¦æ£€æŸ¥ SELinux æ˜¯å¦åœ¨ä½ çš„ç³»ç»Ÿä¸Šå¯ç”¨å’Œæ‰§è¡Œï¼Œè¯·ä½¿ç”¨<code v-pre>getenforce</code>ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>getenforce
Enforcing
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><code v-pre>INSTALL_K3S_CHANNEL_URL</code> -- ç”¨äºè·å– K3s ä¸‹è½½ç½‘å€çš„é¢‘é“ URLã€‚é»˜è®¤ä¸º https://update.k3s.io/v1-release/channels ã€‚</p>
<p><code v-pre>INSTALL_K3S_CHANNEL</code> -- ç”¨äºè·å– K3s ä¸‹è½½ URL çš„é€šé“ã€‚é»˜è®¤å€¼ä¸º &quot;stable&quot;ã€‚é€‰é¡¹åŒ…æ‹¬ï¼š<code v-pre>stable</code>, <code v-pre>latest</code>, <code v-pre>testing</code>ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_CHANNEL</span><span class="token operator">=</span><span class="token string">"latest"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>K3S_CONFIG_FILE</code> -- æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚é»˜è®¤ç›®å½•ä¸º<code v-pre>/etc/rancher/k3s/config.yaml</code>ã€‚</p>
<div class="custom-container tip"><p class="custom-container-title">æˆ‘ä»¬å…ˆæŒ‡å®šä¸‹æ–‡ä»¶ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">>></span> /opt/config.yaml <span class="token operator">&lt;&lt;-</span><span class="token string">EOF
node-label:
- "foo=bar"
- "something=amazing"
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">K3S_CONFIG_FILE</span><span class="token operator">=</span>/opt/config.yaml <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://sm.nsddd.top/smimage-20221126211751303.png" alt="image-20221126211751303"></p>
<p><code v-pre>K3S_TOKEN</code> -- ç”¨äºå°† server æˆ– agent åŠ å…¥é›†ç¾¤çš„å…±äº« secretã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>rancher-k3s <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">å¸Œæœ›ä½ å¯ä»¥æ‰¾åˆ°å®ƒçš„ä½ç½®</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> /var/lib/rancher/k3s/server/token
K1042465c14be8de6a57c482b4162f673addcb652acb13c8119a9900b5d27c234f7::server:rancher-k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><code v-pre>K3S_TOKEN_FILE</code> -- æŒ‡å®š <code v-pre>cluster-secret</code>,<code v-pre>token</code> çš„æ–‡ä»¶ç›®å½•ã€‚</p>
<div class="custom-container tip"><p class="custom-container-title">æˆ‘ä»¬éœ€è¦å…ˆæŒ‡å®šæ–‡ä»¶</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">>></span> /opt/token.txt <span class="token operator">&lt;&lt;-</span><span class="token string">EOF
rancher-k3s
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">K3S_TOKEN_FILE</span><span class="token operator">=</span>/opt/token.txt <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">å¸Œæœ›ä½ å¯ä»¥æ‰¾åˆ°å®ƒçš„ä½ç½®</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># cat /var/lib/rancher/k3s/server/token</span>
K10fbe884032e42976a1dd419e5d171b9bc38d50e13dc852afbc97ffb99c765f06e::server:rancher-k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div>
<h3 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h3>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<ol>
<li>ä»¥ &quot;K3S_&quot;å¼€å¤´çš„ç¯å¢ƒå˜é‡å°†è¢«ä¿ç•™ï¼Œä¾› systemd å’Œ openrc æœåŠ¡ä½¿ç”¨ã€‚</li>
<li>åœ¨æ²¡æœ‰æ˜ç¡®è®¾ç½® exec å‘½ä»¤çš„æƒ…å†µä¸‹è®¾ç½® K3S_URLï¼Œä¼šå°†å‘½ä»¤é»˜è®¤ä¸º &quot;agent&quot;ã€‚</li>
<li>è¿è¡Œ agent æ—¶è¿˜å¿…é¡»è®¾ç½® K3S_TOKENã€‚</li>
</ol>
</div>
<h2 id="å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……" tabindex="-1"><a class="header-anchor" href="#å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……" aria-hidden="true">#</a> å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……</h2>
<p>å®‰è£…è„šæœ¬ä¸»è¦æ˜¯é…ç½® K3s ä½œä¸ºæœåŠ¡è¿è¡Œã€‚å¦‚æœä½ é€‰æ‹©ä¸ä½¿ç”¨è„šæœ¬ï¼Œä½ å¯ä»¥é€šè¿‡ <a href="https://github.com/rancher/k3s/releases/latest" target="_blank" rel="noopener noreferrer">å‘å¸ƒé¡µé¢<ExternalLinkIcon/></a>ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†å…¶æ”¾åœ¨ä½ çš„ç¯å¢ƒå˜é‡è·¯å¾„ä¸Šï¼Œç„¶åæ‰§è¡Œå®ƒæ¥è¿è¡Œ K3sã€‚K3s äºŒè¿›åˆ¶æ”¯æŒä»¥ä¸‹å‘½ä»¤ï¼š</p>
<p><code v-pre>k3s server</code> -- è¿è¡Œ K3s serverï¼Œå®ƒè¿˜å°†å¯åŠ¨ Kubernetes control-plane ç»„ä»¶ï¼Œå¦‚ API server, controller-manager, å’Œ schedulerã€‚</p>
<blockquote>
<p>å’Œ kubernetes çš„æ§åˆ¶å±‚é¢å¾ˆç±»ä¼¼~</p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># k3s server</span>
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Acquiring lock <span class="token function">file</span> /var/lib/rancher/k3s/data/.lock 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Preparing data <span class="token function">dir</span> /var/lib/rancher/k3s/data/2ef87ff954adbb390309ce4dc07500f29c319f84feec1719bfb5059c8808ec6a 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Starting k3s v1.25.3+k3s1 <span class="token punctuation">(</span>f2585c16<span class="token punctuation">)</span>         
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Configuring sqlite3 database connection pooling: <span class="token assign-left variable">maxIdleConns</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">maxOpenConns</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">connMaxLifetime</span><span class="token operator">=</span>0s 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Configuring database table schema and indexes, this may take a moment<span class="token punctuation">..</span>. 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Database tables and indexes are up to <span class="token function">date</span>   
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Kine available at unix://kine.sock 
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>k3s agent</code> -- è¿è¡Œ <code v-pre>K3s agent</code> èŠ‚ç‚¹ã€‚è¿™å°†ä½¿ <code v-pre>K3s</code> ä½œä¸ºå·¥ä½œèŠ‚ç‚¹è¿è¡Œï¼Œå¯åŠ¨ <code v-pre>Kubernetes</code> èŠ‚ç‚¹æœåŠ¡ <code v-pre>kubelet</code> å’Œ <code v-pre>kube-proxy</code>ã€‚</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>root@etcnode01:~# k3s agent --server https://192.168.71.130:6443 --token K10fcaced71fc70ca6b77921a7e374dc03c34fdd1fb11973d69a2a8e937b61beb22::server:82c397ed440c496f5448ec3c4b11c112
INFO[0000] Starting k3s agent v1.25.4+k3s1 (0dc63334)   
INFO[0000] Running load balancer k3s-agent-load-balancer 127.0.0.1:6444 -> [192.168.71.130:6443] 
ERRO[0004] failed to get CA certs: Get "https://127.0.0.1:6444/cacerts": read tcp 127.0.0.1:60386->127.0.0.1:6444: read: connection reset by peer 
......
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/opt<span class="token comment"># k3s kubectl get nodes</span>
NAME          STATUS   ROLES                  AGE   VERSION
cubmaster01   Ready    control-plane,master   96m   v1.25.3+k3s1
cubnode02     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 52m   v1.25.4+k3s1
etcnode01     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 67m   v1.25.4+k3s1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>
<p><code v-pre>k3s kubectl</code> -- è¿è¡ŒåµŒå…¥å¼ kubectl CLIã€‚å¦‚æœæ²¡æœ‰è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡ï¼Œå½“å¯åŠ¨ K3s æœåŠ¡å™¨èŠ‚ç‚¹æ—¶ï¼Œå°†è‡ªåŠ¨å°è¯•ä½¿ç”¨åœ¨<code v-pre>/etc/rancher/k3s/k3s.yaml</code> åˆ›å»ºçš„é…ç½®æ–‡ä»¶ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># k3s kubectl get nodes</span>
NAME   STATUS   ROLES                  AGE     VERSION
k3s1   Ready    control-plane,master   8m14s   v1.20.5+k3s1
k3s2   Ready    <span class="token operator">&lt;</span>none                11s     v1.20.5+k3s1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>k3s crictl</code> -- è¿è¡Œä¸€ä¸ªåµŒå…¥å¼ crictlã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºä¸ Kubernetes çš„å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰äº¤äº’çš„ CLIã€‚å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># k3s crictl ps</span>
CONTAINER           IMAGE               CREATED             STATE               NAME                     ATTEMPT             POD ID
9ceb610df16c7       aa764f7db3051       <span class="token number">8</span> minutes ago       Running             traefik                  <span class="token number">0</span>                   373c79416fa65
cadceb62ae08d       897ce3c5fc8ff       <span class="token number">8</span> minutes ago       Running             lb-port-443              <span class="token number">0</span>                   f8a0ecfe56562
a26a49be485ac       897ce3c5fc8ff       <span class="token number">8</span> minutes ago       Running             lb-port-80               <span class="token number">0</span>                   f8a0ecfe56562
01894072f2298       148c192562719       <span class="token number">8</span> minutes ago       Running             local-path-provisioner   <span class="token number">1</span>                   b9d55e63f632f
5ccd6ed05120f       296a6d5035e2d       <span class="token number">9</span> minutes ago       Running             coredns                  <span class="token number">0</span>                   2bae007d8e486
be0765e77a703       9dd718864ce61       <span class="token number">9</span> minutes ago       Running             metrics-server           <span class="token number">0</span>                   53ab949c026ce
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>k3s ctr</code> -- è¿è¡Œä¸€ä¸ªåµŒå…¥å¼çš„ ctrã€‚è¿™æ˜¯ä¸º containerdï¼ˆK3s ä½¿ç”¨çš„å®¹å™¨å®ˆæŠ¤è¿›ç¨‹ï¼‰æä¾›çš„ CLIã€‚å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># k3s ctr container ls</span>
CONTAINER                                                           IMAGE                                                                                                               RUNTIME
01894072f2298208f3c109f9fb1d5e12e677d11cd5d0b0a3a66f550ae38644e4    docker.io/rancher/local-path-provisioner:v0.0.19                                                                    io.containerd.runc.v2
2bae007d8e486afffbbf1ffb88e97b92d367aff4b06842217de4fb5d22ecf1b9    docker.io/rancher/pause:3.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>k3s server</code> å’Œ <code v-pre>k3s agent</code> å‘½ä»¤æœ‰é¢å¤–çš„é…ç½®é€‰é¡¹ï¼Œå¯ä»¥é€šè¿‡ <code v-pre>k3s server --help</code> æˆ– <code v-pre>k3s agent --help</code> æŸ¥çœ‹ã€‚</p>
<h2 id="é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨-k3s" tabindex="-1"><a class="header-anchor" href="#é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨-k3s" aria-hidden="true">#</a> é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨ K3s</h2>
<p>é™¤äº†ä½¿ç”¨ç¯å¢ƒå˜é‡å’Œ CLI å‚æ•°æ¥é…ç½® K3sï¼ŒK3s è¿˜å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶ã€‚é»˜è®¤ç›®å½•ä½äº <code v-pre>/etc/rancher/k3s/config.yaml</code>ï¼ˆæˆ–è€…æ˜¯ <code v-pre>k3s.yaml</code> æ–‡ä»¶ï¼‰</p>
<div class="custom-container warning"><p class="custom-container-title">æç¤º</p>
<p>å¦‚æœåŒæ—¶ä½¿ç”¨é…ç½®æ–‡ä»¶å’Œ CLI å‚æ•°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå€¼å°†ä»ä¸¤ä¸ªæ¥æºåŠ è½½ï¼Œä½† CLI å‚æ•°ä¼˜å…ˆçº§æ›´é«˜ã€‚ å¯¹äºå¯é‡å¤çš„å‚æ•°ï¼Œå¦‚--node-labelï¼ŒCLI å‚æ•°å°†è¦†ç›–åˆ—è¡¨ä¸­çš„æ‰€æœ‰å€¼ã€‚</p>
</div>
<h2 id="k3s-server-agent-é…ç½®" tabindex="-1"><a class="header-anchor" href="#k3s-server-agent-é…ç½®" aria-hidden="true">#</a> K3s Server/Agent é…ç½®</h2>
<p><strong><code v-pre>write-kubeconfig</code> -- å°†ç®¡ç†å®¢æˆ·ç«¯çš„ kubeconfig å†™å…¥è¿™ä¸ªæ–‡ä»¶</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">K3S_KUBECONFIG_OUTPUT</span><span class="token operator">=</span>/root/.kube/config <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä½¿ç”¨ docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--docker"</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æµ‹è¯•</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                              COMMAND                  CREATED              STATUS              PORTS     NAMES
9e9e8cd5eb22   rancher/mirrored-library-traefik   <span class="token string">"/entrypoint.sh --glâ€¦"</span>   <span class="token number">14</span> seconds ago       Up <span class="token number">12</span> seconds                 k8s_traefik_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
8fb6d8f2c3dc   dbd43b6716a0                       <span class="token string">"entry"</span>                  <span class="token number">32</span> seconds ago       Up <span class="token number">31</span> seconds                 k8s_lb-tcp-443_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6033d7ecc824   dbd43b6716a0                       <span class="token string">"entry"</span>                  <span class="token number">32</span> seconds ago       Up <span class="token number">31</span> seconds                 k8s_lb-tcp-80_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6b95dbafc4ee   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 <span class="token number">32</span> seconds ago       Up <span class="token number">31</span> seconds                 k8s_POD_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
b13f33df38d9   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 <span class="token number">33</span> seconds ago       Up <span class="token number">31</span> seconds                 k8s_POD_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
5e8ce9d7d95e   rancher/mirrored-coredns-coredns   <span class="token string">"/coredns -conf /etcâ€¦"</span>   <span class="token number">51</span> seconds ago       Up <span class="token number">50</span> seconds                 k8s_coredns_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_1
03db38691203   rancher/local-path-provisioner     <span class="token string">"local-path-provisioâ€¦"</span>   <span class="token number">56</span> seconds ago       Up <span class="token number">55</span> seconds                 k8s_local-path-provisioner_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_1
9b087eb2f2d0   e57a417f15d3                       <span class="token string">"/metrics-server --câ€¦"</span>   About a minute ago   Up About a minute             k8s_metrics-server_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_1
a1ead6d83564   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 About a minute ago   Up About a minute             k8s_POD_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_0
7a1020d7a01f   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 About a minute ago   Up About a minute             k8s_POD_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_0
cd0e940354a9   rancher/mirrored-pause:3.6         <span class="token string">"/pause"</span>                 About a minute ago   Up About a minute             k8s_POD_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_0

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><strong>é’ˆå¯¹å¤šç½‘å¡ä¸»æœºå®‰è£… K3s é›†ç¾¤</strong></p>
<p><strong>k3s server:</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
<span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--node-ip=192.168.99.211"</span> <span class="token punctuation">\</span>
<span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>K3s agent:</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
<span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://192.168.99.211:6443 <span class="token punctuation">\</span>
<span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>xiongxinwei <span class="token punctuation">\</span>
<span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--node-ip=192.168.99.212"</span> <span class="token punctuation">\</span>
<span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>--tls-san -- åœ¨ TLS è¯ä¹¦ä¸­æ·»åŠ å…¶ä»–ä¸»æœºåæˆ– IP ä½œä¸ºä¸»é¢˜å¤‡ç”¨åç§°</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--tls-san 3.97.6.45"</span>  <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¿®æ”¹<code v-pre>kube-apiserver</code>ã€<code v-pre>kube-scheduler</code> ã€<code v-pre>kube-controller-manager</code>ã€ <code v-pre>kube-cloud-controller-manager</code>ã€ <code v-pre>kubelet</code>ã€ <code v-pre>kube-proxy</code> å‚æ•°</p>
<p><strong>kubelet-argï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--kubelet-arg=max-pods=200'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>kube-apiserverï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--kube-apiserver-arg=service-node-port-range=40000-50000'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>kube-proxy-argï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code> <span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--kube-proxy-arg=proxy-mode=ipvs'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong><code v-pre>--data-dir -- K3s</code> æ•°æ®å­˜å‚¨ç›®å½•ï¼Œé»˜è®¤ä¸º <code v-pre>/var/lib/rancher/k3s</code> æˆ– <code v-pre>${HOME}/.rancher/k3s</code>(å¦‚æœä¸æ˜¯ root ç”¨æˆ·)</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--data-dir=/opt/k3s-data'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>è¿™å°±æœ‰ç‚¹æ„æ€äº†ï¼Œæˆ‘ä»¬é»˜è®¤çš„å®‰è£…è¿ç§»äº†ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/opt/k3s-data/server<span class="token comment"># cd /opt/k3s-data/;ls</span>
agent  server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å½“ç„¶ï¼Œæˆ‘ä»¬è‡ªå·±è®¾è®¡ç›®å½•ç»“æ„çš„æ—¶å€™æˆ–è®¸å¯ä»¥ç”¨åˆ°~</strong></p>
</div>
<p><strong>ç¦ç”¨ç»„ä»¶ --disableï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--disable traefik'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p><strong>ç¦ç”¨å‰ï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">[</span>root@VM-4-6-centos k3s<span class="token punctuation">]</span><span class="token comment"># ls /var/lib/rancher/k3s/server/manifests</span>
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml  traefik.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¦ç”¨åï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># ls /var/lib/rancher/k3s/server/manifests</span>
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml
root@cubmaster01:/workspces/runtime<span class="token comment"># kubectl get pods -A | grep traefik</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p><strong>æ·»åŠ  label å’Œ taint:</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
  <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'--node-label foo=bar,hello=world --node-taint key1=value1:NoExecute'</span> <span class="token punctuation">\</span>
  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç½‘ç»œé€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œé€‰é¡¹" aria-hidden="true">#</a> ç½‘ç»œé€‰é¡¹</h2>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code v-pre>K3s</code> å°†ä»¥ <code v-pre>flannel</code> ä½œä¸º <code v-pre>CNI</code> è¿è¡Œï¼Œä½¿ç”¨ <code v-pre>VXLAN</code> ä½œä¸ºé»˜è®¤åç«¯ã€‚<code v-pre>CNI</code>å’Œé»˜è®¤åç«¯éƒ½å¯ä»¥é€šè¿‡å‚æ•°ä¿®æ”¹ã€‚</p>
<h3 id="flannel-é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#flannel-é€‰é¡¹" aria-hidden="true">#</a> Flannel é€‰é¡¹</h3>
<p>Flannel çš„é»˜è®¤åç«¯æ˜¯ VXLANã€‚è¦å¯ç”¨åŠ å¯†ï¼Œè¯·ä½¿ç”¨ä¸‹é¢çš„ IPSecï¼ˆInternet Protocol Securityï¼‰æˆ– WireGuard é€‰é¡¹ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">CLI Flag å’Œ Value</th>
<th style="text-align:left">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code v-pre>--flannel-backend=vxlan</code></td>
<td style="text-align:left">(é»˜è®¤) ä½¿ç”¨ VXLAN åç«¯ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code v-pre>--flannel-backend=ipsec</code></td>
<td style="text-align:left">ä½¿ç”¨ IPSEC åç«¯ï¼Œå¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code v-pre>--flannel-backend=host-gw</code></td>
<td style="text-align:left">ä½¿ç”¨ host-gw åç«¯ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code v-pre>--flannel-backend=wireguard</code></td>
<td style="text-align:left">ä½¿ç”¨ WireGuard åç«¯ï¼Œå¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†ã€‚å¯èƒ½éœ€è¦é¢å¤–çš„å†…æ ¸æ¨¡å—å’Œé…ç½®ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="flannel-backend-ä½¿ç”¨-host-gw" tabindex="-1"><a class="header-anchor" href="#flannel-backend-ä½¿ç”¨-host-gw" aria-hidden="true">#</a> flannel-backend ä½¿ç”¨ <code v-pre>host-gw</code></h3>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># K3s master</span>
root@k3s1:~<span class="token comment"># curl -sfL https://get.k3s.io | \</span>
        <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--flannel-backend=host-gw"</span> <span class="token punctuation">\</span>
        <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token function">sh</span> -

<span class="token comment"># K3s agent </span>
root@k3s2:~<span class="token comment"># curl -sfL https://get.k3s.io | \</span>
        <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://172.16.64.6:6443 <span class="token punctuation">\</span>
        <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>85892cbfef2177603f25be30344dbcd0 <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json</span>
<span class="token punctuation">{</span>
	<span class="token string">"Network"</span><span class="token builtin class-name">:</span> <span class="token string">"10.42.0.0/16"</span>,
	<span class="token string">"Backend"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">"Type"</span><span class="token builtin class-name">:</span> <span class="token string">"host-gw"</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

root@k3s1:~<span class="token comment"># route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">172.16</span>.64.1     <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> enp0s2
<span class="token number">10.42</span>.0.0       <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> cni0
<span class="token number">10.42</span>.1.0       <span class="token number">172.16</span>.64.9     <span class="token number">255.255</span>.255.0   UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> enp0s2
<span class="token number">172.16</span>.64.0     <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.0   U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> enp0s2
<span class="token number">172.16</span>.64.1     <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.255.255 UH    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> enp0s2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>
<h3 id="å¯ç”¨-directrouting" tabindex="-1"><a class="header-anchor" href="#å¯ç”¨-directrouting" aria-hidden="true">#</a> å¯ç”¨ Directrouting</h3>
<p>å½“ä¸»æœºåœ¨åŒä¸€å­ç½‘æ—¶ï¼Œå¯ç”¨ direct routes(å¦‚host-gw)ã€‚<code v-pre>vxlan</code> åªç”¨äºå°†æ•°æ®åŒ…å°è£…åˆ°ä¸åŒå­ç½‘çš„ä¸»æœºä¸Šï¼ŒåŒå­ç½‘çš„ä¸»æœºä¹‹é—´ä½¿ç”¨ <code v-pre>host-gw</code>ã€‚é»˜è®¤å€¼ä¸º <code v-pre>false</code>ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># K3s master å’Œ agent</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/net-conf.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF 
{
        "Network": "10.42.0.0/16",
        "Backend": {
            "Type": "vxlan",
            "Directrouting": true
	}
}
EOF</span>

<span class="token comment"># K3s master</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="token operator">|</span> <span class="token punctuation">\</span>
        <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--flannel-conf=/etc/net-conf.json"</span> <span class="token punctuation">\</span>
        <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="è‡ªå®šä¹‰-cni" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰-cni" aria-hidden="true">#</a> è‡ªå®šä¹‰ CNI</h2>
<p>ä½¿ç”¨ <code v-pre>--flannel-backend=none</code> è¿è¡Œ K3sï¼Œç„¶ååœ¨å®‰è£…ä½ é€‰æ‹©çš„ CNIã€‚</p>
<h4 id="calico" tabindex="-1"><a class="header-anchor" href="#calico" aria-hidden="true">#</a> Calico</h4>
<p>æŒ‰ç…§<a href="https://docs.projectcalico.org/master/reference/cni-plugin/configuration" target="_blank" rel="noopener noreferrer">Calico CNI æ’ä»¶æŒ‡å—<ExternalLinkIcon/></a>ã€‚ä¿®æ”¹ Calico YAMLï¼Œåœ¨ container_settings éƒ¨åˆ†ä¸­å…è®¸ IP è½¬å‘ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>"container_settings": {
              "allow_ip_forwarding": true
          }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>å¦‚ä¸é…ç½® <code v-pre>&quot;allow_ip_forwarding&quot;: true</code>ï¼Œ <code v-pre>svclb-traefik</code> å°†ä¼šæŠ¥é”™ï¼š<code v-pre>/usr/bin/entry: line 6: can't create /proc/sys/net/ipv4/ip_forward: Read-only file system</code></p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@k3s1:~<span class="token comment"># curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \</span>
        <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\</span>
        <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">"--flannel-backend=none \
        --cluster-cidr=192.168.200.0/24"</span> <span class="token punctuation">\</span>
        <span class="token function">sh</span> -
root@k3s1:~<span class="token comment"># kubectl apply -f https://raw.githubusercontent.com/kingsd041/k3s-tutorial/main/05-å®‰è£…-ç½‘ç»œé€‰é¡¹/calico.yaml</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**å‚è€ƒï¼š**https://docs.projectcalico.org/getting-started/kubernetes/k3s/quickstart</p>
<h2 id="ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…" aria-hidden="true">#</a> ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…</h2>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>å•èŠ‚ç‚¹ k3s server é›†ç¾¤å¯ä»¥æ»¡è¶³å„ç§ç”¨ä¾‹ï¼Œä½†æ˜¯å¯¹äºéœ€è¦ Kubernetes control-plane ç¨³å®šè¿è¡Œçš„é‡è¦ç¯å¢ƒï¼Œæ‚¨å¯ä»¥åœ¨ HA é…ç½®ä¸­è¿è¡Œ K3sã€‚ä¸€ä¸ª K3s HA é›†ç¾¤ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li><strong>ä¸¤ä¸ªæˆ–å¤šä¸ª</strong> <code v-pre>server èŠ‚ç‚¹</code>ï¼Œå°†ä¸º Kubernetes API æä¾›æœåŠ¡å¹¶è¿è¡Œå…¶ä»– control-plane æœåŠ¡ã€‚</li>
<li><strong>é›¶ä¸ªæˆ–å¤šä¸ª</strong> <code v-pre>agent èŠ‚ç‚¹</code>ï¼Œç”¨äºè¿è¡Œæ‚¨çš„åº”ç”¨å’ŒæœåŠ¡ã€‚</li>
<li><code v-pre>å¤–éƒ¨æ•°æ®å­˜å‚¨</code> (ä¸å•ä¸ª k3s server è®¾ç½®ä¸­ä½¿ç”¨çš„åµŒå…¥å¼ SQLite æ•°æ®å­˜å‚¨ç›¸å)</li>
<li><code v-pre>å›ºå®šçš„æ³¨å†Œåœ°å€</code>ï¼Œä½äº server èŠ‚ç‚¹çš„å‰é¢ï¼Œä»¥å…è®¸ agent èŠ‚ç‚¹å‘é›†ç¾¤æ³¨å†Œ</li>
</ul>
<blockquote>
<p>Agent é€šè¿‡å›ºå®šçš„æ³¨å†Œåœ°å€è¿›è¡Œæ³¨å†Œï¼Œä½†æ³¨å†Œåç›´æ¥ä¸å…¶ä¸­ä¸€ä¸ª <code v-pre>server</code> èŠ‚ç‚¹å»ºç«‹è¿æ¥ã€‚è¿™æ˜¯ä¸€ä¸ªç”± <code v-pre>k3s agent</code> è¿›ç¨‹å‘èµ·çš„ <code v-pre>websocket</code> è¿æ¥ï¼Œå¹¶ç”±ä½œä¸º <code v-pre>agent</code> è¿›ç¨‹ä¸€éƒ¨åˆ†è¿è¡Œçš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ç»´æŠ¤ã€‚</p>
<p><strong>åµŒå…¥å¼ ETCD ä½¿ç”¨çš„å…±è¯†ç®—æ³• Raft å»ºè®®ä½ ä½¿ç”¨æœ€å°‘ 3 ä¸ªä¸”æ•°é‡ä¸ºå¥‡æ•°çš„èŠ‚ç‚¹</strong></p>
</blockquote>
</div>
<h3 id="ç¯å¢ƒå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h3>
<div class="custom-container warning"><p class="custom-container-title">æé†’</p>
<p>ä¸ªäººæ¯”è¾ƒå€¾å‘äº etcdï¼ŒDqlite å·²ç»è¢«æŠ›å¼ƒäº†ï¼ŒåµŒå…¥å¼ etcd æ‰æ˜¯ yyds</p>
<p>ä½¿ç”¨ä¹‹å‰çš„ 3 å°ä¸»æœºå®éªŒã€‚<strong>åˆ›å»ºä¸€ä¸ªå¤–éƒ¨æ•°æ®å­˜å‚¨</strong></p>
</div>
<table>
<thead>
<tr>
<th>ä¸»æœºå</th>
<th>è§’è‰²</th>
<th>IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>k3s-server-1</td>
<td>k3s master</td>
<td>192.168.71.130</td>
</tr>
<tr>
<td>k3s-server-2</td>
<td>k3s master</td>
<td>192.168.71.131</td>
</tr>
<tr>
<td>k3s-db</td>
<td>DB</td>
<td>121.43.165.25</td>
</tr>
<tr>
<td>k3s-lb</td>
<td>LB</td>
<td>172.31.13.97</td>
</tr>
<tr>
<td>k3s-agent</td>
<td>k3s agent</td>
<td>172.31.15.130</td>
</tr>
</tbody>
</table>
<h3 id="å¤–éƒ¨æ•°æ®åº“é«˜å¯ç”¨" tabindex="-1"><a class="header-anchor" href="#å¤–éƒ¨æ•°æ®åº“é«˜å¯ç”¨" aria-hidden="true">#</a> å¤–éƒ¨æ•°æ®åº“é«˜å¯ç”¨</h3>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># k3s-db</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> some-mysql <span class="token parameter variable">--restart</span><span class="token operator">=</span>unless-stopped <span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>password <span class="token parameter variable">-d</span> mysql:5.7
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¯åŠ¨ k3s server èŠ‚ç‚¹:</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># k3s-server-1 å’Œ k3s-server-2 èŠ‚ç‚¹</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - server <span class="token punctuation">\</span>
  --datastore-endpoint<span class="token operator">=</span><span class="token string">"mysql://root:password@tcp(192.168.71.130:3306)/database-name"</span> --tls-san <span class="token number">172.31</span>.13.97
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container warning"><p class="custom-container-title">æ³¨æ„</p>
<p><code v-pre>--tls-san</code>ï¼šåœ¨ TLS è¯ä¹¦ä¸­æ·»åŠ å…¶ä»–ä¸»æœºåæˆ– IP ä½œä¸ºä¸»é¢˜å¤‡ç”¨åç§°ï¼Œæœ¬ä¾‹ä¸º LB çš„ IP
å¦åˆ™é€šè¿‡ LB IP è¿æ¥ k3s api æ—¶å°†ä¼šæŠ¥é”™ï¼š<code v-pre>Unable to connect to the server: x509: certificate is valid for 10.43.0.1, 127.0.0.1, 172.31.2.134, 172.31.2.42, not 172.31.13.97</code></p>
<p><code v-pre>--tls-san</code> å¯çœç•¥</p>
</div>
<div class="custom-container tip"><p class="custom-container-title">éªŒè¯</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œserver èŠ‚ç‚¹å°†æ˜¯å¯è°ƒåº¦çš„ï¼Œå› æ­¤ä½ çš„å·¥ä½œè´Ÿè½½å¯ä»¥åœ¨å®ƒä»¬ä¸Šå¯åŠ¨ã€‚å¦‚æœä½ å¸Œæœ›æœ‰ä¸€ä¸ªä¸“ç”¨çš„ control-planeï¼Œåœ¨è¿™ä¸ªå¹³é¢ä¸Šä¸ä¼šè¿è¡Œç”¨æˆ·å·¥ä½œè´Ÿè½½ï¼Œä½ å¯ä»¥ä½¿ç”¨ taintsã€‚<code v-pre>node-taint</code> å‚æ•°å°†å…è®¸ä½ ç”¨æ±¡ç‚¹é…ç½®èŠ‚ç‚¹ï¼Œä¾‹å¦‚<code v-pre>--node-taint CriticalAddonsOnly=true:NoExecute</code>ã€‚</p>
</div>
<h3 id="agent-åŠ å…¥" tabindex="-1"><a class="header-anchor" href="#agent-åŠ å…¥" aria-hidden="true">#</a> agent åŠ å…¥</h3>
<p>Agent èŠ‚ç‚¹éœ€è¦ä¸€ä¸ª URL æ¥æ³¨å†Œï¼Œä½ åº”è¯¥åœ¨ server èŠ‚ç‚¹å‰é¢æœ‰ä¸€ä¸ªç¨³å®šçš„ endpointï¼Œä¸ä¼šéšæ—¶é—´æ¨ç§»è€Œæ”¹å˜ã€‚å¯ä»¥ä½¿ç”¨è®¸å¤šæ–¹æ³•æ¥è®¾ç½®æ­¤ endpointï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>ä¸€ä¸ª 4 å±‚ï¼ˆTCPï¼‰è´Ÿè½½å‡è¡¡å™¨</li>
<li>è½®è¯¢ DNS</li>
<li>è™šæ‹Ÿæˆ–å¼¹æ€§ IP åœ°å€</li>
</ul>
<p>ä½¿ç”¨ nginx ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼Œå°† 6443 ç«¯å£æµé‡è½¬å‘åˆ° k3s server:</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># k3s-lb èŠ‚ç‚¹</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/nginx.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
worker_processes 4;
worker_rlimit_nofile 40000;

events {
    worker_connections 8192;
}

stream {
    upstream k3s_api {
        least_conn;
        server 172.31.2.134:6443 max_fails=3 fail_timeout=5s;
        server 172.31.2.42:6443 max_fails=3 fail_timeout=5s;
    }
    server {
        listen     6443;
        proxy_pass k3s_api;
    }
}
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>è¿è¡Œï¼š</em></p>
<div class="language-docker ext-docker line-numbers-mode"><pre v-pre class="language-docker"><code>docker run -d --restart=unless-stopped \
  -p 6443:6443 \
  -v /etc/nginx.conf:/etc/nginx/nginx.conf \
  nginx:1.14
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ²¡æœ‰-cli-æ ‡å¿—å¯åŠ¨-agent-åŠ å…¥" tabindex="-1"><a class="header-anchor" href="#æ²¡æœ‰-cli-æ ‡å¿—å¯åŠ¨-agent-åŠ å…¥" aria-hidden="true">#</a> æ²¡æœ‰ CLI æ ‡å¿—å¯åŠ¨ agent åŠ å…¥</h3>
<p>å¦‚æœç¬¬ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹æ˜¯åœ¨æ²¡æœ‰ <code v-pre>--token</code> CLI æ ‡å¿—æˆ– <code v-pre>K3S_TOKEN</code> å˜é‡çš„æƒ…å†µä¸‹å¯åŠ¨çš„ï¼Œåˆ™å¯ä»¥ä»å·²åŠ å…¥ç¾¤é›†çš„ä»»ä½•æœåŠ¡å™¨æ£€ç´¢ä»¤ç‰Œå€¼ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> /var/lib/rancher/k3s/server/token
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ç„¶å<a href="https://docs.k3s.io/reference/server-config#cluster-options" target="_blank" rel="noopener noreferrer">å¯ä»¥ä½¿ç”¨ä»¤ç‰Œæ·»åŠ <ExternalLinkIcon/></a>å…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹:</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - server <span class="token punctuation">\</span>
  <span class="token punctuation">\</span>
  --datastore-endpoint<span class="token operator">=</span><span class="token string">"mysql://username:password@tcp(hostname:3306)/database-name"</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>åœ¨ HA é›†ç¾¤ä¸­åŠ å…¥ agent èŠ‚ç‚¹ä¸åœ¨å•ä¸ª server é›†ç¾¤ä¸­åŠ å…¥ agent èŠ‚ç‚¹æ˜¯ä¸€æ ·çš„ã€‚ä½ åªéœ€è¦æŒ‡å®š agent åº”è¯¥æ³¨å†Œåˆ°çš„ URL å’Œå®ƒåº”è¯¥ä½¿ç”¨çš„ token å³å¯ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># k3s-agent èŠ‚ç‚¹</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://172.31.13.97:6443 <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>mynodetoken <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div>
<p>æœ‰ä¸€äº›é…ç½®æ ‡å¿—åœ¨æ‰€æœ‰æœåŠ¡å™¨èŠ‚ç‚¹ä¸­å¿…é¡»ç›¸åŒï¼š</p>
<ul>
<li>ç½‘ç»œç›¸å…³æ ‡å¿—ï¼š --cluster-dnsï¼Œ -<code v-pre>--cluster-domain</code>ï¼Œ --cluster-cidrï¼Œ -<code v-pre>--service-cidr</code> <code v-pre>--cluster-dns``--cluster-cidr</code></li>
<li>æ§åˆ¶æŸäº›ç»„ä»¶éƒ¨ç½²çš„æ ‡å¿—ï¼š--disable-helm-controllerã€--<code v-pre>--disable-kube-proxy</code>ã€-<code v-pre>--disable-network-policy</code> ä»¥åŠä¼ é€’ç»™ -<code v-pre>--disable</code> çš„ä»»ä½•ç»„ä»¶ <code v-pre>--disable-helm-controller</code></li>
<li>åŠŸèƒ½ç›¸å…³æ ‡å¿—ï¼š-<code v-pre>--secrets-encryption</code></li>
</ul>
<div class="custom-container warning"><p class="custom-container-title">æ³¨æ„</p>
<p>ç¡®ä¿ä¿ç•™æ­¤ä»¤ç‰Œçš„å‰¯æœ¬ï¼Œå› ä¸ºä»å¤‡ä»½è¿˜åŸå’Œæ·»åŠ èŠ‚ç‚¹æ—¶éœ€è¦è¯¥å‰¯æœ¬ã€‚ä»¥å‰ï¼ŒK3s åœ¨ä½¿ç”¨å¤–éƒ¨ SQL æ•°æ®å­˜å‚¨æ—¶ä¸ä¼šå¼ºåˆ¶ä½¿ç”¨ä»¤ç‰Œã€‚</p>
</div>
<h2 id="åµŒå…¥å¼db-ha" tabindex="-1"><a class="header-anchor" href="#åµŒå…¥å¼db-ha" aria-hidden="true">#</a> åµŒå…¥å¼DB HA</h2>
<p>è¦åœ¨è¿™ç§æ¨¡å¼ä¸‹è¿è¡Œ K3sï¼Œä½ å¿…é¡»æœ‰å¥‡æ•°çš„æœåŠ¡å™¨èŠ‚ç‚¹ã€‚æˆ‘ä»¬å»ºè®®ä»ä¸‰ä¸ªèŠ‚ç‚¹å¼€å§‹ã€‚</p>
<p>è¦å¼€å§‹è¿è¡Œï¼Œé¦–å…ˆå¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ï¼Œä½¿ç”¨ cluster-init æ ‡å¿—æ¥å¯ç”¨é›†ç¾¤ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªæ ‡è®°ä½œä¸ºå…±äº«çš„å¯†é’¥æ¥åŠ å…¥å…¶ä»–æœåŠ¡å™¨åˆ°é›†ç¾¤ä¸­ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>SECRET k3s server --cluster-init
<span class="token comment"># æˆ–ï¼š</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>SECRET <span class="token function">sh</span> <span class="token parameter variable">-s</span> - --cluster-init
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯åŠ¨ç¬¬ä¸€å°æœåŠ¡å™¨åï¼Œä½¿ç”¨å…±äº«å¯†é’¥å°†ç¬¬äºŒå°å’Œç¬¬ä¸‰å°æœåŠ¡å™¨åŠ å…¥é›†ç¾¤ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>SECRET k3s server <span class="token parameter variable">--server</span> https://<span class="token operator">&lt;</span>ip or <span class="token function">hostname</span> of server<span class="token operator"><span class="token file-descriptor important">1</span>></span>:6443
<span class="token comment"># æˆ–:</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>SECRET <span class="token function">sh</span> <span class="token parameter variable">-s</span> - <span class="token parameter variable">--server</span> https://<span class="token operator">&lt;</span>ip or <span class="token function">hostname</span> of server<span class="token operator"><span class="token file-descriptor important">1</span>></span>:6443
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŸ¥è¯¢ ETCD é›†ç¾¤çŠ¶æ€ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token assign-left variable">ETCDCTL_ENDPOINTS</span><span class="token operator">=</span><span class="token string">'https://172.31.12.136:2379,https://172.31.4.43:2379,https://172.31.4.190:2379'</span> 
<span class="token assign-left variable">ETCDCTL_CACERT</span><span class="token operator">=</span><span class="token string">'/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt'</span> 
<span class="token assign-left variable">ETCDCTL_CERT</span><span class="token operator">=</span><span class="token string">'/var/lib/rancher/k3s/server/tls/etcd/server-client.crt'</span> 
<span class="token assign-left variable">ETCDCTL_KEY</span><span class="token operator">=</span><span class="token string">'/var/lib/rancher/k3s/server/tls/etcd/server-client.key'</span> 
<span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl endpoint status --write-out<span class="token operator">=</span>table
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container danger"><p class="custom-container-title">è­¦å‘Š</p>
<p>etcd è¯ä¹¦é»˜è®¤ç›®å½•ï¼š<code v-pre>/var/lib/rancher/k3s/server/tls/etcd</code>
etcd æ•°æ®é»˜è®¤ç›®å½•ï¼š<code v-pre>/var/lib/rancher/k3s/server/db/etcd</code></p>
</div>
<h2 id="é›†ç¾¤æ•°æ®å­˜å‚¨é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤æ•°æ®å­˜å‚¨é€‰é¡¹" aria-hidden="true">#</a> é›†ç¾¤æ•°æ®å­˜å‚¨é€‰é¡¹</h2>
<div class="custom-container tip"><p class="custom-container-title">å®˜æ–¹ä»‹ç»ï¼š</p>
<p>ä½¿ç”¨ etcd ä»¥å¤–çš„æ•°æ®å­˜å‚¨è¿è¡Œ Kubernetes çš„èƒ½åŠ›ä½¿ K3s åŒºåˆ«äºå…¶ä»– Kubernetes å‘è¡Œç‰ˆã€‚è¯¥åŠŸèƒ½ä¸º Kubernetes æ“ä½œè€…æä¾›äº†çµæ´»æ€§ã€‚å¯ç”¨çš„æ•°æ®å­˜å‚¨é€‰é¡¹å…è®¸æ‚¨é€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆæ‚¨ç”¨ä¾‹çš„æ•°æ®å­˜å‚¨ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>å¦‚æœä½ çš„å›¢é˜Ÿæ²¡æœ‰æ“ä½œ etcd çš„ä¸“ä¸šçŸ¥è¯†ï¼Œå¯ä»¥é€‰æ‹© MySQL æˆ– PostgreSQL ç­‰ä¼ä¸šçº§ SQL æ•°æ®åº“ã€‚</li>
<li>å¦‚æœæ‚¨éœ€è¦åœ¨ CI/CD ç¯å¢ƒä¸­è¿è¡Œä¸€ä¸ªç®€å•çš„ã€çŸ­æš‚çš„é›†ç¾¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åµŒå…¥å¼ SQLite æ•°æ®åº“ã€‚</li>
<li>å¦‚æœä½ å¸Œæœ›åœ¨è¾¹ç¼˜éƒ¨ç½² Kubernetesï¼Œå¹¶éœ€è¦ä¸€ä¸ªé«˜å¯ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œä½†åˆæ— æ³•æ‰¿æ‹…åœ¨è¾¹ç¼˜ç®¡ç†æ•°æ®åº“çš„æ“ä½œå¼€é”€ï¼Œä½ å¯ä»¥ä½¿ç”¨ K3s å»ºç«‹åœ¨åµŒå…¥å¼ etcd ä¹‹ä¸Šçš„åµŒå…¥å¼ HA æ•°æ®å­˜å‚¨ã€‚</li>
</ul>
</div>
<h3 id="é…ç½®å‚æ•°" tabindex="-1"><a class="header-anchor" href="#é…ç½®å‚æ•°" aria-hidden="true">#</a> é…ç½®å‚æ•°</h3>
<p>ä½¿ç”¨å¤–éƒ¨æ•°æ®å­˜å‚¨ï¼Œå¦‚ PostgreSQLã€MySQL æˆ– etcdï¼Œä½ å¿…é¡»è®¾ç½®<code v-pre>datastore-endpoint</code>å‚æ•°ï¼Œä»¥ä¾¿ K3s çŸ¥é“å¦‚ä½•è¿æ¥åˆ°å®ƒã€‚ä½ ä¹Ÿå¯ä»¥æŒ‡å®šå‚æ•°æ¥é…ç½®è¿æ¥çš„è®¤è¯å’ŒåŠ å¯†ã€‚ä¸‹è¡¨å‚æ•°ï¼Œå®ƒä»¬å¯ä»¥ä½œä¸º CLI æ ‡å¿—æˆ–ç¯å¢ƒå˜é‡ä¼ é€’ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">CLI Flag</th>
<th style="text-align:left">ç¯å¢ƒå˜é‡</th>
<th style="text-align:left">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code v-pre>--datastore-endpoint</code></td>
<td style="text-align:left"><code v-pre>K3S_DATASTORE_ENDPOINT</code></td>
<td style="text-align:left">æŒ‡å®šä¸€ä¸ª PostgresSQLã€MySQL æˆ– etcd è¿æ¥å­—ç¬¦ä¸²ã€‚ç”¨äºæè¿°ä¸æ•°æ®å­˜å‚¨çš„è¿æ¥ã€‚è¿™ä¸ªå­—ç¬¦ä¸²çš„ç»“æ„æ˜¯ç‰¹å®šäºæ¯ä¸ªåç«¯çš„ï¼Œè¯¦æƒ…å¦‚ä¸‹ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code v-pre>--datastore-cafile</code></td>
<td style="text-align:left"><code v-pre>K3S_DATASTORE_CAFILE</code></td>
<td style="text-align:left">TLS è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰æ–‡ä»¶ï¼Œç”¨äºå¸®åŠ©ç¡®ä¿ä¸æ•°æ®å­˜å‚¨çš„é€šä¿¡å®‰å…¨ã€‚å¦‚æœä½ çš„æ•°æ®å­˜å‚¨é€šè¿‡ TLS æœåŠ¡è¯·æ±‚ï¼Œä½¿ç”¨ç”±è‡ªå®šä¹‰è¯ä¹¦é¢å‘æœºæ„ç­¾ç½²çš„è¯ä¹¦ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‚æ•°æŒ‡å®šè¯¥ CAï¼Œè¿™æ · K3s å®¢æˆ·ç«¯å°±å¯ä»¥æ­£ç¡®éªŒè¯è¯ä¹¦ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code v-pre>--datastore-certfile</code></td>
<td style="text-align:left"><code v-pre>K3S_DATASTORE_CERTFILE</code></td>
<td style="text-align:left">TLS è¯ä¹¦æ–‡ä»¶ï¼Œç”¨äºå¯¹æ•°æ®å­˜å‚¨è¿›è¡ŒåŸºäºå®¢æˆ·ç«¯è¯ä¹¦çš„éªŒè¯ã€‚è¦ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œä½ çš„æ•°æ®å­˜å‚¨å¿…é¡»è¢«é…ç½®ä¸ºæ”¯æŒåŸºäºå®¢æˆ·ç«¯è¯ä¹¦çš„è®¤è¯ã€‚å¦‚æœä½ æŒ‡å®šäº†è¿™ä¸ªå‚æ•°ï¼Œä½ è¿˜å¿…é¡»æŒ‡å®š<code v-pre>datastore-keyfile</code>å‚æ•°ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code v-pre>--datastore-keyfile</code></td>
<td style="text-align:left"><code v-pre>K3S_DATASTORE_KEYFILE</code></td>
<td style="text-align:left">TLS å¯†é’¥æ–‡ä»¶ï¼Œç”¨äºå¯¹æ•°æ®å­˜å‚¨è¿›è¡ŒåŸºäºå®¢æˆ·ç«¯è¯ä¹¦çš„è®¤è¯ã€‚æ›´å¤šç»†èŠ‚è¯·å‚è§å‰é¢çš„<code v-pre>datastore-certfile</code>å‚æ•°ã€‚</td>
</tr>
</tbody>
</table>
<p>ä½œä¸ºæœ€ä½³å®è·µï¼Œæˆ‘ä»¬å»ºè®®å°†è¿™äº›å‚æ•°è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œè€Œä¸æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™æ ·ä½ çš„æ•°æ®åº“è¯ä¹¦æˆ–å…¶ä»–æ•æ„Ÿä¿¡æ¯å°±ä¸ä¼šä½œä¸ºè¿›ç¨‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚</p>
<div class="custom-container warning"><p class="custom-container-title">å®˜æ–¹å»ºè®®</p>
<p>ä½œä¸ºæœ€ä½³å®è·µï¼Œæˆ‘ä»¬å»ºè®®å°†è¿™äº›å‚æ•°è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œè€Œä¸æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™æ ·ä½ çš„æ•°æ®åº“è¯ä¹¦æˆ–å…¶ä»–æ•æ„Ÿä¿¡æ¯å°±ä¸ä¼šä½œä¸º <strong>è¿›ç¨‹ä¿¡æ¯</strong> çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚</p>
</div>
<h2 id="ç§æœ‰ä»“åº“" tabindex="-1"><a class="header-anchor" href="#ç§æœ‰ä»“åº“" aria-hidden="true">#</a> ç§æœ‰ä»“åº“</h2>
<p>å¯ä»¥å°† Containerd é…ç½®ä¸ºè¿æ¥åˆ°ç§æœ‰æ³¨å†Œè¡¨ï¼Œå¹¶ä½¿ç”¨å®ƒä»¬åœ¨èŠ‚ç‚¹ä¸Šæ‹‰å–ç§æœ‰æ˜ åƒã€‚</p>
<p>K3s é»˜è®¤ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥åœ¨ docker ä¸Šé…ç½®é•œåƒä»“åº“æ˜¯ä¸ç”Ÿæ•ˆçš„</p>
<p>K3s registry é…ç½®ç›®å½•ä¸ºï¼š <code v-pre>/etc/rancher/k3s/registries.yaml</code>ã€‚K3s å¯åŠ¨æ—¶ï¼ŒK3s ä¼šæ£€æŸ¥ <code v-pre>/etc/rancher/k3s/</code> ä¸­æ˜¯å¦å­˜åœ¨ <code v-pre>registries.yaml</code> æ–‡ä»¶ï¼Œå¹¶æŒ‡ç¤º <code v-pre>containerd</code> ä½¿ç”¨æ–‡ä»¶ä¸­å®šä¹‰çš„é•œåƒä»“åº“ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨ä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ï¼Œé‚£ä¹ˆä½ éœ€è¦åœ¨æ¯ä¸ªä½¿ç”¨é•œåƒä»“åº“çš„èŠ‚ç‚¹ä¸Šä»¥ root èº«ä»½åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œserver èŠ‚ç‚¹é»˜è®¤æ˜¯å¯ä»¥è°ƒåº¦çš„ã€‚å¦‚æœä½ æ²¡æœ‰åœ¨ server èŠ‚ç‚¹ä¸Šè®¾ç½®æ±¡ç‚¹ï¼Œé‚£ä¹ˆå°†åœ¨å®ƒä»¬ä¸Šè¿è¡Œå·¥ä½œè´Ÿè½½ï¼Œè¯·ç¡®ä¿åœ¨æ¯ä¸ª server èŠ‚ç‚¹ä¸Šåˆ›å»º <code v-pre>registries.yaml</code> æ–‡ä»¶ã€‚</p>
<h3 id="registries-yaml-æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#registries-yaml-æ–‡ä»¶" aria-hidden="true">#</a> registries.yaml æ–‡ä»¶</h3>
<p><strong>ç»„æˆéƒ¨åˆ†ï¼š</strong></p>
<ol>
<li><code v-pre>mirrors</code>ï¼šå®šä¹‰ä¸“ç”¨æ³¨å†Œè¡¨çš„åç§°å’Œç«¯ç‚¹çš„æŒ‡ä»¤</li>
<li><code v-pre>configs</code>ï¼š<code v-pre>configs</code>éƒ¨åˆ†å®šä¹‰æ¯ä¸ªé•œåƒçš„ TLS å’Œå‡­æ®é…ç½®ã€‚å¯¹äºæ¯ä¸ªé•œåƒï¼Œæ‚¨å¯ä»¥å®šä¹‰<code v-pre>auth</code>å’Œ/æˆ– <code v-pre>tls</code>.</li>
</ol>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>containerd ä½¿ç”¨äº†ç±»ä¼¼ K8S ä¸­ svc ä¸ endpoint çš„æ¦‚å¿µï¼Œsvc å¯ä»¥ç†è§£ä¸º <strong>è®¿é—®åç§°</strong>ï¼Œè¿™ä¸ªåç§°ä¼šè§£æåˆ°å¯¹åº”çš„ endpoint ä¸Šã€‚ ä¹Ÿå¯ä»¥ç†è§£ mirror é…ç½®å°±æ˜¯ä¸€ä¸ªåå‘ä»£ç†ï¼Œå®ƒæŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚ä»£ç†åˆ° endpoint é…ç½®çš„åç«¯é•œåƒä»“åº“ã€‚mirror åç§°å¯ä»¥éšæ„å¡«å†™ï¼Œä½†æ˜¯å¿…é¡»ç¬¦åˆIPæˆ–åŸŸåçš„å®šä¹‰è§„åˆ™ã€‚å¹¶ä¸”å¯ä»¥é…ç½®å¤šä¸ª endpointï¼Œé»˜è®¤è§£æåˆ°ç¬¬ä¸€ä¸ª endpointï¼Œå¦‚æœç¬¬ä¸€ä¸ª endpoint æ²¡æœ‰è¿”å›æ•°æ®ï¼Œåˆ™è‡ªåŠ¨åˆ‡æ¢åˆ°ç¬¬äºŒä¸ª endpointï¼Œä»¥æ­¤ç±»æ¨ã€‚<code v-pre>INSTALL_K3S_MIRROR=cn</code></p>
<p><strong>ğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š</strong></p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code><span class="token key atrule">mirrors</span><span class="token punctuation">:</span>
  <span class="token key atrule">"172.31.6.200:5000"</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"http://172.31.6.200:5000"</span>
      <span class="token punctuation">-</span> <span class="token string">"http://x.x.x.x:5000"</span>
      <span class="token punctuation">-</span> <span class="token string">"http://y.y.y.y:5000"</span>
  <span class="token key atrule">"rancher.ksd.top:5000"</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"http://172.31.6.200:5000"</span>
  <span class="token key atrule">"docker.io"</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"https://fogjl973.mirror.aliyuncs.com"</span>
      <span class="token punctuation">-</span> <span class="token string">"https://registry-1.docker.io"</span>

<span class="token key atrule">configs</span><span class="token punctuation">:</span>
  <span class="token key atrule">"172.31.6.200:5000"</span><span class="token punctuation">:</span>
    <span class="token key atrule">auth</span><span class="token punctuation">:</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
      <span class="token key atrule">password</span><span class="token punctuation">:</span> Harbor@12345
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">cert_file</span><span class="token punctuation">:</span> /home/ubuntu/harbor2.kingsd.top.cert
      <span class="token key atrule">key_file</span><span class="token punctuation">:</span>  /home/ubuntu/harbor2.kingsd.top.key
      <span class="token key atrule">ca_file</span><span class="token punctuation">:</span>   /home/ubuntu/ca.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥é€šè¿‡ <code v-pre>crictl pull 172.31.6.200:5000/library/alpine</code> å’Œ <code v-pre>crictl pull rancher.ksd.top:5000/library/alpine</code> è·å–åˆ°é•œåƒï¼Œä½†é•œåƒéƒ½æ˜¯ä»åŒä¸€ä¸ªä»“åº“è·å–åˆ°çš„ã€‚</p>
</div>
<h4 id="mirrors" tabindex="-1"><a class="header-anchor" href="#mirrors" aria-hidden="true">#</a> mirrors</h4>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code><span class="token key atrule">mirrors</span><span class="token punctuation">:</span>
  <span class="token key atrule">mycustomreg.com</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"https://mycustomreg.com:5000"</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Rewrites:</strong></p>
<p>æ¯ä¸ªé•œåƒéƒ½å¯ä»¥æœ‰ä¸€ç»„ <code v-pre>Rewrites</code>ã€‚<code v-pre>Rewrites</code> å¯ä»¥æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼æ›´æ”¹å›¾åƒçš„æ ‡ç­¾ã€‚å¦‚æœé•œåƒæ³¨å†Œè¡¨ä¸­çš„ç»„ç»‡/é¡¹ç›®ç»“æ„ä¸ä¸Šæ¸¸ç»“æ„ä¸åŒï¼Œè¿™å°†éå¸¸æœ‰ç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹é…ç½®å°†ä»¥é€æ˜æ–¹å¼ä» <code v-pre>registry.example.com:5000/mirrorproject/rancher-images/coredns-coredns:1.6.3</code> æ‹‰å–æ˜ åƒ <code v-pre>docker.io/rancher/coredns-coredns:1.6.3</code>:</p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code><span class="token key atrule">mirrors</span><span class="token punctuation">:</span>
  <span class="token key atrule">docker.io</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"https://registry.example.com:5000"</span>
    <span class="token key atrule">rewrite</span><span class="token punctuation">:</span>
      <span class="token key atrule">"^rancher/(.*)"</span><span class="token punctuation">:</span> <span class="token string">"mirrorproject/rancher-images/$1"</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>æ˜ åƒä»å°†å­˜å‚¨åœ¨åŸå§‹åç§°ä¸‹ï¼Œä»¥ä¾¿ <code v-pre>crictl image ls</code> å°†æ˜¾ç¤ºèŠ‚ç‚¹ä¸Šå¯ç”¨çš„ <code v-pre>docker.io/rancher/coredns-coredns:1.6.3</code>ï¼Œå³ä½¿æ˜ åƒæ˜¯ä»å…·æœ‰ä¸åŒåç§°çš„é•œåƒæ³¨å†Œè¡¨ä¸­æå–çš„ã€‚</p>
</blockquote>
<h4 id="configs" tabindex="-1"><a class="header-anchor" href="#configs" aria-hidden="true">#</a> configs</h4>
<p><code v-pre>configs</code>éƒ¨åˆ†å®šä¹‰æ¯ä¸ªé•œåƒçš„ TLS å’Œå‡­æ®é…ç½®ã€‚å¯¹äºæ¯ä¸ªé•œåƒï¼Œæ‚¨å¯ä»¥å®šä¹‰<code v-pre>auth</code>å’Œ/æˆ– <code v-pre>tls</code>.</p>
<p><code v-pre>tls</code> éƒ¨åˆ†åŒ…æ‹¬ï¼š</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>cert_file</code></td>
<td>å°†ç”¨äºå‘æ³¨å†Œè¡¨è¿›è¡Œèº«ä»½éªŒè¯çš„å®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„</td>
</tr>
<tr>
<td><code v-pre>key_file</code></td>
<td>å°†ç”¨äºå‘æ³¨å†Œè¡¨è¿›è¡Œèº«ä»½éªŒè¯çš„å®¢æˆ·ç«¯å¯†é’¥è·¯å¾„</td>
</tr>
<tr>
<td><code v-pre>ca_file</code></td>
<td>å®šä¹‰ç”¨äºéªŒè¯æ³¨å†Œè¡¨çš„æœåŠ¡å™¨è¯ä¹¦æ–‡ä»¶çš„ CA è¯ä¹¦è·¯å¾„</td>
</tr>
<tr>
<td><code v-pre>insecure_skip_verify</code></td>
<td>å®šä¹‰æ˜¯å¦åº”è·³è¿‡æ³¨å†Œè¡¨çš„ TLS éªŒè¯çš„å¸ƒå°”å€¼</td>
</tr>
</tbody>
</table>
<p>èº«ä»½éªŒè¯éƒ¨åˆ†ç”±ç”¨æˆ·å/å¯†ç æˆ–<code v-pre>auth</code>ä»¤ç‰Œç»„æˆï¼š</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>username</code></td>
<td>ä¸“ç”¨æ³¨å†Œè¡¨åŸºæœ¬èº«ä»½éªŒè¯çš„ç”¨æˆ·å</td>
</tr>
<tr>
<td><code v-pre>password</code></td>
<td>ä¸“ç”¨æ³¨å†Œè¡¨åŸºæœ¬èº«ä»½éªŒè¯çš„ç”¨æˆ·å¯†ç </td>
</tr>
<tr>
<td><code v-pre>auth</code></td>
<td>ä¸“ç”¨æ³¨å†Œè¡¨åŸºæœ¬èº«ä»½éªŒè¯çš„èº«ä»½éªŒè¯ä»¤ç‰Œ</td>
</tr>
</tbody>
</table>
<h4 id="ä½¿ç”¨-tls" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-tls" aria-hidden="true">#</a> ä½¿ç”¨ TLS</h4>
<p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†ä½¿ç”¨ TLS æ—¶å¦‚ä½•åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé…ç½® /<code v-pre>/etc/rancher/k3s/registries.yaml</code>ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">>></span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
  "harbor.kingsd.top":
    endpoint:
      - "https://harbor.kingsd.top"
configs:
  "harbor.kingsd.top":
    auth:
      username: admin
      password: Harbor@12345
EOF</span>
systemctl restart k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è‡ªç­¾åè¯ä¹¦:</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">>></span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
  "harbor2.kingsd.top":
    endpoint:
      - "https://harbor2.kingsd.top"
configs:
  "harbor2.kingsd.top":
    auth:
      username: admin
      password: Harbor@12345
    tls:
      cert_file: /home/ubuntu/harbor2.kingsd.top.cert
      key_file:  /home/ubuntu/harbor2.kingsd.top.key
      ca_file:   /home/ubuntu/ca.crt
EOF</span>
systemctl restart k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸ä½¿ç”¨ TLS (Http registry):</strong></p>
<blockquote>
<p>åœ¨æ²¡æœ‰ TLS é€šä¿¡çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ä¸º endpoints æŒ‡å®šhttp://ï¼Œå¦åˆ™å°†é»˜è®¤ä¸º https</p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">>></span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
  "172.31.19.227:5000":
    endpoint:
      - "http://172.31.19.227:5000"
EOF</span>
systemctl restart k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¸¦èº«ä»½éªŒè¯çš„å’Œä¸å¸¦èº«ä»½éªŒè¯çš„ï¼ˆauth)</strong></p>
<CodeGroup>
<CodeGroupItem title="å¸¦èº«ä»½éªŒè¯">
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code><span class="token key atrule">mirrors</span><span class="token punctuation">:</span>
  <span class="token key atrule">docker.io</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"https://mycustomreg.com:5000"</span>
<span class="token key atrule">configs</span><span class="token punctuation">:</span>
  <span class="token key atrule">"mycustomreg:5000"</span><span class="token punctuation">:</span>
    <span class="token key atrule">auth</span><span class="token punctuation">:</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> xxxxxx <span class="token comment"># this is the registry username</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> xxxxxx <span class="token comment"># this is the registry password</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">cert_file</span><span class="token punctuation">:</span> <span class="token comment"># path to the cert file used in the registry</span>
      <span class="token key atrule">key_file</span><span class="token punctuation">:</span>  <span class="token comment"># path to the key file used in the registry</span>
      <span class="token key atrule">ca_file</span><span class="token punctuation">:</span>   <span class="token comment"># path to the ca file used in the registry</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></CodeGroupItem>
<CodeGroupItem title="ä¸å¸¦èº«ä»½éªŒè¯">
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code><span class="token key atrule">mirrors</span><span class="token punctuation">:</span>
  <span class="token key atrule">docker.io</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"https://mycustomreg.com:5000"</span>
<span class="token key atrule">configs</span><span class="token punctuation">:</span>
  <span class="token key atrule">"mycustomreg:5000"</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">cert_file</span><span class="token punctuation">:</span> <span class="token comment"># path to the cert file used in the registry</span>
      <span class="token key atrule">key_file</span><span class="token punctuation">:</span>  <span class="token comment"># path to the key file used in the registry</span>
      <span class="token key atrule">ca_file</span><span class="token punctuation">:</span>   <span class="token comment"># path to the ca file used in the registry</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></CodeGroupItem>
<blockquote>
<p>åœ¨æ²¡æœ‰ TLS é€šä¿¡çš„æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦ä¸ºç«¯ç‚¹æŒ‡å®š <code v-pre>http://</code>ï¼Œå¦åˆ™å®ƒå°†é»˜è®¤ä¸º httpsã€‚</p>
</blockquote>
<p>ä¸ºäº†ä½¿æ³¨å†Œè¡¨æ›´æ”¹ç”Ÿæ•ˆï¼Œæ‚¨éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé‡æ–°å¯åŠ¨ K3ã€‚</p>
</CodeGroup>
<p><strong>é…ç½® Mirror:</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">>></span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
  "docker.io":
    endpoint:
      - "https://fogjl973.mirror.aliyuncs.com"
      - "https://registry-1.docker.io"
EOF</span>
systemctl restart k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="custom-container details"><summary>å®Œæ•´ç¤ºä¾‹</summary>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code><span class="token key atrule">mirrors</span><span class="token punctuation">:</span>
  <span class="token key atrule">"harbor.kingsd.top"</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"https://harbor.kingsd.top"</span>
  <span class="token key atrule">"harbor2.kingsd.top"</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"https://harbor2.kingsd.top"</span>
  <span class="token key atrule">"172.31.19.227:5000"</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"http://172.31.19.227:5000"</span>
  <span class="token key atrule">"docker.io"</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"https://fogjl973.mirror.aliyuncs.com"</span>
      <span class="token punctuation">-</span> <span class="token string">"https://registry-1.docker.io"</span>

<span class="token key atrule">configs</span><span class="token punctuation">:</span>
  <span class="token key atrule">"harbor.kingsd.top"</span><span class="token punctuation">:</span>
    <span class="token key atrule">auth</span><span class="token punctuation">:</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
      <span class="token key atrule">password</span><span class="token punctuation">:</span> Harbor@12345

  <span class="token key atrule">"harbor2.kingsd.top"</span><span class="token punctuation">:</span>
    <span class="token key atrule">auth</span><span class="token punctuation">:</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
      <span class="token key atrule">password</span><span class="token punctuation">:</span> Harbor@12345
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">cert_file</span><span class="token punctuation">:</span> /home/ubuntu/harbor2.kingsd.top.cert
      <span class="token key atrule">key_file</span><span class="token punctuation">:</span>  /home/ubuntu/harbor2.kingsd.top.key
      <span class="token key atrule">ca_file</span><span class="token punctuation">:</span>   /home/ubuntu/ca.crt

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details>
<h3 id="é…ç½®-containerd" tabindex="-1"><a class="header-anchor" href="#é…ç½®-containerd" aria-hidden="true">#</a> é…ç½® Containerd</h3>
<p>K3s å°†ä¼šåœ¨<code v-pre>/var/lib/rancher/k3s/agent/etc/containerd/config.toml</code>ä¸­ä¸º containerd ç”Ÿæˆ <code v-pre>config.toml</code>ã€‚</p>
<p>å¦‚æœè¦å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œé«˜çº§è®¾ç½®ï¼Œä½ å¯ä»¥åœ¨åŒä¸€ç›®å½•ä¸­åˆ›å»ºå¦ä¸€ä¸ªåä¸º <code v-pre>config.toml.tmpl</code> çš„æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶å°†ä¼šä»£æ›¿é»˜è®¤è®¾ç½®ã€‚</p>
<p><code v-pre>config.toml.tmpl</code>å°†è¢«è§†ä¸º Go æ¨¡æ¿æ–‡ä»¶ï¼Œå¹¶ä¸”<code v-pre>config.Node</code>ç»“æ„è¢«ä¼ é€’ç»™æ¨¡æ¿ã€‚æˆªå–ä¸‹é¢æ¨¡æ¿ç¤ºä¾‹ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ç»“æ„æ¥è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> templates

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/rancher/wharfie/pkg/registries"</span>

	<span class="token string">"github.com/k3s-io/k3s/pkg/daemons/config"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> ContainerdRuntimeConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	RuntimeType <span class="token builtin">string</span>
	BinaryName  <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ContainerdConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	NodeConfig            <span class="token operator">*</span>config<span class="token punctuation">.</span>Node
	DisableCgroup         <span class="token builtin">bool</span>
	SystemdCgroup         <span class="token builtin">bool</span>
	IsRunningInUserNS     <span class="token builtin">bool</span>
	EnableUnprivileged    <span class="token builtin">bool</span>
	PrivateRegistryConfig <span class="token operator">*</span>registries<span class="token punctuation">.</span>Registry
	ExtraRuntimes         <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>ContainerdRuntimeConfig
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å°†æ˜ åƒæ·»åŠ åˆ°ä¸“ç”¨æ³¨å†Œè¡¨" tabindex="-1"><a class="header-anchor" href="#å°†æ˜ åƒæ·»åŠ åˆ°ä¸“ç”¨æ³¨å†Œè¡¨" aria-hidden="true">#</a> å°†æ˜ åƒæ·»åŠ åˆ°ä¸“ç”¨æ³¨å†Œè¡¨</h3>
<p>é¦–å…ˆï¼Œä» GitHub è·å–æ‚¨æ­£åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬.txt k3s-images æ–‡ä»¶ã€‚ä» docker.io ä¸­æå– k3s æ˜ åƒ.txt æ–‡ä»¶ä¸­åˆ—å‡ºçš„ K3s æ˜ åƒ</p>
<p>ç¤ºä¾‹ï¼š<code v-pre>docker pull docker.io/rancher/coredns-coredns:1.6.3</code></p>
<p>ç„¶åï¼Œå°†æ˜ åƒé‡æ–°æ ‡è®°åˆ°ä¸“ç”¨æ³¨å†Œè¡¨ã€‚</p>
<p>ç¤ºä¾‹ï¼šdocker tag coredns-corednsï¼š<code v-pre>docker tag coredns-coredns:1.6.3 mycustomreg:5000/coredns-coredns</code></p>
<p>æœ€åï¼Œå°†æ˜ åƒæ¨é€åˆ°ä¸“ç”¨æ³¨å†Œè¡¨ã€‚</p>
<p>ç¤ºä¾‹ï¼š<code v-pre>docker push mycustomreg.com:5000/coredns-coredns</code></p>
<h2 id="ç¦»çº¿å®‰è£…" tabindex="-1"><a class="header-anchor" href="#ç¦»çº¿å®‰è£…" aria-hidden="true">#</a> ç¦»çº¿å®‰è£…</h2>
<p>ç¦»çº¿å®‰è£…çš„è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<p><strong>æ­¥éª¤ 1</strong>ï¼šéƒ¨ç½²é•œåƒï¼Œæœ¬æ–‡æä¾›äº†ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯<strong>éƒ¨ç½²ç§æœ‰é•œåƒä»“åº“</strong>å’Œ<strong>æ‰‹åŠ¨éƒ¨ç½²é•œåƒ</strong>ã€‚è¯·åœ¨è¿™ä¸¤ç§æ–¹å¼ä¸­é€‰æ‹©ä¸€ç§æ‰§è¡Œã€‚</p>
<p><strong>æ­¥éª¤ 2</strong>ï¼šå®‰è£… K3sï¼Œæœ¬æ–‡æä¾›äº†ä¸¤ç§å®‰è£…æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯<strong>å•èŠ‚ç‚¹å®‰è£…</strong>å’Œ<strong>é«˜å¯ç”¨å®‰è£…</strong>ã€‚å®Œæˆé•œåƒéƒ¨ç½²åï¼Œè¯·åœ¨è¿™ä¸¤ç§æ–¹å¼ä¸­é€‰æ‹©ä¸€ç§æ‰§è¡Œã€‚</p>
<p><strong>ç¦»çº¿å‡çº§ K3s ç‰ˆæœ¬</strong>ï¼šå®Œæˆç¦»çº¿å®‰è£… K3s åï¼Œæ‚¨è¿˜å¯ä»¥é€šè¿‡è„šæœ¬å‡çº§ K3s ç‰ˆæœ¬ï¼Œæˆ–å¯ç”¨è‡ªåŠ¨å‡çº§åŠŸèƒ½ï¼Œä»¥ä¿æŒç¦»çº¿ç¯å¢ƒä¸­çš„ K3s ç‰ˆæœ¬ä¸æœ€æ–°çš„ K3s ç‰ˆæœ¬åŒæ­¥ã€‚</p>
<h3 id="é€šè¿‡ç§æœ‰é•œåƒä»“åº“å®‰è£…-k3s" tabindex="-1"><a class="header-anchor" href="#é€šè¿‡ç§æœ‰é•œåƒä»“åº“å®‰è£…-k3s" aria-hidden="true">#</a> é€šè¿‡ç§æœ‰é•œåƒä»“åº“å®‰è£… K3s</h3>
<p><strong>å°†æ‰€éœ€é•œåƒä¸Šä¼ åˆ°ç§æœ‰é•œåƒä»“åº“ï¼š</strong></p>
<p>K3s é•œåƒåˆ—è¡¨å¯ä»¥ä» https://github.com/k3s-io/k3s/releases è·å–ã€‚</p>
<p><strong>åˆ›å»ºé•œåƒä»“åº“ YAMLï¼š</strong></p>
<p>æŒ‰ç…§<a href="http://docs.rancher.cn/docs/k3s/installation/private-registry/_index/" target="_blank" rel="noopener noreferrer">ç§æœ‰é•œåƒä»“åº“é…ç½®æŒ‡å—<ExternalLinkIcon/></a> åˆ›å»ºå¹¶é…ç½®<code v-pre>registry.yaml</code>æ–‡ä»¶ã€‚</p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code>mkdir <span class="token punctuation">-</span>p /etc/rancher/k3s/
cat <span class="token punctuation">></span><span class="token punctuation">></span> /etc/rancher/k3s/registries.yaml &lt;&lt;EOF
<span class="token key atrule">mirrors</span><span class="token punctuation">:</span>
  <span class="token key atrule">"docker.io"</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"https://harbor.kingsd.top"</span>
<span class="token key atrule">configs</span><span class="token punctuation">:</span>
  <span class="token key atrule">"docker.io"</span><span class="token punctuation">:</span>
    <span class="token key atrule">auth</span><span class="token punctuation">:</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
      <span class="token key atrule">password</span><span class="token punctuation">:</span> Harbor@12345
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®‰è£…å•èŠ‚ç‚¹ K3sï¼š</strong></p>
<ol>
<li>
<p>ä»<a href="https://github.com/rancher/k3s/releases" target="_blank" rel="noopener noreferrer">K3s GitHub Release<ExternalLinkIcon/></a>é¡µé¢è·å– K3s äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒK3s äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦ä¸ç¦»çº¿é•œåƒçš„ç‰ˆæœ¬åŒ¹é…ã€‚</p>
</li>
<li>
<p>è·å– K3s å®‰è£…è„šæœ¬ï¼šhttps://get.k3s.ioã€‚</p>
</li>
<li>
<p>å°†äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„<code v-pre>/usr/local/bin</code>ä¸­ï¼Œå¹¶ç¡®ä¿æ‹¥æœ‰å¯æ‰§è¡Œæƒé™ã€‚å°†å®‰è£…è„šæœ¬æ”¾åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„ä»»æ„ä½ç½®ï¼Œå¹¶å°†å…¶å‘½åä¸º<code v-pre>install.sh</code>ã€‚</p>
</li>
<li>
<p>å®‰è£… K3s serverï¼š</p>
</li>
</ol>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>INSTALL_K3S_SKIP_DOWNLOAD=true ./install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="5">
<li>å°† agent åŠ å…¥åˆ° K3s é›†ç¾¤</li>
</ol>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>INSTALL_K3S_SKIP_DOWNLOAD=true K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken ./install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>é€šè¿‡æ‰‹åŠ¨éƒ¨ç½²é•œåƒå®‰è£… K3sï¼š</strong></p>
<p>è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å‡†å¤‡é•œåƒå’Œ K3s äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<ol>
<li>
<p>ä»<a href="https://github.com/rancher/k3s/releases" target="_blank" rel="noopener noreferrer">K3s GitHub Release<ExternalLinkIcon/></a>é¡µé¢è·å–ä½ æ‰€è¿è¡Œçš„ K3s ç‰ˆæœ¬çš„é•œåƒ tar æ–‡ä»¶ã€‚</p>
</li>
<li>
<p>å°† tar æ–‡ä»¶æ”¾åœ¨<code v-pre>images</code>ç›®å½•ä¸‹ï¼Œä¾‹å¦‚ï¼š</p>
</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/rancher/k3s/agent/images/
<span class="token function">sudo</span> <span class="token function">cp</span> ./k3s-airgap-images-<span class="token variable">$ARCH</span>.tar /var/lib/rancher/k3s/agent/images/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3">
<li>
<p>å°† k3s äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨ <code v-pre>/usr/local/bin/k3s</code>è·¯å¾„ä¸Šï¼Œå¹¶ç¡®ä¿æ‹¥æœ‰å¯æ‰§è¡Œæƒé™ã€‚</p>
</li>
<li>
<p>å®‰è£… K3s serverï¼š</p>
</li>
</ol>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>INSTALL_K3S_SKIP_DOWNLOAD=true ./install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="5">
<li>å°† agent åŠ å…¥åˆ° K3s é›†ç¾¤</li>
</ol>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>INSTALL_K3S_SKIP_DOWNLOAD=true K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken ./install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æŒ‡å®š<code v-pre>INSTALL_K3S_SKIP_DOWNLOAD=true</code>å‚æ•°æŒ‡å®šä½¿ç”¨æœ¬åœ° K3s äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token assign-left variable">INSTALL_K3S_SKIP_DOWNLOAD</span><span class="token operator">=</span>true <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">'server --datastore-endpoint=mysql://username:password@tcp(hostname:3306)/database-name'</span> ./install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="å‡çº§-k3s" tabindex="-1"><a class="header-anchor" href="#å‡çº§-k3s" aria-hidden="true">#</a> å‡çº§ K3s</h2>
<h3 id="é€šè¿‡è„šæœ¬å‡çº§" tabindex="-1"><a class="header-anchor" href="#é€šè¿‡è„šæœ¬å‡çº§" aria-hidden="true">#</a> é€šè¿‡è„šæœ¬å‡çº§</h3>
<p>ç¦»çº¿ç¯å¢ƒçš„å‡çº§å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®Œæˆï¼š</p>
<ol>
<li>ä»<a href="https://github.com/rancher/k3s/releases" target="_blank" rel="noopener noreferrer">K3s GitHub Release<ExternalLinkIcon/></a>é¡µé¢ä¸‹è½½è¦å‡çº§åˆ°çš„ K3s ç‰ˆæœ¬ã€‚å°† tar æ–‡ä»¶æ”¾åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„<code v-pre>/var/lib/rancher/k3s/agent/images/</code>ç›®å½•ä¸‹ã€‚åˆ é™¤æ—§çš„ tar æ–‡ä»¶ã€‚</li>
<li>å¤åˆ¶å¹¶æ›¿æ¢æ¯ä¸ªèŠ‚ç‚¹ä¸Š<code v-pre>/usr/local/bin</code>ä¸­çš„æ—§ K3s äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¤åˆ¶https://get.k3s.io çš„å®‰è£…è„šæœ¬ï¼ˆå› ä¸ºå®ƒå¯èƒ½åœ¨ä¸Šæ¬¡å‘å¸ƒåå‘ç”Ÿäº†å˜åŒ–ï¼‰ã€‚å†æ¬¡è¿è¡Œè„šæœ¬ã€‚</li>
<li>é‡å¯ K3s æœåŠ¡ã€‚</li>
</ol>
<h3 id="åœ¨çº¿è„šæœ¬å‡çº§" tabindex="-1"><a class="header-anchor" href="#åœ¨çº¿è„šæœ¬å‡çº§" aria-hidden="true">#</a> åœ¨çº¿è„šæœ¬å‡çº§</h3>
<div class="custom-container warning"><p class="custom-container-title">åœ¨çº¿è„šæœ¬å‡çº§</p>
<p>å½“å‡çº§ K3s æ—¶ï¼ŒK3s æœåŠ¡ä¼šé‡å¯æˆ–åœæ­¢ï¼Œä½† K3s å®¹å™¨ä¼šç»§ç»­è¿è¡Œã€‚ è¦åœæ­¢æ‰€æœ‰çš„ K3s å®¹å™¨å¹¶é‡ç½®å®¹å™¨çš„çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨ <code v-pre>k3s-killall.sh</code> è„šæœ¬ã€‚ killall è„šæœ¬æ¸…ç†å®¹å™¨ã€K3s ç›®å½•å’Œç½‘ç»œç»„ä»¶ï¼ŒåŒæ—¶ä¹Ÿåˆ é™¤äº† iptables é“¾å’Œæ‰€æœ‰ç›¸å…³è§„åˆ™ã€‚é›†ç¾¤æ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚</p>
<p>ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§ K3sï¼Œæˆ–è€…æ‰‹åŠ¨å®‰è£…æ‰€éœ€ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼š å‡çº§æ—¶ï¼Œå…ˆé€ä¸ªå‡çº§ server èŠ‚ç‚¹ï¼Œç„¶åå†å‡çº§å…¶ä»– agent èŠ‚ç‚¹ã€‚</p>
</blockquote>
</div>
<h3 id="channels-è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#channels-è¯´æ˜" aria-hidden="true">#</a> Channels è¯´æ˜</h3>
<p>é€šè¿‡å®‰è£…è„šæœ¬æˆ–ä½¿ç”¨æˆ‘ä»¬çš„<a href="http://docs.rancher.cn/docs/k3s/upgrades/basic/_index" target="_blank" rel="noopener noreferrer">è‡ªåŠ¨å‡çº§<ExternalLinkIcon/></a>åŠŸèƒ½è¿›è¡Œçš„å‡çº§å¯ä»¥ç»‘å®šåˆ°ä¸åŒçš„å‘å¸ƒ channelsã€‚ä»¥ä¸‹æ˜¯å¯ç”¨çš„ channelsã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">CHANNEL</th>
<th style="text-align:left">æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">stable</td>
<td style="text-align:left">(é»˜è®¤)ç¨³å®šç‰ˆå»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚è¿™äº›ç‰ˆæœ¬å·²ç»è¿‡ä¸€æ®µæ—¶é—´çš„ç¤¾åŒºå¼ºåŒ–ã€‚</td>
</tr>
<tr>
<td style="text-align:left">latest</td>
<td style="text-align:left">æ¨èä½¿ç”¨æœ€æ–°ç‰ˆæœ¬å°è¯•æœ€æ–°çš„åŠŸèƒ½ã€‚ è¿™äº›ç‰ˆæœ¬è¿˜æ²¡æœ‰ç»è¿‡ç¤¾åŒºå¼ºåŒ–ã€‚</td>
</tr>
<tr>
<td style="text-align:left">v1.19 (ä¾‹å­)</td>
<td style="text-align:left">æ¯ä¸€ä¸ªæ”¯æŒçš„ Kubernetes æ¬¡è¦ç‰ˆæœ¬éƒ½æœ‰ä¸€ä¸ªå‘å¸ƒ channelï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯<code v-pre>v1.19</code>ã€<code v-pre>v1.20</code>å’Œ<code v-pre>v1.21</code>ã€‚ã€‚è¿™äº› channel ä¼šé€‰æ‹©æœ€æ–°çš„å¯ç”¨è¡¥ä¸ç‰ˆæœ¬ï¼Œä¸ä¸€å®šæ˜¯ç¨³å®šç‰ˆæœ¬ã€‚</td>
</tr>
</tbody>
</table>
<p>å¯¹äºè¯¦ç»†çš„æœ€æ–° channels åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥è®¿é—®<a href="https://update.k3s.io/v1-release/channels" target="_blank" rel="noopener noreferrer">k3s channel æœåŠ¡ API<ExternalLinkIcon/></a>ã€‚å…³äº channels å·¥ä½œçš„æ›´å¤šæŠ€æœ¯ç»†èŠ‚ï¼Œè¯·å‚è§<a href="https://github.com/rancher/channelserver" target="_blank" rel="noopener noreferrer">channelserver é¡¹ç›®<ExternalLinkIcon/></a>ã€‚</p>
<h3 id="ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§-k3s" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§-k3s" aria-hidden="true">#</a> ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§ K3s</h3>
<p>è¦ä»æ—§ç‰ˆæœ¬å‡çº§ K3sï¼Œä½ å¯ä»¥ä½¿ç”¨ <strong>ç›¸åŒçš„æ ‡å¿—</strong> é‡æ–°è¿è¡Œå®‰è£…è„šæœ¬:</p>
<ul>
<li>å‡çº§åˆ°æœ€æ–° <code v-pre>stable</code> ç‰ˆæœ¬</li>
</ul>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>curl -sfL https://get.k3s.io | sh -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul>
<li>å‡çº§åˆ° <code v-pre>latest</code> ç‰ˆæœ¬</li>
</ul>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=latest sh -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul>
<li>å‡çº§åˆ° <code v-pre>v1.20</code> çš„æœ€æ–°ç‰ˆæœ¬</li>
</ul>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL="v1.20" sh -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul>
<li>å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬</li>
</ul>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=vX.Y.Z-rc1 sh -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ‰‹åŠ¨å‡çº§-k3s" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ‰‹åŠ¨å‡çº§-k3s" aria-hidden="true">#</a> ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ‰‹åŠ¨å‡çº§ K3s</h4>
<ol>
<li>ä»<a href="https://github.com/rancher/k3s/releases" target="_blank" rel="noopener noreferrer">å‘å¸ƒ<ExternalLinkIcon/></a>ä¸‹è½½æ‰€éœ€ç‰ˆæœ¬çš„ K3s äºŒè¿›åˆ¶æ–‡ä»¶</li>
<li>å°†ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°<code v-pre>/usr/local/bin/k3s</code>ï¼ˆæˆ–æ‚¨æ‰€éœ€çš„ä½ç½®ï¼‰</li>
<li>åœæ­¢æ—§çš„ K3s äºŒè¿›åˆ¶æ–‡ä»¶</li>
<li>å¯åŠ¨æ–°çš„ K3s äºŒè¿›åˆ¶æ–‡ä»¶</li>
</ol>
<h3 id="è‡ªåŠ¨å‡çº§" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨å‡çº§" aria-hidden="true">#</a> è‡ªåŠ¨å‡çº§</h3>
<blockquote>
<p>æ³¨æ„ï¼š æ­¤åŠŸèƒ½ä» v1.17.4+k3s1 å¼€å§‹æä¾›æ”¯æŒã€‚</p>
</blockquote>
<p>ä½ å¯ä»¥ä½¿ç”¨ Rancher çš„ system-upgrad-controller æ¥ç®¡ç† K3s é›†ç¾¤å‡çº§ã€‚è¿™æ˜¯ä¸€ç§ Kubernetes åŸç”Ÿçš„é›†ç¾¤å‡çº§æ–¹æ³•ã€‚å®ƒåˆ©ç”¨<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-resources" target="_blank" rel="noopener noreferrer">è‡ªå®šä¹‰èµ„æºå®šä¹‰(CRD)<ExternalLinkIcon/></a>ã€<code v-pre>è®¡åˆ’</code>å’Œ<a href="https://kubernetes.io/docs/concepts/architecture/controller/" target="_blank" rel="noopener noreferrer">æ§åˆ¶å™¨<ExternalLinkIcon/></a>ï¼Œæ ¹æ®é…ç½®çš„è®¡åˆ’å®‰æ’å‡çº§ã€‚</p>
<p>æ§åˆ¶å™¨é€šè¿‡ç›‘æ§è®¡åˆ’å’Œé€‰æ‹©è¦åœ¨å…¶ä¸Šè¿è¡Œå‡çº§<a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/" target="_blank" rel="noopener noreferrer"> job<ExternalLinkIcon/></a> çš„èŠ‚ç‚¹æ¥è°ƒåº¦å‡çº§ã€‚è®¡åˆ’é€šè¿‡<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/" target="_blank" rel="noopener noreferrer">æ ‡ç­¾é€‰æ‹©å™¨<ExternalLinkIcon/></a>å®šä¹‰å“ªäº›èŠ‚ç‚¹åº”è¯¥å‡çº§ã€‚å½“ä¸€ä¸ª job æˆåŠŸè¿è¡Œå®Œæˆåï¼Œæ§åˆ¶å™¨ä¼šç»™å®ƒè¿è¡Œçš„èŠ‚ç‚¹æ‰“ä¸Šç›¸åº”çš„æ ‡ç­¾ã€‚</p>
<p>å…³äº system-upgrade-controller çš„è®¾è®¡å’Œæ¶æ„æˆ–å…¶ä¸ K3s é›†æˆçš„æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§ä»¥ä¸‹ Git ä»“åº“ï¼š</p>
<ul>
<li><a href="https://github.com/rancher/system-upgrade-controller" target="_blank" rel="noopener noreferrer">system-upgrade-controller<ExternalLinkIcon/></a></li>
<li><a href="https://github.com/rancher/k3s-upgrade" target="_blank" rel="noopener noreferrer">k3s-upgrade<ExternalLinkIcon/></a></li>
</ul>
<p>è¦ä»¥è¿™ç§æ–¹å¼è¿›è¡Œè‡ªåŠ¨å‡çº§ï¼Œä½ å¿…é¡»ï¼š</p>
<ol>
<li>å°† system-upgrade-controller å®‰è£…åˆ°æ‚¨çš„é›†ç¾¤ä¸­</li>
<li>é…ç½®è®¡åˆ’</li>
</ol>
<h4 id="å®‰è£…-system-upgrade-controller" tabindex="-1"><a class="header-anchor" href="#å®‰è£…-system-upgrade-controller" aria-hidden="true">#</a> å®‰è£… system-upgrade-controller</h4>
<p>System-upgrade-controller å¯ä»¥ä½œä¸º deployment å®‰è£…åˆ°æ‚¨çš„é›†ç¾¤ä¸­ã€‚Deployment éœ€è¦ä¸€ä¸ª service-accountã€clusterRoleBinding å’Œä¸€ä¸ª configmapã€‚è¦å®‰è£…è¿™äº›ç»„ä»¶ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>kubectl apply -f https://github.com/rancher/system-upgrade-controller/releases/download/v0.6.2/system-upgrade-controller.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="é…ç½®è®¡åˆ’" tabindex="-1"><a class="header-anchor" href="#é…ç½®è®¡åˆ’" aria-hidden="true">#</a> é…ç½®è®¡åˆ’</h4>
<p>å»ºè®®æ‚¨æœ€å°‘åˆ›å»ºä¸¤ä¸ªè®¡åˆ’ï¼šå‡çº§ serverï¼ˆmasterï¼‰èŠ‚ç‚¹çš„è®¡åˆ’å’Œå‡çº§ agentï¼ˆworkerï¼‰èŠ‚ç‚¹çš„è®¡åˆ’ã€‚æ ¹æ®éœ€è¦ï¼Œæ‚¨å¯ä»¥åˆ›å»ºå…¶ä»–è®¡åˆ’æ¥æ§åˆ¶è·¨èŠ‚ç‚¹çš„æ»šåŠ¨å‡çº§ã€‚ä»¥ä¸‹ä¸¤ä¸ªç¤ºä¾‹è®¡åˆ’å°†æŠŠæ‚¨çš„é›†ç¾¤å‡çº§åˆ° K3s v1.20.4+k3s1ã€‚åˆ›å»ºè®¡åˆ’åï¼Œæ§åˆ¶å™¨å°†æ¥æ”¶è¿™äº›è®¡åˆ’å¹¶å¼€å§‹å‡çº§æ‚¨çš„é›†ç¾¤ã€‚</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code># Server plan
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: server-plan
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
    - key: node-role.kubernetes.io/master
      operator: In
      values:
      - "true"
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  version: v1.20.4+k3s1

---
# Agent plan
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: agent-plan
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
    - key: node-role.kubernetes.io/master
      operator: DoesNotExist
  prepare:
    args:
    - prepare
    - server-plan
    image: rancher/k3s-upgrade
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  version: v1.20.4+k3s1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äºè¿™äº›è®¡åˆ’ï¼Œæœ‰å‡ ä¸ªé‡è¦çš„äº‹æƒ…éœ€è¦æé†’ï¼š</p>
<p>é¦–å…ˆï¼Œå¿…é¡»åœ¨éƒ¨ç½²æ§åˆ¶å™¨çš„åŒä¸€å‘½åç©ºé—´ä¸­åˆ›å»ºè®¡åˆ’ã€‚</p>
<p>å…¶æ¬¡ï¼Œ<code v-pre>concurrency</code>å­—æ®µè¡¨ç¤ºå¯ä»¥åŒæ—¶å‡çº§å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>ç¬¬ä¸‰ï¼Œ<code v-pre>server-plan</code>é€šè¿‡æŒ‡å®šä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨æ¥é€‰æ‹©å¸¦æœ‰<code v-pre>node-role.kubernetes.io/master</code>æ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œä»è€Œé”å®š server èŠ‚ç‚¹ã€‚<code v-pre>agent-plan</code>é€šè¿‡æŒ‡å®šä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨æ¥é€‰æ‹©æ²¡æœ‰è¯¥æ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œä»¥ agent èŠ‚ç‚¹ä¸ºç›®æ ‡ã€‚</p>
<p>ç¬¬å››ï¼Œ<code v-pre>agent-plan</code>ä¸­çš„ <code v-pre>prepare</code> æ­¥éª¤ä¼šä½¿è¯¥è®¡åˆ’ç­‰å¾…<code v-pre>server-plan</code>å®Œæˆåå†æ‰§è¡Œå‡çº§ jobsã€‚</p>
<p>ç¬¬äº”ï¼Œä¸¤ä¸ªè®¡åˆ’çš„<code v-pre>version</code>å­—æ®µéƒ½è®¾ç½®ä¸º v1.17.4+k3s1ã€‚æˆ–è€…ï¼Œä½ å¯ä»¥çœç•¥ <code v-pre>version</code> å­—æ®µï¼Œå°† <code v-pre>channel</code> å­—æ®µè®¾ç½®ä¸ºè§£æåˆ° K3s ç‰ˆæœ¬çš„ URLã€‚è¿™å°†å¯¼è‡´æ§åˆ¶å™¨ç›‘æ§è¯¥ URLï¼Œå¹¶åœ¨å®ƒè§£æåˆ°æ–°ç‰ˆæœ¬æ—¶éšæ—¶å‡çº§é›†ç¾¤ã€‚è¿™ä¸ <a href="/docs/k3s/upgrades/basic/_index#%E5%8F%91%E5%B8%83-channels">release channels</a> é…åˆå¾—å¾ˆå¥½ã€‚å› æ­¤ï¼Œä½ å¯ä»¥ç”¨ä¸‹é¢çš„ channel é…ç½®ä½ çš„è®¡åˆ’ï¼Œä»¥ç¡®ä¿ä½ çš„é›†ç¾¤æ€»æ˜¯è‡ªåŠ¨å‡çº§åˆ° K3s çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬ã€‚</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>apiVersion: upgrade.cattle.io/v1
kind: Plan
...
spec:
  ...
  channel: https://update.k3s.io/v1-release/channels/stable

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚ä¸Šæ‰€è¿°ï¼Œä¸€æ—¦æ§åˆ¶å™¨æ£€æµ‹åˆ°è®¡åˆ’å·²åˆ›å»ºï¼Œå‡çº§å°±ä¼šç«‹å³å¼€å§‹ã€‚æ›´æ–°è®¡åˆ’å°†ä½¿æ§åˆ¶å™¨é‡æ–°è¯„ä¼°è®¡åˆ’å¹¶ç¡®å®šæ˜¯å¦éœ€è¦å†æ¬¡å‡çº§ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡ kubectl æŸ¥çœ‹ plans å’Œ jobs æ¥ç›‘æ§å‡çº§çš„è¿›åº¦ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>kubectl -n system-upgrade get plans -o yaml
kubectl -n system-upgrade get jobs -o yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="è¿æ¥åˆ°-k3s-kubernets-é›†ç¾¤çš„ä¸‰ç§æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#è¿æ¥åˆ°-k3s-kubernets-é›†ç¾¤çš„ä¸‰ç§æ–¹å¼" aria-hidden="true">#</a> è¿æ¥åˆ° k3s kubernets é›†ç¾¤çš„ä¸‰ç§æ–¹å¼</h2>
<div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>åŒæ—¶ä¹Ÿæ˜¯å¯¹ <a href="https://docker.nsddd.top/Cloud-Native-k8s/23.html" target="_blank" rel="noopener noreferrer">23 èŠ‚<ExternalLinkIcon/></a>ï¼Œ<a href="https://docker.nsddd.top/Cloud-Native-k8s/23.html" target="_blank" rel="noopener noreferrer">Kubeconfig &amp;&amp; token<ExternalLinkIcon/></a> çš„è¡¥å……</p>
<ul>
<li><a href="https://headworq.org/en/how-to-connect-to-kubernetes/#" target="_blank" rel="noopener noreferrer">å‚è€ƒhttps://headworq.org/en/how-to-connect-to-kubernetes/#<ExternalLinkIcon/></a></li>
</ul>
</div>
<h3 id="kubeconfig" tabindex="-1"><a class="header-anchor" href="#kubeconfig" aria-hidden="true">#</a> kubeconfig</h3>
<p>åœ¨ K3s å®‰è£…è¿‡ç¨‹ä¸­ï¼Œ<strong>kubeconfig</strong> æ–‡ä»¶è¢«å†™å…¥ <code v-pre>/etc/rancher/k3s/k3s.yaml</code>ã€‚æ‚¨å°†éœ€è¦æ­¤æ–‡ä»¶æ‰èƒ½ä½¿ç”¨é¦–é€‰çš„ Kubernetes å®¢æˆ·ç«¯è¿æ¥åˆ°æ‚¨çš„é›†ç¾¤ã€‚ä½ çš„ kubeconfig ä¼šå–œæ¬¢è¿™æ ·ï¼š</p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">clusters</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">certificate-authority-data</span><span class="token punctuation">:</span> LS0<span class="token punctuation">...</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">6443</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default
<span class="token key atrule">contexts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default
    <span class="token key atrule">user</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default
<span class="token key atrule">current-context</span><span class="token punctuation">:</span> default
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Config
<span class="token key atrule">preferences</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token key atrule">users</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> default
  <span class="token key atrule">user</span><span class="token punctuation">:</span>
    <span class="token key atrule">client-certificate-data</span><span class="token punctuation">:</span> LS<span class="token punctuation">...</span>
    <span class="token key atrule">client-key-data</span><span class="token punctuation">:</span> LS<span class="token punctuation">...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container danger"><p class="custom-container-title">æ³¨æ„</p>
<p>å¦‚æœè¦ä»å…¶ä»–ä¸»æœºè¿›è¡Œè¿æ¥ï¼Œåˆ™å¿…é¡»æ›´æ”¹æœåŠ¡å™¨ç«¯ç‚¹å¹¶è¾“å…¥å¯è®¿é—®ç¾¤é›†çš„ä¸»æœºå/IP åœ°å€ã€‚å¦‚æœç¾¤é›†èŠ‚ç‚¹ä¸Šçš„é˜²ç«å¢™å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œåˆ™å¯èƒ½å¿…é¡»å…ˆæ‰“å¼€ç«¯å£ 6443/tcpï¼ˆ<a href="https://headworq.org/en-how-to-install-k3s-kubernets-on-ubuntu/" target="_blank" rel="noopener noreferrer">è¯·å‚é˜…æ­¤å¤„<ExternalLinkIcon/></a>ï¼‰).</p>
</div>
<p><strong>å‡ºäºå¥½å¥‡ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥k3s-agentå•å…ƒæ–‡ä»¶å¦‚ä½•ä½¿ç”¨ç¯å¢ƒæ–‡ä»¶ ( <code v-pre>/etc/systemd/system/k3s-agent.service.env</code> ) æ¥å­˜å‚¨å˜é‡å˜é‡K3S_URLå’ŒK3S_TOKENï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubnode02:/workspces/runtime<span class="token comment"># cat /etc/systemd/system/k3s-agent.service</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Lightweight Kubernetes
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://k3s.io
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>-/etc/default/%N
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>-/etc/sysconfig/%N
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>-/etc/systemd/system/k3s-agent.service.env
<span class="token assign-left variable">KillMode</span><span class="token operator">=</span>process
<span class="token assign-left variable">Delegate</span><span class="token operator">=</span>yes
<span class="token comment"># Having non-zero Limit*s causes performance problems due to accounting overhead</span>
<span class="token comment"># in the kernel. We recommend using cgroups to do container-local accounting.</span>
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">1048576</span>
<span class="token assign-left variable">LimitNPROC</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">LimitCORE</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">TasksMax</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">TimeoutStartSec</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>5s
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/bin/sh <span class="token parameter variable">-xc</span> <span class="token string">'! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.service'</span>
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe br_netfilter
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>-/sbin/modprobe overlay
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/k3s <span class="token punctuation">\</span>
    agent <span class="token punctuation">\</span>
	<span class="token string">'--server'</span> <span class="token punctuation">\</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">æç¤º</p>
<p>å¦‚æœä¸ä¾èµ–systemctlæœåŠ¡è¿›è¡Œç®¡ç†ï¼Œåªèƒ½nohupè‡ªå·±æï¼Œè¦ä¹ˆå†™ç¨‹åºçš„æ—¶å€™åšä¸€ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹deamonå®ˆæŠ¤ï¼Œä¸€ç›´è®©å®ƒæŒç»­è·‘ã€‚
ExecStartå‡ ä¸ªæ®µï¼Œå’Œä½ å¹³æ—¶æ‰§è¡Œçš„ä¸€å¥è¯å‘½ä»¤æ˜¯ä¸€æ ·çš„
åªä¸è¿‡å†™æˆäº†é…ç½®æ–‡ä»¶ï¼Œäº¤ç»™systemctlç®¡ç†æ•´ä¸€ä¸ªæœåŠ¡
environmentFileç›¸å½“äºä½ æ¯æ¬¡æ‰§è¡Œçš„æ‰‹å·¥ç¯å¢ƒå˜é‡å…¨æ•´å¥½äº†</p>
<p><code v-pre>nohup  å‘½ä»¤   &amp;</code></p>
</div>
<p><strong>k3s-agent.service.env</strong> çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>root@cubnode02:/workspces/runtime<span class="token comment"># cat /etc/systemd/system/k3s-agent.service.env</span>
<span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span><span class="token string">'SECRET'</span>
<span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span><span class="token string">'https://192.168.71.130:6443'</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¦æ‰‹åŠ¨å¯åŠ¨<code v-pre>k3s</code> ä»£ç†ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡çš„é€‰é¡¹<code v-pre>--server</code>å’Œ<code v-pre>--token inetad</code>ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>k3s agent <span class="token parameter variable">--server</span> https://192.168.71.130:6443 <span class="token parameter variable">--token</span> <span class="token string">"K10b625ace11027708856a6369064ef7cbd8e695a65457c9815e5f7ec2c3eca0635::server:SECRET"</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="kubectl" tabindex="-1"><a class="header-anchor" href="#kubectl" aria-hidden="true">#</a> kubectl</h3>
<p>è¿æ¥åˆ° Kubernetes é›†ç¾¤çš„æœ€å¸¸è§æ–¹æ³•æ˜¯ <code v-pre>'kubectl'</code> å‘½ä»¤ã€‚è¯¥å‘½ä»¤åœ¨ K3s å®‰è£…æœŸé—´è‡ªåŠ¨å®‰è£…åœ¨ç¾¤é›†èŠ‚ç‚¹ä¸Šã€‚</p>
<p>è¦è¿æ¥åˆ°é›†ç¾¤ï¼Œä½ å¿…é¡»è®© <code v-pre>kubectl</code> çŸ¥é“åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ° <code v-pre>kubeconfig</code>ã€‚æ‚¨å¯ä»¥é€šè¿‡ <strong>å°† kubeconfig æ–‡ä»¶æŒ‡å®šä¸ºé€‰é¡¹ã€è®¾ç½®ç¯å¢ƒå˜é‡æˆ–å°†å…¶å¤åˆ¶åˆ° <code v-pre>~/.kube/config</code></strong> æ¥åšåˆ°è¿™ä¸€ç‚¹â€”â€”ä»»ä½•æ›´é€‚åˆæ‚¨çš„æ–¹æ³•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># æŒ‡å®škubeconfigæ–‡ä»¶ä½œä¸ºé€‰é¡¹ï¼Œ</span>
kubectl <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/rancher/k3s/k3s.yaml  get nodes
<span class="token comment"># &lt;output></span>

<span class="token comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/rancher/k3s/k3s.yaml
kubectl get nodes
<span class="token comment"># &lt;output></span>

<span class="token comment"># copying it to '~/.kube/config' </span>
<span class="token function">cp</span> /etc/rancher/k3s/k3s.yaml ~/.kube/config
kubectl get nodes
<span class="token comment"># &lt;output></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰äº† kubeconfigï¼Œä½ å¯ä»¥å°è¯•ä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># kubectl get nodes</span>
NAME          STATUS   ROLES                       AGE   VERSION
cubmaster01   Ready    control-plane,etcd,master   15m   v1.25.4+k3s1
<span class="token comment"># kubectl get pods --all-namespaces</span>
NAMESPACE     NAME                                      READY   STATUS      RESTARTS   AGE
kube-system   coredns-597584b69b-rb9bh                  <span class="token number">1</span>/1     Running     <span class="token number">0</span>          15m
kube-system   helm-install-traefik-crd-9h7rn            <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          15m
kube-system   helm-install-traefik-fn7n7                <span class="token number">0</span>/1     Completed   <span class="token number">1</span>          15m
kube-system   local-path-provisioner-79f67d76f8-v5nxz   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          15m
kube-system   metrics-server-5c8978b444-xbdbk           <span class="token number">1</span>/1     Running     <span class="token number">0</span>          15m
kube-system   svclb-traefik-f1a0eea9-ch5hp              <span class="token number">2</span>/2     Running     <span class="token number">0</span>          14m
kube-system   traefik-bb69b68cd-wzt8q                   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          14m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="lens-kubernetes-ide" tabindex="-1"><a class="header-anchor" href="#lens-kubernetes-ide" aria-hidden="true">#</a> Lens Kubernetes IDE</h3>
<p>å¦‚æœæ‚¨æ›´å–œæ¬¢å›¾å½¢ç•Œé¢æ¥ç®¡ç†æ‚¨çš„é›†ç¾¤ï¼Œæ‚¨ç»å¯¹åº”è¯¥æŸ¥çœ‹ <a href="https://k8slens.dev/" target="_blank" rel="noopener noreferrer">Lens<ExternalLinkIcon/></a>ã€‚å®ƒç¡®å®å¯ä»¥æ›´è½»æ¾åœ°ç®¡ç†å·¥ä½œè´Ÿè½½ï¼Œé…ç½®æ˜ å°„ï¼Œæœºå¯†ï¼ŒæœåŠ¡ï¼Œå…¥å£ï¼Œå¹¶ä¸ºæ‚¨æä¾›æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…çš„æ¦‚è¿°ã€‚æœ€å¥½çš„äº‹æƒ…æ˜¯ï¼Œå®ƒæ˜¯å®Œå…¨å…è´¹å’Œå¼€æºçš„ã€‚</p>
<blockquote>
<p>â€œLens ä¸º Kubernetes ä¸­è¿è¡Œçš„æ‰€æœ‰å†…å®¹æä¾›äº†å®Œæ•´çš„æ€åŠ¿æ„ŸçŸ¥ã€‚å®ƒé™ä½äº†åˆšèµ·æ­¥çš„äººçš„è¿›å…¥é—¨æ§›ï¼Œå¹¶ä»æ ¹æœ¬ä¸Šæé«˜äº†æ‹¥æœ‰æ›´å¤šç»éªŒçš„äººçš„ç”Ÿäº§åŠ›ã€‚</p>
<p>https://github.com/lensapp/lens/</p>
</blockquote>
<p><a href="https://kubenav.io/" target="_blank" rel="noopener noreferrer">Kubenav<ExternalLinkIcon/></a> ä¹Ÿæ˜¯ä¸€ä¸ªå›¾å½¢åŒ–çš„ Kubernetes å·¥å…·ã€‚Kubenav æœ€å¥½çš„ä¸€ç‚¹æ˜¯å®ƒå¯ç”¨äºç§»åŠ¨ Android å’Œ iOS è®¾å¤‡ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨æ—…é€”ä¸­ç®¡ç†æ‚¨çš„ Kubernetes é›†ç¾¤;)ã€‚Kubenav ä¹Ÿæ˜¯å¼€æºçš„ï¼Œå¯åœ¨ iOS App Store å’Œ Play Store ä¸Šä½¿ç”¨ã€‚æ‚¨ä¹Ÿå¯ä»¥ä» <a href="https://github.com/kubenav/kubenav/" target="_blank" rel="noopener noreferrer">Github å­˜å‚¨åº“<ExternalLinkIcon/></a>ä¸‹è½½æ¡Œé¢ç‰ˆæœ¬.</p>
<p>å®‰è£…åå¯¼èˆªåˆ°â€œç¾¤é›†â€ï¼Œç„¶åæŒ‰åŠ å·æ·»åŠ ç¾¤é›†ã€‚å‘ä¸‹æ»šåŠ¨åˆ°â€œå¯¼å…¥ Kubeconfigâ€ï¼Œå°†å†…å®¹ç²˜è´´åˆ°æ–‡æœ¬å­—æ®µä¸­ï¼Œç„¶åæŒ‰â€œæ·»åŠ â€ã€‚</p>
<p><img src="http://sm.nsddd.top/smimage-20221127124516263.png" alt="image-20221127124516263"></p>
<p>æ³¨æ„ï¼šKubernetes API ç«¯å£ ï¼ˆTCP/6443ï¼‰ å¿…é¡»å¯ç”¨äºæ‚¨çš„æ‰‹æœºã€‚å¦‚æœæ‚¨ä¸æƒ³æ‰“å¼€è¯¥ç«¯å£åˆ°äº’è”ç½‘ï¼Œæ‚¨å¯ä»¥é€šè¿‡VPNè¿æ¥åˆ°é›†ç¾¤ã€‚è¯·å‚é˜…æˆ‘åœ¨ <a href="https://headworq.org/en-how-to-install-wiregurad-on-ubuntu/" target="_blank" rel="noopener noreferrer">Ubuntu ä¸Šè®¾ç½® Wireguard çš„æŒ‡å—<ExternalLinkIcon/></a>.</p>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '14.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '16.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


