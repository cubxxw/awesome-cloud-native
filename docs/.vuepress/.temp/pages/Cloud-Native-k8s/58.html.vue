<template><div><ul>
<li><a href="http://nsddd.top" target="_blank" rel="noopener noreferrer">author<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬58èŠ‚-kubernetes-ç½‘ç»œ" tabindex="-1"><a class="header-anchor" href="#ç¬¬58èŠ‚-kubernetes-ç½‘ç»œ" aria-hidden="true">#</a> ç¬¬58èŠ‚ Kubernetes ç½‘ç»œ</h1>
<div><a href = '57.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '59.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<p>[TOC]</p>
<h2 id="kubernetes-ç½‘ç»œåŸºç¡€" tabindex="-1"><a class="header-anchor" href="#kubernetes-ç½‘ç»œåŸºç¡€" aria-hidden="true">#</a> Kubernetes ç½‘ç»œåŸºç¡€</h2>
<p>ç½‘ç»œå¾ˆéš¾ï¼ŒKubernetes çš„ç½‘ç»œæ›´éš¾ï¼Œåé¢æ›´æ˜¯æœ‰å¤æ‚çš„ç½‘ç»œåˆ†æ²»ï¼Œè¦ç†è§£å®ç°ï¼Œå¿…é¡»å¯¹Kubernetesçš„ç½‘ç»œæœ‰ç€æ·±å…¥çš„äº†è§£ã€‚</p>
<div class="custom-container danger"><p class="custom-container-title">è­¦å‘Š</p>
<p>Kubernetes å¾€æ·±å¤„æŒ–å¿…é¡»è¦æ‰“å¥½ç½‘ç»œçš„åŸºç¡€ï¼Œè¿™ä¸ªå¾ˆé‡è¦ ~</p>
<p>ä»ä½¿ç”¨äº¤æ¢æœºã€è·¯ç”±å™¨å’Œä»¥å¤ªç½‘ç”µç¼†çš„ç‰©ç†ç½‘ç»œè¿ç§»åˆ°ä½¿ç”¨è½¯ä»¶å®šä¹‰ç½‘ç»œï¼ˆSDNï¼‰å’Œè™šæ‹Ÿæ¥å£çš„è™šæ‹Ÿç½‘ç»œéœ€è¦ä¸€æ®µæ—¶é—´ã€‚å½“ç„¶ï¼ŒåŸåˆ™æ˜¯ç›¸åŒçš„ï¼Œä½†æœ‰ä¸åŒçš„è§„èŒƒå’Œæœ€ä½³å®è·µã€‚Kubernetesæœ‰è‡ªå·±çš„ä¸€å¥—è§„åˆ™ï¼Œå¦‚æœæ‚¨è¦å¤„ç†å®¹å™¨å’Œäº‘ï¼Œäº†è§£Kubernetesç½‘ç»œçš„å·¥ä½œåŸç†ä¼šæœ‰æ‰€å¸®åŠ©ã€‚</p>
<p>&quot;ç½‘ç»œæ ˆ&quot; åŒ…æ‹¬äº†ç½‘å¡ï¼ˆnetwork interface)ã€å›ç¯è®¾å¤‡ï¼ˆloopback deviceï¼‰ã€è·¯ç”±è¡¨ï¼ˆrouting tableï¼‰ å’Œ iptables çš„è§„åˆ™ï¼Œè¿™äº›æ˜¯æ„æˆäº†ç½‘ç»œçš„å‘èµ·å’Œå“åº”çš„åŸºæœ¬è¦ç´ ã€‚</p>
<blockquote>
<p>ç½‘å¡å·¥ä½œåœ¨ OSI æ¨¡å‹çš„ç¬¬äºŒå±‚ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼‰å’Œç¬¬ä¸€å±‚ï¼ˆç‰©ç†å±‚ï¼‰ï¼Œè´Ÿè´£å¤„ç†ç‰©ç†ç½‘ç»œçš„æ•°æ®æµã€‚ç½‘å¡é€šå¸¸ç”±ç½‘å¡é©±åŠ¨ç¨‹åºæ§åˆ¶ï¼Œç½‘å¡é©±åŠ¨ç¨‹åºæ˜¯è¿è¡Œåœ¨å†…æ ¸æ€çš„ç¨‹åºã€‚ç”¨æˆ·æ€çš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡å¥—æ¥å­—ï¼ˆsocketï¼‰æ¥å£ä¸å†…æ ¸ç©ºé—´çš„ç½‘ç»œåè®®æ ˆè¿›è¡Œé€šä¿¡ï¼Œä»è€Œé€šè¿‡ç½‘å¡å‘é€å’Œæ¥æ”¶ç½‘ç»œæ•°æ®åŒ…ã€‚åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·æ€çš„åº”ç”¨ç¨‹åºé€šè¿‡å¥—æ¥å­—æ¥å£å‘å†…æ ¸ç©ºé—´å‘é€ç½‘ç»œæ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡è¯¥æ¥å£æ¥æ”¶æ¥è‡ªå†…æ ¸ç©ºé—´çš„ç½‘ç»œæ•°æ®åŒ…ã€‚</p>
</blockquote>
</div>
<p><strong>è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å°†æ”¶é›† ä»¥ä¸‹ èµ„æ–™è¿›è¡Œæ•´ç†ã€è¯´æ˜ ğŸ’¡ï¼š</strong></p>
<ul>
<li>ã€Šæ·±å…¥å‰–æKubernetesã€‹ï¼šKubernetes ç½‘ç»œåŸç†</li>
<li>åˆ˜è¶…è€å¸ˆçš„ ã€Šè¶£è°ˆ<em>ç½‘ç»œ</em>åè®®ã€‹</li>
<li>https://opensource.com/article/22/6/kubernetes-networking-fundamentals</li>
<li>https://kubernetes.io/docs/concepts/cluster-administration/networking/</li>
<li>https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-1-f9bc0909e051</li>
</ul>
<p><strong>è¿™ç¯‡æ–‡ç« ï¼Œæœ€ç»ˆä¼šå½’çº³åˆ° docs: <a href="https://docker.nsddd.top" target="_blank" rel="noopener noreferrer">https://docker.nsddd.top<ExternalLinkIcon/></a></strong> Kubernetes / CloudNative</p>
<p>Kubernetesç½‘ç»œæ¨¡å‹æœ‰å‡ æ¡ä¸€èˆ¬è§„åˆ™éœ€è¦ç‰¢è®°ï¼š</p>
<ol>
<li><strong>æ¯ä¸ªPodéƒ½æœ‰è‡ªå·±çš„IPåœ°å€</strong>ï¼šä¸éœ€è¦åœ¨Podä¹‹é—´åˆ›å»ºé“¾æ¥ï¼Œä¹Ÿä¸éœ€è¦å°†å®¹å™¨ç«¯å£æ˜ å°„åˆ°ä¸»æœºç«¯å£ã€‚</li>
<li><strong>ä¸éœ€è¦NAT</strong>ï¼šèŠ‚ç‚¹ä¸Šçš„Podåº”èƒ½å¤Ÿä¸æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰Podé€šä¿¡ï¼Œè€Œæ— éœ€NATã€‚</li>
<li><strong>Agents è·å¾—æ‰€æœ‰è®¿é—®æƒé™</strong>ï¼šnode ä¸Šçš„ agentï¼ˆsystem daemonsã€Kubeletï¼‰å¯ä»¥ä¸è¯¥èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰Podé€šä¿¡ã€‚</li>
<li><strong>å…±äº«å‘½åç©ºé—´</strong>ï¼šPodä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œåç§°ç©ºé—´ï¼ˆIPå’ŒMACåœ°å€ï¼‰ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥ä½¿ç”¨ç¯å›åœ°å€ç›¸äº’é€šä¿¡ã€‚</li>
</ol>
<h3 id="kubernetes-ä¸­ç½‘ç»œçš„è§£å†³æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#kubernetes-ä¸­ç½‘ç»œçš„è§£å†³æ–¹æ¡ˆ" aria-hidden="true">#</a> Kubernetes ä¸­ç½‘ç»œçš„è§£å†³æ–¹æ¡ˆ</h3>
<p>Kubernetesç½‘ç»œè®¾è®¡ç”¨äºç¡®ä¿Kubernetesä¸­çš„ä¸åŒå®ä½“ç±»å‹å¯ä»¥é€šä¿¡ã€‚KubernetesåŸºç¡€è®¾æ–½çš„å¸ƒå±€åœ¨è®¾è®¡ä¸Šæœ‰å¾ˆå¤§çš„åˆ†ç¦»åº¦ã€‚åç§°ç©ºé—´ã€å®¹å™¨å’ŒPodæ—¨åœ¨ä¿æŒç»„ä»¶ä¹‹é—´çš„åŒºåˆ«ï¼Œå› æ­¤é«˜åº¦ç»“æ„åŒ–çš„é€šä¿¡è®¡åˆ’éå¸¸é‡è¦ã€‚</p>
<p><img src="http://sm.nsddd.top/sm202303101350246.png" alt="image-20230310135053049" title="Kubernetesç½‘ç»œæ–¹æ¡ˆå›¾"></p>
<p><strong>ç½‘ç»œæ˜¯Kubernetesçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä½†è¦å‡†ç¡®äº†è§£å®ƒçš„å·¥ä½œæ–¹å¼å¯èƒ½ä¼šå¾ˆæœ‰æŒ‘æˆ˜æ€§ã€‚æœ‰4ä¸ªä¸åŒçš„ç½‘ç»œé—®é¢˜éœ€è¦è§£å†³ï¼š</strong></p>
<ul>
<li>é«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">Pod<ExternalLinkIcon/></a> å’Œ <code v-pre>localhost</code> é€šä¿¡è§£å†³äº†ã€‚</li>
<li>Pod é—´é€šä¿¡ï¼šè¿™æ˜¯æœ¬æ–‡æ¡£è®²è¿°çš„é‡ç‚¹ã€‚</li>
<li>Pod ä¸ Service é—´é€šä¿¡ï¼šæ¶µç›–åœ¨ <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/" target="_blank" rel="noopener noreferrer">Service<ExternalLinkIcon/></a> ä¸­ã€‚</li>
<li>å¤–éƒ¨ä¸ Service é—´é€šä¿¡ï¼šä¹Ÿæ¶µç›–åœ¨ Service ä¸­ã€‚</li>
</ul>
<p>Kuberneteså®Œå…¨æ˜¯ä¸ºäº†åœ¨åº”ç”¨ç¨‹åºä¹‹é—´å…±äº«æœºå™¨ã€‚é€šå¸¸ï¼Œå…±äº«è®¡ç®—æœºéœ€è¦ç¡®ä¿ä¸¤ä¸ªåº”ç”¨ç¨‹åºä¸ä¼šå°è¯•ä½¿ç”¨ç›¸åŒçš„ç«¯å£ã€‚è·¨å¤šä¸ªå¼€å‘äººå‘˜åè°ƒç«¯å£éå¸¸éš¾ä»¥å¤§è§„æ¨¡è¿›è¡Œï¼Œå¹¶ä¸”ä¼šä½¿ç”¨æˆ·é¢ä¸´è¶…å‡ºå…¶æ§åˆ¶èŒƒå›´çš„ç¾¤é›†çº§é—®é¢˜ã€‚</p>
<h3 id="container-to-container-networking" tabindex="-1"><a class="header-anchor" href="#container-to-container-networking" aria-hidden="true">#</a> Container-to-container networking</h3>
<p>å®¹å™¨åˆ°å®¹å™¨çš„ç½‘ç»œè¿æ¥é€šè¿‡Pod namespace è¿›è¡Œã€‚<strong>namespaceç©ºé—´å…è®¸æ‚¨æ‹¥æœ‰ç‹¬ç«‹çš„ç½‘ç»œæ¥å£å’Œè·¯ç”±è¡¨ï¼Œå®ƒä»¬ä¸ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†éš”ç¦»å¹¶ç‹¬ç«‹è¿è¡Œã€‚</strong> æ¯ä¸ªPodéƒ½æœ‰è‡ªå·±çš„ç½‘ç»œåç§°ç©ºé—´ï¼ŒPodå†…çš„å®¹å™¨å…±äº«ç›¸åŒçš„IPåœ°å€å’Œç«¯å£ã€‚<strong>è¿™äº›å®¹å™¨ä¹‹é—´çš„æ‰€æœ‰é€šä¿¡éƒ½é€šè¿‡localhostè¿›è¡Œï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯åŒä¸€åç§°ç©ºé—´çš„ä¸€éƒ¨åˆ†ã€‚</strong>ï¼ˆä¸Šå›¾ä¸­ä»¥ç»¿è‰²çº¿è¡¨ç¤ºã€‚ï¼‰</p>
<p>æˆ‘ä»¬åœ¨å‰é¢æŸä¸€èŠ‚æœ‰å­¦è¿‡ docker çš„ç½‘ç»œçŸ¥è¯†ï¼Œè¿™å¾ˆé‡è¦ä¸æ˜¯å˜›ğŸ‘€ ã€‚æˆ‘ä»¬å°è¯•å¯åŠ¨ container:</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-net</span><span class="token operator">=</span>host <span class="token parameter variable">--name</span> nginx-host nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote>
<p>æˆ‘ä»¬å°è¯•å¯åŠ¨ nginxï¼Œä½†æ˜¯è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬çŸ¥é“å¯åŠ¨çš„é»˜è®¤ç«¯å£æ˜¯å®¿ä¸»æœºçš„ 80 ç«¯å£ã€‚</p>
</blockquote>
<p><strong>è¿™ç§æ–¹å¼ï¼Œè™½ç„¶å’Œä¸»æœºä½¿ç”¨åŒä¸€ä¸ª ç½‘ç»œæ ˆï¼Œå¯ä»¥ä¸ºå®¹å™¨æä¾›è‰¯å¥½çš„ç½‘ç»œæ€§èƒ½ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¸¦æ¥å…±äº«ç½‘ç»œèµ„æºå¸¦æ¥çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œå¦‚ç½‘ç»œéš”ç¦»æ€§ã€ç½‘ç»œçš„ç«¯å£å†²çªï¼Œè®°å¾—æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ ï¼š Network Namespece.</strong></p>
<p>docker ä¸­åœ¨å®¿ä¸»æœºåˆ›å»ºä¸€ä¸ª å« <code v-pre>docker0</code> çš„ç½‘æ¡¥ï¼Œå‡¡æ˜¯å’Œ <code v-pre>docker0</code> é“¾æ¥çš„å®¹å™¨ï¼Œéƒ½å¯ä»¥ç”¨å®ƒæ¥é€šä¿¡ï¼Œè€Œå®¹å™¨é“¾æ¥åˆ° <code v-pre>docker0</code> çš„æ–¹å¼ï¼Œå°±æ›´åŠ å¾®å¦™äº†ï¼Œä½¿ç”¨çš„æ–¹å¼æ˜¯ <code v-pre>Veth Pair</code> çš„è™šæ‹Ÿè®¾å¤‡ã€‚</p>
<blockquote>
<p>åœ¨ Docker ä¸­ï¼ŒVeth Pairï¼ˆæˆ–ç§° Veth å¯¹ï¼‰æ˜¯ä¸€ç§è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå®ƒç”±ä¸€å¯¹è™šæ‹Ÿç½‘å¡ç»„æˆï¼Œä¸€ç«¯è¿æ¥åˆ° Docker å®¹å™¨ä¸­çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ°å®¿ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ã€‚Veth Pair æä¾›äº†ä¸€ç§ç®€å•è€Œé«˜æ•ˆçš„æ–¹å¼ï¼Œè®©å®¹å™¨å’Œå®¿ä¸»æœºä¹‹é—´å¯ä»¥è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚</p>
<p>Veth Pair çš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯ï¼Œå®ƒä»¬æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œä¸€ç«¯è¿æ¥åˆ° Docker å®¹å™¨ä¸­ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ°å®¿ä¸»æœºä¸­ã€‚ç”±äº Veth Pair æ˜¯è™šæ‹Ÿè®¾å¤‡ï¼Œæ‰€ä»¥å®ƒä»¬ä¸ä¼šå ç”¨å®¿ä¸»æœºä¸­çš„ç‰©ç†ç½‘ç»œæ¥å£ï¼Œä»è€Œå¯ä»¥é¿å…ç½‘ç»œèµ„æºçš„æµªè´¹ã€‚</p>
</blockquote>
<h3 id="pod-to-pod-networking" tabindex="-1"><a class="header-anchor" href="#pod-to-pod-networking" aria-hidden="true">#</a> Pod-to-Pod networking</h3>
<p>ä½¿ç”¨Kubernetesæ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰æŒ‡å®šçš„Pod IP CIDRèŒƒå›´ã€‚è¿™å¯ç¡®ä¿æ¯ä¸ªPodéƒ½æ”¶åˆ°ç¾¤é›†ä¸­å…¶ä»–Podå¯ä»¥çœ‹åˆ°çš„å”¯ä¸€IPåœ°å€ã€‚åˆ›å»ºæ–°Podæ—¶ï¼ŒIPåœ°å€å†³ä¸ä¼šé‡å ã€‚ä¸å®¹å™¨åˆ°å®¹å™¨ç½‘ç»œä¸åŒï¼ŒPodåˆ°Podé€šä¿¡ä½¿ç”¨çœŸå®çš„IPï¼Œæ— è®ºæ‚¨å°†Podéƒ¨ç½²åœ¨ç¾¤é›†ä¸­çš„åŒä¸€èŠ‚ç‚¹è¿˜æ˜¯ä¸åŒèŠ‚ç‚¹ä¸Šã€‚</p>
<p>ä¸Šå›¾ä¸­æ˜¾ç¤ºï¼Œ<strong>Podè¦ç›¸äº’é€šä¿¡ï¼Œæµé‡å¿…é¡»åœ¨ Pod ç½‘ç»œå‘½åç©ºé—´å’Œæ ¹ç½‘ç»œå‘½åç©ºé—´ï¼ˆroot network namespaceï¼‰ä¹‹é—´æµåŠ¨</strong>ã€‚è¿™æ˜¯é€šè¿‡è™šæ‹Ÿä»¥å¤ªç½‘è®¾å¤‡æˆ–vethå¯¹ï¼ˆå›¾ä¸­veth0åˆ°Podå‘½åç©ºé—´1ï¼Œveth1åˆ°Podå‘½åç©ºé—´2ï¼‰è¿æ¥Podå‘½åç©ºé—´å’Œæ ¹å‘½åç©ºé—´æ¥å®ç°çš„ã€‚è™šæ‹Ÿç½‘æ¡¥è¿æ¥è¿™äº›è™šæ‹Ÿæ¥å£ï¼Œå…è®¸æµé‡ä½¿ç”¨åœ°å€è§£æåè®®ï¼ˆARPï¼‰ åœ¨å®ƒä»¬ä¹‹é—´æµåŠ¨ã€‚</p>
<p><strong>å½“æ•°æ®ä»Pod 1å‘é€åˆ°Pod 2æ—¶ï¼Œäº‹ä»¶æµä¸ºï¼š</strong></p>
<ol>
<li>Pod 1æµé‡é€šè¿‡eth0æµå‘æ ¹ç½‘ç»œå‘½åç©ºé—´çš„è™šæ‹Ÿæ¥å£veth0ã€‚</li>
<li>ç„¶åï¼Œæµé‡é€šè¿‡veth0åˆ°è¾¾è¿æ¥åˆ°veth1çš„è™šæ‹Ÿç½‘æ¡¥ã€‚</li>
<li>æµé‡é€šè¿‡è™šæ‹Ÿç½‘æ¡¥åˆ°è¾¾veth1ã€‚</li>
<li>æœ€åï¼Œæµé‡é€šè¿‡veth1åˆ°è¾¾Pod 2çš„eth0æ¥å£ã€‚</li>
</ol>
<h3 id="pod-to-service-networking" tabindex="-1"><a class="header-anchor" href="#pod-to-service-networking" aria-hidden="true">#</a> Pod-to-Service networking</h3>
<p>è™½ç„¶ pod çš„ address æ˜¯å”¯ä¸€çš„ï¼Œä½†æ˜¯pod æ˜¯éå¸¸åŠ¨æ€çš„ã€‚å®ƒä»¬å¯èƒ½éœ€è¦æ ¹æ®éœ€æ±‚è¿›è¡Œæ‰©å±•æˆ–ç¼©å‡ã€‚åœ¨åº”ç”¨ç¨‹åºå´©æºƒæˆ–èŠ‚ç‚¹æ•…éšœçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é‡æ–°åˆ›å»ºå®ƒä»¬ã€‚è¿™äº›äº‹ä»¶ä¼šå¯¼è‡´Podçš„IPåœ°å€å‘ç”Ÿå˜åŒ–ï¼Œè¿™å°†ä½¿è”ç½‘æˆä¸ºä¸€ä¸ªæŒ‘æˆ˜ã€‚</p>
<p><img src="http://sm.nsddd.top/sm202303101432580.png" alt="image-20230310143159337"></p>
<p><strong>æˆ‘ä»¬è¦è§£å†³ pod çš„åŠ¨æ€é—®é¢˜ï¼Œé‚£ä¹ˆå°±éœ€è¦ï¼š</strong></p>
<ol>
<li>åœ¨å‰ç«¯åˆ†é…é™æ€è™šæ‹ŸIPåœ°å€ï¼ˆvirtual IPï¼šVIPï¼‰ï¼Œä»¥è¿æ¥ä¸æœåŠ¡å…³è”çš„ä»»ä½•åç«¯Podã€‚</li>
<li>å°†å¯»å€åˆ°æ­¤è™šæ‹ŸIPçš„ä»»ä½•æµé‡è´Ÿè½½å¹³è¡¡åˆ°åç«¯Podé›†ã€‚</li>
<li>è·Ÿè¸ªPodçš„IPåœ°å€ï¼Œè¿™æ ·å³ä½¿Pod IPåœ°å€å‘ç”Ÿå˜åŒ–ï¼Œå®¢æˆ·ç«¯ä¹Ÿä¸ä¼šåœ¨è¿æ¥Podæ—¶é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬åªç›´æ¥è¿æ¥åˆ°æœåŠ¡æœ¬èº«çš„é™æ€è™šæ‹ŸIPåœ°å€ã€‚</li>
</ol>
<p><strong>ç¾¤é›†å†…è´Ÿè½½å¹³è¡¡ä»¥ä¸¤ç§æ–¹å¼è¿›è¡Œï¼š</strong></p>
<ol>
<li><code v-pre>Iptables</code>ï¼šåœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œkube-proxyç›‘è§†APIæœåŠ¡å™¨ä¸­çš„æ›´æ”¹ã€‚å¯¹äºæ¯ä¸ªæ–°æœåŠ¡ï¼Œå®ƒéƒ½å®‰è£…iptablesè§„åˆ™ï¼Œè¿™äº›è§„åˆ™æ•è·åˆ°æœåŠ¡çš„clusterIPå’Œç«¯å£çš„æµé‡ï¼Œç„¶åå°†æµé‡é‡å®šå‘åˆ°æœåŠ¡çš„åç«¯Podã€‚Podæ˜¯éšæœºé€‰æ‹©çš„ã€‚è¿™ç§æ¨¡å¼å¾ˆå¯é ï¼Œè€Œä¸”ç³»ç»Ÿå¼€é”€è¾ƒä½ï¼Œå› ä¸ºLinux Netfilteræ— éœ€åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´åˆ‡æ¢å³å¯å¤„ç†æµé‡ã€‚</li>
<li><code v-pre>IPVS</code>ï¼š<strong>IPVSæ„å»ºåœ¨Netfilterä¹‹ä¸Šï¼Œå®ç°ä¼ è¾“å±‚è´Ÿè½½å¹³è¡¡</strong>ã€‚IPVSä½¿ç”¨<code v-pre>Netfilter Hook</code>  å‡½æ•°ï¼Œä½¿ç”¨ <code v-pre>hash tables</code> ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ï¼Œå¹¶åœ¨å†…æ ¸ç©ºé—´ä¸­å·¥ä½œã€‚è¿™æ„å‘³ç€IPVSæ¨¡å¼ä¸‹çš„ <code v-pre>kube-proxy</code> é‡å®šå‘æµé‡æ¯”iptablesæ¨¡å¼ä¸‹çš„kube-proxyå…·æœ‰æ›´ä½çš„å»¶è¿Ÿã€æ›´é«˜çš„ååé‡å’Œæ›´å¥½çš„æ€§èƒ½ã€‚</li>
</ol>
<blockquote>
<p>ä¸Šå›¾æ˜¾ç¤ºäº†ä»Pod 1åˆ°Pod 3ï¼Œé€šè¿‡æœåŠ¡åˆ°ä¸åŒèŠ‚ç‚¹ï¼ˆç”¨çº¢è‰²æ ‡è®°ï¼‰çš„åŒ…æµã€‚ç”±äºç½‘æ¡¥ä¸Šè¿è¡Œçš„ RPC æ— æ³•ç†è§£æœåŠ¡ï¼Œå› æ­¤ä¼ è¾“åˆ°è™šæ‹Ÿç½‘æ¡¥çš„åŒ…å¿…é¡»ä½¿ç”¨é»˜è®¤è·¯ç”±ï¼ˆeth0)ã€‚ç¨åï¼Œå¿…é¡»é€šè¿‡iptablesè¿‡æ»¤è¿™äº›åŒ…ï¼Œiptablesä½¿ç”¨kube-proxyåœ¨èŠ‚ç‚¹ä¸­å®šä¹‰çš„è§„åˆ™ã€‚å› æ­¤ï¼Œå›¾ä¸­æ˜¾ç¤ºçš„æ˜¯è·¯å¾„ã€‚</p>
</blockquote>
<h3 id="internet-to-service-networking" tabindex="-1"><a class="header-anchor" href="#internet-to-service-networking" aria-hidden="true">#</a> Internet-to-Service networking</h3>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘å·²ç»è®¨è®ºäº†å¦‚ä½•åœ¨é›†ç¾¤ä¸­è·¯ç”±æµé‡ã€‚ä¸è¿‡ï¼ŒKubernetesç½‘ç»œè¿˜æœ‰å¦ä¸€é¢ï¼Œé‚£å°±æ˜¯å°†åº”ç”¨ç¨‹åºæš´éœ²ç»™å¤–éƒ¨ç½‘ç»œã€‚</p>
<p><img src="http://sm.nsddd.top/sm202303101441314.png" alt="image-20230310144018105"></p>
<p><strong>å¯ä»¥é€šè¿‡ä¸¤ç§ä¸åŒçš„æ–¹å¼å°†åº”ç”¨ç¨‹åºå…¬å¼€ç»™å¤–éƒ¨ç½‘ç»œ:</strong></p>
<ol>
<li>Egressï¼šå½“æ‚¨å¸Œæœ›å°†æµé‡ä»KubernetesæœåŠ¡è·¯ç”±åˆ°Internetæ—¶ï¼Œè¯·ä½¿ç”¨æ­¤é€‰é¡¹ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œiptablesæ‰§è¡ŒæºNATï¼Œå› æ­¤æµé‡ä¼¼ä¹æ¥è‡ªèŠ‚ç‚¹è€Œä¸æ˜¯Podã€‚</li>
<li>Ingressï¼šè¿™æ˜¯ä»å¤–éƒ¨ä¸–ç•Œåˆ°æœåŠ¡çš„ä¼ å…¥æµé‡ã€‚å…¥å£è¿˜ä½¿ç”¨è¿æ¥è§„åˆ™å…è®¸å’Œé˜»æ­¢ä¸æœåŠ¡çš„ç‰¹å®šé€šä¿¡ã€‚é€šå¸¸ï¼Œå­˜åœ¨ä¸¤ç§åœ¨ä¸åŒç½‘ç»œå †æ ˆåŒºåŸŸä¸Šèµ·ä½œç”¨çš„å…¥å£è§£å†³æ–¹æ¡ˆï¼šæœåŠ¡è´Ÿè½½å‡è¡¡å™¨å’Œå…¥å£æ§åˆ¶å™¨ã€‚</li>
</ol>
<h2 id="æœåŠ¡å‘ç°-discovering-services" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡å‘ç°-discovering-services" aria-hidden="true">#</a> æœåŠ¡å‘ç°ï¼ˆDiscovering Services ï¼‰</h2>
<p>Kubernetesæä¾›äº†ä¸€ç§æœºåˆ¶æ¥è‡ªåŠ¨ç®¡ç†å®¹å™¨å’ŒæœåŠ¡ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œè¿™è¢«ç§°ä¸ºæœåŠ¡å‘ç°ã€‚æœåŠ¡å‘ç°å…è®¸å®¹å™¨å’ŒæœåŠ¡äº’ç›¸å‘ç°å½¼æ­¤çš„å­˜åœ¨å’Œä½ç½®ï¼Œä»è€Œä½¿å®ƒä»¬å¯ä»¥è¿›è¡Œé€šä¿¡ã€‚</p>
<p><strong>Kubernetes æœåŠ¡å‘ç°çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</strong></p>
<ul>
<li><strong>ç¯å¢ƒå˜é‡</strong>ï¼šPodæ‰€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œ çš„<code v-pre>kubelet</code>æœåŠ¡è´Ÿè´£ä¸ºæ¯ä¸ªæ´»åŠ¨æœåŠ¡è®¾ç½®<code v-pre>{SVCNAME}_SERVICE_HOST</code>å’Œ<code v-pre>{SVCNAME}_SERVICE_PORT</code>æ ¼å¼çš„ç¯å¢ƒå˜é‡ã€‚å¿…é¡»åœ¨å®¢æˆ·ç«¯Podå‡ºç°ä¹‹å‰åˆ›å»ºæœåŠ¡ã€‚å¦åˆ™ï¼Œè¿™äº›å®¢æˆ·æœºPodå°†ä¸ä¼šå¡«å……å…¶ç¯å¢ƒå˜é‡ã€‚</li>
<li><strong>DNS</strong>ï¼šDNSæœåŠ¡ä½œä¸ºæ˜ å°„åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªDNSæœåŠ¡å™¨Podçš„KubernetesæœåŠ¡å®ç°ï¼Œè¿™äº›Podçš„è°ƒåº¦ä¸ä»»ä½•å…¶ä»–Podä¸€æ ·ã€‚ç¾¤é›†ä¸­çš„Podé…ç½®ä¸ºä½¿ç”¨DNSæœåŠ¡ï¼ŒDNSæœç´¢åˆ—è¡¨åŒ…æ‹¬Podè‡ªå·±çš„å‘½åç©ºé—´å’Œç¾¤é›†çš„é»˜è®¤åŸŸã€‚æ”¯æŒç¾¤é›†çš„DNSæœåŠ¡å™¨ï¼ˆå¦‚CoreDNSï¼‰ä¼šç›‘è§†Kubernetes APIä¸­çš„æ–°æœåŠ¡ï¼Œå¹¶ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ç»„DNSè®°å½•ã€‚å¦‚æœåœ¨æ•´ä¸ªç¾¤é›†ä¸­å¯ç”¨äº†DNSï¼Œåˆ™æ‰€æœ‰Podéƒ½å¯ä»¥é€šè¿‡å…¶DNSåç§°è‡ªåŠ¨è§£ææœåŠ¡ã€‚Kubernetes DNSæœåŠ¡å™¨æ˜¯è®¿é—®ExternalNameæœåŠ¡çš„å”¯ä¸€é€”å¾„ã€‚</li>
</ul>
<p>æ­¤å¤–ï¼ŒKubernetesè¿˜æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨KubernetesæœåŠ¡å¯¹è±¡æ¥å®šä¹‰ä¸€ç»„ç›¸å…³çš„Podï¼Œå¹¶ä¸ºå®ƒä»¬åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„åç§°å’ŒIPåœ°å€ã€‚è¿™ä½¿å¾—å…¶ä»–æœåŠ¡å¯ä»¥ä½¿ç”¨è¯¥åç§°æ¥è®¿é—®è¿™ç»„Podï¼Œè€Œä¸å¿…æ‹…å¿ƒå®ƒä»¬çš„IPåœ°å€ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p>
<p>Kubernetesè¿˜æ”¯æŒåœ¨æœåŠ¡å‘ç°è¿‡ç¨‹ä¸­ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†æµé‡ã€‚è´Ÿè½½å‡è¡¡å™¨å¯ä»¥æ ¹æ®ç‰¹å®šçš„è§„åˆ™å°†æµé‡åˆ†å‘åˆ°å¤šä¸ªå®¹å™¨æˆ–æœåŠ¡ä¸­ï¼Œä»è€Œç¡®ä¿å®ƒä»¬ä¹‹é—´çš„è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨æ€§ã€‚</p>
<p>å¦å¤–ï¼ŒKubernetesè¿˜æ”¯æŒè‡ªå®šä¹‰æœåŠ¡å‘ç°æ’ä»¶ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ»¡è¶³ç‰¹å®šåº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶æ¥å®ç°è·¨å¤šä¸ªKubernetesé›†ç¾¤çš„æœåŠ¡å‘ç°ã€‚</p>
<h3 id="kubernetes-æœåŠ¡å‘å¸ƒ" tabindex="-1"><a class="header-anchor" href="#kubernetes-æœåŠ¡å‘å¸ƒ" aria-hidden="true">#</a> Kubernetes æœåŠ¡å‘å¸ƒ</h3>
<p>KubernetesæœåŠ¡ä¸ºä½ æä¾›äº†ä¸€ç§è®¿é—®Podç»„çš„æ–¹æ³•ï¼Œé€šå¸¸ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨è¿›è¡Œå®šä¹‰ã€‚è¿™å¯èƒ½æ˜¯è¯•å›¾è®¿é—®é›†ç¾¤ä¸­å…¶ä»–åº”ç”¨ç¨‹åºçš„åº”ç”¨ç¨‹åºï¼Œä¹Ÿå¯èƒ½å…è®¸æ‚¨å°†é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå…¬å¼€ç»™å¤–éƒ¨ä¸–ç•Œã€‚Kubernetes æœåŠ¡ç±»å‹å…è®¸æ‚¨æŒ‡å®šæ‰€éœ€çš„æœåŠ¡ç±»å‹ã€‚</p>
<p><img src="http://sm.nsddd.top/sm202303101453168.png" alt="image-20230310145316045"></p>
<p><strong>ä¸åŒçš„æœåŠ¡ç±»å‹åŒ…æ‹¬ï¼š</strong></p>
<ol>
<li><strong>ClusterIP</strong>ï¼šè¿™æ˜¯é»˜è®¤çš„æœåŠ¡ç±»å‹ã€‚å®ƒä½¿æœåŠ¡åªèƒ½ä»é›†ç¾¤å†…è®¿é—®ï¼Œå¹¶å…è®¸é›†ç¾¤å†…çš„åº”ç”¨ç¨‹åºç›¸äº’é€šä¿¡ã€‚æ²¡æœ‰å¤–éƒ¨è®¿é—®ã€‚</li>
<li><strong>LoadBalancerï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰</strong>ï¼šæ­¤ServiceTypeä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å¹³è¡¡å™¨å‘å¤–éƒ¨å…¬å¼€æœåŠ¡ã€‚æ¥è‡ªå¤–éƒ¨è´Ÿè½½å¹³è¡¡å™¨çš„æµé‡è¢«å®šå‘åˆ°åç«¯Podã€‚äº‘æä¾›å•†å†³å®šå¦‚ä½•è¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚</li>
<li><strong>NodePort</strong>ï¼šè¿™å…è®¸å¤–éƒ¨æµé‡é€šè¿‡æ‰“å¼€æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ç‰¹å®šç«¯å£æ¥è®¿é—®æœåŠ¡ã€‚å‘é€åˆ°è¯¥ç«¯å£çš„ä»»ä½•æµé‡éšåå°†è½¬å‘åˆ°æœåŠ¡ã€‚</li>
<li><strong>ExternalNameï¼ˆå¤–éƒ¨åç§°ï¼‰</strong>ï¼šæ­¤ç±»å‹çš„æœåŠ¡é€šè¿‡ä½¿ç”¨externalNameå­—æ®µçš„å†…å®¹å°†æœåŠ¡æ˜ å°„åˆ°DNSåç§°ï¼Œæ–¹æ³•æ˜¯è¿”å›CNAMEè®°å½•åŠå…¶å€¼ã€‚ä¸è®¾ç½®ä»»ä½•ç±»å‹çš„ä»£ç†ã€‚</li>
</ol>
<h2 id="cni" tabindex="-1"><a class="header-anchor" href="#cni" aria-hidden="true">#</a> CNI</h2>
<ul>
<li><RouterLink to="/Cloud-Native-k8s/53.html#CNI">åœ¨å‰é¢æˆ‘ä»¬è®²è¿‡ namespces</RouterLink></li>
<li><a href="https://github.com/containernetworking/cni" target="_blank" rel="noopener noreferrer">CNI  github<ExternalLinkIcon/></a></li>
</ul>
<p>åœ¨ä»»ä½•Linuxæ“ä½œç³»ç»Ÿä¸­ï¼Œä½¿ç”¨ <code v-pre>ip</code> å‘½ä»¤åˆ›å»ºç½‘ç»œåç§°ç©ºé—´éƒ½éå¸¸å®¹æ˜“ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªä¸åŒçš„ç½‘ç»œåç§°ç©ºé—´ï¼Œå¹¶å°†å®ƒä»¬å‘½åä¸ºclientå’Œserverã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">ip</span> netns <span class="token function">add</span> client
â¯ <span class="token function">ip</span> netns <span class="token function">add</span> server
â¯ <span class="token function">ip</span> netns list
server
client
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>åˆ é™¤ namespace å‘½ä»¤ï¼š<code v-pre>ip netns delete &lt;namespace_name&gt;</code></p>
</blockquote>
<p><img src="http://sm.nsddd.top/sm202303101516295.png" alt="image-20230310151650219"></p>
<p>åˆ›å»º <code v-pre>veth</code> å¯¹ä»¥è¿æ¥è¿™äº›ç½‘ç»œå‘½åç©ºé—´ã€‚å°† <code v-pre>veth</code> çº¿å¯¹è§†ä¸ºä¸¤ç«¯éƒ½æœ‰è¿æ¥å™¨çš„ç½‘çº¿ï¼ˆæˆ‘ä»¬åœ¨å‰é¢è®²è¿‡ veth)ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> veth-client <span class="token builtin class-name">type</span> veth peer name veth-server
â¯ <span class="token function">ip</span> <span class="token function">link</span> list <span class="token operator">|</span> <span class="token function">grep</span> veth
<span class="token number">12</span>: veth-server@veth-client: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,M-DOWN<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class="token number">1000</span>
<span class="token number">13</span>: veth-client@veth-server: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,M-DOWN<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class="token number">1000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://sm.nsddd.top/sm202303101517622.png" alt="image-20230310151749562"></p>
<p><code v-pre>veth</code> å¯¹ï¼ˆç”µç¼†ï¼‰å­˜åœ¨äºä¸»æœºç½‘ç»œå‘½åç©ºé—´ä¸­ï¼Œç°åœ¨ï¼Œè®©æˆ‘ä»¬å°† <code v-pre>veth</code> å¯¹çš„ä¸¤ç«¯ç§»åˆ°å‰é¢åˆ›å»ºçš„å®ƒä»¬å„è‡ªçš„åç§°ç©ºé—´ä¸­ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-client netns client
â¯ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-server netns server
â¯ <span class="token function">ip</span> <span class="token function">link</span> list <span class="token operator">|</span> <span class="token function">grep</span> veth <span class="token comment"># doesnâ€™t exist on the host network namespace now</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://sm.nsddd.top/sm202303101518387.png" alt="image-20230310151854318"></p>
<p>è®©æˆ‘ä»¬éªŒè¯ <code v-pre>veth</code> ç»“æŸå®é™…ä¸Šå­˜åœ¨äºåç§°ç©ºé—´ä¸­ã€‚æˆ‘ä»¬å°†ä» <code v-pre>client</code> åç§°ç©ºé—´å¼€å§‹</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> client <span class="token function">ip</span> <span class="token function">link</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
<span class="token number">13</span>: veth-client@if12: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class="token number">1000</span>
    link/ether <span class="token number">16</span>:8c:9a:f4:34:5d brd ff:ff:ff:ff:ff:ff link-netns server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ <code v-pre>server</code> åç§°ç©ºé—´</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> server <span class="token function">ip</span> <span class="token function">link</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
<span class="token number">12</span>: veth-server@if13: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class="token number">1000</span>
    link/ether 4a:36:cf:93:eb:d3 brd ff:ff:ff:ff:ff:ff link-netns client
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸ºè¿™äº›æ¥å£åˆ†é…IPåœ°å€å¹¶å°†å…¶è®¾ç½®ä¸ºå¯ç”¨çŠ¶æ€</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> client <span class="token function">ip</span> address <span class="token function">add</span> <span class="token number">10.0</span>.0.11/24 dev veth-client
â¯ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> client <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-client up
â¯ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> server <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-server up
â¯ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> server <span class="token function">ip</span> address <span class="token function">add</span> <span class="token number">10.0</span>.0.12/24 dev veth-server
â¯ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> client <span class="token function">ip</span> addr
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noop state DOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
<span class="token number">13</span>: veth-client@if12: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state UP group default qlen <span class="token number">1000</span>
    link/ether <span class="token number">16</span>:8c:9a:f4:34:5d brd ff:ff:ff:ff:ff:ff link-netns server
    inet <span class="token number">10.0</span>.0.11/24 scope global veth-client
       valid_lft forever preferred_lft forever
    inet6 fe80::148c:9aff:fef4:345d/64 scope <span class="token function">link</span> 
       valid_lft forever preferred_lft forever
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»§ç»­çœ‹æœåŠ¡ç«¯ IPï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> server <span class="token function">ip</span> addr
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noop state DOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
<span class="token number">12</span>: veth-server@if13: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state UP group default qlen <span class="token number">1000</span>
    link/ether 4a:36:cf:93:eb:d3 brd ff:ff:ff:ff:ff:ff link-netns client
    inet <span class="token number">10.0</span>.0.12/24 scope global veth-server
       valid_lft forever preferred_lft forever
    inet6 fe80::4836:cfff:fe93:ebd3/64 scope <span class="token function">link</span> 
       valid_lft forever preferred_lft forever
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://sm.nsddd.top/sm202303101522150.png" alt="image-20230310152215060"></p>
<p>ä½¿ç”¨pingå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯ä¸¤ä¸ªç½‘ç»œåç§°ç©ºé—´å·²ç»è¿æ¥å¹¶ä¸”å¯ä»¥è®¿é—®ï¼Œ</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> client <span class="token function">ping</span> <span class="token number">10.0</span>.0.12
PING <span class="token number">10.0</span>.0.12 <span class="token punctuation">(</span><span class="token number">10.0</span>.0.12<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.0.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.102</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.0.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.036</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.0.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.038</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.0.12: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.037</span> ms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä»¬æƒ³åˆ›å»ºæ›´å¤šçš„ç½‘ç»œåç§°ç©ºé—´å¹¶å°†å®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ï¼Œä¸ºåç§°ç©ºé—´çš„æ¯ä¸ªç»„åˆåˆ›å»º <code v-pre>veth</code> å¯¹å¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¯ä¼¸ç¼©çš„è§£å†³æ–¹æ¡ˆã€‚ç›¸åï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªLinuxæ¡¥ï¼Œå¹¶å°†è¿™äº›ç½‘ç»œåç§°ç©ºé—´è¿æ¥åˆ°æ¡¥ä»¥è·å¾—è¿æ¥ã€‚è¿™æ­£æ˜¯Dockeråœ¨åŒä¸€ä¸»æœºä¸Šè¿è¡Œçš„å®¹å™¨ä¹‹é—´å»ºç«‹ç½‘ç»œçš„æ–¹å¼ï¼</p>
<p>è®©æˆ‘ä»¬åˆ›å»ºåç§°ç©ºé—´å¹¶å°†å…¶é™„åŠ åˆ° bridgeã€‚</p>
<p><img src="http://sm.nsddd.top/sm202303101523717.png" alt="image-20230310152321642"></p>
<h3 id="å¦‚ä½•ä»å¤–éƒ¨æœåŠ¡å™¨è®¿é—®ä¸“ç”¨ç½‘ç»œ" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä»å¤–éƒ¨æœåŠ¡å™¨è®¿é—®ä¸“ç”¨ç½‘ç»œ" aria-hidden="true">#</a> å¦‚ä½•ä»å¤–éƒ¨æœåŠ¡å™¨è®¿é—®ä¸“ç”¨ç½‘ç»œï¼Ÿ</h3>
<p>è®©æˆ‘ä»¬ä½¿ç”¨Dockeræ¥æ¨¡æ‹Ÿè¯¥åœºæ™¯ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> web <span class="token parameter variable">--rm</span> nginx
$ <span class="token assign-left variable">WEB_IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> inspect <span class="token parameter variable">-f</span> <span class="token string">"{{ .NetworkSettings.IPAddress }}"</span> web<span class="token variable">`</span></span>
$ <span class="token function">docker</span> inspect web <span class="token parameter variable">--format</span> <span class="token string">'{{ .NetworkSettings.SandboxKey }}'</span>
/var/run/docker/netns/c009f2a4be71
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±äºDockerä¸ä¼šåœ¨é»˜è®¤ä½ç½®åˆ›å»º <code v-pre>**netns**</code> ï¼Œå› æ­¤ <code v-pre>**ip netns list**</code> ä¸ä¼šæ˜¾ç¤ºæ­¤ç½‘ç»œåç§°ç©ºé—´ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæŒ‡å‘é¢„æœŸä½ç½®çš„ç¬¦å·é“¾æ¥æ¥å…‹æœè¿™ä¸ªé™åˆ¶ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>client$ <span class="token assign-left variable">container_id</span><span class="token operator">=</span>web
client$ <span class="token assign-left variable">container_netns</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> inspect $<span class="token punctuation">{</span>container_id<span class="token punctuation">}</span> <span class="token parameter variable">--format</span> <span class="token string">'{{ .NetworkSettings.SandboxKey }}'</span><span class="token variable">)</span></span>
client$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/run/netns
client$ <span class="token function">rm</span> <span class="token parameter variable">-f</span> /var/run/netns/<span class="token variable">${container_id}</span>
client$ <span class="token function">ln</span> <span class="token parameter variable">-sv</span> <span class="token variable">${container_netns}</span> /var/run/netns/<span class="token variable">${container_id}</span>
<span class="token string">'/var/run/netns/web'</span> -<span class="token operator">></span> <span class="token string">'/var/run/docker/netns/c009f2a4be71'</span>
client$ <span class="token function">ip</span> netns list
web <span class="token punctuation">(</span>id: <span class="token number">3</span><span class="token punctuation">)</span>
server1 <span class="token punctuation">(</span>id: <span class="token number">1</span><span class="token punctuation">)</span>
client1 <span class="token punctuation">(</span>id: <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ£€æŸ¥Webåç§°ç©ºé—´ä¸­çš„IPåœ°å€</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> web <span class="token function">ip</span> addr
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
<span class="token number">11</span>: eth0@if12: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state UP group default
    link/ether 02:42:ac:12:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">0</span>
    inet <span class="token number">172.18</span>.0.3/24 brd <span class="token number">172.18</span>.0.255 scope global eth0
       valid_lft forever preferred_lft forever
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬æ¥æ£€æŸ¥ä¸€ä¸‹Dockerå®¹å™¨ä¸­çš„IPåœ°å€</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token assign-left variable">WEB_IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">docker</span> inspect <span class="token parameter variable">-f</span> <span class="token string">"{{ .NetworkSettings.IPAddress }}"</span> web<span class="token variable">`</span></span>
client$ <span class="token builtin class-name">echo</span> <span class="token variable">$WEB_IP</span>
<span class="token number">172.18</span>.0.3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¾ˆæ˜æ˜¾ï¼ŒDockerä½¿ç”¨æ‰€æœ‰Linuxåç§°ç©ºé—´ï¼Œå¹¶å°†å†…å®¹ä¸ä¸»æœºéš”ç¦»ã€‚è®©æˆ‘ä»¬å°è¯•ä»HOSTæœåŠ¡å™¨è®¿é—®åœ¨webç½‘ç»œåç§°ç©ºé—´ä¸­è¿è¡Œçš„WebAppã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>client$ <span class="token function">curl</span> <span class="token variable">$WEB_IP</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span>
<span class="token operator">&lt;</span>title<span class="token operator">></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">></span>
<span class="token operator">&lt;</span>style<span class="token operator">></span>
    body <span class="token punctuation">{</span>
        width: 35em<span class="token punctuation">;</span>
        margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
        font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">></span>
<span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span>
<span class="token operator">&lt;</span>p<span class="token operator">></span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">></span>
<span class="token operator">&lt;</span>p<span class="token operator">></span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.org/"</span><span class="token operator">></span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">></span>.<span class="token operator">&lt;</span>br/<span class="token operator">></span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.com/"</span><span class="token operator">></span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">></span>.<span class="token operator">&lt;</span>/p<span class="token operator">></span>
<span class="token operator">&lt;</span>p<span class="token operator">></span><span class="token operator">&lt;</span>em<span class="token operator">></span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
<span class="token operator">&lt;</span>/body<span class="token operator">></span>
<span class="token operator">&lt;</span>/html<span class="token operator">></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ˜¯å¦å¯ä»¥ä»å¤–éƒ¨ç½‘ç»œè®¿é—®æ­¤WebæœåŠ¡å™¨ï¼Ÿæ˜¯çš„ï¼Œé€šè¿‡æ·»åŠ ç«¯å£è½¬å‘ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> PREROUTING <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-j</span> 
$ <span class="token builtin class-name">echo</span> <span class="token variable">$HOST_IP</span>
<span class="token number">172.17</span>.0.23
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ä¸»æœºIPåœ°å€è®¿é—®WebæœåŠ¡å™¨ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token number">172.17</span>.0.23
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span>
<span class="token operator">&lt;</span>title<span class="token operator">></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">></span>
<span class="token operator">&lt;</span>style<span class="token operator">></span>
    body <span class="token punctuation">{</span>
        width: 35em<span class="token punctuation">;</span>
        margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
        font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">></span>
<span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span>
<span class="token operator">&lt;</span>p<span class="token operator">></span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">></span>
<span class="token operator">&lt;</span>p<span class="token operator">></span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.org/"</span><span class="token operator">></span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">></span>.<span class="token operator">&lt;</span>br/<span class="token operator">></span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"http://nginx.com/"</span><span class="token operator">></span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">></span>.<span class="token operator">&lt;</span>/p<span class="token operator">></span>
<span class="token operator">&lt;</span>p<span class="token operator">></span><span class="token operator">&lt;</span>em<span class="token operator">></span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
<span class="token operator">&lt;</span>/body<span class="token operator">></span>
<span class="token operator">&lt;</span>/html<span class="token operator">></span>
node01 $
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://sm.nsddd.top/sm202303101623625.png" alt="image-20230310162317474"></p>
<h3 id="cni-1" tabindex="-1"><a class="header-anchor" href="#cni-1" aria-hidden="true">#</a> CNI</h3>
<p>â€œCNIæ’ä»¶è´Ÿè´£å°†ç½‘ç»œæ¥å£æ’å…¥å®¹å™¨ç½‘ç»œåç§°ç©ºé—´ï¼ˆä¾‹å¦‚ï¼Œvethå¯¹çš„ä¸€ç«¯ï¼‰ï¼Œå¹¶åœ¨ä¸»æœºä¸Šè¿›è¡Œä»»ä½•å¿…è¦çš„æ›´æ”¹ï¼ˆä¾‹å¦‚ï¼Œå°†vethçš„å¦ä¸€ç«¯è¿æ¥åˆ°ç½‘æ¡¥ï¼‰ã€‚ç„¶åï¼Œå®ƒåº”å°†IPåˆ†é…ç»™æ¥å£ï¼Œå¹¶é€šè¿‡è°ƒç”¨ç›¸åº”çš„IPAMæ’ä»¶è®¾ç½®ä¸IPåœ°å€ç®¡ç†éƒ¨åˆ†ä¸€è‡´çš„è·¯ç”±ã€‚â€</p>
<p>CNIï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰æ˜¯äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šçš„ä¸€ä¸ªé¡¹ç›®ï¼Œç”±ä¸€ä¸ªè§„èŒƒå’Œåº“ç»„æˆï¼Œç”¨äºç¼–å†™æ’ä»¶æ¥é…ç½®Linuxå®¹å™¨ä¸­çš„ç½‘ç»œæ¥å£ï¼Œæ²¿ç€è®¸å¤šå—æ”¯æŒçš„æ’ä»¶ã€‚CNIåªå…³å¿ƒå®¹å™¨çš„ç½‘ç»œè¿é€šæ€§ï¼Œå¹¶åœ¨åˆ é™¤å®¹å™¨æ—¶ç§»é™¤åˆ†é…çš„èµ„æºã€‚ç”±äºè¿™ä¸€é‡ç‚¹ï¼ŒCNIå¾—åˆ°äº†å¹¿æ³›çš„æ”¯æŒï¼Œå¹¶ä¸”è§„èŒƒæ˜“äºå®ç°ã€‚</p>
<p><img src="http://sm.nsddd.top/sm202303101624384.png" alt="image-20230310162410292"></p>
<p>æ³¨æ„ï¼šè¿è¡Œæ—¶å¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿-ä¾‹å¦‚ Kubernetes, PodMan, cloud foundry, etc</p>
<h3 id="åˆ›å»º-cni" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-cni" aria-hidden="true">#</a> åˆ›å»º CNI</h3>
<p><strong>æ­¥éª¤1ï¼šä¸‹è½½CNIæ’ä»¶</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>client$ <span class="token function">mkdir</span> cni
client$ <span class="token builtin class-name">cd</span> cni
client$ <span class="token function">curl</span> <span class="token parameter variable">-O</span> <span class="token parameter variable">-L</span> https://github.com/containernetworking/cni/releases/download/v0.4.0/cni-amd64-v0.4.0.tgz
client$ <span class="token function">tar</span> <span class="token parameter variable">-xvf</span> cni-amd64-v0.4.0.tgz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ­¥éª¤2ï¼šåˆ›å»ºJSONæ ¼å¼çš„CNIé…ç½®</strong></p>
<div class="language-yaml ext-yml line-numbers-mode"><pre v-pre class="language-yaml"><code>cat <span class="token punctuation">></span> /tmp/00<span class="token punctuation">-</span>demo.conf &lt;&lt;"EOF"
<span class="token punctuation">{</span>
    <span class="token key atrule">"cniVersion"</span><span class="token punctuation">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
    <span class="token key atrule">"name"</span><span class="token punctuation">:</span> <span class="token string">"demo_br"</span><span class="token punctuation">,</span>
    <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"bridge"</span><span class="token punctuation">,</span>
    <span class="token key atrule">"bridge"</span><span class="token punctuation">:</span> <span class="token string">"cni_net0"</span><span class="token punctuation">,</span>
    <span class="token key atrule">"isGateway"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
    <span class="token key atrule">"ipMasq"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
    <span class="token key atrule">"ipam"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"host-local"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"subnet"</span><span class="token punctuation">:</span> <span class="token string">"10.0.10.0/24"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"routes"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> <span class="token key atrule">"dst"</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0/0"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token key atrule">"dst"</span><span class="token punctuation">:</span> <span class="token string">"1.1.1.1/32"</span><span class="token punctuation">,</span> "gw"<span class="token punctuation">:</span><span class="token string">"10.0.10.1"</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>CNIé…ç½®å‚æ•°</strong></p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>-:CNI generic parameters:-
cniVersion: The version of the CNI spec in which the definition works with
name: The network name
type: The name of the plugin you wish to use.  In this case, the actual name of the plugin executable
args: Optional additional parameters
ipMasq: Configure outbound masquerade (source NAT) for this network
ipam:
    type: The name of the IPAM plugin executable
    subnet: The subnet to allocate out of (this is actually part of the IPAM plugin)
    routes:
        dst: The subnet you wish to reach
        gw: The IP address of the next hop to reach the dst.  If not specified the default gateway for the subnet is assumed
dns:
    nameservers: A list of nameservers you wish to use with this network
    domain: The search domain to use for DNS requests
    search: A list of search domains
    options: A list of options to be passed to the receiver
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¥éª¤3ï¼šåˆ›å»ºä¸€ä¸ªç½‘ç»œä¸ºâ€œ<strong>none</strong>â€çš„å®¹å™¨ï¼Œè¿™æ ·å®¹å™¨å°±ä¸ä¼šæœ‰ä»»ä½•IPåœ°å€å¯ä¾›ä½¿ç”¨ã€‚æ‚¨å¯ä»¥ä¸ºè¿™ä¸ªå®¹å™¨ä½¿ç”¨ä»»ä½•å›¾åƒï¼Œä½†æ˜¯ï¼Œæˆ‘ä½¿ç”¨'<strong>pause</strong>'å®¹å™¨æ¥æ¨¡æ‹ŸKubernetesã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>controlplane $ <span class="token function">docker</span> run <span class="token parameter variable">--name</span> pause_demo <span class="token parameter variable">-d</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--network</span> none kubernetes/pause
controlplane $ <span class="token assign-left variable">container_id</span><span class="token operator">=</span>pause_demo
controlplane $ <span class="token assign-left variable">container_netns</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> inspect $<span class="token punctuation">{</span>container_id<span class="token punctuation">}</span> <span class="token parameter variable">--format</span> <span class="token string">'{{ .NetworkSettings.SandboxKey }}'</span><span class="token variable">)</span></span>
controlplane $ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/run/netns
controlplane $ <span class="token function">rm</span> <span class="token parameter variable">-f</span> /var/run/netns/<span class="token variable">${container_id}</span>
controlplane $ <span class="token function">ln</span> <span class="token parameter variable">-sv</span> <span class="token variable">${container_netns}</span> /var/run/netns/<span class="token variable">${container_id}</span>
<span class="token string">'/var/run/netns/pause_demo'</span> -<span class="token operator">></span> <span class="token string">'/var/run/docker/netns/0297681f79b5'</span>
controlplane $ <span class="token function">ip</span> netns list
pause_demo
controlplane $ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token variable">$container_id</span> <span class="token function">ifconfig</span>
lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 erbashrors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1
          RX bytes:0 <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>  TX bytes:0 <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ­¥éª¤4ï¼šä½¿ç”¨CNIé…ç½®æ–‡ä»¶è°ƒç”¨CNIæ’ä»¶</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token assign-left variable">CNI_CONTAINERID</span><span class="token operator">=</span><span class="token variable">$container_id</span> <span class="token assign-left variable">CNI_IFNAME</span><span class="token operator">=</span>eth10 <span class="token assign-left variable">CNI_COMMAND</span><span class="token operator">=</span>ADD <span class="token assign-left variable">CNI_NETNS</span><span class="token operator">=</span>/var/run/netns/<span class="token variable">$container_id</span> <span class="token assign-left variable">CNI_PATH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span> ./bridge <span class="token operator">&lt;</span>/tmp/00-demo.conf
<span class="token number">2020</span>/10/17 <span class="token number">17</span>:32:37 Error retriving last reserved ip: Failed to retrieve last reserved ip: <span class="token function">open</span> /var/lib/cni/networks/demo_br/last_reserved_ip: no such <span class="token function">file</span> or directory
<span class="token punctuation">{</span>
    <span class="token string">"ip4"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">"ip"</span><span class="token builtin class-name">:</span> <span class="token string">"10.0.10.2/24"</span>,
        <span class="token string">"gateway"</span><span class="token builtin class-name">:</span> <span class="token string">"10.0.10.1"</span>,
        <span class="token string">"routes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">"dst"</span><span class="token builtin class-name">:</span> <span class="token string">"0.0.0.0/0"</span>
            <span class="token punctuation">}</span>,
            <span class="token punctuation">{</span>
                <span class="token string">"dst"</span><span class="token builtin class-name">:</span> <span class="token string">"1.1.1.1/32"</span>,
                <span class="token string">"gw"</span><span class="token builtin class-name">:</span> <span class="token string">"10.0.10.1"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"dns"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '57.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '59.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>
