<template><div><ul>
<li><a href="http://nsddd.top" target="_blank" rel="noopener noreferrer">author<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬64èŠ‚-kubeadmæ¦‚è¿°ã€åŸç†ã€ä»¥åŠéƒ¨åˆ†æºç é˜…è¯»" tabindex="-1"><a class="header-anchor" href="#ç¬¬64èŠ‚-kubeadmæ¦‚è¿°ã€åŸç†ã€ä»¥åŠéƒ¨åˆ†æºç é˜…è¯»" aria-hidden="true">#</a> ç¬¬64èŠ‚ kubeadmæ¦‚è¿°ã€åŸç†ã€ä»¥åŠéƒ¨åˆ†æºç é˜…è¯»</h1>
<div><a href = '63.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '65.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<p>[TOC]</p>
<h2 id="kubeadm" tabindex="-1"><a class="header-anchor" href="#kubeadm" aria-hidden="true">#</a> kubeadm</h2>
<ul>
<li><a href="https://github.com/kubernetes/kubeadm/blob/main/docs/design/" target="_blank" rel="noopener noreferrer">github kubeadm design docs<ExternalLinkIcon/></a></li>
</ul>
<p>æˆ‘ä»¬åœ¨å‰é¢å‡ åä¸ªå°èŠ‚å­¦ä¹ ä¸­ä¹ŸçŸ¥é“äº† REST APIæ˜¯Kubernetesçš„åŸºæœ¬ç»“æ„ã€‚ç»„ä»¶å’Œå¤–éƒ¨ç”¨æˆ·å‘½ä»¤ä¹‹é—´çš„æ‰€æœ‰æ“ä½œå’Œé€šä¿¡éƒ½æ˜¯APIæœåŠ¡å™¨å¤„ç†çš„REST APIè°ƒç”¨ã€‚å› æ­¤ï¼ŒKuberneteså¹³å°ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½è¢«è§†ä¸ºAPIå¯¹è±¡ï¼Œå¹¶ä¸”åœ¨APIä¸­æœ‰ç›¸åº”çš„æ¡ç›®ã€‚</p>
<p>å¤§å¤šæ•°æ“ä½œéƒ½å¯ä»¥é€šè¿‡<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/kubectl_cli/overview_of_kubectl.html" target="_blank" rel="noopener noreferrer"><code v-pre>kubectl</code><ExternalLinkIcon/></a>å‘½ä»¤è¡Œç•Œé¢æˆ–å…¶ä»–å‘½ä»¤è¡Œå·¥å…·(å¦‚<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/overview_of_kubeadm.html" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm</code><ExternalLinkIcon/></a>)æ‰§è¡Œï¼Œè€Œè¿™äº›å·¥å…·åˆä½¿ç”¨APIã€‚ä¸è¿‡ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨RESTè°ƒç”¨ç›´æ¥è®¿é—®APIã€‚</p>
<p>Kubeadmæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒæä¾›<code v-pre>kubeadm init</code>å’Œ<code v-pre>kubeadm join</code>ä½œä¸ºåˆ›å»ºKubernetesé›†ç¾¤çš„æœ€ä½³å®è·µâ€œå¿«æ·è·¯å¾„â€ã€‚</p>
<blockquote>
<p>kubeadmæ˜¯ä¸€ä¸ªç”¨äºéƒ¨ç½²Kubernetesé›†ç¾¤çš„å·¥å…·ã€‚å®ƒè¢«è®¾è®¡ç”¨äºè‡ªåŠ¨åŒ–å¤§å¤šæ•°Kubernetesé›†ç¾¤çš„éƒ¨ç½²ä»»åŠ¡ï¼Œä»è€Œä½¿Kubernetesé›†ç¾¤çš„éƒ¨ç½²å˜å¾—æ›´åŠ ç®€å•å’Œé«˜æ•ˆã€‚kubeadmè´Ÿè´£åˆå§‹åŒ–MasterèŠ‚ç‚¹ï¼Œå¹¶åœ¨èŠ‚ç‚¹ä¸Šå®‰è£…Kubernetesç»„ä»¶ã€‚å®ƒè¿˜å¯ä»¥æ·»åŠ WorkerèŠ‚ç‚¹ï¼Œä»¥ä¾¿å°†å®ƒä»¬æ·»åŠ åˆ°é›†ç¾¤ä¸­ã€‚</p>
</blockquote>
<p>kubeadmæ‰§è¡Œå¿…è¦çš„æ“ä½œæ¥å¯åŠ¨å’Œè¿è¡Œæœ€å°å¯è¡Œé›†ç¾¤ã€‚æŒ‰ç…§è®¾è®¡ï¼Œå®ƒåªå…³å¿ƒå¼•å¯¼ï¼Œè€Œä¸å…³å¿ƒé…ç½®æœºå™¨ã€‚åŒæ ·ï¼Œå®‰è£…å„ç§æ¼‚äº®çš„æ’ä»¶(æ¯”å¦‚Kubernetes Dashboardã€ç›‘æ§è§£å†³æ–¹æ¡ˆå’Œç‰¹å®šäºäº‘çš„æ’ä»¶)ä¹Ÿä¸åœ¨è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚</p>
<p>ç›¸åï¼Œæˆ‘ä»¬æœŸæœ›åœ¨kubeadmçš„åŸºç¡€ä¸Šæ„å»ºæ›´é«˜çº§ã€æ›´å®šåˆ¶åŒ–çš„å·¥å…·ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œä½¿ç”¨kubeadmä½œä¸ºæ‰€æœ‰éƒ¨ç½²çš„åŸºç¡€å°†ä½¿åˆ›å»ºç¬¦åˆè§„èŒƒçš„é›†ç¾¤å˜å¾—æ›´å®¹æ˜“ã€‚</p>
<h2 id="kubeadm-init" tabindex="-1"><a class="header-anchor" href="#kubeadm-init" aria-hidden="true">#</a> kubeadm init</h2>
<p>æ­¤å‘½ä»¤ç”¨äºåˆå§‹åŒ–Kubernetesæ§åˆ¶å¹³é¢èŠ‚ç‚¹ã€‚</p>
<p><code v-pre>init</code>å‘½ä»¤æ‰§è¡Œä»¥ä¸‹é˜¶æ®µ:</p>
<ol>
<li><strong>preflight</strong> è¿è¡Œé¢„æ£€æŸ¥</li>
<li><strong>certs</strong>ï¼šè¯ä¹¦ç”Ÿæˆ
<ul>
<li><strong>/ca</strong> ç”Ÿæˆç”¨äºä¸ºå…¶ä»–Kubernetesç»„ä»¶æä¾›èº«ä»½çš„è‡ªç­¾åKubernetes CA</li>
<li><strong>/apiserver</strong> ç”Ÿæˆç”¨äºæä¾›Kubernetes APIçš„è¯ä¹¦</li>
<li><strong>/apiserver-kubelet-client</strong> ç”ŸæˆAPIæœåŠ¡å™¨ç”¨äºè¿æ¥kubeletçš„è¯ä¹¦</li>
<li><strong>/front-proxy-ca</strong> ç”Ÿæˆç”¨äºæä¾›å‰ç½®ä»£ç†èº«ä»½çš„è‡ªç­¾åCA</li>
<li><strong>/front-proxy-client</strong> ç”Ÿæˆå‰ç½®ä»£ç†å®¢æˆ·ç«¯è¯ä¹¦</li>
<li><strong>/etcd-ca</strong> ç”Ÿæˆç”¨äºä¸ºetcdæä¾›èº«ä»½çš„è‡ªç­¾åCA</li>
<li><strong>/etcd-server</strong> ç”Ÿæˆç”¨äºæä¾›etcdæœåŠ¡çš„è¯ä¹¦</li>
<li><strong>/etcd-peer</strong> ç”Ÿæˆä¾›etcdèŠ‚ç‚¹ç›¸äº’é€šä¿¡çš„è¯ä¹¦</li>
<li><strong>/etcd-healthcheck-client</strong> ç”Ÿæˆç”¨äºå¥åº·æ£€æŸ¥etcdçš„æ´»æ€§æ¢é’ˆè¯ä¹¦</li>
<li><strong>/apiserver-etcd-client</strong> ç”Ÿæˆapiserverç”¨äºè®¿é—®etcdçš„è¯ä¹¦</li>
<li><strong>/sa</strong> ç”Ÿæˆç”¨äºç­¾ç½²æœåŠ¡å¸æˆ·ä»¤ç‰Œçš„ç§é’¥åŠå…¶å…¬é’¥</li>
</ul>
</li>
<li><strong>kubeconfig</strong>ï¼šç”Ÿæˆæ‰€æœ‰kubeconfigæ–‡ä»¶ï¼Œä»¥å»ºç«‹æ§åˆ¶å¹³é¢å’Œç®¡ç†å‘˜kubeconfigæ–‡ä»¶
<ul>
<li><strong>/admin</strong> ä¸ºç®¡ç†å‘˜å’Œkubeadmæœ¬èº«ç”Ÿæˆkubeconfigæ–‡ä»¶</li>
<li><strong>/kubelet</strong> ä¸ºkubeletç”Ÿæˆkubeconfigæ–‡ä»¶ï¼Œä»…ç”¨äºé›†ç¾¤å¼•å¯¼ç›®çš„</li>
<li><strong>/controller-manager</strong> ä¸ºæ§åˆ¶å™¨ç®¡ç†å™¨ç”Ÿæˆkubeconfigæ–‡ä»¶</li>
<li><strong>/scheduler</strong> ä¸ºè°ƒåº¦å™¨ç”Ÿæˆkubeconfigæ–‡ä»¶</li>
</ul>
</li>
<li><strong>kubelet-start</strong> å†™å…¥kubeletè®¾ç½®å¹¶ï¼ˆé‡æ–°ï¼‰å¯åŠ¨kubelet</li>
<li><strong>control-plane</strong>ï¼šç”Ÿæˆæ‰€æœ‰é™æ€Podæ¸…å•æ–‡ä»¶ï¼Œä»¥å»ºç«‹æ§åˆ¶å¹³é¢
<ul>
<li><strong>/apiserver</strong> ç”Ÿæˆkube-apiserveré™æ€Podæ¸…å•</li>
<li><strong>/controller-manager</strong> ç”Ÿæˆkube-controller-manageré™æ€Podæ¸…å•</li>
<li><strong>/scheduler</strong> ç”Ÿæˆkube-scheduleré™æ€Podæ¸…å•</li>
</ul>
</li>
<li><strong>etcd</strong>ï¼šä¸ºæœ¬åœ°etcdç”Ÿæˆé™æ€Podæ¸…å•æ–‡ä»¶
<ul>
<li><strong>/local</strong> ä¸ºæœ¬åœ°å•èŠ‚ç‚¹etcdå®ä¾‹ç”Ÿæˆé™æ€Podæ¸…å•æ–‡ä»¶</li>
</ul>
</li>
<li><strong>upload-config</strong>ï¼šå°†kubeadmå’Œkubeleté…ç½®ä¸Šä¼ åˆ°ConfigMap
<ul>
<li><strong>/kubeadm</strong> å°†kubeadm ClusterConfigurationä¸Šä¼ åˆ°ConfigMap</li>
<li><strong>/kubelet</strong> å°†kubeletç»„ä»¶é…ç½®ä¸Šä¼ åˆ°ConfigMap</li>
</ul>
</li>
<li><strong>upload-certs</strong> å°†è¯ä¹¦ä¸Šä¼ åˆ°kubeadm-certs</li>
<li><strong>mark-control-plane</strong> å°†èŠ‚ç‚¹æ ‡è®°ä¸ºæ§åˆ¶å¹³é¢</li>
<li><strong>bootstrap-token</strong> ç”Ÿæˆç”¨äºå°†èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å¼•å¯¼ä»¤ç‰Œ</li>
<li><strong>kubelet-finalize</strong>ï¼šåœ¨TLSå¼•å¯¼åæ›´æ–°ä¸kubeletç›¸å…³çš„è®¾ç½®
<ul>
<li><strong>/experimental-cert-rotation</strong> å¯ç”¨kubeletå®¢æˆ·ç«¯è¯ä¹¦è½®æ¢</li>
</ul>
</li>
<li><strong>addon</strong>ï¼šå®‰è£…é€šè¿‡ä¸€è‡´æ€§æµ‹è¯•æ‰€éœ€çš„å¿…è¦æ’ä»¶
<ul>
<li><strong>/coredns</strong> å°†CoreDNSæ’ä»¶å®‰è£…åˆ°Kubernetesé›†ç¾¤</li>
<li><strong>/kube-proxy</strong> å°†kube-proxyæ’ä»¶å®‰è£…åˆ°Kubernetesé›†ç¾¤</li>
</ul>
</li>
<li><strong>show-join-command</strong> æ˜¾ç¤ºæ§åˆ¶å¹³é¢å’Œå·¥ä½œèŠ‚ç‚¹çš„åŠ å…¥å‘½ä»¤</li>
</ol>
<h3 id="é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#é€‰é¡¹" aria-hidden="true">#</a> é€‰é¡¹</h3>
<table>
<thead>
<tr>
<th>é€‰é¡¹</th>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>--apiserver-advertise-address</td>
<td>string</td>
<td>API Server å¹¿å‘Šå…¶ç›‘å¬çš„ IP åœ°å€ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ç½‘ç»œæ¥å£ã€‚</td>
</tr>
<tr>
<td>--apiserver-bind-port</td>
<td>int32</td>
<td>é»˜è®¤å€¼ï¼š6443ã€‚API Serverç»‘å®šçš„ç«¯å£ã€‚</td>
</tr>
<tr>
<td>--apiserver-cert-extra-sans</td>
<td>stringSlice</td>
<td>API Server æœåŠ¡è¯ä¹¦çš„å¯é€‰é¢å¤–ä¸»ä½“æ›¿ä»£åç§°ï¼ˆSANï¼‰ï¼Œå¯ä»¥æ˜¯ IP åœ°å€å’Œ DNS åç§°ã€‚</td>
</tr>
<tr>
<td>--cert-dir</td>
<td>string</td>
<td>é»˜è®¤å€¼ï¼š&quot;/etc/kubernetes/pki&quot;ã€‚</td>
</tr>
<tr>
<td>--certificate-key</td>
<td>string</td>
<td>ç”¨äºåŠ å¯† kubeadm-certs Secret ä¸­çš„æ§åˆ¶å¹³é¢è¯ä¹¦çš„å¯†é’¥ã€‚</td>
</tr>
<tr>
<td>--config</td>
<td>string</td>
<td>kubeadm é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚</td>
</tr>
<tr>
<td>--cri-socket</td>
<td>string</td>
<td>è¦è¿æ¥çš„CRIå¥—æ¥å­—çš„è·¯å¾„ã€‚å¦‚æœä¸ºç©ºï¼Œkubeadmå°†å°è¯•è‡ªåŠ¨æ£€æµ‹æ­¤å€¼ï¼›ä»…åœ¨å®‰è£…äº†å¤šä¸ªCRIæˆ–å­˜åœ¨éæ ‡å‡†CRIå¥—æ¥å­—æ—¶ä½¿ç”¨æ­¤é€‰é¡¹ã€‚</td>
</tr>
<tr>
<td>--dry-run</td>
<td></td>
<td>ä¸åº”ç”¨ä»»ä½•æ›´æ”¹ï¼›åªè¾“å‡ºå°†è¦æ‰§è¡Œçš„æ“ä½œã€‚</td>
</tr>
<tr>
<td>--experimental-upload-certs</td>
<td></td>
<td>ä¸Šä¼ æ§åˆ¶å¹³é¢è¯ä¹¦åˆ° kubeadm-certs Secretã€‚</td>
</tr>
<tr>
<td>--feature-gates</td>
<td>string</td>
<td>ä¸€ç»„é”®å€¼å¯¹ï¼Œæè¿°å„ç§åŠŸèƒ½çš„ç‰¹æ€§é—¨ã€‚å¯é€‰é¡¹ä¸ºï¼š</td>
</tr>
<tr>
<td>-h, --help</td>
<td></td>
<td>init çš„å¸®åŠ©ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td>--ignore-preflight-errors</td>
<td>stringSlice</td>
<td>è¦å°†å…¶é”™è¯¯æ˜¾ç¤ºä¸ºè­¦å‘Šçš„æ£€æŸ¥åˆ—è¡¨ã€‚ç¤ºä¾‹ï¼šâ€œIsPrivilegedUserï¼ŒSwapâ€ã€‚å€¼â€œallâ€ä¼šå¿½ç•¥æ‰€æœ‰æ£€æŸ¥çš„é”™è¯¯ã€‚</td>
</tr>
<tr>
<td>--image-repository</td>
<td>string</td>
<td>é»˜è®¤å€¼ï¼šâ€œhttp://k8s.gcr.io/â€ã€‚é€‰æ‹©ä¸€ä¸ªå®¹å™¨æ³¨å†Œè¡¨ä»¥æ‹‰å–æ§åˆ¶å¹³é¢æ˜ åƒã€‚</td>
</tr>
<tr>
<td>--kubernetes-version</td>
<td>string</td>
<td>é»˜è®¤å€¼ï¼šâ€œstable-1â€ã€‚ä¸ºæ§åˆ¶å¹³é¢é€‰æ‹©ç‰¹å®šçš„ Kubernetes ç‰ˆæœ¬ã€‚</td>
</tr>
<tr>
<td>--node-name</td>
<td>string</td>
<td>æŒ‡å®šèŠ‚ç‚¹åç§°ã€‚</td>
</tr>
<tr>
<td>--pod-network-cidr</td>
<td>string</td>
<td>æŒ‡å®š Pod ç½‘ç»œçš„ IP åœ°å€èŒƒå›´ã€‚å¦‚æœè®¾ç½®ï¼Œåˆ™æ§åˆ¶å¹³é¢å°†è‡ªåŠ¨ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é… CIDRã€‚</td>
</tr>
<tr>
<td>--service-cidr</td>
<td>string</td>
<td>é»˜è®¤å€¼ï¼šâ€œ10.96.0.0/12â€ã€‚ä½¿ç”¨æ›¿ä»£ IP åœ°å€èŒƒå›´æ¥è®¾ç½®æœåŠ¡ VIPã€‚</td>
</tr>
<tr>
<td>--service-dns-domain</td>
<td>string</td>
<td>é»˜è®¤å€¼ï¼šâ€œcluster.localâ€ã€‚ä½¿ç”¨æ›¿ä»£åŸŸåä¸ºæœåŠ¡å‘½åï¼Œä¾‹å¦‚â€œmyorg.internalâ€ã€‚</td>
</tr>
<tr>
<td>--skip-certificate-key-print</td>
<td></td>
<td>ä¸æ‰“å°ç”¨äºåŠ å¯†æ§åˆ¶å¹³é¢è¯ä¹¦çš„å¯†é’¥ã€‚</td>
</tr>
<tr>
<td>--skip-phases</td>
<td>stringSlice</td>
<td>è¦è·³è¿‡çš„é˜¶æ®µåˆ—è¡¨ã€‚</td>
</tr>
<tr>
<td>--skip-token-print</td>
<td></td>
<td>è·³è¿‡æ‰“å°ç”±â€œkubeadm initâ€ç”Ÿæˆçš„é»˜è®¤å¼•å¯¼ä»¤ç‰Œã€‚</td>
</tr>
<tr>
<td>--token</td>
<td>string</td>
<td>ç”¨äºåœ¨èŠ‚ç‚¹å’Œæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¹‹é—´å»ºç«‹åŒå‘ä¿¡ä»»çš„ä»¤ç‰Œã€‚æ ¼å¼ä¸º[a-z0-9] {6}ã€‚[a-z0-9] {16} - ä¾‹å¦‚abcdef.0123456789abcdef</td>
</tr>
<tr>
<td>--token-ttl duration</td>
<td></td>
<td>é»˜è®¤å€¼ï¼š24h0m0sã€‚ä»¤ç‰Œè‡ªåŠ¨åˆ é™¤ä¹‹å‰çš„æŒç»­æ—¶é—´ï¼ˆä¾‹å¦‚1sï¼Œ2mï¼Œ3hï¼‰ã€‚å¦‚æœè®¾ç½®ä¸ºâ€œ0â€ï¼Œåˆ™ä»¤ç‰Œæ°¸ä¸è¿‡æœŸã€‚</td>
</tr>
</tbody>
</table>
<h3 id="ä»çˆ¶å‘½ä»¤ç»§æ‰¿çš„é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#ä»çˆ¶å‘½ä»¤ç»§æ‰¿çš„é€‰é¡¹" aria-hidden="true">#</a> ä»çˆ¶å‘½ä»¤ç»§æ‰¿çš„é€‰é¡¹</h3>
<table>
<thead>
<tr>
<th style="text-align:left">é€‰é¡¹</th>
<th style="text-align:left">ç±»å‹</th>
<th style="text-align:left">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">--rootfs</td>
<td style="text-align:left">string</td>
<td style="text-align:left">[EXPERIMENTAL] The path to the 'real' host root filesystem.</td>
</tr>
</tbody>
</table>
<h3 id="åˆå§‹åŒ–æµç¨‹" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–æµç¨‹" aria-hidden="true">#</a> åˆå§‹åŒ–æµç¨‹</h3>
<h4 id="pre-flifht-æ£€æŸ¥" tabindex="-1"><a class="header-anchor" href="#pre-flifht-æ£€æŸ¥" aria-hidden="true">#</a> pre-flifht æ£€æŸ¥</h4>
<p>åœ¨æ‰§è¡Œ kubeadm init å‘½ä»¤ä¹‹å‰ï¼Œkubeadm ä¼šè¿è¡Œä¸€ä¸ª preflight é˜¶æ®µï¼Œç”¨äºæ£€æŸ¥é›†ç¾¤èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³ Kubernetes çš„æœ€ä½è¦æ±‚ã€‚åœ¨ preflight é˜¶æ®µä¸­ï¼Œkubeadm ä¼šæ ¹æ®ç”¨æˆ·æä¾›çš„é€‰é¡¹æ¥æ‰§è¡Œä¸€ç³»åˆ—æ£€æŸ¥ï¼Œä»¥ç¡®ä¿ Kubernetes æ§åˆ¶å¹³é¢çš„æ­£å¸¸è¿è¡Œã€‚</p>
<p>å¸¸ç”¨çš„ preflight é˜¶æ®µé€‰é¡¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>-configï¼šæŒ‡å®š kubeadm é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼›</li>
<li>-cri-socketï¼šæŒ‡å®šå®¹å™¨è¿è¡Œæ—¶ï¼ˆCRIï¼‰çš„ socket æ–‡ä»¶è·¯å¾„ï¼›</li>
<li>-skip-phasesï¼šè·³è¿‡ preflight é˜¶æ®µä¸­çš„æŸäº›æ£€æŸ¥é˜¶æ®µï¼›</li>
<li>-ignore-preflight-errorsï¼šå¿½ç•¥ preflight é˜¶æ®µä¸­çš„æŸäº›é”™è¯¯ã€‚</li>
</ul>
<h4 id="certificate-ç”Ÿæˆé˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#certificate-ç”Ÿæˆé˜¶æ®µ" aria-hidden="true">#</a> certificate ç”Ÿæˆé˜¶æ®µ</h4>
<p>åœ¨åˆå§‹åŒ– Kubernetes æ§åˆ¶å¹³é¢æ—¶ï¼Œkubeadm è¿˜ä¼šè‡ªåŠ¨ä¸º Kubernetes ç»„ä»¶ç”Ÿæˆ TLS è¯ä¹¦å’Œç§˜é’¥ã€‚è¿™äº›è¯ä¹¦å’Œç§˜é’¥ç”¨äºç¡®ä¿ Kubernetes ç»„ä»¶ä¹‹é—´çš„å®‰å…¨é€šä¿¡ã€‚</p>
<p>ç”Ÿæˆè‡ªç­¾åCAï¼ˆå¦‚æœæä¾›äº†ï¼Œåˆ™ä½¿ç”¨ç°æœ‰CAï¼‰ï¼Œä¸ºé›†ç¾¤ä¸­çš„æ¯ä¸ªç»„ä»¶è®¾ç½®æ ‡è¯†ã€‚å¦‚æœç”¨æˆ·æä¾›äº†è‡ªå·±çš„CAè¯ä¹¦å’Œ/æˆ–å¯†é’¥ï¼Œå¹¶å°†å…¶æ”¾å…¥é€šè¿‡ <code v-pre>--cert-dir</code> é€‰é¡¹ï¼ˆé»˜è®¤å€¼ä¸º<code v-pre>/etc/kubernetes/pki</code> ï¼‰é…ç½®çš„è¯ä¹¦ç›®å½•ä¸­ã€‚å¯ä»¥æŒ‰ç…§<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#zidingyizhengshu" target="_blank" rel="noopener noreferrer">ä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦<ExternalLinkIcon/></a>æ–‡æ¡£ä¸­çš„æè¿°è·³è¿‡æ­¤æ­¥éª¤ã€‚APIæœåŠ¡å™¨è¯ä¹¦æ‹¥æœ‰ç”¨äº <code v-pre>--apiserver-cert-extra-sans</code>å‚æ•°ï¼ˆå¿…è¦æ—¶å°å†™ï¼‰çš„é¢å¤–SANæ¡ç›®ã€‚</p>
<h4 id="ç”Ÿæˆ-kubeconfig-æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#ç”Ÿæˆ-kubeconfig-æ–‡ä»¶" aria-hidden="true">#</a> ç”Ÿæˆ kubeconfig æ–‡ä»¶</h4>
<p>å°†kubeconfigæ–‡ä»¶å†™åˆ°<code v-pre>/etc/kubernetes/</code>ä¸­ï¼Œä¾›kubeletã€æ§åˆ¶å™¨-ç®¡ç†å™¨å’Œè°ƒåº¦å™¨è¿æ¥APIæœåŠ¡å™¨ï¼Œæ¯ä¸ªkubeconfigæ–‡ä»¶éƒ½æœ‰è‡ªå·±çš„æ ‡è¯†ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªåä¸º<code v-pre>admin.conf</code>çš„kubeconfigæ–‡ä»¶ç”¨äºç®¡ç†ã€‚</p>
<h4 id="pod" tabindex="-1"><a class="header-anchor" href="#pod" aria-hidden="true">#</a> pod</h4>
<p>ä¸ºAPIæœåŠ¡å™¨ã€æ§åˆ¶å™¨ç®¡ç†å™¨å’Œè°ƒåº¦å™¨ç”Ÿæˆé™æ€Podæ¸…å•ã€‚å¦‚æœæ²¡æœ‰æä¾›å¤–éƒ¨etcdï¼Œåˆ™ä¸ºetcdç”Ÿæˆé¢å¤–çš„é™æ€Podæ¸…å•ã€‚</p>
<p>é™æ€Podæ¸…å•è¢«å†™å…¥<code v-pre>/etc/kubernetes/manifests</code>ï¼›kubeletç›‘è§†è¿™ä¸ªç›®å½•ï¼Œä»¥ä¾¿åœ¨å¯åŠ¨æ—¶åˆ›å»ºpodã€‚</p>
<p>ä¸€æ—¦æ§åˆ¶å¹³é¢podå¯åŠ¨å¹¶è¿è¡Œï¼Œ<code v-pre>kubeadm init</code>æµç¨‹å°±å¯ä»¥ç»§ç»­ã€‚</p>
<ol>
<li>
<p>å°†æ ‡ç­¾å’Œæ±¡æŸ“åº”ç”¨åˆ°æ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œè¿™æ ·å°±ä¸ä¼šåœ¨é‚£é‡Œè¿è¡Œé¢å¤–çš„å·¥ä½œè´Ÿè½½ã€‚</p>
</li>
<li>
<p>ç”Ÿæˆä»¤ç‰Œï¼Œé¢å¤–çš„èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨è¯¥ä»¤ç‰Œåœ¨å°†æ¥å‘æ§åˆ¶å¹³é¢æ³¨å†Œè‡ªå·±ã€‚ç”¨æˆ·å¯ä»¥é€‰æ‹©é€šè¿‡<code v-pre>--token</code>é€‰é¡¹æä¾›ä»¤ç‰Œï¼Œå¦‚<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_token.html" target="_blank" rel="noopener noreferrer">kubeadm token<ExternalLinkIcon/></a>æ–‡æ¡£ä¸­æ‰€è¿°ã€‚</p>
</li>
<li>
<p>é…ç½®æ‰€æœ‰å¿…è¦çš„é…ç½®ï¼Œå…è®¸èŠ‚ç‚¹ä½¿ç”¨<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/authenticating_with_bootstrap_tokens.html" target="_blank" rel="noopener noreferrer">å¼•å¯¼ä»¤ç‰Œ<ExternalLinkIcon/></a>å’Œ<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/command_line_tools_reference/tls_bootstrapping.html" target="_blank" rel="noopener noreferrer">TLSå¼•å¯¼<ExternalLinkIcon/></a>æœºåˆ¶åŠ å…¥é›†ç¾¤ï¼š</p>
<ul>
<li>ç¼–å†™ä¸€ä¸ªConfigMapæ¥æä¾›åŠ å…¥é›†ç¾¤æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶è®¾ç½®ç›¸å…³çš„RBACè®¿é—®è§„åˆ™ã€‚</li>
<li>ä½¿å¼•å¯¼ä»¤ç‰Œè®¿é—®CSRç­¾åAPIã€‚</li>
<li>ä¸ºæ–°çš„CSRè¯·æ±‚é…ç½®è‡ªåŠ¨æ‰¹å‡†ã€‚</li>
</ul>
<p>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_join.html" target="_blank" rel="noopener noreferrer">kubeadm join<ExternalLinkIcon/></a>ã€‚</p>
</li>
<li>
<p>é€šè¿‡APIæœåŠ¡å™¨å®‰è£…DNSæœåŠ¡å™¨(CoreDNS)å’Œkube-proxyæ’ä»¶ç»„ä»¶ã€‚åœ¨Kubernetes v1.11å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒCoreDNSæ˜¯é»˜è®¤çš„DNSæœåŠ¡å™¨ã€‚å¦‚æœä½ è¦å®‰è£…kube-dnsè€Œä¸æ˜¯CoreDNSï¼Œå¿…é¡»åœ¨kubeadm <code v-pre>ClusterConfiguration</code>é…ç½®DNSæ’ä»¶ã€‚</p>
</li>
</ol>
<h3 id="ä½¿ç”¨kubeadmçš„åˆå§‹åŒ–é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨kubeadmçš„åˆå§‹åŒ–é˜¶æ®µ" aria-hidden="true">#</a> ä½¿ç”¨kubeadmçš„åˆå§‹åŒ–é˜¶æ®µ</h3>
<p>Kubeadmå…è®¸ä½ åˆ†é˜¶æ®µåˆ›å»ºä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ã€‚åœ¨v1.13ä¸­ï¼Œ<code v-pre>kubeadm init phase</code>å‘½ä»¤å·²ç»ä»alphaçº§åˆ«çš„<code v-pre>kubeadm alpha phase</code>å‡çº§åˆ°äº†GAçº§åˆ«ã€‚</p>
<p>è¦æŸ¥çœ‹æœ‰åºçš„é˜¶æ®µå’Œå­é˜¶æ®µåˆ—è¡¨ï¼Œå¯ä»¥è°ƒç”¨<code v-pre>kubeadm init --help</code>ã€‚åˆ—è¡¨å°†ä½äºå¸®åŠ©ä¿¡æ¯çš„é¡¶éƒ¨ï¼Œæ¯ä¸ªé˜¶æ®µæ—è¾¹éƒ½æœ‰ä¸€ä¸ªæè¿°ã€‚æ³¨æ„ï¼Œé€šè¿‡è°ƒç”¨<code v-pre>kubeadm init</code>ï¼Œæ‰€æœ‰é˜¶æ®µå’Œå­é˜¶æ®µéƒ½å°†æŒ‰ç…§è¿™ä¸ªé¡ºåºæ‰§è¡Œã€‚</p>
<p>æœ‰äº›é˜¶æ®µæœ‰ç‹¬ç‰¹çš„é€‰é¡¹ï¼Œå¦‚æœä½ æƒ³æŸ¥çœ‹å¯ç”¨çš„é€‰é¡¹åˆ—è¡¨ï¼Œè¯·æ·»åŠ <code v-pre>--help</code>ï¼Œä¾‹å¦‚:</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">sudo</span> kubeadm init phase control-plane controller-manager <span class="token parameter variable">--help</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä½ è¿˜å¯ä»¥ä½¿ç”¨<code v-pre>--help</code>æŸ¥çœ‹ç‰¹å®šçˆ¶é˜¶æ®µçš„å­é˜¶æ®µåˆ—è¡¨:</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">sudo</span> kubeadm init phase control-plane <span class="token parameter variable">--help</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code v-pre>kubeadm init</code>è¿˜æš´éœ²äº†ä¸€ä¸ªåä¸º<code v-pre>--skip-phase</code>çš„é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å¯ç”¨äºè·³è¿‡æŸäº›é˜¶æ®µã€‚è¯¥é€‰é¡¹æ¥å—ä¸€ä¸ªé˜¶æ®µåç§°åˆ—è¡¨ï¼Œè¿™äº›åç§°å¯ä»¥ä»ä¸Šé¢çš„æœ‰åºåˆ—è¡¨ä¸­è·å–ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">sudo</span> kubeadm init phase control-plane all <span class="token parameter variable">--config</span><span class="token operator">=</span>configfile.yaml
<span class="token function">sudo</span> kubeadm init phase etcd <span class="token builtin class-name">local</span> <span class="token parameter variable">--config</span><span class="token operator">=</span>configfile.yaml
<span class="token comment"># you can now modify the control plane and etcd manifest files</span>
<span class="token function">sudo</span> kubeadm init --skip-phases<span class="token operator">=</span>control-plane,etcd <span class="token parameter variable">--config</span><span class="token operator">=</span>configfile.yaml
<span class="token function">sudo</span> kubeadm init phase control-plane all <span class="token parameter variable">--config</span><span class="token operator">=</span>configfile.yaml
<span class="token function">sudo</span> kubeadm init phase etcd <span class="token builtin class-name">local</span> <span class="token parameter variable">--config</span><span class="token operator">=</span>configfile.yaml
<span class="token comment"># you can now modify the control plane and etcd manifest files</span>
<span class="token function">sudo</span> kubeadm init --skip-phases<span class="token operator">=</span>control-plane,etcd <span class="token parameter variable">--config</span><span class="token operator">=</span>configfile.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥ç¤ºä¾‹å°†ç¼–å†™åŸºäº<code v-pre>configfile.yaml</code>ä¸­çš„é…ç½®ï¼Œä½äº<code v-pre>/etc/kubernetes/manifests</code>ä¸­çš„æ¸…å•æ–‡ä»¶ã€‚è¿™å…è®¸ä½ ä¿®æ”¹æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨<code v-pre>--skip-phases</code>é€‰é¡¹è·³è¿‡è¿™äº›é˜¶æ®µã€‚é€šè¿‡è°ƒç”¨æœ€åä¸€ä¸ªå‘½ä»¤ï¼Œä½ å°†åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è‡ªå®šä¹‰æ¸…å•æ–‡ä»¶çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ã€‚</p>
<h3 id="ä¸ºkubeadm-initæŒ‡å®šé…ç½®æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#ä¸ºkubeadm-initæŒ‡å®šé…ç½®æ–‡ä»¶" aria-hidden="true">#</a> ä¸ºkubeadm initæŒ‡å®šé…ç½®æ–‡ä»¶</h3>
<p>å¯ä»¥ç”¨é…ç½®æ–‡ä»¶è€Œä¸æ˜¯å‘½ä»¤è¡Œé€‰é¡¹æ¥é…ç½®<code v-pre>kubeadm init</code>ï¼Œä¸€äº›æ›´é«˜çº§çš„ç‰¹æ€§å¯èƒ½åªä½œä¸ºé…ç½®æ–‡ä»¶é€‰é¡¹ä½¿ç”¨ã€‚è¯¥æ–‡ä»¶é€šè¿‡ <code v-pre>--config</code> é€‰é¡¹ä¼ é€’ã€‚</p>
<h4 id="å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é•œåƒ" tabindex="-1"><a class="header-anchor" href="#å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é•œåƒ" aria-hidden="true">#</a> å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é•œåƒ</h4>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadmä» <code v-pre>k8s.gcr.io</code>ä¸­æ‹‰å–é•œåƒï¼Œé™¤éè¯·æ±‚çš„Kubernetesç‰ˆæœ¬æ˜¯CIç‰ˆæœ¬ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°†ä½¿ç”¨ <code v-pre>gcr.io/kubernetes-ci-images</code> ã€‚</p>
<p>è¿™ç§æƒ…å†µä¸‹åœ¨å›½å†…å¯èƒ½ä¼šå‡ºç°æ‹‰å– over time</p>
<p>ä½ å¯ä»¥å‘kubeadmæŒ‡å®šä¸€ä¸ªé…ç½®æ–‡ä»¶è¦†ç›–æ­¤è¡Œä¸ºã€‚å…è®¸è‡ªå®šä¹‰æœ‰ï¼š</p>
<ul>
<li>æä¾›ä¸€ä¸ªæ›¿ä»£ <code v-pre>k8s.gcr.io</code>çš„<code v-pre>imageRepository</code>ã€‚</li>
<li>å°†<code v-pre>useHyperKubeImage</code>è®¾ç½®ä¸º<code v-pre>true</code>ä»¥ä½¿ç”¨HyperKubeå›¾åƒã€‚</li>
<li>ä¸ºetcdæˆ–DNSæ’ä»¶æä¾›ç‰¹å®šçš„<code v-pre>imageRepository</code>å’Œ<code v-pre>imageTag</code>ã€‚</li>
</ul>
<p>è¯·æ³¨æ„ï¼Œé…ç½®å­—æ®µ<code v-pre>kubernetesVersion</code>å’Œå‘½ä»¤è¡Œé€‰é¡¹ <code v-pre>--kubernetes-version</code> éƒ½ä¼šå½±å“é•œåƒçš„ç‰ˆæœ¬ã€‚</p>
<h3 id="ä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦" aria-hidden="true">#</a> ä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦</h3>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadmç”Ÿæˆé›†ç¾¤è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰è¯ä¹¦ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡æä¾›è‡ªå·±çš„è¯ä¹¦æ¥è¦†ç›–æ­¤è¡Œä¸ºã€‚</p>
<p>ä¸ºæ­¤ï¼Œä½ å¿…é¡»å°†å®ƒä»¬æ”¾åœ¨ç”± <code v-pre>--cert-dir</code>é€‰é¡¹æˆ– <code v-pre>CertificatesDir</code>é…ç½®æ–‡ä»¶é”®æŒ‡å®šçš„ç›®å½•ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥ç›®å½•ä¸º<code v-pre>/etc/kubernetes/pki</code>ã€‚</p>
<p>å¦‚æœå­˜åœ¨ç»™å®šçš„è¯ä¹¦å’Œç§é’¥å¯¹ï¼Œkubeadmå°†è·³è¿‡ç”Ÿæˆæ­¥éª¤ï¼Œä½¿ç”¨ç°æœ‰æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥å°†ç°æœ‰çš„CAå¤åˆ¶åˆ° <code v-pre>/etc/kubernetes/pki/ca.crt</code>å’Œ <code v-pre>/etc/kubernetes/pki/ca.key</code>ï¼Œkubeadmå°†ä½¿ç”¨æ­¤CAç­¾ç½²å…¶ä½™çš„è¯ä¹¦ã€‚</p>
<h4 id="å¤–éƒ¨caæ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#å¤–éƒ¨caæ¨¡å¼" aria-hidden="true">#</a> å¤–éƒ¨CAæ¨¡å¼</h4>
<p>ä¹Ÿå¯ä»¥åªæä¾›<code v-pre>ca.crt</code> æ–‡ä»¶ï¼Œè€Œä¸æä¾›<code v-pre>ca.key</code>æ–‡ä»¶ï¼ˆè¿™åªé€‚ç”¨äºæ ¹CAæ–‡ä»¶ï¼Œä¸é€‚ç”¨äºå…¶ä»–è¯ä¹¦å¯¹ï¼‰ã€‚å¦‚æœæ‰€æœ‰å…¶ä»–è¯ä¹¦å’Œkubeconfigæ–‡ä»¶éƒ½åˆ°ä½ï¼Œkubeadmå°†è¯†åˆ«æ­¤æ¡ä»¶å¹¶æ¿€æ´»â€œå¤–éƒ¨CAâ€æ¨¡å¼ã€‚kubeadmå°†åœ¨ç£ç›˜ä¸Šæ²¡æœ‰CAå¯†é’¥çš„æƒ…å†µä¸‹ç»§ç»­æ‰§è¡Œã€‚</p>
<p>ç›¸åï¼Œä½¿ç”¨ <code v-pre>--controllers=csrsigner</code>ç‹¬ç«‹è¿è¡Œæ§åˆ¶å™¨ç®¡ç†å™¨ï¼Œå¹¶æŒ‡å‘CAè¯ä¹¦å’Œå¯†é’¥ã€‚</p>
<h3 id="æŒ‡å®š-cri" tabindex="-1"><a class="header-anchor" href="#æŒ‡å®š-cri" aria-hidden="true">#</a> æŒ‡å®š CRI</h3>
<p>ä»v1.6.0å¼€å§‹ï¼ŒKuberneteså°±é»˜è®¤å¯ç”¨äº†CRIå®¹å™¨è¿è¡Œæ—¶æ¥å£ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶æ˜¯Dockerï¼Œå®ƒæ˜¯é€šè¿‡<code v-pre>kubelet</code>å†…ç½®çš„<code v-pre>dockershim </code>CRIå¯ç”¨çš„ã€‚</p>
<p>ä» Kubernetes 1.20 å¼€å§‹ï¼Œé»˜è®¤å®¹å™¨è¿è¡Œæ—¶ä¸º <code v-pre>containerd</code>ï¼Œè€Œä¹‹å‰çš„ç‰ˆæœ¬é»˜è®¤å®¹å™¨è¿è¡Œæ—¶ä¸º <code v-pre>Docker</code>ã€‚</p>
<p>æˆåŠŸå®‰è£…<code v-pre>kubeadm</code>å’Œ<code v-pre>kubelet</code>ä¹‹åï¼Œæ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªé¢å¤–æ­¥éª¤:</p>
<ol>
<li>
<p>æŒ‰ç…§ä¸Šé¢è¿è¡Œæ—¶shimé¡¹ç›®æ¸…å•ä¸­çš„å®‰è£…æ–‡æ¡£ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå®‰è£…è¿è¡Œæ—¶shimã€‚</p>
</li>
<li>
<p>é…ç½®kubeletä½¿ç”¨è¿œç¨‹CRIè¿è¡Œæ—¶ã€‚è¯·è®°ä½å°†<code v-pre>RUNTIME_ENDPOINT</code>æ›´æ”¹ä¸ºä½ è‡ªå·±çš„å€¼ï¼Œæ¯”å¦‚ <code v-pre>/var/run/{your_runtime}.sock</code>ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">></span> /etc/systemd/system/kubelet.service.d/20-cri.conf <span class="token operator">&lt;&lt;</span>EOF<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>Environment<span class="token operator">=</span><span class="token string">"KUBELET_EXTRA_ARGS=--container-runtime=remote --container-runtime-endpoint=<span class="token variable">$RUNTIME_ENDPOINT</span>"</span>EOFsystemctl daemon-reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li>
</ol>
<p>ç°åœ¨<code v-pre>kubelet</code>å·²ç»å‡†å¤‡å¥½ä½¿ç”¨æŒ‡å®šçš„CRIè¿è¡Œæ—¶ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨<code v-pre>kubeadm init</code>å’Œ<code v-pre>kubeadm join</code>æ¥éƒ¨ç½²Kubernetesé›†ç¾¤ã€‚</p>
<p>åœ¨ä½¿ç”¨å¤–éƒ¨CRIå®ç°æ—¶ï¼Œè¯·å°†åœ¨æ‰§è¡Œ <code v-pre>kubeadm init</code> å’Œ<code v-pre>kubeadm reset</code>æ—¶æ·»åŠ  <code v-pre>--cri-socket</code> é€‰é¡¹ã€‚</p>
<h3 id="ç¦»çº¿è¿è¡Œ-kubeadm" tabindex="-1"><a class="header-anchor" href="#ç¦»çº¿è¿è¡Œ-kubeadm" aria-hidden="true">#</a> ç¦»çº¿è¿è¡Œ kubeadm</h3>
<p>è¦åœ¨æ²¡æœ‰äº’è”ç½‘è¿æ¥çš„æƒ…å†µä¸‹è¿è¡Œkubeadmï¼Œä½ å¿…é¡»é¢„å…ˆæ‹‰å–æ‰€éœ€çš„æ§åˆ¶å¹³é¢é•œåƒã€‚</p>
<p>åœ¨Kubernetes v1.11å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code v-pre>kubeadm config images</code>çš„å­å‘½ä»¤è·å–å’Œæ‹‰å–é•œåƒ:</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ ./kubeadm config images list

W0319 <span class="token number">15</span>:08:46.559718   <span class="token number">50461</span> version.go:112<span class="token punctuation">]</span> could not obtain neither client nor remote version<span class="token punctuation">;</span> fall back to: <span class="token number">1.0</span>.0-placeholder-version
W0319 <span class="token number">15</span>:08:46.561620   <span class="token number">50461</span> images.go:80<span class="token punctuation">]</span> could not <span class="token function">find</span> officially supported version of etcd <span class="token keyword">for</span> Kubernetes v1.0.0-placeholder-version, falling back
to the nearest etcd version <span class="token punctuation">(</span><span class="token number">3.2</span>.24<span class="token punctuation">)</span>
registry.k8s.io/kube-apiserver:v1.0.0-placeholder-version
registry.k8s.io/kube-controller-manager:v1.0.0-placeholder-version
registry.k8s.io/kube-scheduler:v1.0.0-placeholder-version
registry.k8s.io/kube-proxy:v1.0.0-placeholder-version
registry.k8s.io/pause:3.9
registry.k8s.io/etcd:3.2.24
registry.k8s.io/coredns/coredns:v1.10.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‹‰å–ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>kubeadm config images pull
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="kubeadm-join" tabindex="-1"><a class="header-anchor" href="#kubeadm-join" aria-hidden="true">#</a> kubeadm join</h2>
<p>è¯¥å‘½ä»¤åˆå§‹åŒ–Kuberneteså·¥ä½œèŠ‚ç‚¹å¹¶å°†å…¶åŠ å…¥åˆ°é›†ç¾¤ã€‚åœ¨å¸Œæœ›åŠ å…¥ç°æœ‰é›†ç¾¤çš„æ‰€æœ‰æœºå™¨ä¸Šè¿è¡Œæ­¤æ“ä½œã€‚</p>
<p><code v-pre>kubeadm init</code> å’Œ <code v-pre>kubeadm join</code> ä¸€èµ·æä¾›äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œå¯ä»¥ä»å¤´å¼€å§‹åˆ›å»ºæœ€ä½³å®è·µçš„è£¸Kubernetesé›†ç¾¤ã€‚ç„¶è€Œï¼Œkubeadmæ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„ï¼Œå¯èƒ½å¹¶ä¸æ˜æ˜¾ã€‚</p>
<p>åœ¨åŠ å…¥ç”±kubeadmåˆå§‹åŒ–çš„é›†ç¾¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹åŒå‘ä¿¡ä»»ã€‚è¿™åˆ†ä¸º<em><strong>å‘ç°</strong></em>ï¼ˆè®©èŠ‚ç‚¹ä¿¡ä»»Kubernetesæ§åˆ¶å¹³é¢ï¼‰å’Œ<em>TLS<strong>å¼•å¯¼</strong></em>(è®©Kubernetesæ§åˆ¶å¹³é¢ä¿¡ä»»èŠ‚ç‚¹)ã€‚</p>
<p>æœ‰ä¸¤ç§ä¸»è¦çš„å‘ç°æ–¹æ¡ˆã€‚ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨å…±äº«ä»¤ç‰Œå’ŒAPIæœåŠ¡å™¨çš„IPåœ°å€ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯æä¾›ä¸€ä¸ªæ–‡ä»¶â€”â€”æ ‡å‡†kubeconfigæ–‡ä»¶çš„å­é›†ã€‚è¯¥æ–‡ä»¶å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡HTTPS URLä¸‹è½½ã€‚å½¢å¼ä¸º<code v-pre>kubeadm join --discovery-token abcdef.1234567890abcdef 1.2.3.4:6443</code>ã€ <code v-pre>kubeadm join --discovery-file path/to/file.conf</code>æˆ–<code v-pre>kubeadm join --discovery-file https://url/file.conf</code>ã€‚åªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ç§å½¢å¼ã€‚å¦‚æœå‘ç°ä¿¡æ¯æ˜¯ä»URLåŠ è½½çš„ï¼Œåˆ™å¿…é¡»ä½¿ç”¨HTTPSã€‚æ­¤å¤–ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨å·²å®‰è£…çš„ä¸»æœºCAåŒ…éªŒè¯è¿æ¥ã€‚</p>
<h3 id="å‘½ä»¤é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤é˜¶æ®µ" aria-hidden="true">#</a> å‘½ä»¤é˜¶æ®µ</h3>
<p><code v-pre>join [api-server-endpoint]</code>å‘½ä»¤æ‰§è¡Œä»¥ä¸‹é˜¶æ®µ:</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code>The <span class="token string">"join [api-server-endpoint]"</span> command executes the <span class="token keyword">following</span> phases:
<span class="token identifier"><span class="token punctuation">`</span><span class="token punctuation">`</span></span><span class="token punctuation">`</span>
preflight              Run <span class="token keyword">join</span> pre<span class="token operator">-</span>flight checks
control<span class="token operator">-</span>plane<span class="token operator">-</span><span class="token keyword">prepare</span>  <span class="token keyword">Prepare</span> the machine <span class="token keyword">for</span> serving a control plane
  <span class="token operator">/</span>download<span class="token operator">-</span>certs        <span class="token punctuation">[</span>EXPERIMENTAL<span class="token punctuation">]</span> Download certificates shared among control<span class="token operator">-</span>plane nodes <span class="token keyword">from</span> the kubeadm<span class="token operator">-</span>certs Secret
  <span class="token operator">/</span>certs                 Generate the certificates <span class="token keyword">for</span> the new control plane components
  <span class="token operator">/</span>kubeconfig            Generate the kubeconfig <span class="token keyword">for</span> the new control plane components
  <span class="token operator">/</span>control<span class="token operator">-</span>plane         Generate the manifests <span class="token keyword">for</span> the new control plane components
kubelet<span class="token operator">-</span><span class="token keyword">start</span>          <span class="token keyword">Write</span> kubelet settings<span class="token punctuation">,</span> certificates <span class="token operator">and</span> <span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token keyword">start</span> the kubelet
control<span class="token operator">-</span>plane<span class="token operator">-</span><span class="token keyword">join</span>     <span class="token keyword">Join</span> a machine <span class="token keyword">as</span> a control plane instance
  <span class="token operator">/</span>etcd                  <span class="token keyword">Add</span> a new <span class="token keyword">local</span> etcd member
  <span class="token operator">/</span><span class="token keyword">update</span><span class="token operator">-</span><span class="token keyword">status</span>         Register the new control<span class="token operator">-</span>plane node <span class="token keyword">into</span> the ClusterStatus maintained <span class="token operator">in</span> the kubeadm<span class="token operator">-</span>config ConfigMap <span class="token punctuation">(</span>DEPRECATED<span class="token punctuation">)</span>
  <span class="token operator">/</span>mark<span class="token operator">-</span>control<span class="token operator">-</span>plane    Mark a node <span class="token keyword">as</span> a control<span class="token operator">-</span>plane
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li><code v-pre>preflight</code>ï¼šè¿è¡ŒåŠ å…¥å‰æ£€æŸ¥</li>
<li><code v-pre>control-plane-prepare</code>ï¼šå‡†å¤‡æœºå™¨ä»¥æœåŠ¡äºæ§åˆ¶å¹³é¢</li>
<li>
<ul>
<li><code v-pre>/download-certs</code>ï¼š[å®éªŒæ€§] ä» kubeadm-certs Secret ä¸‹è½½æ§åˆ¶å¹³é¢èŠ‚ç‚¹é—´å…±äº«çš„è¯ä¹¦</li>
<li><code v-pre>/certs</code>ï¼šä¸ºæ–°çš„æ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆè¯ä¹¦</li>
<li><code v-pre>/kubeconfig</code>ï¼šä¸ºæ–°çš„æ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆ kubeconfig</li>
<li><code v-pre>/control-plane</code>ï¼šä¸ºæ–°çš„æ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆæ¸…å•</li>
</ul>
</li>
<li><code v-pre>kubelet-start</code>ï¼šç¼–å†™ kubelet è®¾ç½®ï¼Œè¯ä¹¦å¹¶å¯åŠ¨ kubelet</li>
<li><code v-pre>control-plane-join</code>ï¼šå°†æœºå™¨ä½œä¸ºæ§åˆ¶å¹³é¢å®ä¾‹åŠ å…¥</li>
<li>
<ul>
<li><code v-pre>/etcd</code>ï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„æœ¬åœ° etcd æˆå‘˜</li>
<li><code v-pre>/update-status</code>ï¼šå°†æ–°çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹æ³¨å†Œåˆ°ç»´æŠ¤åœ¨ kubeadm-config ConfigMap ä¸­çš„ ClusterStatus ä¸­ (å·²å¼ƒç”¨)</li>
<li><code v-pre>/mark-control-plane</code>ï¼šå°†èŠ‚ç‚¹æ ‡è®°ä¸ºæ§åˆ¶å¹³é¢èŠ‚ç‚¹</li>
</ul>
</li>
</ul>
<h3 id="é€‰é¡¹-1" tabindex="-1"><a class="header-anchor" href="#é€‰é¡¹-1" aria-hidden="true">#</a> é€‰é¡¹</h3>
<table>
<thead>
<tr>
<th>é€‰é¡¹</th>
<th>ç±»å‹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>--apiserver-advertise-address</code></td>
<td>string</td>
<td>å¦‚æœèŠ‚ç‚¹åº”è¯¥æ‰˜ç®¡æ–°çš„æ§åˆ¶å¹³é¢å®ä¾‹ï¼Œåˆ™æ˜¯ API æœåŠ¡å™¨å°†å¹¿å‘Šå®ƒæ­£åœ¨ä¾¦å¬çš„ IP åœ°å€ã€‚å¦‚æœæœªè®¾ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤ç½‘ç»œæ¥å£ã€‚</td>
</tr>
<tr>
<td><code v-pre>--apiserver-bind-port</code></td>
<td>int32</td>
<td>é»˜è®¤å€¼ï¼š6443ã€‚å¦‚æœèŠ‚ç‚¹åº”è¯¥æ‰˜ç®¡æ–°çš„æ§åˆ¶å¹³é¢å®ä¾‹ï¼Œåˆ™æ˜¯ API æœåŠ¡å™¨ç»‘å®šçš„ç«¯å£ã€‚</td>
</tr>
<tr>
<td><code v-pre>--certificate-key</code></td>
<td>string</td>
<td>ä½¿ç”¨æ­¤å¯†é’¥è§£å¯†ç”± init ä¸Šä¼ çš„è¯ä¹¦å¯†é’¥ã€‚</td>
</tr>
<tr>
<td><code v-pre>--config</code></td>
<td>string</td>
<td>kubeadm é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚</td>
</tr>
<tr>
<td><code v-pre>--cri-socket</code></td>
<td>string</td>
<td>è¿æ¥çš„ CRI å¥—æ¥å­—çš„è·¯å¾„ã€‚å¦‚æœä¸ºç©ºï¼Œkubeadm å°†å°è¯•è‡ªåŠ¨æ£€æµ‹æ­¤å€¼ã€‚ä»…åœ¨å®‰è£…äº†å¤šä¸ª CRI æˆ–å…·æœ‰éæ ‡å‡† CRI å¥—æ¥å­—æ—¶ä½¿ç”¨æ­¤é€‰é¡¹ã€‚</td>
</tr>
<tr>
<td><code v-pre>--discovery-file</code></td>
<td>string</td>
<td>å¯¹äºåŸºäºæ–‡ä»¶çš„å‘ç°ï¼Œè¦ä»ä¸­åŠ è½½ç¾¤é›†ä¿¡æ¯çš„æ–‡ä»¶æˆ– URLã€‚</td>
</tr>
<tr>
<td><code v-pre>--discovery-token</code></td>
<td>string</td>
<td>å¯¹äºåŸºäºä»¤ç‰Œçš„å‘ç°ï¼Œç”¨äºéªŒè¯ä» API æœåŠ¡å™¨è·å–çš„ç¾¤é›†ä¿¡æ¯çš„ä»¤ç‰Œã€‚</td>
</tr>
<tr>
<td><code v-pre>--discovery-token-ca-cert-hash</code></td>
<td>stringSlice</td>
<td>å¯¹äºåŸºäºä»¤ç‰Œçš„å‘ç°ï¼ŒéªŒè¯æ ¹ CA å…¬é’¥æ˜¯å¦ä¸æ­¤å“ˆå¸Œå€¼åŒ¹é…ï¼ˆæ ¼å¼ï¼šâ€œ : â€ï¼‰ã€‚</td>
</tr>
<tr>
<td><code v-pre>--discovery-token-unsafe-skip-ca-verification</code></td>
<td></td>
<td>å¯¹äºåŸºäºä»¤ç‰Œçš„å‘ç°ï¼Œå…è®¸åŠ å…¥è€Œä¸ä½¿ç”¨ --discovery-token-ca-cert-hash å›ºå®šã€‚</td>
</tr>
<tr>
<td><code v-pre>--experimental-control-plane</code></td>
<td></td>
<td>åœ¨æ­¤èŠ‚ç‚¹ä¸Šåˆ›å»ºæ–°çš„æ§åˆ¶å¹³é¢å®ä¾‹ã€‚</td>
</tr>
<tr>
<td><code v-pre>-h</code>, <code v-pre>--help</code></td>
<td></td>
<td>join çš„å¸®åŠ©ä¿¡æ¯</td>
</tr>
<tr>
<td><code v-pre>--ignore-preflight-errors</code></td>
<td>stringSlice</td>
<td>æ˜¾ç¤ºä¸ºè­¦å‘Šçš„æ£€æŸ¥åˆ—è¡¨çš„é”™è¯¯ã€‚ç¤ºä¾‹ï¼šâ€œIsPrivilegedUser,Swapâ€ã€‚å€¼â€œallâ€ä¼šå¿½ç•¥æ‰€æœ‰æ£€æŸ¥çš„é”™è¯¯ã€‚</td>
</tr>
<tr>
<td><code v-pre>--node-name</code></td>
<td>string</td>
<td>æŒ‡å®šèŠ‚ç‚¹åç§°ã€‚</td>
</tr>
<tr>
<td><code v-pre>--skip-phases</code></td>
<td>stringSlice</td>
<td>è¦è·³è¿‡çš„é˜¶æ®µåˆ—è¡¨ã€‚</td>
</tr>
<tr>
<td><code v-pre>--tls-bootstrap-token</code></td>
<td>string</td>
<td>åœ¨åŠ å…¥èŠ‚ç‚¹æ—¶ï¼ŒæŒ‡å®šç”¨äºä¸´æ—¶èº«ä»½éªŒè¯ Kubernetes æ§åˆ¶å¹³é¢çš„ä»¤ç‰Œã€‚</td>
</tr>
<tr>
<td><code v-pre>--token</code></td>
<td>string</td>
<td>åœ¨æœªæä¾› discovery-token å’Œ tls-bootstrap-token æ—¶ä½¿ç”¨æ­¤ä»¤ç‰Œã€‚</td>
</tr>
</tbody>
</table>
<h3 id="åŠ å…¥æµç¨‹" tabindex="-1"><a class="header-anchor" href="#åŠ å…¥æµç¨‹" aria-hidden="true">#</a> åŠ å…¥æµç¨‹</h3>
<p><code v-pre>kubeadm join</code>å¼•å¯¼Kuberneteså·¥ä½œèŠ‚ç‚¹æˆ–æ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°é›†ç¾¤ä¸­ã€‚å¯¹äºå·¥ä½œèŠ‚ç‚¹ï¼Œè¯¥æ“ä½œåŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤:</p>
<ol>
<li>
<p>kubeadmä»APIæœåŠ¡å™¨ä¸‹è½½å¿…è¦çš„é›†ç¾¤ä¿¡æ¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä½¿ç”¨å¼•å¯¼ä»¤ç‰Œå’ŒCAå¯†é’¥çš„å“ˆå¸Œå€¼æ¥éªŒè¯æ•°æ®çš„çœŸå®æ€§ã€‚æ ¹CAä¹Ÿå¯ä»¥é€šè¿‡æ–‡ä»¶æˆ–URLç›´æ¥è·å–ã€‚</p>
</li>
<li>
<p>ä¸€æ—¦è·å–äº†é›†ç¾¤ä¿¡æ¯ï¼Œkubeletå°±å¯ä»¥å¯åŠ¨TLSå¼•å¯¼æµç¨‹ã€‚</p>
<p>TLSå¼•å¯¼ä½¿ç”¨å…±äº«ä»¤ç‰Œä¸Kubernetes APIæœåŠ¡å™¨è¿›è¡Œä¸´æ—¶è®¤è¯ï¼Œæäº¤è¯ä¹¦ç­¾åè¯·æ±‚(CSR)ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œæ§åˆ¶å¹³é¢è‡ªåŠ¨ç­¾ç½²æ­¤CSRè¯·æ±‚ã€‚</p>
</li>
<li>
<p>æœ€åï¼Œkubeadmå°†æœ¬åœ°kubeleté…ç½®ä¸ºä½¿ç”¨åˆ†é…ç»™èŠ‚ç‚¹çš„æœ€ç»ˆæ ‡è¯†è¿æ¥åˆ°APIæœåŠ¡å™¨ã€‚</p>
</li>
</ol>
<p>å¯¹äºæ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œè¿˜è¦æ‰§è¡Œé¢å¤–çš„æ­¥éª¤:</p>
<ol>
<li>ä»é›†ç¾¤ä¸­ä¸‹è½½æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¹‹é—´å…±äº«çš„è¯ä¹¦(å¦‚æœç”¨æˆ·æ˜¾å¼åœ°è¯·æ±‚)ã€‚</li>
<li>ç”Ÿæˆæ§åˆ¶å¹³é¢ç»„ä»¶æ¸…å•ã€è¯ä¹¦å’Œkubeconfigã€‚</li>
<li>æ·»åŠ æ–°çš„æœ¬åœ°etcdæˆå‘˜ã€‚</li>
<li>å°†æ­¤èŠ‚ç‚¹æ·»åŠ åˆ°kubeadmé›†ç¾¤çš„ClusterStatusä¸­ã€‚</li>
</ol>
<h3 id="ä½¿ç”¨kubeadmçš„åŠ å…¥é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨kubeadmçš„åŠ å…¥é˜¶æ®µ" aria-hidden="true">#</a> ä½¿ç”¨kubeadmçš„åŠ å…¥é˜¶æ®µ</h3>
<p>Kubeadmå…è®¸ä½ åˆ†é˜¶æ®µå°†èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ã€‚<code v-pre>kubeadm join phase</code>å‘½ä»¤æ˜¯åœ¨v1.14.0ä¸­æ·»åŠ çš„ã€‚</p>
<p>è¦æŸ¥çœ‹é˜¶æ®µçš„æœ‰åºåˆ—è¡¨å’Œå­é˜¶æ®µåˆ—è¡¨ï¼Œå¯ä»¥è°ƒç”¨<code v-pre>kubeadm join --help</code>ã€‚åˆ—è¡¨å°†ä½äºå¸®åŠ©çš„é¡¶éƒ¨ï¼Œæ¯ä¸ªé˜¶æ®µæ—è¾¹éƒ½æœ‰ä¸€ä¸ªæè¿°ã€‚æ³¨æ„ï¼Œé€šè¿‡è°ƒç”¨<code v-pre>kubeadm join</code>ï¼Œæ‰€æœ‰é˜¶æ®µå’Œå­é˜¶æ®µéƒ½å°†æŒ‰ç…§è¿™ä¸ªé¡ºåºæ‰§è¡Œã€‚</p>
<p>æœ‰äº›é˜¶æ®µæœ‰ç‹¬ç‰¹çš„é€‰é¡¹ï¼Œæ‰€ä»¥å¦‚æœä½ æƒ³æŸ¥çœ‹å¯ç”¨çš„é€‰é¡¹åˆ—è¡¨ï¼Œè¯·æ·»åŠ <code v-pre>--help</code>ï¼Œä¾‹å¦‚:</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubeadm <span class="token function">join</span> phase kubelet-start <span class="token parameter variable">--help</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init phase</code><ExternalLinkIcon/></a>å‘½ä»¤ç±»ä¼¼ï¼Œ<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_join_phase.html" target="_blank" rel="noopener noreferrer"><code v-pre>kubadm join phase</code><ExternalLinkIcon/></a>å…è®¸ä½ ä½¿ç”¨<code v-pre>--skip-phase</code>é€‰é¡¹è·³è¿‡æŸäº›é˜¶æ®µã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">sudo</span> kubeadm <span class="token function">join</span> --skip-phases<span class="token operator">=</span>preflight <span class="token parameter variable">--config</span><span class="token operator">=</span>config.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="kubeadm-upgrade" tabindex="-1"><a class="header-anchor" href="#kubeadm-upgrade" aria-hidden="true">#</a> kubeadm upgrade</h2>
<p><code v-pre>kubeadm upgrade</code>æ˜¯ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„å‘½ä»¤ï¼Œå®ƒå°†å¤æ‚çš„å‡çº§é€»è¾‘å°è£…åœ¨ä¸€ä¸ªå‘½ä»¤åé¢ï¼Œæ”¯æŒè®¡åˆ’å‡çº§å’Œå®é™…æ‰§è¡Œå‡çº§ã€‚</p>
<p>å¦‚æœéœ€è¦ï¼Œ<code v-pre>kubeadm upgrade</code>è¿˜å¯ä»¥ç”¨äºé™çº§é›†ç¾¤ã€‚</p>
<p>æ£€æŸ¥å¯ä»¥å‡çº§åˆ°å“ªäº›ç‰ˆæœ¬ï¼Œå¹¶éªŒè¯å½“å‰é›†ç¾¤æ˜¯å¦å¯ä»¥å‡çº§ã€‚è¦è·³è¿‡internetæ£€æŸ¥ï¼Œè¯·ä¼ å…¥å¯é€‰<code v-pre>[version]</code>å‚æ•°ã€‚</p>
<div class="language-css ext-css line-numbers-mode"><pre v-pre class="language-css"><code>â¯ ./kubeadm upgrade
Upgrade your cluster smoothly to a newer version with this command

<span class="token property">Usage</span><span class="token punctuation">:</span>
  kubeadm upgrade [flags]
  kubeadm upgrade [command]

Available <span class="token property">Commands</span><span class="token punctuation">:</span>
  apply       Upgrade your Kubernetes cluster to the specified version
  diff        Show what differences would be applied to existing static pod manifests. See <span class="token property">also</span><span class="token punctuation">:</span> kubeadm upgrade apply --dry-run
  node        Upgrade commands for a node in the cluster
  plan        Check which versions are available to upgrade to and validate whether your current cluster is upgradeable. To skip the internet check<span class="token punctuation">,</span> pass in the optional [version] parameter
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kubeadm-config" tabindex="-1"><a class="header-anchor" href="#kubeadm-config" aria-hidden="true">#</a> kubeadm config</h2>
<p>ä»v1.8.0å¼€å§‹ï¼Œkubeadmå°†é›†ç¾¤çš„é…ç½®ä¸Šä¼ åˆ°<code v-pre>kube-system</code>åç§°ç©ºé—´ä¸­åä¸º<code v-pre>kubeadm-config</code>çš„ConfigMapï¼Œç„¶ååœ¨å‡çº§æ—¶è¯»å–ConfigMapã€‚è¿™æ”¯æŒæ­£ç¡®é…ç½®ç³»ç»Ÿç»„ä»¶ï¼Œå¹¶æä¾›äº†æ— ç¼çš„ç”¨æˆ·ä½“éªŒã€‚</p>
<p>ä½ å¯ä»¥æ‰§è¡Œ<code v-pre>kubeadm config view</code>æ¥æŸ¥çœ‹ConfigMapã€‚å¦‚æœä½¿ç”¨kubeadm v1.7åˆå§‹åŒ–é›†ç¾¤ã€‚åœ¨ä½¿ç”¨<code v-pre>kubeadm upgrade</code>ä¹‹å‰ï¼Œå¿…é¡»ä½¿ç”¨<code v-pre>kubeadm config upload</code>åˆ›å»ºConfigMapã€‚</p>
<p>åœ¨Kubernetes v1.11.0ä¸­ï¼Œæ·»åŠ äº†ä¸€äº›æ–°å‘½ä»¤ã€‚ä½ å¯ä»¥ä½¿ç”¨<code v-pre>kubeadm config print-default</code> æ¥æ‰“å°é»˜è®¤é…ç½®ï¼Œè€Œ<code v-pre>kubeadm config migrate</code> å¯ä»¥å°†æ—§çš„é…ç½®æ–‡ä»¶è½¬æ¢ä¸ºæ–°ç‰ˆæœ¬ã€‚<code v-pre>kubeadm config images list</code> å’Œ<code v-pre>kubeadm config images pull</code> å¯ç”¨äºåˆ—å‡ºå’Œæ‹‰å–kubeadmæ‰€éœ€çš„é•œåƒã€‚</p>
<p>åœ¨ <code v-pre>Kubernetes v1.13.0</code> ä»¥åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœè¦åˆ—å‡º/æ‹‰å‡ºçš„æ˜¯kube-dnsé•œåƒï¼Œè€Œä¸æ˜¯CoreDNSé•œåƒï¼Œåˆ™å¿…é¡»ä½¿ç”¨è¿™é‡Œæè¿°çš„<code v-pre>--config</code> æ–¹å¼ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ kubeadm config upload <span class="token parameter variable">--help</span>

There is a ConfigMap <span class="token keyword">in</span> the kube-system namespace called <span class="token string">"kubeadm-config"</span> that kubeadm uses to store internal configuration about the
cluster. kubeadm CLI v1.8.0+ automatically creates this ConfigMap with the config used with <span class="token string">'kubeadm init'</span>, but <span class="token keyword">if</span> you
initialized your cluster using kubeadm v1.7.x or lower, you must use the <span class="token string">'config upload'</span> <span class="token builtin class-name">command</span> to create this
ConfigMap. This is required so that <span class="token string">'kubeadm upgrade'</span> can configure your upgraded cluster correctly.

Usage:
  kubeadm config <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
  kubeadm config <span class="token punctuation">[</span>command<span class="token punctuation">]</span>

Available Commands:
  images      Interact with container images used by kubeadm
  migrate     Read an older version of the kubeadm configuration API types from a file, and output the similar config object <span class="token keyword">for</span> the newer version
  print       Print configuration

Flags:
  -h, <span class="token parameter variable">--help</span>                <span class="token builtin class-name">help</span> <span class="token keyword">for</span> config
      <span class="token parameter variable">--kubeconfig</span> string   The kubeconfig <span class="token function">file</span> to use when talking to the cluster. If the flag is not set, a <span class="token builtin class-name">set</span> of standard locations can be searched <span class="token keyword">for</span> an existing kubeconfig file. <span class="token punctuation">(</span>default <span class="token string">"/etc/kubernetes/admin.conf"</span><span class="token punctuation">)</span>

Global Flags:
      --add-dir-header           If true, adds the <span class="token function">file</span> directory to the header of the log messages
      --log-file string          If non-empty, use this log <span class="token function">file</span>
      --log-file-max-size uint   Defines the maximum size a log <span class="token function">file</span> can grow to. Unit is megabytes. If the value is <span class="token number">0</span>, the maximum <span class="token function">file</span> size is unlimited. <span class="token punctuation">(</span>default <span class="token number">1800</span><span class="token punctuation">)</span>
      --one-output               If true, only <span class="token function">write</span> logs to their native severity level <span class="token punctuation">(</span>vs also writing to each lower severity level<span class="token punctuation">)</span>
      <span class="token parameter variable">--rootfs</span> string            <span class="token punctuation">[</span>EXPERIMENTAL<span class="token punctuation">]</span> The path to the <span class="token string">'real'</span> <span class="token function">host</span> root filesystem.
      --skip-headers             If true, avoid header prefixes <span class="token keyword">in</span> the log messages
      --skip-log-headers         If true, avoid headers when opening log files
  -v, <span class="token parameter variable">--v</span> Level                  number <span class="token keyword">for</span> the log level verbosity
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="kubeadm-config-upload-from-file" tabindex="-1"><a class="header-anchor" href="#kubeadm-config-upload-from-file" aria-hidden="true">#</a> kubeadm config upload from-file</h3>
<p>ä¸Šä¼ ä¸€ä¸ªé…ç½®æ–‡ä»¶åˆ°é›†ç¾¤å†…çš„ConfigMapï¼Œç”¨äºkubeadmé…ç½®ã€‚</p>
<p>ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œä½ å¯ä»¥ä½¿ç”¨æä¾›ç»™<code v-pre>kubeadm init</code>çš„ç›¸åŒé…ç½®æ–‡ä»¶å°†é…ç½®ä¸Šä¼ åˆ°é›†ç¾¤ä¸­çš„ConfigMapã€‚å¦‚æœä½¿ç”¨v1.7åˆå§‹åŒ–é›†ç¾¤ã€‚åœ¨ä½¿ç”¨<code v-pre>kubeadm upgrade</code>å‡çº§åˆ°v1.8ä¹‹å‰ï¼Œä½ éœ€è¦ä½¿ç”¨ç›¸åŒçš„é…ç½®æ–‡ä»¶è¿è¡Œè¿™ä¸ªå‘½ä»¤ã€‚</p>
<p>é…ç½®ä½äº<code v-pre>kube-system</code>å‘½åç©ºé—´ä¸­çš„<code v-pre>kubeadm-config</code> ConfigMapä¸­ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubeadm config upload from-file <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote>
<p><code v-pre>kubeadm config upload from-file --help </code> æŸ¥çœ‹æ”¯æŒçš„ flages</p>
</blockquote>
<h3 id="kubeadm-config-view" tabindex="-1"><a class="header-anchor" href="#kubeadm-config-view" aria-hidden="true">#</a> kubeadm config view</h3>
<p>ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œä½ å¯ä»¥åœ¨kubeadmé…ç½®æ‰€åœ¨çš„é›†ç¾¤ä¸­æŸ¥çœ‹ConfigMapã€‚</p>
<p>é…ç½®ä½äº<code v-pre>kube-system</code>å‘½åç©ºé—´ä¸­çš„<code v-pre>kubeadm-config</code> ConfigMapä¸­ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubeadm config view <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="kubeadm-reset" tabindex="-1"><a class="header-anchor" href="#kubeadm-reset" aria-hidden="true">#</a> kubeadm reset</h2>
<p>æ­¤å‘½ä»¤å°†è¿˜åŸ<code v-pre>kubeadm init</code>å’Œ<code v-pre>kubeadm join</code>æ‰€åšçš„ä»»ä½•æ›´æ”¹ã€‚</p>
<p>è¿è¡Œæ­¤å‘½ä»¤ï¼Œä»¥æ¢å¤<code v-pre> kubeadm init</code>å’Œ <code v-pre>kubeadm join</code>å¯¹è¯¥ä¸»æœºæ‰€åšçš„ä»»ä½•æ›´æ”¹ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubeadm reset
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="æ¸…ç†å¤–éƒ¨etcd" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†å¤–éƒ¨etcd" aria-hidden="true">#</a> æ¸…ç†å¤–éƒ¨etcd</h3>
<p>å¦‚æœä½¿ç”¨å¤–éƒ¨etcdï¼Œ <code v-pre>kubeadm reset</code>ä¸ä¼šåˆ é™¤ä»»ä½•etcdæ•°æ®ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœå†æ¬¡ä½¿ç”¨ç›¸åŒçš„etcdç«¯ç‚¹è¿è¡Œ<code v-pre>kubeadm init</code>ï¼Œæ‚¨å°†çœ‹åˆ°ä»¥å‰é›†ç¾¤çš„çŠ¶æ€ã€‚</p>
<p>è¦æ“¦é™¤etcdæ•°æ®ï¼Œå»ºè®®ä½¿ç”¨etcdctlè¿™æ ·çš„å®¢æˆ·ç«¯ï¼Œä¾‹å¦‚:</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>etcdctl del <span class="token string">""</span> <span class="token parameter variable">--prefix</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="kubeadm-token" tabindex="-1"><a class="header-anchor" href="#kubeadm-token" aria-hidden="true">#</a> kubeadm token</h2>
<p>å¼•å¯¼ä»¤ç‰Œç”¨äºåœ¨è¿æ¥é›†ç¾¤çš„èŠ‚ç‚¹å’Œæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¹‹é—´å»ºç«‹åŒå‘ä¿¡ä»»ï¼Œå¦‚<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/authenticating_with_bootstrap_tokens.html" target="_blank" rel="noopener noreferrer">ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œè¿›è¡Œè®¤è¯<ExternalLinkIcon/></a>ä¸­æ‰€è¿°ã€‚</p>
<p><code v-pre>kubeadm init</code>ä½¿ç”¨24å°æ—¶TTLåˆ›å»ºåˆå§‹ä»¤ç‰Œã€‚ä¸‹é¢çš„å‘½ä»¤å¯ä»¥ç®¡ç†è¯¥ä»¤ç‰Œï¼Œå¹¶åˆ›å»ºå’Œç®¡ç†æ–°çš„ä»¤ç‰Œã€‚</p>
<h3 id="kubeadm-token-create" tabindex="-1"><a class="header-anchor" href="#kubeadm-token-create" aria-hidden="true">#</a> kubeadm token create</h3>
<p>åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå¼•å¯¼ä»¤ç‰Œã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubeadm token create <span class="token punctuation">[</span>token<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™ä¸ªå‘½ä»¤å°†ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ª <strong>å¼•å¯¼ä»¤ç‰Œ</strong>ã€‚ä½ å¯ä»¥æŒ‡å®šæ­¤ä»¤ç‰Œçš„ç”¨æ³•ã€â€œç”Ÿå­˜æ—¶é—´â€å’Œå¯é€‰çš„äººæ€§åŒ–æè¿°ã€‚</p>
<p><code v-pre>[token]</code>æ˜¯è¦å†™çš„å®é™…ä»¤ç‰Œã€‚è¿™åº”è¯¥æ˜¯ä¸€ä¸ªå®‰å…¨ç”Ÿæˆçš„éšæœºä»¤ç‰Œå½¢å¼<code v-pre>[a-z0-9]{6}.[a-z0-9]{16}</code>ã€‚å¦‚æœæ²¡æœ‰ç»™å‡º<code v-pre>[token]</code>ï¼Œåˆ™kubeadmå°†ç”Ÿæˆä¸€ä¸ªéšæœºä»¤ç‰Œã€‚</p>
<blockquote>
<p>æ‰€ä»¥æ‰€ å¼•å¯¼ä»¤ç‰Œæ˜¯å’Œ kueadme å¯¹åº”çš„ï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>â¯ kubeadm token create
qg8u0m.g31qk96l34ns9gz4

â¯ kubectl get secrets -A | grep -i qg8u0m
kube-system       bootstrap-token-qg8u0m                           bootstrap.kubernetes.io/token         6      2m10s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>
<h3 id="kubeadm-token-delete" tabindex="-1"><a class="header-anchor" href="#kubeadm-token-delete" aria-hidden="true">#</a> kubeadm token delete</h3>
<p>åˆ é™¤æœåŠ¡å™¨ä¸Šçš„å¼•å¯¼ä»¤ç‰Œã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubeadm token delete <span class="token punctuation">[</span>token-value<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¾‹å¦‚ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ kubeadm token delete qg8u0m
bootstrap token <span class="token string">"qg8u0m"</span> deleted
â¯ kubeadm token list
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="kubeadm-token-generate" tabindex="-1"><a class="header-anchor" href="#kubeadm-token-generate" aria-hidden="true">#</a> kubeadm token generate</h3>
<p>ç”Ÿæˆå¹¶æ‰“å°å¼•å¯¼ä»¤ç‰Œï¼Œä½†ä¸è¦åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå®ƒã€‚</p>
<p>è¿™ä¸ªå‘½ä»¤å°†è¾“å‡ºä¸€ä¸ªéšæœºç”Ÿæˆçš„å¼•å¯¼ä»¤ç‰Œï¼Œå¯ä»¥ä¸<code v-pre>init</code>å’Œ<code v-pre>join</code>å‘½ä»¤ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>ä½ ä¸å¿…ä½¿ç”¨æ­¤å‘½ä»¤æ¥ç”Ÿæˆä»¤ç‰Œã€‚åªè¦æ ¼å¼æ˜¯<code v-pre>[a-z0-9]{6}.[a-z0-9]{16}</code>ï¼Œä½ å‡ºå¯ä»¥è‡ªå·±ç”Ÿæˆã€‚æä¾›æ­¤å‘½ä»¤æ˜¯ä¸ºäº†æ–¹ä¾¿ä»¥ç»™å®šæ ¼å¼ç”Ÿæˆä»¤ç‰Œã€‚</p>
<p>ä½ è¿˜å¯ä»¥ä½¿ç”¨<code v-pre>kubeadm init</code>è€Œæ— éœ€æŒ‡å®šä»¤ç‰Œï¼Œå®ƒå°†ä¸ºä½ ç”Ÿæˆå¹¶æ‰“å°ä¸€ä¸ªä»¤ç‰Œã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubeadm token generate <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="kubeadm-token-list" tabindex="-1"><a class="header-anchor" href="#kubeadm-token-list" aria-hidden="true">#</a> kubeadm token list</h3>
<p>åˆ—å‡ºæœåŠ¡å™¨ä¸Šçš„å¼•å¯¼ä»¤ç‰Œã€‚</p>
<h2 id="kubeadm-version" tabindex="-1"><a class="header-anchor" href="#kubeadm-version" aria-hidden="true">#</a> kubeadm version</h2>
<p>è¿™ä¸ªå‘½ä»¤æ‰“å°kubeadmçš„ç‰ˆæœ¬ã€‚</p>
<h2 id="kubeadm-alpha" tabindex="-1"><a class="header-anchor" href="#kubeadm-alpha" aria-hidden="true">#</a> kubeadm alpha</h2>
<p>Kubeadm alphaå‘½ä»¤æ˜¯Kubeadmå·¥å…·ä¸­çš„ä¸€ä¸ªå®éªŒæ€§åŠŸèƒ½ï¼Œç”¨äºå¯ç”¨Kubernetesé›†ç¾¤çš„æŸäº›é«˜çº§åŠŸèƒ½ã€‚åœ¨Kubeadm alphaå‘½ä»¤ä¸­ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å„ç§å‚æ•°å’Œæ ‡å¿—æ¥é…ç½®æ‰€éœ€çš„åŠŸèƒ½å¹¶å¯åŠ¨Kubernetesé›†ç¾¤ã€‚</p>
<h3 id="kubeadm-alpha-certs-renew" tabindex="-1"><a class="header-anchor" href="#kubeadm-alpha-certs-renew" aria-hidden="true">#</a> kubeadm alpha certs renew</h3>
<p>ä½ å¯ä»¥ä½¿ç”¨<code v-pre>all</code>å­å‘½ä»¤æ›´æ–°æ‰€æœ‰Kubernetesè¯ä¹¦ï¼Œæˆ–è€…æœ‰é€‰æ‹©åœ°æ›´æ–°å®ƒä»¬ã€‚</p>
<h3 id="renew" tabindex="-1"><a class="header-anchor" href="#renew" aria-hidden="true">#</a> renew</h3>
<p>æ›´æ–°Kubernetesé›†ç¾¤çš„è¯ä¹¦ã€‚</p>
<h3 id="all" tabindex="-1"><a class="header-anchor" href="#all" aria-hidden="true">#</a> all</h3>
<p>æ›´æ–°æ‰€æœ‰å¯ç”¨è¯ä¹¦ã€‚</p>
<p>æ›´æ–°è¿è¡Œæ§åˆ¶å¹³é¢æ‰€éœ€çš„æ‰€æœ‰å·²çŸ¥è¯ä¹¦ã€‚æ— è®ºè¿‡æœŸæ—¥æœŸå¦‚ä½•ï¼Œéƒ½ä¼šæ— æ¡ä»¶åœ°è¿è¡Œç»­è®¢ã€‚ä¸ºäº†è·å¾—æ›´å¤šçš„æ§åˆ¶ï¼Œè¿˜å¯ä»¥å•ç‹¬è¿è¡Œç»­è®¢ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>kubeadm alpha certs renew all <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="kubeadm-alpha-kubeconfig-user" tabindex="-1"><a class="header-anchor" href="#kubeadm-alpha-kubeconfig-user" aria-hidden="true">#</a> kubeadm alpha kubeconfig user</h3>
<p><code v-pre>user</code>å­å‘½ä»¤å¯ç”¨äºä¸ºå…¶ä»–ç”¨æˆ·åˆ›å»ºkubeconfigæ–‡ä»¶ã€‚</p>
<h2 id="kubeadm-init-phase" tabindex="-1"><a class="header-anchor" href="#kubeadm-init-phase" aria-hidden="true">#</a> kubeadm init phase</h2>
<p>åœ¨v1.8.0ä¸­ï¼Œkubeadmå¼•å…¥äº†<code v-pre>kubeadm alpha phase</code>å‘½ä»¤ï¼Œç›®çš„æ˜¯ä½¿kubeadmæ›´åŠ æ¨¡å—åŒ–ã€‚åœ¨v1.13.0ä¸­ï¼Œè¿™ä¸ªå‘½ä»¤é€æ¸è¿‡æ¸¡åˆ°<code v-pre>kubeadm init phase</code>ã€‚è¿™ç§æ¨¡å—åŒ–ä½¿ä½ èƒ½å¤Ÿè°ƒç”¨å¼•å¯¼è¿‡ç¨‹çš„åŸå­å­æ­¥éª¤ã€‚å› æ­¤ï¼Œä½ å¯ä»¥è®©kubeadmå®ŒæˆæŸäº›éƒ¨åˆ†ï¼Œå¹¶åœ¨éœ€è¦è‡ªå®šä¹‰çš„åœ°æ–¹è¿›è¡Œå¡«å……ã€‚</p>
<p><code v-pre>kubeadm init phase</code>ä¸<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#chushihualiucheng" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init</code>å·¥ä½œæµç¨‹<ExternalLinkIcon/></a>æ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸”ä¸¤è€…éƒ½ä½¿ç”¨ç›¸åŒçš„ä»£ç ã€‚</p>
<h2 id="kubeadm-join-phase" tabindex="-1"><a class="header-anchor" href="#kubeadm-join-phase" aria-hidden="true">#</a> kubeadm join phase</h2>
<p>åœ¨v1.14.0ä¸­ï¼Œkubeadmå¼•å…¥äº†<code v-pre>kubeadm join phase</code>å‘½ä»¤ï¼Œç›®çš„æ˜¯ä½¿kubeadmæ›´åŠ æ¨¡å—åŒ–ã€‚è¿™ç§æ¨¡å—åŒ–ä½¿ä½ èƒ½å¤Ÿè°ƒç”¨åŠ å…¥ï¼ˆjoinï¼‰è¿‡ç¨‹çš„åŸå­å­æ­¥éª¤ã€‚å› æ­¤ï¼Œä½ å¯ä»¥è®©kubeadmå®ŒæˆæŸäº›éƒ¨åˆ†ï¼Œå¹¶åœ¨éœ€è¦è‡ªå®šä¹‰çš„åœ°æ–¹è¿›è¡Œå¡«å……ã€‚</p>
<p><code v-pre>kubeadm join phase</code>ä¸<code v-pre>kubeadm join</code>å·¥ä½œæµç¨‹æ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸”åœ¨åå°ä¸¤è€…éƒ½ä½¿ç”¨ç›¸åŒçš„ä»£ç ã€‚</p>
<h2 id="ç»†èŠ‚" tabindex="-1"><a class="header-anchor" href="#ç»†èŠ‚" aria-hidden="true">#</a> ç»†èŠ‚</h2>
<p>kubeadm å›´ç»•ç€ init å’Œ join ä¸ºä¸»ä½“å¼€å±•çš„ã€‚</p>
<p><code v-pre>kubeadm init</code>å’Œ<code v-pre>kubeadm join</code>æ‰€å»ºç«‹çš„é›†ç¾¤åº”è¯¥æ˜¯:</p>
<ul>
<li>
<p>å®‰å…¨çš„ï¼š</p>
<p>å®ƒåº”è¯¥é‡‡ç”¨æœ€æ–°çš„æœ€ä½³å®è·µï¼Œå¦‚:</p>
<ul>
<li>å¼ºåˆ¶æ‰§è¡ŒRBAC</li>
<li>ä½¿ç”¨èŠ‚ç‚¹æˆæƒå™¨</li>
<li>ä½¿ç”¨æ§åˆ¶å¹³é¢ç»„ä»¶ä¹‹é—´çš„å®‰å…¨é€šä¿¡</li>
<li>ä½¿ç”¨APIæœåŠ¡å™¨å’Œkubeletä¹‹é—´çš„å®‰å…¨é€šä¿¡</li>
<li>é”å®škubelet API</li>
<li>é”å®šå¯¹kube-proxyå’ŒCoreDNSç­‰ç³»ç»Ÿç»„ä»¶çš„APIè®¿é—®</li>
<li>é”å®šå¼•å¯¼ä»¤ç‰Œå¯ä»¥è®¿é—®çš„å†…å®¹</li>
<li>ç­‰å¾…</li>
</ul>
</li>
<li>
<p>æ˜“ç”¨çš„ï¼š</p>
<p>ç”¨æˆ·è¿è¡Œçš„ä¸¤ä¸ªå‘½ä»¤ä¸åº”è¯¥è¶…ä¸¤ä¸ª:</p>
<ul>
<li><code v-pre>kubeadm init</code></li>
<li><code v-pre>export KUBECONFIG=/etc/kubernetes/admin.conf</code></li>
<li><code v-pre>kubectl apply -f &lt;network-of-choice.yaml&gt;</code></li>
<li><code v-pre>kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt;</code></li>
</ul>
</li>
<li>
<p>å¯æ‰©å±•çš„ï¼š</p>
<ul>
<li>ä¾‹å¦‚ï¼Œå®ƒåº”è¯¥ä¸æ”¯æŒæ‰€æœ‰ç½‘ç»œæä¾›è€…ï¼Œç›¸åï¼Œé…ç½®ç½‘ç»œå·²è¶…å‡ºäº†èŒƒå›´</li>
<li>åº”è¯¥æä¾›ä½¿ç”¨é…ç½®æ–‡ä»¶å®šåˆ¶å„ç§å‚æ•°çš„å¯èƒ½æ€§</li>
</ul>
</li>
</ul>
<h3 id="å¸¸é‡å’Œè‘—åçš„å€¼ä¸è·¯å¾„" tabindex="-1"><a class="header-anchor" href="#å¸¸é‡å’Œè‘—åçš„å€¼ä¸è·¯å¾„" aria-hidden="true">#</a> å¸¸é‡å’Œè‘—åçš„å€¼ä¸è·¯å¾„</h3>
<p>ä¸ºäº†é™ä½å¤æ‚æ€§å¹¶ç®€åŒ–åŸºäºkubeadmå®ç°çš„éƒ¨ç½²è§£å†³æ–¹æ¡ˆçš„å¼€å‘ï¼Œkubeadmä¸ºä¼—æ‰€å‘¨çŸ¥çš„è·¯å¾„å’Œæ–‡ä»¶åä½¿ç”¨ä¸€ç»„æœ‰é™çš„å¸¸é‡å€¼ã€‚</p>
<p>Kubernetesç›®å½•<code v-pre>/etc/kubernetes</code>åœ¨åº”ç”¨ç¨‹åºä¸­æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå› ä¸ºå®ƒåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ç»™å®šçš„è·¯å¾„ï¼Œå¹¶ä¸”æ˜¯æœ€ç›´è§‚çš„ä½ç½®ï¼›å…¶ä»–å¸¸é‡è·¯å¾„å’Œæ–‡ä»¶åä¸º:</p>
<ul>
<li><strong><code v-pre>/etc/kubernetes/manifests</code> ä½œä¸ºkubeletåº”è¯¥å¯»æ‰¾é™æ€Podæ¸…å•çš„è·¯å¾„ã€‚é™æ€podçš„æ¸…å•æœ‰:</strong>
<ul>
<li><code v-pre>etcd.yaml</code></li>
<li><code v-pre>kube-apiserver.yaml</code></li>
<li><code v-pre>kube-controller-manager.yaml</code></li>
<li><code v-pre>kube-scheduler.yaml</code></li>
</ul>
</li>
<li><strong><code v-pre>/etc/kubernetes/</code> ä½œä¸ºå­˜å‚¨å…·æœ‰æ§åˆ¶å¹³é¢ç»„ä»¶æ ‡è¯†ç¬¦çš„kubeconfigæ–‡ä»¶çš„è·¯å¾„ã€‚kubeconfigæ–‡ä»¶çš„åç§°æœ‰:</strong>
<ul>
<li><code v-pre>kubelet.conf</code> (<code v-pre>bootstrap-kubelet.conf</code> åœ¨TLSå¼•å¯¼æœŸé—´)</li>
<li><code v-pre>controller-manager.conf</code></li>
<li><code v-pre>scheduler.conf</code></li>
<li><code v-pre>admin.conf</code> ç”¨äºé›†ç¾¤ç®¡ç†å‘˜å’Œkubeadmè‡ªå·±</li>
</ul>
</li>
<li><strong>è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶åç§°:</strong>
<ul>
<li><code v-pre>ca.crt</code>ã€ <code v-pre>ca.key</code> ç”¨äºKubernetesè¯ä¹¦æˆæƒ</li>
<li><code v-pre>apiserver.crt</code>ã€ <code v-pre>apiserver.key</code> ç”¨äºAPIæœåŠ¡å™¨è¯ä¹¦</li>
<li><code v-pre>apiserver-kubelet-client.crt</code>ã€ <code v-pre>apiserver-kubelet-client.key</code> ä½œä¸ºAPIæœåŠ¡å™¨çš„å®¢æˆ·ç«¯è¯ä¹¦ç”¨äºè¿æ¥å®‰å…¨åœ°è¿æ¥kubelet</li>
<li><code v-pre>sa.pub</code>ã€ <code v-pre>sa.key</code> åœ¨ç­¾å<code v-pre>ServiceAccount</code>æ—¶ï¼Œä½œä¸ºæ§åˆ¶å™¨ç®¡ç†å™¨çš„å¯†é’¥</li>
<li><code v-pre>front-proxy-ca.crt</code>ã€ <code v-pre>front-proxy-ca.key</code> ç”¨äºå‰ç«¯ä»£ç†è¯ä¹¦æˆæƒ</li>
<li><code v-pre>front-proxy-client.crt</code>ã€ <code v-pre>front-proxy-client.key</code> ç”¨äºå‰ç«¯ä»£ç†å®¢æˆ·ç«¯</li>
</ul>
</li>
</ul>
<h3 id="kubeadmåˆå§‹åŒ–æµç¨‹çš„å†…éƒ¨è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#kubeadmåˆå§‹åŒ–æµç¨‹çš„å†…éƒ¨è®¾è®¡" aria-hidden="true">#</a> kubeadmåˆå§‹åŒ–æµç¨‹çš„å†…éƒ¨è®¾è®¡</h3>
<p><code v-pre>kubeadm init</code>å†…éƒ¨æµç¨‹ï¼ˆç¬¬äºŒä¸ªæ®µè½æ ‡é¢˜ï¼‰ç”±ä¸€ç³»åˆ—è¦æ‰§è¡Œçš„åŸå­å·¥ä½œä»»åŠ¡ç»„æˆï¼Œå¦‚<code v-pre>kubeadm init</code>ä¸­æ‰€è¿°ã€‚</p>
<p><code v-pre>kubeadm init phase</code>å‘½ä»¤å…è®¸ç”¨æˆ·åˆ†åˆ«è°ƒç”¨æ¯ä¸ªä»»åŠ¡ï¼Œå¹¶æœ€ç»ˆæä¾›ä¸€ä¸ªå¯é‡ç”¨å’Œå¯ç»„åˆçš„API/å·¥å…·ç®±ï¼Œå…¶ä»–Kuberneteså¼•å¯¼å·¥å…·ã€ä»»ä½•ITè‡ªåŠ¨åŒ–å·¥å…·æˆ–é«˜çº§ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨è¯¥API/å·¥å…·ç®±åˆ›å»ºè‡ªå®šä¹‰é›†ç¾¤ã€‚</p>
<h3 id="é¢„æ£€æŸ¥-preflight" tabindex="-1"><a class="header-anchor" href="#é¢„æ£€æŸ¥-preflight" aria-hidden="true">#</a> é¢„æ£€æŸ¥ï¼ˆpreflight)</h3>
<p>Kubeadmåœ¨å¯åŠ¨ init ä¹‹å‰æ‰§è¡Œä¸€ç»„é¢„å…ˆæ£€æŸ¥ï¼Œç›®çš„æ˜¯éªŒè¯å…ˆå†³æ¡ä»¶å¹¶é¿å…å¸¸è§çš„é›†ç¾¤å¯åŠ¨é—®é¢˜ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨<code v-pre>--ignore-preflight-errors</code> é€‰é¡¹è·³è¿‡ç‰¹å®šçš„é¢„å…ˆæ£€æŸ¥ï¼ˆæˆ–è€…æœ€ç»ˆè·³è¿‡æ‰€æœ‰çš„é¢„å…ˆæ£€æŸ¥ï¼‰ã€‚</p>
<ul>
<li>[è­¦å‘Š]å¦‚æœè¦ä½¿ç”¨çš„Kubernetesç‰ˆæœ¬ï¼ˆä½¿ç”¨ <code v-pre>--kubernetes-version</code>é€‰é¡¹æŒ‡å®šï¼‰è‡³å°‘æ¯”kubeadm CLIç‰ˆæœ¬é«˜ä¸€ä¸ªæ¬¡è¦ç‰ˆæœ¬ã€‚</li>
<li>Kubernetesç³»ç»Ÿè¦æ±‚:
<ul>
<li>å¦‚æœè¿è¡Œåœ¨linuxä¸Š:
<ul>
<li>[é”™è¯¯]å¦‚æœä¸æ˜¯æ‹¥æœ‰ç‰¹å®šKernelSpecçš„å†…æ ¸3.10+æˆ–4</li>
<li>[é”™è¯¯]å¦‚æœéœ€è¦çš„cgroupså­ç³»ç»Ÿæ²¡æœ‰å»ºç«‹</li>
</ul>
</li>
<li>å¦‚æœä½¿ç”¨dockerï¼š
<ul>
<li>[è­¦å‘Š/é”™è¯¯]å¦‚æœDockeræœåŠ¡ä¸å­˜åœ¨ï¼Œå¦‚æœå®ƒè¢«ç¦ç”¨ï¼Œå¦‚æœå®ƒä¸æ˜¯æ´»åŠ¨çš„ã€‚</li>
<li>[é”™è¯¯]å¦‚æœDockerç«¯ç‚¹ä¸å­˜åœ¨æˆ–ä¸å·¥ä½œ</li>
<li>[è­¦å‘Š]å¦‚æœdockerç‰ˆæœ¬&gt;17.03</li>
</ul>
</li>
<li>å¦‚æœä½¿ç”¨å…¶å®ƒCRIå¼•æ“ï¼š
<ul>
<li>[é”™è¯¯]å¦‚æœcrictlå¥—æ¥å­—æ²¡æœ‰åº”ç­”</li>
</ul>
</li>
</ul>
</li>
<li>[é”™è¯¯]å¦‚æœç”¨æˆ·ä¸æ˜¯root</li>
<li>[é”™è¯¯]å¦‚æœæœºå™¨ä¸»æœºåä¸æ˜¯æœ‰æ•ˆçš„DNSå­åŸŸå</li>
<li>[è­¦å‘Š]å¦‚æœæ— æ³•é€šè¿‡ç½‘ç»œæŸ¥æ‰¾è®¿é—®ä¸»æœºå</li>
<li>[é”™è¯¯]å¦‚æœkubeletç‰ˆæœ¬ä½äºkubeadmæ”¯æŒçš„æœ€å°kubeletç‰ˆæœ¬ï¼ˆå½“å‰æ¬¡è¦ç‰ˆæœ¬ - 1ï¼‰</li>
<li>[é”™è¯¯]å¦‚æœkubeletç‰ˆæœ¬æ¯”æ‰€éœ€çš„æ§åˆ¶å¹³é¢ç‰ˆæœ¬ï¼ˆä¸æ”¯æŒçš„ç‰ˆæœ¬å€¾æ–œï¼‰é«˜è‡³å°‘ä¸€ä¸ªæ¬¡è¦ç‰ˆæœ¬</li>
<li>[è­¦å‘Š]å¦‚æœkubeletæœåŠ¡ä¸å­˜åœ¨æˆ–è¢«ç¦ç”¨</li>
<li>[è­¦å‘Š]å¦‚æœfirewalldæ˜¯æ´»åŠ¨çš„</li>
<li>[é”™è¯¯]å¦‚æœAPIæœåŠ¡å™¨bindPortæˆ–ç«¯å£ä½¿ç”¨çš„æ˜¯<code v-pre>10250/10251/10252</code></li>
<li>[é”™è¯¯]å¦‚æœ<code v-pre>/etc/kubernetes/manifest</code>æ–‡ä»¶å¤¹å·²ç»å­˜åœ¨ä¸”ä¸æ˜¯ç©ºçš„</li>
<li>[é”™è¯¯]å¦‚æœ<code v-pre>/proc/sys/net/bridge/bridge-nf-call-iptables</code>æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸åŒ…å«1</li>
<li>[é”™è¯¯]å¦‚æœadvertiseåœ°å€æ˜¯ipv6ï¼Œ <code v-pre>/proc/sys/net/bridge/bridge-nf-call-ip6tables</code>ä¸å­˜åœ¨æˆ–ä¸åŒ…å«1ã€‚</li>
<li>[é”™è¯¯]å¦‚æœswapæ˜¯æ‰“å¼€çš„</li>
<li>[é”™è¯¯]å¦‚æœå‘½ä»¤è·¯å¾„ä¸­ä¸å­˜åœ¨<code v-pre>ip</code>ã€<code v-pre>iptables</code>ã€<code v-pre>mount</code>ã€<code v-pre>nsenter</code>å‘½ä»¤</li>
<li>[è­¦å‘Š]å¦‚æœå‘½ä»¤è·¯å¾„ä¸­æ²¡æœ‰<code v-pre>ebtables</code>ã€<code v-pre>ethtool</code>ã€<code v-pre>socat</code>ã€<code v-pre>tc</code>ã€<code v-pre>touch</code>ã€<code v-pre>crictl</code>å‘½ä»¤</li>
<li>[è­¦å‘Š]å¦‚æœAPIæœåŠ¡å™¨ã€æ§åˆ¶å™¨ç®¡ç†å™¨ã€è°ƒåº¦å™¨çš„é¢å¤–å‚æ•°åŒ…å«ä¸€äº›æ— æ•ˆé€‰é¡¹</li>
<li>[è­¦å‘Š]å¦‚æœé€šè¿‡ä»£ç†è¿æ¥åˆ°<a href="https://api.advertiseaddress:API.BindPort/" target="_blank" rel="noopener noreferrer">https://API.AdvertiseAddress:API.BindPort<ExternalLinkIcon/></a></li>
<li>[è­¦å‘Š]å¦‚æœé€šè¿‡ä»£ç†è¿æ¥åˆ°æœåŠ¡å­ç½‘ï¼ˆä»…é€‰ä¸­ç¬¬ä¸€ä¸ªåœ°å€ï¼‰</li>
<li>[è­¦å‘Š]å¦‚æœé€šè¿‡ä»£ç†è¿æ¥åˆ°Podå­ç½‘ï¼ˆä»…é€‰ä¸­ç¬¬ä¸€ä¸ªåœ°å€ï¼‰</li>
<li>å¦‚æœæä¾›å¤–éƒ¨etcd:
<ul>
<li>[é”™è¯¯]å¦‚æœetcdç‰ˆæœ¬å°äº3.0.14</li>
<li>[é”™è¯¯]å¦‚æœæŒ‡å®šetcdè¯ä¹¦æˆ–å¯†é’¥ï¼Œä½†æ²¡æœ‰æä¾›</li>
</ul>
</li>
<li>å¦‚æœæ²¡æœ‰æä¾›å¤–éƒ¨etcdï¼ˆå› æ­¤å°†å®‰è£…æœ¬åœ°etcdï¼‰:
<ul>
<li>[é”™è¯¯]å¦‚æœ2379ç«¯å£è¢«å ç”¨</li>
<li>[é”™è¯¯]å¦‚æœ Etcd.DataDiræ–‡ä»¶å¤¹å·²ç»å­˜åœ¨å¹¶ä¸”ä¸ä¸ºç©º</li>
</ul>
</li>
<li>å¦‚æœæˆæƒæ¨¡å¼ä¸ºABAC:
<ul>
<li>[é”™è¯¯]å¦‚æœ<code v-pre>abac_policy.json</code>æ–‡ä»¶ä¸å­˜åœ¨</li>
</ul>
</li>
<li>å¦‚æœæˆæƒæ¨¡å¼æ˜¯WebHookï¼š
<ul>
<li>[é”™è¯¯]å¦‚æœ<code v-pre>webhook_authz .conf</code>æ–‡ä»¶ä¸å­˜åœ¨</li>
</ul>
</li>
</ul>
<p>è¯·æ³¨æ„ï¼š</p>
<ol>
<li>å¯ä»¥ä½¿ç”¨ <code v-pre>kubeadm init phase preflight</code>å‘½ä»¤å•ç‹¬æ‰§è¡Œé¢„å…ˆæ£€æŸ¥</li>
</ol>
<h3 id="ç”Ÿæˆå¿…è¦çš„è¯ä¹¦" tabindex="-1"><a class="header-anchor" href="#ç”Ÿæˆå¿…è¦çš„è¯ä¹¦" aria-hidden="true">#</a> ç”Ÿæˆå¿…è¦çš„è¯ä¹¦</h3>
<p>Kubeadmç”Ÿæˆç”¨äºä¸åŒç›®çš„çš„è¯ä¹¦å’Œç§é’¥å¯¹:</p>
<ul>
<li>
<p>ä¸€ä¸ªç”¨äºKubernetesé›†ç¾¤çš„è‡ªç­¾åè¯ä¹¦é¢å‘æœºæ„ï¼Œä¿å­˜åœ¨<code v-pre>ca.crt</code>æ–‡ä»¶å’Œ<code v-pre>ca.key</code>ç§é’¥æ–‡ä»¶ä¸­</p>
</li>
<li>
<p>APIæœåŠ¡å™¨çš„æœåŠ¡è¯ä¹¦ï¼Œä½¿ç”¨</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>ca.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä½œä¸ºCAç”Ÿæˆï¼Œå¹¶ä¿å­˜åˆ°</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>apiserver.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ–‡ä»¶åŠå…¶ç§é’¥</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>apiserver.key
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ã€‚æ­¤è¯ä¹¦åº”åŒ…å«ä»¥ä¸‹å¯é€‰åç§°:</p>
<ul>
<li>KubernetesæœåŠ¡çš„å†…éƒ¨é›†ç¾¤IPï¼ˆæœåŠ¡CIDRä¸­çš„ç¬¬ä¸€ä¸ªåœ°å€ï¼Œä¾‹å¦‚ï¼šå¦‚æœæœåŠ¡å­ç½‘æ˜¯<code v-pre>10.96.0.0/12</code>ï¼Œåˆ™é›†ç¾¤IPä¸º<code v-pre>10.96.0.1</code>ï¼‰</li>
<li>Kubernetes DNSåç§°ï¼›ä¾‹å¦‚ï¼šå¦‚æœæŒ‡å®š<code v-pre>--service-dns-domain</code> ä¸º <code v-pre>cluster.local</code>ï¼Œåˆ™DNSåç§°ä¸º<code v-pre>kubernetes.default.svc.cluster.local</code> ï¼ŒåŠ ä¸Šé»˜è®¤DNSåç§°ï¼š <code v-pre>kubernetes.default.svc</code>ã€<code v-pre>kubernetes.default</code>ã€ <code v-pre>kubernetes</code></li>
<li>èŠ‚ç‚¹åç§°</li>
<li><code v-pre>--apiserver-advertise-address</code></li>
<li>ç”±ç”¨æˆ·æŒ‡å®šçš„å…¶ä»–æ›¿ä»£åç§°</li>
</ul>
</li>
<li>
<p>ç”¨äºAPIæœåŠ¡å™¨å®‰å…¨åœ°è¿æ¥åˆ°kubeletçš„å®¢æˆ·ç«¯è¯ä¹¦ï¼Œä½¿ç”¨<code v-pre>ca.crt</code>ä½œä¸ºCAç”Ÿæˆï¼Œå¹¶ä¿å­˜åˆ°<code v-pre>apiserver-kubelet-client.crt</code>æ–‡ä»¶ä¸­åŠå…¶ç§é’¥<code v-pre>apiserver-kubelet-client.key</code>ã€‚è¿™ä¸ªè¯ä¹¦åº”è¯¥åœ¨ <code v-pre>system:masters</code>ç»„ç»‡ä¸­</p>
</li>
<li>
<p>ç”¨äºç­¾åæœåŠ¡è´¦æˆ·ä»¤ç‰Œçš„ç§é’¥ï¼Œå¹¶ä¿å­˜è‡³ <code v-pre>sa.key</code> æ–‡ä»¶åŠå…¶å…¬é’¥æ–‡ä»¶ <code v-pre>sa.pub</code></p>
</li>
<li>
<p>ç”¨äºå‰ç«¯ä»£ç†æˆæƒçš„è¯ä¹¦ï¼Œå¹¶ä¿å­˜è‡³ <code v-pre>front-proxy-ca.crt</code>æ–‡ä»¶åŠå…¶å¯†é’¥æ–‡ä»¶y<code v-pre>front-proxy-ca.key</code></p>
</li>
<li>
<p>ç”¨äºå‰ç«¯ä»£ç†å®¢æˆ·ç«¯çš„å®¢æˆ·ç«¯è¯ä¹¦ï¼Œä½¿ç”¨ <code v-pre>front-proxy-ca.crt</code>ä½œä¸ºCAç”Ÿæˆï¼Œå¹¶ä¿å­˜è‡³ <code v-pre>front-proxy-client.crt</code> æ–‡ä»¶åŠå…¶ç§é’¥<code v-pre>front-proxy-client.key</code></p>
</li>
</ul>
<p>è¯ä¹¦é»˜è®¤å­˜å‚¨åœ¨<code v-pre>/etc/kubernetes/pki</code>ä¸­ï¼Œä½†æ˜¯è¿™ä¸ªç›®å½•å¯ä»¥ä½¿ç”¨<code v-pre>--cert-dir</code>é€‰é¡¹è¿›è¡Œé…ç½®ã€‚</p>
<p><strong>è¯·æ³¨æ„ï¼š</strong></p>
<ol>
<li>å¦‚æœä¸€ä¸ªç»™å®šçš„è¯ä¹¦å’Œç§é’¥å¯¹éƒ½å­˜åœ¨ï¼Œå¹¶ä¸”å®ƒçš„å†…å®¹ç¬¦åˆä¸Šé¢çš„è§„èŒƒï¼Œé‚£ä¹ˆå°†ä½¿ç”¨ç°æœ‰çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è·³è¿‡ç»™å®šè¯ä¹¦çš„ç”Ÿæˆé˜¶æ®µã€‚ä¾‹å¦‚ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·å¯ä»¥å°†ç°æœ‰CAå¤åˆ¶åˆ°<code v-pre>/etc/kubernetes/pki/ca.{crt,key}</code>ï¼Œç„¶åkubeadmå°†ä½¿ç”¨è¿™äº›æ–‡ä»¶æ¥ç­¾ç½²å…¶ä½™çš„è¯ä¹¦ã€‚</li>
<li>ä»…å¯¹äºCAï¼Œå¯ä»¥åªæä¾›<code v-pre>ca.crt</code>æ–‡ä»¶è€Œä¸æä¾›<code v-pre>ca.key</code>æ–‡ä»¶ï¼Œå¦‚æœæ‰€æœ‰å…¶ä»–è¯ä¹¦å’Œkubeconfigæ–‡ä»¶å·²ç»åˆ°ä½ï¼Œkubeadmè¯†åˆ«è¿™ç§æƒ…å†µå¹¶æ¿€æ´»å¤–éƒ¨CAæ¨¡å¼ï¼Œè¿™ä¹Ÿæ„å‘³ç€åœ¨æ§åˆ¶å™¨ç®¡ç†å™¨çš„<code v-pre>csrsigner</code>æ§åˆ¶å™¨ä¸ä¼šå¯åŠ¨ã€‚</li>
<li>å¦‚æœkubeadmåœ¨<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#waibucamoshi" target="_blank" rel="noopener noreferrer">å¤–éƒ¨CAæ¨¡å¼<ExternalLinkIcon/></a>ä¸‹è¿è¡Œï¼›æ‰€æœ‰è¯ä¹¦éƒ½å¿…é¡»ç”±ç”¨æˆ·æä¾›ï¼Œå› ä¸ºkubeadmä¸èƒ½è‡ªå·±ç”Ÿæˆè¯ä¹¦ã€‚</li>
<li>åœ¨kubeadmä»¥<code v-pre>--dry-run</code>æ¨¡å¼æ‰§è¡Œæ—¶ï¼Œè¯ä¹¦æ–‡ä»¶è¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-certs" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init phase certs all</code><ExternalLinkIcon/></a> å‘½ä»¤å•ç‹¬è°ƒç”¨è¯ä¹¦ç”Ÿæˆã€‚</li>
</ol>
<h3 id="ä¸ºæ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆkubeconfigæ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#ä¸ºæ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆkubeconfigæ–‡ä»¶" aria-hidden="true">#</a> ä¸ºæ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆkubeconfigæ–‡ä»¶</h3>
<p>å¸¦æœ‰æ§åˆ¶å¹³é¢ç»„ä»¶æ ‡è¯†çš„Kubeadm kubeconfigæ–‡ä»¶:</p>
<ul>
<li>
<p>ä¸€ä¸ªkubeconfigæ–‡ä»¶ï¼Œä¾›kubeletä½¿ç”¨ï¼Œ</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>/etc/kubernetes/kubelet.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ï¼›åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­åµŒå…¥äº†ä¸€ä¸ªå¸¦æœ‰kubeletæ ‡è¯†çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚æ­¤å®¢æˆ·è¯ä¹¦åº”è¯¥ï¼š</p>
<ul>
<li>åœ¨ <code v-pre>system:nodes</code>ç»„ç»‡ä¸­ï¼Œæ ¹æ®<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_node_authorization.html" target="_blank" rel="noopener noreferrer">èŠ‚ç‚¹æˆæƒ<ExternalLinkIcon/></a>æ¨¡å—çš„è¦æ±‚</li>
<li>CNä¸º <code v-pre>system:node:&lt;hostname-lowercased&gt;</code></li>
</ul>
</li>
<li>
<p>ä¸€ä¸ªkubeconfigæ–‡ä»¶ï¼Œä¾›æ§åˆ¶å™¨ç®¡ç†å™¨ä½¿ç”¨ï¼Œ<code v-pre>/etc/kubernetes/controller-manager.conf</code>ï¼›åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­åµŒå…¥äº†ä¸€ä¸ªå¸¦æœ‰æ§åˆ¶å™¨ç®¡ç†å™¨æ ‡è¯†çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚è¿™ä¸ªå®¢æˆ·ç«¯è¯ä¹¦çš„CNåº”è¯¥ä¸º <code v-pre>system:kube-controller-manager</code>ï¼Œè¿™æ˜¯ç”±é»˜è®¤çš„<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_rbac_authorization.html#hexinzujianjiaose" target="_blank" rel="noopener noreferrer">RBACæ ¸å¿ƒç»„ä»¶è§’è‰²<ExternalLinkIcon/></a>å®šä¹‰çš„</p>
</li>
<li>
<p>ä¸€ä¸ªkubeconfigæ–‡ä»¶ï¼Œä¾›è°ƒåº¦å™¨ä½¿ç”¨ï¼Œ<code v-pre>/etc/kubernetes/scheduler.conf</code>ï¼›åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­åµŒå…¥äº†ä¸€ä¸ªå¸¦æœ‰è°ƒåº¦å™¨æ ‡è¯†çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚è¿™ä¸ªå®¢æˆ·ç«¯è¯ä¹¦CNåº”è¯¥ä¸º<code v-pre>system:kube-scheduler</code>ï¼Œè¿™æ˜¯ç”±é»˜è®¤çš„<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_rbac_authorization.html#hexinzujianjiaose-1" target="_blank" rel="noopener noreferrer">RBACæ ¸å¿ƒç»„ä»¶è§’è‰²<ExternalLinkIcon/></a>å®šä¹‰çš„</p>
</li>
</ul>
<p>æ­¤å¤–ï¼Œè¿˜ç”Ÿæˆä¸€ä¸ªkubeadmè‡ªèº«å’Œç®¡ç†å‘˜ä½¿ç”¨çš„kubeconfigæ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°<code v-pre>/etc/kubernetes/admin.conf</code>æ–‡ä»¶ä¸­ã€‚è¿™é‡Œçš„<code v-pre>admin</code>å®šä¹‰äº†ç®¡ç†é›†ç¾¤å¹¶å¸Œæœ›å®Œå…¨æ§åˆ¶ï¼ˆrootï¼‰é›†ç¾¤çš„å®é™…äººå‘˜ã€‚ç”¨äº<code v-pre>admin</code>çš„åµŒå…¥å¼å®¢æˆ·ç«¯è¯ä¹¦åº”è¯¥ï¼š</p>
<ul>
<li>åœ¨<code v-pre>system:masters</code>ç»„ç»‡ä¸­ï¼Œå¦‚é»˜è®¤çš„<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_rbac_authorization.html#mianxiangyonghudejiaose" target="_blank" rel="noopener noreferrer">RBACç”¨æˆ·é¢å‘è§’è‰²ç»‘å®š<ExternalLinkIcon/></a>æ‰€å®šä¹‰çš„é‚£æ ·</li>
<li>åŒ…å«ä¸€ä¸ªCNï¼Œä½†å®ƒå¯ä»¥æ˜¯ä»»ä½•å€¼ã€‚Kubeadmä½¿ç”¨CN <code v-pre>kubernetes-admin</code></li>
</ul>
<p>è¯·æ³¨æ„ï¼š</p>
<ol>
<li><code v-pre>ca.crt</code>è¯ä¹¦è¢«åµŒå…¥åˆ°æ‰€æœ‰kubeconfigæ–‡ä»¶ä¸­ã€‚</li>
<li>å¦‚æœå­˜åœ¨ä¸€ä¸ªç»™å®šçš„kubeconfigæ–‡ä»¶ï¼Œå¹¶ä¸”å®ƒçš„å†…å®¹ç¬¦åˆä¸Šé¢çš„è§„èŒƒï¼Œé‚£ä¹ˆå°†ä½¿ç”¨ç°æœ‰çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è·³è¿‡ç»™å®škubeconfigçš„ç”Ÿæˆé˜¶æ®µã€‚</li>
<li>å¦‚æœkubeadmåœ¨å¤–éƒ¨CAæ¨¡å¼ä¸‹è¿è¡Œï¼Œé‚£ä¹ˆç”¨æˆ·è¿˜å¿…é¡»æä¾›æ‰€æœ‰å¿…éœ€çš„kubeconfigï¼Œå› ä¸ºkubeadmæœ¬èº«ä¸èƒ½ç”Ÿæˆä»»ä½•kubeonfig</li>
<li>åœ¨kubeadmä»¥<code v-pre>--dry-run</code>æ¨¡å¼æ—¶ï¼Œkubeconfigæ–‡ä»¶è¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-kubeconfig" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init phase kubeconfig all</code><ExternalLinkIcon/></a> å‘½ä»¤å•ç‹¬è°ƒç”¨Kubeconfigæ–‡ä»¶ç”Ÿæˆã€‚</li>
</ol>
<h3 id="ä¸ºæ§åˆ¶å¹³é¢ç»„ä»¶ç”ŸæˆpodåŠèˆ±æ¸…å•" tabindex="-1"><a class="header-anchor" href="#ä¸ºæ§åˆ¶å¹³é¢ç»„ä»¶ç”ŸæˆpodåŠèˆ±æ¸…å•" aria-hidden="true">#</a> ä¸ºæ§åˆ¶å¹³é¢ç»„ä»¶ç”ŸæˆpodåŠèˆ±æ¸…å•</h3>
<p>Kubeadmå°†æ§åˆ¶å¹³é¢ç»„ä»¶çš„é™æ€Podæ¸…å•æ–‡ä»¶å†™å…¥<code v-pre>/etc/kubernetes/manifests</code>ï¼›kubeletç›‘æ§è¿™ä¸ªç›®å½•ï¼Œä»¥ä¾¿åœ¨å¯åŠ¨æ—¶åˆ›å»ºpodã€‚</p>
<p>é™æ€Podæ¸…å•å…±äº«ä¸€ç»„å…¬å…±å±æ€§:</p>
<ul>
<li>
<p>æ‰€æœ‰é™æ€podéƒ½éƒ¨ç½²åœ¨<code v-pre>kube-system</code>å‘½åç©ºé—´ä¸­</p>
</li>
<li>
<p>æ‰€æœ‰é™æ€podéƒ½æœ‰ <code v-pre>tier:control-plane</code> å’Œ<code v-pre>component:{component-name}</code> æ ‡ç­¾</p>
</li>
<li>
<p>æ‰€æœ‰é™æ€podéƒ½æœ‰ <code v-pre>scheduler.alpha.kubernetes.io/critical-pod</code>æ³¨è§£ï¼ˆè¿™å°†è½¬ç§»åˆ°é€‚å½“çš„è§£å†³æ–¹æ¡ˆï¼Œå³åœ¨å°±ç»ªæ—¶ä½¿ç”¨Podä¼˜å…ˆçº§å’ŒæŠ¢å ï¼‰</p>
</li>
<li>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>hostNetwork: true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è®¾ç½®åœ¨æ‰€æœ‰é™æ€podä¸Šï¼Œå…è®¸åœ¨é…ç½®ç½‘ç»œä¹‹å‰å¯åŠ¨æ§åˆ¶å¹³é¢ï¼›ç»“æœ:</p>
<ul>
<li>æ§åˆ¶å™¨ç®¡ç†å™¨å’Œè°ƒåº¦å™¨ç”¨æ¥å¼•ç”¨APIæœåŠ¡å™¨çš„<code v-pre>address</code>æ˜¯<code v-pre>127.0.0.1</code></li>
<li>å¦‚æœä½¿ç”¨æœ¬åœ°etcdæœåŠ¡å™¨ï¼Œ<code v-pre>etcd-servers</code>åœ°å€å°†è¢«è®¾ç½®ä¸º<code v-pre>127.0.0.1:2379</code></li>
</ul>
</li>
<li>
<p>æ§åˆ¶å™¨ç®¡ç†å™¨å’Œè°ƒåº¦å™¨éƒ½å¯ç”¨äº†é€‰ä¸»åŠŸèƒ½</p>
</li>
<li>
<p>æ§åˆ¶å™¨ç®¡ç†å™¨å’Œè°ƒåº¦å™¨å°†ä½¿ç”¨å„è‡ªçš„æƒŸä¸€æ ‡è¯†å¼•ç”¨kubeconfigæ–‡ä»¶</p>
</li>
<li>
<p>æ‰€æœ‰é™æ€podè·å–ç”¨æˆ·æŒ‡å®šçš„æ‰€æœ‰é¢å¤–é€‰é¡¹ï¼Œå¦‚<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#xiangkongzhipingmianchuandizidingyixuanxiang" target="_blank" rel="noopener noreferrer">å‘æ§åˆ¶å¹³é¢ä¼ é€’è‡ªå®šä¹‰é€‰é¡¹<ExternalLinkIcon/></a>ä¸­æ‰€è¿°</p>
</li>
<li>
<p>æ‰€æœ‰é™æ€podè·å–ç”¨æˆ·ï¼ˆ<code v-pre>hostPath</code>ï¼‰æŒ‡å®šçš„æ‰€æœ‰é¢å¤–å·</p>
</li>
</ul>
<p>è¯·æ³¨æ„ï¼š</p>
<ol>
<li>æ‰€æœ‰çš„é•œåƒï¼Œå¯¹äº <code v-pre>--kubernetes-version</code>æˆ–å½“å‰æ¶æ„ï¼Œå°†ä»<code v-pre>k8s.gcr.io</code>æ‹‰å–ã€‚å¦‚æœæŒ‡å®šäº†æ›¿ä»£é•œåƒä»“åº“æˆ–CIé•œåƒä»“åº“ï¼Œåˆ™ä½¿ç”¨æ­¤ä»“åº“ï¼›å¦‚æœæ‰€æœ‰æ§åˆ¶å¹³é¢ç»„ä»¶éƒ½åº”è¯¥ä½¿ç”¨ç‰¹å®šçš„å®¹å™¨é•œåƒï¼Œåˆ™å°†ä½¿ç”¨æ­¤é•œåƒã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#shiyongzidingyijingxiang" target="_blank" rel="noopener noreferrer">ä½¿ç”¨è‡ªå®šä¹‰é•œåƒ<ExternalLinkIcon/></a></li>
<li>åœ¨kubeadmä»¥<code v-pre>--dry-run</code>æ¨¡å¼æ‰§è¡Œæ—¶ï¼Œé™æ€Podæ–‡ä»¶è¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹</li>
<li>å¯ä»¥ä½¿ç”¨ <a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-control-plane" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init phase control-plane all</code><ExternalLinkIcon/></a>å‘½ä»¤å•ç‹¬è°ƒç”¨ä¸»ç»„ä»¶çš„é™æ€Podæ¸…å•ç”Ÿæˆ</li>
</ol>
<h4 id="apiæœåŠ¡å™¨" tabindex="-1"><a class="header-anchor" href="#apiæœåŠ¡å™¨" aria-hidden="true">#</a> APIæœåŠ¡å™¨</h4>
<p>APIæœåŠ¡å™¨çš„é™æ€Podæ¸…å•å—ç”¨æˆ·æä¾›çš„å‚æ•°å½±å“:</p>
<ul>
<li>è¦ç»‘å®šçš„<code v-pre>apiserver-advertise-address</code> å’Œ<code v-pre>apiserver-bind-port</code> ï¼›å¦‚æœæ²¡æœ‰æä¾›ï¼Œè¿™äº›å€¼é»˜è®¤ä¸ºæœºå™¨ä¸Šé»˜è®¤ç½‘ç»œæ¥å£çš„IPåœ°å€å’Œ6443ç«¯å£</li>
<li>ç”¨äºæœåŠ¡çš„<code v-pre>service-cluster-ip-range</code></li>
<li>å¦‚æœæŒ‡å®šäº†å¤–éƒ¨etcdæœåŠ¡å™¨ï¼Œåˆ™æŒ‡å®š <code v-pre>etcd-servers</code> åœ°å€å’Œç›¸å…³TLSè®¾ç½®ï¼ˆ<code v-pre>etcd-cafile</code>ã€<code v-pre>etcd-certfile</code>ã€<code v-pre>etcd-keyfile</code>ï¼‰ï¼›å¦‚æœä¸æä¾›å¤–éƒ¨etcdæœåŠ¡å™¨ï¼Œåˆ™ä½¿ç”¨æœ¬åœ°etcdï¼ˆé€šè¿‡ä¸»æœºç½‘ç»œï¼‰</li>
<li>å¦‚æœæŒ‡å®šäº†äº‘æä¾›å•†ï¼Œåˆ™é…ç½®ç›¸åº”çš„ <code v-pre>--cloud-provider</code>ï¼Œå¦‚æœå­˜åœ¨ <code v-pre>--cloud-config</code>è·¯å¾„ï¼ˆè¿™æ˜¯å®éªŒæ€§çš„ã€alphaçº§åˆ«ï¼Œå°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­åˆ é™¤ï¼‰</li>
</ul>
<p>å…¶ä»–æ— æ¡ä»¶è®¾ç½®çš„APIæœåŠ¡å™¨é€‰é¡¹æœ‰ï¼š</p>
<ul>
<li>
<p><code v-pre>--insecure-port=0</code> é¿å…ä¸APIæœåŠ¡å™¨çš„ä¸å®‰å…¨è¿æ¥</p>
</li>
<li>
<p><code v-pre>--enable-bootstrap-token-auth=true</code> å¯ç”¨ <code v-pre>BootstrapTokenAuthenticator</code> è®¤è¯æ¨¡å—ã€‚æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/command_line_tools_reference/tls_bootstrapping.html" target="_blank" rel="noopener noreferrer">TLSå¼•å¯¼<ExternalLinkIcon/></a></p>
</li>
<li>
<p><code v-pre>--allow-privileged</code> ä¸º<code v-pre>true</code> ï¼ˆå¿…é¡»ï¼Œä¾‹å¦‚ï¼škube-proxyï¼‰</p>
</li>
<li>
<p><code v-pre>--requestheader-client-ca-file</code> ä¸º<code v-pre>front-proxy-ca.crt</code></p>
</li>
<li>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>--enable-admission-plugins
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸ºï¼š</p>
<ul>
<li><a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#namespacelifecycle" target="_blank" rel="noopener noreferrer"><code v-pre>NamespaceLifecycle</code><ExternalLinkIcon/></a> é¿å…åˆ é™¤ç³»ç»Ÿä¿ç•™çš„å‘½åç©ºé—´</li>
<li><a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#limitranger" target="_blank" rel="noopener noreferrer"><code v-pre>LimitRanger</code><ExternalLinkIcon/></a> å’Œ<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#resourcequota" target="_blank" rel="noopener noreferrer"><code v-pre>ResourceQuota</code><ExternalLinkIcon/></a> æ‰§è¡Œå‘½åç©ºé—´é™åˆ¶</li>
<li><a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#serviceaccount" target="_blank" rel="noopener noreferrer"><code v-pre>ServiceAccount</code><ExternalLinkIcon/></a> æ‰§è¡ŒæœåŠ¡è´¦æˆ·è‡ªåŠ¨åŒ–</li>
<li><a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#persistentvolumelabel" target="_blank" rel="noopener noreferrer"><code v-pre>PersistentVolumeLabel</code><ExternalLinkIcon/></a> å°†åœ°åŒºï¼ˆregionï¼‰æˆ–åŒºåŸŸï¼ˆzoneï¼‰æ ‡ç­¾é™„åŠ åˆ°äº‘æä¾›å•†å®šä¹‰çš„æŒä¹…å·ä¸Šï¼ˆä¸æ¨èä½¿ç”¨æ­¤å‡†å…¥æ§åˆ¶å™¨ï¼Œå¹¶å°†åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤ï¼‰ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸æ˜ç¡®é€‰æ‹©ä½¿ç”¨<code v-pre>gce</code>æˆ–<code v-pre>aws</code>ä½œä¸ºäº‘æä¾›å•†æ—¶ï¼Œåœ¨v1.9ä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œkubeadmä¸ä¼šéƒ¨ç½²æ­¤å‡†å…¥æ§åˆ¶å™¨ï¼‰</li>
<li><a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#defaultstorageclass" target="_blank" rel="noopener noreferrer"><code v-pre>DefaultStorageClass</code><ExternalLinkIcon/></a> åœ¨ <code v-pre>PersistentVolumeClaim</code>å¯¹è±¡ä¸Šå¼ºåˆ¶æ‰§è¡Œé»˜è®¤å­˜å‚¨ç±»ã€</li>
<li><a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#defaulttolerationseconds" target="_blank" rel="noopener noreferrer"><code v-pre>DefaultTolerationSeconds</code><ExternalLinkIcon/></a></li>
<li><a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#noderestriction" target="_blank" rel="noopener noreferrer"><code v-pre>NodeRestriction</code><ExternalLinkIcon/></a> é™åˆ¶kubeletå¯ä»¥ä¿®æ”¹çš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œåªæœ‰è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„podï¼‰</li>
</ul>
</li>
<li>
<p><code v-pre>--kubelet-preferred-address-types</code> ä¸º<code v-pre>InternalIP,ExternalIP,Hostname;</code> è¿™ä½¿å¾—<code v-pre>kubectl logs</code>å’Œå…¶ä»–APIæœåŠ¡å™¨ä¸kubeletçš„é€šä¿¡å¯ä»¥åœ¨èŠ‚ç‚¹çš„ä¸»æœºåæ— æ³•è§£æçš„ç¯å¢ƒä¸­å·¥ä½œ</p>
</li>
<li>
<p>ä½¿ç”¨å‰é¢æ­¥éª¤ç”Ÿæˆçš„è¯ä¹¦çš„é€‰é¡¹:</p>
<ul>
<li><code v-pre>--client-ca-file</code> ä¸º<code v-pre>ca.crt</code></li>
<li><code v-pre>--tls-cert-file</code> ä¸º<code v-pre>apiserver.crt</code></li>
<li><code v-pre>--tls-private-key-file</code> ä¸º<code v-pre>apiserver.key</code></li>
<li><code v-pre>--kubelet-client-certificate</code> ä¸º<code v-pre>apiserver-kubelet-client.crt</code></li>
<li><code v-pre>--kubelet-client-key</code> ä¸º<code v-pre>apiserver-kubelet-client.key</code></li>
<li><code v-pre>--service-account-key-file</code> ä¸º<code v-pre>sa.pub</code></li>
<li><code v-pre>--requestheader-client-ca-file</code> ä¸º-proxy-ca.crt`</li>
<li><code v-pre>--proxy-client-cert-file</code> ä¸º<code v-pre>front-proxy-client.crt</code></li>
<li><code v-pre>--proxy-client-key-file</code> ä¸º<code v-pre>front-proxy-client.key</code></li>
</ul>
</li>
<li>
<p>ç”¨äºä¿æŠ¤å‰ç«¯ä»£ç†ï¼ˆ</p>
<p>APIèšåˆ</p>
<p>ï¼‰é€šä¿¡çš„å…¶ä»–é€‰é¡¹ï¼š</p>
<ul>
<li><code v-pre>--requestheader-username-headers=X-Remote-User</code></li>
<li><code v-pre>--requestheader-group-headers=X-Remote-Group</code></li>
<li>``--requestheader-extra-headers-prefix=X-Remote-Extra-`</li>
<li><code v-pre>--requestheader-allowed-names=front-proxy-client</code></li>
</ul>
</li>
</ul>
<h4 id="æ§åˆ¶å™¨ç®¡ç†å™¨" tabindex="-1"><a class="header-anchor" href="#æ§åˆ¶å™¨ç®¡ç†å™¨" aria-hidden="true">#</a> æ§åˆ¶å™¨ç®¡ç†å™¨</h4>
<p>APIæœåŠ¡å™¨çš„é™æ€Podæ¸…å•å—ç”¨æˆ·æä¾›çš„å‚æ•°å½±å“:</p>
<ul>
<li>
<p>å¦‚æœè°ƒç”¨kubeadmæ—¶æŒ‡å®šäº†</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>--pod-network-cidr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ï¼Œåˆ™é€šè¿‡è®¾ç½®ä»¥ä¸‹é€‰é¡¹å¯ä»¥å¯ç”¨æŸäº›CNIç½‘ç»œæ’ä»¶æ‰€éœ€çš„å­ç½‘ç®¡ç†å™¨ç‰¹æ€§:</p>
<ul>
<li><code v-pre>--allocate-node-cidrs=true</code></li>
<li><code v-pre>--cluster-cidr</code> å’Œ<code v-pre>--node-cidr-mask-size</code> é€‰é¡¹ï¼ˆæ ¹æ®æŒ‡å®šçš„CIDRï¼‰</li>
<li>å¦‚æœæŒ‡å®šäº†äº‘æä¾›å•†ï¼Œåˆ™é…ç½®ç›¸åº”çš„ <code v-pre>--cloud-provider</code>ï¼Œå¦‚æœå­˜åœ¨ <code v-pre>--cloud-config</code>è·¯å¾„ï¼ˆè¿™æ˜¯å®éªŒæ€§çš„ã€alphaçº§åˆ«ï¼Œå°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­åˆ é™¤ï¼‰</li>
</ul>
</li>
</ul>
<p>å…¶ä»–æ— æ¡ä»¶è®¾ç½®çš„é€‰é¡¹æœ‰:</p>
<ul>
<li><code v-pre>--controllers</code> ä¸ºTLSå¼•å¯¼å¯ç”¨æ‰€æœ‰é»˜è®¤æ§åˆ¶å™¨ä»¥åŠ<code v-pre>BootstrapSigner</code>å’Œ<code v-pre>TokenCleaner</code>æ§åˆ¶å™¨ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/command_line_tools_reference/tls_bootstrapping.html" target="_blank" rel="noopener noreferrer">TLSå¼•å¯¼<ExternalLinkIcon/></a></li>
<li><code v-pre>--use-service-account-credentials</code> ä¸º<code v-pre>true</code></li>
<li>ä½¿ç”¨å‰é¢æ­¥éª¤ç”Ÿæˆçš„è¯ä¹¦çš„é€‰é¡¹:
<ul>
<li><code v-pre>--root-ca-file</code> ä¸º<code v-pre>ca.crt</code></li>
<li><code v-pre>--cluster-signing-cert-file</code> ä¸º<code v-pre>ca.crt</code>ï¼Œå¦‚æœç¦ç”¨äº†å¤–éƒ¨CAæ¨¡å¼ï¼Œåˆ™è®¾ç½®ä¸º<code v-pre>&quot;&quot;</code></li>
<li><code v-pre>--cluster-signing-key-file</code> ä¸º<code v-pre>ca.key</code>ï¼Œå¦‚æœç¦ç”¨äº†å¤–éƒ¨CAæ¨¡å¼ï¼Œåˆ™è®¾ç½®ä¸º<code v-pre>&quot;&quot;</code></li>
<li><code v-pre>--service-account-private-key-file</code> ä¸º<code v-pre>sa.key</code></li>
</ul>
</li>
</ul>
<h4 id="è°ƒåº¦å™¨" tabindex="-1"><a class="header-anchor" href="#è°ƒåº¦å™¨" aria-hidden="true">#</a> è°ƒåº¦å™¨</h4>
<p>è°ƒåº¦å™¨çš„é™æ€Podæ¸…å•ä¸å—ç”¨æˆ·æä¾›çš„å‚æ•°çš„å½±å“ã€‚</p>
<h3 id="ä¸ºæœ¬åœ°etcdç”Ÿæˆé™æ€podæ¸…å•" tabindex="-1"><a class="header-anchor" href="#ä¸ºæœ¬åœ°etcdç”Ÿæˆé™æ€podæ¸…å•" aria-hidden="true">#</a> ä¸ºæœ¬åœ°etcdç”Ÿæˆé™æ€Podæ¸…å•</h3>
<p>å¦‚æœç”¨æˆ·æŒ‡å®šäº†ä¸€ä¸ªå¤–éƒ¨etcdï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ï¼Œå¦åˆ™kubeadmå°†ç”Ÿæˆä¸€ä¸ªé™æ€Podæ¸…å•æ–‡ä»¶ï¼Œç”¨äºåˆ›å»ºåœ¨Podä¸­è¿è¡Œçš„æœ¬åœ°etcdå®ä¾‹ï¼Œè¯¥å®ä¾‹å…·æœ‰ä»¥ä¸‹å±æ€§:</p>
<ul>
<li>åœ¨ <code v-pre>localhost:2379</code> ä¸Šè¿›è¡Œç›‘å¬å¹¶ä½¿ç”¨ <code v-pre>HostNetwork=true</code></li>
<li>å°† <code v-pre>hostPath</code>ä»<code v-pre>dataDir</code>æŒ‚è½½åˆ°ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿ</li>
<li>ç”¨æˆ·æŒ‡å®šçš„ä»»ä½•é¢å¤–é€‰é¡¹</li>
</ul>
<p>è¯·æ³¨æ„ï¼š</p>
<ol>
<li>etcdé•œåƒå°†ä»<code v-pre>k8.gcr.io</code>ä¸­æ‹‰å–ã€‚å¦‚æœæŒ‡å®šäº†å¦ä¸€ä¸ªé•œåƒä»“åº“ï¼Œåˆ™ä½¿ç”¨æ­¤é•œåƒä»“åº“ï¼›å¦‚æœæŒ‡å®šäº†å…¶ä»–é•œåƒåç§°ï¼Œåˆ™å°†ä½¿ç”¨æ­¤é•œåƒåç§°ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#shiyongzidingyijingxiang-1" target="_blank" rel="noopener noreferrer">ä½¿ç”¨è‡ªå®šä¹‰é•œåƒ<ExternalLinkIcon/></a></li>
<li>åœ¨kubeadmä»¥<code v-pre>--dry-run</code>æ¨¡å¼æ‰§è¡Œæ—¶ï¼Œé™æ€Podæ–‡ä»¶è¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹</li>
<li>æœ¬åœ°etcdçš„é™æ€Podæ¸…å•ç”Ÿæˆå¯ä»¥ä½¿ç”¨<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-etcd" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init phase etcd local</code><ExternalLinkIcon/></a> å‘½ä»¤å•ç‹¬è°ƒç”¨</li>
</ol>
<h3 id="å¯é€‰çš„åŠ¨æ€kubleté…ç½®" tabindex="-1"><a class="header-anchor" href="#å¯é€‰çš„åŠ¨æ€kubleté…ç½®" aria-hidden="true">#</a> å¯é€‰çš„åŠ¨æ€Kubleté…ç½®</h3>
<p>è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·è°ƒç”¨ <code v-pre>kubeadm alpha kubelet config enable-dynamic</code>ã€‚å®ƒå°†kubeletåˆå§‹åŒ–é…ç½®å†™å…¥ <code v-pre>/var/lib/kubelet/config/init/kubelet</code>æ–‡ä»¶ã€‚</p>
<p>åˆå§‹åŒ–é…ç½®ç”¨äºåœ¨æ­¤ç‰¹å®šèŠ‚ç‚¹ä¸Šå¯åŠ¨kubeletï¼Œä¸ºkubeletçš„drop-inæ–‡ä»¶æä¾›äº†å¦ä¸€ç§é€‰æ‹©ï¼›è¿™äº›é…ç½®å°†è¢«kubeletåŸºæœ¬é…ç½®æ‰€æ›¿ä»£ï¼Œå¦‚ä¸‹é¢çš„æ­¥éª¤æ‰€è¿°ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/tasks/administer_cluster/set_kubelet_parameters_via_a_config_file.html" target="_blank" rel="noopener noreferrer">é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®Kubeletå‚æ•°<ExternalLinkIcon/></a>ã€‚</p>
<p>è¯·æ³¨æ„ï¼š</p>
<ul>
<li>è¦ä½¿åŠ¨æ€kubeleté…ç½®å·¥ä½œï¼Œ<code v-pre>--dynamic-config-dir=/var/lib/kubelet/config/dynamic</code> åº”è¯¥åœ¨ <code v-pre>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code>ä¸­æŒ‡å®š</li>
<li>ä½¿ç”¨é…ç½®æ–‡ä»¶<code v-pre>--config some-file.yaml</code>å‘<code v-pre>kubeadm init</code> æˆ–<code v-pre>kubeadm join</code> ä¼ é€’ä¸€ä¸ª <code v-pre>KubeletConfiguration</code>å¯¹è±¡ï¼Œå¯ä»¥æ›´æ”¹kubeleté…ç½®ã€‚å¯ä»¥ä½¿ç”¨<code v-pre>---</code>åˆ†éš”ç¬¦å°†<code v-pre>KubeletConfiguration</code>å¯¹è±¡ä¸å…¶ä»–å¯¹è±¡ï¼ˆå¦‚<code v-pre>InitConfiguration</code>ï¼‰åˆ†éš”å¼€ã€‚æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹ <code v-pre>kubeadm config print-default</code>å‘½ä»¤ã€‚</li>
</ul>
<h3 id="ç­‰å¾…æ§åˆ¶å¹³é¢å¯åŠ¨" tabindex="-1"><a class="header-anchor" href="#ç­‰å¾…æ§åˆ¶å¹³é¢å¯åŠ¨" aria-hidden="true">#</a> ç­‰å¾…æ§åˆ¶å¹³é¢å¯åŠ¨</h3>
<p>è¿™æ˜¯kubeadmé›†ç¾¤çš„å…³é”®æ—¶åˆ»ã€‚kubeadmå°†ç­‰å¾…<code v-pre>localhost:6443/healthz</code>è¿”å›<code v-pre>ok</code>ï¼Œä½†æ˜¯ä¸ºäº†æ£€æµ‹æ­»é”æ¡ä»¶ï¼Œå¦‚æœ<code v-pre>localhost:10255/healthz</code> ï¼ˆkubeletå­˜æ´»ï¼‰æˆ–<code v-pre>localhost:10255/healthz/syncloop</code> ï¼ˆkubeletå°±ç»ªï¼‰åœ¨40ç§’å’Œ60ç§’åéƒ½æ²¡æœ‰è¿”å›<code v-pre>ok</code>ï¼Œåˆ™kubeadmå°†å¿«é€Ÿå¤±è´¥ã€‚</p>
<p>kubeadmä¾èµ–äºkubeletæ¥æ‹‰å–æ§åˆ¶å¹³é¢é•œåƒï¼Œå¹¶å°†å…¶ä½œä¸ºé™æ€podæ­£å¸¸è¿è¡Œã€‚æ§åˆ¶å¹³é¢å¯åŠ¨åï¼Œkubeadmå°†å®Œæˆä»¥å¦‚ä¸‹æ®µè½ä¸­æè¿°çš„ä»»åŠ¡ã€‚</p>
<h3 id="åœ¨v1-9ä¸­ä¸ºå¯é€‰çš„alphaçº§åˆ«-å†™å…¥kubeletåŸºæœ¬é…ç½®" tabindex="-1"><a class="header-anchor" href="#åœ¨v1-9ä¸­ä¸ºå¯é€‰çš„alphaçº§åˆ«-å†™å…¥kubeletåŸºæœ¬é…ç½®" aria-hidden="true">#</a> ï¼ˆåœ¨v1.9ä¸­ä¸ºå¯é€‰çš„alphaçº§åˆ«ï¼‰å†™å…¥kubeletåŸºæœ¬é…ç½®</h3>
<p>å¦‚æœä½¿ç”¨ <code v-pre>--feature-gates=DynamicKubeletConfig</code>è°ƒç”¨kubeadmï¼š</p>
<ul>
<li>å°†kubeletåŸºæœ¬é…ç½®å†™å…¥<code v-pre>kube-system</code>å‘½åç©ºé—´ä¸­çš„<code v-pre>kubelet-base-config-v1.9</code> ConfigMap</li>
<li>åˆ›å»ºRBACè§„åˆ™ï¼Œæˆäºˆå¯¹æ‰€æœ‰å¼•å¯¼ä»¤ç‰Œå’Œæ‰€æœ‰kubeletå®ä¾‹(å³ <code v-pre>system:bootstrappers:kubeadm:default-node-token</code> å’Œ<code v-pre>system:nodes</code>ç»„)çš„ConfigMapçš„è¯»è®¿é—®æƒ</li>
<li>é€šè¿‡ <code v-pre>Node.spec.configSource</code>æŒ‡å‘æ–°åˆ›å»ºçš„ConfigMapï¼Œä¸ºåˆå§‹æ§åˆ¶å¹³é¢èŠ‚ç‚¹å¯ç”¨åŠ¨æ€kubeleté…ç½®ç‰¹æ€§ã€‚</li>
</ul>
<h3 id="å°†kubeadmé›†ç¾¤é…ç½®ä¿å­˜åœ¨configmapä¸­-ä¾›ä»¥åä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#å°†kubeadmé›†ç¾¤é…ç½®ä¿å­˜åœ¨configmapä¸­-ä¾›ä»¥åä½¿ç”¨" aria-hidden="true">#</a> å°†kubeadmé›†ç¾¤é…ç½®ä¿å­˜åœ¨ConfigMapä¸­ï¼Œä¾›ä»¥åä½¿ç”¨</h3>
<p>kubeadmå°†é€šè¿‡é€‰é¡¹æˆ–é…ç½®æ–‡ä»¶ä¼ é€’ç»™<code v-pre>kubeadm init</code>çš„é…ç½®ä¿å­˜åœ¨<code v-pre>kube-system</code>å‘½åç©ºé—´ä¸­åä¸º<code v-pre>kubeadm-config</code>çš„ConfigMapä¸­ã€‚</p>
<p>è¿™å°†ç¡®ä¿å°†æ¥æ‰§è¡Œkubeadmæ“ä½œï¼ˆå¦‚ï¼š<code v-pre>kubeadm upgrade</code>ï¼‰å°†èƒ½å¤Ÿç¡®å®šå®é™…/å½“å‰é›†ç¾¤çŠ¶æ€ï¼Œå¹¶åŸºäºè¯¥æ•°æ®åšå‡ºæ–°çš„å†³ç­–ã€‚</p>
<p>è¯·æ³¨æ„ï¼š</p>
<ol>
<li>åœ¨ä¸Šä¼ ä¹‹å‰ï¼Œæ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚ä»¤ç‰Œï¼Œå°†ä»é…ç½®ä¸­åˆ é™¤</li>
<li>å¯ä»¥ä½¿ç”¨<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-upload-config" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init phase upload-config</code><ExternalLinkIcon/></a> å‘½ä»¤å•ç‹¬è°ƒç”¨ä¸»èŠ‚ç‚¹é…ç½®çš„ä¸Šä¼ </li>
<li>å¦‚æœä½¿ç”¨kubeadm v1.7åˆå§‹åŒ–é›†ç¾¤ã€‚åœ¨å‡çº§åˆ°v1.8ä¹‹å‰ï¼Œä½ å¿…é¡»æ‰‹åŠ¨åˆ›å»ºä¸»èŠ‚ç‚¹é…ç½®ConfigMapã€‚ä¸ºäº†ç®€åŒ–è¿™ä¸€ä»»åŠ¡ï¼Œå®ç°äº† <a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_config.html" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm config upload (from-flags|from-file)</code><ExternalLinkIcon/></a></li>
</ol>
<h3 id="æ ‡è®°ä¸»èŠ‚ç‚¹" tabindex="-1"><a class="header-anchor" href="#æ ‡è®°ä¸»èŠ‚ç‚¹" aria-hidden="true">#</a> æ ‡è®°ä¸»èŠ‚ç‚¹</h3>
<p>ä¸€æ—¦æ§åˆ¶å¹³é¢å¯ç”¨ï¼Œkubeadmå°±ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œ:</p>
<ul>
<li>ä¸ºä¸»èŠ‚ç‚¹æ·»åŠ  <code v-pre>node-role.kubernetes.io/master=&quot;&quot;</code>æ ‡ç­¾</li>
<li>ä¸ºä¸»èŠ‚ç‚¹æ·»åŠ  <code v-pre>node-role.kubernetes.io/master:NoSchedule</code>æ±¡æŸ“</li>
</ul>
<p>è¯·æ³¨æ„ï¼š</p>
<ul>
<li>å¯ä»¥ä½¿ç”¨<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-mark-control-plane" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init phase mark-control-plane</code><ExternalLinkIcon/></a> å‘½ä»¤å•ç‹¬è°ƒç”¨æ ‡è®°æ§åˆ¶å¹³é¢é˜¶æ®µ</li>
</ul>
<h3 id="é…ç½®tlså¼•å¯¼ç”¨äºèŠ‚ç‚¹åŠ å…¥é›†ç¾¤" tabindex="-1"><a class="header-anchor" href="#é…ç½®tlså¼•å¯¼ç”¨äºèŠ‚ç‚¹åŠ å…¥é›†ç¾¤" aria-hidden="true">#</a> é…ç½®TLSå¼•å¯¼ç”¨äºèŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h3>
<p>Kubeadm<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/authenticating_with_bootstrap_tokens.html" target="_blank" rel="noopener noreferrer">ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œè¿›è¡Œè®¤è¯<ExternalLinkIcon/></a>ï¼Œå°†æ–°èŠ‚ç‚¹è¿æ¥åˆ°ç°æœ‰é›†ç¾¤ï¼›æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§<a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/cluster-lifecycle/bootstrap-discovery.md" target="_blank" rel="noopener noreferrer">è®¾è®¡ææ¡ˆ<ExternalLinkIcon/></a>ã€‚</p>
<p><code v-pre>kubeadm init</code>ç¡®ä¿ä¸ºè¯¥è¿›ç¨‹æ­£ç¡®é…ç½®äº†æ‰€æœ‰å†…å®¹ï¼Œè¿™åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ä»¥åŠè®¾ç½®APIæœåŠ¡å™¨å’Œæ§åˆ¶å™¨é€‰é¡¹ï¼ˆå¦‚å‰é¢å„æ®µè½ä¸­æ‰€è¿°ï¼‰ã€‚è¯·æ³¨æ„ï¼š</p>
<ul>
<li>å¯ä»¥ä½¿ç”¨<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-bootstrap-token" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init phase bootstrap-token</code><ExternalLinkIcon/></a> å‘½ä»¤é…ç½®èŠ‚ç‚¹çš„TLSå¼•å¯¼ï¼Œæ‰§è¡Œå¦‚ä¸‹å„æ®µè½æè¿°çš„æ‰€æœ‰é…ç½®æ­¥éª¤ï¼›æˆ–è€…ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½å¯ä»¥å•ç‹¬è°ƒç”¨</li>
</ul>
<h4 id="åˆ›å»ºå¼•å¯¼ä»¤ç‰Œ" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºå¼•å¯¼ä»¤ç‰Œ" aria-hidden="true">#</a> åˆ›å»ºå¼•å¯¼ä»¤ç‰Œ</h4>
<p><code v-pre>kubeadm init</code>åˆ›å»ºç¬¬ä¸€ä¸ªå¼•å¯¼ä»¤ç‰Œï¼Œè¯¥ä»¤ç‰Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥ç”±ç”¨æˆ·ä½¿ç”¨ <code v-pre>--token</code>ç®•æä¾›ï¼›æ­£å¦‚å¼•å¯¼ä»¤ç‰Œè§„èŒƒä¸­æ‰€è®°å½•çš„é‚£æ ·ï¼Œä»¤ç‰Œåº”è¯¥ä»¥åç§° <code v-pre>bootstrap-token-&lt;token-id&gt;</code> ä½œä¸ºSecretä¿å­˜åœ¨<code v-pre>kube-system</code>å‘½åç©ºé—´ä¸­ã€‚è¯·æ³¨æ„:</p>
<ol>
<li>ç”±<code v-pre>kubeadm init</code>åˆ›å»ºçš„ç¼ºçœä»¤ç‰Œå°†ç”¨äºéªŒè¯TLSå¼•å¯¼è¿‡ç¨‹ä¸­çš„ä¸´æ—¶ç”¨æˆ·ï¼›è¿™äº›ç”¨æˆ·å°†æ˜¯<code v-pre>system:bootstrappers:kubeadm:default-node-token</code> ç»„çš„æˆå‘˜</li>
<li>ä»¤ç‰Œçš„æœ‰æ•ˆæ€§æœ‰é™ï¼Œé»˜è®¤ä¸º24å°æ—¶ï¼ˆé—´éš”å¯ä»¥ä½¿ç”¨<code v-pre>â€”token-ttl</code> é€‰é¡¹æ›´æ”¹ï¼‰</li>
<li>å¯ä»¥ä½¿ç”¨<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_token.html" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm token</code><ExternalLinkIcon/></a>å‘½ä»¤åˆ›å»ºå…¶ä»–ä»¤ç‰Œï¼Œè¯¥å‘½ä»¤ä¸ºä»¤ç‰Œç®¡ç†æä¾›äº†å…¶ä»–æœ‰ç”¨çš„åŠŸèƒ½</li>
</ol>
<h4 id="å…è®¸è¦åŠ å…¥çš„èŠ‚ç‚¹è°ƒç”¨csr-api" tabindex="-1"><a class="header-anchor" href="#å…è®¸è¦åŠ å…¥çš„èŠ‚ç‚¹è°ƒç”¨csr-api" aria-hidden="true">#</a> å…è®¸è¦åŠ å…¥çš„èŠ‚ç‚¹è°ƒç”¨CSR API</h4>
<p>Kubeadmç¡®ä¿ <code v-pre>system:bootstrappers:kubeadm:default-node-token</code>ç»„ä¸­çš„ç”¨æˆ·èƒ½å¤Ÿè®¿é—®è¯ä¹¦ç­¾åAPIã€‚</p>
<p>è¿™æ˜¯é€šè¿‡åœ¨ä¸Šé¢çš„ç»„å’Œé»˜è®¤RBACè§’è‰² <code v-pre>system:node-bootstrapper</code>ä¹‹é—´åˆ›å»ºä¸€ä¸ªåä¸º <code v-pre>kubeadm:kubelet-bootstrap</code>çš„é›†ç¾¤è§’è‰²ç»‘å®šæ¥å®ç°çš„ã€‚</p>
<h4 id="ä¸ºæ–°çš„å¼•å¯¼ä»¤ç‰Œè®¾ç½®è‡ªåŠ¨æ‰¹å‡†" tabindex="-1"><a class="header-anchor" href="#ä¸ºæ–°çš„å¼•å¯¼ä»¤ç‰Œè®¾ç½®è‡ªåŠ¨æ‰¹å‡†" aria-hidden="true">#</a> ä¸ºæ–°çš„å¼•å¯¼ä»¤ç‰Œè®¾ç½®è‡ªåŠ¨æ‰¹å‡†</h4>
<p>Kubeadmç¡®ä¿å¼•å¯¼ä»¤ç‰Œå°†ç”±<code v-pre>csrapprover</code>æ§åˆ¶å™¨è‡ªåŠ¨æ‰¹å‡†å…¶CSRè¯·æ±‚ã€‚</p>
<p>è¿™æ˜¯é€šè¿‡åœ¨<code v-pre>system:bootstrappers:kubeadm:default-node-token</code> ç»„å’Œé»˜è®¤è§’è‰² <code v-pre>system:certificates.k8s.io:certificatesigningrequests:nodeclient</code>ä¹‹é—´åˆ›å»ºä¸€ä¸ªåä¸º <code v-pre>kubeadm:node-autoapprove-bootstrap</code> çš„é›†ç¾¤è§’è‰²ç»‘å®šæ¥å®ç°çš„ã€‚</p>
<p>åº”è¯¥ä¹Ÿåˆ›å»ºäº† <code v-pre>system:certificates.k8s.io:certificatesigningrequests:nodeclient</code>è§’è‰²ï¼Œè¯¥è§’è‰²è¢«æˆäºˆäº†å¯¹<code v-pre>/apis/certificates.k8s.io/certificatesigningrequests/nodeclient</code>çš„POSTæƒé™ã€‚</p>
<h4 id="ä¸ºèŠ‚ç‚¹è¯ä¹¦æ—‹è½¬è®¾ç½®è‡ªåŠ¨æ‰¹å‡†" tabindex="-1"><a class="header-anchor" href="#ä¸ºèŠ‚ç‚¹è¯ä¹¦æ—‹è½¬è®¾ç½®è‡ªåŠ¨æ‰¹å‡†" aria-hidden="true">#</a> ä¸ºèŠ‚ç‚¹è¯ä¹¦æ—‹è½¬è®¾ç½®è‡ªåŠ¨æ‰¹å‡†</h4>
<p>Kubeadmç¡®ä¿ä¸ºèŠ‚ç‚¹å¯ç”¨è¯ä¹¦æ—‹è½¬ï¼ŒèŠ‚ç‚¹çš„æ–°è¯ä¹¦è¯·æ±‚å°†ç”±<code v-pre>csrapprover</code>æ§åˆ¶å™¨è‡ªåŠ¨æ‰¹å‡†å…¶CSRè¯·æ±‚ã€‚</p>
<p>è¿™æ˜¯é€šè¿‡åœ¨<code v-pre>system:nodes</code> ç»„å’Œé»˜è®¤è§’è‰² <code v-pre>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</code>ä¹‹é—´åˆ›å»ºä¸€ä¸ªåä¸º <code v-pre>kubeadm:node-autoapprove-certificate-rotation</code> çš„é›†ç¾¤è§’è‰²ç»‘å®šæ¥å®ç°çš„ã€‚</p>
<h4 id="åˆ›å»ºå…¬å…±cluster-info-configmap" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºå…¬å…±cluster-info-configmap" aria-hidden="true">#</a> åˆ›å»ºå…¬å…±cluster-info ConfigMap</h4>
<p>è¿™ä¸ªé˜¶æ®µåœ¨<code v-pre>kube-public</code>å‘½åç©ºé—´ä¸­åˆ›å»º<code v-pre>cluster-info</code> ConfigMapã€‚</p>
<p>æ­¤å¤–ï¼Œå®ƒè¿˜åˆ›å»ºäº†ä¸€ä¸ªè§’è‰²å’Œä¸€ä¸ªè§’è‰²ç»‘å®šï¼Œæˆäºˆæœªç»è®¤è¯çš„ç”¨æˆ·ï¼ˆå³ <code v-pre>system:unauthenticated</code>ç»„ä¸­çš„ç”¨æˆ·ï¼‰è®¿é—®è¯¥ConfigMapçš„æƒé™ã€‚</p>
<p>è¯·æ³¨æ„ï¼š</p>
<ol>
<li>å¯¹<code v-pre>cluster-info</code> ConfigMapçš„è®¿é—®ä¸å—é€Ÿç‡é™åˆ¶ã€‚å¦‚æœä½ æŠŠä½ çš„ä¸»èŠ‚ç‚¹æš´éœ²åœ¨äº’è”ç½‘ä¸Šï¼Œè¿™å¯èƒ½æ˜¯ä¸ªé—®é¢˜ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯ï¼›æœ€åçš„æƒ…å†µæ˜¯DoSæ”»å‡»ï¼Œæ”»å‡»è€…ä½¿ç”¨APIæœåŠ¡å™¨èƒ½å¤Ÿå¤„ç†çš„æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¯·æ±‚æ¥è®¿é—®<code v-pre>cluster-info</code> ConfigMapã€‚</li>
</ol>
<h3 id="å®‰è£…æ’ä»¶" tabindex="-1"><a class="header-anchor" href="#å®‰è£…æ’ä»¶" aria-hidden="true">#</a> å®‰è£…æ’ä»¶</h3>
<p>Kubeadmé€šè¿‡APIæœåŠ¡å™¨å®‰è£…å†…éƒ¨DNSæœåŠ¡å™¨å’Œkube-proxyæ’ä»¶ç»„ä»¶ã€‚è¯·æ³¨æ„:</p>
<ol>
<li>æ­¤é˜¶æ®µå¯ä»¥ä½¿ç”¨ <a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-addon" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm init phase addon all</code><ExternalLinkIcon/></a>å‘½ä»¤å•ç‹¬è°ƒç”¨ã€‚</li>
</ol>
<h4 id="proxy" tabindex="-1"><a class="header-anchor" href="#proxy" aria-hidden="true">#</a> proxy</h4>
<p>åœ¨ <code v-pre>kube-system</code> å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªç”¨äº<code v-pre>kube-proxy</code>çš„ServiceAccountï¼›ç„¶å<code v-pre>kube-proxy</code>ä½œä¸ºDaemonSetéƒ¨ç½²:</p>
<ul>
<li>åˆ°ä¸»èŠ‚ç‚¹çš„å‡­æ®ï¼ˆ<code v-pre>ca.crt</code>å’Œ<code v-pre>token</code>ï¼‰æ¥è‡ªServiceAccount</li>
<li>ä¸»èŠ‚ç‚¹çš„ä½ç½®æ¥è‡ªConfigMap</li>
<li><code v-pre>kube-proxy</code> ServiceAccountç»‘å®šåˆ° <code v-pre>system:node-proxier</code> ClusterRoleä¸­çš„ç‰¹æƒ</li>
</ul>
<h4 id="dns" tabindex="-1"><a class="header-anchor" href="#dns" aria-hidden="true">#</a> DNS</h4>
<p>è¯·æ³¨æ„ï¼š</p>
<ul>
<li>CoreDNSæœåŠ¡è¢«å‘½åä¸º<code v-pre>kube-dns</code>ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢å½“ç”¨æˆ·å°†é›†ç¾¤DNSä»kube-dnsåˆ‡æ¢åˆ°CoreDNSï¼ˆåä¹‹äº¦ç„¶ï¼‰æ—¶æœåŠ¡ä¸­çš„ä»»ä½•ä¸­æ–­</li>
<li>åœ¨Kubernetes v1.10æˆ–æ›´æ—©çš„ç‰ˆæœ¬ä¸­ï¼Œå¿…é¡»ä½¿ç”¨ <code v-pre>--feature-gates=CoreDNS=true</code>å¯ç”¨CoreDNS</li>
<li>åœ¨Kubernetes v1.11å’Œv1.12ç‰ˆæœ¬ä¸­ï¼ŒCoreDNSæ˜¯é»˜è®¤çš„DNSæœåŠ¡å™¨ï¼Œå¿…é¡»ä½¿ç”¨ <code v-pre>--feature-gates=CoreDNS=false</code>è°ƒç”¨kubeadmæ¥å®‰è£…kube-dns</li>
<li>åœ¨Kubernetes v1.13åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒCoreDNSç‰¹æ€§å¼€å…³ä¸å†å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨è¿™é‡Œæè¿°çš„<code v-pre>--config</code>æ–¹æ³•å®‰è£…kube-dns</li>
</ul>
<p>åœ¨<code v-pre>kube-system</code>å‘½åç©ºé—´ä¸­åˆ›å»ºäº†ä¸€ä¸ªç”¨äºCoreDNSæˆ–kube-dnsçš„ServiceAccountã€‚</p>
<p>éƒ¨ç½²<code v-pre>kube-dns</code>éƒ¨ç½²å’ŒæœåŠ¡:</p>
<ul>
<li>è¿™æ˜¯ç›¸å¯¹æœªç»ä¿®æ”¹çš„ä¸Šæ¸¸æ ¸å¿ƒéƒ¨ç½²</li>
<li><code v-pre>kube-dns</code>æœåŠ¡å¸æˆ·ç»‘å®šåˆ° <code v-pre>system:kube-dns</code> ClusterRoleçš„ç‰¹æƒ</li>
</ul>
<h3 id="å¯é€‰çš„è‡ªæ‰˜ç®¡" tabindex="-1"><a class="header-anchor" href="#å¯é€‰çš„è‡ªæ‰˜ç®¡" aria-hidden="true">#</a> å¯é€‰çš„è‡ªæ‰˜ç®¡</h3>
<p>è¦åœ¨ç°æœ‰çš„é™æ€Podæ§åˆ¶å¹³é¢ä¸Šå¯ç”¨è‡ªæ‰˜ç®¡ï¼Œè¯·ä½¿ç”¨<code v-pre>kubeadm alpha selfhosting pivot</code>ã€‚</p>
<p>è‡ªæ‰˜ç®¡åŸºæœ¬ä¸Šç”¨DaemonSetæ›¿æ¢äº†ç”¨äºæ§åˆ¶å¹³é¢ç»„ä»¶çš„podåŠèˆ±ï¼›è¿™æ˜¯é€šè¿‡å¯¹APIæœåŠ¡å™¨ã€è°ƒåº¦å™¨å’Œæ§åˆ¶å™¨ç®¡ç†å™¨é™æ€åŠèˆ±æ‰§è¡Œä»¥ä¸‹æ­¥éª¤å®ç°çš„:</p>
<ul>
<li>ä»ç£ç›˜åŠ è½½é™æ€Podè§„çº¦</li>
<li>ä»é™æ€Podæ¸…å•æ–‡ä»¶ä¸­æå–PodSpec</li>
<li>ä¿®æ”¹PodSpecä½¿ä¹‹ä¸è‡ªæ‰˜ç®¡å…¼å®¹ï¼Œæ›´å¤šç»†èŠ‚:
<ul>
<li>æ·»åŠ èŠ‚ç‚¹é€‰æ‹©å™¨å±æ€§ï¼Œå®šå‘è‡³æ‹¥æœ‰<code v-pre>node-role.kubernetes.io/master=&quot;&quot;</code> æ ‡ç­¾çš„èŠ‚ç‚¹</li>
<li>æ·»åŠ  <code v-pre>node-role.kubernetes.io/master:NoSchedule</code> æ±¡æŸ“çš„å®¹å¿</li>
<li>å°† <code v-pre>spec.DNSPolicy</code> è®¾ç½®ä¸º<code v-pre>ClusterFirstWithHostNet</code></li>
</ul>
</li>
<li>ä½¿ç”¨ä¸Šé¢æåˆ°çš„PodSpecï¼Œä¸ºè‡ªæ‰˜ç®¡ç»„ä»¶æ„å»ºä¸€ä¸ªæ–°çš„DaemonSetå¯¹è±¡ã€‚</li>
<li>åœ¨<code v-pre>kube-system</code>å‘½åç©ºé—´ä¸­åˆ›å»ºDaemonSetèµ„æºï¼Œå¹¶ç­‰å¾…podå¼€å§‹è¿è¡Œã€‚</li>
<li>åˆ é™¤é™æ€Podæ¸…å•æ–‡ä»¶ã€‚kubeletå°†åœæ­¢åŸæ¥è¿è¡Œçš„é™æ€podæ‰˜ç®¡ç»„ä»¶</li>
</ul>
<p>è¯·æ³¨æ„ï¼Œè‡ªæ‰˜ç®¡å°šæœªæ¢å¤åˆ°èŠ‚ç‚¹é‡å¯ï¼›è¿™å¯ä»¥é€šè¿‡å¤–éƒ¨æ£€æŸ¥ç‚¹æˆ–æ§åˆ¶å¹³é¢podçš„kubeletæ£€æŸ¥ç‚¹æ¥ä¿®å¤ã€‚æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#zituoguan" target="_blank" rel="noopener noreferrer">è‡ªæ‰˜ç®¡<ExternalLinkIcon/></a>ã€‚</p>
<h3 id="kubeadm-join-phaseçš„å†…éƒ¨è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#kubeadm-join-phaseçš„å†…éƒ¨è®¾è®¡" aria-hidden="true">#</a> kubeadm join phaseçš„å†…éƒ¨è®¾è®¡</h3>
<p>ä¸<code v-pre>kubeadm init</code>ç±»ä¼¼ï¼Œ<code v-pre>kubeadm join</code>å†…éƒ¨å·¥ä½œæµç¨‹ä¹Ÿç”±ä¸€ç³»åˆ—è¦æ‰§è¡Œçš„åŸå­å·¥ä½œä»»åŠ¡ç»„æˆã€‚</p>
<p>è¿™åˆ†ä¸ºå‘ç°ï¼ˆè®©èŠ‚ç‚¹ä¿¡ä»»Kubernetesä¸»èŠ‚ç‚¹ï¼‰å’ŒTLSå¼•å¯¼ï¼ˆè®©Kubernetesä¸»èŠ‚ç‚¹ä¿¡ä»»è¯¥èŠ‚ç‚¹ï¼‰ã€‚</p>
<p>å‚è§<a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/authenticating_with_bootstrap_tokens.html" target="_blank" rel="noopener noreferrer">ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œè¿›è¡Œè®¤è¯<ExternalLinkIcon/></a>æˆ–ç›¸åº”çš„<a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/cluster-lifecycle/bootstrap-discovery.md" target="_blank" rel="noopener noreferrer">è®¾è®¡ææ¡ˆ<ExternalLinkIcon/></a>ã€‚</p>
<h3 id="é¢„å…ˆ-preflight-æ£€æŸ¥" tabindex="-1"><a class="header-anchor" href="#é¢„å…ˆ-preflight-æ£€æŸ¥" aria-hidden="true">#</a> é¢„å…ˆï¼ˆpreflightï¼‰æ£€æŸ¥</h3>
<p><code v-pre>kubeadm</code>åœ¨å¯åŠ¨åŠ å…¥é›†ç¾¤ä¹‹å‰æ‰§è¡Œä¸€ç»„é¢„å…ˆæ£€æŸ¥ï¼Œç›®çš„æ˜¯éªŒè¯å…ˆå†³æ¡ä»¶å¹¶é¿å…å¸¸è§çš„é›†ç¾¤å¯åŠ¨é—®é¢˜ã€‚</p>
<p>è¯·æ³¨æ„ï¼š</p>
<ol>
<li><code v-pre>kubeadm join</code>é¢„å…ˆæ£€æŸ¥åŸºæœ¬ä¸Šæ˜¯<code v-pre>kubeadm init</code>é¢„å…ˆæ£€æŸ¥çš„å­é›†</li>
<li>ä»v1.9å¼€å§‹ï¼Œkubeadmä¸ºCRI-genericåŠŸèƒ½æä¾›äº†æ›´å¥½çš„æ”¯æŒï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºcrictlè·³è¿‡æˆ–æ›¿æ¢dockerç‰¹å®šçš„æ§ä»¶ã€‚</li>
<li>ä»v1.9å¼€å§‹ï¼Œkubeadmæ”¯æŒè¿è¡Œåœ¨Windowsä¸Šçš„èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†è·³è¿‡linuxç‰¹å®šçš„æ§ä»¶ã€‚</li>
<li>åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨<code v-pre>--ignore-preflight-errors</code> é€‰é¡¹è·³è¿‡ç‰¹å®šçš„é¢„å…ˆæ£€æŸ¥ï¼ˆæˆ–è€…æœ€ç»ˆè·³è¿‡æ‰€æœ‰çš„é¢„å…ˆæ£€æŸ¥ï¼‰ã€‚</li>
</ol>
<h3 id="å‘ç°cluster-info" tabindex="-1"><a class="header-anchor" href="#å‘ç°cluster-info" aria-hidden="true">#</a> å‘ç°cluster-info</h3>
<p>æœ‰ä¸¤ç§ä¸»è¦çš„å‘ç°æ–¹æ¡ˆã€‚ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨å…±äº«ä»¤ç‰Œå’ŒAPIæœåŠ¡å™¨çš„IPåœ°å€ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯æä¾›ä¸€ä¸ªæ–‡ä»¶ï¼ˆå®ƒæ˜¯æ ‡å‡†kubeconfigæ–‡ä»¶çš„å­é›†ï¼‰ã€‚</p>
<h4 id="å…±äº«ä»¤ç‰Œå‘ç°" tabindex="-1"><a class="header-anchor" href="#å…±äº«ä»¤ç‰Œå‘ç°" aria-hidden="true">#</a> å…±äº«ä»¤ç‰Œå‘ç°</h4>
<p>å¦‚æœä½¿ç”¨<code v-pre>--discovery-token</code>è°ƒç”¨<code v-pre>kubeadm join</code>ï¼Œåˆ™ä½¿ç”¨ä»¤ç‰Œå‘ç°ï¼›åœ¨æœ¬ä¾‹ä¸­ï¼ŒèŠ‚ç‚¹åŸºæœ¬ä¸Šä»<code v-pre>kube-public</code>å‘½åç©ºé—´ä¸­çš„<code v-pre>cluster-info</code> ConfigMapä¸­æ£€ç´¢é›†ç¾¤CAè¯ä¹¦ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢â€œä¸­é—´äººâ€çš„æ”»å‡»ï¼Œæˆ‘ä»¬é‡‡å–äº†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:</p>
<ul>
<li>é¦–å…ˆï¼Œé€šè¿‡ä¸å®‰å…¨çš„è¿æ¥æ£€ç´¢CAè¯ä¹¦ï¼ˆè¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸º<code v-pre>kubeadm init</code>ä¸º<code v-pre>system:unauthenticated</code>æˆäºˆäº†å¯¹ <code v-pre>cluster-info</code> ç”¨æˆ·çš„è®¿é—®æƒé™ï¼‰</li>
<li>ç„¶åCAè¯ä¹¦ç»è¿‡ä»¥ä¸‹éªŒè¯æ­¥éª¤:
<ul>
<li>åŸºæœ¬éªŒè¯ï¼šå¯¹JWTç­¾åä½¿ç”¨ä»¤ç‰ŒID</li>
<li>å…¬é’¥éªŒè¯ï¼šä½¿ç”¨æä¾›çš„ <code v-pre>--discovery-token-ca-cert-hash</code>ã€‚è¿™ä¸ªå€¼åœ¨<code v-pre>kubeadm init</code>çš„è¾“å‡ºä¸­å¯ç”¨ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨æ ‡å‡†å·¥å…·è®¡ç®—ï¼ˆå“ˆå¸Œæ˜¯é€šè¿‡Subject Public Key Info (SPKI)å¯¹è±¡çš„å­—èŠ‚è®¡ç®—çš„ï¼Œå¦‚RFC7469ä¸­æ‰€ç¤ºï¼‰ã€‚<code v-pre>--discovery-token-ca-cert-hash flag</code> é€‰é¡¹å¯ä»¥é‡å¤å¤šæ¬¡ï¼Œä»¥å…è®¸å¤šä¸ªå…¬é’¥ã€‚</li>
<li>ä½œä¸ºé™„åŠ éªŒè¯ï¼ŒCAè¯ä¹¦é€šè¿‡å®‰å…¨è¿æ¥æ£€ç´¢ï¼Œç„¶åä¸æœ€åˆæ£€ç´¢çš„CAè¿›è¡Œæ¯”è¾ƒ</li>
</ul>
</li>
</ul>
<p>è¯·æ³¨è§£ï¼š</p>
<ol>
<li>é€šè¿‡ä¼ é€’<code v-pre>--discovery-token-unsafe-skip-ca-verification</code> é€‰é¡¹ï¼Œå¯ä»¥è·¯è¿‡å…¬é’¥éªŒè¯ï¼›è¿™å‰Šå¼±äº†kubeadmå®‰å…¨æ¨¡å‹ï¼Œå› ä¸ºå…¶ä»–äººå¯èƒ½å†’å……Kubernetesä¸»èŠ‚ç‚¹ã€‚</li>
</ol>
<h4 id="æ–‡ä»¶æˆ–httpså‘ç°" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶æˆ–httpså‘ç°" aria-hidden="true">#</a> æ–‡ä»¶æˆ–HTTPSå‘ç°</h4>
<p>å¦‚æœä½¿ç”¨<code v-pre>--discovery-file</code>è°ƒç”¨<code v-pre>kubeadm join</code>ï¼Œåˆ™ä½¿ç”¨æ–‡ä»¶å‘ç°ï¼›è¯¥æ–‡ä»¶å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡HTTPS URLä¸‹è½½ï¼›å¯¹äºHTTPSï¼Œä½¿ç”¨å·²å®‰è£…çš„ä¸»èŠ‚ç‚¹CA åŒ…éªŒè¯èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚</p>
<p>é€šè¿‡æ–‡ä»¶å‘ç°ï¼Œé›†ç¾¤CAè¯ä¹¦è¢«æ·»åŠ åœ¨æ–‡ä»¶æœ¬èº«ä¸­ï¼›äº‹å®ä¸Šï¼Œå‘ç°æ–‡ä»¶æ˜¯ä¸€ä¸ªkubeconfigæ–‡ä»¶ï¼Œåªè®¾ç½®äº† <code v-pre>server</code>å’Œ <code v-pre>certificate-authority-data</code>å±æ€§ï¼Œå¦‚ <a href="https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_join.html" target="_blank" rel="noopener noreferrer"><code v-pre>kubeadm join</code><ExternalLinkIcon/></a>å‚è€ƒæ–‡æ¡£ä¸­æ‰€è¿°ï¼›å½“ä¸é›†ç¾¤å»ºç«‹è¿æ¥æ—¶ï¼Œkubeadmå°è¯•è®¿é—®<code v-pre>cluster-info</code> ConfigMapï¼Œå¦‚æœå¯ç”¨ï¼Œåˆ™ä½¿ç”¨å®ƒã€‚</p>
<h3 id="tlså¼•å¯¼" tabindex="-1"><a class="header-anchor" href="#tlså¼•å¯¼" aria-hidden="true">#</a> TLSå¼•å¯¼</h3>
<p>ä¸€æ—¦çŸ¥é“é›†ç¾¤ä¿¡æ¯ï¼Œå°±ä¼šå†™å…¥<code v-pre>bootstrap-kubelet.conf</code>æ–‡ä»¶ï¼Œä»è€Œå…è®¸kubeletæ‰§è¡ŒTLSå¼•å¯¼ï¼ˆç›¸åï¼Œç›´åˆ°v.1.7 TLSå¼•å¯¼æ‰ç”±kubeadmç®¡ç†ï¼‰ã€‚</p>
<p>TLSå¼•å¯¼æœºåˆ¶ä½¿ç”¨å…±äº«ä»¤ç‰Œä¸Kubernetesä¸»èŠ‚ç‚¹è¿›è¡Œä¸´æ—¶è®¤è¯ï¼Œä¸ºæœ¬åœ°åˆ›å»ºçš„å¯†é’¥å¯¹æäº¤è¯ä¹¦ç­¾åè¯·æ±‚(CSR)ã€‚</p>
<p>ç„¶åè‡ªåŠ¨æ‰¹å‡†è¯·æ±‚ï¼Œä¿å­˜<code v-pre>ca.crt</code>æ–‡ä»¶å’Œ<code v-pre>kubelet.conf</code>æ–‡ä»¶ï¼Œkubeletå°†ä½¿ç”¨è¯¥æ–‡ä»¶åŠ å…¥é›†ç¾¤ï¼ŒåŒæ—¶åˆ é™¤<code v-pre>bootstrap-kubelet.conf</code>ã€‚</p>
<p>è¯·æ³¨æ„ï¼š</p>
<ul>
<li>ä¸´æ—¶è®¤è¯æ˜¯æ ¹æ®<code v-pre>kubeadm init</code>æµç¨‹ä¸­ä¿å­˜çš„ä»¤ç‰Œè¿›è¡ŒéªŒè¯çš„ï¼ˆæˆ–è€…ä½¿ç”¨<code v-pre>kubeadm token</code>åˆ›å»ºçš„å…¶ä»–ä»¤ç‰Œï¼‰</li>
<li>ä¸´æ—¶è®¤è¯è§£æä¸º<code v-pre>system:bootstrappers:kubeadm:default-node-token</code> ç»„çš„ç”¨æˆ·æˆå‘˜ï¼Œè¯¥ç”¨æˆ·ç»„åœ¨<code v-pre>kubeadm init</code>æµç¨‹ä¸­è¢«æˆäºˆè®¿é—®CSR APIçš„æƒé™</li>
<li>è‡ªåŠ¨CSRæ‰¹å‡†ç”±<code v-pre>csrapprover</code>æ§åˆ¶å™¨æ ¹æ®<code v-pre>kubeadm init</code>æµç¨‹çš„é…ç½®è¿›è¡Œç®¡ç†</li>
</ul>
<h4 id="åœ¨v1-9ä¸­ä¸ºå¯é€‰çš„alphaçº§åˆ«-å†™å…¥kubeletåˆå§‹åŒ–é…ç½®" tabindex="-1"><a class="header-anchor" href="#åœ¨v1-9ä¸­ä¸ºå¯é€‰çš„alphaçº§åˆ«-å†™å…¥kubeletåˆå§‹åŒ–é…ç½®" aria-hidden="true">#</a> ï¼ˆåœ¨v1.9ä¸­ä¸ºå¯é€‰çš„alphaçº§åˆ«ï¼‰å†™å…¥kubeletåˆå§‹åŒ–é…ç½®</h4>
<p>å¦‚æœä½¿ç”¨ <code v-pre>--feature-gates=DynamicKubeletConfig</code>è°ƒç”¨<code v-pre>kubeadm</code>ï¼š</p>
<ul>
<li>ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œå‡­è¯å°†kubeletåŸºæœ¬é…ç½®å†™å…¥<code v-pre>kube-system</code>å‘½åç©ºé—´ä¸­çš„<code v-pre>kubelet-base-config-v1.9</code> ConfigMapï¼Œå¹¶å°†å…¶ä½œä¸º kubeletåˆå§‹åŒ–æ–‡ä»¶ <code v-pre>/var/lib/kubelet/config/init/kubelet</code> å†™å…¥ç£ç›˜ã€‚</li>
<li>ä¸€æ—¦kubeletå¼€å§‹ä½¿ç”¨èŠ‚ç‚¹è‡ªå·±çš„å‡­æ®ï¼ˆ<code v-pre>/etc/kubernetes/kubelet.conf</code>ï¼‰ï¼Œæ›´æ–°å½“å‰èŠ‚ç‚¹é…ç½®ï¼ŒæŒ‡å®šçš„èŠ‚ç‚¹æˆ–kubeletå’Œé…ç½®æ¥æºäºä¸Šè¿°ConfigMapã€‚</li>
</ul>
<p>è¯·æ³¨æ„ï¼š</p>
<ol>
<li>è¦ä½¿åŠ¨æ€kubeleté…ç½®å·¥ä½œï¼Œéœ€è¦åœ¨<code v-pre>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code>ä¸­è®¾ç½®<code v-pre>--dynamic-config-dir=/var/lib/kubelet/config/dynamic</code>é€‰é¡¹ã€‚</li>
</ol>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '63.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '65.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


