<template><div><ul>
<li><a href="http://nsddd.top" target="_blank" rel="noopener noreferrer">author<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬67èŠ‚-k8s-æ·±å…¥ç†è§£-operator-client-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#ç¬¬67èŠ‚-k8s-æ·±å…¥ç†è§£-operator-client-è¯¦è§£" aria-hidden="true">#</a> ç¬¬67èŠ‚ K8s æ·±å…¥ç†è§£ Operator-client è¯¦è§£</h1>
<div><a href = '66.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '68.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<p>[TOC]</p>
<h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€" aria-hidden="true">#</a> å‰è¨€</h2>
<p>åœ¨ä¸Šä¸€ä¸ªå¯¹äº client-go å­¦ä¹ ä¸­ï¼Œé€šè¿‡ sample-controller çš„é¡¹ç›®äº†è§£åˆ° Kubernetes çš„ éƒ¨åˆ† client-go çš„å­¦ä¹ ã€‚ç»§ç»­æ·±å…¥å­¦ä¹  client-go</p>
<h3 id="client-go" tabindex="-1"><a class="header-anchor" href="#client-go" aria-hidden="true">#</a> Client-go</h3>
<p>kubectl å¹¶ä¸é€‚åˆ Kubernetes çš„äºŒæ¬¡å¼€å‘è€…æ¥å’Œ k8s æ‰“äº¤é“ï¼ŒGoè¯­è¨€æä¾›äº†ä¸€ä¸ªä¸“é—¨å’Œ Kubernetes API äº¤äº’çš„ åº“ Client-goã€‚</p>
<p>Kubernetes ä¹Ÿæä¾›äº†ä¸€ä¸ªç¼–å†™æ§åˆ¶å™¨<a href="https://github.com/kubernetes/sample-controller/" target="_blank" rel="noopener noreferrer">çš„å°æ¡ˆä¾‹<ExternalLinkIcon/></a>ï¼Œå¯ä»¥ä½œä¸º client-go çš„å…¥é—¨</p>
<p>Client-goæ˜¯ä¸€ä¸ªç”¨äºä¸ Kubernetes API äº¤äº’çš„Goåº“ã€‚å®ƒæä¾›äº†å¹¿æ³›çš„åŠŸèƒ½ï¼Œç”¨äºä¸Kubernetes APIäº¤äº’ï¼ŒåŒ…æ‹¬å¼ºç±»å‹ APIã€èµ„æºå®¢æˆ·ç«¯ã€Watch API å’ŒåŠ¨æ€å®¢æˆ·ç«¯ã€‚ä½¿ç”¨ client-goï¼Œå¼€å‘äººå‘˜å¯ä»¥è½»æ¾åœ°åœ¨ Kubernetes ä¸­åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤èµ„æºå¯¹è±¡ã€‚</p>
<blockquote>
<p>ä»è¿™ä¸ª<code v-pre>package</code>çš„åç§°æ¥çœ‹ï¼Œè¿™åº”è¯¥æ˜¯è·Ÿ<code v-pre>k8s</code>æ‰“äº¤é“çš„å®¢æˆ·ç«¯<code v-pre>client</code>çš„<code v-pre>go</code>å®ç°ï¼Œè¿™ä¸€ç‚¹æ²¡é”™ï¼Œå®ƒå®šä¹‰äº†è¯¸å¤šèµ„æºçš„å®¢æˆ·ç«¯<code v-pre>client</code>ã€‚</p>
</blockquote>
<ul>
<li><a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener noreferrer">Client-go GitHub Address<ExternalLinkIcon/></a></li>
<li>https://github.com/cubxxw/client-go</li>
</ul>
<p>ä¸Šé¢æ˜¯ client-go çš„ GitHub ä»“åº“ï¼Œä¸è¿‡è¿™ä¸ªåº“æ˜¯ actions ä»¥æ¯å¤©ä¸€æ¬¡çš„é¢‘ç‡ä» Kubernetes/Kubernetes ä¸»ä»“åº“ä¸­è‡ªåŠ¨åŒæ­¥è¿‡æ¥çš„ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è´¡çŒ®çš„è¯æ‰¾å¥½ä½ç½®å» Kubernetes è´¡çŒ®ï¼ˆkubernetes/stagin/src/k8s.ioï¼‰ã€‚</p>
<h3 id="client-goç›®å½•ç»“æ„" tabindex="-1"><a class="header-anchor" href="#client-goç›®å½•ç»“æ„" aria-hidden="true">#</a> Client-goç›®å½•ç»“æ„</h3>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â”œâ”€â”€ discovery   <span class="token comment"># DsicoveryClientå®¢æˆ·ç«¯,ç”¨äºå‘ç°k8sæ‰€æ”¯æŒGVRã€‚</span>
â”œâ”€â”€ dynamic     <span class="token comment"># DynamicClientå®¢æˆ·ç«¯, ç”¨äºè®¿é—®k8s Resourcesï¼Œä¹Ÿå¯ä»¥è®¿é—®CRDã€‚</span>
â”œâ”€â”€ informers   <span class="token comment"># k8sä¸­å„ç§Resourcesçš„Informeræœºåˆ¶çš„å®ç°ã€‚</span>
â”œâ”€â”€ kubernetes  <span class="token comment"># å¯¹RestClientè¿›è¡Œäº†å°è£…ï¼Œå®šä¹‰å¤šç§Clientçš„å®¢æˆ·ç«¯é›†åˆï¼Œä¿—ç§°clientsetã€‚</span>
â”œâ”€â”€ listers     <span class="token comment"># æä¾›å¯¹Resourcesçš„è·å–åŠŸèƒ½ã€‚å¯¹äºGet()å’ŒList()è€Œè¨€ï¼Œlistersæä¾›ç»™äºŒè€…çš„æ•°æ®éƒ½æ˜¯ä»ç¼“å­˜ä¸­è¯»å–çš„ã€‚</span>
â”œâ”€â”€ pkg
â”œâ”€â”€ plugin      <span class="token comment"># æä¾›ç¬¬ä¸‰æ–¹æ’ä»¶ã€‚</span>
â”œâ”€â”€ scale       <span class="token comment"># å®šä¹‰ç”¨äºDeploy, RS, RCç­‰èµ„æºè¿›è¡Œçš„æ‰©ã€ç¼©å®¹çš„å®¢æˆ·ç«¯ScaleClientã€‚</span>
â”œâ”€â”€ tools       <span class="token comment"># å®ç°clientæŸ¥è¯¢å’Œç¼“å­˜æœºåˆ¶ï¼Œä»¥åŠå®šä¹‰è¯¸å¦‚SharedInformerã€Reflectorã€DealtFIFOå’ŒIndexerç­‰å¸¸ç”¨å·¥å…·ã€‚</span>
â”œâ”€â”€ transport
â””â”€â”€ util        <span class="token comment"># æä¾›è¯¸å¦‚WorkQueueã€Certificateç­‰å¸¸ç”¨æ–¹æ³•ã€‚</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š</p>
<ul>
<li><code v-pre>/discovery</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºå‘ç°å’Œè·å–Kubernetes APIèµ„æºçš„ä»£ç ã€‚è¿™äº›èµ„æºåŒ…æ‹¬Podã€Serviceã€ReplicationControllerç­‰ã€‚<code v-pre>discovery</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å‘ç°å’Œä½¿ç”¨è¿™äº›èµ„æºã€‚</li>
<li><code v-pre>/dynamic</code>ï¼šè¯¥ç›®å½•åŒ…å«åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼Œç”¨äºä¸Kubernetes APIäº¤äº’ï¼Œè€Œæ— éœ€ç”Ÿæˆä»£ç ã€‚è¿™å¯¹äºæ„å»ºéœ€è¦ä¸ä»»æ„Kubernetesèµ„æºäº¤äº’çš„é€šç”¨å·¥å…·å’Œå®ç”¨ç¨‹åºéå¸¸æœ‰ç”¨ã€‚</li>
<li><code v-pre>/kubernetes</code>ï¼šè¿™ä¸ªåŒ…ä¸­æ–¹çš„æ˜¯ç”¨ client-gen è‡ªåŠ¨ç”Ÿæˆçš„ç”¨æ¥è®¿é—® Kubernetes API çš„ ClientSetï¼Œåé¢ä¼šç»å¸¸çœ‹åˆ° ClientSet è¿™ä¸ªå·¥å…·ã€‚</li>
<li><code v-pre>/informers</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºç›‘è§†Kubernetesèµ„æºå˜åŒ–çš„ä»£ç ã€‚è¿™äº›å˜åŒ–å¯ä»¥åŒ…æ‹¬èµ„æºçš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ã€‚<code v-pre>informers</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ„å»ºæ§åˆ¶å™¨å’Œå…¶ä»–éœ€è¦å¯¹Kubernetesç¯å¢ƒä¸­çš„å˜åŒ–åšå‡ºååº”çš„åº”ç”¨ç¨‹åºã€‚</li>
<li><code v-pre>/listers</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºä»KubernetesæœåŠ¡å™¨è·å–èµ„æºåˆ—è¡¨çš„ä»£ç ã€‚è¿™äº›èµ„æºåˆ—è¡¨åŒ…æ‹¬Podã€Serviceã€Namespaceç­‰ã€‚<code v-pre>listers</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´è½»æ¾åœ°è·å–æœ‰å…³Kubernetesèµ„æºçš„ä¿¡æ¯ã€‚</li>
<li><code v-pre>/rest</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºä¸Kubernetes APIäº¤äº’çš„ä»£ç ã€‚è¿™äº›APIåŒ…æ‹¬Podã€Serviceã€Namespaceç­‰ã€‚<code v-pre>rest</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ‰§è¡Œå„ç§æ“ä½œï¼ŒåŒ…æ‹¬ç®¡ç†Podã€Deploymentã€Serviceã€Namespaceç­‰ã€‚</li>
<li><code v-pre>/scale</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºä¸Kubernetesèµ„æºçš„è‡ªåŠ¨ç¼©æ”¾ç›¸å…³çš„ä»£ç ã€‚è¿™äº›èµ„æºåŒ…æ‹¬Deploymentã€ReplicaSetã€StatefulSetç­‰ã€‚<code v-pre>scale</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜è‡ªåŠ¨ç¼©æ”¾ä¸Kubernetesèµ„æºç›¸å…³çš„ç»„ä»¶ã€‚</li>
<li><code v-pre>transport</code>ï¼šè¿™ä¸ªåŒ…ç”¨äºè®¾ç½®è®¤è¯å’Œå»ºç«‹è¿æ¥</li>
<li><code v-pre>/tools</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºæµ‹è¯•å’Œå…¶ä»–å®ç”¨ç¨‹åºçš„ä»£ç ã€‚è¿™äº›å®ç”¨ç¨‹åºåŒ…æ‹¬ä»£ç ç”Ÿæˆå™¨ã€æµ‹è¯•å·¥å…·ç­‰ã€‚<code v-pre>tools</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´è½»æ¾åœ°æµ‹è¯•å’Œä½¿ç”¨client-goåº“ã€‚</li>
<li><code v-pre>/util</code>ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºå®¢æˆ·ç«¯åº“çš„è¾…åŠ©åŠŸèƒ½çš„ä»£ç ã€‚è¿™äº›åŠŸèƒ½åŒ…æ‹¬å¯¹Kubernetes APIå¯¹è±¡çš„ç±»å‹è½¬æ¢ã€å¯¹è±¡æ¯”è¾ƒç­‰ã€‚<code v-pre>util</code>ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´è½»æ¾åœ°ä½¿ç”¨client-goåº“ã€‚</li>
</ul>
<h3 id="è·å–-client-go" tabindex="-1"><a class="header-anchor" href="#è·å–-client-go" aria-hidden="true">#</a> è·å– Client-go</h3>
<p>å¯ä»¥é€šè¿‡ go get å‘½ä»¤è·å– client-goï¼Œä¸è¿‡æˆ‘ç›´æ¥å…‹éš†æœ€æ–°æºä»£ç ï¼Œç„¶åæ„å»ºä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/kubernetes/client-go.git
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»–ä»¬ç»™äº†ä¸€äº›æ ·ä¾‹çš„æ–‡ä»¶ï¼Œæˆ‘æ‰¾å‡ºæ¥ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">find</span> <span class="token parameter variable">-name</span> main.go
./examples/workqueue/main.go
./examples/in-cluster-client-configuration/main.go
./examples/out-of-cluster-client-configuration/main.go
./examples/dynamic-create-update-delete-deployment/main.go
./examples/create-update-delete-deployment/main.go
./examples/leader-election/main.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™äº›æ–‡ä»¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿä¸Šæ‰‹ client-goï¼š</p>
<ul>
<li><code v-pre>./examples/workqueue/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆWorkqueueï¼‰å®ç°èµ„æºæ§åˆ¶å™¨ï¼ˆControllerï¼‰ã€‚</li>
<li><code v-pre>./examples/in-cluster-client-configuration/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•åœ¨ Kubernetes é›†ç¾¤å†…éƒ¨ä½¿ç”¨ <code v-pre>client-go</code> è®¿é—® Kubernetes API Serverã€‚</li>
<li><code v-pre>./examples/out-of-cluster-client-configuration/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•åœ¨ Kubernetes é›†ç¾¤å¤–éƒ¨ä½¿ç”¨ <code v-pre>client-go</code> è®¿é—® Kubernetes API Serverã€‚</li>
<li><code v-pre>./examples/dynamic-create-update-delete-deployment/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼ˆDynamic Clientï¼‰å®ç°å¯¹ Deployment èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚</li>
<li><code v-pre>./examples/create-update-delete-deployment/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ <code v-pre>client-go</code> å®ç°å¯¹ Deployment èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚</li>
<li><code v-pre>./examples/leader-election/main.go</code>ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„ Leader Election æœºåˆ¶ï¼Œå®ç°èµ„æºæ§åˆ¶å™¨çš„é«˜å¯ç”¨æ€§å’Œæ•…éšœè½¬ç§»ã€‚</li>
</ul>
<p>åœ¨ <code v-pre>/root/workspaces/client-go/examples/workqueue</code> ç›®å½•ä¸­ï¼š</p>
<p>æˆ‘ä»¬æ˜¯ä¸èƒ½ç›´æ¥ç¼–è¯‘çš„ï¼Œçœ‹ä¸€ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ ./main <span class="token parameter variable">--help</span>
Usage of ./main:
  <span class="token parameter variable">-kubeconfig</span> string
        absolute path to the kubeconfig <span class="token function">file</span>
  <span class="token parameter variable">-master</span> string
        master url
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŒ‡å®š kubeconfig ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡  <code v-pre>export KUBECONFIG</code> ï¼‰</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ ./main <span class="token parameter variable">-kubeconfig</span> ~/.kube/config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote>
<p>ä¸¾ä¾‹ï¼šä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸€ä¸ªåä¸º myresource çš„è‡ªå®šä¹‰èµ„æºï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° YAML æ–‡ä»¶ä¸­ã€‚ç„¶åï¼Œè¿è¡Œ <code v-pre>go run ./examples/workqueue/main.go</code> å‘½ä»¤å¯åŠ¨æ§åˆ¶å™¨ã€‚æ­¤æ—¶ï¼Œæ§åˆ¶å™¨ä¼šå¼€å§‹ç›‘å¬ myresource èµ„æºï¼Œå¹¶åœ¨è¯¥èµ„æºè¢«åˆ›å»ºæˆ–æ›´æ–°æ—¶ï¼Œå¼‚æ­¥åœ°å¤„ç†ä¸€äº›ä»»åŠ¡ã€‚</p>
</blockquote>
<p><strong>ç»§ç»­æ¼”ç¤º å¯¹ Deployment CURD æ“ä½œï¼š</strong></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token builtin class-name">cd</span> dynamic-create-update-delete-deployment/
â¯ <span class="token function">ls</span>
README.md  main.go
â¯ go build main.go
â¯ ./main 
Creating deployment<span class="token punctuation">..</span>.
Created deployment <span class="token string">"demo-deployment"</span><span class="token builtin class-name">.</span>
-<span class="token operator">></span> Press Return key to continue.

Updating deployment<span class="token punctuation">..</span>.
Updated deployment<span class="token punctuation">..</span>.
-<span class="token operator">></span> Press Return key to continue.

Listing deployments <span class="token keyword">in</span> namespace <span class="token string">"default"</span><span class="token builtin class-name">:</span>
 * demo-deployment <span class="token punctuation">(</span><span class="token number">1</span> replicas<span class="token punctuation">)</span>
 * my-nginx-app <span class="token punctuation">(</span><span class="token number">3</span> replicas<span class="token punctuation">)</span>
 * nginx-deployment <span class="token punctuation">(</span><span class="token number">3</span> replicas<span class="token punctuation">)</span>
-<span class="token operator">></span> Press Return key to continue.

Deleting deployment<span class="token punctuation">..</span>.
Deleted deployment.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>./examples/dynamic-create-update-delete-deployment/main.go</code>ï¼šè¿™ä¸ªç¤ºä¾‹æ–‡ä»¶æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼ˆDynamic Clientï¼‰å®ç°å¯¹ Deployment èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚ä½¿ç”¨åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ›´åŠ çµæ´»åœ°æ“ä½œ Kubernetes èµ„æºå¯¹è±¡ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™å¤æ‚çš„ä»£ç ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ DynamicClient å¯¹è±¡ï¼ŒåŠ¨æ€åœ°åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ Deployment èµ„æºå¯¹è±¡ã€‚</p>
<blockquote>
<p>ä¸¾ä¾‹ï¼šä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸€ä¸ªåä¸º my-deployment çš„ Deployment å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° YAML æ–‡ä»¶ä¸­ã€‚ç„¶åï¼Œè¿è¡Œ <code v-pre>go run ./examples/dynamic-create-update-delete-deployment/main.go</code> å‘½ä»¤ï¼Œä½¿ç”¨ DynamicClient å¯¹è±¡ï¼ŒåŠ¨æ€åœ°åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ my-deployment Deployment å¯¹è±¡ã€‚</p>
</blockquote>
<p>æµ‹è¯•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ k get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
demo-deployment    <span class="token number">0</span>/1     <span class="token number">0</span>            <span class="token number">0</span>           4s
my-nginx-app       <span class="token number">0</span>/3     <span class="token number">3</span>            <span class="token number">0</span>           26h
nginx-deployment   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           165m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="workqueue-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#workqueue-æºç åˆ†æ" aria-hidden="true">#</a> WorkQueue æºç åˆ†æ</h3>
<p>WorkQueue ä¸€èˆ¬ä½¿ç”¨çš„è¯´å°±æ˜¯å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°ï¼Œåœ¨ Resopurce Event Handlers ä¸­ä¼šå®Œæˆå°†å¯¹è±¡çš„ key æ”¾å…¥ WorkQueue çš„è¿‡ç¨‹ï¼Œç„¶åå†è‡ªå·±çš„é€»è¾‘ä»£ç ä¸­ä» WorkQueue ä¸­æ¶ˆè´¹è¿™äº› Keyã€‚</p>
<p>Client-go çš„ <code v-pre>utile/Workqueue</code> åŒ…ä¸­æœ‰ä¸‰ä¸ªé˜Ÿåˆ—ï¼š</p>
<p>åˆ†åˆ«å¯¹åº”çš„æ˜¯ æ™®é€šé˜Ÿåˆ—ã€å»¶æ—¶é˜Ÿåˆ—å’Œé™é€Ÿé˜Ÿåˆ—ã€‚å¯¹åº”çš„æºæ–‡ä»¶åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>queue.go</li>
<li>delaying_queue.go</li>
<li>rate_limiting_queue.go</li>
</ul>
<p><strong>æˆ‘ä»¬å…ˆçœ‹çœ‹ æ™®é€šé˜Ÿåˆ—ï¼Œè¿™ä¸ªå¯¹åº”çš„æ–‡ä»¶å°±æ˜¯ queue.goï¼š</strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Add</span><span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
	<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> shutdown <span class="token builtin">bool</span><span class="token punctuation">)</span>
	<span class="token function">Done</span><span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token function">ShutDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">ShutDownWithDrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">ShuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹æ¥å£å°±çŸ¥é“äº†å®ç°äº†å“ªäº›æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯æ·»åŠ å…ƒç´ ï¼Œå…ƒç´ ä¸ªæ•°ã€è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ã€ç¬¬äºŒä¸ªè¿”å›å€¼å’Œ channel ç±»ä¼¼ï¼Œæ ‡è®°äº†é˜Ÿåˆ—æ˜¯å¦å…³é—­ã€‚</p>
<p>Done æ ‡è®°ä¸€ä¸ªå…ƒç´ æ˜¯å¦å·²ç»å¤„ç†å®Œï¼ŒShutDown å…³é—­é˜Ÿåˆ—ï¼ŒShowDownWithDrain å…³é—­é˜Ÿåˆ—ï¼Œä½†æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å…ƒç´ å¤„ç†å®Œã€‚ShuttingDown æ ‡è®°å½“å‰çš„ channel æ˜¯å¦æ­£åœ¨å…³é—­ã€‚</p>
<p><strong>æˆ‘ä»¬å†çœ‹å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå¯¹åº”çš„æ–‡ä»¶åœ¨delaying_queue.go</strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// DelayingInterface is an Interface that can Add an item at a later time. This makes it easier to</span>
<span class="token comment">// requeue items after failures without ending up in a hot-loop.</span>
<span class="token keyword">type</span> DelayingInterface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	Interface
	<span class="token comment">// AddAfter adds an item to the workqueue after the indicated duration has passed</span>
	<span class="token function">AddAfter</span><span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> duration time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥å£å°±å¾ˆç®€å•ï¼Œå®šä¹‰ DelayingInterface æ¥å£åœ¨ delaying_queue.go æºæ–‡ä»¶ï¼Œåå­—å’Œ Queue æ‰€ä½¿ç”¨çš„interfaceå¯¹ç§°ï¼Œå«åš DelayingInterfaceã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ª Interfaceï¼Œå¯¹æ­¤æˆ‘æ„Ÿè§‰åˆ°æœ‰ä¸€äº›ç–‘æƒ‘ï¼ŒInterface æ˜¯æ™®é€šé˜Ÿåˆ—å‘½åçš„æ¥å£ï¼Œè¿™ä¸ªè®¾è®¡æ¨¡å¼çš„æ¥å£è®¾è®¡çš„æ€è·¯è›®æœ‰æ„æ€çš„ï¼Œå…ˆåˆ«æ¿€åŠ¨ï¼Œåé¢æœ‰ä½ æ¿€åŠ¨çš„ï¼Œçœ‹åˆ° Controller çš„æ¥å£è®¾è®¡ï¼Œé‚£ç®€ç›´å°±æ˜¯ 6 ~</p>
<p><strong>æœ€åæˆ‘ä»¬çœ‹ä¸€ä¸‹é™é€Ÿé˜Ÿåˆ—ï¼Œè¿™ä¸ªæœ‰æ„æ€å¾ˆå¤šäº†ï¼ŒåŒæ ·ä»Šå¤©çš„é¡¹ç›® <code v-pre>sample-controller</code> ä¹Ÿç”¨åˆ°äº†è¿™ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ controller éƒ¨åˆ†ï¼š</strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Controller <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
	workqueue workqueue<span class="token punctuation">.</span>RateLimitingInterface
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬çœ‹åˆ°äº† é™é€Ÿé˜Ÿåˆ—åŒ…å«äº†å»¶è¿Ÿé˜Ÿåˆ—çš„æ‰€æœ‰æ¥å£å®ç°ï¼Œä¹ŸåŒ…å«äº† åŸºæœ¬é˜Ÿåˆ—çš„æ‰€æœ‰æ¥å£å®ç°ã€‚</p>
<p><strong>åˆ†æè¿™ä¸ªé˜Ÿåˆ—çš„æ¥å£ï¼š</strong></p>
<ul>
<li>AddRateLimitedï¼šåœ¨é€Ÿç‡é™åˆ¶å™¨è®¤å¯çš„æƒ…å†µä¸‹å°†é¡¹ç›®æ·»åŠ åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ã€‚</li>
<li>Forgetï¼šè¡¨ç¤ºé¡¹ç›®å·²ç»å®Œæˆé‡è¯•ã€‚æ— è®ºæ˜¯æ°¸ä¹…æ€§å¤±è´¥è¿˜æ˜¯æˆåŠŸï¼Œæˆ‘ä»¬éƒ½ä¼šåœæ­¢é€Ÿç‡é™åˆ¶å™¨å¯¹å…¶è¿›è¡Œè·Ÿè¸ªã€‚è¿™ä»…æ¸…é™¤äº†<code v-pre>rateLimiter</code>ï¼Œæ‚¨ä»ç„¶éœ€è¦åœ¨é˜Ÿåˆ—ä¸Šè°ƒç”¨<code v-pre>Done</code>æ–¹æ³•ã€‚</li>
<li>NumRequeuesï¼šè¿”å›é¡¹ç›®è¢«é‡æ–°æ’é˜Ÿçš„æ¬¡æ•°ã€‚</li>
</ul>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// RateLimitingInterface is an interface that rate limits items being added to the queue.</span>
<span class="token keyword">type</span> RateLimitingInterface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	DelayingInterface

	<span class="token comment">// AddRateLimited adds an item to the workqueue after the rate limiter says it's ok</span>
	<span class="token function">AddRateLimited</span><span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// Forget indicates that an item is finished being retried.  Doesn't matter whether it's for perm failing</span>
	<span class="token comment">// or for success, we'll stop the rate limiter from tracking it.  This only clears the `rateLimiter`, you</span>
	<span class="token comment">// still have to call `Done` on the queue.</span>
	<span class="token function">Forget</span><span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// NumRequeues returns back how many times the item was requeued</span>
	<span class="token function">NumRequeues</span><span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨åé¢çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å†æ·±å…¥æ¢ç´¢è¿™äº› WorkQueue çš„å®ç°ã€‚</p>
<h3 id="deltafifo-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#deltafifo-æºç åˆ†æ" aria-hidden="true">#</a> DeltaFIFO æºç åˆ†æ</h3>
<p>DeltaFIFO ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„ç»„ä»¶ï¼Œåœ¨ <code v-pre>k8s.io/client-go/tools/cache</code> åŒ…ä¸­ï¼Œç”¨äºå­˜å‚¨å¯¹è±¡çš„å¢é‡æ›´æ–°ã€‚</p>
<ul>
<li>å­˜å‚¨å¯¹è±¡çš„å¢é‡æ›´æ–°ï¼ŒåŒ…æ‹¬æ·»åŠ ã€åˆ é™¤å’Œæ›´æ–°æ“ä½œã€‚</li>
<li>èƒ½å¤ŸæŒ‰é¡ºåºå¤„ç†æ›´æ–°ï¼Œä»¥ç¡®ä¿å®ƒä»¬è¢«æ­£ç¡®åœ°åº”ç”¨ã€‚</li>
<li>æ”¯æŒé˜»å¡å¼åŒæ­¥ï¼Œä»¥ä¾¿åœ¨åº”ç”¨æ‰€æœ‰æ›´æ–°ä¹‹å‰ç­‰å¾…ã€‚</li>
</ul>
<p>åœ¨ fifo.go ä¸­å®šä¹‰äº†ä¸€ä¸ª Queue çš„æ¥å£ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ¥å£ä»£ç ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Queue <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	Store
	<span class="token function">Pop</span><span class="token punctuation">(</span>PopProcessFunc<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">AddIfNotPresent</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">HasSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
	<span class="token comment">// Close the queue</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åµŒå…¥äº†ä¸€ä¸ª Store æ¥å£ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>Store <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Add</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Update</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Delete</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token function">Get</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">GetByKey</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Resync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éƒ½æ˜¯è¡¨é¢çš„æ„æ€äº†ï¼ŒCURD æ“ä½œï¼Œå„ç§ Getã€List æ“ä½œã€‚</p>
<p><strong>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–çš„ï¼Œé˜…è¯»æºç å³å¯ï¼Œåé¢æ…¢æ…¢æ·±å…¥è®²è§£ã€‚</strong></p>
<h3 id="informer-æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#informer-æœºåˆ¶" aria-hidden="true">#</a> Informer æœºåˆ¶</h3>
<p>Informar è¿™ä¸ªå•è¯å‡ºé•œç‡å¾ˆé«˜ï¼Œæˆ‘ä»¬åœ¨å¾ˆå¤šæ–‡ç« ä¸­éƒ½å¯ä»¥çœ‹åˆ°è¿™ä¸ª Informerï¼ŒåŒ…æ‹¬ Kubernetes æºç è®²è§£çš„ ETCD å’Œ API Server ä¸­ã€‚</p>
<p>Informer ä» DeltaFIFO ä¸­ Pop ç›¸å¯¹åº”çš„å¯¹è±¡ï¼Œä¼šé€šè¿‡ Indexer å°†å¯¹è±¡å’Œç´¢å¼•éƒ½ä¸¢åœ¨æœ¬åœ°çš„ cache ä¸­ï¼Œå†è§¦å‘ç›¸åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼ˆResource Event Handlers) çš„è¿è¡Œã€‚</p>
<p>æºç ä½ç½®ï¼š <code v-pre>k8s.io/client-go/tools/cache</code></p>
<p>Informar æ˜¯é€šè¿‡ä¸€ä¸ª Controller å¯¹è±¡æ¥è¿›è¡Œå®šä¹‰çš„ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å¯¹è±¡æ¥å£ï¼š</p>
<p>åœ¨ <code v-pre>controller.go</code> æ–‡ä»¶ä¸­èƒ½çœ‹åˆ° Controller çš„å®šä¹‰ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Controller <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token function">HasSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
	<span class="token function">LastSyncResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹å‡ºï¼Œæœ€æ ¸å¿ƒçš„æ–¹æ³•æ˜¯ <code v-pre>Run(stopCh &lt;-chan struct{})</code> Run è¿™ä¸ªå‡½æ•°æˆ‘ä»¬ç‚¹å‡»è¿›å»ä¼šå‘ç°ï¼Œä¸»è¦åšäº†ä¸¤ä¸ªäº‹æƒ…ï¼š</p>
<ul>
<li>æ„é€  Reflector åˆ©ç”¨ ListerWatcher çš„èƒ½åŠ›å°†å¯¹è±¡äº‹ä»¶æ›´æ–°åˆ° DeltaFIFO</li>
<li>ä» DeltaFIFO ä¸­ Pop å¯¹è±¡åè°ƒç”¨ ProcessFunc æ¥å¤„ç†ã€‚</li>
</ul>
<p>åˆå§‹åŒ–æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// New makes a new Controller from the given Config.</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Config<span class="token punctuation">)</span> Controller <span class="token punctuation">{</span>
	ctlr <span class="token operator">:=</span> <span class="token operator">&amp;</span>controller<span class="token punctuation">{</span>
		config<span class="token punctuation">:</span> <span class="token operator">*</span>c<span class="token punctuation">,</span>
		clock<span class="token punctuation">:</span>  <span class="token operator">&amp;</span>clock<span class="token punctuation">.</span>RealClock<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ctlr
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¼ å…¥äº†ä¸€ä¸ª Config è¿‡æ¥ï¼Œç„¶ååˆå§‹åŒ–ï¼Œæ ¸å¿ƒé€»è¾‘é‚£å°±åœ¨ Config ä¸­äº†ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// Config contains all the settings for one of these low-level controllers.</span>
<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Queue
	<span class="token comment">// Something that can list and watch your objects.</span>
	ListerWatcher
	<span class="token comment">// Something that can process a popped Deltas.</span>
	Process ProcessFunc
	<span class="token comment">// ObjectType is an example object of the type this controller is</span>
	<span class="token comment">// expected to handle.</span>
	ObjectType runtime<span class="token punctuation">.</span>Object
	<span class="token comment">// ObjectDescription is the description to use when logging type-specific information about this controller.</span>
	ObjectDescription <span class="token builtin">string</span>
	<span class="token comment">// FullResyncPeriod is the period at which ShouldResync is considered.</span>
	FullResyncPeriod time<span class="token punctuation">.</span>Duration
	ShouldResync ShouldResyncFunc
	RetryOnError <span class="token builtin">bool</span>
	<span class="token comment">// Called whenever the ListAndWatch drops the connection with an error.</span>
	WatchErrorHandler WatchErrorHandler
	<span class="token comment">// WatchListPageSize is the requested chunk size of initial and relist watch lists.</span>
	WatchListPageSize <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sharedinformer-å¯¹è±¡æºç " tabindex="-1"><a class="header-anchor" href="#sharedinformer-å¯¹è±¡æºç " aria-hidden="true">#</a> SharedInformer å¯¹è±¡æºç </h3>
<p>SharedInformer å’Œ Informer ä¹‹é—´çš„åå­—å°±å·®ä¸€ä¸ª Sharedï¼Œåœ¨ Operator å¼€å‘ä¸­ï¼Œå¦‚æœä¸é€‚ç”¨ controller-runtime åº“ï¼ˆkubebuilder controller-runtime å­é¡¹ç›®çš„Repoï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸ç”¨ Kubebuilder ç­‰å·¥å…·ç”Ÿæˆè„šæ‰‹æ¶ï¼Œé‚£ä¹ˆåº”è¯¥ç”¨åˆ°çš„æ˜¯ SharedInformerFactoryï¼Œæ¯”å¦‚ä»Šå¤©ä¸»è¦åšçš„ sample-controller çš„ <code v-pre>main()</code>  å‡½æ•°ï¼Œåœ¨ä¸‹é¢çš„ sample-controller æºç ä»‹ç»ä¸­ä¼šè®²è§£~</p>
<p>æˆ‘ä»¬èƒ½çœ‹åˆ°è¿™ä¸¤è¡Œä»£ç ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>kubeInformerFactory <span class="token operator">:=</span> kubeinformers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>kubeClient<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span>
	
exampleInformerFactory <span class="token operator">:=</span> informers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>exampleClient<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span>

controller <span class="token operator">:=</span> <span class="token function">NewController</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> kubeClient<span class="token punctuation">,</span> exampleClient<span class="token punctuation">,</span>
	kubeInformerFactory<span class="token punctuation">.</span><span class="token function">Apps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exampleInformerFactory<span class="token punctuation">.</span><span class="token function">Samplecontroller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1alpha1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Foos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ§åˆ¶å™¨çš„åˆå§‹åŒ–åé¢ä¼šè®² <code v-pre>controller.go</code> çš„æ—¶å€™é‡ç‚¹è®²è§£ï¼Œå…ˆçœ‹çœ‹åˆå§‹åŒ–è¿‡ç¨‹å’Œ SharedInformer çš„å…³ç³»ã€‚</p>
<p>controller ä¾èµ–äº <code v-pre>kubeInformerFactory.Apps().V1().Deployments()</code> å’Œ <code v-pre>exampleInformerFactory.Samplecontroller().V1alpha1().Foos()</code></p>
<p>åè€…æ˜¯ <code v-pre>sample-controller</code> è‡ªå·± pkg åŒ…æä¾›çš„ï¼Œå‰è€…æ˜¯ client-go æä¾›çš„ï¼Œé‚£ä¹ˆçœ‹çœ‹å‰è€…ï¼š</p>
<p>è¿™é‡Œçš„ Deployment ä¾èµ–çš„æ˜¯ï¼š<code v-pre>Deployments() DeploymentInformer</code></p>
<p>è€Œ <code v-pre>DeploymentInformer</code> æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œçœ‹ä¸€çœ‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// DeploymentInformer provides access to a shared informer and lister for</span>
<span class="token comment">// Deployments.</span>
<span class="token keyword">type</span> DeploymentInformer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> cache<span class="token punctuation">.</span>SharedIndexInformer
	<span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> v1<span class="token punctuation">.</span>DeploymentLister
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°äº† <code v-pre>Informer</code>  å’Œ <code v-pre>Lister</code>ï¼Œ<code v-pre>Informer</code> æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª <code v-pre>ShareIndexInformer</code></p>
<hr>
<p><strong>æ¥ä¸‹æ¥çš„ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç» sample-controllerã€kubebuilderã€operator-sdk ä»¥åŠå®ƒä»¬ä¹‹é—´é‚£å¾®å¦™çš„å…³ç³»ã€‚</strong></p>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '66.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '68.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


