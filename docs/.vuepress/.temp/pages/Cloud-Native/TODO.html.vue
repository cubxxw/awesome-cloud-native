<template><div><h1 id="sealer-rootless-design" tabindex="-1"><a class="header-anchor" href="#sealer-rootless-design" aria-hidden="true">#</a> sealer rootless design</h1>
<h2 id="ğŸ”-desired-state" tabindex="-1"><a class="header-anchor" href="#ğŸ”-desired-state" aria-hidden="true">#</a> ğŸ” Desired state</h2>
<ul>
<li>[ ] sealer run (cluster)</li>
<li>[ ] sealer images (image)</li>
<li>[ ] é€šè¿‡åˆ é™¤ setuid åŠ å›º Linux äºŒè¿›åˆ¶æ–‡ä»¶[^1]</li>
<li>[ ]</li>
</ul>
<blockquote>
<p><code v-pre>setuid</code> æ˜¯ä¸€ä¸ª Unix æ“ä½œç³»ç»Ÿçš„æƒé™æ ‡å¿—ï¼Œç”¨äºç»™äºˆç‰¹å®šç¨‹åºåœ¨è¿è¡Œæ—¶ç‰¹å®šçš„æƒé™ã€‚å½“ä¸€ä¸ªç¨‹åºå…·æœ‰ <code v-pre>setuid</code> æ ‡å¿—æ—¶ï¼Œå®ƒä»¥å…¶æ–‡ä»¶æ‰€æœ‰è€…çš„èº«ä»½è¿è¡Œï¼Œè€Œä¸æ˜¯ä»¥å½“å‰ç”¨æˆ·çš„èº«ä»½è¿è¡Œã€‚è¿™å¯ä»¥ç”¨äºå…è®¸éç‰¹æƒç”¨æˆ·æ‰§è¡Œç‰¹æƒæ“ä½œï¼Œä¾‹å¦‚è®¿é—®ç‰¹æ®Šæ–‡ä»¶æˆ–æ‰§è¡Œç‰¹æ®Šæ“ä½œã€‚</p>
</blockquote>
<h2 id="ğŸ“–-solution-ideas" tabindex="-1"><a class="header-anchor" href="#ğŸ“–-solution-ideas" aria-hidden="true">#</a> ğŸ“– Solution Ideas</h2>
<p>æˆ–è®¸å¯ä»¥å‚è€ƒ docker çš„ docker ç”¨æˆ·ç»„æƒé™è®¾ç½®ï¼Œæ¥è§£å†³ rootless é—®é¢˜</p>
<ul>
<li><a href="https://rootlesscontaine.rs/" target="_blank" rel="noopener noreferrer">https://rootlesscontaine.rs/<ExternalLinkIcon/></a></li>
</ul>
<p>å€ŸåŠ© <code v-pre>buildah</code> æ— æ ¹æ¨¡å¼çš„è®¾è®¡ï¼Œæ„å»ºå‡º rootlessã€‚</p>
<blockquote>
<p>âš ï¸ æ³¨æ„ï¼š <code v-pre>buildah</code> é»˜è®¤æ˜¯æ”¯æŒäº”æ ¹æ¨¡å¼çš„ï¼</p>
</blockquote>
<p>æ–¹æ¡ˆï¼š</p>
<ul>
<li>[ ] Alias sealer = /usr/bin/sealer  (unalias sealer)</li>
<li>[ ] With the <code v-pre>group</code> ownership the <code v-pre>sealer</code> group</li>
<li>[ ] Add related documents</li>
</ul>
<p>There are 3 ways to use <code v-pre>Sealer</code> and <code v-pre>Buildah</code> in a container:</p>
<ol>
<li>Linux kernel with rootless overlayfs.
å…·æœ‰æ— æ ¹è¦†ç›–å±‚çš„ Linux å†…æ ¸ã€‚</li>
<li>Linux kernel without rootless overlayfs and privileged container.
æ²¡æœ‰æ— æ ¹è¦†ç›–å±‚å’Œç‰¹æƒå®¹å™¨çš„ Linux å†…æ ¸ã€‚</li>
<li>Linux kernel without rootless overlayfs and non-privileged container with special options.
æ²¡æœ‰æ— æ ¹è¦†ç›–å±‚çš„ Linux å†…æ ¸å’Œå…·æœ‰ç‰¹æ®Šé€‰é¡¹çš„éç‰¹æƒå®¹å™¨ã€‚</li>
</ol>
<h3 id="ğŸ–Šï¸-todo" tabindex="-1"><a class="header-anchor" href="#ğŸ–Šï¸-todo" aria-hidden="true">#</a> ğŸ–Šï¸ TODO</h3>
<ul>
<li>
<p>[ ] <code v-pre>rootless</code> æ¨¡å¼ä¸‹ä¸€é”®å®‰è£… <code v-pre>sealer</code> è„šæœ¬ï¼ˆæ²¡æœ‰æƒé™ï¼‰</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">wget</span> https://github.com/sealerio/sealer/releases/download/v0.9.0/sealer-v0.9.0-linux-amd64.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">tar</span> zxvf sealer-v0.9.0-linux-amd64.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">mv</span> sealer /usr/bin <span class="token punctuation">;</span> sealer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>[ ] å•èŠ‚ç‚¹éé«˜å¯ä»¥ç”¨çŠ¶æ€å®‰è£…å–æ¶ˆ <code v-pre>â€“masters</code></p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">sudo</span> sealer run docker.io/sealerio/kubernetes:v1.22.15 
<span class="token comment">#2023-02-05 16:32:44 [ERROR] [root.go:75] sealer-v0.9.0: you must input master ip Or use Clusterfile</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>[ ]</p>
</li>
</ul>
<h3 id="ğŸ·ï¸-error-logged" tabindex="-1"><a class="header-anchor" href="#ğŸ·ï¸-error-logged" aria-hidden="true">#</a> ğŸ·ï¸ Error logged</h3>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>test@cubmaster01:/tmp$ sealer run docker.io/sealerio/kubernetes:v1.22.15
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ç¬¬ä¸€ä¸ªæ— æƒé™ï¼š</p>
<blockquote>
<p>å‚è€ƒ docker çš„ç»„æƒé™ï¼š</p>
<p>å¦‚æœæ‚¨ä¸æƒ³åœ¨<code v-pre>docker</code>å‘½ä»¤å‰åŠ ä¸Š<code v-pre>sudo</code>ï¼Œè¯·åˆ›å»ºä¸€ä¸ªåä¸º çš„ Unix ç»„<code v-pre>docker</code>å¹¶å°†ç”¨æˆ·æ·»åŠ åˆ°å…¶ä¸­ã€‚å½“ Docker å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªå¯ä¾›<code v-pre>docker</code>ç»„æˆå‘˜è®¿é—®çš„ Unix å¥—æ¥å­—ã€‚åœ¨æŸäº› Linux å‘è¡Œç‰ˆä¸Šï¼Œç³»ç»Ÿä¼šåœ¨ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£… Docker Engine æ—¶è‡ªåŠ¨åˆ›å»ºæ­¤ç»„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨æ— éœ€æ‰‹åŠ¨åˆ›å»ºç»„ã€‚</p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">2023</span>-02-05 <span class="token number">13</span>:40:49 <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:75<span class="token punctuation">]</span> sealer-unknown: <span class="token function">open</span> /etc/containers/policy.json: permission denied
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æƒé™åˆ†é…ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">groupadd</span> seal<span class="token punctuation">;</span>
<span class="token function">sudo</span> <span class="token function">useradd</span> sealer<span class="token punctuation">;</span><span class="token function">sudo</span> sealer <span class="token function">mkdir</span> /home/sealer<span class="token punctuation">;</span> <span class="token function">chmod</span> <span class="token number">777</span> /home/sealer 
<span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-g</span> seal sealer<span class="token punctuation">;</span>
<span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-aG</span> seal <span class="token environment constant">$USER</span><span class="token punctuation">;</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span>	/etc/containers/storage.conf<span class="token punctuation">;</span>

<span class="token comment"># Free of secretï¼ˆroor user)</span>
<span class="token function">sudo</span> <span class="token builtin class-name">echo</span> <span class="token string">"sealer ALL=(ALL) NOPASSWD: NOPASSWD: ALL"</span> <span class="token operator">>></span> /etc/sudoers
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>sudo ææƒï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>ubuntu@i-02v830ud:~$ <span class="token function">sudo</span> sealer run docker.io/sealerio/kubernetes:v1.22.15 <span class="token parameter variable">--masters</span> <span class="token number">10.160</span>.25.43
<span class="token number">2023</span>-02-06 <span class="token number">10</span>:34:55 <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:75<span class="token punctuation">]</span> sealer-v0.9.0: failed to <span class="token function">install</span> docker: execute command<span class="token punctuation">(</span>bash /var/lib/sealer/data/my-cluster/rootfs/scripts/docker.sh <span class="token punctuation">)</span> on <span class="token function">host</span> <span class="token punctuation">(</span><span class="token number">10.160</span>.25.43<span class="token punctuation">)</span>: error<span class="token punctuation">(</span>failed to execute command<span class="token punctuation">(</span>bash /var/lib/sealer/data/my-cluster/rootfs/scripts/docker.sh <span class="token punctuation">)</span> on host<span class="token punctuation">(</span><span class="token number">10.160</span>.25.43<span class="token punctuation">)</span>: error<span class="token punctuation">(</span>exit status <span class="token number">1</span><span class="token punctuation">))</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">2023</span>-02-07 <span class="token number">16</span>:29:37 <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:75<span class="token punctuation">]</span> sealer-v0.9.0: failed to <span class="token function">install</span> docker: execute command<span class="token punctuation">(</span>bash /var/lib/sealer/data/my-cluster/rootfs/scripts/docker.sh <span class="token punctuation">)</span> on <span class="token function">host</span> <span class="token punctuation">(</span><span class="token number">10.0</span>.4.3<span class="token punctuation">)</span>: error<span class="token punctuation">(</span>failed to execute command<span class="token punctuation">(</span>bash /var/lib/sealer/data/my-cluster/rootfs/scripts/docker.sh <span class="token punctuation">)</span> on host<span class="token punctuation">(</span><span class="token number">10.0</span>.4.3<span class="token punctuation">)</span>: error<span class="token punctuation">(</span>exit status <span class="token number">127</span><span class="token punctuation">))</span><span class="token number">2023</span>-02-07 <span class="token number">16</span>:29:37 <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:75<span class="token punctuation">]</span> sealer-v0.9.0: failed to <span class="token function">install</span> docker: execute command<span class="token punctuation">(</span>bash /var/lib/sealer/data/my-cluster/rootfs/scripts/docker.sh <span class="token punctuation">)</span> on <span class="token function">host</span> <span class="token punctuation">(</span><span class="token number">10.0</span>.4.3<span class="token punctuation">)</span>: error<span class="token punctuation">(</span>failed to execute command<span class="token punctuation">(</span>bash /var/lib/sealer/data/my-cluster/rootfs/scripts/docker.sh <span class="token punctuation">)</span> on host<span class="token punctuation">(</span><span class="token number">10.0</span>.4.3<span class="token punctuation">)</span>: error<span class="token punctuation">(</span>exit status <span class="token number">127</span><span class="token punctuation">))</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote>
<p>docker å®ˆæŠ¤è¿›ç¨‹ æ­è½½å¤±è´¥ï¼š</p>
<p>ï¼ˆroot user and sudo user)</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>docker: Error response from daemon: cgroups: cgroup mountpoint does not exist: unknown.docker: Error response from daemon: cgroups: cgroup mountpoint does not exist: unknown.
---
<span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:75<span class="token punctuation">]</span> sealer-v0.9.0: failed to execute command<span class="token punctuation">(</span>RegistryDomain<span class="token operator">=</span><span class="token string">"sea.hub"</span> <span class="token assign-left variable">RegistryPort</span><span class="token operator">=</span><span class="token string">"5000"</span> <span class="token assign-left variable">RegistryURL</span><span class="token operator">=</span><span class="token string">"sea.hub:5000"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> /var/lib/sealer/data/my-cluster/rootfs/scripts <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> init-registry.sh <span class="token number">5000</span> /var/lib/sealer/data/my-cluster/rootfs/registry sea.hub<span class="token punctuation">)</span> on host<span class="token punctuation">(</span><span class="token number">10.160</span>.25.43<span class="token punctuation">)</span>: error<span class="token punctuation">(</span>exit status <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mount æŒ‚è½½ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>ubuntu@i-02v830ud:~$ sealer run docker.io/sealerio/kubernetes:v1.22.15 <span class="token parameter variable">--masters</span> <span class="token number">10.160</span>.25.43
<span class="token number">2023</span>-02-06 <span class="token number">14</span>:15:06 <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:75<span class="token punctuation">]</span> sealer-v0.9.0: cannot <span class="token function">mount</span> using driver overlay <span class="token keyword">in</span> rootless mode. You need to run it <span class="token keyword">in</span> a <span class="token variable"><span class="token variable">`</span>buildah unshare<span class="token variable">`</span></span> session
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>[ ] ä¸‰èŠ‚ç‚¹ <code v-pre>Kubectl</code> ä¸æœåŠ¡å™¨ <code v-pre>localhost:8080</code> è¿æ¥è¢«æ‹’ç»ï¼š</li>
</ul>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">[</span>sealer@iZuf68xky083mr0yy6q37lZ ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> kubectl get nodes
W0208 <span class="token number">20</span>:11:28.049909    <span class="token number">4138</span> loader.go:221<span class="token punctuation">]</span> Config not found: /home/sealer/admin.conf
The connection to the server localhost:8080 was refused - did you specify the right <span class="token function">host</span> or port?
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è§£å†³ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf 
<span class="token function">cp</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/
<span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/admin.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>[ ] é <code v-pre>sudo</code> ä¸èƒ½ä½¿ç”¨ <code v-pre>kubectl</code> ï¼š</li>
</ul>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">[</span>sealer@iZuf68xky083mr0yy6q37lZ ~<span class="token punctuation">]</span>$ kubectl get nodes 
W0208 <span class="token number">21</span>:02:48.870473   <span class="token number">30557</span> loader.go:221<span class="token punctuation">]</span> Config not found: /home/sealer/admin.conf
The connection to the server localhost:8080 was refused - did you specify the right <span class="token function">host</span> or port?
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>[ ] sealer images</li>
</ul>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">[</span>sealer@iZuf68xky083mr0yy6q37lZ ~<span class="token punctuation">]</span>$ sealer images
<span class="token number">2023</span>-02-09 <span class="token number">11</span>:09:47 <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>root.go:75<span class="token punctuation">]</span> sealer-v0.9.0: unable to <span class="token function">make</span> rootless runtime: <span class="token function">mkdir</span> /run/user/0/containers: permission de
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>https://github.com/containers/storage/issues/1505</li>
</ul>
<p>è§£å†³ï¼ˆéæ­£å¸¸æ‰‹æ®µï¼‰ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> /run/user/0 ï¼› <span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">700</span> /run/user/0 <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span> /run/user/0
<span class="token comment"># åªéœ€åˆ›å»ºæ—§ç”¨æˆ·ç›®å½•å¹¶æˆäºˆæ‚¨çš„ç”¨æˆ·ä½¿ç”¨è¯¥ç›®å½•çš„æƒåˆ©</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>[ ] <code v-pre>WARN[0000] &quot;/&quot; is not a shared mount, this could cause issues or missing mounts with rootless containers</code></li>
</ul>
<p>è§£å†³ï¼šæ— æ ¹æ¨¡å¼è¿è¡Œçš„ Buildah/Podman æœŸæœ›å…±äº«ç»‘å®šæŒ‚è½½ï¼Œæ£€æŸ¥å®ƒæ˜¯å¦è®¾ç½®ä¸ºç§æœ‰ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">]</span>$ findmnt <span class="token parameter variable">-o</span> PROPAGATION /
PROPAGATION
shared
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·å‚é˜… <a href="https://man.archlinux.org/man/mount.8#Shared_subtree_operations" target="_blank" rel="noopener noreferrer">mount(8) Â§Shared subtree operations<ExternalLinkIcon/></a> å¹¶ä¸´æ—¶å°†æŒ‚è½½è®¾ç½®ä¸ºå…±äº«ï¼š</p>
<h2 id="ğŸ”¥-conclusion" tabindex="-1"><a class="header-anchor" href="#ğŸ”¥-conclusion" aria-hidden="true">#</a> ğŸ”¥ Conclusion</h2>
<p>We believe the security of managing the docker daemon needs a lot of improvement, before we can think of opening up access to non-privileged users directly. Until these fixes are made <code v-pre>sudo</code> is the best option. Weâ€™re working on better options, but for the time being we strongly recommend using <code v-pre>sudo</code>.</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token assign-left variable">sealer_path</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">whereis</span> sealer <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">':'</span> <span class="token parameter variable">-f2</span><span class="token variable">)</span></span>
<span class="token builtin class-name">echo</span> <span class="token variable">$sealer_path</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">sealer</span><span class="token operator">=</span><span class="token string">'sudo $sealer_path'</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>sealos :</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>sealos_path=$(whereis sealos | cut -d ':' -f2) &amp;&amp; alias sealos='sudo $sealos_path'sealos_path=$(whereis sealos | cut -d ':' -f2) &amp;&amp; alias sealos='sudo $sealos_path'
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote>
<p><strong>æ•…éšœæ’æŸ¥ï¼ˆæ˜¯å¦ä¸ºLinuxå®‰è£…ï¼‰ï¼š</strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"os/exec"</span>
	<span class="token string">"strings"</span>

	<span class="token string">"github.com/sirupsen/logrus"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	out<span class="token punctuation">,</span> err <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">,</span> <span class="token string">"--format"</span><span class="token punctuation">,</span> <span class="token string">"'{{.OSType}}'"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Failed to get docker info: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	ostype <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ostype <span class="token operator">==</span> <span class="token string">"Linux"</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Host information: OSType=%s"</span><span class="token punctuation">,</span> ostype<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Error: Unsupported OSType %s"</span><span class="token punctuation">,</span> ostype<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ—ƒï¸-reference" tabindex="-1"><a class="header-anchor" href="#ğŸ—ƒï¸-reference" aria-hidden="true">#</a> ğŸ—ƒï¸ Reference</h2>
<ul>
<li>https://askubuntu.com/questions/477551/how-can-i-use-docker-without-sudo</li>
<li>https://projectatomic.io/blog/2015/08/why-we-dont-let-non-root-users-run-docker-in-centos-fedora-or-rhel/</li>
<li>https://docs.docker.com/engine/security/rootless/</li>
<li>https://github.com/containers/buildah/issues/3491</li>
<li>https://github.com/containers/podman/issues/2739</li>
<li>https://rootlesscontaine.rs/getting-started/common/cgroup2/ &amp;&amp; https://rootlesscontaine.rs/</li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/" target="_blank" rel="noopener noreferrer">érootèº«ä»½è¿è¡Œpod<ExternalLinkIcon/></a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-in-userns/" target="_blank" rel="noopener noreferrer">ä»¥é root ç”¨æˆ·èº«ä»½è¿è¡Œ Kubernetes èŠ‚ç‚¹ç»„ä»¶<ExternalLinkIcon/></a></li>
<li><a href="https://wiki.archlinux.org/title/users_and_groups" target="_blank" rel="noopener noreferrer">linux ç”¨æˆ·ä¸ç»„ design<ExternalLinkIcon/></a></li>
<li><a href="https://wiki.archlinuxcn.org/wiki/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%88%97%E8%A1%A8/%E5%AE%89%E5%85%A8" target="_blank" rel="noopener noreferrer">åº”ç”¨ç¨‹åºåˆ—è¡¨/å®‰å…¨<ExternalLinkIcon/></a></li>
<li>https://en.wikipedia.org/wiki/Security-Enhanced_Linux</li>
<li><a href="https://linux-audit.com/linux-capabilities-hardening-linux-binaries-by-removing-setuid/" target="_blank" rel="noopener noreferrer">Linux åŠŸèƒ½ï¼šé€šè¿‡åˆ é™¤ setuid å¼ºåŒ– Linux äºŒè¿›åˆ¶æ–‡ä»¶<ExternalLinkIcon/></a></li>
<li><a href="https://rootlesscontaine.rs/getting-started/common/subuid/" target="_blank" rel="noopener noreferrer">/etc/subuid å’Œ /etc/subgid<ExternalLinkIcon/></a></li>
<li><a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2033-kubelet-in-userns-aka-rootless" target="_blank" rel="noopener noreferrer">KEP-2033ï¼šKubelet-in-UserNSï¼ˆåˆå Rootless æ¨¡å¼ï¼‰<ExternalLinkIcon/></a></li>
<li><a href="https://github.com/containers/podman/blob/main/rootless.md" target="_blank" rel="noopener noreferrer">podman ç¼ºç‚¹<ExternalLinkIcon/></a></li>
<li><a href="https://github.com/kubernetes/minikube/issues/9495" target="_blank" rel="noopener noreferrer">minikube è°ƒæŸ¥æ”¯æŒæ— æ ¹çš„è¦æ±‚<ExternalLinkIcon/></a></li>
<li><a href="https://github.com/containers/podman/blob/main/troubleshooting.md" target="_blank" rel="noopener noreferrer">Podmanæ•…éšœæ’æŸ¥<ExternalLinkIcon/></a></li>
<li><a href="https://fabianlee.org/2022/08/02/buildah-installing-buildah-and-podman-on-ubuntu-20-04/" target="_blank" rel="noopener noreferrer">podman AND buildah for Ubuntu 20.04 install<ExternalLinkIcon/></a></li>
</ul>
<h3 id="advance-of-right" tabindex="-1"><a class="header-anchor" href="#advance-of-right" aria-hidden="true">#</a> Advance of right</h3>
<ul>
<li>
<p><strong><a href="https://wiki.archlinuxcn.org/wiki/Doas" target="_blank" rel="noopener noreferrer">doas<ExternalLinkIcon/></a></strong> â€” OpenBSD çš„<em>doas</em>å‘½ä»¤çš„å¯ç§»æ¤ç‰ˆæœ¬ï¼Œä¸ sudo ç›¸æ¯”ä»¥ä½“ç§¯å°å¾—å¤šè€Œé—»åã€‚</p>
</li>
<li>
<p><strong><a href="https://man.archlinux.org/man/pkexec.1" target="_blank" rel="noopener noreferrer">pkexec(1)<ExternalLinkIcon/></a></strong> â€” ä¸€ä¸ª<a href="https://wiki.archlinuxcn.org/wiki/Polkit" target="_blank" rel="noopener noreferrer">Polkit<ExternalLinkIcon/></a>åº”ç”¨ç¨‹åºï¼Œå…è®¸æˆæƒç”¨æˆ·ä»¥å¦ä¸€ä¸ªç”¨æˆ·èº«ä»½è¿è¡Œå‘½ä»¤æˆ–äº¤äº’å¼ shellã€‚ä½¿ç”¨ Polkit è§„åˆ™é…ç½®ã€‚</p>
</li>
<li>
<p><strong><a href="https://wiki.archlinuxcn.org/wiki/Su" target="_blank" rel="noopener noreferrer">su<ExternalLinkIcon/></a></strong> â€” ç”¨äºå‡å®šç³»ç»Ÿä¸Šå¦ä¸€ä¸ªç”¨æˆ·èº«ä»½çš„å‘½ä»¤ã€‚</p>
</li>
<li>
<p><strong><a href="https://wiki.archlinuxcn.org/wiki/Sudo" target="_blank" rel="noopener noreferrer">sudo<ExternalLinkIcon/></a></strong> - å§”æ‰˜ä»¥ root æˆ–å…¶ä»–ç”¨æˆ·èº«ä»½è¿è¡Œå‘½ä»¤çš„èƒ½åŠ›çš„å‘½ä»¤ï¼ŒåŒæ—¶æä¾›å®¡è®¡è·Ÿè¸ªã€‚</p>
</li>
</ul>
<p>[1]:  <em>é€šå¸¸å…è®¸å—ä¿¡ä»»çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨ root æƒé™æ¥æ‰§è¡Œæ˜¯æœ‰æ„ä¹‰çš„ã€‚è½¯ä»¶çš„ä¸å¹¸ä¹‹å¤„åœ¨äºå®ƒå¯èƒ½åŒ…å«é”™è¯¯ã€‚å› æ­¤ï¼Œå³ä½¿æ˜¯ setuid äºŒè¿›åˆ¶æ–‡ä»¶çš„æœ€å°é”™è¯¯ä¹Ÿå¯èƒ½å¯¼è‡´å®Œå…¨å¦¥åã€‚</em></p>
</div></template>


