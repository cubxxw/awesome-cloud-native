<template><div><ul>
<li><a href="http://nsddd.top" target="_blank" rel="noopener noreferrer">author<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬4èŠ‚-ç¬¬äºŒé˜¶æ®µ-ç¬¬äºŒéƒ¨åˆ†" tabindex="-1"><a class="header-anchor" href="#ç¬¬4èŠ‚-ç¬¬äºŒé˜¶æ®µ-ç¬¬äºŒéƒ¨åˆ†" aria-hidden="true">#</a> ç¬¬4èŠ‚ ç¬¬äºŒé˜¶æ®µ ç¬¬äºŒéƒ¨åˆ†</h1>
<br>
<div><a href = '3.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '5.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•è®°å½•<a href="https://github.com/3293172751/sealos" target="_blank" rel="noopener noreferrer">sealos<ExternalLinkIcon/></a>å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚<a href="https://github.com/3293172751/sealos" target="_blank" rel="noopener noreferrer">k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ <ExternalLinkIcon/></a>ã€‚Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<p>[TOC]</p>
<h2 id="before" tabindex="-1"><a class="header-anchor" href="#before" aria-hidden="true">#</a> Before</h2>
<ul>
<li>go test</li>
<li>k3s / helm / K3s rootfs / docs / source codes /</li>
<li>fabric</li>
<li>spring boot  â€“  dockerfile</li>
</ul>
<h2 id="problem" tabindex="-1"><a class="header-anchor" href="#problem" aria-hidden="true">#</a> problem</h2>
<h3 id="_3293172751-commented-2-days-ago" tabindex="-1"><a class="header-anchor" href="#_3293172751-commented-2-days-ago" aria-hidden="true">#</a> <strong><a href="https://github.com/3293172751" target="_blank" rel="noopener noreferrer">3293172751<ExternalLinkIcon/></a></strong> commented <a href="https://github.com/labring/sealos/issues/1943#issuecomment-1295060720" target="_blank" rel="noopener noreferrer">2 days ago<ExternalLinkIcon/></a></h3>
<p><a href="https://github.com/k3s-io/k3s" target="_blank" rel="noopener noreferrer">k3s - github<ExternalLinkIcon/></a>ï¼ŒI wonder if I need a tutorial on <a href="https://k3s.io/" target="_blank" rel="noopener noreferrer">k3s.io<ExternalLinkIcon/></a>ï¼Œwhat should I pay attention to when I use itâ“ Do I need to write the functions next to k8s to keep them <strong>together,</strong> or <strong>separateâ“</strong> <a href="https://github.com/fanux" target="_blank" rel="noopener noreferrer">@fanux<ExternalLinkIcon/></a></p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>sealos run k0s:latest --masters xxx --nodes xxxx --passwd xxxx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="cuisongliu-commented-yesterday" tabindex="-1"><a class="header-anchor" href="#cuisongliu-commented-yesterday" aria-hidden="true">#</a> <strong><a href="https://github.com/cuisongliu" target="_blank" rel="noopener noreferrer">cuisongliu<ExternalLinkIcon/></a></strong> commented <a href="https://github.com/labring/sealos/issues/1943#issuecomment-1295680848" target="_blank" rel="noopener noreferrer">yesterday<ExternalLinkIcon/></a></h3>
<p><a href="https://github.com/k3s-io/k3s" target="_blank" rel="noopener noreferrer">k3s - github<ExternalLinkIcon/></a>ï¼ŒI wonder if I need a tutorial on <a href="https://k3s.io/" target="_blank" rel="noopener noreferrer">k3s.io<ExternalLinkIcon/></a>ï¼Œwhat should I pay attention to when I use itâ“ Do I need to write the functions next to k8s to keep them <strong>together,</strong> or <strong>separateâ“</strong></p>
<ol>
<li>runtime interface need spilt kubeadm and k3s</li>
<li>k3s rootfs</li>
</ol>
<p><strong>controllersï¼š</strong></p>
<blockquote>
<p><code v-pre>controllers</code>   vï¼šgo1.18</p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>cluster <span class="token comment"># ä¸“é—¨ç®¡ç†awsä¸Šk8sç”Ÿå‘½å‘¨æœŸ</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ClusterSpec defines the desired state of InfraMetadata</p>
<h3 id="rootfs-runtime-design" tabindex="-1"><a class="header-anchor" href="#rootfs-runtime-design" aria-hidden="true">#</a> rootfs runtime design</h3>
<details class="custom-container details"><summary>k3s rootfs</summary>
<p>goolang ç¼–è¯‘æ—¶ä¼šæ‰“åŒ…æ‰€æœ‰çš„ä¾èµ–ï¼Œæ¯ä¸ªç‹¬ç«‹çš„ binary éƒ½ä¼šæœ‰ç‹¬ç«‹çš„è¿è¡Œæ—¶æ”¯æŒ</p>
<p>k3sæŠŠæ‰€æœ‰çš„ä¾èµ–éƒ½ç¼–è¯‘åœ¨ä¸€ä¸ª <code v-pre>binary</code> ä¸­ï¼Œæ‰€æœ‰çš„ç¨‹åº ä¸€ä»½è¿è¡Œæ—¶</p>
<p>å€Ÿé‰´ rootfs (linux) åŸºäº <a href="https://github.com/buildroot/buildroot" target="_blank" rel="noopener noreferrer">buildroot<ExternalLinkIcon/></a> æ„å»ºçš„ busybox rootfs</p>
<p>å‚è€ƒ <a href="https://github.com/k3s-io/k3s-root" target="_blank" rel="noopener noreferrer">rancher/k3s-root<ExternalLinkIcon/></a> æ‰€æœ‰çš„k3s æ„å»ºçš„ binary éƒ½æ”¾åœ¨æ­¤å¤„</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>/var/lib/rancher/k3s/data/..../bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></details>
<p>make Runtime module more readable</p>
<ol>
<li>k0s runtime</li>
<li>k3s runtime</li>
<li>k8s runtime</li>
</ol>
<p><strong>aboutï¼š</strong></p>
<ol>
<li><code v-pre>util_test.go</code>  file</li>
<li>implement runtime interface</li>
<li>k3s runtime</li>
</ol>
<p><strong>implement runtime interfaceï¼š</strong></p>
<ul>
<li>
<p><a href="https://www.sealos.io/zh-Hans/docs/cli/apply" target="_blank" rel="noopener noreferrer">https://www.sealos.io/zh-Hans/docs/cli/apply<ExternalLinkIcon/></a></p>
</li>
<li>
<p>Interface <code v-pre>interface{}</code></p>
</li>
</ul>
<p><strong>runtime module listï¼š</strong></p>
<div class="language-markdown ext-md line-numbers-mode"><pre v-pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> runtime</span>
<span class="token list punctuation">+</span> kubernets
	<span class="token list punctuation">-</span> kubeconfig.go  # 
	<span class="token list punctuation">-</span> master.go
	<span class="token list punctuation">-</span> node.go
	<span class="token list punctuation">-</span> registry.go
	<span class="token list punctuation">-</span> reset.go
	<span class="token list punctuation">-</span> runtime_getter.go
	<span class="token list punctuation">-</span> runtime.go
	<span class="token list punctuation">-</span> static_files.go
	<span class="token list punctuation">-</span> token.go
	<span class="token list punctuation">-</span> update_cert.go
	<span class="token list punctuation">-</span> utils.go
<span class="token list punctuation">+</span> k3s
	<span class="token list punctuation">-</span> add.go
	<span class="token list punctuation">-</span> delete.go
	<span class="token list punctuation">-</span> reset.go 
	<span class="token list punctuation">-</span> update.go
	<span class="token list punctuation">-</span> token.go
<span class="token list punctuation">+</span> k0s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>k3s rootfs designï¼š</strong></p>
<p><code v-pre>init sealos</code>  â€“&gt; <code v-pre>Clusterfile</code> file</p>
<p>mergedï¼šrootfs</p>
<p><em>root directory: <code v-pre>/</code></em></p>
<div class="custom-container tip"><p class="custom-container-title">â“</p>
<ul>
<li>
<p>rootfs make build</p>
</li>
<li>
<p>rootfs interface</p>
</li>
</ul>
<p><strong>construction</strong></p>
<blockquote>
<p>How should rootfs build it?</p>
</blockquote>
<div class="language-test ext-test line-numbers-mode"><pre v-pre class="language-test"><code>bin  cri  etc  images  Kubefile  opt  README.md  registry  scripts  statics
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></div>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>+ /bin
+ /etc
+ /images
+ /scripts
+ /tmp
+ /lib
+ /run
+ /var
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>ä¸ºä»€ä¹ˆæœ‰äº› <code v-pre>merged</code> æ˜¯ç©ºçš„</p>
</blockquote>
<p><del><code v-pre>k3d</code> ï¼šè¦ä½¿ç”¨ Dockerï¼Œ<code v-pre>rancher/k3s</code>è¿˜å¯ä»¥ä½¿ç”¨é•œåƒæ¥è¿è¡Œ K3s æœåŠ¡å™¨å’Œä»£ç†ã€‚ä½¿ç”¨<code v-pre>docker run</code>å‘½ä»¤ï¼š</del></p>
<blockquote>
<p>sealos run ranchar/k3s</p>
</blockquote>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">docker</span> run <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token parameter variable">--tmpfs</span> /run <span class="token punctuation">\</span>
  <span class="token parameter variable">--tmpfs</span> /var/run <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span><span class="token variable">${SERVER_URL}</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span><span class="token variable">${NODE_TOKEN}</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--privileged</span> rancher/k3s:vX.Y.Z
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>the  runtime module of k3sï¼š</strong></p>
<blockquote>
<p>ç»“æ„ä½“æ–¹æ³•ï¼š</p>
<ul>
<li>initæ–¹æ³•</li>
<li>SyncNodeIPVS æ–¹æ³•</li>
</ul>
</blockquote>
<ul>
<li>Init   âš ï¸</li>
<li>SyncNodeIPVS  âš ï¸</li>
</ul>
<p><strong>sealosåœ¨åŸºæœ¬çš„å‘½ä»¤æ“ä½œä¸Šå¯ä»¥ç†è§£ä¸ºä»£æ›¿dockerï¼Ÿ</strong></p>
<p><strong>ä½¿ç”¨sealos run docker.io/rancher/k3s?</strong></p>
<p><strong>build k3s images ?</strong></p>
<blockquote>
<p>kubernetes çš„æ„å»ºæ–¹å¼</p>
</blockquote>
<ol>
<li><a href="https://artifacthub.io/packages/search?ts_query_web=k3s&amp;sort=relevance&amp;page=1" target="_blank" rel="noopener noreferrer">helm<ExternalLinkIcon/></a></li>
<li>sealos run ? -&gt;  merged(rootfs)</li>
</ol>
<p><strong>A simple questionï¼š</strong></p>
<ol>
<li>
<p>ç¦»çº¿ç¯å¢ƒä¹Ÿéœ€è¦ sealos ï¼Ÿ</p>
</li>
<li>
<p>é¡¹ç›®æµ‹è¯•ç¯å¢ƒ~ï¼ˆæ–­ç‚¹ã€å•å…ƒæµ‹è¯•ã€æµ‹è¯•ç”¨ä¾‹)</p>
<blockquote>
<p>windows11</p>
<p>centos / ubuntu(å†…å­˜ä¸å¤Ÿ)</p>
<p>vscode</p>
</blockquote>
</li>
</ol>
<p><strong>I need solutionsï¼š</strong></p>
<p>repeat imagesï¼ˆauto cleaning)ï¼Ÿ</p>
<p><img src="http://sm.nsddd.top/smimage-20221103200214386.png" alt="image-20221103200214386"></p>
<p><strong>æ·»åŠ é•œåƒåˆ—è¡¨ï¼š</strong></p>
<blockquote>
<p>sealos ä¼šä¸‹è½½é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒå¹¶ç¼“å­˜åˆ° registry ç›®å½•ã€‚</p>
<p>ç›®å½•å¿…é¡»å½¢å¦‚ <code v-pre>images/shim/[your image list filename]</code>ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ <span class="token function">cat</span> images/shim/nginxImages
k8s.gcr.io/ingress-nginx/controller:v1.2.0
k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>sealos åœ¨æ„å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨æ·»åŠ é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒä¾èµ–åˆ°é›†ç¾¤é•œåƒä¸­ï¼Œé€šè¿‡ç¥å¥‡çš„æ–¹å¼ä¿å­˜äº†é‡Œé¢ä¾èµ–çš„ Docker é•œåƒã€‚ å¹¶ä¸”åœ¨åˆ°åˆ«çš„ç¯å¢ƒä¸­è¿è¡Œçš„æ—¶å€™æ›´ç¥å¥‡çš„è‡ªåŠ¨æ£€æµ‹é›†ç¾¤ä¸­æƒ³æ˜¯å¦çš„ Docker é•œåƒï¼Œæœ‰çš„è¯è‡ªåŠ¨ä¸‹è½½ï¼Œæ²¡æœ‰çš„è¯æ‰ä¼šå» k8s.gcr.io ä¸‹è½½ã€‚ ç”¨æˆ·æ— éœ€ä¿®æ”¹ helm chart ä¸­çš„ docker é•œåƒåœ°å€ï¼Œè¿™é‡Œç”¨åˆ°äº†é•œåƒç¼“å­˜ä»£ç†çš„é»‘ç§‘æŠ€ã€‚</p>
</blockquote>
<p>web ï¼šhttps://k8s.gcr.io/v2/ ï¼Ÿ</p>
<p>**pull images registryâ“ **</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>$ sealos login docker.io
$ sealos push docker.io/fanux/ingress-nginx:v1.2.0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>sealos life cycle</code> ï¼špod</p>
<p><strong>sealos run == apply (pod / Deployment)</strong></p>
<blockquote>
<p>except  <code v-pre>/var/lib/</code>ï¼Œanything elseï¼Ÿ</p>
</blockquote>
<h2 id="my-questions-suggestions" tabindex="-1"><a class="header-anchor" href="#my-questions-suggestions" aria-hidden="true">#</a> My questions, suggestionsï¼Ÿ</h2>
<p>sealos &amp;&amp; docker  ï¼š Invest time in <code v-pre>docker</code> source code ï¼ˆkubernetesï¼› k3s â€¦.)</p>
<p>linux operating system source code</p>
<h2 id="else" tabindex="-1"><a class="header-anchor" href="#else" aria-hidden="true">#</a> else</h2>
<ul>
<li>Advice to developers (me)</li>
</ul>
<p>â€¦</p>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '3.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '5.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


