<template><div><ul>
<li><a href="http://nsddd.top" target="_blank" rel="noopener noreferrer">author<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬54èŠ‚-openim-é‡æ„ç¡®å®šåè®®" tabindex="-1"><a class="header-anchor" href="#ç¬¬54èŠ‚-openim-é‡æ„ç¡®å®šåè®®" aria-hidden="true">#</a> ç¬¬54èŠ‚ OpenIM é‡æ„ç¡®å®šåè®®</h1>
<div><a href = '53.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '55.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•è®°å½•<a href="https://github.com/cubxxw/sealos" target="_blank" rel="noopener noreferrer">sealos<ExternalLinkIcon/></a>å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚<a href="https://github.com/cubxxw/sealos" target="_blank" rel="noopener noreferrer">k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ <ExternalLinkIcon/></a>ã€‚Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<p>[TOC]</p>
<h2 id="ç¡®å®šåè®®" tabindex="-1"><a class="header-anchor" href="#ç¡®å®šåè®®" aria-hidden="true">#</a> ç¡®å®šåè®®</h2>
<p><strong>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„åè®®</strong>
ï¼ˆ1ï¼‰å¿ƒè·³
ï¼ˆ2ï¼‰æ¶ˆæ¯æ‹‰å–
ï¼ˆ3ï¼‰æ¨é€
ï¼ˆ4ï¼‰æ¶ˆæ¯å‘é€</p>
<p><strong>å®¢æˆ·ç«¯å†…éƒ¨çš„</strong>
ï¼ˆ1ï¼‰æ¶ˆæ¯åŒæ­¥åç¨‹å’Œä¼šè¯åç¨‹ä¹‹é—´</p>
<p>æ¶ˆæ¯ï¼› 2.åŒæ­¥å¼€å§‹ï¼›3.åŒæ­¥ç»“æŸï¼›
ï¼ˆ2ï¼‰wsåç¨‹å’Œæ¶ˆæ¯åŒæ­¥åç¨‹ä¹‹é—´</p>
<p>å¿ƒè·³å“åº”ï¼ˆæœ€å¤§seqï¼‰ï¼›2.æ¨é€æ¶ˆæ¯ï¼›3.è¿æ¥æˆåŠŸ
ï¼ˆ3ï¼‰ä»»ä½•å‘é€wsè¯·æ±‚åç¨‹å’Œwsåç¨‹ä¹‹é—´ï¼›
1.é€šè¿‡SendReqWaitRespå°è£…</p>
<p><strong>æˆ‘ä»¬éœ€è¦æ‹¿åˆ°æ•°æ®ï¼š</strong></p>
<p>ï¼ˆ2ï¼‰wsåç¨‹å’Œæ¶ˆæ¯åŒæ­¥åç¨‹ä¹‹é—´
1.å¿ƒè·³å“åº”ï¼ˆæœ€å¤§seqï¼‰ï¼›2.æ¨é€æ¶ˆæ¯ï¼›3.è¿æ¥æˆåŠŸ</p>
<p>å…ˆåˆ¤æ–­ cmdï¼Œç„¶ååšé€»è¾‘éƒ¨åˆ†ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>CmdMaxSeq       <span class="token operator">=</span> <span class="token string">"maxSeq"</span>	<span class="token comment">//å¿ƒè·³å“åº”ï¼ˆæœ€å¤§seqï¼‰</span>
CmdPushMsg      <span class="token operator">=</span> <span class="token string">"pushMsg"</span>	<span class="token comment">//æ¨é€ä¿¡æ¯</span>
CmdConnSuccesss <span class="token operator">=</span> <span class="token string">"connSuccess"</span>	<span class="token comment">//è¿æ¥æˆåŠŸ</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>ç¬¬ä¸€ä¸ªä½ ä¼šæ¥å—åˆ°æ¨é€è¿‡æ¥çš„æ¶ˆæ¯</p>
<p>ç¬¬äºŒå°±æ˜¯åœ¨æœåŠ¡å™¨å®šæ—¶çš„å»è·å–åˆ°æ¯ä¸€ä¸ªç¾¤ï¼Œæˆ–è€…æ˜¯æ¯ä¸€ä¸ªä¼šè¯é‡Œçš„æ‰€æœ‰çš„å°±æ˜¯æ¯ä¸€ä¸ªç»˜ç”»çš„æœ€æ–°çš„æœ€å¤§çš„ä¹Ÿæ˜¯æœ€å¤§çš„seqã€‚è¿™æ ·æˆ‘ä»¬è¿™ä¸ªæ¨¡å—å°±çŸ¥é“æˆ‘ä»¬ç¼ºäº†å“ªäº›æ¶ˆæ¯</p>
<p>ç¬¬ä¸‰ä¸ªå¦‚æœåŒå¹´æˆåŠŸæˆ–è€…å°±è¿æ¥æˆåŠŸï¼Œç„¶åä¹Ÿæœ‰wsé‚£ä¸ªæ¨¡å—ä¼šä¸¢ä¸€é‡åº†æˆåŠŸçš„ Cmdç»™ä½ ï¼Œå°±æ˜¯è¯´ä½ ç°åœ¨ä¼šæ¥å—ä¸‰ç§ç±»å‹çš„æ¶ˆæ¯ï¼Œåƒæ˜¯é‚£äº›é€šçŸ¥åœ¨cç¾¤é‡Œé¢ï¼Œè¿™ä¸ªæœ‰æ²¡æœ‰é—®é¢˜ã€‚</p>
<p>é‡è¿æˆåŠŸåå°±è¦é€šçŸ¥ä½ å¼€å§‹åŒæ­¥ä¿¡æ¯äº†ã€‚</p>
</blockquote>
<p>ç»“æ„ä½“ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// The callback synchronization starts. The reconnection endsc</span>
<span class="token keyword">type</span> MsgSyncer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	loginUserID        <span class="token builtin">string</span>                <span class="token comment">// login user ID</span>
	longConnMgr        <span class="token operator">*</span>LongConnMgr          <span class="token comment">// long connection manager</span>
	PushMsgAndMaxSeqCh <span class="token keyword">chan</span> common<span class="token punctuation">.</span>Cmd2Value <span class="token comment">// channel for receiving push messages and the maximum SEQ number</span>
	conversationCh     <span class="token keyword">chan</span> common<span class="token punctuation">.</span>Cmd2Value <span class="token comment">// storage and session triggering</span>
	syncedMaxSeqs      <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>SyncedSeq  <span class="token comment">// map of the maximum synced SEQ numbers for all group IDs</span>
	db                 db_interface<span class="token punctuation">.</span>DataBase <span class="token comment">// data store</span>
	syncTimes          <span class="token builtin">int</span>                   <span class="token comment">// times of sync</span>
	ctx                context<span class="token punctuation">.</span>Context       <span class="token comment">// context</span>
	cancel             context<span class="token punctuation">.</span>CancelFunc    <span class="token comment">// cancel function</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>conversationCh æ˜¯å¹²å˜›çš„ï¼Ÿå®é™…ä¸Šè¿™å°±æ˜¯æ¶ˆæ¯æ¨¡å—çš„ä¸€ä¸ªåˆ‡å…¥ï¼Œå°±æ˜¯ä½ åˆšæ‰å°±æ˜¯è¯´ä¼šä¸€äº›æŠŠæŸäº›æ•°æ®ç»™åˆ°è¿™ä¸ªä¸œè¥¿å°±ç»™åˆ°åµŒå…¥é‡Œé¢ï¼Œå®ƒæœ‰å“ªäº›ä¸œè¥¿å‘¢ï¼Ÿè¿™é‡Œé¢ä¸¤ç§æ¶ˆæ¯ï¼Œå°±ä¸€ç§æ˜¯æ¶ˆæ¯ï¼Œå°±æ˜¯ä½ åŒæ­¥çš„æ¶ˆæ¯ï¼Œåˆšæ‰ä¸æ˜¯è¯´åŒæ­¥ä¸€æ¡æˆ–è€…åŒæ­¥10æ¡æ˜¯ä¸æ˜¯ç»™åˆ°ä»–ï¼Œå¯¹å§ï¼Ÿä»–æ¥åšå­˜å‚¨ï¼Œä»–è‡ªå·±è¦åšå­˜å‚¨å’Œä¼šè¯çš„è§¦å‘ã€‚</p>
<p>æ‰€ä»¥è¯´è¿™é‡Œçš„ channel æ”¶åˆ°çš„æ˜¯ä¸‰ç§ä¿¡æ¯ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§æ˜¯çœŸæ­£åŒæ­¥çš„æ¶ˆæ¯</li>
<li>ç¬¬äºŒç§æ˜¯åŒæ­¥å¼€å§‹ã€åŒæ­¥ç»“æŸçš„ä¸€ç§é€šçŸ¥ï¼Œä»–è¦ç»™å®¢æˆ·ç«¯è¿›è¡Œæ˜¾ç¤º</li>
</ul>
<p>loadSeqå‡½æ•°ï¼š</p>
<p>å°±æ˜¯è¯´ä½ åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå®é™…ä¸Šåˆå§‹åŒ–çš„æ—¶å€™å®é™…ä¸Šä½ çš„å°±å·²ç»åŒæ­¥ï¼Œä½†æ˜¯ä½ æ˜¯ä¸çŸ¥é“çš„ï¼Œæ‰€ä»¥åˆ°æ—¶å€™DBé‚£è¾¹å¯èƒ½è¦æä¾›ä¸€äº›å‡½æ•°èƒ½å‘Šè¯‰ä½ ï¼Œå°±æ˜¯è¯´æ¯”å¦‚è¯´æˆ‘æœ‰äº†æˆ‘è¿™ä¸ªç”¨æˆ·æœ‰å“ªæœ‰å“ªäº›ä¼šè¯ï¼Œç„¶åæ¯ä¸ªä¼šè¯æœ€å¤§çš„ä¸€ä¸ªæ˜¯ä»€ä¹ˆæƒ…å†µï¼Œæˆ‘è¦åœ¨DBæœ¬åœ°è¯»å‡ºæ¥å¯„åˆ°å†…å­˜é‡Œé¢ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªç±»ä¼¼ Mapçš„ä¸œè¥¿ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ï¼Œè¿™ä¸ªæ—¶å€™å°±èƒ½ç¡®å®š <code v-pre>seqs </code></p>
<p>ä½¿ç”¨ switchï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">case</span> cmd <span class="token operator">:=</span> <span class="token operator">&lt;-</span>m<span class="token punctuation">.</span>PushMsgAndMaxSegCh<span class="token punctuation">:</span>
	m<span class="token punctuation">.</span><span class="token function">handleRecvMsgAndSyncSeqs</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å®šä¹‰éƒ¨åˆ†ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Cmd2Value <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   Cmd   <span class="token builtin">string</span>
   Value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
   Ctx   context<span class="token punctuation">.</span>Context
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>valueä¸ä¸€å®šæ˜¯<code v-pre>msgdata</code></strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TriggerCmdPushMsg</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> msg <span class="token operator">*</span>sdkws<span class="token punctuation">.</span>MsgData<span class="token punctuation">,</span> ch <span class="token keyword">chan</span> Cmd2Value<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> ch <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"ch == nil"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   c2v <span class="token operator">:=</span> Cmd2Value<span class="token punctuation">{</span>Cmd<span class="token punctuation">:</span> constant<span class="token punctuation">.</span>CmdPushMsg<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> msg<span class="token punctuation">,</span> Ctx<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token function">sendCmd</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> c2v<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TriggerCmdMaxSeq</span><span class="token punctuation">(</span>seq sdk_struct<span class="token punctuation">.</span>CmdMaxSeqToMsgSync<span class="token punctuation">,</span> ch <span class="token keyword">chan</span> Cmd2Value<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> ch <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"ch == nil"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   c2v <span class="token operator">:=</span> Cmd2Value<span class="token punctuation">{</span>Cmd<span class="token punctuation">:</span> constant<span class="token punctuation">.</span>CmdMaxSeq<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> seq<span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token function">sendCmd</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> c2v<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TriggerCmdConnected</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ch <span class="token keyword">chan</span> Cmd2Value<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> ch <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"ch == nil"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   c2v <span class="token operator">:=</span> Cmd2Value<span class="token punctuation">{</span>Cmd<span class="token punctuation">:</span> constant<span class="token punctuation">.</span>CmdConnSuccesss<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> Ctx<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token function">sendCmd</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> c2v<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ†åˆ«æ˜¯è¿™ä¸‰ä¸ª <code v-pre>Cmd2Value</code></p>
<p><strong>è°ƒæ•´ï¼š</strong></p>
<ul>
<li><code v-pre>ws *Ws</code> è¿™ä¸ªæ¢æ‰</li>
<li><code v-pre>msgCache</code> å¯ä»¥åˆ é™¤</li>
<li><code v-pre>handleRecvMsgAndSyncSeqs</code>è¦å¯¹<code v-pre>cmd</code>è§£æä¸€ä¸‹</li>
</ul>
<h2 id="æ¡ˆä¾‹" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹" aria-hidden="true">#</a> æ¡ˆä¾‹</h2>
<p>å°±æ‹¿æˆ‘ä»¬çš„ä¸€ä¸ªæ¡ˆä¾‹æ¥è¯´ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Protocol <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    heartbeat  <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// å¿ƒè·³</span>
    pullMsg    <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// æ¶ˆæ¯æ‹‰å–</span>
    pushMsg    <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// æ¨é€æ¶ˆæ¯</span>
    sendMsg    <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// æ¶ˆæ¯å‘é€</span>
    syncMsg    <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// æ¶ˆæ¯åŒæ­¥</span>
    syncStart  <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// åŒæ­¥å¼€å§‹</span>
    syncFinish <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// åŒæ­¥ç»“æŸ</span>
    wsResp     <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// WSå“åº”</span>
    wsPush     <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// WSæ¨é€</span>
    wsConn     <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// WSè¿æ¥æˆåŠŸ</span>
    wsReq      <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>   <span class="token comment">// ä»»ä½•å‘é€WSè¯·æ±‚</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Protocol<span class="token punctuation">)</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    p<span class="token punctuation">.</span>heartbeat <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>  <span class="token comment">// åˆå§‹åŒ–å¿ƒè·³åè®®</span>
    p<span class="token punctuation">.</span>pullMsg <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>    <span class="token comment">// åˆå§‹åŒ–æ¶ˆæ¯æ‹‰å–åè®®</span>
    p<span class="token punctuation">.</span>pushMsg <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>    <span class="token comment">// åˆå§‹åŒ–æ¨é€æ¶ˆæ¯åè®®</span>
    p<span class="token punctuation">.</span>sendMsg <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>    <span class="token comment">// åˆå§‹åŒ–æ¶ˆæ¯å‘é€åè®®</span>
    p<span class="token punctuation">.</span>syncMsg <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>    <span class="token comment">// åˆå§‹åŒ–æ¶ˆæ¯åŒæ­¥åè®®</span>
    p<span class="token punctuation">.</span>syncStart <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>  <span class="token comment">// åˆå§‹åŒ–åŒæ­¥å¼€å§‹åè®®</span>
    p<span class="token punctuation">.</span>syncFinish <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token comment">// åˆå§‹åŒ–åŒæ­¥ç»“æŸåè®®</span>
    p<span class="token punctuation">.</span>wsResp <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>     <span class="token comment">// åˆå§‹åŒ–WSå“åº”åè®®</span>
    p<span class="token punctuation">.</span>wsPush <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>     <span class="token comment">// åˆå§‹åŒ–WSæ¨é€åè®®</span>
    p<span class="token punctuation">.</span>wsConn <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>     <span class="token comment">// åˆå§‹åŒ–WSè¿æ¥æˆåŠŸåè®®</span>
    p<span class="token punctuation">.</span>wsReq <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>      <span class="token comment">// åˆå§‹åŒ–ä»»ä½•WSè¯·æ±‚åè®®</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="internal-interaction-ç»“æ„" tabindex="-1"><a class="header-anchor" href="#internal-interaction-ç»“æ„" aria-hidden="true">#</a> internal/interaction ç»“æ„</h2>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>â¯ <span class="token function">ls</span> internal/interaction <span class="token parameter variable">-al</span>
total <span class="token number">100</span>
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> May  <span class="token number">4</span> <span class="token number">17</span>:32 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">19</span> root root  <span class="token number">4096</span> Apr <span class="token number">28</span> 06:30 <span class="token punctuation">..</span>
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">1073</span> May  <span class="token number">4</span> 00:57 compressor.go
-rw-r--r--  <span class="token number">1</span> root root   <span class="token number">678</span> May  <span class="token number">4</span> 00:57 constant.go
-rw-r--r--  <span class="token number">1</span> root root   <span class="token number">574</span> May  <span class="token number">4</span> 00:57 context.go
-rw-r--r--  <span class="token number">1</span> root root   <span class="token number">745</span> May  <span class="token number">4</span> 00:57 encoder.go
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">14090</span> May  <span class="token number">4</span> <span class="token number">17</span>:32 long_conn_mgr.go
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">1550</span> May  <span class="token number">4</span> 00:57 long_connection.go
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">3130</span> May  <span class="token number">4</span> <span class="token number">17</span>:07 msg_sync.go
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">8878</span> May  <span class="token number">4</span> <span class="token number">17</span>:32 msg_sync2.go
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">9472</span> May  <span class="token number">4</span> <span class="token number">17</span>:32 msg_sync_self.go
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">12857</span> May  <span class="token number">4</span> 08:13 msy_sync_read_diffusion_group.go
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">2046</span> May  <span class="token number">4</span> 07:18 ws_default.go
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">1637</span> May  <span class="token number">4</span> 00:57 ws_js.go
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">3811</span> May  <span class="token number">4</span> <span class="token number">17</span>:32 ws_resp_asyn.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li><code v-pre>compressor.go</code>: å‹ç¼©å·¥å…·</li>
<li><code v-pre>context.go</code>: å¤„ç†ä¸Šä¸‹æ–‡</li>
<li><code v-pre>long_conn_mgr.go</code>: é•¿è¿æ¥ç®¡ç†å™¨</li>
<li><code v-pre>msg_sync.go</code>: æ¶ˆæ¯åŒæ­¥</li>
<li><code v-pre>msg_sync_self.go</code>: æ¶ˆæ¯åŒæ­¥ï¼ˆè‡ªèº«ï¼‰</li>
<li><code v-pre>ws_default.go</code>: WebSocket çš„é»˜è®¤å®ç°</li>
<li><code v-pre>ws_resp_asyn.go</code>: å¼‚æ­¥çš„ WebSocket å“åº”</li>
<li><code v-pre>constant.go</code>: å¸¸é‡</li>
<li><code v-pre>encoder.go</code>: ç¼–ç å™¨</li>
<li><code v-pre>long_connection.go</code>: é•¿è¿æ¥</li>
<li><code v-pre>msg_sync2.go</code>: æ¶ˆæ¯åŒæ­¥</li>
<li><code v-pre>msy_sync_read_diffusion_group.go</code>: æ¶ˆæ¯åŒæ­¥ï¼ˆè¯»å–æ‰©æ•£ç¾¤ç»„ï¼‰</li>
<li><code v-pre>ws_js.go</code>: WebSocket çš„ JavaScript å®ç°</li>
</ul>
<h2 id="æ–°åè®®" tabindex="-1"><a class="header-anchor" href="#æ–°åè®®" aria-hidden="true">#</a> æ–°åè®®</h2>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> SeqRange <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   state         protoimpl<span class="token punctuation">.</span>MessageState
   sizeCache     protoimpl<span class="token punctuation">.</span>SizeCache
   unknownFields protoimpl<span class="token punctuation">.</span>UnknownFields

   ConversationID <span class="token builtin">string</span> <span class="token string">`protobuf:"bytes,1,opt,name=conversationID,proto3" json:"conversationID"`</span>
   Begin          <span class="token builtin">int64</span>  <span class="token string">`protobuf:"varint,2,opt,name=begin,proto3" json:"begin"`</span>
   End            <span class="token builtin">int64</span>  <span class="token string">`protobuf:"varint,3,opt,name=end,proto3" json:"end"`</span>
   IsNotification <span class="token builtin">bool</span>   <span class="token string">`protobuf:"varint,4,opt,name=isNotification,proto3" json:"isNotification"`</span>
   Num            <span class="token builtin">int64</span>  <span class="token string">`protobuf:"varint,5,opt,name=num,proto3" json:"num"`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å‘ä¿¡æ¯åŒæ­¥åç¨‹å‘é€æ•°æ®" tabindex="-1"><a class="header-anchor" href="#å‘ä¿¡æ¯åŒæ­¥åç¨‹å‘é€æ•°æ®" aria-hidden="true">#</a> å‘ä¿¡æ¯åŒæ­¥åç¨‹å‘é€æ•°æ®</h3>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// -- // é•¿è¿æ¥åç¨‹å‘æ¶ˆæ¯åŒæ­¥åç¨‹ä¸‹å‘çš„æ•°æ®ï¼š</span>
<span class="token comment">// 1ã€æ¨é€æ¶ˆæ¯ï¼Œmsgä¸ºmsgDataåˆ‡ç‰‡</span>
<span class="token keyword">func</span> <span class="token function">TriggerCmdPushMsg</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> msg <span class="token operator">*</span>sdkws<span class="token punctuation">.</span>PushMessages<span class="token punctuation">,</span> ch <span class="token keyword">chan</span> Cmd2Value<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> ch <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"ch == nil"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    c2v <span class="token operator">:=</span> Cmd2Value<span class="token punctuation">{</span>Cmd<span class="token punctuation">:</span> constant<span class="token punctuation">.</span>CmdPushMsg<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> msg<span class="token punctuation">,</span> Ctx<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">sendCmd</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> c2v<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2ã€seqè§¦å‘</span>
<span class="token keyword">func</span> <span class="token function">TriggerCmdMaxSeq</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>seq sdk_struct<span class="token punctuation">.</span>CmdMaxSeqToMsgSync<span class="token punctuation">,</span> ch <span class="token keyword">chan</span> Cmd2Value<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> ch <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"ch == nil"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c2v <span class="token operator">:=</span> Cmd2Value<span class="token punctuation">{</span>Cmd<span class="token punctuation">:</span> constant<span class="token punctuation">.</span>CmdMaxSeq<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> seq<span class="token punctuation">,</span>Ctx<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">sendCmd</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> c2v<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3ã€è¿æ¥æˆåŠŸè§¦å‘</span>
<span class="token keyword">func</span> <span class="token function">TriggerCmdConnected</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ch <span class="token keyword">chan</span> Cmd2Value<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> ch <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"ch == nil"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c2v <span class="token operator">:=</span> Cmd2Value<span class="token punctuation">{</span>Cmd<span class="token punctuation">:</span> constant<span class="token punctuation">.</span>CmdConnSuccesss<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> Ctx<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">sendCmd</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> c2v<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span><span class="token punctuation">(</span>
    MsgSyncBegin      <span class="token operator">=</span> <span class="token number">1001</span> <span class="token comment">//</span>
    MsgSyncProcessing <span class="token operator">=</span> <span class="token number">1002</span> <span class="token comment">//</span>
    MsgSyncEnd        <span class="token operator">=</span> <span class="token number">1003</span> <span class="token comment">//</span>
    MsgSyncFailed     <span class="token operator">=</span> <span class="token number">1004</span>
<span class="token punctuation">)</span>
    
<span class="token keyword">type</span> CmdNewMsgComeToConversation <span class="token keyword">struct</span> <span class="token punctuation">{</span>

    MsgList  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>sdkws<span class="token punctuation">.</span>MsgData
    SyncFlag <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è¿™ä¸ªæ˜¯wsåç¨‹ä¸¢ç»™chçš„ä¸‰ç§ç±»å‹çš„æ•°æ®ï¼š</strong></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> CmdNewMsgComeToConversation <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    MsgList  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>sdkws<span class="token punctuation">.</span>MsgData
    SyncFlag <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ˜¯ä½ ä¸¢ç»™ <code v-pre>conversationch</code> çš„</p>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '53.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '55.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


