<template><div><ul>
<li><a href="http://nsddd.top" target="_blank" rel="noopener noreferrer">author<ExternalLinkIcon/></a></li>
</ul>
<h1 id="ç¬¬40èŠ‚-é€Ÿè¯»-sealos-æºç " tabindex="-1"><a class="header-anchor" href="#ç¬¬40èŠ‚-é€Ÿè¯»-sealos-æºç " aria-hidden="true">#</a> ç¬¬40èŠ‚ é€Ÿè¯» sealos æºç </h1>
<div><a href = '39.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '41.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>
<blockquote>
<p>â¤ï¸ğŸ’•ğŸ’•è®°å½•<a href="https://github.com/cubxxw/sealos" target="_blank" rel="noopener noreferrer">sealos<ExternalLinkIcon/></a>å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚<a href="https://github.com/cubxxw/sealos" target="_blank" rel="noopener noreferrer">k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ <ExternalLinkIcon/></a>ã€‚Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<ExternalLinkIcon/></a></p>
</blockquote>
<hr>
<p>[TOC]</p>
<h2 id="å‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#å‡†å¤‡" aria-hidden="true">#</a> å‡†å¤‡</h2>
<p>è¿™ç¯‡æ–‡ç« ç­‰çš„å¤ªä¹…äº†ï¼Œå¤§è‡´ å››ä¸ªæœˆäº†æŠŠï¼Œä¹Ÿæ˜¯è‡ªå·±ç»å† docker è·¨è¶Šåˆ° Kubernetes ä»¥åŠ CloudNative ç”Ÿæ€çš„è¿‡ç¨‹ã€‚</p>
<p>åè¿‡æ¥å†å»ç†è§£å¼€æºã€ç†è§£ sealosã€ ç†è§£ Kubernetesï¼Œæœ‰ç§è±ç„¶å¼€æœ—çš„è§†è§’ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« å’Œå…¶ä»–æ–‡ç« ä¸ä¸€æ ·çš„æ˜¯ï¼Œè¿™ç¯‡æ˜¯æŒ‰ç…§è‡ªå·±ç°åœ¨çš„æ€è·¯æ¥å†™çš„ï¼Œå…·ä½“ä¸ºä»€ä¹ˆï¼Œåœ¨ä»¥å‰çš„æ–‡ç« ä¸­èƒ½æ‰¾åˆ°ç­”æ¡ˆ~</p>
<p><strong>ä» CMD è§’åº¦ä¸Šå¯¹æ¥æºç ï¼Œä»æœ€å¼€å§‹å‡ºå‘ï¼š</strong></p>
<p>ä¸ç®¡æ˜¯ sealer è¿˜æ˜¯ sealctlï¼Œéƒ½ç¦»ä¸å¼€ é•œåƒçš„æ„å»ºæ ¸å¿ƒã€‹ buildahï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/containers/buildah"</span>

	<span class="token string">"github.com/labring/sealos/cmd/sealctl/cmd"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> buildah<span class="token punctuation">.</span><span class="token function">InitReexec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	cmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä» <code v-pre>InitReexec</code> è°ƒç”¨ buildah åˆå§‹åŒ–å¼€å§‹ï¼Œè¿›è¡Œèµ°è¿› sealos çš„å¤§é—¨ï¼š<code v-pre>Execute</code></p>
<p>åœ¨ cobra ä¸­ï¼Œ<code v-pre>Execute</code> åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸ç®¡æ˜¯æ­£ç¡®çš„è¿˜æ˜¯å¤±è´¥çš„~</p>
<p>åœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå…ˆæ‰§è¡Œ  <code v-pre>init</code> åˆå§‹åŒ–å‡½æ•°ï¼Œå®ƒ å®šä¹‰äº†ä¸€äº›åˆå§‹åŒ–å·¥ä½œä»¥åŠæ ‡å¿—ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	cobra<span class="token punctuation">.</span><span class="token function">OnInitialize</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">CfgConsoleLogger</span><span class="token punctuation">(</span>debug<span class="token punctuation">,</span> showPath<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>debug<span class="token punctuation">,</span> <span class="token string">"debug"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"enable debug logger"</span><span class="token punctuation">)</span>
	rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>showPath<span class="token punctuation">,</span> <span class="token string">"show-path"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"enable show code path"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å“ˆå“ˆï¼Œsealos å¯¹äºæ—¥å¿—åŒ…çš„å°è£…ï¼Œè¿˜æ˜¯å¾ˆè®©æˆ‘æƒŠå–œçš„ï¼Œä½¿ç”¨äº† <code v-pre>zap</code> è¿›è¡ŒäºŒæ¬¡å¼€å‘å’Œå°è£…ï¼Œç”¨äºé€‚åˆè‡ªå·±çš„ä¸šåŠ¡éœ€è¦ï¼Œè¿™å¯¹æˆ‘æ˜¯æœ‰å‚è€ƒæ„ä¹‰çš„ï¼ŒåŒ…æ‹¬ horizonï¼Œæœªæ¥å¯èƒ½éœ€è¦åœ¨ æ—¥å¿—åŒ…å’Œ é”™è¯¯ç è®¾è®¡ä¸Šè¿›è¡Œæ”¹è¿›ï¼Œè¿™æ˜¯æˆå°±ä¸€ä¸ªä¼˜ç§€çš„å¼€æºé¡¹ç›®çš„å¿…è¦æ¡ä»¶~</p>
<p>åé¢å¯¹ <code v-pre>rootCmd</code> è¿›è¡Œäº†æ ‡å¿—ç»‘å®šï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ <code v-pre>sealos</code> çš„æ ¹å‘½ä»¤ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token comment">// rootCmd represents the base command when called without any subcommands</span>
<span class="token keyword">var</span> rootCmd <span class="token operator">=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
	Use<span class="token punctuation">:</span>   <span class="token string">"sealos"</span><span class="token punctuation">,</span>
	Short<span class="token punctuation">:</span> <span class="token string">"sealos is a Kubernetes distribution, a unified OS to manage cloud native applications."</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½œä¸º sealos æˆå°± Kubernetes é›†ç¾¤æœ€ä¸»è¦çš„å‘½ä»¤ï¼Œæˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹ <code v-pre>sealos run</code></p>
<ul>
<li><a href="https://docker.nsddd.top/Cloud-Native-k8s/6.html" target="_blank" rel="noopener noreferrer">ä½¿ç”¨ sealos å¿«é€Ÿæ­å»º HA cluster<ExternalLinkIcon/></a></li>
</ul>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>sealos run labring/kubernetes:v1.25.0 labring/helm:v3.8.2 labring/calico:v3.24.1 <span class="token punctuation">\</span>
     <span class="token parameter variable">--masters</span> <span class="token number">192.168</span>.0.2,192.168.0.3<span class="token punctuation">\</span>
     <span class="token parameter variable">--nodes</span> <span class="token number">192.168</span>.0.4 <span class="token parameter variable">-p</span> <span class="token punctuation">[</span>your-ssh-passwd<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¾ˆé«˜å…´çš„ä¸€ç‚¹ï¼Œç›¸æ¯”è¾ƒ sealerï¼Œsealos å°† run.go é€»è¾‘ä¸­çš„å¤§éƒ¨åˆ†éƒ½æ”¾åœ¨äº† pkg ä¸­å®ç°ï¼Œè®©å…¶çœ‹ä¸Šå»å¹¶ä¸æ˜¯é‚£ä¹ˆè‡ƒè‚¿ï¼Œä½†æ˜¯å¯¹äº sealos çš„æ¶æ„æ¥è¯´ï¼Œå› ä¸ºæ²¡æœ‰ cluster-runtime ä½œä¸ºæŠ½è±¡å±‚ï¼Œæ‰€ä»¥ sealos çš„ä¾èµ–è¿‡äºä¸¥é‡ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ç›®å‰æ­£åœ¨è®¾è®¡ k3s runtime æ‰€å¿…é¡»è§£å†³çš„æ€è·¯ã€‚</p>
<h2 id="åŸç†å®ç°" tabindex="-1"><a class="header-anchor" href="#åŸç†å®ç°" aria-hidden="true">#</a> åŸç†å®ç°</h2>
<p>run ç®€ç®€å•å•çš„ä¸€ä¸ªå‘½åæ˜¯é«˜åº¦æŠ½è±¡çš„ï¼šæˆ‘ä»¬ run çš„æ—¶å€™ cmd å°† <code v-pre>applier, err := apply.NewApplierFromArgs(images, runArgs)</code> ä¼ é€’ç»™ <code v-pre>NewApplierFromArgs</code></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewApplierFromArgs</span><span class="token punctuation">(</span>imageName <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">*</span>RunArgs<span class="token punctuation">)</span> <span class="token punctuation">(</span>applydrivers<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	clusterPath <span class="token operator">:=</span> constants<span class="token punctuation">.</span><span class="token function">Clusterfile</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>ClusterName<span class="token punctuation">)</span>
	cf <span class="token operator">:=</span> clusterfile<span class="token punctuation">.</span><span class="token function">NewClusterFile</span><span class="token punctuation">(</span>clusterPath<span class="token punctuation">,</span>
		clusterfile<span class="token punctuation">.</span><span class="token function">WithCustomConfigFiles</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>CustomConfigFiles<span class="token punctuation">)</span><span class="token punctuation">,</span>
		clusterfile<span class="token punctuation">.</span><span class="token function">WithCustomEnvs</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>CustomEnv<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> cf<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> clusterfile<span class="token punctuation">.</span>ErrClusterFileNotExists <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> cf<span class="token punctuation">.</span><span class="token function">SetSingleMode</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>Single<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	cluster <span class="token operator">:=</span> cf<span class="token punctuation">.</span><span class="token function">GetCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> cluster <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"creating new cluster"</span><span class="token punctuation">)</span>
		cluster <span class="token operator">=</span> <span class="token function">initCluster</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>ClusterName<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		cluster <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">DeepCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>ClusterArgs<span class="token punctuation">{</span>
		clusterName<span class="token punctuation">:</span> cluster<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
		cluster<span class="token punctuation">:</span>     cluster<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">runArgs</span><span class="token punctuation">(</span>imageName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> applydrivers<span class="token punctuation">.</span><span class="token function">NewDefaultApplier</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cluster<span class="token punctuation">,</span> cf<span class="token punctuation">,</span> imageName<span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>NewApplierFromArgs</code> ç”¨äºåˆ›å»ºä¸€ä¸ª <code v-pre>Applier</code> å®ä¾‹å¯¹è±¡ã€‚å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªæ˜¯é•œåƒåç§°æ•°ç»„ <code v-pre>imageName</code>ï¼Œå¦ä¸€ä¸ªæ˜¯è¿è¡Œå‚æ•° argsã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå®ƒå®ç°äº†ä»å‚æ•°ä¸­è·å– <code v-pre>ClusterName</code>ï¼Œç„¶åæ ¹æ® <code v-pre>ClusterName</code> è·å–å¯¹åº”çš„ <code v-pre>ClusterFile</code>ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚æ¥ç€ï¼Œå®ƒæ ¹æ®ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼Œæ›´æ–°é›†ç¾¤çŠ¶æ€ Cluster ä¸­çš„ specï¼Œæœ€åé€šè¿‡ Cluster å¯¹è±¡å’Œ ClusterFile å¯¹è±¡ï¼Œåˆ›å»ºä¸€ä¸ª Applier å¯¹è±¡è¿”å›ã€‚</p>
<h2 id="applier" tabindex="-1"><a class="header-anchor" href="#applier" aria-hidden="true">#</a> Applier</h2>
<p>é¦–å…ˆï¼ŒSealos ä¼šåˆ›å»ºä¸€ä¸ª Applier ç»“æ„ä½“ï¼Œè´Ÿè´£äº†éƒ¨ç½²é›†ç¾¤çš„æ ¸å¿ƒé€»è¾‘ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewDefaultApplier</span><span class="token punctuation">(</span>cluster <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster<span class="token punctuation">,</span> cf clusterfile<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> images <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> cluster<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"cluster name cannot be empty"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> cf <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		cf <span class="token operator">=</span> clusterfile<span class="token punctuation">.</span><span class="token function">NewClusterFile</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span><span class="token function">Clusterfile</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">:=</span> cf<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>cluster<span class="token punctuation">.</span>CreationTimestamp<span class="token punctuation">.</span><span class="token function">IsZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Applier<span class="token punctuation">{</span>
		ClusterDesired<span class="token punctuation">:</span> cluster<span class="token punctuation">,</span>
		ClusterFile<span class="token punctuation">:</span>    cf<span class="token punctuation">,</span>
		ClusterCurrent<span class="token punctuation">:</span> cf<span class="token punctuation">.</span><span class="token function">GetCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		RunNewImages<span class="token punctuation">:</span>   images<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>NewDefaultApplier</code> å‡½æ•°æ˜¯ç”¨äºåˆ›å»ºä¸€ä¸ª <code v-pre>Applier</code> å®ä¾‹å¯¹è±¡çš„ã€‚å®ƒæ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ˜¯ <code v-pre>Cluster</code> å¯¹è±¡</li>
<li>ä¸€ä¸ªæ˜¯ <code v-pre>ClusterFile</code> å¯¹è±¡</li>
<li>è¿˜æœ‰ä¸€ä¸ªæ˜¯é•œåƒåç§°æ•°ç»„ <code v-pre>images</code></li>
</ul>
<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå®ƒå®ç°äº†ä»å‚æ•°ä¸­è·å–é›†ç¾¤åç§°ï¼Œç„¶åæ ¹æ®é›†ç¾¤åç§°è·å–å¯¹åº”çš„ <code v-pre>ClusterFile</code>ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚æ¥ç€ï¼Œå®ƒæ ¹æ®ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼Œæ›´æ–°é›†ç¾¤çŠ¶æ€ <code v-pre>ClusterDesired</code> ä¸­çš„ <code v-pre>Spec</code>ï¼Œæœ€åé€šè¿‡ <code v-pre>ClusterDesired</code> å¯¹è±¡å’Œ <code v-pre>ClusterFile</code> å¯¹è±¡ï¼Œåˆ›å»ºä¸€ä¸ª <code v-pre>Applier</code> å¯¹è±¡è¿”å›ã€‚</p>
<p><strong>å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</strong></p>
<ol>
<li>åˆ¤æ–­é›†ç¾¤åç§°æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</li>
<li>åˆ¤æ–­ <code v-pre>ClusterFile</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ <code v-pre>ClusterFile</code>ã€‚</li>
<li>å¦‚æœ <code v-pre>ClusterDesired</code> çš„åˆ›å»ºæ—¶é—´æˆ³ä¸ºç©ºä¸” <code v-pre>ClusterCurrent</code> ä¸º <code v-pre>nil</code> æˆ– <code v-pre>ClusterCurrent</code> çš„åˆ›å»ºæ—¶é—´æˆ³ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–åˆ›å»ºä¸€ä¸ªæ–°çš„é›†ç¾¤ï¼Œ<code v-pre>ClusterDesired</code> çš„åˆ›å»ºæ—¶é—´æˆ³è®¾ç½®ä¸ºå½“å‰æ—¶é—´ã€‚</li>
<li>å¦‚æœ <code v-pre>ClusterDesired</code> å’Œ <code v-pre>ClusterCurrent</code> çš„åˆ›å»ºæ—¶é—´æˆ³éƒ½ä¸ä¸ºç©ºï¼Œåˆ™æ›´æ–°é›†ç¾¤çŠ¶æ€ <code v-pre>ClusterDesired</code> ä¸­çš„ <code v-pre>Spec</code>ã€‚</li>
</ol>
<p><code v-pre>Applier</code> é‡‡ç”¨äº† k8s çš„ <strong>å£°æ˜å¼</strong> çš„è®¾è®¡æ€æƒ³ï¼Œç”¨æˆ·å£°æ˜ä¸€ä¸ªæœŸæœ›çš„é›†ç¾¤çŠ¶æ€ï¼Œè€Œ Applier è´Ÿè´£å°†é›†ç¾¤ç°åœ¨çš„çŠ¶æ€è½¬æ¢æˆç”¨æˆ·æœŸæœ›çš„çŠ¶æ€ã€‚</p>
<h2 id="applier-struct" tabindex="-1"><a class="header-anchor" href="#applier-struct" aria-hidden="true">#</a> Applier struct</h2>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Applier <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ClusterDesired     <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster <span class="token comment">// ç”¨æˆ·æœŸæœ›çš„é›†ç¾¤çŠ¶æ€</span>
    ClusterCurrent     <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster <span class="token comment">// é›†ç¾¤å½“å‰çŠ¶æ€</span>
    ClusterFile        clusterfile<span class="token punctuation">.</span>Interface <span class="token comment">// å½“å‰é›†ç¾¤æ¥å£</span>
    Client             kubernetes<span class="token punctuation">.</span>Client
    CurrentClusterInfo <span class="token operator">*</span>version<span class="token punctuation">.</span>Info
    RunNewImages       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>              <span class="token comment">// run å‘½ä»¤æ–°å¢çš„é•œåƒåç§°</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>clusterfile.Interface</code> æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼ŒSealos ä¸­é€šè¿‡ <code v-pre>ClusterFile</code> å®ç°äº†è¿™ä¸€æ¥å£ã€‚å› æ­¤ï¼Œ<code v-pre>Applier</code> ç»“æ„ä½“ä¸­æœ€é‡è¦çš„å°±æ˜¯ <code v-pre>Cluster</code> å’Œ <code v-pre>ClusterFile</code> è¿™ä¸¤ä¸ªç±»å‹ï¼Œå®ƒä»¬å®šä¹‰äº†é›†ç¾¤çš„çŠ¶æ€å’Œé…ç½®ã€‚</p>
<ol>
<li>ClusterDesiredï¼šç”¨æˆ·æœŸæœ›çš„é›†ç¾¤çŠ¶æ€</li>
<li>ClusterCurrentï¼šé›†ç¾¤å½“å‰çŠ¶æ€</li>
<li>ClusterFileï¼šå½“å‰é›†ç¾¤æ¥å£</li>
<li>Clientï¼šKubernetes å®¢æˆ·ç«¯</li>
<li>CurrentClusterInfoï¼šé›†ç¾¤å½“å‰ä¿¡æ¯</li>
<li>RunNewImagesï¼šrun å‘½ä»¤æ–°å¢çš„é•œåƒåç§°</li>
</ol>
<h2 id="æ·±æŒ–é›†ç¾¤çš„-cluster-ç»“æ„ä½“" tabindex="-1"><a class="header-anchor" href="#æ·±æŒ–é›†ç¾¤çš„-cluster-ç»“æ„ä½“" aria-hidden="true">#</a> æ·±æŒ–é›†ç¾¤çš„ Cluster ç»“æ„ä½“</h2>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Cluster <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    metav1<span class="token punctuation">.</span>TypeMeta   <span class="token string">`json:",inline"`</span>
    metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">`json:"metadata,omitempty"`</span>

    Spec   ClusterSpec   <span class="token string">`json:"spec,omitempty"`</span>
    Status ClusterStatus <span class="token string">`json:"status,omitempty"`</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> ClusterSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Image ImageList <span class="token string">`json:"image,omitempty"`</span>
    SSH   SSH       <span class="token string">`json:"ssh"`</span>
    Hosts <span class="token punctuation">[</span><span class="token punctuation">]</span>Host    <span class="token string">`json:"hosts,omitempty"`</span>
    Env <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"env,omitempty"`</span>
    Command <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"command,omitempty"`</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> ClusterStatus <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Phase      ClusterPhase       <span class="token string">`json:"phase,omitempty"`</span>
    Mounts     <span class="token punctuation">[</span><span class="token punctuation">]</span>MountImage       <span class="token string">`json:"mounts,omitempty"`</span>
    Conditions <span class="token punctuation">[</span><span class="token punctuation">]</span>ClusterCondition <span class="token string">`json:"conditions,omitempty" `</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Cluster çš„å†…å®¹æŒ‰ç…§ K8s Resource çš„æ ¼å¼è¿›è¡Œäº†è®¾è®¡ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å°†ç»“æ„ä½“éƒ½æ‹†åˆ†å‡ºæ¥äº†ï¼Œè€Œä¸æ˜¯ä½¿ç”¨çš„ç»“æ„ä½“åµŒå¥—ï¼Œè¿™æ ·æ›´åŠ è§„èŒƒã€æ›´åŠ æ•´æ´ã€‚åœ¨ ClusterSpec ä¸­ï¼Œå®šä¹‰äº†ä¸€ç³»åˆ—ç”¨äºéƒ¨ç½² K8s é›†ç¾¤çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼Œé•œåƒã€SSH å‚æ•°ã€èŠ‚ç‚¹ç­‰ç­‰ã€‚</p>
<p>è€Œåœ¨ ClusterStatus ä¸­ï¼Œ<code v-pre>Phase</code> å®šä¹‰äº†å½“å‰é›†ç¾¤çš„çŠ¶æ€ï¼Œ<code v-pre>Mounts</code> å®šä¹‰äº†é›†ç¾¤ä½¿ç”¨çš„é•œåƒï¼Œ<code v-pre>Conditions</code> ä¿å­˜äº†é›†ç¾¤ä¸­æ‰€å‘ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶ã€‚</p>
<h2 id="clusterfile" tabindex="-1"><a class="header-anchor" href="#clusterfile" aria-hidden="true">#</a> ClusterFile</h2>
<p><code v-pre>ClusterFile</code> æ˜¯çœŸæ­£è¢« <code v-pre>Applier</code> æ“ä½œçš„å¯¹è±¡ï¼Œä»¥åŠæŒä¹…åŒ–åˆ°æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚è¿™é‡ŒåŒ…å«äº†æ‰€æœ‰é›†ç¾¤çš„å½“å‰çŠ¶æ€ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜åŒ…å«äº† <code v-pre>kubeconfig</code>ã€‚è¿™é‡Œçš„ kubeconfig å¹¶ä¸æ˜¯æˆ‘ä»¬å¹³æ—¶æ“ä½œ k8s æ—¶æ‰€ç”¨çš„ config æ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ç³»åˆ—ç”¨äºæ­å»ºé›†ç¾¤æ‰€éœ€çš„é…ç½®é¡¹ã€‚åœ¨ä½¿ç”¨ <code v-pre>kubeadm</code> æ—¶ï¼Œè¿™äº›é…ç½®é¡¹å¾€å¾€éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨é…ç½®ï¼Œè€Œ Sealos åœ¨è¿™é‡Œä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å¡«å†™å¹¶åº”ç”¨äºé›†ç¾¤ä¸­ã€‚å¯ä»¥çœ‹å‡ºï¼Œ<code v-pre>Cluster</code> æ›´åƒæ˜¯ <code v-pre>ClusterFile</code> çš„ä¸€ä¸ªå®ä¾‹ï¼Œè®°å½•äº†é›†ç¾¤å®æ—¶çš„çŠ¶æ€ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	PreProcessor
	<span class="token function">GetCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster
	<span class="token function">GetConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>v2<span class="token punctuation">.</span>Config
	<span class="token function">GetKubeadmConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>runtime<span class="token punctuation">.</span>KubeadmConfig
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="åˆ›å»º-applier" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-applier" aria-hidden="true">#</a> åˆ›å»º Applier</h2>
<p>åˆ›å»º Applier çš„é€»è¾‘ï¼š</p>
<p><code v-pre>buildah mount</code> å‘½ä»¤æ˜¯ç”¨äºå°†å®¹å™¨é•œåƒæŒ‚è½½åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šçš„å·¥å…·ã€‚é€šè¿‡è¯¥å‘½ä»¤å¯ä»¥æ–¹ä¾¿åœ°æŸ¥çœ‹ã€ç¼–è¾‘å®¹å™¨é•œåƒä¸­çš„æ–‡ä»¶ã€‚å…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒ <a href="https://buildah.io/commands/mount/" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£<ExternalLinkIcon/></a>ã€‚</p>
<p><img src="http://sm.nsddd.top/sm202304152156333.png" alt="Untitled"></p>
<p><strong>åˆ›å»ºä¸€ä¸ª <code v-pre>Applier</code> ä¼šç»è¿‡ä»¥ä¸‹æ­¥éª¤ï¼š</strong></p>
<ol>
<li>åˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨ <code v-pre>ClusterFile</code> ï¼Œå¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆç›´æ¥è¯»å–ï¼Œæ„å»ºå‡ºé›†ç¾¤çŠ¶æ€ <code v-pre>Cluster</code>ã€‚å¦åˆ™ï¼Œåˆå§‹åŒ–åˆ›å»ºä¸€ä¸ªç©ºçš„é›†ç¾¤çŠ¶æ€ <code v-pre>Cluster</code>ã€‚</li>
<li>æ ¹æ®ç”¨æˆ·æœ¬æ¬¡çš„å‚æ•°ï¼Œæ›´æ–°é›†ç¾¤çŠ¶æ€ <code v-pre>Cluster</code> ä¸­çš„ specï¼Œæ­¤æ—¶ï¼Œ<code v-pre>Cluster</code> å³ä¸ºç›®æ ‡çš„é›†ç¾¤çŠ¶æ€ã€‚</li>
<li>å†æ¬¡ä»æ–‡ä»¶ä¸­æ„å»º <code v-pre>ClusterFile</code>ï¼Œä½œä¸ºé›†ç¾¤å½“å‰çš„çŠ¶æ€å’Œå¯¹è±¡ã€‚</li>
<li>æ„å»º <code v-pre>Applier</code> ç»“æ„ä½“è¿”å›ã€‚</li>
</ol>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å›åˆ°äº† run çš„é€»è¾‘ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code>RunE<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> runSingle <span class="token punctuation">{</span>
				addr<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> iputils<span class="token punctuation">.</span><span class="token function">ListLocalHostAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				runArgs<span class="token punctuation">.</span>Masters <span class="token operator">=</span> iputils<span class="token punctuation">.</span><span class="token function">LocalIP</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
				runArgs<span class="token punctuation">.</span>Single <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token punctuation">}</span>

			images<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">args2Images</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> transport<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>

			applier<span class="token punctuation">,</span> err <span class="token operator">:=</span> apply<span class="token punctuation">.</span><span class="token function">NewApplierFromArgs</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> runArgs<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> applier<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>applier</code> å°±æ˜¯æ„å»ºå‡ºçš„ç»“æ„ä½“ï¼šæ„å»º <code v-pre>applier</code> çš„ç›®çš„æ˜¯ä¸ºäº†å°†é›†ç¾¤çš„å½“å‰çŠ¶æ€è½¬æ¢æˆç”¨æˆ·æœŸæœ›çš„çŠ¶æ€ã€‚é€šè¿‡åˆå§‹åŒ–åˆ›å»ºä¸€ä¸ª <code v-pre>Applier</code>ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·æœ¬æ¬¡çš„å‚æ•°ï¼Œæ›´æ–°é›†ç¾¤çŠ¶æ€ <code v-pre>Cluster</code> ä¸­çš„ specï¼Œæœ€ç»ˆæ„å»ºå‡ºä¸€ä¸ª <code v-pre>Applier</code> ç»“æ„ä½“ã€‚è¿™ä¸ªç»“æ„ä½“å¯ä»¥å°†ç”¨æˆ·æœŸæœ›çš„é›†ç¾¤çŠ¶æ€è½¬æ¢æˆå®é™…çš„é›†ç¾¤çŠ¶æ€ï¼Œå®ç°äº† K8s çš„å£°æ˜å¼çš„è®¾è®¡æ€æƒ³ã€‚æ¥ä¸‹æ¥åˆ°äº† <code v-pre>Apply()</code> æ“ä½œäº†ã€‚</p>
<h2 id="å¼€å§‹-apply" tabindex="-1"><a class="header-anchor" href="#å¼€å§‹-apply" aria-hidden="true">#</a> å¼€å§‹ Apply</h2>
<p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡ <code v-pre>Applier.Apply()</code>ï¼ŒSealos å¼€å§‹æ­£å¼çš„éƒ¨ç½²é›†ç¾¤ï¼Œä½¿é›†ç¾¤çŠ¶æ€å‘ç›®æ ‡é è¿‘ã€‚é¦–å…ˆï¼ŒSealos ä¼šå°†å½“å‰é›†ç¾¤çš„çŠ¶æ€ç½®ä¸º <code v-pre>ClusterInProcess</code>ã€‚æ¥ä¸‹æ¥ï¼Œæ ¹æ®é›†ç¾¤åˆ›å»ºæˆ–æ˜¯æ›´æ–°ï¼Œåˆ†åˆ«è¿›å…¥ä¸¤ä¸ªåˆ†æ”¯ã€‚</p>
<blockquote>
<p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦è¯´æ˜å¾—ï¼Œä¹‹å‰æœ‰ä¸€æ¬¡é¢è¯•çš„æ—¶å€™é¢è¯•å®˜é—®æˆ‘ï¼Œ<code v-pre>apply</code> å’Œ <code v-pre>create</code> å®ç°çš„é€»è¾‘ï¼Œè¿™ä¸¤ä¸ªå®ç°çš„é€»è¾‘åŒºåˆ«å°±æ˜¯ï¼Œå¾ˆæ˜æ˜¾çš„ï¼Œcreate å¹¶ä¸ä¼šè¿›è¡Œ æ§åˆ¶å™¨ çš„ è§‚å¯Ÿã€åˆ†æé˜¶æ®µï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡Œå’Œæ›´æ–°ï¼Œè¿™æ ·çš„æ˜¯ç¬¦åˆçš„æ˜¯å‘½ä»¤å¼ç‰¹ç‚¹ï¼Œè€Œå¹¶éæ˜¯å£°æ˜å¼çš„ ç‰¹å¾ã€‚</p>
</blockquote>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Applier<span class="token punctuation">)</span> <span class="token function">Apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	clusterPath <span class="token operator">:=</span> constants<span class="token punctuation">.</span><span class="token function">Clusterfile</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ClusterDesired<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
	<span class="token comment">// clusterErr and appErr should not appear in the same time</span>
	<span class="token keyword">var</span> clusterErr<span class="token punctuation">,</span> appErr <span class="token builtin">error</span>
	<span class="token comment">// save cluster to file after apply</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> clusterErr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>processor<span class="token punctuation">.</span>CheckError<span class="token punctuation">,</span> <span class="token operator">*</span>processor<span class="token punctuation">.</span>PreProcessError<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"write cluster file to local storage: %s"</span><span class="token punctuation">,</span> clusterPath<span class="token punctuation">)</span>
		saveErr <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">MarshalYamlToFile</span><span class="token punctuation">(</span>clusterPath<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">getWriteBackObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> saveErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"write cluster file to local storage: %s error, %s"</span><span class="token punctuation">,</span> clusterPath<span class="token punctuation">,</span> saveErr<span class="token punctuation">)</span>
			logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"complete write back file: \n %v"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">getWriteBackObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">initStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>ClusterDesired<span class="token punctuation">.</span>CreationTimestamp<span class="token punctuation">.</span><span class="token function">IsZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>ClusterCurrent <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> c<span class="token punctuation">.</span>ClusterCurrent<span class="token punctuation">.</span>CreationTimestamp<span class="token punctuation">.</span><span class="token function">IsZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		clusterErr <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">initCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>ClusterDesired<span class="token punctuation">.</span>CreationTimestamp <span class="token operator">=</span> metav1<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		clusterErr<span class="token punctuation">,</span> appErr <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">reconcileCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>ClusterDesired<span class="token punctuation">.</span>CreationTimestamp <span class="token operator">=</span> c<span class="token punctuation">.</span>ClusterCurrent<span class="token punctuation">.</span>CreationTimestamp
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>clusterErr<span class="token punctuation">,</span> appErr<span class="token punctuation">)</span>

	<span class="token comment">// return app error if not nil</span>
	<span class="token keyword">if</span> appErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>appErr<span class="token punctuation">,</span> processor<span class="token punctuation">.</span>ErrCancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> appErr
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> clusterErr
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>Apply()</code> å‡½æ•°æ˜¯ Sealos ä¸­è´Ÿè´£éƒ¨ç½²é›†ç¾¤çš„æ ¸å¿ƒå‡½æ•°ã€‚è¯¥å‡½æ•°é€šè¿‡ä¼ å…¥çš„ <code v-pre>Applier</code> å®ä¾‹çš„ <code v-pre>ClusterDesired</code> å’Œ <code v-pre>ClusterCurrent</code> çš„å€¼æ¥åˆ¤æ–­é›†ç¾¤æ˜¯å¦å·²ç»å­˜åœ¨ã€‚åœ¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œé¦–å…ˆä¼šå°†å½“å‰é›†ç¾¤çŠ¶æ€ç½®ä¸º <code v-pre>ClusterInProcess</code>ï¼Œç„¶ååˆ†åˆ«è°ƒç”¨ <code v-pre>initCluster()</code> å’Œ <code v-pre>reconcileCluster()</code> æ¥ <strong>åˆ›å»ºå’Œæ›´æ–°é›†ç¾¤</strong>ã€‚æœ€åï¼Œå‡½æ•°ä¼šæ ¹æ® <code v-pre>appErr</code> å’Œ <code v-pre>clusterErr</code> çš„å€¼æ¥æ›´æ–°é›†ç¾¤ï¼ˆæˆ–è€… APPï¼‰çš„çŠ¶æ€ï¼Œå› ä¸ºä¸Šé¢è®²è¿‡ <code v-pre>EXECUTE</code> åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œæ— è®ºå¯¹é”™ï¼Œæ‰€ä»¥ cluster å’Œ app åªèƒ½æœ‰ä¸€ä¸ªå­˜åœ¨ã€‚</p>
<p>ä¸ºä»€ä¹ˆéœ€è¦ <code v-pre>c.initStatus()</code>:</p>
<p>initStatus å‡½æ•°çš„ä½œç”¨æ˜¯åˆå§‹åŒ–é›†ç¾¤çŠ¶æ€ï¼Œå³ä¸ºé›†ç¾¤çŠ¶æ€ Cluster ä¸­çš„ Status å­—æ®µèµ‹åˆå€¼ï¼šå°† Phase è®¾ä¸º ClusterInProcessï¼Œå¦‚æœ Conditions ä¸ºç©ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Applier<span class="token punctuation">)</span> <span class="token function">initStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>ClusterDesired<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Phase <span class="token operator">=</span> v2<span class="token punctuation">.</span>ClusterInProcess
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>ClusterDesired<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Conditions <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>ClusterDesired<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Conditions <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>v2<span class="token punctuation">.</span>ClusterCondition<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡½æ•°å®ç°å¾ˆç®€å•ï¼Œå…ˆå°† <code v-pre>Phase</code> è®¾ä¸º <code v-pre>ClusterInProcess</code>ï¼Œè¡¨ç¤ºé›†ç¾¤æ­£åœ¨éƒ¨ç½²ä¸­ã€‚ç„¶åï¼Œåˆ¤æ–­ <code v-pre>Conditions</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™å°† <code v-pre>Conditions</code> è®¾ä¸ºä¸€ä¸ªç©ºæ•°ç»„ã€‚</p>
<p>è¿™æ®µä»£ç æ˜¯åœ¨åˆ¤æ–­é›†ç¾¤æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li><code v-pre>c.ClusterDesired.CreationTimestamp.IsZero()</code> åˆ¤æ–­æœŸæœ›çŠ¶æ€çš„ <code v-pre>CreationTimestamp</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è¯´æ˜é›†ç¾¤ä¸å­˜åœ¨æˆ–è€…è¿˜æ²¡æœ‰åˆ›å»ºã€‚</li>
<li><code v-pre>(c.ClusterCurrent == nil || c.ClusterCurrent.CreationTimestamp.IsZero())</code> åˆ¤æ–­å½“å‰çŠ¶æ€çš„ <code v-pre>ClusterCurrent</code> æ˜¯å¦ä¸ºç©ºæˆ–è€… <code v-pre>CreationTimestamp</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è¯´æ˜é›†ç¾¤ä¸å­˜åœ¨æˆ–è€…è¿˜æ²¡æœ‰åˆ›å»ºã€‚</li>
</ul>
<p>å¦‚æœä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼Œè¯´æ˜é›†ç¾¤è¿˜æ²¡æœ‰åˆ›å»ºï¼Œå¯ä»¥è°ƒç”¨ <code v-pre>initCluster()</code> å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„é›†ç¾¤ã€‚å¦åˆ™ï¼Œè¯´æ˜é›†ç¾¤å·²ç»å­˜åœ¨ï¼Œå¯ä»¥è°ƒç”¨ <code v-pre>reconcileCluster()</code> å‡½æ•°æ¥æ›´æ–°é›†ç¾¤ã€‚</p>
<p><code v-pre>yaml.MarshalYamlToFile</code> çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡åºåˆ—åŒ–ä¸º YAML æ ¼å¼ï¼Œå¹¶å°†åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²å†™å…¥æŒ‡å®šçš„æ–‡ä»¶ã€‚åœ¨ Sealos ä¸­ï¼Œ<code v-pre>yaml.MarshalYamlToFile</code> ç”¨äºå°† <code v-pre>ClusterFile</code> å¯¹è±¡åºåˆ—åŒ–ä¸º YAML æ ¼å¼ï¼Œå¹¶å°†å…¶å†™å…¥æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªæ–‡ä»¶ç”¨äºæŒä¹…åŒ–é›†ç¾¤çš„çŠ¶æ€ã€‚</p>
<p><code v-pre>initCluster()</code> å‡½æ•°ä¼šä»é›¶å¼€å§‹åˆ›å»ºä¸€ä¸ªé›†ç¾¤ï¼Œä¼šä½¿ç”¨ <code v-pre>CreateProcessor</code> å¯¹è±¡æ¥éƒ¨ç½²æœŸæœ›çŠ¶æ€çš„é›†ç¾¤ã€‚<code v-pre>CreateProcessor.Execute()</code> å‡½æ•°æ¥æ”¶æœŸæœ›çš„é›†ç¾¤çŠ¶æ€ <code v-pre>ClusterDesired</code>ï¼Œç„¶åæ‰§è¡Œä¸€ç³»åˆ— pipelineï¼Œæ­£å¼è¿›å…¥å®é™…çš„é›†ç¾¤éƒ¨ç½²è¿‡ç¨‹ä¸­ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>InstallProcessor<span class="token punctuation">)</span> <span class="token function">GetPipeLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span>cluster <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> todoList <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span>cluster <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster<span class="token punctuation">)</span> <span class="token builtin">error</span>
	todoList <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>todoList<span class="token punctuation">,</span>
		c<span class="token punctuation">.</span>SyncStatusAndCheck<span class="token punctuation">,</span>
		c<span class="token punctuation">.</span>ConfirmOverrideApps<span class="token punctuation">,</span>
		c<span class="token punctuation">.</span>PreProcess<span class="token punctuation">,</span>
		c<span class="token punctuation">.</span>RunConfig<span class="token punctuation">,</span>
		c<span class="token punctuation">.</span>MountRootfs<span class="token punctuation">,</span>
		c<span class="token punctuation">.</span>MirrorRegistry<span class="token punctuation">,</span>
		c<span class="token punctuation">.</span>UpgradeIfNeed<span class="token punctuation">,</span>
		<span class="token comment">// i.GetPhasePluginFunc(plugin.PhasePreGuest),</span>
		c<span class="token punctuation">.</span>RunGuest<span class="token punctuation">,</span>
		c<span class="token punctuation">.</span>PostProcess<span class="token punctuation">,</span>
		<span class="token comment">// i.GetPhasePluginFunc(plugin.PhasePostInstall),</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">return</span> todoList<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Sealos ä¸­ï¼Œ<code v-pre>CreateProcessor</code> å’Œ <code v-pre>InstallProcessor</code> æ˜¯ä¸¤ä¸ªä¸åŒçš„ Processorï¼Œåˆ†åˆ«ç”¨äºåˆ›å»ºé›†ç¾¤å’Œå®‰è£…é›†ç¾¤ã€‚å®ƒä»¬å®ç°äº† <code v-pre>processor.Processor</code> æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†æ‰§è¡Œé›†ç¾¤éƒ¨ç½²æ‰€éœ€çš„åŸºæœ¬æ–¹æ³•ã€‚æ¯ä¸ª Processor ä¸­éƒ½åŒ…å«äº†ä¸€ç³»åˆ—çš„ Pipelineï¼Œæ¯ä¸ª Pipeline ä¸­åˆåŒ…å«äº†ä¸€ç³»åˆ—çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ç”¨äºæ‰§è¡Œå…·ä½“çš„éƒ¨ç½²æ“ä½œã€‚</p>
<p>åœ¨ <code v-pre>CreateProcessor</code> ä¸­ï¼Œ<code v-pre>GetPipeLine()</code> å‡½æ•°è¿”å›ä¸€ä¸ªåŒ…å«äº†åˆ›å»ºé›†ç¾¤æ‰€éœ€ Pipeline çš„åˆ—è¡¨ã€‚è¿™ä¸ªåˆ—è¡¨ä¸­åŒ…å«äº†ä¸€äº›åŸºæœ¬æ“ä½œï¼Œä¾‹å¦‚æ£€æŸ¥é›†ç¾¤æ˜¯å¦å·²ç»å­˜åœ¨ã€è¿è¡Œé…ç½®ã€æ£€æŸ¥å¹¶æŒ‚è½½ rootfsã€å¯åŠ¨ bootstrap ç­‰ç­‰ã€‚è¿™äº›æ“ä½œä¼šè¢«ä¾æ¬¡æ‰§è¡Œï¼Œæœ€ç»ˆå®Œæˆé›†ç¾¤çš„åˆ›å»ºè¿‡ç¨‹ã€‚</p>
<p>è€Œåœ¨ <code v-pre>InstallProcessor</code> ä¸­ï¼Œ<code v-pre>GetPipeLine()</code> å‡½æ•°è¿”å›ä¸€ä¸ªåŒ…å«äº†å®‰è£…é›†ç¾¤æ‰€éœ€ Pipeline çš„åˆ—è¡¨ã€‚è¿™ä¸ªåˆ—è¡¨ä¸­åŒ…å«äº†ä¸åˆ›å»ºé›†ç¾¤ç±»ä¼¼çš„æ“ä½œï¼Œä½†ä¹ŸåŒ…å«äº†ä¸€äº›é¢å¤–çš„æ“ä½œï¼Œå¦‚å‡çº§ã€è¿è¡Œ guestã€åå¤„ç†ç­‰ç­‰ã€‚è¿™äº›æ“ä½œä¼šè¢«ä¾æ¬¡æ‰§è¡Œï¼Œæœ€ç»ˆå®Œæˆé›†ç¾¤çš„å®‰è£…è¿‡ç¨‹ã€‚</p>
<p>ä»åŠŸèƒ½ä¸Šæ¥çœ‹ï¼Œ<code v-pre>CreateProcessor</code> æ›´ä¾§é‡äºåˆ›å»ºé›†ç¾¤ï¼Œè€Œ <code v-pre>InstallProcessor</code> æ›´ä¾§é‡äºå®‰è£…é›†ç¾¤ã€‚å®é™…ä¸Šï¼Œåœ¨ Sealos ä¸­ï¼Œè¿™ä¸¤ä¸ª Processor ä¹‹é—´å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œå®ƒä»¬éƒ½åŒ…å«äº†ç›¸åŒçš„ Pipeline å’Œæ“ä½œã€‚å”¯ä¸€çš„åŒºåˆ«åœ¨äºå®ƒä»¬è¢«ç”¨äºä¸åŒçš„åœºæ™¯ã€‚</p>
<p><code v-pre>pipeline</code> ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>
<p>Checkï¼šæ£€æŸ¥é›†ç¾¤çš„ä¸»æœºï¼ŒåŒ…æ‹¬ IP æ˜¯å¦èƒ½å¤Ÿè®¿é—®ï¼Œä¸»æœºæ˜¯å¦ä¸º Linux ç³»ç»Ÿï¼Œç”¨æˆ·æ˜¯å¦ä¸º root ç­‰ã€‚</p>
</li>
<li>
<p>PreProcessï¼šè´Ÿè´£é›†ç¾¤éƒ¨ç½²å‰çš„é•œåƒé¢„å¤„ç†æ“ä½œï¼Œä¸»è¦æ˜¯ä½¿ç”¨ <code v-pre>image.Manager</code> å¯¹è±¡æ¥å¤„ç†é•œåƒã€‚åœ¨è¿™é‡Œä¼šæ‹‰å–é•œåƒï¼Œå¹¶å¯¹é•œåƒè¿›è¡Œæ ¼å¼æ£€æŸ¥ã€æŒ‚è½½åˆ° rootfs ä¸Šç­‰æ“ä½œã€‚</p>
</li>
<li>
<p>RunConfigï¼šå°†é›†ç¾¤çŠ¶æ€ä¸­çš„ <code v-pre>working container</code> å¯¼å‡ºæˆ yaml æ ¼å¼çš„é…ç½®å¹¶æŒä¹…åŒ–åˆ°å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>InstallProcessor<span class="token punctuation">)</span> <span class="token function">RunConfig</span><span class="token punctuation">(</span><span class="token boolean">_</span> <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>NewMounts<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	eg<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> errgroup<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> cManifest <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>NewMounts <span class="token punctuation">{</span>
		manifest <span class="token operator">:=</span> cManifest
		eg<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			cfg <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">NewConfiguration</span><span class="token punctuation">(</span>manifest<span class="token punctuation">.</span>ImageName<span class="token punctuation">,</span> manifest<span class="token punctuation">.</span>MountPoint<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ClusterFile<span class="token punctuation">.</span><span class="token function">GetConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> cfg<span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> eg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>RunConfig</code> å‡½æ•°çš„ä½œç”¨æ˜¯å°†é›†ç¾¤çŠ¶æ€ä¸­çš„ <code v-pre>working container</code> å¯¼å‡ºæˆ yaml æ ¼å¼çš„é…ç½®å¹¶æŒä¹…åŒ–åˆ°å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚åœ¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šå°† <code v-pre>working container</code> çš„é…ç½®å¯¼å‡ºæˆ Config å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ <code v-pre>config.Dump()</code> å‡½æ•°å°† Config å¯¹è±¡åºåˆ—åŒ–ä¸º YAML æ ¼å¼ï¼Œå¹¶å°†å…¶å†™å…¥æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚åœ¨ Sealos ä¸­ï¼Œ<code v-pre>RunConfig</code> å‡½æ•°ä¸»è¦ç”¨äºç”Ÿæˆ Kubernetes é›†ç¾¤çš„é…ç½®æ–‡ä»¶ï¼Œè¿™äº›é…ç½®æ–‡ä»¶ç”¨äºæŒä¹…åŒ–é›†ç¾¤çš„çŠ¶æ€ã€‚</p>
<p><code v-pre>rootfs â†’ Clusterfile</code></p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Dumper<span class="token punctuation">)</span> <span class="token function">Dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Configs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"clusterfile config is empty!"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">WriteFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to write config files %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Dumper<span class="token punctuation">)</span> <span class="token function">WriteFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> config <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>Configs <span class="token punctuation">{</span>
		<span class="token keyword">if</span> config<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Match <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Match <span class="token operator">!=</span> c<span class="token punctuation">.</span>name <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		configData <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Data<span class="token punctuation">)</span>
		configPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>RootPath<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		<span class="token comment">//only the YAML format is supported</span>
		<span class="token keyword">switch</span> config<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Strategy <span class="token punctuation">{</span>
		<span class="token keyword">case</span> v1beta1<span class="token punctuation">.</span>Merge<span class="token punctuation">:</span>
			configData<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">getMergeConfigData</span><span class="token punctuation">(</span>configPath<span class="token punctuation">,</span> configData<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> v1beta1<span class="token punctuation">.</span>Insert<span class="token punctuation">:</span>
			configData<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">getAppendOrInsertConfigData</span><span class="token punctuation">(</span>configPath<span class="token punctuation">,</span> configData<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> v1beta1<span class="token punctuation">.</span>Append<span class="token punctuation">:</span>
			configData<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">getAppendOrInsertConfigData</span><span class="token punctuation">(</span>configPath<span class="token punctuation">,</span> configData<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> v1beta1<span class="token punctuation">.</span>Override<span class="token punctuation">:</span>
		<span class="token punctuation">}</span>
		err <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>configPath<span class="token punctuation">,</span> configData<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"write config file failed %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>Dump()</code> å‡½æ•°æ˜¯ä¸€ä¸ªå°†é›†ç¾¤é…ç½®å†™å…¥æ–‡ä»¶çš„æ–¹æ³•ã€‚è¯¥å‡½æ•°é¦–å…ˆæ£€æŸ¥é…ç½®æ˜¯å¦ä¸ºç©ºã€‚å¦‚æœä¸ä¸ºç©ºï¼Œå®ƒå°†è°ƒç”¨ <code v-pre>WriteFiles()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†ä¸ºæ¯ä¸ªé…ç½®æ–‡ä»¶å†™å…¥æ–‡ä»¶ã€‚å¦‚æœæ²¡æœ‰å‘ç”Ÿé”™è¯¯ï¼Œåˆ™è¿”å› <code v-pre>nil</code>ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚</p>
<p><code v-pre>WriteFiles()</code> æ–¹æ³•æ˜¯å°†é›†ç¾¤é…ç½®å†™å…¥æ–‡ä»¶çš„å®é™…æ–¹æ³•ã€‚è¯¥æ–¹æ³•éå†æ‰€æœ‰é…ç½®å¹¶æ£€æŸ¥ä¸å½“å‰åç§°åŒ¹é…çš„é…ç½®ã€‚å¦‚æœæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é…ç½®ï¼Œåˆ™ä½¿ç”¨è¯¥é…ç½®ä¸­çš„æ•°æ®å°†å…¶å†™å…¥æ–‡ä»¶ã€‚åœ¨å†™å…¥åˆ°æ–‡ä»¶ä¹‹å‰ï¼Œè¿˜éœ€è¦æ£€æŸ¥é…ç½®ä¸­çš„ç­–ç•¥å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æœ€åï¼Œè¯¥æ–¹æ³•å°†è¿”å› <code v-pre>nil</code> æˆ–é”™è¯¯ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	Merge    StrategyType <span class="token operator">=</span> <span class="token string">"merge"</span>
	Override StrategyType <span class="token operator">=</span> <span class="token string">"override"</span>
	Insert   StrategyType <span class="token operator">=</span> <span class="token string">"insert"</span>
	Append   StrategyType <span class="token operator">=</span> <span class="token string">"append"</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™äº›å¸¸é‡å®šä¹‰äº† <code v-pre>StrategyType</code> ç±»å‹çš„æšä¸¾å€¼ï¼Œç”¨äºæŒ‡å®šåœ¨æ›´æ–°é…ç½®æ–‡ä»¶æ—¶ä½¿ç”¨çš„ç­–ç•¥ã€‚å…¶ä¸­ï¼Œ<code v-pre>Merge</code> è¡¨ç¤ºå°†æ–°é…ç½®åˆå¹¶åˆ°æ—§é…ç½®ä¸­ï¼Œ<code v-pre>Override</code> è¡¨ç¤ºä½¿ç”¨æ–°é…ç½®è¦†ç›–æ—§é…ç½®ï¼Œ<code v-pre>Insert</code> è¡¨ç¤ºåœ¨æ—§é…ç½®æ–‡ä»¶çš„æŒ‡å®šä½ç½®æ’å…¥æ–°é…ç½®ï¼Œ<code v-pre>Append</code> è¡¨ç¤ºå°†æ–°é…ç½®è¿½åŠ åˆ°æ—§é…ç½®æ–‡ä»¶çš„æœ«å°¾ã€‚</p>
</li>
<li>
<p><code v-pre>MountRootfs</code>ï¼šå°†æŒ‚è½½çš„é•œåƒå†…å®¹æŒ‰ç…§ç±»åˆ«åˆ†å‘åˆ°æ¯å°æœºå™¨ä¸Šã€‚è¿™é‡Œéœ€è¦ä»‹ç»ä¸€ä¸‹ sealos çš„é•œåƒç»“æ„ï¼Œä»¥æœ€åŸºç¡€çš„ k8s é•œåƒä¸ºä¾‹ï¼š</p>
</li>
</ol>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>labring/kubernetes
   - etc # é…ç½®é¡¹
   - scripts # è„šæœ¬
       - init-containerd.sh
       - init-kube.sh
       - init-shim.sh
       - init-registry.sh
       - init.sh
   - Kubefile # dockerfile è¯­æ³•ï¼Œå®šä¹‰äº†é•œåƒçš„æ‰§è¡Œé€»è¾‘
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote>
<p>è¿™ä¸ªè¿‡ç¨‹å¯¹æˆ‘ä»¬åˆ¶ä½œ k3s çš„é•œåƒæ¥è¯´éå¸¸é‡è¦ï¼Œæˆ‘åœ¨ä¸‹ä¸€ä¸ªæ ‡é¢˜è¯¦ç»†è§£é‡Šè¿™ä¸ªæ­¥éª¤ï¼Œæˆ–è®¸æˆ‘ä»¬åº”è¯¥å¥½å¥½çš„ç†è§£è¿™ä¸ªæ­¥éª¤~</p>
</blockquote>
<h2 id="mount" tabindex="-1"><a class="header-anchor" href="#mount" aria-hidden="true">#</a> mount</h2>
<p>ä¸Šé¢æœ‰ä¸€éƒ¨åˆ†æ˜¯ mount çš„åŸºç¡€é•œåƒï¼Œçœ‹åˆ°äº† <code v-pre>init.sh</code> æ˜¯æœ€å¼€å§‹æ‰§è¡Œçš„ã€‚è¿™ä¸ªæ—¶å€™ä¼šç”¨ <code v-pre>init</code> åˆå§‹åŒ–ä¸€äº› kubeadm å’Œ kubectl ä¸€äº›ä¸œè¥¿ï¼Œæˆ‘ä»¬åœ¨å­¦ä¹  Kubernetes ä¸­ä¹ŸçŸ¥é“äº†ï¼ŒKubernetes çš„ä¸€äº›åˆå§‹åŒ–é—®é¢˜ï¼Œæ˜¯æ²¡æœ‰åŠæ³•ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½²çš„ï¼Œå› ä¸º kubeadm æ˜¯å’Œ å®¹å™¨å’Œ å®¿ä¸»æœºæ‰“äº¤é“çš„ã€‚</p>
<p>Sealos çš„é•œåƒç»“æ„ä¸­åŒ…å«äº† addons æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­å­˜æ”¾äº†ä¸€äº›é¢å¤–çš„ç»„ä»¶ï¼Œæ¯”å¦‚ dashboard å’Œ metrics-serverã€‚åœ¨ MountRootfs è¿™æ­¥ä¸­ï¼Œä¼šæ‰§è¡Œ addons ç±»å‹çš„ init.sh è„šæœ¬ï¼Œå°† addons ä¸­çš„ç»„ä»¶å®‰è£…åˆ°é›†ç¾¤ä¸­</p>
<p>K8s ä½œä¸ºæ•´ä¸ªé›†ç¾¤çš„åŸºç¡€ï¼Œè™½ç„¶æœ€ç»ˆé•œåƒå†…çš„ç›®å½•ç»“æ„ä¸å…¶ä»–ä¸€è‡´ï¼Œä½†å…¶æ„å»ºè¿‡ç¨‹ç¨å¾®æœ‰æ‰€ä¸åŒã€‚åœ¨ CI ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œk8s é•œåƒå…¶å®æ˜¯åˆå¹¶äº†å¤šä¸ªæ–‡ä»¶å¤¹ï¼Œcontainerdï¼Œrootfs å’Œ registryã€‚è¿™äº›ç‹¬ç«‹çš„æ–‡ä»¶å¤¹ä¸­åŒ…å«æœ‰å®‰è£…å¯¹åº”ç»„ä»¶çš„è„šæœ¬ã€‚åœ¨ MountRootfs è¿™æ­¥ä¸­ï¼Œåªä¼šæ‰§è¡Œ rootfs å’Œ addons ç±»å‹çš„ init.sh è„šæœ¬ã€‚è¿™ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒSealos ä»…ä»…åœ¨æ¯å°æœºå™¨ä¸Šå®‰è£…æˆåŠŸäº† kubeletï¼Œæ•´ä¸ª k8s é›†ç¾¤è¿˜æœªå¯ç”¨ã€‚</p>
<p>å…ˆé€šè¿‡ä¸€ä¸ª æ„é€ å‡½æ•° ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>defaultRootfs<span class="token punctuation">)</span> <span class="token function">MountRootfs</span><span class="token punctuation">(</span>cluster <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster<span class="token punctuation">,</span> hosts <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">mountRootfs</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> hosts<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è™½ç„¶æˆ‘ä¹Ÿä¸çŸ¥é“è¿™ä¸ªæœ‰å•¥ç”¨ï¼Œä¸è¿‡ä¹Ÿç®—æ˜¯å®ç°äº†ç»“æ„ä½“æ–¹æ³•æŠŠï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>defaultRootfs<span class="token punctuation">)</span> <span class="token function">mountRootfs</span><span class="token punctuation">(</span>cluster <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster<span class="token punctuation">,</span> ipList <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	target <span class="token operator">:=</span> constants<span class="token punctuation">.</span><span class="token function">NewData</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RootFSPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	eg<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> errgroup<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	envProcessor <span class="token operator">:=</span> env<span class="token punctuation">.</span><span class="token function">NewEnvProcessor</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> f<span class="token punctuation">.</span>mounts<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> mount <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>mounts <span class="token punctuation">{</span>
		src <span class="token operator">:=</span> mount
		eg<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">IsExist</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>MountPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Image %s not exist, render env continue"</span><span class="token punctuation">,</span> src<span class="token punctuation">.</span>ImageName<span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// TODO: if we are planing to support rendering templates for each host,</span>
			<span class="token comment">// then move this rendering process before ssh.CopyDir and do it one by one.</span>
			err <span class="token operator">:=</span> <span class="token function">renderTemplatesWithEnv</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>MountPoint<span class="token punctuation">,</span> ipList<span class="token punctuation">,</span> envProcessor<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to render env: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			dirs<span class="token punctuation">,</span> err <span class="token operator">:=</span> file<span class="token punctuation">.</span><span class="token function">StatDir</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>MountPoint<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to stat files: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>dirs<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> exec<span class="token punctuation">.</span><span class="token function">RunBashCmd</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>constants<span class="token punctuation">.</span>DefaultChmodBash<span class="token punctuation">,</span> src<span class="token punctuation">.</span>MountPoint<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"run chmod to rootfs failed: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> eg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	sshClient <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">getSSH</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span>
	notRegistryDirFilter <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>entry fs<span class="token punctuation">.</span>DirEntry<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span>constants<span class="token punctuation">.</span><span class="token function">IsRegistryDir</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token punctuation">}</span>

	<span class="token keyword">for</span> idx <span class="token operator">:=</span> <span class="token keyword">range</span> ipList <span class="token punctuation">{</span>
		ip <span class="token operator">:=</span> ipList<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
		eg<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			egg<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> errgroup<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
			<span class="token keyword">for</span> idj <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>mounts <span class="token punctuation">{</span>
				mount <span class="token operator">:=</span> f<span class="token punctuation">.</span>mounts<span class="token punctuation">[</span>idj<span class="token punctuation">]</span>
				egg<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
					<span class="token keyword">switch</span> mount<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
					<span class="token keyword">case</span> v2<span class="token punctuation">.</span>RootfsImage<span class="token punctuation">,</span> v2<span class="token punctuation">.</span>PatchImage<span class="token punctuation">:</span>
						logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"send mount image, ip: %s, image name: %s, image type: %s"</span><span class="token punctuation">,</span> ip<span class="token punctuation">,</span> mount<span class="token punctuation">.</span>ImageName<span class="token punctuation">,</span> mount<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>
						err <span class="token operator">:=</span> ssh<span class="token punctuation">.</span><span class="token function">CopyDir</span><span class="token punctuation">(</span>sshClient<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> mount<span class="token punctuation">.</span>MountPoint<span class="token punctuation">,</span> target<span class="token punctuation">,</span> notRegistryDirFilter<span class="token punctuation">)</span>
						<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
							<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to copy %s %s: %v"</span><span class="token punctuation">,</span> mount<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> mount<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">return</span> <span class="token boolean">nil</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> egg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">:=</span> eg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	endEg<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> errgroup<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	master0 <span class="token operator">:=</span> cluster<span class="token punctuation">.</span><span class="token function">GetMaster0IPAndPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> idx <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>mounts <span class="token punctuation">{</span>
		mountInfo <span class="token operator">:=</span> f<span class="token punctuation">.</span>mounts<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
		endEg<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> mountInfo<span class="token punctuation">.</span>Type <span class="token operator">==</span> v2<span class="token punctuation">.</span>AppImage <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"send app mount images, ip: %s, image name: %s, image type: %s"</span><span class="token punctuation">,</span> master0<span class="token punctuation">,</span> mountInfo<span class="token punctuation">.</span>ImageName<span class="token punctuation">,</span> mountInfo<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>
				err <span class="token operator">=</span> ssh<span class="token punctuation">.</span><span class="token function">CopyDir</span><span class="token punctuation">(</span>sshClient<span class="token punctuation">,</span> master0<span class="token punctuation">,</span> mountInfo<span class="token punctuation">.</span>MountPoint<span class="token punctuation">,</span> constants<span class="token punctuation">.</span><span class="token function">GetAppWorkDir</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> mountInfo<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">,</span> notRegistryDirFilter<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to copy %s %s: %v"</span><span class="token punctuation">,</span> mountInfo<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> mountInfo<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> endEg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>mountRootfs</code> å‡½æ•°æ˜¯ Sealos ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒå‡½æ•°ï¼Œå®ƒä¸»è¦ç”¨äºå°†æŒ‚è½½çš„é•œåƒå†…å®¹æŒ‰ç…§ç±»åˆ«åˆ†å‘åˆ°æ¯å°æœºå™¨ä¸Šã€‚è¯¥å‡½æ•°ä¸­çš„æ­¥éª¤åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li><strong>ç¯å¢ƒå˜é‡å¤„ç†</strong>ï¼šè¯¥å‡½æ•°ä¼šæ ¹æ®ä¼ å…¥çš„é›†ç¾¤å’ŒæŒ‚è½½ç‚¹ä¿¡æ¯å¤„ç†ç¯å¢ƒå˜é‡ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª <code v-pre>envProcessor</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«äº†é›†ç¾¤çš„ä¿¡æ¯ä»¥åŠæŒ‚è½½ç‚¹çš„ä¿¡æ¯ï¼Œç”¨äºå¤„ç†ç¯å¢ƒå˜é‡ã€‚</li>
<li>éå†æŒ‚è½½ç‚¹ï¼šè¯¥å‡½æ•°ä¼šéå†æ‰€æœ‰çš„æŒ‚è½½ç‚¹ï¼Œå¯¹æ¯ä¸ªæŒ‚è½½ç‚¹æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
<ol>
<li>åˆ¤æ–­æŒ‚è½½ç‚¹æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è·³è¿‡è¯¥æŒ‚è½½ç‚¹ã€‚</li>
<li>æ¸²æŸ“ç¯å¢ƒå˜é‡ã€‚è¯¥å‡½æ•°ä¼šå°†ç¯å¢ƒå˜é‡æ³¨å…¥åˆ°æŒ‚è½½ç‚¹ä¸­ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šè°ƒç”¨ <code v-pre>renderTemplatesWithEnv</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°†ç¯å¢ƒå˜é‡æ³¨å…¥åˆ°æŒ‚è½½ç‚¹ä¸­çš„æ¨¡æ¿æ–‡ä»¶ä¸­ã€‚</li>
<li>ä¿®æ”¹ç›®å½•æƒé™ã€‚å¦‚æœæŒ‚è½½ç‚¹ä¸­åŒ…å«å­ç›®å½•ï¼Œåˆ™ä¼šå°†å…¶æƒé™æ›´æ”¹ä¸ºé»˜è®¤æƒé™ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šè°ƒç”¨ <code v-pre>exec.RunBashCmd</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šæ‰§è¡Œ <code v-pre>chmod</code> å‘½ä»¤ï¼Œå°†æŒ‚è½½ç‚¹ä¸­çš„æ‰€æœ‰ç›®å½•çš„æƒé™æ›´æ”¹ä¸ºé»˜è®¤æƒé™ã€‚</li>
</ol>
</li>
<li><strong>å¤åˆ¶é•œåƒåˆ°æ¯ä¸ªèŠ‚ç‚¹</strong>ï¼šè¯¥å‡½æ•°ä¼šå°†é•œåƒæ–‡ä»¶å¤¹å¤åˆ¶åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šéå†æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¯¹äºæ¯ä¸ªèŠ‚ç‚¹ï¼Œå®ƒä¼šéå†æ¯ä¸ªæŒ‚è½½ç‚¹ï¼Œå°†æŒ‚è½½ç‚¹ä¸­çš„é•œåƒæ–‡ä»¶å¤¹å¤åˆ¶åˆ°èŠ‚ç‚¹ä¸Šã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šè°ƒç”¨ <code v-pre>ssh.CopyDir</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šé€šè¿‡ SSH å°†æŒ‚è½½ç‚¹ä¸­çš„é•œåƒæ–‡ä»¶å¤¹å¤åˆ¶åˆ°èŠ‚ç‚¹ä¸Šã€‚</li>
<li><strong>å¤åˆ¶åº”ç”¨ç¨‹åºé•œåƒåˆ°ä¸»èŠ‚ç‚¹</strong>ï¼šå¦‚æœå­˜åœ¨åº”ç”¨ç¨‹åºé•œåƒï¼Œåˆ™å°†å…¶å¤åˆ¶åˆ°ä¸»èŠ‚ç‚¹ä¸Šã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šéå†æ¯ä¸ªæŒ‚è½½ç‚¹ï¼Œå¦‚æœæŒ‚è½½ç‚¹çš„ç±»å‹æ˜¯åº”ç”¨ç¨‹åºé•œåƒç±»å‹ï¼Œåˆ™å°†å…¶å¤åˆ¶åˆ°ä¸»èŠ‚ç‚¹ä¸Šã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šè°ƒç”¨ <code v-pre>ssh.CopyDir</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šé€šè¿‡ SSH å°†åº”ç”¨ç¨‹åºé•œåƒæ–‡ä»¶å¤¹å¤åˆ¶åˆ°ä¸»èŠ‚ç‚¹ä¸Šã€‚</li>
</ol>
<h2 id="mirrorregistry-å’Œ-bootstrap-æ­¥éª¤" tabindex="-1"><a class="header-anchor" href="#mirrorregistry-å’Œ-bootstrap-æ­¥éª¤" aria-hidden="true">#</a> MirrorRegistry å’Œ Bootstrap æ­¥éª¤</h2>
<h3 id="mirrorregistry" tabindex="-1"><a class="header-anchor" href="#mirrorregistry" aria-hidden="true">#</a> MirrorRegistry</h3>
<p>å½“ç„¶ï¼Œåœ¨åˆ° init çš„æ­¥éª¤ä¸­è¿˜æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>c.MirrorRegistry,
c.Bootstrap,
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>MirrorRegistry</code> é˜¶æ®µæ˜¯ Sealos éƒ¨ç½²é›†ç¾¤çš„ä¸€ä¸ªé‡è¦æ­¥éª¤ã€‚åœ¨è¿™ä¸ªæ­¥éª¤ä¸­ï¼ŒSealos ä¼šå°†æ‰€éœ€çš„ Docker é•œåƒä»å…¬å…±é•œåƒä»“åº“ä¸­æ‹‰å–åˆ°æœ¬åœ°ï¼Œå¹¶å°†å…¶æ¨é€åˆ°æœ¬åœ°çš„ Docker é•œåƒä»“åº“ä¸­ã€‚è¿™ä¸ªæ­¥éª¤çš„ä½œç”¨æ˜¯å°† Docker é•œåƒç¼“å­˜åˆ°æœ¬åœ°ï¼Œä»¥é¿å…åœ¨é›†ç¾¤éƒ¨ç½²è¿‡ç¨‹ä¸­é¢‘ç¹åœ°ä¸‹è½½é•œåƒï¼Œä»è€ŒåŠ å¿«é›†ç¾¤éƒ¨ç½²çš„é€Ÿåº¦ã€‚<code v-pre>MirrorRegistry</code> é˜¶æ®µé€šå¸¸æ˜¯åœ¨ <code v-pre>MountRootfs</code> é˜¶æ®µä¹‹åæ‰§è¡Œçš„ã€‚</p>
<p><strong>è¿™ä¸ªæ­¥éª¤å°±ç›¸å½“äºæ˜¯ sealos çš„æ ¸å¿ƒé€»è¾‘ï¼Œé•œåƒå¤„ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œç®—æ˜¯ä¸€ç§é»‘ç§‘æŠ€æŠŠï¼Œå°±æ˜¯æŠŠ remote docker registery ä¸­çš„ images pull åˆ° localhostï¼Œç„¶åç¼“å­˜ï¼Œåé¢å°±å¯ä»¥ç”¨ç¼“å­˜çš„æ–‡ä»¶äº†ã€‚</strong></p>
<h3 id="bootstrap" tabindex="-1"><a class="header-anchor" href="#bootstrap" aria-hidden="true">#</a> Bootstrap</h3>
<p><code v-pre>Bootstrap</code> é˜¶æ®µæ˜¯ Sealos éƒ¨ç½²é›†ç¾¤çš„æœ€åä¸€ä¸ªé˜¶æ®µã€‚åœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼ŒSealos ä¼šå¯åŠ¨ Kubernetes çš„åˆå§‹åŒ–ç¨‹åºï¼Œå¯¹é›†ç¾¤è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼ŒSealos ä¼šä½¿ç”¨ kubeadm å·¥å…·æ¥åˆ›å»º Kubernetes é›†ç¾¤çš„æ§åˆ¶å¹³é¢å’ŒèŠ‚ç‚¹ï¼Œå¯åŠ¨å„ç§ Kubernetes ç»„ä»¶ï¼Œå¹¶å°†å®ƒä»¬é…ç½®ä¸ºæ­£å¸¸è¿è¡Œã€‚å½“åˆå§‹åŒ–ç¨‹åºæˆåŠŸå®Œæˆåï¼ŒKubernetes é›†ç¾¤å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚<code v-pre>Bootstrap</code> é˜¶æ®µé€šå¸¸æ˜¯åœ¨ <code v-pre>MountRootfs</code> å’Œ <code v-pre>MirrorRegistry</code> é˜¶æ®µä¹‹åæ‰§è¡Œçš„ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>CreateProcessor<span class="token punctuation">)</span> <span class="token function">Bootstrap</span><span class="token punctuation">(</span>cluster <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Executing pipeline Bootstrap in CreateProcessor"</span><span class="token punctuation">)</span>
	hosts <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">GetMasterIPAndPortList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">GetNodeIPAndPortList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
	bs <span class="token operator">:=</span> bootstrap<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span>
	<span class="token keyword">return</span> bs<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>hosts<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»º bootstrap å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶ Apply å‡½æ•°ã€‚å…¶ä¸­ï¼Œcluster è¡¨ç¤º Kubernetes é›†ç¾¤çš„é…ç½®ä¿¡æ¯ï¼Œhosts åŒ…å«äº†é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹çš„ IP åœ°å€å’Œç«¯å£å·ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ Sealos ä¸­çš„ <code v-pre>bootstrap.New</code> å‡½æ•°ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>cluster <span class="token operator">*</span>v2<span class="token punctuation">.</span>Cluster<span class="token punctuation">)</span> Interface <span class="token punctuation">{</span>
	ctx <span class="token operator">:=</span> <span class="token function">NewContextFrom</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span>
	bs <span class="token operator">:=</span> <span class="token operator">&amp;</span>realBootstrap<span class="token punctuation">{</span>
		ctx<span class="token punctuation">:</span>          ctx<span class="token punctuation">,</span>
		preflights<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Applier<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		initializers<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Applier<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		postflights<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Applier<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// register builtin appliers</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> bs<span class="token punctuation">.</span><span class="token function">RegisterApplier</span><span class="token punctuation">(</span>Preflight<span class="token punctuation">,</span> defaultPreflights<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> bs<span class="token punctuation">.</span><span class="token function">RegisterApplier</span><span class="token punctuation">(</span>Init<span class="token punctuation">,</span> defaultInitializers<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> bs<span class="token punctuation">.</span><span class="token function">RegisterApplier</span><span class="token punctuation">(</span>Postflight<span class="token punctuation">,</span> defaultPostflights<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> bs
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»º bootstrap å®ä¾‹ï¼Œå¹¶åˆå§‹åŒ–å…¶å„ä¸ªå­—æ®µçš„å€¼ã€‚å…¶ä¸­ï¼Œcluster è¡¨ç¤º Kubernetes é›†ç¾¤çš„é…ç½®ä¿¡æ¯ï¼Œctx è¡¨ç¤ºä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œ<code v-pre>preflights</code>ã€<code v-pre>initializers</code>ã€<code v-pre>postflights</code> åˆ†åˆ«è¡¨ç¤ºé¢„æ£€æŸ¥ã€åˆå§‹åŒ–ã€åå¤„ç†å‡½æ•°çš„åˆ—è¡¨ã€‚æ­¤å¤–ï¼Œè¯¥å‡½æ•°è¿˜ä¼šè°ƒç”¨ <code v-pre>RegisterApplier</code> å‡½æ•°ï¼Œæ³¨å†Œé»˜è®¤çš„é¢„æ£€æŸ¥ã€åˆå§‹åŒ–ã€åå¤„ç†å‡½æ•°ã€‚</p>
<h3 id="registerapplier-å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#registerapplier-å‡½æ•°" aria-hidden="true">#</a> RegisterApplier å‡½æ•°</h3>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ Sealos ä¸­çš„ RegisterApplier å‡½æ•°ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>bs <span class="token operator">*</span>realBootstrap<span class="token punctuation">)</span> <span class="token function">RegisterApplier</span><span class="token punctuation">(</span>phase Phase<span class="token punctuation">,</span> appliers <span class="token operator">...</span>Applier<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> phase <span class="token punctuation">{</span>
	<span class="token keyword">case</span> Preflight<span class="token punctuation">:</span>
		bs<span class="token punctuation">.</span>preflights <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span>preflights<span class="token punctuation">,</span> appliers<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> Init<span class="token punctuation">:</span>
		bs<span class="token punctuation">.</span>initializers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span>initializers<span class="token punctuation">,</span> appliers<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> Postflight<span class="token punctuation">:</span>
		bs<span class="token punctuation">.</span>postflights <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span>postflights<span class="token punctuation">,</span> appliers<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unknown phase %s"</span><span class="token punctuation">,</span> phase<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯æ³¨å†Œé¢„æ£€æŸ¥ã€åˆå§‹åŒ–ã€åå¤„ç†å‡½æ•°ã€‚å…¶ä¸­ï¼Œphase è¡¨ç¤ºå‡½æ•°çš„ç±»å‹ï¼Œappliers è¡¨ç¤ºå‡½æ•°åˆ—è¡¨ã€‚è¯¥å‡½æ•°ä¼šæ ¹æ® phase çš„ä¸åŒï¼Œå°†å‡½æ•°åˆ—è¡¨æ·»åŠ åˆ°ç›¸åº”çš„åˆ—è¡¨ä¸­ã€‚</p>
<h3 id="apply-å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#apply-å‡½æ•°" aria-hidden="true">#</a> Apply å‡½æ•°</h3>
<p>æœ€åçœ‹ä¸€ä¸‹ Sealos ä¸­çš„ Apply å‡½æ•°ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>bs <span class="token operator">*</span>realBootstrap<span class="token punctuation">)</span> <span class="token function">Apply</span><span class="token punctuation">(</span>hosts <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	appliers <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Applier<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	appliers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>appliers<span class="token punctuation">,</span> bs<span class="token punctuation">.</span>preflights<span class="token operator">...</span><span class="token punctuation">)</span>
	appliers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>appliers<span class="token punctuation">,</span> bs<span class="token punctuation">.</span>initializers<span class="token operator">...</span><span class="token punctuation">)</span>
	appliers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>appliers<span class="token punctuation">,</span> bs<span class="token punctuation">.</span>postflights<span class="token operator">...</span><span class="token punctuation">)</span>
	logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"apply %+v on hosts %+v"</span><span class="token punctuation">,</span> appliers<span class="token punctuation">,</span> hosts<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> appliers <span class="token punctuation">{</span>
		applier <span class="token operator">:=</span> appliers<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">runParallel</span><span class="token punctuation">(</span>hosts<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>host <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>applier<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
			logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"apply %s on host %s"</span><span class="token punctuation">,</span> applier<span class="token punctuation">,</span> host<span class="token punctuation">)</span>
			<span class="token keyword">return</span> applier<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> host<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯ä¾æ¬¡æ‰§è¡Œé¢„æ£€æŸ¥ã€åˆå§‹åŒ–ã€åå¤„ç†å‡½æ•°ã€‚å…¶ä¸­ï¼Œ<code v-pre>hosts</code> è¡¨ç¤ºè¦æ‰§è¡Œå‡½æ•°çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œ<code v-pre>appliers</code> è¡¨ç¤ºè¦æ‰§è¡Œçš„å‡½æ•°åˆ—è¡¨ã€‚è¯¥å‡½æ•°ä¼šå°†é¢„æ£€æŸ¥ã€åˆå§‹åŒ–ã€åå¤„ç†å‡½æ•°åˆ†åˆ«æ·»åŠ åˆ° <code v-pre>appliers</code> åˆ—è¡¨ä¸­ï¼Œå¹¶æŒ‰ç…§é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ <code v-pre>Filter</code> å‡½æ•°æ¥åˆ¤æ–­è¯¥å‡½æ•°æ˜¯å¦éœ€è¦åœ¨è¯¥èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚å¦‚æœéœ€è¦æ‰§è¡Œï¼Œåˆ™ä¼šè°ƒç”¨ <code v-pre>Apply</code> å‡½æ•°æ¥æ‰§è¡Œè¯¥å‡½æ•°ã€‚æœ€åï¼Œè‹¥æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œåˆ™è¯¥å‡½æ•°ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ã€‚</p>
<p>é€šè¿‡å¯¹ <code v-pre>Sealos</code> çš„ <code v-pre>Bootstrap</code> é˜¶æ®µä»£ç è¿›è¡Œåˆ†æï¼Œæˆ‘ä»¬äº†è§£äº†å…¶è°ƒç”¨æµç¨‹å’Œå„ä¸ªå‡½æ•°çš„åŠŸèƒ½ã€‚åœ¨è¯¥é˜¶æ®µä¸­ï¼Œ<code v-pre>Sealos</code> ä¼šå¯åŠ¨ Kubernetes çš„åˆå§‹åŒ–ç¨‹åºï¼Œå¯¹é›†ç¾¤è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œä½¿ Kubernetes é›†ç¾¤å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚åŒæ—¶ï¼Œè¯¥é˜¶æ®µä¹Ÿä¼šæ‰§è¡Œé¢„æ£€æŸ¥ã€åˆå§‹åŒ–ã€åå¤„ç†å‡½æ•°ï¼Œä»¥ä¿è¯é›†ç¾¤çš„æ­£å¸¸è¿è¡Œã€‚</p>
<blockquote>
<p>è¿™é‡Œæˆ–è®¸å¯ä»¥å‚è€ƒ Linux å†…æ ¸å¯åŠ¨çš„ä¸€ä¸ªè¿‡ç¨‹ï¼ŒLinux ä¸­çš„ bootfs ä¼šå¯åŠ¨ä¸€ä¸ª Kernel Boot Processï¼Œå¼•å¯¼ kernel çš„å¯åŠ¨ï¼Œå¯åŠ¨å boot å°±ä¼šè¢«é”€æ¯ï¼Œç”Ÿå‘½å‘¨æœŸç»“æŸã€‚</p>
</blockquote>
<h2 id="init-é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#init-é˜¶æ®µ" aria-hidden="true">#</a> init é˜¶æ®µ</h2>
<p>Initï¼šåˆå§‹åŒ– k8s é›†ç¾¤ã€‚åœ¨è¿™æ­¥ä¸­ï¼Œå…¶å®ä¹Ÿæ˜¯æ‰§è¡Œäº†ä¸€ç³»åˆ—çš„å­æ“ä½œã€‚é¦–å…ˆï¼Œå°†é›†ç¾¤çŠ¶æ€å†™å…¥é›†ç¾¤æ–‡ä»¶ä¸­ã€‚</p>
<h3 id="initcluster" tabindex="-1"><a class="header-anchor" href="#initcluster" aria-hidden="true">#</a> <strong>initCluster</strong></h3>
<p><code v-pre>initCluster</code> è´Ÿè´£ä»é›¶å¼€å§‹åˆ›å»ºä¸€ä¸ªé›†ç¾¤ã€‚å‡½æ•°ä¸­ä¼šé€šè¿‡ <code v-pre>CreateProcessor</code> å»éƒ¨ç½²æœŸæœ›çŠ¶æ€çš„é›†ç¾¤ã€‚</p>
<div class="language-go ext-go line-numbers-mode"><pre v-pre class="language-go"><code><span class="token keyword">type</span> CreateProcessor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ClusterFile     clusterfile<span class="token punctuation">.</span>Interface <span class="token comment">// å½“å‰é›†ç¾¤å¯¹è±¡</span>
    ImageManager    types<span class="token punctuation">.</span>ImageService <span class="token comment">// å¤„ç†é•œåƒ</span>
    ClusterManager  types<span class="token punctuation">.</span>ClusterService <span class="token comment">// ç®¡ç† clusterfile</span>
    RegistryManager types<span class="token punctuation">.</span>RegistryService <span class="token comment">// ç®¡ç†é•œåƒ registry</span>
    Runtime         runtime<span class="token punctuation">.</span>Interface   <span class="token comment">// kubeadm å¯¹è±¡</span>
    Guest           guest<span class="token punctuation">.</span>Interface   <span class="token comment">// åŸºäº sealos çš„åº”ç”¨å¯¹è±¡</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>CreateProcessor.Execute</code> æ¥æ”¶æœŸæœ›çš„é›†ç¾¤çŠ¶æ€ <code v-pre>ClusterDesired</code>ã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>func <span class="token punctuation">(</span>c *CreateProcessor<span class="token punctuation">)</span> Execute<span class="token punctuation">(</span>cluster *v2.Cluster<span class="token punctuation">)</span> error <span class="token punctuation">{</span>
	pipeLine, err :<span class="token operator">=</span> c.GetPipeLine<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{</span>
		<span class="token builtin class-name">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> _, f :<span class="token operator">=</span> range pipeLine <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">=</span> f<span class="token punctuation">(</span>cluster<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{</span>
			<span class="token builtin class-name">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token builtin class-name">return</span> nil
<span class="token punctuation">}</span>

func <span class="token punctuation">(</span>c *CreateProcessor<span class="token punctuation">)</span> GetPipeLine<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>func<span class="token punctuation">(</span>cluster *v2.Cluster<span class="token punctuation">)</span> error, error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	var todoList <span class="token punctuation">[</span><span class="token punctuation">]</span>func<span class="token punctuation">(</span>cluster *v2.Cluster<span class="token punctuation">)</span> error
	todoList <span class="token operator">=</span> append<span class="token punctuation">(</span>todoList,
		// c.GetPhasePluginFunc<span class="token punctuation">(</span>plugin.PhaseOriginally<span class="token punctuation">)</span>,
		c.Check,
		c.PreProcess,
		c.RunConfig,
		c.MountRootfs,
		c.MirrorRegistry,
		c.Bootstrap,
		// c.GetPhasePluginFunc<span class="token punctuation">(</span>plugin.PhasePreInit<span class="token punctuation">)</span>,
		c.Init,
		c.Join,
		// c.GetPhasePluginFunc<span class="token punctuation">(</span>plugin.PhasePreGuest<span class="token punctuation">)</span>,
		c.RunGuest,
		// c.GetPhasePluginFunc<span class="token punctuation">(</span>plugin.PhasePostInstall<span class="token punctuation">)</span>,
	<span class="token punctuation">)</span>
	<span class="token builtin class-name">return</span> todoList, nil
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>
<p>æ–¹ä¾¿ç†è§£ï¼Œè¿™é‡Œç›—ç”¨ sealer å›¾</p>
<p><img src="http://sm.nsddd.top/sm202304152338621.png" alt="sdUntitled"></p>
</li>
</ul>
<p>æ¥ä¸‹æ¥ä¼šæ‰§è¡Œä¸€ç³»åˆ— pipelineï¼Œæ­£å¼è¿›å…¥å®é™…çš„é›†ç¾¤éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼š</p>
<ol>
<li>Checkï¼šæ£€æŸ¥é›†ç¾¤çš„ host</li>
<li>PreProcessï¼šè´Ÿè´£é›†ç¾¤éƒ¨ç½²å‰çš„é•œåƒé¢„å¤„ç†æ“ä½œï¼Œåœ¨è¿™é‡Œå°±ä¼šåˆ©ç”¨ <code v-pre>CreateProcessor</code> ä¸­çš„å„ä¸ª Managerã€‚</li>
<li>æ‹‰å–é•œåƒ</li>
<li>æ£€æŸ¥é•œåƒæ ¼å¼</li>
<li>ä½¿ç”¨ <code v-pre>buildah</code> ä» OCI æ ¼å¼çš„é•œåƒä¸­åˆ›å»º working containerï¼Œå¹¶å°†å®¹å™¨æŒ‚è½½åˆ° rootfs ä¸Š</li>
<li>å°†å®¹å™¨çš„ manifest æ·»åŠ åˆ°é›†ç¾¤çŠ¶æ€ä¸­</li>
<li>RunConfigï¼šå°†é›†ç¾¤çŠ¶æ€ä¸­çš„ working container å¯¼å‡ºæˆ yaml æ ¼å¼çš„é…ç½®å¹¶æŒä¹…åŒ–åˆ°å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿä¸­</li>
<li>MountRootfsï¼šå°†æŒ‚è½½çš„é•œåƒå†…å®¹æŒ‰ç…§ç±»åˆ«ï¼Œä»¥ <code v-pre>rootfs</code>ï¼Œ<code v-pre>addons</code>ï¼Œ<code v-pre>app</code> çš„é¡ºåºåˆ†å‘åˆ°æ¯å°æœºå™¨ä¸Šã€‚ è¿™é‡Œéœ€è¦ä»‹ç»ä¸€ä¸‹ sealos é•œåƒçš„ä¸€èˆ¬ç»“æ„ï¼Œä»¥æœ€åŸºç¡€çš„ k8s é•œåƒä¸ºä¾‹ï¼š</li>
</ol>
<p>K8s ä½œä¸ºæ•´ä¸ªé›†ç¾¤çš„åŸºç¡€ï¼Œè™½ç„¶æœ€ç»ˆé•œåƒå†…çš„ç›®å½•ç»“æ„ä¸å…¶ä»–ä¸€è‡´ï¼Œä½†å…¶æ„å»ºè¿‡ç¨‹ç¨å¾®æœ‰æ‰€ä¸åŒã€‚åœ¨ CI <strong>https://github.com/labring/cluster-image/blob/faca63809e7a3eae512100a1eb8f9b7384973175/.github/scripts/kubernetes.sh#L35</strong> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œk8s é•œåƒå…¶å®æ˜¯åˆå¹¶äº† cluster-image ä»“åº“ä¸‹çš„å¤šä¸ªæ–‡ä»¶å¤¹ï¼Œ<code v-pre>containerd</code>ï¼Œ<code v-pre>rootfs</code> å’Œ <code v-pre>registry</code>ã€‚è¿™äº›ç‹¬ç«‹çš„æ–‡ä»¶å¤¹ä¸­åŒ…å«æœ‰å®‰è£…å¯¹åº”ç»„ä»¶çš„è„šæœ¬ã€‚ Sealos åœ¨æŒ‚è½½ä¸€ä¸ªé•œåƒåï¼Œä¼šé¦–å…ˆæ‰§è¡Œ <code v-pre>init.sh</code> è„šæœ¬ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯ k8s é•œåƒçš„è„šæœ¬ä¸­ï¼Œåˆ†åˆ«æŒ‰é¡ºåºæ‰§è¡Œäº† <code v-pre>init-containerd.sh</code> å®‰è£… containerdï¼Œ<code v-pre>init-shim.sh</code> å®‰è£… image-cri-shim å’Œ <code v-pre>init-kube.sh</code> å®‰è£… kubeletã€‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token builtin class-name">source</span> common.sh
<span class="token assign-left variable">REGISTRY_DOMAIN</span><span class="token operator">=</span><span class="token variable">${1<span class="token operator">:-</span>sealos.hub}</span>
<span class="token assign-left variable">REGISTRY_PORT</span><span class="token operator">=</span><span class="token variable">${2<span class="token operator">:-</span>5000}</span>

<span class="token comment"># Install containerd</span>
<span class="token function">chmod</span> a+x init-containerd.sh
<span class="token function">bash</span> init-containerd.sh <span class="token variable">${REGISTRY_DOMAIN}</span> <span class="token variable">${REGISTRY_PORT}</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
   error <span class="token string">"====init containerd failed!===="</span>
<span class="token keyword">fi</span>

<span class="token function">chmod</span> a+x init-shim.sh
<span class="token function">bash</span> init-shim.sh

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
   error <span class="token string">"====init image-cri-shim failed!===="</span>
<span class="token keyword">fi</span>

<span class="token function">chmod</span> a+x init-kube.sh
<span class="token function">bash</span> init-kube.sh

logger <span class="token string">"init containerd rootfs success"</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ MountRootfs è¿™æ­¥ä¸­ï¼Œåªä¼šæ‰§è¡Œ <code v-pre>rootfs</code> å’Œ <code v-pre>addons</code> ç±»å‹çš„ <code v-pre>init.sh</code> è„šæœ¬ã€‚è¿™ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒSealos ä»…ä»…åœ¨æ¯å°æœºå™¨ä¸Šå®‰è£…æˆåŠŸäº† kubeletï¼Œæ•´ä¸ª k8s é›†ç¾¤è¿˜æœªå¯ç”¨ã€‚</p>
<ol>
<li>Initï¼šåˆå§‹åŒ– k8s é›†ç¾¤ã€‚åœ¨è¿™æ­¥ä¸­ï¼Œå…¶å®ä¹Ÿæ˜¯æ‰§è¡Œäº†ä¸€ç³»åˆ—çš„å­æ“ä½œã€‚</li>
<li>Sealos ä¼šä» <code v-pre>ClusterFile</code> ä¸­åŠ è½½ <code v-pre>kubeadm</code> çš„é…ç½®ï¼Œç„¶åæ‹·è´åˆ° master0 ä¸Šã€‚</li>
<li>æ ¹æ® master0 çš„ hostname ç”Ÿæˆè¯ä¹¦ä»¥åŠ k8s é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ <code v-pre>admin.conf</code>ï¼Œ<code v-pre>controller-manager.conf</code>ï¼Œ<code v-pre>scheduler.conf</code>ï¼Œ<code v-pre>kubelet.conf</code>ã€‚</li>
<li>Sealos å°†è¿™äº›é…ç½®ä»¥åŠ rootfs ä¸­çš„é™æ€æ–‡ä»¶ï¼ˆä¸»è¦æ˜¯ä¸€äº› policy çš„é…ç½®ï¼‰æ‹·è´åˆ° master0 ä¸Šã€‚</li>
<li>Sealos é€šè¿‡ link çš„æ–¹å¼å°† rootfs ä¸­çš„ registry é“¾æ¥åˆ°å®¿ä¸»æœºçš„ç›®å½•ä¸Šï¼Œç„¶åæ‰§è¡Œè„šæœ¬ <code v-pre>init-registry.sh</code>ï¼Œå¯åŠ¨ registry å®ˆæŠ¤è¿›ç¨‹ã€‚</li>
<li>æœ€åä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼Œåˆå§‹åŒ– master0ã€‚é¦–å…ˆï¼Œå°† registry çš„åŸŸåï¼Œapi server çš„åŸŸåï¼ˆIP ä¸º master0 çš„ IPï¼‰æ·»åŠ åˆ° master0 å®¿ä¸»æœºä¸Šã€‚ç„¶åï¼Œè°ƒç”¨ <code v-pre>kubeadm init</code> åˆ›å»º k8s é›†ç¾¤ã€‚æœ€åï¼Œå°†ç”Ÿæˆçš„ç®¡ç†å‘˜ kubeconfig æ‹·è´åˆ° <code v-pre>.kube/config</code>ã€‚</li>
<li>Joinï¼šä½¿ç”¨ kubeadm å°†å…¶ä½™ master å’Œ node åŠ å…¥ç°æœ‰çš„é›†ç¾¤ï¼Œç„¶åæ›´æ–° <code v-pre>ClusterFile</code>ã€‚æ­¤æ—¶ï¼Œæ•´ä¸ª k8s é›†ç¾¤å°±å·²ç»æ­å»ºå®Œæ¯•äº†ã€‚</li>
<li>RunGuest: è¿è¡Œæ‰€æœ‰ç±»å‹ä¸º <code v-pre>app</code> çš„é•œåƒçš„ CMDï¼Œå®‰è£…æ‰€æœ‰åº”ç”¨ã€‚</li>
</ol>
<p>è‡³æ­¤ä¸€ä¸ª k8s é›†ç¾¤ä»¥åŠåŸºäºè¿™ä¸ªé›†ç¾¤çš„æ‰€æœ‰åº”ç”¨éƒ½è¢«å®‰è£…å®Œæ¯•ã€‚</p>
<h2 id="controller" tabindex="-1"><a class="header-anchor" href="#controller" aria-hidden="true">#</a> controller</h2>
<ul>
<li><a href="https://github.com/labring/sealos/tree/main/controllers" target="_blank" rel="noopener noreferrer">https://github.com/labring/sealos/tree/main/controllers<ExternalLinkIcon/></a></li>
</ul>
<p>å¦‚æœè¯´ sealos æœ€æ ¸å¿ƒçš„éƒ¨åˆ†æ˜¯ä»€ä¹ˆï¼Œæˆ‘è§‰å¾—æ˜¯ controller çš„å®ç°ï¼Œ<a href="https://github.com/labring/sealos/tree/main/controllers" target="_blank" rel="noopener noreferrer">controllers<ExternalLinkIcon/></a> æ§åˆ¶å™¨ç”¨æ¥ç®¡ç†é›†ç¾¤ï¼ˆk8s æœ‰ä¸€äº›å†…ç½®çš„åŠŸèƒ½ <code v-pre>pod</code>ï¼Œdeloymentè¿™äº›ï¼ŒåŒæ ·å¯ä»¥controllersæ‰©å±•ï¼‰ï¼š</p>
<p>controllers ä½¿ç”¨ Goè¯­è¨€ 1.8 +  çš„æ–°ç‰¹æ€§ï¼šå·¥ä½œåŒº</p>
<blockquote>
<p>è¿™äº›åŠŸèƒ½éƒ½æ˜¯ <code v-pre>k8s</code> æ²¡æœ‰çš„åŠŸèƒ½~</p>
</blockquote>
<ol>
<li>
<p>æˆ‘ä»¬è·‘äº†å¾ˆå¤šæœåŠ¡å™¨éƒ½æ˜¯é€šè¿‡<code v-pre>infra</code>ç®¡ç†ä»–ä»¬</p>
</li>
<li>
<p><code v-pre>metering</code>æ˜¯ç”¨ä½œè®¡é‡ï¼Œæˆ‘ä»¬ç”¨è¿‡å¤šå°‘èµ„æº</p>
</li>
<li>
<p><code v-pre>terminal</code>å°±æ˜¯æ¡Œé¢ä¸Šçš„ç»ˆç«¯åº”ç”¨</p>
</li>
<li>
<p><code v-pre>user</code>å°±æ˜¯ç”¨æˆ·çš„ç®¡ç†ï¼Œå› ä¸º<code v-pre>cloud.sealos</code>æ˜¯ä¸€ä¸ªå¤šç§Ÿæˆ·çš„é›†ç¾¤</p>
</li>
<li>
<p><code v-pre>app</code>: è´Ÿè´£ç®¡ç†ç”¨æˆ·åˆ›å»ºçš„æ‰€æœ‰åº”ç”¨ï¼ŒåŒ…æ‹¬åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°ã€æŸ¥çœ‹åº”ç”¨çš„çŠ¶æ€ä»¥åŠéƒ¨ç½²åº”ç”¨ã€‚</p>
</li>
<li>
<p><code v-pre>cluster</code>: è´Ÿè´£ç®¡ç† Kubernetes é›†ç¾¤ï¼ŒåŒ…æ‹¬åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°ã€æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€ä»¥åŠéƒ¨ç½²é›†ç¾¤ã€‚</p>
</li>
<li>
<p><code v-pre>imagehub</code>: è´Ÿè´£ç®¡ç†é•œåƒä»“åº“ï¼ŒåŒ…æ‹¬åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°ã€æŸ¥çœ‹é•œåƒä»“åº“çš„çŠ¶æ€ä»¥åŠéƒ¨ç½²é•œåƒä»“åº“ã€‚</p>
</li>
</ol>
<p>æˆ‘è®¤ä¸ºè¿™é‡Œæ˜¯  sealos çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p>
<h2 id="end-é“¾æ¥" tabindex="-1"><a class="header-anchor" href="#end-é“¾æ¥" aria-hidden="true">#</a> END é“¾æ¥</h2>
<ul><li><div><a href = '39.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '41.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>
<ul>
<li>
<p><RouterLink to="/">â“‚ï¸å›åˆ°ç›®å½•ğŸ </RouterLink></p>
</li>
<li>
<p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–</strong><ExternalLinkIcon/></a>)</p>
</li>
<li>
<p>âœ´ï¸ç‰ˆæƒå£°æ˜ Â© ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰Â©<ExternalLinkIcon/></a></p>
</li>
</ul>
</div></template>


